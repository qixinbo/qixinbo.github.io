<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qixinbo.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="写在前面：本文转自原AFEPack论坛afepack.org。  AFEPack教学系列转载自北京大学数学学院李若教授之个人博客。 如果需要转载本教学系列，请保持文章完整性，并注明转载出处。  李老师的话 学校的服务器老是有问题，希望这个地方能够稳定一些。我把AFEPack的使用写一些系列的小例子，从最简单的开始，希望能够为我这个软件包的使用者提供一些方便。  我在大年三十的晚上更新了AFEPac">
<meta property="og:type" content="article">
<meta property="og:title" content="自适应有限元包AFEPack教学系列">
<meta property="og:url" content="http://qixinbo.github.io/2016/03/11/afepack-tutorials/index.html">
<meta property="og:site_name" content="数字旗手">
<meta property="og:description" content="写在前面：本文转自原AFEPack论坛afepack.org。  AFEPack教学系列转载自北京大学数学学院李若教授之个人博客。 如果需要转载本教学系列，请保持文章完整性，并注明转载出处。  李老师的话 学校的服务器老是有问题，希望这个地方能够稳定一些。我把AFEPack的使用写一些系列的小例子，从最简单的开始，希望能够为我这个软件包的使用者提供一些方便。  我在大年三十的晚上更新了AFEPac">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2016-03-10T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-26T06:43:55.420Z">
<meta property="article:author" content="Xin-Bo Qi(亓欣波)">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="AFEPack">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://qixinbo.github.io/2016/03/11/afepack-tutorials/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>自适应有限元包AFEPack教学系列 | 数字旗手</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="数字旗手" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">数字旗手</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">电气化、自动化、数字化、智能化、智慧化</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-scholar">

    <a href="/scholar/" rel="section"><i class="fa fa-chart-bar fa-fw"></i>scholar</a>

  </li>
        <li class="menu-item menu-item-sources">

    <a href="/sources/" rel="section"><i class="fa fa-rss fa-fw"></i>sources</a>

  </li>
        <li class="menu-item menu-item-gallery">

    <a href="/gallery/" rel="section"><i class="fa fa-file-image fa-fw"></i>gallery</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404.html" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2016/03/11/afepack-tutorials/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Digitize everything to realize Digitalization!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="数字旗手">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          自适应有限元包AFEPack教学系列
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-03-11 00:00:00" itemprop="dateCreated datePublished" datetime="2016-03-11T00:00:00+08:00">2016-03-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-26 14:43:55" itemprop="dateModified" datetime="2021-03-26T14:43:55+08:00">2021-03-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/simulation/" itemprop="url" rel="index"><span itemprop="name">simulation</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/03/11/afepack-tutorials/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/03/11/afepack-tutorials/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>写在前面：本文转自原AFEPack论坛afepack.org。</p>
<blockquote>
<p>AFEPack教学系列转载自北京大学数学学院李若教授之个人博客。<br>如果需要转载本教学系列，请保持文章完整性，并注明转载出处。</p>
</blockquote>
<h1 id="李老师的话"><a href="#李老师的话" class="headerlink" title="李老师的话"></a>李老师的话</h1><p>学校的服务器老是有问题，希望这个地方能够稳定一些。我把AFEPack的使用写一些系列的小例子，从最简单的开始，希望能够为我这个软件包的使用者提供一些方便。</p>
<p>我在大年三十的晚上更新了AFEPack 的主页上的一点内容，现在主要是照抄下来，给想用AFEPack的人一些方向性的指导。在过去的几年中间，我多少花了一些力气来推广这个包，希望能够为计算数学的发展做一点事情。由于一些令人失望的经验，我对于推广使用这个软件包并不抱太乐观的态度。由于Linux 操作系统和C++这两个东西对于我们大多数同行和同学来说是两个巨大的困难，真正学会了我的这个软件包的使用者少之又少。如果期望从不熟悉环境到能够使用这个包来进行研究工作，假设您确实有研究上的需求，因而有学习使用这个包的动力，那么至少需要在半年时间中，每天都花上两个小时以上学习它，才有可能有所小成。在当今这个日新月异的时代里，这个时间恐怕已经超出了大多数期望尽快发表SCI论文而能够付出的可接受时间尺度。这个包的用户对象是研究人员，是那些为了能够研究新的算法而需求而设计的，如果您期望使用鼠标完成您的工作，那么这个包绝非正确的选择。</p>
<p>说了这么多吓人的话，您如果还能坚持读下去，我也期望对能够坚持学习下去的用户，描述一下如果您能够真正的掌握这个包的开发方式的话，可能会见到的光明前景。一般来说，在这个包的帮助下，您写一个复杂的偏微分方程 组的有限元程序的工作，在一到两个小时内完成是并不困难的。而且您的程序天生会具有相当大的可重用性：解一个新的问题常常只需要在旧程序上进行少许修改就能完成，而很多并不是太高要求的问题都可以在库中附带的例子上进行不多的修改即可解决。</p>
<p>在过去的两年时间里，AFEPack的主页一直都没有更新。一个问题是，两年没有更新的网页为什么现在要进行更新呢？事实上，这次终于进行的更新也只是进行了少许的修改，更新主要的目的是期望为了在我基本上终止对这个包的进一步开发的时候，为它的发展最后加入一点动力。AFEPack在2006年的八月申请了一个计算机软件版权号，它现在对于其能力所能够覆盖的问题，基本上能够比较完好的解决了，但是对于其能力不能覆盖的问题，是不可能在其现在的基本数据结构下进行简单的修改和补充就能够解决的。我现在将精力放在了新一代的软件包的开发上，期望能够在整个的自适应算法上有比较全面的发展，这个新的包的结构虽然在我看来非常精致而美丽，但是也很难以理解。</p>
<p>AFEPack 是刘文斌教授和我开发的基础有限元和有限元自适应软件包，请在它的主页上了解详细的信息。这是一个给基础数值技术研究人员使用的C++库函数包，熟练的使用者能够通过这个包非常大程度的提高工作效率。这个源码包以后若非修正Bug，将不会再频繁更新。</p>
<h1 id="AFEPack安装的步骤"><a href="#AFEPack安装的步骤" class="headerlink" title="AFEPack安装的步骤"></a>AFEPack安装的步骤</h1><p>一、请先安装deal.II软件包，因为我使用了deal.II的线性代数包，所以您只需要编译deal.II的base和lac部分就可以了，具体操作如下：</p>
<ol>
<li>下载deal.II 的源码包；</li>
<li>将这个软件包解压缩到，比如在/usr/local/deal.II 下面；</li>
<li>进入/usr/local/deal.II，运行./configure；</li>
<li>编译：make base lac；</li>
<li>将deal.II 的头文件和库文件链接到系统目录下，在我的机器上为：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[rli@circus /usr/local/include]$ ln -s ../deal.II/base/include/base .</span><br><span class="line">[rli@circus /usr/local/include]$ ln -s ../deal.II/lac/include/lac .</span><br><span class="line">[rli@circus /usr/local/lib]$ ln -s ../deal.II/base/lib/lib* .</span><br><span class="line">[rli@circus /usr/local/lib]$ ln -s ../deal.II/lac/lib/lib* .</span><br></pre></td></tr></table></figure>
二、然后您就可以编译AFEPack了，先获得AFEPack的源码包，并进行解压，比如解压到 /usr/local/AFEPack下面；</li>
</ol>
<p>三、请您在AFEPack的源码目录中，运行 ./configure；<br>如果包括 deal.II 的头文件或者库文件找不到，可以使用指定EXTRA_INCDIR和EXCTRA_LIBDIR这两个环境变量来指定deal.II 的头文件和库文件的路径:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env EXTRA_INCDIR=<span class="string">&quot;-Ipath/to/dealii/head/file&quot;</span> EXTRA_LIBDIR=<span class="string">&quot;-Lpath/to/dealii/libs&quot;</span> ./configure</span><br></pre></td></tr></table></figure><br>如果还有问题，可能是因为GNU开发工具包的版本的问题，您可以首先将过去运行automake和autoconf等的缓冲目录删除(名为autom4*)，然后使用命令序列：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aclocal</span><br><span class="line">automake</span><br><span class="line">autoconf</span><br></pre></td></tr></table></figure><br>重新产生出configure 脚本；<br>configure 脚本接收 —help 参数的时候可以给您帮助信息；</p>
<p>四、运行make进行编译；<br>编译过程也可以分开进行，您可以到library、template目录中分别运行make进行编译；<br>目录example下的内容编译的时候会有问题，您可以在做完下一步以后再在exmaple目录下运行make进行编译；<br>在example/tools下会编译出来很多很有用的可执行程序，帮助您做很多数据文件的格式转换，很值得试一下；</p>
<p>五、将头文件和编译得到的库文件链接到系统目录下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[rli@circus /usr/local/include]$ ln -s ../AFEPack/library/include AFEPack</span><br><span class="line">[rli@circus /usr/local/lib]$ ln -s ../AFEPack/library/lib/lib* .</span><br></pre></td></tr></table></figure><br>您使用make install也可以做这件事。</p>
<p>六、现在您就能够使用AFEPack提供的功能进行编程了，具体情况请参阅文档。</p>
<p>您现在可以到example目录中编译和研究我提供的一些使用AFEPack进行开发的小例子，这些例子对于帮助您学习使用AFEPack进行编程，是非常有用处的。很多问题直接通过对这些小例子中的某一个进行简单的修改就可以解决。</p>
<p>这个软件的开发在我的博士后研究期间得到EPSRC的支持，但是开发的动机是出于研究的兴趣，没有任何商业上的企图，现在已经没有经费的支持，所以文档更新的不是太及时，我也不能对于其稳定性和正确性提供任何保证，但如果有什么问题请给我发email，我会尽力给您帮助的。如果您有兴趣参与这个软件的开发，我也非常欢迎。</p>
<p>我现在使用AFEPack进行研究工作中的开发的程序包括：</p>
<ul>
<li>间断Galerkin方法+移动网格方法求解守恒律；</li>
<li>最优控制问题的自适应方法，包括椭圆型和抛物型的分布式控制问题，参数估计问题；</li>
<li>p-Laplacian方程的快速算法；</li>
<li>求解一些Fokker-Planck方程的求解算法；</li>
</ul>
<p>如果您也从事相应的研究工作，我可以提供大部分的源程序以供参考。如果您有使用AFEPack 进行开发的实例，希望您告诉我。如果比较成功，让我分享您的喜悦；如果还有问题，或许我可以提供一些帮助。</p>
<p>AFEPack 支持的相关软件下载：</p>
<ul>
<li>easymesh : 一个二维的网格产生程序；<br><a target="_blank" rel="noopener" href="http://dsec.pku.edu.cn/~rli/WiKi/Easymesh.html">这里</a>有我翻译的 easymesh 的文档；</li>
<li>gmsh : 一个能进行三维造型和产生网格的程序，rpm 包；<br><a target="_blank" rel="noopener" href="http://dsec.pku.edu.cn/~rli/WiKi/GmshTutorial.html">这里</a>有我翻译的 gmsh 的文档；</li>
<li>bamg : 一个二维的网格产生程序；</li>
<li>IBM Open Data Explorer : 非常专业的画图软件，我最喜欢的！AFEPack支持它的数据格式，推荐使用。</li>
</ul>
<p>AFEPack 还支持将计算结果输出成为Tecplot使用的数据格式，不过这个软件不是免费的，请您自己安排购买该软件。</p>
<h1 id="AFEPack教学系列之二-第一个例子－－求解泊松方程"><a href="#AFEPack教学系列之二-第一个例子－－求解泊松方程" class="headerlink" title="AFEPack教学系列之二: 第一个例子－－求解泊松方程"></a>AFEPack教学系列之二: 第一个例子－－求解泊松方程</h1><p>AFEPack 的基本使用方法，我们通过下面的求解泊松方程的程序来具体讲解。假设我们现在需要在区域$\Omega=[0, 1]\times[0, 1]$上来求解一个狄氏边值问题的泊松方程</p>
<script type="math/tex; mode=display">
-\Delta u = f, \qquad u |\_{\partial \Omega} = u\_b.</script><p>作为有限元程序，第一个问题就是要对区域进行剖分，得到网格的数据。我们这里使用一个简单的二维三角形网格剖分软件EasyMesh来去区域进行剖分。EasyMesh有一个一页纸的说明书，请读者自己去阅读它。EasyMesh 需要用户手工写一个对区域进行描述的文件作为输入文件，我们使用的文件名为D.d，其内容如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span> # 区域的顶点的个数 #</span><br><span class="line"><span class="number">0</span>: <span class="number">0.0</span> <span class="number">0.0</span> <span class="number">0.05</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span>: <span class="number">1.0</span> <span class="number">0.0</span> <span class="number">0.05</span> <span class="number">1</span></span><br><span class="line"><span class="number">2</span>: <span class="number">1.0</span> <span class="number">1.0</span> <span class="number">0.05</span> <span class="number">1</span></span><br><span class="line"><span class="number">3</span>: <span class="number">0.0</span> <span class="number">1.0</span> <span class="number">0.05</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span> # 区域的边界上边的条数 #</span><br><span class="line"><span class="number">0</span>: <span class="number">0</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span>: <span class="number">1</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line"><span class="number">2</span>: <span class="number">2</span> <span class="number">3</span> <span class="number">1</span></span><br><span class="line"><span class="number">3</span>: <span class="number">3</span> <span class="number">4</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><br>其中前面一个部分描述区域中的顶点，共有4个，然后每一行描述一个顶点的信息，其意义为</p>
<p>顶点的序号:    x坐标    y坐标    剖分密度h    材料标识</p>
<p>后面一个部分则描述区域的边界上的边的条数，共有4条，然后每一行描述一条边的信息，其意义为</p>
<p>边的序号:    起始顶点序号    结束顶点序号    材料标识</p>
<p>以这个文件的主文件名D作为输入，运行easymesh D，即可获得网格数据，存储在三个不同的文件中，名为D.n，D.s，D.e，存储的分别是节点、边和单元的信息。EasyMesh的说明中有对这些文件格式的详细说明，而AFEPack也提供了对这种数据格式的文件读入的接口。</p>
<p>在得到了网格数据以后，我们即可以开始对程序进行说明。我们的整个程序的原文和详细的说明如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 下面这些包含的头文件都是属于AFEPack的。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/AMGSolver.h&gt;</span>        <span class="comment">/// 代数多重网格求解器</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/TemplateElement.h&gt;</span>  <span class="comment">/// 参考单元</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/FEMSpace.h&gt;</span>         <span class="comment">/// 有限元空间</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Operator.h&gt;</span>         <span class="comment">/// 算子</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/BilinearOperator.h&gt;</span> <span class="comment">/// 双线性算子</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Functional.h&gt;</span>       <span class="comment">/// 泛函</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/EasyMesh.h&gt;</span>         <span class="comment">/// EasyMesh 接口</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2                <span class="comment">/**&lt; 区域的维数 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PI (4.0*atan(1.0))   <span class="comment">/**&lt; 常数 \pi   */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 精确解 u 的表达式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param p 区域上的点的坐标: x = p[0], y = p[1]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return u(x, y)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">double</span> _u_(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sin</span>(PI*p[<span class="number">0</span>]) * <span class="built_in">sin</span>(<span class="number">2</span>*PI*p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  右端项函数 f 的表达式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param p 区域上的点的坐标: x = p[0], y = p[1]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return f(x, y)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">double</span> _f_(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">5</span>*PI*PI*<span class="built_in">u</span>(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 主函数：程序在运行的时候，我们要求有一个命令行参数，即为网格数据文</span></span><br><span class="line"><span class="comment"> *         件名 D。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param argc 命令行参数个数</span></span><br><span class="line"><span class="comment"> * @param argv 命令行参数列表</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return 返回 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * AFEPack 中的 EasyMesh 类能够读入 EasyMesh 产生的数据文件的接口，</span></span><br><span class="line"><span class="comment">   * 它本身是由网格类 Mesh 派生出来的，可以当成一个网格使用</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  EasyMesh mesh;</span><br><span class="line">  mesh.<span class="built_in">readData</span>(argv[<span class="number">1</span>]); <span class="comment">/// 以第一个命令行参数为文件名，读入网格数据</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 下面这个段落是为有限元空间准备参考单元的数据。AFEPack 将参考单元</span></span><br><span class="line"><span class="comment">   * 的数据分成为四个不同的信息，包括：</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *   - 参考单元的几何信息</span></span><br><span class="line"><span class="comment">   *   - 参考单元到网格中的单元的坐标变换</span></span><br><span class="line"><span class="comment">   *   - 单元上的自由度分布</span></span><br><span class="line"><span class="comment">   *   - 单元上的基函数</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * 使用这几个信息反复组合，可以得到很多种不同的参考单元。这四个信息</span></span><br><span class="line"><span class="comment">   * 的管理使用了四个不同的类，名为 TemplateGeometry, CoordTransform,</span></span><br><span class="line"><span class="comment">   * TemplateDOF 和 BasisFunctionAdmin。这四个类都可以从数据文件中读入</span></span><br><span class="line"><span class="comment">   * 信息来构造其自身的结构，而对于很多常用的单元，这些数据文件都已经</span></span><br><span class="line"><span class="comment">   * 准备在了 AFEPack 的 template 子目录下。这些数据文件的数据格式在</span></span><br><span class="line"><span class="comment">   * AFEPack 的文档之中有比较详细的说明。为了能够使得 AFEPack 顺利的找</span></span><br><span class="line"><span class="comment">   * 到这些数据文件，我们需要设置环境变量 AFEPACK_TEMPLATE_PATH。比如</span></span><br><span class="line"><span class="comment">   * 对于我们这个问题的计算， 我们需要设置(假设 bash)</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">   *   $ export AFEPACK_TEMPLATE_PATH=$AFEPACK_PATH/template/triangle</span></span><br><span class="line"><span class="comment">   * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * 其中 AFEPACK_PATH 假设为 AFEPack 的安装路径。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 参考单元的几何信息：其中模板参数 DIM 为参考单元的维数，对于我们现 </span></span><br><span class="line"><span class="comment">   * 在的三角形来说就是 2。 参考单元的几何信息中包括参考单元的几何结构， </span></span><br><span class="line"><span class="comment">   * 以及进行数值积分的时候的一系列积分公式的信息。</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  TemplateGeometry&lt;DIM&gt; triangle_template_geometry;</span><br><span class="line">  triangle_template_geometry.<span class="built_in">readData</span>(<span class="string">&quot;triangle.tmp_geo&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 从参考单元到网格中的单元的坐标变换：这个类有两个模板参数，分别为</span></span><br><span class="line"><span class="comment">   * 参考单元的维数和网格中单元的维数。这两个数可能是不一样的，比如从</span></span><br><span class="line"><span class="comment">   * 标准三角形到球面三角形的坐标变换。这个类中提供了将参考单元中的点</span></span><br><span class="line"><span class="comment">   * 和实际网格单元中的点相互进行变换以及变换的雅可比行列式的计算方法。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt; triangle_coord_transform;</span><br><span class="line">  triangle_coord_transform.<span class="built_in">readData</span>(<span class="string">&quot;triangle.crd_trs&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 自由度分布指定了在单元的每个构件几何体上分布的自由度的个数，因此</span></span><br><span class="line"><span class="comment">   * 它需要在知道了参考单元的几何构型的情况下进行初始化。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">TemplateDOF&lt;DIM&gt; <span class="title">triangle_template_dof</span><span class="params">(triangle_template_geometry)</span></span>;</span><br><span class="line">  triangle_template_dof.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.tmp_dof&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 类 BasisFunctionAdmin 事实上管理着一组基函数，每个基函数为指定自</span></span><br><span class="line"><span class="comment">   * 己依赖的几何体，在参考单元上的插值点，一组称为&quot;基函数识别协议&quot;的</span></span><br><span class="line"><span class="comment">   * 信息，以及每个基函数的函数值和函数梯度的计算方法。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  BasisFunctionAdmin&lt;double,DIM,DIM&gt; triangle_basis_function(triangle_template_dof);</span><br><span class="line">  triangle_basis_function.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 将上面的这四个信息组合到类 TemplateElement 中，就得到了一个完整的</span></span><br><span class="line"><span class="comment">   * 参考单元。而建立有限元空间需要一个网格和一组参考单元，现在我们只</span></span><br><span class="line"><span class="comment">   * 使用一个参考单元。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  std::vector&lt;TemplateElement&lt;<span class="keyword">double</span>,DIM,DIM&gt; &gt; <span class="built_in">template_element</span>(<span class="number">1</span>);</span><br><span class="line">  template_element[<span class="number">0</span>].<span class="built_in">reinit</span>(triangle_template_geometry,</span><br><span class="line">                             triangle_template_dof,</span><br><span class="line">                             triangle_coord_transform,</span><br><span class="line">                             triangle_basis_function);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 使用我们读入的 EasyMesh 得到的网格，和刚刚创建的参考单元组来初始</span></span><br><span class="line"><span class="comment">   * 化有限元空间。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  FEMSpace&lt;double,DIM&gt; fem_space(mesh, template_element);</span><br><span class="line">        </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 我们先取出网格中的单元的个数，然后据此为有限元空间中的单元保留网</span></span><br><span class="line"><span class="comment">   * 格中的几何体单元同样数量的空间。此后，我们使得有限元空间中的每个</span></span><br><span class="line"><span class="comment">   * 单元是根据网格中的相应序号的几何体单元映射上第零号参考单元得到的。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">int</span> n_element = mesh.<span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">  fem_space.<span class="built_in">element</span>().<span class="built_in">resize</span>(n_element);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n_element;i ++) &#123;</span><br><span class="line">    fem_space.<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(fem_space,i,<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 下面三行分别建立有限元空间中的单元的内部数据结构，然后在整个网格</span></span><br><span class="line"><span class="comment">   * 上分布自由度以及为所有的自由度确定材料标识。自此，整个有限元空间</span></span><br><span class="line"><span class="comment">   * 的所有数据就都准备好了。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  fem_space.<span class="built_in">buildElement</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDof</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在上面建立的这个有限元空间上，我们计算一个刚度矩阵，就是由元素</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * \f[</span></span><br><span class="line"><span class="comment">   *    a_&#123;ij&#125; = \int_\Omega \nabla \phi^i \cdot \nabla \phi^j dx</span></span><br><span class="line"><span class="comment">   * \f]</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * 所构成的矩阵。由于这是常用矩阵，因此库中间有准备这个矩阵。建立这</span></span><br><span class="line"><span class="comment">   * 个矩阵，我们先使用上面的有限元空间构造这个矩阵的对象，然后设置计</span></span><br><span class="line"><span class="comment">   * 算矩阵时候使用的数值积分公式的代数精度的阶数。最后，调用函数</span></span><br><span class="line"><span class="comment">   * build 即可将矩阵计算出来。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  StiffMatrix&lt;DIM,double&gt; stiff_matrix(fem_space);</span><br><span class="line">  stiff_matrix.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">  stiff_matrix.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 有限元函数 u_h 用来逼近解函数 u</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  FEMFunction&lt;double,DIM&gt; u_h(fem_space);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 向量 f_h 用来计算右端项 f 在离散过后得到的向量，其元素为</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * \f[</span></span><br><span class="line"><span class="comment">   *    f_i = \int_\Omega f \phi^i dx</span></span><br><span class="line"><span class="comment">   * \f]</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * 函数 Operator::L2Discretize 帮助我们完成这个向量的计算。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  Vector&lt;<span class="keyword">double</span>&gt; f_h;</span><br><span class="line">  Operator::<span class="built_in">L2Discretize</span>(&amp;_f_, fem_space, f_h, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 下面这段是使用上狄氏边值条件：我们为材料标识为 1 的自由度使用函数</span></span><br><span class="line"><span class="comment">   * 表达式计算了其函数值，从而应用上了想要的边值条件。我们通过直接修</span></span><br><span class="line"><span class="comment">   * 改获得的线性系统中的稀疏矩阵和右端项来达成这样的结果。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  BoundaryFunction&lt;double,DIM&gt; boundary(BoundaryConditionInfo::DIRICHLET,</span><br><span class="line">                                        <span class="number">1</span>, &amp;_u_);</span><br><span class="line">  BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(fem_space);</span><br><span class="line">  boundary_admin.<span class="built_in">add</span>(boundary);</span><br><span class="line">  boundary_admin.<span class="built_in">apply</span>(stiff_matrix, u_h, f_h);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 调用 AFEPack 中的代数多重网格求解器，求解线性系统</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">AMGSolver <span class="title">solver</span><span class="params">(stiff_matrix)</span></span>;</span><br><span class="line">  solver.<span class="built_in">solve</span>(u_h, f_h);      </span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 将解输出到一个数据文件中。我们这里使用了 Open Data Explorer 的数</span></span><br><span class="line"><span class="comment">   * 据文件格式，输出的数据可以使用该软件来做可视化。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  u_h.<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;u.dx&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 由于这个问题有精确解，我们计算一下数值解和精确解的 L^2 误差。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">double</span> error = Functional::<span class="built_in">L2Error</span>(u_h, FunctionFunction&lt;<span class="keyword">double</span>&gt;(&amp;_u_), <span class="number">3</span>);</span><br><span class="line">  std::cerr &lt;&lt; <span class="string">&quot;\nL2 error = &quot;</span> &lt;&lt; error &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这个程序是使用AFEPack进行程序设计的基本套路，虽然其中基本上没有用户输入的关于计算方面的内容，但是很多问题都可以通过对这个程序进行不多的修改就能完成计算。</p>
<p>下面是上面程序的一个算例的图形:</p>
<ol>
<li>网格<br><a target="_blank" rel="noopener" href="http://rli.bloghome.cn/photos/p_original/7fa80b4fff007a6c9db4ce72559c9129.jpg">http://rli.bloghome.cn/photos/p_original/7fa80b4fff007a6c9db4ce72559c9129.jpg</a></li>
<li>解的等高线<br><a target="_blank" rel="noopener" href="http://rli.bloghome.cn/photos/p_original/775be126588a4ce7377c04f8165e67bf.jpg">http://rli.bloghome.cn/photos/p_original/775be126588a4ce7377c04f8165e67bf.jpg</a></li>
</ol>
<h1 id="AFEPack教学系列之三-变二次系数的椭圆型方程"><a href="#AFEPack教学系列之三-变二次系数的椭圆型方程" class="headerlink" title="AFEPack教学系列之三: 变二次系数的椭圆型方程"></a>AFEPack教学系列之三: 变二次系数的椭圆型方程</h1><p>我们将上文中求解的泊松方程进行一些修改，变成一个变二次项系数的问题。从而，我们现在的问题为</p>
<script type="math/tex; mode=display">
-\nabla \cdot \left( A \nabla u \right) = f, \qquad u|\_{\partial\Omega} = u\_b.</script><p>其中$A$是一个$2\times2$的矩阵，依赖于坐标，在我们的算例中，我们将其取为一个标量函数$a(x)$乘以单位矩阵。其与前一节中的泊松方程唯一的不同之处在于现在我们需要计算二次型</p>
<script type="math/tex; mode=display">
a(u,v) = \int\_\Omega \nabla u \cdot A \cdot \nabla v dx</script><p>的刚度矩阵。</p>
<p>在求解这个问题的过程中，我们先要把程序的结构进行整理，将变二次项系数的因素加进去，并使得其更加有利于复杂一些的问题的求解。为此，我们使用一个类来管理这个求解的问题，先写一个对这个类进行声明的头文件EllipticEquation.h。请看下面该头文件的源码和详细注释<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   EllipticEquation.h</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Wed Feb 21 11:45:03 2007</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @brief  类 EllipticEquation 的声明，附带的我们还声明了刚度矩阵的类</span></span><br><span class="line"><span class="comment"> *         型 Matrix。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __EllipticEquation_h__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __EllipticEquation_h__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/AMGSolver.h&gt;</span>        <span class="comment">/// 代数多重网格求解器</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/TemplateElement.h&gt;</span>  <span class="comment">/// 参考单元</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/FEMSpace.h&gt;</span>         <span class="comment">/// 有限元空间</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Operator.h&gt;</span>         <span class="comment">/// 算子</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/BilinearOperator.h&gt;</span> <span class="comment">/// 双线性算子</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Functional.h&gt;</span>       <span class="comment">/// 泛函</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/EasyMesh.h&gt;</span>         <span class="comment">/// EasyMesh 接口</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类EllipticEquation 的声明，可以看到，在这个类的声明中，我们基本上</span></span><br><span class="line"><span class="comment"> * 只是把前一节的程序中的很多变量，搬到了这里作为这个类的成员变量。注</span></span><br><span class="line"><span class="comment"> * 意我们使得本类是从 EasyMesh 上派生出来的，从而本类的对象本身可以作</span></span><br><span class="line"><span class="comment"> * 为一个网格来使用，同时这是为了下面扩展到移动网格方法的方便。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EllipticEquation</span> :</span> <span class="keyword">public</span> EasyMesh</span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 下面的几个变量用来构造参考单元，已经在上一节进行过详细解释。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  TemplateGeometry&lt;DIM&gt; triangle_template_geometry;</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt; triangle_coord_transform;</span><br><span class="line">  TemplateDOF&lt;DIM&gt; triangle_template_dof;</span><br><span class="line">  BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt; triangle_basis_function;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;TemplateElement&lt;<span class="keyword">double</span>,DIM,DIM&gt; &gt; template_element;</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt; fem_space; <span class="comment">/// 有限元空间</span></span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt; u_h;    <span class="comment">/// 有限元函数</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 这个函数进行初始化的工作，包括读入网格数据文件，以及构造参考单元，</span></span><br><span class="line"><span class="comment">   * 为建立有限元空间做准备。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 这个函数将构造有限元空间。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">buildSpace</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在构造的有限元空间上计算刚度矩阵并求解获得的线性系统，最终完成求</span></span><br><span class="line"><span class="comment">   * 解近似解。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这个类是用来计算现在的变系数二次算子的刚度矩阵用的。它从库中的刚度</span></span><br><span class="line"><span class="comment"> * 矩阵类 StiffMatrix 派生出来，唯一需要进行重载的函数就是计算单元刚度</span></span><br><span class="line"><span class="comment"> * 矩阵的函数 getElementMatrix。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Matrix</span> :</span> <span class="keyword">public</span> StiffMatrix&lt;DIM,<span class="keyword">double</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Matrix</span>(FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; sp) :</span><br><span class="line">    StiffMatrix&lt;DIM,<span class="keyword">double</span>&gt;(sp) &#123;&#125;;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Matrix</span>() &#123;&#125;;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> <span class="keyword">void</span></span><br><span class="line">    <span class="built_in">getElementMatrix</span>(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,<span class="number">2</span>&gt;&amp; ele0,</span><br><span class="line">                     <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,<span class="number">2</span>&gt;&amp; ele1,</span><br><span class="line">                     <span class="keyword">const</span> ActiveElementPairIterator&lt;DIM&gt;::State state);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __EllipticEquation_h__</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">\\end&#123;verbatim&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">针对这个头文件，其中提到的函数的实现文件 的源码和注释如下：</span><br><span class="line"></span><br><span class="line">\\begin&#123;verbatim&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   EllipticEquation.cpp</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Wed Feb 21 15:26:48 2007</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @brief  类 EllipticEquation 和 Matrix 的实现文件。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;EllipticEquation.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算二次项系数的函数，表达式为</span></span><br><span class="line"><span class="comment"> *                4, x^2 &gt; y^2;</span></span><br><span class="line"><span class="comment"> *    a(x, y) = &#123;</span></span><br><span class="line"><span class="comment"> *                1, x^2 &lt; y^2.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param p 点的坐标： x = p[0], y = p[1]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return 返回函数 a(x, y) 的值</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">double</span> _a_(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (p[<span class="number">0</span>]*p[<span class="number">0</span>] &gt; p[<span class="number">1</span>]*p[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算矩阵 Matrix 的单元刚度矩阵。这个函数本来是为了计算双线性型 b(u,</span></span><br><span class="line"><span class="comment"> * v) 而设计的，其中 u 和 v 可以在不同的有限元空间上。因此，这个函数接</span></span><br><span class="line"><span class="comment"> * 受两个单元的参数，分别是 u 和 v 所在的有限元空间的单元，在我们现在</span></span><br><span class="line"><span class="comment"> * 的情况下，这两个参数是同一个单元。第三个参数是为了实现库中的所谓多</span></span><br><span class="line"><span class="comment"> * 套网格方法而预留的，在这里我们可以先忽略这个参数的作用。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param ele0 有限元空间的单元</span></span><br><span class="line"><span class="comment"> * @param ele1 这里是和 ele0 相同的单元</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 下面的这段程序是比较标准的进行单元上的数值积分的程序的套路，弄清楚</span></span><br><span class="line"><span class="comment"> * 其作用对于掌握 AFEPack 的程序设计是至关重要的。计算一个函数 f(x) 在</span></span><br><span class="line"><span class="comment"> * 一个单元上的数值积分可以使用通用的公式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *    sum |J| w_l f(x_l) |e|</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 其中 |e| 是参考单元的体积，w_l 是积分公式中在第 l 个积分点上的权重，</span></span><br><span class="line"><span class="comment"> * 而 |J| 是从参考单元到实际单元进行变换的雅可比行列式，x_l 是第 l 个</span></span><br><span class="line"><span class="comment"> * 积分点。在 AFEPack 中，积分点是首先给在参考单元上的，然后通过坐标变</span></span><br><span class="line"><span class="comment"> * 换映射到实际单元上，成为实际单元上的积分点。下面的程序基本上就是在</span></span><br><span class="line"><span class="comment"> * 实现这样的一个数值积分公式。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">Matrix::<span class="built_in">getElementMatrix</span>(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; ele0,</span><br><span class="line">                         <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; ele1,</span><br><span class="line">                         <span class="keyword">const</span> ActiveElementPairIterator&lt;DIM&gt;::State state)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/// 计算参考单元的体积</span></span><br><span class="line">  <span class="keyword">double</span> volume = ele0.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 取出参考单元上的数值积分公式</span></span><br><span class="line">  <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info =</span><br><span class="line">    ele0.<span class="built_in">findQuadratureInfo</span>(<span class="built_in">algebricAccuracy</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 计算在积分点上的坐标变换的雅可比矩阵</span></span><br><span class="line">  std::vector&lt;<span class="keyword">double</span>&gt; jacobian =</span><br><span class="line">    ele0.<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 这是积分点的个数</span></span><br><span class="line">  <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 将参考单元上的积分点变换到网格中的实际单元上去</span></span><br><span class="line">  std::vector&lt;Point&lt;DIM&gt; &gt; q_point =</span><br><span class="line">    ele0.<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 计算单元上的基函数的梯度值</span></span><br><span class="line">  std::vector&lt;std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; &gt; basis_grad =</span><br><span class="line">    ele0.<span class="built_in">basis_function_gradient</span>(q_point);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> n_ele_dof = <span class="built_in">eleDof0</span>().<span class="built_in">size</span>(); <span class="comment">/// 单元上的自由度的个数</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 对积分点做求和</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;l ++) &#123;</span><br><span class="line">    <span class="comment">/// Jxw 就是积分公式中的项 |e| |J| w_l</span></span><br><span class="line">    <span class="keyword">double</span> Jxw = quad_info.<span class="built_in">weight</span>(l)*jacobian[l]*volume;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 计算函数 a(x, y) 在积分点的值</span></span><br><span class="line">    <span class="keyword">double</span> a_val = _a_(q_point[l]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; n_ele_dof;j ++) &#123; <span class="comment">/// 对自由度做循环</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>;k &lt; n_ele_dof;k ++) &#123; <span class="comment">/// 对自由度做循环</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/// 将积分点上的值往单元刚度矩阵上进行累加</span></span><br><span class="line">        <span class="built_in">elementMatrix</span>(j,k) += Jxw*a_val*<span class="built_in">innerProduct</span>(basis_grad[j][l],</span><br><span class="line">                                                     basis_grad[k][l]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化函数中准备了参考单元以及读入了网格数据文件。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EllipticEquation::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/// 读入参考单元的几何信息及坐标变换</span></span><br><span class="line">  triangle_template_geometry.<span class="built_in">readData</span>(<span class="string">&quot;triangle.tmp_geo&quot;</span>);</span><br><span class="line">  triangle_coord_transform.<span class="built_in">readData</span>(<span class="string">&quot;triangle.crd_trs&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 在参考单元的几何信息更新以后，模板单元上的自由度分布需要重新初始</span></span><br><span class="line">  <span class="comment">/// 化一下，对于下面的基函数，也是相似的情况。</span></span><br><span class="line">  triangle_template_dof.<span class="built_in">reinit</span>(triangle_template_geometry);</span><br><span class="line">  triangle_template_dof.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  triangle_basis_function.<span class="built_in">reinit</span>(triangle_template_dof);</span><br><span class="line">  triangle_basis_function.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 用上面读入的信息合成参考单元</span></span><br><span class="line">  template_element.<span class="built_in">resize</span>(<span class="number">1</span>);</span><br><span class="line">  template_element[<span class="number">0</span>].<span class="built_in">reinit</span>(triangle_template_geometry,</span><br><span class="line">                             triangle_coord_transform,</span><br><span class="line">                             triangle_template_dof,</span><br><span class="line">                             triangle_basis_function);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 读入网格数据文件</span></span><br><span class="line">  <span class="keyword">this</span>-&gt;<span class="built_in">readData</span>(<span class="string">&quot;D&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构造有限元空间，这里的代码是完全从前一节中搬过来的。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EllipticEquation::buildSpace</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/// 对有限元空间的对象重新初始化一下</span></span><br><span class="line">  fem_space,<span class="built_in">reinit</span>(*<span class="keyword">this</span>, template_element);</span><br><span class="line">        </span><br><span class="line">  <span class="keyword">int</span> n_element = mesh.<span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">  fem_space.<span class="built_in">element</span>().<span class="built_in">resize</span>(n_element);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n_element;i ++) &#123;</span><br><span class="line">    fem_space.<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(fem_space,i,<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fem_space.<span class="built_in">buildElement</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDof</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构造线性系统，并求解，得到需要的有限元函数。这一段的程序也基本上是</span></span><br><span class="line"><span class="comment"> * 由前一节搬过来的。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EllipticEquation::solve</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/// 注意这里我们使用 Matrix 来当我们的刚度矩阵</span></span><br><span class="line">  <span class="function">Matrix <span class="title">stiff_matrix</span><span class="params">(fem_space)</span></span>;</span><br><span class="line">  stiff_matrix.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">  stiff_matrix.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 有限元函数 u_h 初始化</span></span><br><span class="line">  u_h.<span class="built_in">reinit</span>(fem_space);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 向量 f_h 用来计算右端项 f 在离散过后得到的向量。</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * 注意：我们需要使用前一节中的函数表达式 _f_ 和 _u_，为了节省篇幅，</span></span><br><span class="line"><span class="comment">   * 我们这个文件中没有重复写这两个函数的表达式。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  Vector&lt;<span class="keyword">double</span>&gt; f_h;</span><br><span class="line">  Operator::<span class="built_in">L2Discretize</span>(&amp;_f_, fem_space, f_h, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 使用狄氏边值条件。</span></span><br><span class="line">  BoundaryFunction&lt;double,DIM&gt; boundary(BoundaryConditionInfo::DIRICHLET,</span><br><span class="line">                                        <span class="number">1</span>, &amp;_u_);</span><br><span class="line">  BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(fem_space);</span><br><span class="line">  boundary_admin.<span class="built_in">add</span>(boundary);</span><br><span class="line">  boundary_admin.<span class="built_in">apply</span>(stiff_matrix, u_h, f_h);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 调用 AFEPack 中的代数多重网格求解器，求解线性系统。</span></span><br><span class="line">  <span class="function">AMGSolver <span class="title">solver</span><span class="params">(stiff_matrix)</span></span>;</span><br><span class="line">  solver.<span class="built_in">solve</span>(u_h, f_h);      </span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 将解输出。</span></span><br><span class="line">  u_h.<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;u.dx&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><br>除去了这两个文件，我们另外写一个主文件，用来调用EllipticEquation类中的几个公有函数完成计算，全文如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   main.cpp</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Wed Feb 21 16:44:21 2007</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @brief  主文件，我们在这里开始运行，其中的这几行程序的意义是显而易</span></span><br><span class="line"><span class="comment"> *         见的，就不多解释了。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;EllipticEquation.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    EllipticEquation the_app;</span><br><span class="line">    the_app.<span class="built_in">initialize</span>();</span><br><span class="line">    the_app.<span class="built_in">buildSpace</span>();</span><br><span class="line">    the_app.<span class="built_in">solve</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in"><span class="keyword">catch</span></span>(std::exception&amp; e) &#123;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;Exception caughted:&quot;</span> &lt;&lt; std::endl</span><br><span class="line">              &lt;&lt; e.<span class="built_in">what</span> ()</span><br><span class="line">              &lt;&lt; std::endl;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in"><span class="keyword">catch</span></span>(...) &#123;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;Exception caughted:&quot;</span> &lt;&lt; std::endl</span><br><span class="line">              &lt;&lt; <span class="string">&quot;unknown exception caughted.&quot;</span></span><br><span class="line">              &lt;&lt; std::endl;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><br>下面是这个结果的图形，可以看到间断系数带来的解上的褶皱：</p>
<ol>
<li>等高线<br><a target="_blank" rel="noopener" href="http://rli.bloghome.cn/photos/p_original/16251db7005cc5179486c6f28e19ea30.jpg">http://rli.bloghome.cn/photos/p_original/16251db7005cc5179486c6f28e19ea30.jpg</a></li>
<li>曲面<br><a target="_blank" rel="noopener" href="http://rli.bloghome.cn/photos/p_original/9c9154be5fa9a3789c245e06606e4eb1.jpg">http://rli.bloghome.cn/photos/p_original/9c9154be5fa9a3789c245e06606e4eb1.jpg</a></li>
</ol>
<h1 id="AFEPack教学系列之四-简单的抛物型方程的例子"><a href="#AFEPack教学系列之四-简单的抛物型方程的例子" class="headerlink" title="AFEPack教学系列之四: 简单的抛物型方程的例子"></a>AFEPack教学系列之四: 简单的抛物型方程的例子</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   test.cpp</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Wed Feb 28 11:45:08 2007</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @brief  这是个抛物型方程的例子，非常简单，中间就没有解释太多了</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/EasyMesh.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/TemplateElement.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/FEMSpace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/BilinearOperator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Operator.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 初值和边值的表达式</span></span><br><span class="line"><span class="keyword">double</span> _u_(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>]*<span class="built_in">exp</span>(p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 右端项</span></span><br><span class="line"><span class="keyword">double</span> _f_(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>]*p[<span class="number">1</span>] + <span class="built_in">sin</span>(p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 1/dt - \Delta 离散出来的矩阵</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Matrix</span> :</span> <span class="keyword">public</span> L2InnerProduct&lt;DIM,<span class="keyword">double</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">double</span> _dt;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Matrix</span>(FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; sp, <span class="keyword">double</span> dt) :</span><br><span class="line">    L2InnerProduct&lt;DIM,<span class="keyword">double</span>&gt;(sp, sp), _dt(dt) &#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">getElementMatrix</span><span class="params">(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; e0,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; e1,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">const</span> ActiveElementPairIterator&lt; DIM &gt;::State s)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> vol = e0.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">    u_int acc = <span class="built_in">algebricAccuracy</span>();</span><br><span class="line">    <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; qi = e0.<span class="built_in">findQuadratureInfo</span>(acc);</span><br><span class="line">    u_int n_q_pnt = qi.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; jac = e0.<span class="built_in">local_to_global_jacobian</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">    std::vector&lt;Point&lt;DIM&gt; &gt; q_pnt = e0.<span class="built_in">local_to_global</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">    std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; bas_val = e0.<span class="built_in">basis_function_value</span>(q_pnt);</span><br><span class="line">    std::vector&lt;std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; &gt; bas_grad = e0.<span class="built_in">basis_function_gradient</span>(q_pnt);</span><br><span class="line">    u_int n_ele_dof = e0.<span class="built_in">dof</span>().<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">for</span> (u_int l = <span class="number">0</span>;l &lt; n_q_pnt;++ l) &#123;</span><br><span class="line">      <span class="keyword">double</span> Jxw = vol*qi.<span class="built_in">weight</span>(l)*jac[l];</span><br><span class="line">      <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele_dof;++ i) &#123;</span><br><span class="line">        <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">          <span class="built_in">elementMatrix</span>(i,j) += Jxw*(bas_val[i][l]*bas_val[j][l]/_dt +</span><br><span class="line">                                     <span class="built_in">innerProduct</span>(bas_grad[i][l], bas_grad[j][l]));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/// 准备网格</span></span><br><span class="line">  EasyMesh mesh;</span><br><span class="line">  mesh.<span class="built_in">readData</span>(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 准备参考单元</span></span><br><span class="line">  TemplateGeometry&lt;DIM&gt; tmp_geo;</span><br><span class="line">  tmp_geo.<span class="built_in">readData</span>(<span class="string">&quot;triangle.tmp_geo&quot;</span>);</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt; crd_trs;</span><br><span class="line">  crd_trs.<span class="built_in">readData</span>(<span class="string">&quot;triangle.crd_trs&quot;</span>);</span><br><span class="line">  <span class="function">TemplateDOF&lt;DIM&gt; <span class="title">tmp_dof</span><span class="params">(tmp_geo)</span></span>;</span><br><span class="line">  tmp_dof.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  BasisFunctionAdmin&lt;double,DIM,DIM&gt; bas_fun(tmp_dof);</span><br><span class="line">  bas_fun.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  std::vector&lt;TemplateElement&lt;<span class="keyword">double</span>,DIM&gt; &gt; <span class="built_in">tmp_ele</span>(<span class="number">1</span>);</span><br><span class="line">  tmp_ele[<span class="number">0</span>].<span class="built_in">reinit</span>(tmp_geo, tmp_dof, crd_trs, bas_fun);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 定制有限元空间</span></span><br><span class="line">  FEMSpace&lt;double,DIM&gt; fem_space(mesh, tmp_ele);</span><br><span class="line">  u_int n_ele = mesh.<span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">  fem_space.<span class="built_in">element</span>().<span class="built_in">resize</span>(n_ele);</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele;++ i) &#123;</span><br><span class="line">    fem_space.<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(fem_space, i, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  fem_space.<span class="built_in">buildElement</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDof</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 准备初值</span></span><br><span class="line">  FEMFunction&lt;double,DIM&gt; u_h(fem_space);</span><br><span class="line">  Operator::<span class="built_in">L2Interpolate</span>(&amp;_u_, u_h);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 准备边界条件</span></span><br><span class="line">  BoundaryFunction&lt;double,DIM&gt; boundary(BoundaryConditionInfo::DIRICHLET,</span><br><span class="line">                                        <span class="number">1</span>,</span><br><span class="line">                                        &amp;_u_);</span><br><span class="line">  BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(fem_space);</span><br><span class="line">  boundary_admin.<span class="built_in">add</span>(boundary);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">double</span> t;<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">double</span> dt = <span class="number">0.01</span>; <span class="comment">/// 简单起见，随手取个时间步长算了</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 准备线性系统的矩阵</span></span><br><span class="line">    <span class="function">Matrix <span class="title">mat</span><span class="params">(fem_space, dt)</span></span>;</span><br><span class="line">    mat.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">    mat.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 准备右端项</span></span><br><span class="line">    <span class="function">Vector&lt;<span class="keyword">double</span>&gt; <span class="title">rhs</span><span class="params">(fem_space.n_dof())</span></span>;</span><br><span class="line">    FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator the_ele = fem_space.<span class="built_in">beginElement</span>();</span><br><span class="line">    FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator end_ele = fem_space.<span class="built_in">endElement</span>();</span><br><span class="line">    <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele) &#123;</span><br><span class="line">      <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">      <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; qi = the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">3</span>);</span><br><span class="line">      u_int n_q_pnt = qi.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line">      std::vector&lt;<span class="keyword">double</span>&gt; jac = the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">      std::vector&lt;Point&lt;DIM&gt; &gt; q_pnt = the_ele-&gt;<span class="built_in">local_to_global</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">      std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; bas_val = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_pnt);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// 当基函数的值已知情况下，可以使用下面的函数来加速</span></span><br><span class="line">      std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = u_h.<span class="built_in">value</span>(bas_val, *the_ele);</span><br><span class="line">      std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; u_h_grad = u_h.<span class="built_in">gradient</span>(q_pnt, *the_ele);</span><br><span class="line">      <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">      u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line">      <span class="keyword">for</span> (u_int l = <span class="number">0</span>;l &lt; n_q_pnt;++ l) &#123;</span><br><span class="line">        <span class="keyword">double</span> Jxw = vol*qi.<span class="built_in">weight</span>(l)*jac[l];</span><br><span class="line">        <span class="keyword">double</span> f_val = _f_(q_pnt[l]);</span><br><span class="line">        <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele_dof;++ i) &#123;</span><br><span class="line">          <span class="built_in">rhs</span>(ele_dof[i]) += Jxw*bas_val[i][l]*(u_h_val[l]/dt + f_val);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 应用边界条件</span></span><br><span class="line">    boundary_admin.<span class="built_in">apply</span>(mat, u_h, rhs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 求解线性系统</span></span><br><span class="line">    AMGSolver solver;</span><br><span class="line">    solver.<span class="built_in">lazyReinit</span>(mat);</span><br><span class="line">    solver.<span class="built_in">solve</span>(u_h, rhs, <span class="number">1.0e-08</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 输出数据画图</span></span><br><span class="line">    u_h.<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;u_h.dx&quot;</span>);</span><br><span class="line"></span><br><span class="line">    t += dt; <span class="comment">/// 更新时间</span></span><br><span class="line">    </span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\n\tt = &quot;</span> &lt;&lt;  t &lt;&lt; std::endl;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<h1 id="AFEPack教学系列之五-一个没有注释的程序，考考你！"><a href="#AFEPack教学系列之五-一个没有注释的程序，考考你！" class="headerlink" title="AFEPack教学系列之五: 一个没有注释的程序，考考你！"></a>AFEPack教学系列之五: 一个没有注释的程序，考考你！</h1><p>下面是我们讨论班上心血来潮随手写的例子，一句注释都没有写，考考你看是什么意思，如果看明白了告诉我啊。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   test.cpp</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Wed Feb 28 11:45:08 2007</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @brief  </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/EasyMesh.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/TemplateElement.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/FEMSpace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/BilinearOperator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Operator.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> _u_(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>]*<span class="built_in">exp</span>(p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> _f_(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>]*p[<span class="number">1</span>] + <span class="built_in">sin</span>(p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Matrix</span> :</span> <span class="keyword">public</span> L2InnerProduct&lt;DIM,<span class="keyword">double</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt; * p_u_h;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Matrix</span>(FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; sp, FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;&amp; u_h) :</span><br><span class="line">    L2InnerProduct&lt;DIM,<span class="keyword">double</span>&gt;(sp, sp), <span class="built_in">p_u_h</span>(&amp;u_h) &#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">getElementMatrix</span><span class="params">(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; e0,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; e1,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">const</span> ActiveElementPairIterator&lt; DIM &gt;::State s)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> vol = e0.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">    u_int acc = <span class="built_in">algebricAccuracy</span>();</span><br><span class="line">    <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; qi = e0.<span class="built_in">findQuadratureInfo</span>(acc);</span><br><span class="line">    u_int n_q_pnt = qi.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; jac = e0.<span class="built_in">local_to_global_jacobian</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">    std::vector&lt;Point&lt;DIM&gt; &gt; q_pnt = e0.<span class="built_in">local_to_global</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">    std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; bas_val = e0.<span class="built_in">basis_function_value</span>(q_pnt);</span><br><span class="line">    std::vector&lt;std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; &gt;</span><br><span class="line">      bas_grad = e0.<span class="built_in">basis_function_gradient</span>(q_pnt);</span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = p_u_h-&gt;<span class="built_in">value</span>(q_pnt, e0);</span><br><span class="line">    u_int n_ele_dof = e0.<span class="built_in">dof</span>().<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">for</span> (u_int l = <span class="number">0</span>;l &lt; n_q_pnt;++ l) &#123;</span><br><span class="line">      <span class="keyword">double</span> Jxw = vol*qi.<span class="built_in">weight</span>(l)*jac[l];</span><br><span class="line">      <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele_dof;++ i) &#123;</span><br><span class="line">        <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">          <span class="built_in">elementMatrix</span>(i,j) += Jxw*(u_h_val[l]*u_h_val[l]*</span><br><span class="line">                                     <span class="built_in">innerProduct</span>(bas_grad[i][l],</span><br><span class="line">                                                  bas_grad[j][l]));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  EasyMesh mesh;</span><br><span class="line">  mesh.<span class="built_in">readData</span>(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  TemplateGeometry&lt;DIM&gt; tmp_geo;</span><br><span class="line">  tmp_geo.<span class="built_in">readData</span>(<span class="string">&quot;triangle.tmp_geo&quot;</span>);</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt; crd_trs;</span><br><span class="line">  crd_trs.<span class="built_in">readData</span>(<span class="string">&quot;triangle.crd_trs&quot;</span>);</span><br><span class="line">  <span class="function">TemplateDOF&lt;DIM&gt; <span class="title">tmp_dof</span><span class="params">(tmp_geo)</span></span>;</span><br><span class="line">  tmp_dof.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  BasisFunctionAdmin&lt;double,DIM,DIM&gt; bas_fun(tmp_dof);</span><br><span class="line">  bas_fun.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  std::vector&lt;TemplateElement&lt;<span class="keyword">double</span>,DIM&gt; &gt; <span class="built_in">tmp_ele</span>(<span class="number">1</span>);</span><br><span class="line">  tmp_ele[<span class="number">0</span>].<span class="built_in">reinit</span>(tmp_geo, tmp_dof, crd_trs, bas_fun);</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;double,DIM&gt; fem_space(mesh, tmp_ele);</span><br><span class="line">  u_int n_ele = mesh.<span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">  fem_space.<span class="built_in">element</span>().<span class="built_in">resize</span>(n_ele);</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele;++ i) &#123;</span><br><span class="line">    fem_space.<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(fem_space, i, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  fem_space.<span class="built_in">buildElement</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDof</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line"></span><br><span class="line">  FEMFunction&lt;double,DIM&gt; u_h(fem_space);</span><br><span class="line">  Operator::<span class="built_in">L2Interpolate</span>(&amp;_u_, u_h);</span><br><span class="line"></span><br><span class="line">  BoundaryFunction&lt;double,DIM&gt; boundary(BoundaryConditionInfo::DIRICHLET,</span><br><span class="line">                                        <span class="number">1</span>,</span><br><span class="line">                                        &amp;_u_);</span><br><span class="line">  BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(fem_space);</span><br><span class="line">  boundary_admin.<span class="built_in">add</span>(boundary);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="function">Matrix <span class="title">mat</span><span class="params">(fem_space, u_h)</span></span>;</span><br><span class="line">    mat.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">    mat.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">Vector&lt;<span class="keyword">double</span>&gt; <span class="title">rhs</span><span class="params">(fem_space.n_dof())</span></span>;</span><br><span class="line">    FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator the_ele = fem_space.<span class="built_in">beginElement</span>();</span><br><span class="line">    FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator end_ele = fem_space.<span class="built_in">endElement</span>();</span><br><span class="line">    <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele) &#123;</span><br><span class="line">      <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">      <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; qi = the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">3</span>);</span><br><span class="line">      u_int n_q_pnt = qi.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line">      std::vector&lt;<span class="keyword">double</span>&gt; jac = the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">      std::vector&lt;Point&lt;DIM&gt; &gt; q_pnt = the_ele-&gt;<span class="built_in">local_to_global</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">      std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; bas_val = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_pnt);</span><br><span class="line">      std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = u_h.<span class="built_in">value</span>(q_pnt, *the_ele);</span><br><span class="line">      std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; u_h_grad = u_h.<span class="built_in">gradient</span>(q_pnt, *the_ele);</span><br><span class="line">      <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">      u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line">      <span class="keyword">for</span> (u_int l = <span class="number">0</span>;l &lt; n_q_pnt;++ l) &#123;</span><br><span class="line">        <span class="keyword">double</span> Jxw = vol*qi.<span class="built_in">weight</span>(l)*jac[l];</span><br><span class="line">        <span class="keyword">double</span> f_val = _f_(q_pnt[l]);</span><br><span class="line">        <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele_dof;++ i) &#123;</span><br><span class="line">          <span class="built_in">rhs</span>(ele_dof[i]) += Jxw*bas_val[i][l]*</span><br><span class="line">            (f_val - u_h_val[l]*(u_h_grad[l][<span class="number">0</span>] + u_h_grad[l][<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    boundary_admin.<span class="built_in">apply</span>(mat, u_h, rhs);</span><br><span class="line"></span><br><span class="line">    AMGSolver solver;</span><br><span class="line">    solver.<span class="built_in">lazyReinit</span>(mat);</span><br><span class="line">    solver.<span class="built_in">solve</span>(u_h, rhs, <span class="number">1.0e-08</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">    u_h.<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;u_h.dx&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function">Vector&lt;<span class="keyword">double</span>&gt; <span class="title">res</span><span class="params">(fem_space.n_dof())</span></span>;</span><br><span class="line">    the_ele = fem_space.<span class="built_in">beginElement</span>();</span><br><span class="line">    <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele) &#123;</span><br><span class="line">      <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">      <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; qi = the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">3</span>);</span><br><span class="line">      u_int n_q_pnt = qi.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line">      std::vector&lt;<span class="keyword">double</span>&gt; jac = the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">      std::vector&lt;Point&lt;DIM&gt; &gt; q_pnt = the_ele-&gt;<span class="built_in">local_to_global</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">      std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; bas_val = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_pnt);</span><br><span class="line">      std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = u_h.<span class="built_in">value</span>(q_pnt, *the_ele);</span><br><span class="line">      std::vector&lt;std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; &gt; bas_grad = the_ele-&gt;<span class="built_in">basis_function_gradient</span>(q_pnt);</span><br><span class="line">      std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; u_h_grad = u_h.<span class="built_in">gradient</span>(q_pnt, *the_ele);</span><br><span class="line">      <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">      u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line">      <span class="keyword">for</span> (u_int l = <span class="number">0</span>;l &lt; n_q_pnt;++ l) &#123;</span><br><span class="line">        <span class="keyword">double</span> Jxw = vol*qi.<span class="built_in">weight</span>(l)*jac[l];</span><br><span class="line">        <span class="keyword">double</span> f_val = _f_(q_pnt[l]);</span><br><span class="line">        <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele_dof;++ i) &#123;</span><br><span class="line">      <span class="keyword">if</span> (fem_space.<span class="built_in">dofBoundaryMark</span>(ele_dof[i]) != <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">          <span class="built_in">res</span>(ele_dof[i]) += Jxw*</span><br><span class="line">            (bas_val[i][l]*(f_val - u_h_val[l]*(u_h_grad[l][<span class="number">0</span>] + u_h_grad[l][<span class="number">1</span>])) -</span><br><span class="line">             u_h_val[l]*u_h_val[l]*<span class="built_in">innerProduct</span>(bas_grad[i][l], u_h_grad[l]));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;res = &quot;</span> &lt;&lt; res.<span class="built_in">l2_norm</span>()</span><br><span class="line">              &lt;&lt; <span class="string">&quot;, press Enter to continue ...&quot;</span> &lt;&lt; std::flush;</span><br><span class="line">    <span class="built_in">getchar</span>();</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure></p>
<h1 id="AFEPack教学系列之六-加入移动网格方法的椭圆型方程"><a href="#AFEPack教学系列之六-加入移动网格方法的椭圆型方程" class="headerlink" title="AFEPack教学系列之六: 加入移动网格方法的椭圆型方程"></a>AFEPack教学系列之六: 加入移动网格方法的椭圆型方程</h1><p>基于前面的变系数的椭圆型方程的例子，我们来加入移动网格的模块，使得网格能够更加集中于数值解中的弱间断的位置。我们的移动网格模块的算法，整个网格的边界和内部将会耦合移动，因此，在区域的不同边界上，需要使用不同的材料标识才能使得程序对每个不同的边界上的信息加以区分。我们先将给EasyMesh使用的输入文件D.d更新为下面的样子：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span> # 区域的顶点的个数 #</span><br><span class="line"><span class="number">0</span>: <span class="number">0.0</span> <span class="number">0.0</span> <span class="number">0.05</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span>: <span class="number">1.0</span> <span class="number">0.0</span> <span class="number">0.05</span> <span class="number">2</span></span><br><span class="line"><span class="number">2</span>: <span class="number">1.0</span> <span class="number">1.0</span> <span class="number">0.05</span> <span class="number">3</span></span><br><span class="line"><span class="number">3</span>: <span class="number">0.0</span> <span class="number">1.0</span> <span class="number">0.05</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span> # 区域的边界上边的条数 #</span><br><span class="line"><span class="number">0</span>: <span class="number">0</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span>: <span class="number">1</span> <span class="number">2</span> <span class="number">2</span></span><br><span class="line"><span class="number">2</span>: <span class="number">2</span> <span class="number">3</span> <span class="number">3</span></span><br><span class="line"><span class="number">3</span>: <span class="number">3</span> <span class="number">4</span> <span class="number">4</span></span><br></pre></td></tr></table></figure><br>正方形的每个边上现在各有不同的边界条件。现在请以这个文件作为输入，使用easymesh产生出新的网格数据文件。另外，我们还需要一个文件来对问题的逻辑区域进行描述，这个文件命名为<code>文件名&#39;&#39; +</code>.log’’，现在我们的主文件名为D，因此我们提供名为D.log 的文件如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0.0</span> <span class="number">0.0</span></span><br><span class="line"><span class="number">1.0</span> <span class="number">0.0</span></span><br><span class="line"><span class="number">1.0</span> <span class="number">1.0</span></span><br><span class="line"><span class="number">0.0</span> <span class="number">1.0</span></span><br></pre></td></tr></table></figure><br>这个文件的每一行是逻辑区域的一个顶点的坐标，和物理区域的各个顶点相对应。由于理论上的考虑，请使得逻辑区域是一个凸区域。为了加入移动网格的模块，需要从头文件 EllipticEquation.h 改起：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __EllipticEquation_h__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __EllipticEquation_h__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/AMGSolver.h&gt;</span>        <span class="comment">/// 代数多重网格求解器</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/TemplateElement.h&gt;</span>  <span class="comment">/// 参考单元</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/FEMSpace.h&gt;</span>         <span class="comment">/// 有限元空间</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Operator.h&gt;</span>         <span class="comment">/// 算子</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/BilinearOperator.h&gt;</span> <span class="comment">/// 双线性算子</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Functional.h&gt;</span>       <span class="comment">/// 泛函</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/MovingMesh.h&gt;</span>       <span class="comment">/// 移动网格模块</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 现在，本类是从 MovingMesh 这个类派生出来的。在库的结构中，MovingMesh</span></span><br><span class="line"><span class="comment"> * 是从 EasyMesh 这个类派生出来的。因此，现在本类中只是多了在 MovingMesh</span></span><br><span class="line"><span class="comment"> * 中实现的一些算法的接口。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EllipticEquation</span> :</span> <span class="keyword">public</span> MovingMesh</span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造参考单元的变量。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  TemplateGeometry&lt;DIM&gt; triangle_template_geometry;</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt; triangle_coord_transform;</span><br><span class="line">  TemplateDOF&lt;DIM&gt; triangle_template_dof;</span><br><span class="line">  BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt; triangle_basis_function;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;TemplateElement&lt;<span class="keyword">double</span>,DIM,DIM&gt; &gt; template_element;</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt; fem_space; <span class="comment">/// 有限元空间</span></span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt; u_h;    <span class="comment">/// 有限元函数</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/// 下面这三个函数还是完成它们在上一个小节的功能</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">buildSpace</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">solve</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 现在由于要进行自适应，意味着我们要反复求解上面的椭圆型方程，因此</span></span><br><span class="line"><span class="comment">   * 我们在上面的椭圆型方程的求解上再套上一重循环来完成整个工作。在</span></span><br><span class="line"><span class="comment">   * run 这个函数中，就是一个这样的循环，在每个循环步中，整个程序求解</span></span><br><span class="line"><span class="comment">   * 椭圆型方程，然后调整网格，然后走向下一个循环步。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * getMonitor是在 MovingMesh 中的一个虚函数，缺省情况下，它将</span></span><br><span class="line"><span class="comment">   * MovingMesh 类中用作控制函数的数组填充为一个值全为 1 的数组。这个</span></span><br><span class="line"><span class="comment">   * 数组的长度和网格中的单元个数是一支的。现在这里重载这个函数，用来</span></span><br><span class="line"><span class="comment">   * 控制网格的移动。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">getMonitor</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在网格移动了以后，一般来说我们需要将旧网格上的解通过某种方式更新</span></span><br><span class="line"><span class="comment">   * 到新网格上来，因此，MovingMesh 类中也定义了这个虚函数。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">updateSolution</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 这个函数本来是调试的时候用的，在基类设计的时候没有计划得很好，做</span></span><br><span class="line"><span class="comment">   * 成了纯虚的，所以这里也写一个它的实现。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">outputSolution</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算刚度矩阵的程序的声明和实现都不做改变。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Matrix</span> :</span> <span class="keyword">public</span> StiffMatrix&lt;DIM,<span class="keyword">double</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Matrix</span>(FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; sp) :</span><br><span class="line">    StiffMatrix&lt;DIM,<span class="keyword">double</span>&gt;(sp) &#123;&#125;;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Matrix</span>() &#123;&#125;;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> <span class="keyword">void</span></span><br><span class="line">    <span class="built_in">getElementMatrix</span>(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; ele0,</span><br><span class="line">                     <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; ele1,</span><br><span class="line">                     <span class="keyword">const</span> ActiveElementPairIterator&lt;DIM&gt;::State state);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __EllipticEquation_h__</span></span></span><br></pre></td></tr></table></figure></p>
<p>下面是类的实现文件的源码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;EllipticEquation.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算二次项系数的函数的表达式。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">double</span> _a_(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (p[<span class="number">0</span>]*p[<span class="number">0</span>] &gt; p[<span class="number">1</span>]*p[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算矩阵 Matrix 的单元刚度矩阵，未做改变。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">Matrix::<span class="built_in">getElementMatrix</span>(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; ele0,</span><br><span class="line">                         <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; ele1,</span><br><span class="line">                         <span class="keyword">const</span> ActiveElementPairIterator&lt;DIM&gt;::State state)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">double</span> volume = ele0.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">  <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info =</span><br><span class="line">    ele0.<span class="built_in">findQuadratureInfo</span>(<span class="built_in">algebricAccuracy</span>());</span><br><span class="line">  std::vector&lt;<span class="keyword">double</span>&gt; jacobian =</span><br><span class="line">    ele0.<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">  <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line">  std::vector&lt;Point&lt;DIM&gt; &gt; q_point =</span><br><span class="line">    ele0.<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">  std::vector&lt;std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; &gt; basis_grad =</span><br><span class="line">    ele0.<span class="built_in">basis_function_gradient</span>(q_point);</span><br><span class="line">  <span class="keyword">int</span> n_ele_dof = <span class="built_in">eleDof0</span>().<span class="built_in">size</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;l ++) &#123;</span><br><span class="line">    <span class="keyword">double</span> Jxw = quad_info.<span class="built_in">weight</span>(l)*jacobian[l]*volume;</span><br><span class="line">    <span class="keyword">double</span> a_val = _a_(q_point[l]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; n_ele_dof;j ++) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>;k &lt; n_ele_dof;k ++) &#123;</span><br><span class="line">        <span class="built_in">elementMatrix</span>(j,k) += Jxw*a_val*<span class="built_in">innerProduct</span>(basis_grad[j][l],</span><br><span class="line">                                                     basis_grad[k][l]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化函数也基本没有改变，但是在读入网格数据文件的时候，我们现在需</span></span><br><span class="line"><span class="comment"> * 要使用 MovingMesh 类提供的 readDomain 函数。这个函数会不但读入网格</span></span><br><span class="line"><span class="comment"> * 剖分文件，并且会对区域描述文件 D.d 和 D.log 进行分析。注意：D.d 中</span></span><br><span class="line"><span class="comment"> * 的节点附近的剖分尺度在这个部分是不会用到的。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EllipticEquation::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  triangle_template_geometry.<span class="built_in">readData</span>(<span class="string">&quot;triangle.tmp_geo&quot;</span>);</span><br><span class="line">  triangle_coord_transform.<span class="built_in">readData</span>(<span class="string">&quot;triangle.crd_trs&quot;</span>);</span><br><span class="line">  triangle_template_dof.<span class="built_in">reinit</span>(triangle_template_geometry);</span><br><span class="line">  triangle_template_dof.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  triangle_basis_function.<span class="built_in">reinit</span>(triangle_template_dof);</span><br><span class="line">  triangle_basis_function.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  template_element.<span class="built_in">resize</span>(<span class="number">1</span>);</span><br><span class="line">  template_element[<span class="number">0</span>].<span class="built_in">reinit</span>(triangle_template_geometry,</span><br><span class="line">                             triangle_coord_transform,</span><br><span class="line">                             triangle_template_dof,</span><br><span class="line">                             triangle_basis_function);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 读入网格数据文件和区域描述文件</span></span><br><span class="line">  <span class="keyword">this</span>-&gt;<span class="built_in">readDomain</span>(<span class="string">&quot;D&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构造有限元空间。我们只需要做一次这个操作，即使是网格移动了以后，有</span></span><br><span class="line"><span class="comment"> * 限元空间也不必更新。事实上，网格移动了以后，有限元空间中每个自由度</span></span><br><span class="line"><span class="comment"> * 的插值点会不对。但是由于我们下面的计算并不使用到插值操作，因此就不</span></span><br><span class="line"><span class="comment"> * 必更新自由度的插值点了。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EllipticEquation::buildSpace</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  fem_space,<span class="built_in">reinit</span>(*<span class="keyword">this</span>, template_element);</span><br><span class="line">        </span><br><span class="line">  <span class="keyword">int</span> n_element = mesh.<span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">  fem_space.<span class="built_in">element</span>().<span class="built_in">resize</span>(n_element);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n_element;i ++) &#123;</span><br><span class="line">    fem_space.<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(fem_space,i,<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fem_space.<span class="built_in">buildElement</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDof</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构造线性系统，并求解，得到需要的有限元函数。在这个函数中，我们仅仅</span></span><br><span class="line"><span class="comment"> * 对边界条件的部分进行了更新，因为我们为了能够应用移动网格模块，更新</span></span><br><span class="line"><span class="comment"> * 了区域描述文件中的边界材料标识。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EllipticEquation::solve</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">Matrix <span class="title">stiff_matrix</span><span class="params">(fem_space)</span></span>;</span><br><span class="line">  stiff_matrix.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">  stiff_matrix.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">  u_h.<span class="built_in">reinit</span>(fem_space);</span><br><span class="line"></span><br><span class="line">  Vector&lt;<span class="keyword">double</span>&gt; f_h;</span><br><span class="line">  Operator::<span class="built_in">L2Discretize</span>(&amp;_f_, fem_space, f_h, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 使用狄氏边值条件。现在我们需要对四个边分别添加边值条件。</span></span><br><span class="line">  BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(fem_space);</span><br><span class="line">  BoundaryFunction&lt;double,DIM&gt; boundary1(BoundaryConditionInfo::DIRICHLET,</span><br><span class="line">                                         <span class="number">1</span>, &amp;_u_);</span><br><span class="line">  BoundaryFunction&lt;double,DIM&gt; boundary2(BoundaryConditionInfo::DIRICHLET,</span><br><span class="line">                                         <span class="number">2</span>, &amp;_u_);</span><br><span class="line">  BoundaryFunction&lt;double,DIM&gt; boundary3(BoundaryConditionInfo::DIRICHLET,</span><br><span class="line">                                         <span class="number">3</span>, &amp;_u_);</span><br><span class="line">  BoundaryFunction&lt;double,DIM&gt; boundary4(BoundaryConditionInfo::DIRICHLET,</span><br><span class="line">                                         <span class="number">4</span>, &amp;_u_);</span><br><span class="line">  boundary_admin.<span class="built_in">add</span>(boundary1);</span><br><span class="line">  boundary_admin.<span class="built_in">add</span>(boundary2);</span><br><span class="line">  boundary_admin.<span class="built_in">add</span>(boundary3);</span><br><span class="line">  boundary_admin.<span class="built_in">add</span>(boundary4);</span><br><span class="line">  boundary_admin.<span class="built_in">apply</span>(stiff_matrix, u_h, f_h);</span><br><span class="line"></span><br><span class="line">  <span class="function">AMGSolver <span class="title">solver</span><span class="params">(stiff_matrix)</span></span>;</span><br><span class="line">  solver.<span class="built_in">solve</span>(u_h, f_h);      </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * run 是整个程序运行的主要驱动引擎。这里是最外层的循环。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EllipticEquation::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">initialize</span>(); <span class="comment">/// 完成准备工作</span></span><br><span class="line">  <span class="built_in">buildSpace</span>(); <span class="comment">/// 建立有限元空间</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 这里要加一个对u_h的初始化，否则在调用getMonitor的时候会出错: </span></span><br><span class="line"><span class="comment">   * 在buildSpace()之后是moveMesh()，而在moveMesh()里最先调用     </span></span><br><span class="line"><span class="comment">   * getMoveDirection()，该函数又首先调用getMonitor()。在</span></span><br><span class="line"><span class="comment">   * getMonitor()里会用到u_h来计算梯度，所以在此之前必须初始化u_h。</span></span><br><span class="line"><span class="comment">   * 对于时间依赖的问题，因为要用到初始值，所以在移动之前，u_h已经</span></span><br><span class="line"><span class="comment">   * 有了初值了，但是本算例是静态问题，所以必须先解一次，给u_h一个</span></span><br><span class="line"><span class="comment">   * 合理的初值，然后才可以移动。这里我们首先求解一次，然后调用</span></span><br><span class="line"><span class="comment">   * moveMesh()（by hghdd）</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="built_in">solve</span>();</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 调用 MovingMesh 的 moveMesh 函数进行网格移动，主循环事实上隐藏在</span></span><br><span class="line"><span class="comment">   * 这个函数中。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="built_in">moveMesh</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这个函数计算控制网格移动的控制函数。我们使用解的梯度的阶跃来作为控</span></span><br><span class="line"><span class="comment"> * 制量。由于我们现在使用最简单的线性逼近的方式，我们可以手工在计算这</span></span><br><span class="line"><span class="comment"> * 个量，避免要进行面单元上的数值积分带来的麻烦。请仔细理解下面这段代</span></span><br><span class="line"><span class="comment"> * 码。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EllipticEquation::getMonitor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  u_int n_ele = <span class="built_in">n_geometry</span>(DIM); <span class="comment">/// 网格中所有的单元的个数</span></span><br><span class="line">  u_int n_side = <span class="built_in">n_geometry</span>(<span class="number">1</span>); <span class="comment">/// 网格中的所有边的条数。</span></span><br><span class="line">  <span class="function">std::vector&lt;<span class="keyword">bool</span>&gt; <span class="title">sflag</span><span class="params">(n_side, <span class="literal">false</span>)</span></span>; <span class="comment">/// 加在每个边上的一个标志</span></span><br><span class="line">  <span class="function">std::vector&lt;<span class="keyword">double</span>&gt; <span class="title">sjump</span><span class="params">(n_side)</span></span>; <span class="comment">/// 用来边上的阶跃</span></span><br><span class="line">  <span class="function">std::vector&lt;<span class="keyword">double</span>&gt; <span class="title">earea</span><span class="params">(n_ele)</span></span>; <span class="comment">/// 用来存储每个单元的面积</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 对单元做循环</span></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator the_ele = fem_space.<span class="built_in">beginElement</span>();</span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator end_ele = fem_space.<span class="built_in">endElement</span>();</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;the_ele != end_ele;++ the_ele, ++ i) &#123;</span><br><span class="line">    <span class="comment">/// 取出单元的几何体</span></span><br><span class="line">    <span class="keyword">const</span> GeometryBM&amp; geo = the_ele-&gt;<span class="built_in">geometry</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 下面是单元的三个顶点的坐标</span></span><br><span class="line">    <span class="keyword">const</span> Point&lt;DIM&gt;&amp; p0 = <span class="built_in">point</span>(<span class="built_in">geometry</span>(<span class="number">0</span>, geo.<span class="built_in">vertex</span>(<span class="number">0</span>)).<span class="built_in">vertex</span>(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">const</span> Point&lt;DIM&gt;&amp; p1 = <span class="built_in">point</span>(<span class="built_in">geometry</span>(<span class="number">0</span>, geo.<span class="built_in">vertex</span>(<span class="number">1</span>)).<span class="built_in">vertex</span>(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">const</span> Point&lt;DIM&gt;&amp; p2 = <span class="built_in">point</span>(<span class="built_in">geometry</span>(<span class="number">0</span>, geo.<span class="built_in">vertex</span>(<span class="number">2</span>)).<span class="built_in">vertex</span>(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 手工计算此单元的面积</span></span><br><span class="line">    earea[i] = <span class="number">0.5</span>*((p1[<span class="number">0</span>] - p0[<span class="number">0</span>])*(p2[<span class="number">1</span>] - p0[<span class="number">1</span>]) -</span><br><span class="line">                    (p1[<span class="number">1</span>] - p0[<span class="number">1</span>])*(p2[<span class="number">0</span>] - p0[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算单元上解函数的梯度。由于使用分片线性逼近，解函数的梯度是一</span></span><br><span class="line"><span class="comment">     * 个常数，因此在下面的函数中，我们将计算的坐标点设为 p0 是没有关</span></span><br><span class="line"><span class="comment">     * 系的。如果不是这样的逼近方式，下面的代码是不对的。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; u_h_grad = u_h.<span class="built_in">gradient</span>(p0, *the_ele);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下面对三角形的三条边进行循环，分别计算每条边上的梯度法向分量。</span></span><br><span class="line"><span class="comment">     * 并加到相应的边上去。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; <span class="number">3</span>;++ j) &#123;</span><br><span class="line">      u_int k = geo.<span class="built_in">boundary</span>(j); <span class="comment">/// 这是边的序号</span></span><br><span class="line">      <span class="keyword">const</span> GeometryBM&amp; sid = <span class="built_in">geometry</span>(<span class="number">1</span>, k); <span class="comment">/// 取出边的几何体</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/// 下面是边的两个端点</span></span><br><span class="line">      <span class="keyword">const</span> Point&lt;DIM&gt;&amp; ep0 = <span class="built_in">point</span>(<span class="built_in">geometry</span>(<span class="number">0</span>, sid.<span class="built_in">vertex</span>(<span class="number">0</span>)).<span class="built_in">vertex</span>(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">const</span> Point&lt;DIM&gt;&amp; ep1 = <span class="built_in">point</span>(<span class="built_in">geometry</span>(<span class="number">0</span>, sid.<span class="built_in">vertex</span>(<span class="number">1</span>)).<span class="built_in">vertex</span>(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// 计算梯度的法向分量乘以边的长度</span></span><br><span class="line">      <span class="keyword">double</span> norm_grad = (u_h_grad[<span class="number">0</span>]*(ep0[<span class="number">1</span>] - ep1[<span class="number">1</span>]) +</span><br><span class="line">                          u_h_grad[<span class="number">1</span>]*(ep1[<span class="number">0</span>] - ep0[<span class="number">0</span>]));</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 如果 sflag[k] 是 false，说明对面的单元上还没有计算过， 因此我 </span></span><br><span class="line"><span class="comment">       * 们将 norm_grad 直接设为该边上的值； 否则说明对面的单元上已经计 </span></span><br><span class="line"><span class="comment">       * 算过了，我们将本单元的 norm_grad 减去，就得到了边上的梯度阶跃 </span></span><br><span class="line"><span class="comment">       * 了。</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">if</span> (sflag[k] == <span class="literal">false</span>) &#123;</span><br><span class="line">        sjump[k] = norm_grad;</span><br><span class="line">        sflag[k] = <span class="literal">true</span>; <span class="comment">/// 将标志改为 true，通知对面单元</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sjump[k] -= norm_grad;</span><br><span class="line">        sflag[k] = <span class="literal">false</span>; <span class="comment">/// 将标志恢复为 false，表面这个边不在边界上</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 重新开始对单元做循环</span></span><br><span class="line">  the_ele = fem_space.<span class="built_in">beginElement</span>();</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;the_ele != end_ele;++ the_ele, ++ i) &#123;</span><br><span class="line">    <span class="keyword">const</span> GeometryBM&amp; geo = the_ele-&gt;<span class="built_in">geometry</span>(); <span class="comment">/// 单元的几何体</span></span><br><span class="line">    <span class="built_in">monitor</span>(i) = <span class="number">0.0</span>;</span><br><span class="line">    <span class="comment">/// 将三个边上的阶跃都算在这个单元头上</span></span><br><span class="line">    <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; <span class="number">3</span>;++ j) &#123;</span><br><span class="line">      u_int k = geo.<span class="built_in">boundary</span>(j);</span><br><span class="line">      <span class="keyword">const</span> GeometryBM&amp; sid = <span class="built_in">geometry</span>(<span class="number">1</span>, k);</span><br><span class="line">      <span class="keyword">if</span> (sflag[k] == <span class="literal">true</span>) <span class="keyword">continue</span>; <span class="comment">/// 如果在区域边界上，则跳过去</span></span><br><span class="line">      <span class="built_in">monitor</span>(i) += sjump[k]*sjump[k];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">monitor</span>(i) /= earea[i]; <span class="comment">/// 除以面积，得到分布函数</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">smoothMonitor</span>(<span class="number">2</span>); <span class="comment">/// 对控制函数进行磨光操作</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * beta 是用来调节对比度的重要参数，当这个数越大的时候，就使得网格的</span></span><br><span class="line"><span class="comment">   * 尺寸对比越大。我们目前还不知道如何选择这个参数，只能靠试验和经验</span></span><br><span class="line"><span class="comment">   * 了。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">double</span> beta = <span class="number">1.0e+02</span>;</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele;++ i) &#123; <span class="comment">/// 将控制函数取调和形式</span></span><br><span class="line">    <span class="built_in">monitor</span>(i) = <span class="number">1.0</span>/<span class="built_in">sqrt</span>(<span class="number">1.0</span> + beta*<span class="built_in">monitor</span>(i));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 由于是静态问题，我们在这里先直接通过在新的网格上直接求解来获得新的</span></span><br><span class="line"><span class="comment"> * 解。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EllipticEquation::updateSolution</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">solve</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 输出解函数做可视化用</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EllipticEquation::outputSolution</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  u_h.<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;u_h.dx&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后，我们将main.cpp改成下面的样子，使得它在里面直接调用run这个函数：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;EllipticEquation.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    EllipticEquation the_app;</span><br><span class="line">    the_app.<span class="built_in">run</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in"><span class="keyword">catch</span></span>(std::exception&amp; e) &#123;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;Exception caughted:&quot;</span> &lt;&lt; std::endl</span><br><span class="line">              &lt;&lt; e.<span class="built_in">what</span> ()</span><br><span class="line">              &lt;&lt; std::endl;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in"><span class="keyword">catch</span></span>(...) &#123;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;Exception caughted:&quot;</span> &lt;&lt; std::endl</span><br><span class="line">              &lt;&lt; <span class="string">&quot;unknown exception caughted.&quot;</span></span><br><span class="line">              &lt;&lt; std::endl;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>由于我们在MovingMesh中的边界控制问题的求解算法上进行了比较本质的改进，现在类MovingMesh将不会继续维护，而代之以一个新的类MovingMesh2D。因此在此谨提醒用户都移到这个新类上来，在一段时间以后，MovingMesh这个类会被废弃的。这个新的类在接口上基本上维持了MovingMesh的样子，原先的程序直接把MovingMesh改为MovingMesh2D就都能使用了。</p>
<h1 id="AFEPack教学系列之七-加一行，改成Burgers方程的程序"><a href="#AFEPack教学系列之七-加一行，改成Burgers方程的程序" class="headerlink" title="AFEPack教学系列之七: 加一行，改成Burgers方程的程序"></a>AFEPack教学系列之七: 加一行，改成Burgers方程的程序</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   bug.cpp</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Thu Mar  8 14:55:37 2007</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @brief  将系列之四的抛物型方程的例子稍微改一下，就成为了黏性Burgers方程</span></span><br><span class="line"><span class="comment"> *         的程序了。其它的部分我就都删除了，只留下了修改过的那一点点。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 准备右端项</span></span><br><span class="line">    <span class="function">Vector&lt;<span class="keyword">double</span>&gt; <span class="title">rhs</span><span class="params">(fem_space.n_dof())</span></span>;</span><br><span class="line">    FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator the_ele = fem_space.<span class="built_in">beginElement</span>();</span><br><span class="line">    FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator end_ele = fem_space.<span class="built_in">endElement</span>();</span><br><span class="line">    <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele) &#123;</span><br><span class="line">      <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">      <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; qi = the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">3</span>);</span><br><span class="line">      u_int n_q_pnt = qi.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line">      std::vector&lt;<span class="keyword">double</span>&gt; jac = the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">      std::vector&lt;Point&lt;DIM&gt; &gt; q_pnt = the_ele-&gt;<span class="built_in">local_to_global</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">      std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; bas_val = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_pnt);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// 当基函数的值已知情况下，可以使用下面的函数来加速</span></span><br><span class="line">      std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = u_h.<span class="built_in">value</span>(bas_val, *the_ele);</span><br><span class="line">      std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; u_h_grad = u_h.<span class="built_in">gradient</span>(q_pnt, *the_ele);</span><br><span class="line">      <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">      u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line">      <span class="keyword">for</span> (u_int l = <span class="number">0</span>;l &lt; n_q_pnt;++ l) &#123;</span><br><span class="line">        <span class="keyword">double</span> Jxw = vol*qi.<span class="built_in">weight</span>(l)*jac[l];</span><br><span class="line">        <span class="keyword">double</span> f_val = _f_(q_pnt[l]);</span><br><span class="line">        <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele_dof;++ i) &#123;</span><br><span class="line">          <span class="built_in">rhs</span>(ele_dof[i]) += Jxw*bas_val[i][l]*(u_h_val[l]*/dt + f_val</span><br><span class="line">                                                u_h_val[l]*(u_h_grad[l][<span class="number">0</span>] + u_h_grad[l][<span class="number">1</span>]));</span><br><span class="line">          <span class="comment">/// 就加了上面这一行</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<h1 id="AFEPack教学系列之八-网格和几何体"><a href="#AFEPack教学系列之八-网格和几何体" class="headerlink" title="AFEPack教学系列之八: 网格和几何体"></a>AFEPack教学系列之八: 网格和几何体</h1><p>应Wang Han的要求，写一些解释AFEPack的基本数据结构的内容。首先，我们说一下关于网格和几何体的数据结构。</p>
<p>几何体的类就是Geometry，如果需要材料标识，则叫做GeometryBM，这个名字比较难看，是因为开始的时候没有设计好造成的。单独一个几何体中存储的数据是没有意义的，几何体这个类的对象必须在网格类中间存储，才能够有意义。</p>
<p>Mesh这个类存储着各维几何体的数组。其中，最高维的几何体就是网格中间的单元，最低维的几何体则是网格中的节点。因为使用了数组，就可以使用随机读取方式来取其中的元素，因此，在AFEPack内部的设计语言中，每个几何体的表述方法，都是按照“第n维的第m个几何体”这样的方式来叙述的。</p>
<p>在Geometry中，于是就使用存储序号的方式进行相互引用。Geometry中有两个数组，一个存储它的顶点的序号，一个存储它的拓扑边界几何体的序号。</p>
<p>几何体的顶点是网格中的节点，我们称为“第0维几何体”。而对于一个“第m维几何体” 来说，它的拓扑边界几何体是“第m-1维的几何体”。每个几何体总是往低维进行索引，从而获得关于其自身结构的所有信息。</p>
<p>于是，对于一个给定的网格类的对象a_mesh，为了得到某一个维数(比如第k维)的几何体的个数，我们可以使用<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u_int n = a_mesh.<span class="built_in">n_geometry</span>(k);</span><br></pre></td></tr></table></figure><br>得到。而为了得到第k维的第l个几何体，则可以使用<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GeometryBM&amp; geo = a_mesh.<span class="built_in">geometry</span>(k, l);</span><br></pre></td></tr></table></figure><br>这样，我们获得了一个几何体的对象，然后就可以知道它的顶点和拓扑边界的序号，就可以继续往低维进行索引了，比如我们取出上面得到的这个几何geo自己的边界，可以使用如下的代码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">u_int n_bnd = geo.<span class="built_in">n_boundary</span>(); <span class="comment">/// geo 的拓扑边界几何体的个数</span></span><br><span class="line"><span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_bnd;i ++) &#123; <span class="comment">/// 进行遍历</span></span><br><span class="line">  u_int bnd_idx = geo.<span class="built_in">boundary</span>(i); <span class="comment">/// 第i个边界几何体的序号</span></span><br><span class="line">  GeometryBM&amp; bnd_geo = a_mesh.<span class="built_in">geometry</span>(k<span class="number">-1</span>, bnd_idx); <span class="comment">/// 取出来</span></span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>网格类有两个模板参数，一个是DIM，一个是DOW。其中DIM是网格所在的区域，作为一个流形的维数。比如平面上的一个多边形，是二维的，球面也是二维的。这个数决定了Mesh类中间，用来存储各维几何体的数组的数组的大小，事实上这是一个DIM+1个元素的数组，分别存储第0维一直到第DIM维的几何体。</p>
<p>另外一个模板参数DOW是Dimension Of World的缩写，标识的是网格所在的流形所在的欧式空间的维数。比如平面上的一个多边形，DOW=2，而对于球面，则DOW=3。</p>
<p>不知你注意到没有，我们事实上到现在为止还没有说网格中的点的坐标呢！DOW事实上给定的就是网格中的点的坐标的维数。在Mesh类中，存储着一个坐标的数组，其中每个元素是一个Point<DOW>型的对象，事实上就是一个坐标而已。</p>
<p>对于一个“0维几何体”，它的顶点序号具有不一样的意义，事实上是说自己作为网格中的一个节点，坐标是坐标数组中的哪一个。而“0维几何体界”的拓扑边界是没有意义的，所以请不要使用其中的信息：那个数AFEPack不会负责维护的！</p>
<p>“0维几何体” 的这种特殊性，给我们的程序常常带来了一些麻烦。比如，我们想取一个几何体geo的第k个顶点的坐标，需要使用下面的方式：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">u_int vtx_idx = geo.<span class="built_in">vertex</span>(k); <span class="comment">/// 节点几何体的序号</span></span><br><span class="line">GeometryBM&amp; vtx_geo = a_mesh.<span class="built_in">geometry</span>(<span class="number">0</span>, vtx_idx); <span class="comment">/// 取出该节点几何体</span></span><br><span class="line">u_int pnt_idx = vtx_geo.<span class="built_in">vertex</span>(<span class="number">0</span>); <span class="comment">/// 取出坐标的序号</span></span><br><span class="line">Point&lt;DOW&gt;&amp; pnt = a_mesh.<span class="built_in">point</span>(pnt_idx); <span class="comment">/// 取出坐标</span></span><br></pre></td></tr></table></figure><br>有时候，你自己可以保证vtx_idx和pnt_idx是一样的，这样可以省下来两行，但是库的内部并不能保证这一点。<br>AFEPack的内部设计语言将节点称为“0维几何体”，把线段称为“1维几何体”等等的目标并不是想标新立异，而是为了统一，因为计算机更善于理解更加统一的语言。而且，在这样的语言下，我们事实上可以描述任意维数的网格，对网格中的几何体的形状也没有什么既定的要求，是一种非常灵活的描述网格的数据格式。</p>
<p>一个Mesh类中的数据，如果被写到文件中，就是完全按照其在内存中的方式进行输出的。首先输出的是坐标，然后是0维几何体，1维几何体，…，直到DIM维几何体。</p>
<h1 id="AFEPack-教学系列之九-局部加密功能的展示"><a href="#AFEPack-教学系列之九-局部加密功能的展示" class="headerlink" title="AFEPack 教学系列之九: 局部加密功能的展示"></a>AFEPack 教学系列之九: 局部加密功能的展示</h1><p>网格的局部加密从原理上来说是很简单的事情，但是具体的实现相当复杂。AFEPack支持在二维和三维的单纯形网格上进行局部加密和稀疏化的操作。为了实现加密和稀疏化，我们事实上要处理不同的网格之间的关系。AFEPack通过一个所谓几何遗传树的数据结构来实现。几何遗传树是一个由不断加密的几何体构成的树型数据结构，而每个网格则是这棵树的一个所谓截面上的所有叶子节点构成的。AFEPack支持的网格上的操作可以是非常大幅度的操作，它通过几个分解了的动作简单地完成了需要构造复杂的算法来完成的功能。涉及到的概念包括非正则网格、半正则网格和正则网格。在一个网格被进行了自适应操作后，获得的是一个所谓非正则网格。这个非正则网格进行一下半正则化，就得到一个半正则网格。然后再进行一下正则化，就得到了正则网格。在正则网格上就可以按照正常的程序建造有限元空间了。这中间的过程相当复杂，不是一两句话就可以说清楚的。如果有兴趣，我们可以在讨论班上慢慢介绍。下面就是一个简单的例子：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   refine.cpp</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Wed Mar  7 11:43:40 2007</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @brief </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/HGeometry.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/// 声明几何遗传树，并从 Easymesh 格式的文件中读入数据</span></span><br><span class="line">  HGeometryTree&lt;DIM&gt; h_tree;</span><br><span class="line">  h_tree.<span class="built_in">readEasyMesh</span>(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 在背景网格上建立第一个非正则网格，并均匀加密三次</span></span><br><span class="line">  <span class="function">IrregularMesh&lt;DIM&gt; <span class="title">irregular_mesh</span><span class="params">(h_tree)</span></span>;</span><br><span class="line">  irregular_mesh.<span class="built_in">globalRefine</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">/// 对非正则网格做半正则化和正则化</span></span><br><span class="line">    irregular_mesh.<span class="built_in">semiregularize</span>();</span><br><span class="line">    irregular_mesh.<span class="built_in">regularize</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 这就是通过正则化得到的网格</span></span><br><span class="line">    RegularMesh&lt;DIM&gt;&amp; regular_mesh = irregular_mesh.<span class="built_in">regularMesh</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 将这个网格输出到数据文件中</span></span><br><span class="line">    regular_mesh.<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;D.dx&quot;</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Press ENTER to continue or CTRL+C to stop ...&quot;</span> &lt;&lt; std::flush;</span><br><span class="line">    <span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下面一段计算用于加密的指示子。我们在以 c0 和 c1 两个点为中心，以半</span></span><br><span class="line"><span class="comment">     * 径处于 0.004 到 0.005 直接的环状区域中设置指示子的值为单元的面积，</span></span><br><span class="line"><span class="comment">     * 从而会将这两个环状区域中的地带均匀加密掉。其他部分的指示子是零。</span></span><br><span class="line"><span class="comment">     * 所有这些计算都是手工进行的，您需要深入了解网格中的数据放置方式。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Indicator&lt;DIM&gt; <span class="title">indicator</span><span class="params">(regular_mesh)</span></span>;</span><br><span class="line">    <span class="function">Point&lt;DIM&gt; <span class="title">c0</span><span class="params">(<span class="number">0.495</span>, <span class="number">0.5</span>)</span></span>;</span><br><span class="line">    <span class="function">Point&lt;DIM&gt; <span class="title">c1</span><span class="params">(<span class="number">0.505</span>, <span class="number">0.5</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; regular_mesh.<span class="built_in">n_geometry</span>(<span class="number">2</span>);i ++) &#123;</span><br><span class="line">      <span class="comment">/// 这是三角形的三个顶点。对于三角形和双生三角形都是这样的。</span></span><br><span class="line">      Point&lt;DIM&gt;&amp; p0 = regular_mesh.<span class="built_in">point</span>(regular_mesh.<span class="built_in">geometry</span>(<span class="number">2</span>,i).<span class="built_in">vertex</span>(<span class="number">0</span>));</span><br><span class="line">      Point&lt;DIM&gt;&amp; p1 = regular_mesh.<span class="built_in">point</span>(regular_mesh.<span class="built_in">geometry</span>(<span class="number">2</span>,i).<span class="built_in">vertex</span>(<span class="number">1</span>));</span><br><span class="line">      Point&lt;DIM&gt;&amp; p2 = regular_mesh.<span class="built_in">point</span>(regular_mesh.<span class="built_in">geometry</span>(<span class="number">2</span>,i).<span class="built_in">vertex</span>(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// 这是三角形的重心</span></span><br><span class="line">      <span class="function">Point&lt;DIM&gt; <span class="title">p</span><span class="params">((p0[<span class="number">0</span>] + p1[<span class="number">0</span>] + p2[<span class="number">0</span>])/<span class="number">3.</span>, (p0[<span class="number">1</span>] + p1[<span class="number">1</span>] + p2[<span class="number">1</span>])/<span class="number">3.</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// 手工计算三角形的面积</span></span><br><span class="line">      <span class="keyword">double</span> area = ((p1[<span class="number">0</span>] - p0[<span class="number">0</span>])*(p2[<span class="number">1</span>] - p0[<span class="number">1</span>]) -</span><br><span class="line">                     (p2[<span class="number">0</span>] - p0[<span class="number">0</span>])*(p1[<span class="number">1</span>] - p0[<span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// 计算三角形的重心到 c0 和 c1 的距离。如果三角形过大，这个计算会抓</span></span><br><span class="line">      <span class="comment">/// 不住正确的指示子，所以一开始我们把网格均匀加密了三倍。</span></span><br><span class="line">      <span class="keyword">double</span> d0 = (p - c0).<span class="built_in">length</span>();</span><br><span class="line">      <span class="keyword">double</span> d1 = (p - c1).<span class="built_in">length</span>();</span><br><span class="line">      <span class="keyword">if</span> ((d0 &gt; <span class="number">0.004</span> &amp;&amp; d0 &lt; <span class="number">0.005</span>) ||</span><br><span class="line">          (d1 &gt; <span class="number">0.004</span> &amp;&amp; d1 &lt; <span class="number">0.005</span>)) &#123; <span class="comment">/// 在环状区域中设置指示子</span></span><br><span class="line">        indicator[i] = area;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 下面的几行调用进行自适应的函数，都是套话。</span></span><br><span class="line">    <span class="function">MeshAdaptor&lt;DIM&gt; <span class="title">mesh_adaptor</span><span class="params">(irregular_mesh)</span></span>;</span><br><span class="line">    mesh_adaptor.<span class="built_in">convergenceOrder</span>() = <span class="number">0.</span>; <span class="comment">/// 设置收敛阶为0</span></span><br><span class="line">    mesh_adaptor.<span class="built_in">refineStep</span>() = <span class="number">1</span>; <span class="comment">/// 最多允许加密一步</span></span><br><span class="line">    mesh_adaptor.<span class="built_in">setIndicator</span>(indicator);</span><br><span class="line">    mesh_adaptor.<span class="built_in">tolerence</span>() = <span class="number">2.5e-10</span>; <span class="comment">/// 自适应的忍量</span></span><br><span class="line">    mesh_adaptor.<span class="built_in">adapt</span>(); <span class="comment">/// 完成自适应</span></span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">1</span>);   </span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><br>下面是一个算例网格的样子：<br><a target="_blank" rel="noopener" href="http://rli.bloghome.cn/photos/p_small/8d365cc574e6f262ae930c9491549b0e.gif">http://rli.bloghome.cn/photos/p_small/8d365cc574e6f262ae930c9491549b0e.gif</a></p>
<h1 id="AFEPack教学系列之十-处理边界条件-I"><a href="#AFEPack教学系列之十-处理边界条件-I" class="headerlink" title="AFEPack教学系列之十: 处理边界条件(I)"></a>AFEPack教学系列之十: 处理边界条件(I)</h1><p>我们学偏微分方程的数值解的课程的时候，首先就是解泊松方程。而在会用有限元程序求解泊松方程了以后，马上就会考虑泊松方程的一些变形。当然，如果不使用一些软件包，白手起家来做一个有限元程序求解泊松方程的话，确实需要相当的勇气和时间的。</p>
<p>在考虑泊松方程的变形的时候，或许第一件想做的事情就是期望解一下Neuman边值问题了。但是事实上的情况是，求解变二次系数的方程的实现，比实现Neumann边值的程序要简单得多。</p>
<p>前面，我们已经看到了变二次系数的方程的求解。这里，让我们来讨论Neumann边值问题的实现方法。应用边值条件这个问题之所以麻烦，就麻烦在边值条件其实是一个约束。我们实现它的方法，却绝对不能将它作为一个约束加上去，否则就会面临要解一个非正定矩阵的尴尬局面，是无论如何不能接受的。因此，我们必须将这个约束手工从线性系统中消去。</p>
<p>要想手工地修正线性系统，我们必须深入了解线性系统中实现矩阵和向量的这些类。现在AFEPack使用的是来自deal.II的线性代数包，所以，我们在这里先介绍一下deal.II中提供的稀疏矩阵和向量的类的结构和使用方法。</p>
<p>deal.II 的作者Wolfgang曾经因为AFEPack中实现的多线程类的界面中，使用了deal.II的代码中实现技术而发信质问我。但是我其实在那里已经给了deal.II包citation的，只是因为我现在为了方便使用中文的用户，改用中文写注释了。而Wolfgang是因为看不懂中文找不到给他的引用在什么地方而已。</p>
<p>我在这里提到这个，主要是希望提醒一些同僚，以后在这些敏感的位置，还是细致一些比较恰当。Wolfgang本人是一个广受称赞的绝对nice guy，但是对于credit这样的事情也是毫不含糊的哦，;-)</p>
<p>鉴于这个原因，我在这下面写一句英文的说明，主要是为了给deal.II的作者们看的。</p>
<p>In the following, let us discussed the usage of the sparse matrix and vector implemented<br>in deal.II(url: <a target="_blank" rel="noopener" href="http://www.dealii.org">http://www.dealii.org</a>). Please refer the original document obtained from<br>its homepage for details.</p>
<p>AFEPack使用了deal.II中的线性代数包，看中的是deal.II中的实现结构很漂亮，给使用者的接口通过细致的面对对象的分析，相当合理和有扩展性。作为设计算法的研究人员，我并不在意其中的求解器是否高效－－－反正我们是要自己写求解器的。另外，现在新版的deal.II开始支持使用petsc的求解器，这或许对很多不想自己写求解器的人来说，是个大好事啊。</p>
<p>deal.II中的稀疏矩阵，使用的是所谓的行压缩存储结构。这个行压缩存储结构，事实上就是用三个数组来存储一个稀疏矩阵的非零元素。如果您不知道啥叫做稀疏矩阵的话，我这里就不补课了。<br>deal.II中稀疏矩阵的数据结构:<br>考虑一个M x N的稀疏矩阵，数据结构中的三个数组分别叫做 ：</p>
<ol>
<li><p>行开始指标数组(rowstarts)<br>这是一个长度为M + 1的整数数组，其中第i个位置的这个整数的值，是我们从矩阵的第0行开始，按行来数矩阵中的非零元素的个数，一直数到第i行的第一个非零元素的时候，数出来的这个数。由于是用C++，这里我们的记数都是从0开始的。从而我们知道，这个数组的第0个元素总是0的，第M个元素则是该矩阵中所有非零元的个数，记为nnz。</p>
</li>
<li><p>列指标数组(colnums)<br>这也是一个整数数组，长度为nnz。其中的每个元素事实上就是每一行的非零元素是哪一列的列指标。比如，对于第i行，我们知道这一行总共的非零元的个数是</p>
</li>
</ol>
<p>rowstarts[i + 1] - rowstarts[i]</p>
<p>而这一行的哪几个列是非零的，这些列的列指标就是colnums数组中的</p>
<p>colnums[rowstarts[i]],<br>colnums[rowstarts[i] + 1],<br>… …,<br>colnums[rowstarts[i + 1] - 1]</p>
<p>这些个数。</p>
<p>其实，有了上面的这两个数组，我们就已经获得了这个稀疏矩阵的非零元分布的样子了。所以，这两个数组在deal.II中先首先包装成为了所谓的稀疏模板类SparsityPattern。这样的包装是非常必要的，因为我们常常会使用相同的稀疏模板构造很多不同的稀疏矩阵。</p>
<ol>
<li>矩阵元素数组(val)<br>这是长度为nnz的实数数组，现在deal.II对float, double两种数据类型进行有特别的实现。这个数组中的第k个元素的意义为：<br>如果rowstarts[i] &lt;= k &lt; rowstarts[i + 1]，而j = colnums[k]，则矩阵中的元素<br>a(i, j) = val[k]</li>
</ol>
<p>deal.II的稀疏矩阵类SparseMatrix中包含一个对SparsityPattern的引用以及一个val数组。</p>
<p>所以，您需要学会SparsityPattern和SparseMatrix这两个类的使用方法。</p>
<p>写太长了，只能在下一篇中说边界条件的问题 了… …</p>
<h1 id="AFEPack教学系列之十-处理边界条件-II"><a href="#AFEPack教学系列之十-处理边界条件-II" class="headerlink" title="AFEPack教学系列之十: 处理边界条件(II)"></a>AFEPack教学系列之十: 处理边界条件(II)</h1><p>继续侃，希望您能够搞明白，:-)</p>
<p>现在在库函数中，自动处理了狄氏边值的问题。处理的方式为：首先由用户提供在每种材料标识的情况下，解函数在自由度的插值点上的函数值的表达式；然后，库通过判断每个自由度的材料标识、以及使用自由度的插值点的坐标，获得自由度本身的。从而，在需要求解的线性系统中，我们就已经知道了一部分解变量的值，于是，现在的问题就可以如下来说了：我们有一个线性方程组</p>
<pre><code>              A x = b
</code></pre><p>现在，我们可以将其分块为</p>
<pre><code>            [ A_11 A_12 ] [ x_1 ]   [ b_1 ]
            [           ] [     ] = [     ]
            [ A_21 A_22 ] [ x_2 ]   [ b_2 ]
</code></pre><p>现在呢，我们已经知道了x_2的值了。于是，我们的手段就是用下面的线性系统来代替上面的：</p>
<pre><code>            [ A_11   0 ] [ x_1 ]   [ b_1 - A_12 x_2 ]
            [          ] [     ] = [                ]
            [  0     I ] [ x_2 ]   [       x_2      ]
</code></pre><p>其中I是单位对角块，0表示零块。可以看到，修改过的系统和原系统相比，具有完全相同的解，而且，整个矩阵的结构可以保持不必修改。在实际实现的时候，可以用A_22的对角线来代替I这块，效果更好一些。</p>
<p>上面就是库中间处理狄氏边值的原理。但是，如果基函数不是正交的拉格朗日插值函数，库中的程序会给出错误的结果的。在事实上遇到这样的情况的时候，解决的方案也是有的，之所以能够解决的基本原理在于，狄氏边值是强制加上的，所以边值的处理可以和区域内部的求解解耦合，我们就不讨论这个话题了。</p>
<p>下面我们来看看加上Neumann边值的方法。首先，对于Neumann边值问题，我们知道边值将会贡献一个边界积分到右端项上去，因此，我们需要能够做边界积分的功能；另外，Neumann边值问题的解具有一个自由度(假设单连通区域)，在解上加上一个常数的话还是解，因此，我们需要在线性系统中将这个因素带来的矩阵退化消掉，这个得我们手工做一下。</p>
<p>我们先来看边界积分的问题。为了能够做边界积分，我们需要使用所谓的DGFEMSpace类。这个类是后来加上去的，使得空间中不但有体单元，而且有面单元，只是面单元上不分配自由度而已。请看下面的代码示例：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2 <span class="comment">/// 考虑二维问题</span></span></span><br><span class="line"></span><br><span class="line">Mesh&lt;DIM&gt; mesh; <span class="comment">/// 网格对象</span></span><br><span class="line">mesh.<span class="built_in">readData</span>(data_file) <span class="comment">/// 读入网格数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 三角形单元上的一阶参考单元</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">TemplateGeometry&lt;DIM&gt; triangle_template_geometry;</span><br><span class="line">CoordTransform&lt;DIM,DIM&gt; triangle_coord_transform;</span><br><span class="line">TemplateDOF&lt;DIM&gt; triangle_1_template_dof;</span><br><span class="line">BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt; triangle_1_basis_function;</span><br><span class="line">UnitOutNormal&lt;DIM&gt; triangle_unit_out_normal; <span class="comment">/// 注意这一行</span></span><br><span class="line"></span><br><span class="line">triangle_template_geometry.<span class="built_in">readData</span>(<span class="string">&quot;triangle.tmp_geo&quot;</span>);</span><br><span class="line">triangle_coord_transform.<span class="built_in">readData</span>(<span class="string">&quot;triangle.crd_trs&quot;</span>);</span><br><span class="line">triangle_unit_out_normal.<span class="built_in">readData</span>(<span class="string">&quot;triangle.out_nrm&quot;</span>);</span><br><span class="line"></span><br><span class="line">triangle_1_template_dof.<span class="built_in">reinit</span>(triangle_template_geometry);</span><br><span class="line">triangle_1_template_dof.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">triangle_1_basis_function.<span class="built_in">reinit</span>(triangle_1_template_dof);</span><br><span class="line">triangle_1_basis_function.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 做体单元的参考单元</span></span><br><span class="line">std::vector&lt;TemplateElement&lt;<span class="keyword">double</span>,DIM,DIM&gt; &gt; <span class="built_in">template_element</span>(<span class="number">1</span>);</span><br><span class="line">template_element[<span class="number">0</span>].<span class="built_in">reinit</span>(triangle_template_geometry,</span><br><span class="line">                           triangle_1_template_dof,</span><br><span class="line">                           triangle_coord_transform,</span><br><span class="line">                           triangle_1_basis_function,</span><br><span class="line">                           triangle_unit_out_normal);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将一维的线变换到二维的线的模板几何信息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">TemplateGeometry&lt;DIM<span class="number">-1</span>&gt; interval_template_geometry;</span><br><span class="line">CoordTransform&lt;DIM<span class="number">-1</span>,DIM&gt; interval_to2d_coord_transform;</span><br><span class="line"></span><br><span class="line">interval_template_geometry.<span class="built_in">readData</span>(<span class="string">&quot;interval.tmp_geo&quot;</span>);</span><br><span class="line">interval_to2d_coord_transform.<span class="built_in">readData</span>(<span class="string">&quot;interval.to2d.crd_trs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 做面单元的模板单元</span></span><br><span class="line">std::vector&lt;TemplateDGElement&lt;DIM-1,DIM&gt; &gt; <span class="built_in">dg_template_element</span>(<span class="number">1</span>);</span><br><span class="line">dg_template_element[<span class="number">0</span>].<span class="built_in">reinit</span>(interval_template_geometry,</span><br><span class="line">                              interval_to2d_coord_transform);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 声明有限元空间</span></span><br><span class="line">DGFEMSpace&lt;double,DIM&gt; fem_space(mesh,</span><br><span class="line">                                 template_element,</span><br><span class="line">                                 dg_template_element);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 建立有限元空间的体单元</span></span><br><span class="line">u_int n_ele = mesh.<span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">fem_space.<span class="built_in">element</span>().<span class="built_in">resize</span>(n_ele);</span><br><span class="line"><span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele;++ i) &#123;</span><br><span class="line">  fem_space.<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(fem_space,i,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">fem_space.<span class="built_in">buildElement</span>();</span><br><span class="line">fem_space.<span class="built_in">buildDof</span>();</span><br><span class="line">fem_space.<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line"></span><br><span class="line">u_int n_side = mesh.<span class="built_in">n_geometry</span>(DIM<span class="number">-1</span>);</span><br><span class="line">u_int n_dg_ele = <span class="number">0</span>; <span class="comment">/// 我们来统计一下边界上的边的个数</span></span><br><span class="line"><span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_side;++ i) &#123;</span><br><span class="line">  <span class="keyword">if</span> (mesh.<span class="built_in">geometry</span>(DIM<span class="number">-1</span>,i).<span class="built_in">boundaryMark</span>() != <span class="number">0</span>) &#123;</span><br><span class="line">    n_dg_ele += <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// 建立有限元空间的面单元</span></span><br><span class="line">fem_space.<span class="built_in">dgElement</span>().<span class="built_in">resize</span>(n_dg_ele);</span><br><span class="line"><span class="keyword">for</span> (u_int i = <span class="number">0</span>, j = <span class="number">0</span>;i &lt; n_side;++ i) &#123;</span><br><span class="line">  <span class="keyword">if</span> (mesh.<span class="built_in">geometry</span>(DIM<span class="number">-1</span>,i).<span class="built_in">boundaryMark</span>() != <span class="number">0</span>) &#123;</span><br><span class="line">    fem_space.<span class="built_in">dgElement</span>(j).<span class="built_in">reinit</span>(fem_space, i, <span class="number">0</span>);</span><br><span class="line">    j += <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">fem_space.<span class="built_in">buildDGElement</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 哈哈，现在已经可以在面单元上积分了</span></span><br><span class="line">DGFEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::DGElementIterator</span><br><span class="line">  the_dgele = fem_space.<span class="built_in">beginDGElement</span>(),</span><br><span class="line">  end_dgele = fem_space.<span class="built_in">endDGElement</span>();</span><br><span class="line"><span class="keyword">for</span> (;the_dgele != end_dgele;++ the_dgele) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 参考单元的体积</span></span><br><span class="line">  <span class="keyword">double</span> vol = the_dgele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 积分公式，注意它的积分点的维数少一啊</span></span><br><span class="line">  <span class="keyword">const</span> QuadratureInfo&lt;DIM<span class="number">-1</span>&gt;&amp; qi = the_dgele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">3</span>);</span><br><span class="line">  u_int n_q_pnt = qi.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 变换的雅可比行列式</span></span><br><span class="line">  std::vector&lt;<span class="keyword">double</span>&gt; jac = the_dgele-&gt;<span class="built_in">local_to_global_jacobian</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 积分点变换到网格中去</span></span><br><span class="line">  std::vector&lt;Point&lt;DIM&gt; &gt; q_pnt = the_dgele-&gt;<span class="built_in">local_to_global</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 和它邻接的两个体单元的指针</span></span><br><span class="line">  Element&lt;<span class="keyword">double</span>,DIM&gt; * p_neigh0 = the_dgele-&gt;<span class="built_in">p_neighbourElement</span>(<span class="number">0</span>);</span><br><span class="line">  Element&lt;<span class="keyword">double</span>,DIM&gt; * p_neigh1 = the_dgele-&gt;<span class="built_in">p_neighbourElement</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 法向单位向量，对 0 号邻居来说是外法向</span></span><br><span class="line">  std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; un = <span class="built_in">unitOutNormal</span>(q_pnt, *p_neigh0, *the_dgele);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 我想下面的数值积分程序你应该会写了吧，不明白你还需要什么更多的信</span></span><br><span class="line">  <span class="comment">/// 息了，;-)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>太长了，太长了，下回分解吧… …</p>
<h1 id="AFEPack教学系列之十-处理边界条件-III"><a href="#AFEPack教学系列之十-处理边界条件-III" class="headerlink" title="AFEPack教学系列之十: 处理边界条件(III)"></a>AFEPack教学系列之十: 处理边界条件(III)</h1><p>现在，我们已经会了在边界上进行的积分，从而能够将非齐次Neumann边界条件对线性系统的右端项上的贡献算出来了。那么，现在的矩阵仍然是一个奇异矩阵，而且我们精确地知道，只要我们固定住解中间的一个变量，就能够得到唯一解。下面，我们就来对矩阵进行手工地修改，实现这个效果。事实上，我们做的事情，相当于对一个变量，使用了狄氏边界条件而已。我假设您已经了解了deal.II中的SparsityPattern、SparseMatrix和Vector这几个类的用法了，我们的线性系统已经准备好了为A x = b，请看示例的代码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SparseMatrix&lt;<span class="keyword">double</span>&gt; stiff_matrix; <span class="comment">/// 这是矩阵 A</span></span><br><span class="line">FEMFunction&lt;<span class="keyword">double</span>&gt; u_h; <span class="comment">/// 这是解变量 x</span></span><br><span class="line">Vector&lt;<span class="keyword">double</span>&gt; f_h; <span class="comment">/// 这是右端项 b</span></span><br><span class="line"></span><br><span class="line">&#123; <span class="comment">/// 先修改矩阵的第一行和第一列</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> * row_start</span><br><span class="line">    = stiff_matrix.<span class="built_in">get_sparsity_pattern</span>().<span class="built_in">get_rowstart_indices</span>();</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> * column</span><br><span class="line">    = stiff_matrix.<span class="built_in">get_sparsity_pattern</span>().<span class="built_in">get_column_numbers</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> j = row_start[<span class="number">0</span>] + <span class="number">1</span>;j &lt; row_start[<span class="number">1</span>];j ++) &#123;</span><br><span class="line">    stiff_matrix.<span class="built_in">global_entry</span>(j) = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">int</span> k = column[j];</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> * p = std::<span class="built_in">find</span>(&amp;column[row_start[k] + <span class="number">1</span>],</span><br><span class="line">                                       &amp;column[row_start[k + <span class="number">1</span>]], <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != &amp;column[row_start[k + <span class="number">1</span>]]) &#123;</span><br><span class="line">      stiff_matrix.<span class="built_in">global_entry</span>(p - &amp;column[row_start[<span class="number">0</span>]]) = <span class="number">0.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 这是修改解变量和右端项的第一个元素</span></span><br><span class="line">  <span class="built_in">u_h</span>(<span class="number">0</span>) = <span class="number">0.0</span>;</span><br><span class="line">  <span class="built_in">f_h</span>(<span class="number">0</span>) = <span class="number">0.0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样，矩阵就成为了非奇异的矩阵，可以调用正定矩阵的求解器来求解了。只是这个矩阵尽管和狄氏边值问题的矩阵的规模差不太多，但是它的条件数比狄氏边值问题的条件数要坏很多，求解所花的迭代步数要多不少，怎么加快求解的技巧值得深入地挖一挖。</p>
<h1 id="AFEPack教学系列之十一：解二次方程-局部加密"><a href="#AFEPack教学系列之十一：解二次方程-局部加密" class="headerlink" title="AFEPack教学系列之十一：解二次方程+局部加密"></a>AFEPack教学系列之十一：解二次方程+局部加密</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   refine.cpp</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Wed Mar  7 11:43:40 2007</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @brief  下面的这个程序，是将求解偏微分方程和局部网格加密简单组合在</span></span><br><span class="line"><span class="comment"> *         了一起。我们用的方程是一个含有间断二次系数的椭圆型方程，在</span></span><br><span class="line"><span class="comment"> *         系数间断的位置，解会有一个弱间断。我们瞎算了一个长得象误差</span></span><br><span class="line"><span class="comment"> *         估计的量来做自适应指示子，您可以试试它的效果，;-)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/AMGSolver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/FEMSpace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Operator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/BilinearOperator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/EasyMesh.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/HGeometry.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 边界条件</span></span><br><span class="line"><span class="keyword">double</span> _u_b_(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sin</span>(p[<span class="number">0</span>] + p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 右端项</span></span><br><span class="line"><span class="keyword">double</span> _f_(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sin</span>(p[<span class="number">0</span>]) + <span class="built_in">exp</span>(p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 二次系数</span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">A</span><span class="params">(<span class="keyword">const</span> Point&lt;DIM&gt;&amp; p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (p[<span class="number">0</span>] &gt; p[<span class="number">1</span>]*p[<span class="number">1</span>]) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">4.0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p[<span class="number">0</span>] &gt; <span class="built_in">sin</span>(p[<span class="number">1</span>])) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2.0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1.0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 二次问题的刚度矩阵，这一段程序我们已经在前面的文章中解释过了。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Matrix</span> :</span> <span class="keyword">public</span> StiffMatrix&lt;DIM,<span class="keyword">double</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Matrix</span>(FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; sp) : StiffMatrix&lt;DIM,<span class="keyword">double</span>&gt;(sp) &#123;&#125;;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">getElementMatrix</span><span class="params">(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele0,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele1,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> ActiveElementPairIterator&lt;DIM&gt;::State</span></span></span><br><span class="line"><span class="function"><span class="params">                state=ActiveElementPairIterator&lt;DIM&gt;::EQUAL)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n_ele_dof = <span class="built_in">elementDof0</span>().<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">double</span> volume = ele0.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">    <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = ele0.<span class="built_in">findQuadratureInfo</span>(<span class="built_in">algebricAccuracy</span>());</span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; jacobian = ele0.<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">    <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line">    std::vector&lt;Point&lt;DIM&gt; &gt; q_point = ele0.<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">    std::vector&lt;std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; &gt; basis_gradient = ele0.<span class="built_in">basis_function_gradient</span>(q_point);</span><br><span class="line">    std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; basis_value = ele0.<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;l ++) &#123;</span><br><span class="line">      <span class="keyword">double</span> Jxw = quad_info.<span class="built_in">weight</span>(l)*jacobian[l]*volume;</span><br><span class="line">      <span class="keyword">double</span> a_val = <span class="built_in">A</span>(q_point[l]);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; n_ele_dof;j ++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>;k &lt; n_ele_dof;k ++) &#123;</span><br><span class="line">          <span class="built_in">elementMatrix</span>(j,k) += Jxw*a_val*</span><br><span class="line">            <span class="built_in">innerProduct</span>(basis_gradient[j][l], basis_gradient[k][l]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 在当前网格上求解二次方程，然后计算自适应指示子。关于求解方程的部分</span></span><br><span class="line"><span class="comment">/// 和前面的其他程序是一模一样的，但是计算自适应指示子的部分则是完全手</span></span><br><span class="line"><span class="comment">/// 工做的。我想您自己读懂这个部分会比听我讲清楚这个部分要获益更多，我</span></span><br><span class="line"><span class="comment">/// 就特意把注释都抹去了，;-)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_indicator</span><span class="params">(Indicator&lt;DIM&gt;&amp; ind,</span></span></span><br><span class="line"><span class="function"><span class="params">                   RegularMesh&lt;DIM&gt;&amp; mesh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  TemplateGeometry&lt;DIM&gt; triangle_template_geometry;</span><br><span class="line">  triangle_template_geometry.<span class="built_in">readData</span>(<span class="string">&quot;triangle.tmp_geo&quot;</span>);</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt; triangle_coord_transform;</span><br><span class="line">  triangle_coord_transform.<span class="built_in">readData</span>(<span class="string">&quot;triangle.crd_trs&quot;</span>);</span><br><span class="line">  <span class="function">TemplateDOF&lt;DIM&gt; <span class="title">triangle_template_dof</span><span class="params">(triangle_template_geometry)</span></span>;</span><br><span class="line">  triangle_template_dof.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  BasisFunctionAdmin&lt;double,DIM,DIM&gt; triangle_basis_function(triangle_template_dof);</span><br><span class="line">  triangle_basis_function.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  TemplateGeometry&lt;DIM&gt; twin_triangle_template_geometry;</span><br><span class="line">  twin_triangle_template_geometry.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.tmp_geo&quot;</span>);</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt; twin_triangle_coord_transform;</span><br><span class="line">  twin_triangle_coord_transform.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.crd_trs&quot;</span>);</span><br><span class="line">  <span class="function">TemplateDOF&lt;DIM&gt; <span class="title">twin_triangle_template_dof</span><span class="params">(twin_triangle_template_geometry)</span></span>;</span><br><span class="line">  twin_triangle_template_dof.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  BasisFunctionAdmin&lt;double,DIM,DIM&gt; twin_triangle_basis_function(twin_triangle_template_dof);</span><br><span class="line">  twin_triangle_basis_function.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  std::vector&lt;TemplateElement&lt;<span class="keyword">double</span>,DIM,DIM&gt; &gt; <span class="built_in">template_element</span>(<span class="number">2</span>);</span><br><span class="line">  template_element[<span class="number">0</span>].<span class="built_in">reinit</span>(triangle_template_geometry,</span><br><span class="line">                             triangle_template_dof,</span><br><span class="line">                             triangle_coord_transform,</span><br><span class="line">                             triangle_basis_function);</span><br><span class="line">  template_element[<span class="number">1</span>].<span class="built_in">reinit</span>(twin_triangle_template_geometry,</span><br><span class="line">                             twin_triangle_template_dof,</span><br><span class="line">                             twin_triangle_coord_transform,</span><br><span class="line">                             twin_triangle_basis_function);</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;double,DIM&gt; fem_space(mesh, template_element);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> n_element = mesh.<span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">  fem_space.<span class="built_in">element</span>().<span class="built_in">resize</span>(n_element);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n_element;i ++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mesh.<span class="built_in">geometry</span>(DIM,i).<span class="built_in">n_vertex</span>() == <span class="number">3</span>) &#123;</span><br><span class="line">      fem_space.<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(fem_space,i,<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      fem_space.<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(fem_space,i,<span class="number">1</span>);      </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  fem_space.<span class="built_in">buildElement</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDof</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line"></span><br><span class="line">  <span class="function">Matrix <span class="title">stiff_matrix</span><span class="params">(fem_space)</span></span>;</span><br><span class="line">  stiff_matrix.<span class="built_in">algebricAccuracy</span>() = <span class="number">2</span>;</span><br><span class="line">  stiff_matrix.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">  FEMFunction&lt;double,DIM&gt; u_h(fem_space);</span><br><span class="line">  Vector&lt;<span class="keyword">double</span>&gt; f_h;</span><br><span class="line">  Operator::<span class="built_in">L2Discretize</span>(&amp;_f_, fem_space, f_h, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  BoundaryFunction&lt;double,DIM&gt; boundary(BoundaryConditionInfo::DIRICHLET,</span><br><span class="line">                                        <span class="number">1</span>, &amp;_u_b_);</span><br><span class="line">  BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(fem_space);</span><br><span class="line">  boundary_admin.<span class="built_in">add</span>(boundary);</span><br><span class="line">  boundary_admin.<span class="built_in">apply</span>(stiff_matrix, u_h, f_h);</span><br><span class="line"></span><br><span class="line">  <span class="function">AMGSolver <span class="title">solver</span><span class="params">(stiff_matrix)</span></span>;</span><br><span class="line">  solver.<span class="built_in">solve</span>(u_h, f_h);</span><br><span class="line"></span><br><span class="line">  u_h.<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;u_h.dx&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 从这里开始就是计算自适应指示子的部分了，;-)</span></span><br><span class="line">  u_int n_side = mesh.<span class="built_in">n_geometry</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="function">std::vector&lt;<span class="keyword">bool</span>&gt; <span class="title">sflag</span><span class="params">(n_side, <span class="literal">false</span>)</span></span>;</span><br><span class="line">  <span class="function">std::vector&lt;<span class="keyword">double</span>&gt; <span class="title">sjump</span><span class="params">(n_side)</span></span>;</span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator</span><br><span class="line">    the_ele = fem_space.<span class="built_in">beginElement</span>(),</span><br><span class="line">    end_ele = fem_space.<span class="built_in">endElement</span>();</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;the_ele != end_ele;++ the_ele, ++ i) &#123;</span><br><span class="line">    <span class="keyword">const</span> GeometryBM&amp; ele_geo = mesh.<span class="built_in">geometry</span>(DIM,i);</span><br><span class="line">    u_int n_bnd = ele_geo.<span class="built_in">n_boundary</span>();</span><br><span class="line">    <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_bnd;++ j) &#123;</span><br><span class="line">      u_int sid_idx = ele_geo.<span class="built_in">boundary</span>(j);</span><br><span class="line">      <span class="keyword">const</span> GeometryBM&amp; sid_geo = mesh.<span class="built_in">geometry</span>(<span class="number">1</span>, sid_idx);</span><br><span class="line">      <span class="keyword">const</span> GeometryBM&amp; vtx0 = mesh.<span class="built_in">geometry</span>(<span class="number">0</span>, sid_geo.<span class="built_in">vertex</span>(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">const</span> Point&lt;DIM&gt;&amp; p0 = mesh.<span class="built_in">point</span>(vtx0.<span class="built_in">vertex</span>(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">const</span> GeometryBM&amp; vtx1 = mesh.<span class="built_in">geometry</span>(<span class="number">0</span>, sid_geo.<span class="built_in">vertex</span>(<span class="number">1</span>));</span><br><span class="line">      <span class="keyword">const</span> Point&lt;DIM&gt;&amp; p1 = mesh.<span class="built_in">point</span>(vtx1.<span class="built_in">vertex</span>(<span class="number">0</span>));</span><br><span class="line">      <span class="function">Point&lt;DIM&gt; <span class="title">p</span><span class="params">(<span class="number">0.5</span>*(p0[<span class="number">0</span>] + p1[<span class="number">0</span>]), <span class="number">0.5</span>*(p0[<span class="number">1</span>] + p1[<span class="number">1</span>]))</span></span>;</span><br><span class="line">      std::vector&lt;<span class="keyword">double</span>&gt; u_h_grad = u_h.<span class="built_in">gradient</span>(p, *the_ele);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (sflag[sid_idx] == <span class="literal">false</span>) &#123;</span><br><span class="line">        sjump[sid_idx] = (u_h_grad[<span class="number">0</span>]*(p0[<span class="number">1</span>] - p1[<span class="number">1</span>]) -</span><br><span class="line">                          u_h_grad[<span class="number">1</span>]*(p1[<span class="number">0</span>] - p0[<span class="number">0</span>]));</span><br><span class="line">        sflag[sid_idx] = <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sjump[sid_idx] -= (u_h_grad[<span class="number">0</span>]*(p0[<span class="number">1</span>] - p1[<span class="number">1</span>]) -</span><br><span class="line">                           u_h_grad[<span class="number">1</span>]*(p1[<span class="number">0</span>] - p0[<span class="number">0</span>]));</span><br><span class="line">        sflag[sid_idx] = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  the_ele = fem_space.<span class="built_in">beginElement</span>();</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;the_ele != end_ele;++ the_ele, ++ i) &#123;</span><br><span class="line">    <span class="keyword">const</span> GeometryBM&amp; ele_geo = mesh.<span class="built_in">geometry</span>(DIM,i);</span><br><span class="line">    u_int n_bnd = ele_geo.<span class="built_in">n_boundary</span>();</span><br><span class="line">    ind[i] = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_bnd;++ j) &#123;</span><br><span class="line">      u_int sid_idx = ele_geo.<span class="built_in">boundary</span>(j);</span><br><span class="line">      <span class="keyword">if</span> (sflag[sid_idx] == <span class="literal">true</span>) <span class="keyword">continue</span>;</span><br><span class="line">      ind[i] += sjump[sid_idx]*sjump[sid_idx];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/// 声明几何遗传树，并从Easymesh格式的文件中读入数据</span></span><br><span class="line">  HGeometryTree&lt;DIM&gt; h_tree;</span><br><span class="line">  h_tree.<span class="built_in">readEasyMesh</span>(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 在背景网格上建立第一个非正则网格，并均匀加密三次</span></span><br><span class="line">  <span class="function">IrregularMesh&lt;DIM&gt; <span class="title">irregular_mesh</span><span class="params">(h_tree)</span></span>;</span><br><span class="line">  irregular_mesh.<span class="built_in">globalRefine</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">/// 对非正则网格做半正则化和正则化</span></span><br><span class="line">    irregular_mesh.<span class="built_in">semiregularize</span>();</span><br><span class="line">    irregular_mesh.<span class="built_in">regularize</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 这就是通过正则化得到的网格</span></span><br><span class="line">    RegularMesh&lt;DIM&gt;&amp; regular_mesh = irregular_mesh.<span class="built_in">regularMesh</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 将这个网格输出到数据文件中</span></span><br><span class="line">    regular_mesh.<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;D.dx&quot;</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Press ENTER to continue or CTRL+C to stop ...&quot;</span> &lt;&lt; std::flush;</span><br><span class="line">    <span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 下面一段计算用于加密的指示子。</span></span><br><span class="line">    <span class="function">Indicator&lt;DIM&gt; <span class="title">indicator</span><span class="params">(regular_mesh)</span></span>;</span><br><span class="line">    <span class="built_in">get_indicator</span>(indicator, regular_mesh);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 下面的几行调用进行自适应的函数，都是套话。</span></span><br><span class="line">    <span class="function">MeshAdaptor&lt;DIM&gt; <span class="title">mesh_adaptor</span><span class="params">(irregular_mesh)</span></span>;</span><br><span class="line">    mesh_adaptor.<span class="built_in">convergenceOrder</span>() = <span class="number">1.</span>; <span class="comment">/// 设置收敛阶为0</span></span><br><span class="line">    mesh_adaptor.<span class="built_in">refineStep</span>() = <span class="number">2</span>; <span class="comment">/// 最多允许加密一步</span></span><br><span class="line">    mesh_adaptor.<span class="built_in">setIndicator</span>(indicator);</span><br><span class="line">    mesh_adaptor.<span class="built_in">tolerence</span>() = <span class="number">1.0e-06</span>; <span class="comment">/// 自适应的忍量</span></span><br><span class="line">    mesh_adaptor.<span class="built_in">adapt</span>(); <span class="comment">/// 完成自适应</span></span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">1</span>);    </span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>列几个问题在这里，看有没有人能回答：</p>
<ul>
<li>现在我们没有利用到上一步的解来作为下一步的解的初值，您能够写出这样的程序么？</li>
<li>我们这里瞎写的这个自适应指示子特别地抹去了所有注释，您能够读懂这是个什么量么？</li>
<li>您读懂了上面的计算自适应指示子的程序后，能够自己把这个部分更新为正确的后验误差估计的形式么？ </li>
</ul>
<h1 id="AFEPack教学系列之十二-在流形上做网格加密的例子"><a href="#AFEPack教学系列之十二-在流形上做网格加密的例子" class="headerlink" title="AFEPack教学系列之十二: 在流形上做网格加密的例子"></a>AFEPack教学系列之十二: 在流形上做网格加密的例子</h1><p>我们常常看见进行自适应加密和稀疏化的程序，但是如果问题不是在一个欧式空间中的问题，而是在一个上提出的，比如是在一个球面上，那么我们怎么能够完成这样的网格上的h-自适应呢？</p>
<p>这个事情看上去好像比较复杂，但是仔细考虑起来其实是比较简单的。这中间最关键的部分其实在于我们如何定义“直线”，如果你给直线一个不一样的定义，那我们就可以在一个流形上，按照欧式空间中的算法，来做加密和稀疏化了。为了实现这一点，AFEPack 提供一个接口让用户来定义直线的方案，而为了定义直线，我们最根本的事实上要定义中点 。如果对任何一个两个端点已知的线段，我们能够知道其中点的计算方法，那么完成流形上的网格的加密和稀疏化的工作就显而易见了。请看下面的例子：这是前面二维平面上的加密和稀疏化的程序上做一个简单修改得到的。</p>
<p>我们使用的初始网格事实上就是一个正方形， 数据如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">o.n</span><br><span class="line">-------------------------------------------------</span><br><span class="line"><span class="number">4</span> <span class="number">2</span> <span class="number">5</span> **(Nnd, Nee, Nsd)**</span><br><span class="line"><span class="number">0</span> <span class="number">-1</span> <span class="number">-1</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span>  <span class="number">1</span> <span class="number">-1</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line"><span class="number">2</span>  <span class="number">1</span>  <span class="number">1</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line"><span class="number">3</span> <span class="number">-1</span>  <span class="number">1</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">-------------------------------------------------</span><br><span class="line"></span><br><span class="line">o.s</span><br><span class="line">-------------------------------------------------</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">-1</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">0</span> <span class="number">-1</span> <span class="number">1</span></span><br><span class="line"><span class="number">2</span> <span class="number">0</span> <span class="number">2</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">3</span> <span class="number">2</span> <span class="number">3</span> <span class="number">1</span> <span class="number">-1</span> <span class="number">1</span></span><br><span class="line"><span class="number">4</span> <span class="number">0</span> <span class="number">3</span> <span class="number">-1</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line">-------------------------------------------------</span><br><span class="line"></span><br><span class="line">o.e</span><br><span class="line">-------------------------------------------------</span><br><span class="line"><span class="number">2</span> <span class="number">4</span> <span class="number">5</span>   **(Nee, Nnd, Nsd)**</span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">-1</span> <span class="number">1</span> <span class="number">-1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">0</span></span><br><span class="line"><span class="number">1</span> <span class="number">0</span> <span class="number">2</span> <span class="number">3</span> <span class="number">-1</span> <span class="number">-1</span> <span class="number">0</span> <span class="number">3</span> <span class="number">4</span> <span class="number">2</span></span><br><span class="line">-------------------------------------------------</span><br></pre></td></tr></table></figure><br>程序如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/HGeometry.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2  <span class="comment">/// 我们在一个 2 维流形上操作</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DOW 3  <span class="comment">/// 这个 2 维的流形上的点的坐标是在三维欧式空间中</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 流形上计算中点的方法：猜猜看这样计算中点得到一个什么样子的流形啊</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param p0 线段的一个端点</span></span><br><span class="line"><span class="comment"> * @param p1 线段的另一个端点</span></span><br><span class="line"><span class="comment"> * @param bm 线段的材料标识</span></span><br><span class="line"><span class="comment"> * @param p  线段的中点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">my_midpoint</span><span class="params">(<span class="keyword">const</span> Point&lt;DOW&gt;&amp; p0,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">const</span> Point&lt;DOW&gt;&amp; p1,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">const</span> <span class="keyword">int</span>&amp; bm,</span></span></span><br><span class="line"><span class="function"><span class="params">                 Point&lt;DOW&gt;&amp; p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">double</span> R1 = <span class="built_in">sqrt</span>(<span class="number">2</span>), R0 = <span class="number">0.3</span>*R1;</span><br><span class="line">  p = (p0 + p1);</span><br><span class="line">  p /= <span class="number">2.0</span>;</span><br><span class="line">  <span class="keyword">double</span> r = <span class="built_in">sqrt</span>(p[<span class="number">0</span>]*p[<span class="number">0</span>] + p[<span class="number">1</span>]*p[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">if</span> (r &lt; R0) &#123;</span><br><span class="line">    p[<span class="number">2</span>] = <span class="built_in">fabs</span>(p[<span class="number">2</span>] - R1);</span><br><span class="line">    r = p.<span class="built_in">length</span>();</span><br><span class="line">    p /= r/R0;</span><br><span class="line">    p[<span class="number">2</span>] += R1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    r = p.<span class="built_in">length</span>();</span><br><span class="line">    p /= r/R1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/// 声明几何遗传树，并从Easymesh格式的文件中读入数据</span></span><br><span class="line">  HGeometryTree&lt;DIM,DOW&gt; h_tree;</span><br><span class="line">  h_tree.<span class="built_in">readEasyMesh</span>(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 秘密都藏在这一行中哦</span></span><br><span class="line">  HGeometry&lt;<span class="number">1</span>,DOW&gt;::mid_point = &amp;(my_midpoint);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 在背景网格上建立第一个非正则网格，并均匀加密三次</span></span><br><span class="line">  IrregularMesh&lt;DIM,DOW&gt; irregular_mesh(h_tree);</span><br><span class="line">  irregular_mesh.<span class="built_in">globalRefine</span>(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 对非正则网格做半正则化和正则化</span></span><br><span class="line">  irregular_mesh.<span class="built_in">semiregularize</span>();</span><br><span class="line">  irregular_mesh.<span class="built_in">regularize</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 这就是通过正则化得到的网格</span></span><br><span class="line">  RegularMesh&lt;DIM,DOW&gt;&amp; regular_mesh = irregular_mesh.<span class="built_in">regularMesh</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 将这个网格输出到数据文件中</span></span><br><span class="line">  regular_mesh.<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;D.dx&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><br>图：<br><a target="_blank" rel="noopener" href="http://rli.bloghome.cn/photos/p_original/13c87f2eaff69aeeb6fa3e42c4275bbe.gif">http://rli.bloghome.cn/photos/p_original/13c87f2eaff69aeeb6fa3e42c4275bbe.gif</a></p>
<h1 id="AFEPack教学系列之十三-试试特征线法解对流扩散方程"><a href="#AFEPack教学系列之十三-试试特征线法解对流扩散方程" class="headerlink" title="AFEPack教学系列之十三: 试试特征线法解对流扩散方程"></a>AFEPack教学系列之十三: 试试特征线法解对流扩散方程</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   test.cpp</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Thu May 17 22:39:30 2007</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @brief  我们在一个三角形网格上使用了特征线法来求解一个对流扩散方程。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/EasyMesh.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/TemplateElement.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/DGFEMSpace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/BilinearOperator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Operator.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  为了求解对流占优的对流扩散方程</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  \f[</span></span><br><span class="line"><span class="comment">    u_t + b \cdot \nabla u = \Delta u + f</span></span><br><span class="line"><span class="comment">  \]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  一个经常的考虑就是通过特征线法来进行离散，去除由于强对流带来的困难。</span></span><br><span class="line"><span class="comment">  在实现特征线法的时候，一个唯一的困难就是在计算上一个时间步的函数值的</span></span><br><span class="line"><span class="comment">  时候，需要为其提供正确的由特征线给出的坐标点所在的单元这个参数。我们</span></span><br><span class="line"><span class="comment">  假设速度场可以手工积分，下面写的函数 find_element 可以找到这个单元参</span></span><br><span class="line"><span class="comment">  数，从而使得上面的方程求解划归为一个抛物型方程求解的样子。所以，只需</span></span><br><span class="line"><span class="comment">  要理解了这个函数，世界就顿时有秩序了。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 假设网格为一个三角形网格，从一个单元出发，寻找点所位于的单元。要求</span></span><br><span class="line"><span class="comment"> * 单元是一个 DGFEMSpace 空间的单元。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param p 点的坐标</span></span><br><span class="line"><span class="comment"> * @param ele 出发单元的指针</span></span><br><span class="line"><span class="comment"> * @param sp 单元所在的有限元空间</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return 最后找到的单元的指针，如果寻找到区域的边界之外，则所返回一</span></span><br><span class="line"><span class="comment"> *         个空指针。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">inline</span> Element&lt;<span class="keyword">double</span>,DIM&gt; *</span><br><span class="line"><span class="built_in">find_element</span>(<span class="keyword">const</span> Point&lt;DIM&gt;&amp; p,</span><br><span class="line">         Element&lt;<span class="keyword">double</span>,DIM&gt; * ele,</span><br><span class="line">         DGFEMSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; sp)</span><br><span class="line">&#123;</span><br><span class="line">  Mesh&lt;DIM&gt;&amp; mesh = sp.<span class="built_in">mesh</span>();                    <span class="comment">// 取得有限元空间的网格</span></span><br><span class="line">  GeometryBM&amp; geo = ele-&gt;<span class="built_in">geometry</span>();              <span class="comment">// 取得单元的几何体</span></span><br><span class="line">  <span class="keyword">double</span> * v[<span class="number">3</span>] = &#123;mesh.<span class="built_in">point</span>(geo.<span class="built_in">vertex</span>(<span class="number">0</span>)),</span><br><span class="line">                   mesh.<span class="built_in">point</span>(geo.<span class="built_in">vertex</span>(<span class="number">1</span>)),</span><br><span class="line">                   mesh.<span class="built_in">point</span>(geo.<span class="built_in">vertex</span>(<span class="number">2</span>))&#125;; <span class="comment">// 几何体的三个顶点</span></span><br><span class="line">  <span class="keyword">double</span> ele_vol = (v[<span class="number">1</span>][<span class="number">0</span>] - v[<span class="number">0</span>][<span class="number">0</span>])*(v[<span class="number">2</span>][<span class="number">1</span>] - v[<span class="number">0</span>][<span class="number">1</span>])</span><br><span class="line">                 - (v[<span class="number">1</span>][<span class="number">1</span>] - v[<span class="number">0</span>][<span class="number">1</span>])*(v[<span class="number">2</span>][<span class="number">0</span>] - v[<span class="number">0</span>][<span class="number">0</span>]);    <span class="comment">// 三角形的面积</span></span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; <span class="number">3</span>;++ i) &#123;                  <span class="comment">// 对每个节点做循环</span></span><br><span class="line">    u_int i1 = (i + <span class="number">1</span>)%<span class="number">3</span>, i2 = (i + <span class="number">2</span>)%<span class="number">3</span>;</span><br><span class="line">    <span class="keyword">double</span> lambda = (p[<span class="number">0</span>] - v[i1][<span class="number">0</span>])*(p[<span class="number">1</span>] - v[i2][<span class="number">1</span>])</span><br><span class="line">                  - (p[<span class="number">1</span>] - v[i1][<span class="number">1</span>])*(p[<span class="number">0</span>] - v[i2][<span class="number">0</span>]);      <span class="comment">// 第 i 个面积坐标</span></span><br><span class="line">    <span class="keyword">if</span> (lambda/ele_vol &lt; <span class="number">-1.0e-08</span>) &#123;              <span class="comment">// 如果为负，说明需要向这个方向搜索</span></span><br><span class="line">      <span class="comment">/// 取出这个边界上的面单元</span></span><br><span class="line">      DGElement&lt;<span class="keyword">double</span>,DIM&gt;&amp; dgele = sp.<span class="built_in">dgElement</span>(geo.<span class="built_in">boundary</span>(i));</span><br><span class="line">      <span class="keyword">if</span> (dgele.<span class="built_in">p_neighbourElement</span>(<span class="number">0</span>) == ele) &#123;  <span class="comment">// 如果本单元是 0 号邻居</span></span><br><span class="line">    <span class="keyword">if</span> (dgele.<span class="built_in">p_neighbourElement</span>(<span class="number">1</span>) != <span class="literal">NULL</span>) &#123; <span class="comment">/**</span></span><br><span class="line"><span class="comment">                            * 如果对面单元不为空，</span></span><br><span class="line"><span class="comment">                            * 则跳到对面继续搜索</span></span><br><span class="line"><span class="comment">                            */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">find_element</span>(p, dgele.<span class="built_in">p_neighbourElement</span>(<span class="number">1</span>), sp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">// 否则就是已经到达区域的边界的情况，返回空指针</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123; <span class="comment">// 否则跳到对面单元上去搜索</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">find_element</span>(p, dgele.<span class="built_in">p_neighbourElement</span>(<span class="number">0</span>), sp);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ele;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算当前(时间为 t)的点 p，在时间 t-dt 时候的位置 q，从而有</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \f[</span></span><br><span class="line"><span class="comment"> *    p = q + \int_&#123;t - dt&#125;^t b(.;t) dt</span></span><br><span class="line"><span class="comment"> * \f]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param p 当前(时间为 t)点坐标</span></span><br><span class="line"><span class="comment"> * @param t 当前时间</span></span><br><span class="line"><span class="comment"> * @param dt 时间步长</span></span><br><span class="line"><span class="comment"> * @param q t-dt时的点坐标</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> _b_(<span class="keyword">const</span> <span class="keyword">double</span> * p,</span><br><span class="line">         <span class="keyword">double</span> t,</span><br><span class="line">         <span class="keyword">double</span> dt,</span><br><span class="line">         <span class="keyword">double</span> * q)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/// 在这里写速度场</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 初值和边值的表达式</span></span><br><span class="line"><span class="keyword">double</span> _u_(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>]*<span class="built_in">exp</span>(p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 右端项</span></span><br><span class="line"><span class="keyword">double</span> _f_(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>]*p[<span class="number">1</span>] + <span class="built_in">sin</span>(p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 1/dt - \Delta 离散出来的矩阵</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Matrix</span> :</span> <span class="keyword">public</span> L2InnerProduct&lt;DIM,<span class="keyword">double</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">double</span> _dt;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Matrix</span>(FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; sp, <span class="keyword">double</span> dt) :</span><br><span class="line">    L2InnerProduct&lt;DIM,<span class="keyword">double</span>&gt;(sp, sp), _dt(dt) &#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">getElementMatrix</span><span class="params">(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; e0,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; e1,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">const</span> ActiveElementPairIterator&lt; DIM &gt;::State s)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> vol = e0.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">    u_int acc = <span class="built_in">algebricAccuracy</span>();</span><br><span class="line">    <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; qi = e0.<span class="built_in">findQuadratureInfo</span>(acc);</span><br><span class="line">    u_int n_q_pnt = qi.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; jac = e0.<span class="built_in">local_to_global_jacobian</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">    std::vector&lt;Point&lt;DIM&gt; &gt; q_pnt = e0.<span class="built_in">local_to_global</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">    std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; bas_val = e0.<span class="built_in">basis_function_value</span>(q_pnt);</span><br><span class="line">    std::vector&lt;std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; &gt; bas_grad = e0.<span class="built_in">basis_function_gradient</span>(q_pnt);</span><br><span class="line">    u_int n_ele_dof = e0.<span class="built_in">dof</span>().<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">for</span> (u_int l = <span class="number">0</span>;l &lt; n_q_pnt;++ l) &#123;</span><br><span class="line">      <span class="keyword">double</span> Jxw = vol*qi.<span class="built_in">weight</span>(l)*jac[l];</span><br><span class="line">      <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele_dof;++ i) &#123;</span><br><span class="line">        <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">          <span class="built_in">elementMatrix</span>(i,j) += Jxw*(bas_val[i][l]*bas_val[j][l]/_dt +</span><br><span class="line">                                     <span class="built_in">innerProduct</span>(bas_grad[i][l], bas_grad[j][l]));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/// 准备网格</span></span><br><span class="line">  EasyMesh mesh;</span><br><span class="line">  mesh.<span class="built_in">readData</span>(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 准备参考单元</span></span><br><span class="line">  TemplateGeometry&lt;DIM&gt; tmp_geo;</span><br><span class="line">  tmp_geo.<span class="built_in">readData</span>(<span class="string">&quot;triangle.tmp_geo&quot;</span>);</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt; crd_trs;</span><br><span class="line">  crd_trs.<span class="built_in">readData</span>(<span class="string">&quot;triangle.crd_trs&quot;</span>);</span><br><span class="line">  <span class="function">TemplateDOF&lt;DIM&gt; <span class="title">tmp_dof</span><span class="params">(tmp_geo)</span></span>;</span><br><span class="line">  tmp_dof.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  BasisFunctionAdmin&lt;double,DIM,DIM&gt; bas_fun(tmp_dof);</span><br><span class="line">  bas_fun.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.bas_fun&quot;</span>);</span><br><span class="line">  UnitOutNormal&lt;DIM&gt; unit_out_normal;</span><br><span class="line">  unit_out_normal.<span class="built_in">readData</span>(<span class="string">&quot;triangle.out_nrm&quot;</span>);</span><br><span class="line"></span><br><span class="line">  std::vector&lt;TemplateElement&lt;<span class="keyword">double</span>,DIM&gt; &gt; <span class="built_in">tmp_ele</span>(<span class="number">1</span>);</span><br><span class="line">  tmp_ele[<span class="number">0</span>].<span class="built_in">reinit</span>(tmp_geo, tmp_dof, crd_trs, bas_fun, unit_out_normal);</span><br><span class="line"></span><br><span class="line">  TemplateGeometry&lt;DIM<span class="number">-1</span>&gt; interval_tmp_geo;</span><br><span class="line">  interval_tmp_geo.<span class="built_in">readData</span>(<span class="string">&quot;interval.tmp_geo&quot;</span>);</span><br><span class="line">  CoordTransform&lt;DIM<span class="number">-1</span>,DIM&gt; interval_crd_trs;</span><br><span class="line">  interval_crd_trs.<span class="built_in">readData</span>(<span class="string">&quot;interval.crd_trs&quot;</span>);  </span><br><span class="line"></span><br><span class="line">  std::vector&lt;TemplateDGElement&lt;DIM-1,DIM&gt; &gt; <span class="built_in">dg_tmp_ele</span>(<span class="number">1</span>);</span><br><span class="line">  dg_tmp_ele[<span class="number">0</span>].<span class="built_in">reinit</span>(interval_tmp_geo, interval_crd_trs);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 定制有限元空间</span></span><br><span class="line">  DGFEMSpace&lt;double,DIM&gt; fem_space(mesh, tmp_ele, dg_tmp_ele);</span><br><span class="line">  u_int n_ele = mesh.<span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">  fem_space.<span class="built_in">element</span>().<span class="built_in">resize</span>(n_ele);</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele;++ i) &#123;</span><br><span class="line">    fem_space.<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(fem_space, i, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  fem_space.<span class="built_in">buildElement</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDof</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line"></span><br><span class="line">  u_int n_edge = mesh.<span class="built_in">n_geometry</span>(DIM<span class="number">-1</span>); <span class="comment">//网格边的条数</span></span><br><span class="line">  fem_space.<span class="built_in">dgElement</span>().<span class="built_in">resize</span>(n_edge);</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_edge;i ++) &#123;</span><br><span class="line">    fem_space.<span class="built_in">dgElement</span>(i).<span class="built_in">reinit</span>(fem_space, i, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  fem_space.<span class="built_in">buildDGElement</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 准备初值</span></span><br><span class="line">  FEMFunction&lt;double,DIM&gt; u_h(fem_space);</span><br><span class="line">  Operator::<span class="built_in">L2Interpolate</span>(&amp;_u_, u_h);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 准备边界条件</span></span><br><span class="line">  BoundaryFunction&lt;double,DIM&gt; boundary(BoundaryConditionInfo::DIRICHLET,</span><br><span class="line">                                        <span class="number">1</span>,</span><br><span class="line">                                        &amp;_u_);</span><br><span class="line">  BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(fem_space);</span><br><span class="line">  boundary_admin.<span class="built_in">add</span>(boundary);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">double</span> t = <span class="number">0.0</span>;</span><br><span class="line">  Point&lt;DIM&gt; qq_pnt;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">double</span> dt = <span class="number">0.01</span>; <span class="comment">/// 简单起见，随手取个时间步长算了</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 准备线性系统的矩阵</span></span><br><span class="line">    <span class="function">Matrix <span class="title">mat</span><span class="params">(fem_space, dt)</span></span>;</span><br><span class="line">    mat.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">    mat.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 准备右端项</span></span><br><span class="line">    <span class="function">Vector&lt;<span class="keyword">double</span>&gt; <span class="title">rhs</span><span class="params">(fem_space.n_dof())</span></span>;</span><br><span class="line">    FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator the_ele = fem_space.<span class="built_in">beginElement</span>();</span><br><span class="line">    FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator end_ele = fem_space.<span class="built_in">endElement</span>();</span><br><span class="line">    <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele) &#123;</span><br><span class="line">      <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">      <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; qi = the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">3</span>);</span><br><span class="line">      u_int n_q_pnt = qi.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line">      std::vector&lt;<span class="keyword">double</span>&gt; jac = the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">      std::vector&lt;Point&lt;DIM&gt; &gt; q_pnt = the_ele-&gt;<span class="built_in">local_to_global</span>(qi.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">      std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; bas_val = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_pnt);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/// 当基函数的值已知情况下，可以使用下面的函数来加速</span></span><br><span class="line">      std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = u_h.<span class="built_in">value</span>(bas_val, *the_ele);</span><br><span class="line">      <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">      u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line">      <span class="keyword">for</span> (u_int l = <span class="number">0</span>;l &lt; n_q_pnt;++ l) &#123;</span><br><span class="line">        <span class="keyword">double</span> Jxw = vol*qi.<span class="built_in">weight</span>(l)*jac[l];</span><br><span class="line">        _b_(q_pnt[l], t, dt, qq_pnt);</span><br><span class="line">        Element&lt;<span class="keyword">double</span>,DIM&gt; * ele = <span class="built_in">find_element</span>(qq_pnt, &amp;(*the_ele), fem_space);</span><br><span class="line">        <span class="keyword">double</span> u_h_val;</span><br><span class="line">        <span class="keyword">if</span> (ele != <span class="literal">NULL</span>) &#123;</span><br><span class="line">          u_h_val = u_h.<span class="built_in">value</span>(qq_pnt, *ele);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          u_h_val = _u_(qq_pnt); <span class="comment">/// 此时坐标出了区域边界，需要使用边界条件来</span></span><br><span class="line">                                 <span class="comment">/// 给定值。</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">double</span> f_val = _f_(q_pnt[l]);</span><br><span class="line">        <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele_dof;++ i) &#123;</span><br><span class="line">          <span class="built_in">rhs</span>(ele_dof[i]) += Jxw*bas_val[i][l]*(u_h_val/dt + f_val);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 应用边界条件</span></span><br><span class="line">    boundary_admin.<span class="built_in">apply</span>(mat, u_h, rhs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 求解线性系统</span></span><br><span class="line">    AMGSolver solver;</span><br><span class="line">    solver.<span class="built_in">lazyReinit</span>(mat);</span><br><span class="line">    solver.<span class="built_in">solve</span>(u_h, rhs, <span class="number">1.0e-08</span>, <span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">    t += dt; <span class="comment">/// 更新时间</span></span><br><span class="line">    </span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\n\tt = &quot;</span> &lt;&lt;  t &lt;&lt; std::endl;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<h1 id="AFEPack教学系列之十四-讨论班例子-I"><a href="#AFEPack教学系列之十四-讨论班例子-I" class="headerlink" title="AFEPack教学系列之十四: 讨论班例子(I)"></a>AFEPack教学系列之十四: 讨论班例子(I)</h1><p>前些天，在我们的讨论班上讲了几次AFEPack的高级功能，把几个例子贴上来供大家参考。由于开始比较简单一些的文件没有保留下来，下面的第一个例子就是两个分线性变量耦合的方程组的移动网格方法的程序。比较懒，不写注释了，反正您要是想学会的话就得自己真正看懂的。如果那位愿意帮我把注释一段一段写上去就好了。这个例子有两个文件，一个是头文件，一个是实现文件，请看下面：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   prob.h</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Sat Jul 14 09:06:42 2007</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @brief  </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __prob_h__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __prob_h__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/EasyMesh.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/FEMSpace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/BilinearOperator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Operator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Functional.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/AMGSolver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/MovingMesh2D.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Matrix</span> :</span> <span class="keyword">public</span> StiffMatrix&lt;DIM, <span class="keyword">double</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">double</span> _dt;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt; * p_u_h;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Matrix</span>(FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; sp,</span><br><span class="line">         <span class="keyword">double</span> dt,</span><br><span class="line">         FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;&amp; u_h) : </span><br><span class="line">    StiffMatrix&lt;DIM,<span class="keyword">double</span>&gt;(sp), _dt(dt), <span class="built_in">p_u_h</span>(&amp;u_h) &#123;&#125;;</span><br><span class="line">  <span class="keyword">virtual</span> </span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">getElementMatrix</span><span class="params">(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele0, </span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele1, </span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> ActiveElementPairIterator&lt;DIM&gt;::State </span></span></span><br><span class="line"><span class="function"><span class="params">                        state=ActiveElementPairIterator&lt;DIM&gt;::EQUAL)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">problem</span> :</span> <span class="keyword">public</span> MovingMesh2D &#123;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  TemplateGeometry&lt;DIM&gt;       template_geometry;</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt;     coord_transform;</span><br><span class="line">  TemplateDOF&lt;DIM&gt;            template_dof;</span><br><span class="line">  BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt;  basis_function;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;TemplateElement&lt;<span class="keyword">double</span>,DIM&gt; &gt; template_element;</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;        fem_space;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;     u_h;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;     v_h;</span><br><span class="line">  <span class="keyword">double</span>                      t;</span><br><span class="line">  <span class="keyword">double</span>                      dt;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">stepForward</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">getMonitor</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">updateSolution</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">outputSolution</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __prob_h__</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><br>下面这个是实现文件：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   prob.cpp</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Sat Jul 14 09:13:06 2007</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @brief  </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;prob.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">f</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>] + p[<span class="number">1</span>]*p[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">u_b</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">g</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">exp</span>(p[<span class="number">0</span>]) + <span class="built_in">sin</span>(p[<span class="number">1</span>]*p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">v_b</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>]*p[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">a</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (p[<span class="number">0</span>] &lt; <span class="number">0.6</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Matrix::getElementMatrix</span><span class="params">(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele0, </span></span></span><br><span class="line"><span class="function"><span class="params">			      <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele1, </span></span></span><br><span class="line"><span class="function"><span class="params">			      ActiveElementPairIterator&lt;DIM&gt;::State)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">double</span> vol = ele0.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">  <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">    ele0.<span class="built_in">findQuadratureInfo</span>(<span class="built_in">algebricAccuracy</span>());</span><br><span class="line">  <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">  std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">    ele0.<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">  std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">    ele0.<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">  std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">    basis_value = ele0.<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">  std::vector&lt;std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; &gt; </span><br><span class="line">    basis_gradient = ele0.<span class="built_in">basis_function_gradient</span>(q_point);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = ele0.<span class="built_in">dof</span>();</span><br><span class="line">  u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">    <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">    <span class="keyword">double</span> a_value = <span class="built_in">a</span>(q_point[l]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">double</span> u_h_val = p_u_h-&gt;<span class="built_in">value</span>(q_point[l], ele0);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n_ele_dof;++ i) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">        <span class="built_in">elementMatrix</span>(i, j) += Jxw*</span><br><span class="line">          ((<span class="number">1</span>/_dt)*basis_value[i][l]*basis_value[j][l]</span><br><span class="line">           + a_value*<span class="built_in">innerProduct</span>(basis_gradient[i][l], </span><br><span class="line">                                  basis_gradient[j][l])</span><br><span class="line">           + <span class="number">10000</span>*u_h_val*u_h_val*basis_value[i][l]*basis_value[j][l]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">this</span>-&gt;<span class="built_in">readDomain</span>(<span class="string">&quot;M&quot;</span>);</span><br><span class="line"></span><br><span class="line">  template_geometry.<span class="built_in">readData</span>(<span class="string">&quot;triangle.tmp_geo&quot;</span>);</span><br><span class="line">  coord_transform.<span class="built_in">readData</span>(<span class="string">&quot;triangle.crd_trs&quot;</span>);</span><br><span class="line">  template_dof.<span class="built_in">reinit</span>(template_geometry);</span><br><span class="line">  template_dof.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  basis_function.<span class="built_in">reinit</span>(template_dof);</span><br><span class="line">  basis_function.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  template_element.<span class="built_in">resize</span>(<span class="number">1</span>);</span><br><span class="line">  template_element[<span class="number">0</span>].<span class="built_in">reinit</span>(template_geometry,</span><br><span class="line">                             template_dof,</span><br><span class="line">                             coord_transform,</span><br><span class="line">                             basis_function);</span><br><span class="line"></span><br><span class="line">  u_int n_ele = <span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">  fem_space.<span class="built_in">reinit</span>(*<span class="keyword">this</span>, template_element);</span><br><span class="line">  fem_space.<span class="built_in">element</span>().<span class="built_in">resize</span>(n_ele);</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele;++ i) &#123;</span><br><span class="line">    fem_space.<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(fem_space, i, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  fem_space.<span class="built_in">buildElement</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDof</span>();</span><br><span class="line">  fem_space.<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line"></span><br><span class="line">  u_h.<span class="built_in">reinit</span>(fem_space);</span><br><span class="line">  v_h.<span class="built_in">reinit</span>(fem_space);</span><br><span class="line"></span><br><span class="line">  t = <span class="number">0</span>, dt = <span class="number">1.0e-02</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="built_in">moveMesh</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">stepForward</span>();</span><br><span class="line"></span><br><span class="line">    t += dt;</span><br><span class="line">    u_h.<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;u_h.dx&quot;</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;t = &quot;</span> &lt;&lt; t &lt;&lt; std::endl;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::stepForward</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FEMFunction&lt;double,DIM&gt; last_u_h(u_h);</span><br><span class="line">  FEMFunction&lt;double,DIM&gt; last_v_h(v_h);</span><br><span class="line"></span><br><span class="line">  u_int step = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function">Matrix <span class="title">stiff_matrix</span><span class="params">(fem_space, dt, u_h)</span></span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">      Vector&lt;<span class="keyword">double</span>&gt; rhs;</span><br><span class="line">      Operator::<span class="built_in">L2Discretize</span>(g, fem_space, rhs, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">      FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator </span><br><span class="line">        the_ele = fem_space.<span class="built_in">beginElement</span>(),</span><br><span class="line">        end_ele = fem_space.<span class="built_in">endElement</span>();</span><br><span class="line">      <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele) &#123;</span><br><span class="line">        <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">          the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">          basis_value = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = last_u_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; v_h_val = last_v_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">          v_h_grad = last_v_h.<span class="built_in">gradient</span>(q_point, *the_ele);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">        u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">          <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">          <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">            <span class="built_in">rhs</span>(ele_dof[j]) += Jxw*((<span class="number">1</span>/dt)*v_h_val[l] - </span><br><span class="line">                                    u_h_val[l]*v_h_grad[l][<span class="number">0</span>] -</span><br><span class="line">                                    v_h_val[l]*v_h_grad[l][<span class="number">1</span>]</span><br><span class="line">                                    )*basis_value[j][l];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary1(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">1</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary2(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">2</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary3(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">3</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary4(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">4</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary5(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">5</span>, &amp;v_b);</span><br><span class="line">      BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(fem_space);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary1);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary2);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary3);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary4);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary5);</span><br><span class="line">      boundary_admin.<span class="built_in">apply</span>(stiff_matrix, v_h, rhs);</span><br><span class="line"></span><br><span class="line">      AMGSolver solver;</span><br><span class="line">      solver.<span class="built_in">lazyReinit</span>(stiff_matrix);</span><br><span class="line">      solver.<span class="built_in">solve</span>(v_h, rhs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      FEMFunction&lt;double,DIM&gt; old_u_h(u_h);</span><br><span class="line"></span><br><span class="line">      <span class="function">Matrix <span class="title">stiff_matrix</span><span class="params">(fem_space, dt, v_h)</span></span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">      Vector&lt;<span class="keyword">double</span>&gt; rhs;</span><br><span class="line">      Operator::<span class="built_in">L2Discretize</span>(f, fem_space, rhs, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">      FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator </span><br><span class="line">        the_ele = fem_space.<span class="built_in">beginElement</span>(),</span><br><span class="line">        end_ele = fem_space.<span class="built_in">endElement</span>();</span><br><span class="line">      <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele) &#123;</span><br><span class="line">        <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">          the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">          basis_value = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = last_u_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; v_h_val = last_v_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">          u_h_grad = last_u_h.<span class="built_in">gradient</span>(q_point, *the_ele);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">        u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">          <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">          <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">            <span class="built_in">rhs</span>(ele_dof[j]) += Jxw*((<span class="number">1</span>/dt)*u_h_val[l] - </span><br><span class="line">                                    u_h_val[l]*u_h_grad[l][<span class="number">0</span>] -</span><br><span class="line">                                    v_h_val[l]*u_h_grad[l][<span class="number">1</span>]</span><br><span class="line">                                    )*basis_value[j][l];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary1(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">1</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary2(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">2</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary3(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">3</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary4(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">4</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary5(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">5</span>, &amp;u_b);</span><br><span class="line">      BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(fem_space);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary1);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary2);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary3);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary4);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary5);</span><br><span class="line">      boundary_admin.<span class="built_in">apply</span>(stiff_matrix, u_h, rhs);</span><br><span class="line"></span><br><span class="line">      AMGSolver solver;</span><br><span class="line">      solver.<span class="built_in">lazyReinit</span>(stiff_matrix);</span><br><span class="line">      solver.<span class="built_in">solve</span>(u_h, rhs);</span><br><span class="line"></span><br><span class="line">      old_u_h.<span class="built_in">add</span>(<span class="number">-1.0</span>, u_h);</span><br><span class="line">      <span class="keyword">double</span> error = Functional::<span class="built_in">L2Norm</span>(old_u_h, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">      std::cout &lt;&lt; <span class="string">&quot;step &quot;</span> &lt;&lt; step ++ &lt;&lt; <span class="string">&quot;, error = &quot;</span> &lt;&lt; error &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (error &lt; <span class="number">1.0e-08</span>) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::getMonitor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator</span><br><span class="line">    the_ele = fem_space.<span class="built_in">beginElement</span>(),</span><br><span class="line">    end_ele = fem_space.<span class="built_in">endElement</span>();</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;the_ele != end_ele;++ the_ele, ++ i) &#123;</span><br><span class="line">    Point&lt;DIM&gt; p;</span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; u_h_grad = u_h.<span class="built_in">gradient</span>(p, *the_ele);</span><br><span class="line">    <span class="built_in">monitor</span>(i) = <span class="built_in">innerProduct</span>(u_h_grad, u_h_grad);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">smoothMonitor</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">double</span> epsilon = <span class="number">1.0e-02</span>;</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; fem_space.<span class="built_in">n_element</span>();++ i) &#123;</span><br><span class="line">    <span class="built_in">monitor</span>(i) = <span class="number">1.0</span>/<span class="built_in">sqrt</span>(epsilon + <span class="built_in">monitor</span>(i));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::updateSolution</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">double</span> msl = <span class="built_in">moveStepLength</span>();</span><br><span class="line">  <span class="function">Vector&lt;<span class="keyword">double</span>&gt; <span class="title">rhs_u</span><span class="params">(fem_space.n_dof())</span></span>;</span><br><span class="line">  <span class="function">Vector&lt;<span class="keyword">double</span>&gt; <span class="title">rhs_v</span><span class="params">(fem_space.n_dof())</span></span>;</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator</span><br><span class="line">    the_ele = fem_space.<span class="built_in">beginElement</span>(),</span><br><span class="line">    end_ele = fem_space.<span class="built_in">endElement</span>();</span><br><span class="line">  <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele) &#123;</span><br><span class="line">    <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">      the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">      the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">    std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">      the_ele-&gt;<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">      basis_value = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; u_h_value = u_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; v_h_value = v_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">      u_h_grad = u_h.<span class="built_in">gradient</span>(q_point, *the_ele);</span><br><span class="line">    std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">      v_h_grad = v_h.<span class="built_in">gradient</span>(q_point, *the_ele);</span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">      move_vec = <span class="built_in">moveDirection</span>(q_point, the_ele-&gt;<span class="built_in">index</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">    u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">      <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">      <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">        <span class="built_in">rhs_u</span>(ele_dof[j]) += Jxw*(u_h_value[l] +</span><br><span class="line">                                  msl*<span class="built_in">innerProduct</span>(u_h_grad[l], move_vec[l])</span><br><span class="line">                                  )*basis_value[j][l];</span><br><span class="line">        <span class="built_in">rhs_v</span>(ele_dof[j]) += Jxw*(v_h_value[l] +</span><br><span class="line">                                  msl*<span class="built_in">innerProduct</span>(v_h_grad[l], move_vec[l])</span><br><span class="line">                                  )*basis_value[j][l];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  MassMatrix&lt;DIM,double&gt; mass_matrix(fem_space);</span><br><span class="line">  mass_matrix.<span class="built_in">algebricAccuracy</span>() = <span class="number">2</span>;</span><br><span class="line">  mass_matrix.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">  AMGSolver solver;</span><br><span class="line">  solver.<span class="built_in">lazyReinit</span>(mass_matrix);</span><br><span class="line">  solver.<span class="built_in">solve</span>(u_h, rhs_u);</span><br><span class="line">  solver.<span class="built_in">solve</span>(v_h, rhs_v);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  problem the_app;</span><br><span class="line">  the_app.<span class="built_in">initialize</span>();</span><br><span class="line">  the_app.<span class="built_in">run</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><br>我们用的计算区域是一个五边形，给easymesh 的源文件如下:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">0.1</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span>: <span class="number">1</span> <span class="number">0</span> <span class="number">0.2</span> <span class="number">1</span></span><br><span class="line"><span class="number">2</span>: <span class="number">2</span> <span class="number">0.8</span> <span class="number">0.05</span> <span class="number">1</span></span><br><span class="line"><span class="number">3</span>: <span class="number">0.7</span> <span class="number">2.2</span> <span class="number">0.2</span> <span class="number">1</span></span><br><span class="line"><span class="number">4</span>: <span class="number">0</span> <span class="number">1</span> <span class="number">0.05</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>: <span class="number">0</span> <span class="number">1</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span>: <span class="number">1</span> <span class="number">2</span> <span class="number">2</span></span><br><span class="line"><span class="number">2</span>: <span class="number">2</span> <span class="number">3</span> <span class="number">3</span></span><br><span class="line"><span class="number">3</span>: <span class="number">3</span> <span class="number">4</span> <span class="number">4</span></span><br><span class="line"><span class="number">4</span>: <span class="number">4</span> <span class="number">0</span> <span class="number">5</span></span><br></pre></td></tr></table></figure></p>
<h1 id="AFEPack教学系列之十四-讨论班例子-II"><a href="#AFEPack教学系列之十四-讨论班例子-II" class="headerlink" title="AFEPack教学系列之十四: 讨论班例子(II)"></a>AFEPack教学系列之十四: 讨论班例子(II)</h1><p>下面这个例子解的还是上面的方程，一个不同之处就在于现在我们是在使用局部加密和稀疏化方法做自适应，不过，为了能够循序渐近起见，现在两个变量的有限元空间总是一样的，请看代码：</p>
<p>头文件：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   prob.h</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Sat Jul 14 09:06:42 2007</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @brief  </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __prob_h__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __prob_h__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/EasyMesh.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/FEMSpace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/BilinearOperator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Operator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Functional.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/AMGSolver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/HGeometry.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Matrix</span> :</span> <span class="keyword">public</span> StiffMatrix&lt;DIM, <span class="keyword">double</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">double</span> _dt;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt; * p_u_h;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Matrix</span>(FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; sp,</span><br><span class="line">         <span class="keyword">double</span> dt,</span><br><span class="line">         FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;&amp; u_h) : </span><br><span class="line">    StiffMatrix&lt;DIM,<span class="keyword">double</span>&gt;(sp), _dt(dt), <span class="built_in">p_u_h</span>(&amp;u_h) &#123;&#125;;</span><br><span class="line">  <span class="keyword">virtual</span> </span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">getElementMatrix</span><span class="params">(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele0, </span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele1, </span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> ActiveElementPairIterator&lt;DIM&gt;::State </span></span></span><br><span class="line"><span class="function"><span class="params">                        state=ActiveElementPairIterator&lt;DIM&gt;::EQUAL)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">problem</span> &#123;</span></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  TemplateGeometry&lt;DIM&gt;       template_geometry;</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt;     coord_transform;</span><br><span class="line">  TemplateDOF&lt;DIM&gt;            template_dof;</span><br><span class="line">  BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt;  basis_function;</span><br><span class="line"></span><br><span class="line">  TemplateGeometry&lt;DIM&gt;       template_geometry1;</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt;     coord_transform1;</span><br><span class="line">  TemplateDOF&lt;DIM&gt;            template_dof1;</span><br><span class="line">  BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt;  basis_function1;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;TemplateElement&lt;<span class="keyword">double</span>,DIM&gt; &gt; template_element;</span><br><span class="line"></span><br><span class="line">  HGeometryTree&lt;DIM&gt;          h_tree;</span><br><span class="line">  IrregularMesh&lt;DIM&gt;        * ir_mesh;</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;      * fem_space;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;   * u_h;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;   * v_h;</span><br><span class="line">  <span class="keyword">double</span>                      t;</span><br><span class="line">  <span class="keyword">double</span>                      dt;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">stepForward</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">buildFEMSpace</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">getIndicator</span><span class="params">(Indicator&lt;DIM&gt;&amp;)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">adaptMesh</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __prob_h__</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><br>实现文件：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   prob.cpp</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Sat Jul 14 09:13:06 2007</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @brief  </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;prob.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">f</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>] + p[<span class="number">1</span>]*p[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">u_b</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">g</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">exp</span>(p[<span class="number">0</span>]) + <span class="built_in">sin</span>(p[<span class="number">1</span>]*p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">v_b</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>]*p[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">a</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (p[<span class="number">0</span>] &lt; <span class="number">0.6</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Matrix::getElementMatrix</span><span class="params">(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele0, </span></span></span><br><span class="line"><span class="function"><span class="params">			      <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele1, </span></span></span><br><span class="line"><span class="function"><span class="params">			      ActiveElementPairIterator&lt;DIM&gt;::State)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">double</span> vol = ele0.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">  <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">    ele0.<span class="built_in">findQuadratureInfo</span>(<span class="built_in">algebricAccuracy</span>());</span><br><span class="line">  <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">  std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">    ele0.<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">  std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">    ele0.<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">  std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">    basis_value = ele0.<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">  std::vector&lt;std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; &gt; </span><br><span class="line">    basis_gradient = ele0.<span class="built_in">basis_function_gradient</span>(q_point);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = ele0.<span class="built_in">dof</span>();</span><br><span class="line">  u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">    <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">    <span class="keyword">double</span> a_value = <span class="built_in">a</span>(q_point[l]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">double</span> u_h_val = p_u_h-&gt;<span class="built_in">value</span>(q_point[l], ele0);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n_ele_dof;++ i) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">        <span class="built_in">elementMatrix</span>(i, j) += Jxw*</span><br><span class="line">          ((<span class="number">1</span>/_dt)*basis_value[i][l]*basis_value[j][l]</span><br><span class="line">           + a_value*<span class="built_in">innerProduct</span>(basis_gradient[i][l], </span><br><span class="line">                                  basis_gradient[j][l])</span><br><span class="line">           + <span class="number">10000</span>*u_h_val*u_h_val*basis_value[i][l]*basis_value[j][l]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  h_tree.<span class="built_in">readEasyMesh</span>(<span class="string">&quot;M&quot;</span>);</span><br><span class="line">  ir_mesh = <span class="keyword">new</span> IrregularMesh&lt;DIM&gt;(h_tree);</span><br><span class="line">  ir_mesh-&gt;<span class="built_in">globalRefine</span>(<span class="number">3</span>);</span><br><span class="line">  ir_mesh-&gt;<span class="built_in">semiregularize</span>();</span><br><span class="line">  ir_mesh-&gt;<span class="built_in">regularize</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  template_geometry.<span class="built_in">readData</span>(<span class="string">&quot;triangle.tmp_geo&quot;</span>);</span><br><span class="line">  coord_transform.<span class="built_in">readData</span>(<span class="string">&quot;triangle.crd_trs&quot;</span>);</span><br><span class="line">  template_dof.<span class="built_in">reinit</span>(template_geometry);</span><br><span class="line">  template_dof.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  basis_function.<span class="built_in">reinit</span>(template_dof);</span><br><span class="line">  basis_function.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  template_geometry1.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.tmp_geo&quot;</span>);</span><br><span class="line">  coord_transform1.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.crd_trs&quot;</span>);</span><br><span class="line">  template_dof1.<span class="built_in">reinit</span>(template_geometry1);</span><br><span class="line">  template_dof1.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  basis_function1.<span class="built_in">reinit</span>(template_dof1);</span><br><span class="line">  basis_function1.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  template_element.<span class="built_in">resize</span>(<span class="number">2</span>);</span><br><span class="line">  template_element[<span class="number">0</span>].<span class="built_in">reinit</span>(template_geometry,</span><br><span class="line">                             template_dof,</span><br><span class="line">                             coord_transform,</span><br><span class="line">                             basis_function);</span><br><span class="line">  template_element[<span class="number">1</span>].<span class="built_in">reinit</span>(template_geometry1,</span><br><span class="line">                             template_dof1,</span><br><span class="line">                             coord_transform1,</span><br><span class="line">                             basis_function1);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">buildFEMSpace</span>();</span><br><span class="line"></span><br><span class="line">  t = <span class="number">0</span>, dt = <span class="number">1.0e-02</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::buildFEMSpace</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  RegularMesh&lt;DIM&gt;&amp; mesh = ir_mesh-&gt;<span class="built_in">regularMesh</span>();</span><br><span class="line"></span><br><span class="line">  u_int n_ele = mesh.<span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">  fem_space = <span class="keyword">new</span> FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;(mesh, template_element);</span><br><span class="line">  fem_space-&gt;<span class="built_in">element</span>().<span class="built_in">resize</span>(n_ele);</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele;++ i) &#123;</span><br><span class="line">    u_int n_vtx = mesh.<span class="built_in">geometry</span>(DIM, i).<span class="built_in">n_vertex</span>();</span><br><span class="line">    <span class="keyword">if</span> (n_vtx == <span class="number">3</span>) &#123;</span><br><span class="line">      fem_space-&gt;<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(*fem_space, i, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      fem_space-&gt;<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(*fem_space, i, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  fem_space-&gt;<span class="built_in">buildElement</span>();</span><br><span class="line">  fem_space-&gt;<span class="built_in">buildDof</span>();</span><br><span class="line">  fem_space-&gt;<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line"></span><br><span class="line">  u_h = <span class="keyword">new</span> FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;(*fem_space);</span><br><span class="line">  v_h = <span class="keyword">new</span> FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;(*fem_space);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::adaptMesh</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">Indicator&lt;DIM&gt; <span class="title">ind</span><span class="params">(ir_mesh-&gt;regularMesh())</span></span>;</span><br><span class="line">  <span class="built_in">getIndicator</span>(ind);</span><br><span class="line"></span><br><span class="line">  IrregularMesh&lt;DIM&gt; * old_ir_mesh = ir_mesh;</span><br><span class="line">  ir_mesh = <span class="keyword">new</span> IrregularMesh&lt;DIM&gt;(*old_ir_mesh);</span><br><span class="line"></span><br><span class="line">  <span class="function">MeshAdaptor&lt;DIM&gt; <span class="title">mesh_adaptor</span><span class="params">(*old_ir_mesh, *ir_mesh)</span></span>;</span><br><span class="line">  mesh_adaptor.<span class="built_in">setIndicator</span>(ind);</span><br><span class="line">  mesh_adaptor.<span class="built_in">tolerence</span>() = <span class="number">1.0e-04</span>;</span><br><span class="line">  mesh_adaptor.<span class="built_in">convergenceOrder</span>() = <span class="number">1</span>;</span><br><span class="line">  mesh_adaptor.<span class="built_in">adapt</span>();</span><br><span class="line"></span><br><span class="line">  ir_mesh-&gt;<span class="built_in">semiregularize</span>();</span><br><span class="line">  ir_mesh-&gt;<span class="built_in">regularize</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt; * old_fem_space = fem_space;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt; * old_u_h = u_h;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt; * old_v_h = v_h;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">buildFEMSpace</span>();</span><br><span class="line"></span><br><span class="line">  Operator::<span class="built_in">L2Interpolate</span>(*old_u_h, *u_h);</span><br><span class="line">  Operator::<span class="built_in">L2Interpolate</span>(*old_v_h, *v_h);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> old_u_h;</span><br><span class="line">  <span class="keyword">delete</span> old_v_h;</span><br><span class="line">  <span class="keyword">delete</span> old_fem_space;</span><br><span class="line">  <span class="keyword">delete</span> old_ir_mesh;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="built_in">stepForward</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">adaptMesh</span>();</span><br><span class="line"></span><br><span class="line">    t += dt;</span><br><span class="line">    u_h-&gt;<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;u_h.dx&quot;</span>);</span><br><span class="line">    v_h-&gt;<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;v_h.dx&quot;</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;t = &quot;</span> &lt;&lt; t &lt;&lt; std::endl;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::stepForward</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FEMFunction&lt;double,DIM&gt; last_u_h(*u_h);</span><br><span class="line">  FEMFunction&lt;double,DIM&gt; last_v_h(*v_h);</span><br><span class="line"></span><br><span class="line">  u_int step = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function">Matrix <span class="title">stiff_matrix</span><span class="params">(*fem_space, dt, *u_h)</span></span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">      Vector&lt;<span class="keyword">double</span>&gt; rhs;</span><br><span class="line">      Operator::<span class="built_in">L2Discretize</span>(g, *fem_space, rhs, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">      FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator </span><br><span class="line">        the_ele = fem_space-&gt;<span class="built_in">beginElement</span>(),</span><br><span class="line">        end_ele = fem_space-&gt;<span class="built_in">endElement</span>();</span><br><span class="line">      <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele) &#123;</span><br><span class="line">        <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">          the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">          basis_value = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = last_u_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; v_h_val = last_v_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">          v_h_grad = last_v_h.<span class="built_in">gradient</span>(q_point, *the_ele);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">        u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">          <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">          <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">            <span class="built_in">rhs</span>(ele_dof[j]) += Jxw*((<span class="number">1</span>/dt)*v_h_val[l] - </span><br><span class="line">                                    u_h_val[l]*v_h_grad[l][<span class="number">0</span>] -</span><br><span class="line">                                    v_h_val[l]*v_h_grad[l][<span class="number">1</span>]</span><br><span class="line">                                    )*basis_value[j][l];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary1(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">1</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary2(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">2</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary3(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">3</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary4(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">4</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary5(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">5</span>, &amp;v_b);</span><br><span class="line">      BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(*fem_space);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary1);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary2);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary3);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary4);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary5);</span><br><span class="line">      boundary_admin.<span class="built_in">apply</span>(stiff_matrix, *v_h, rhs);</span><br><span class="line"></span><br><span class="line">      AMGSolver solver;</span><br><span class="line">      solver.<span class="built_in">lazyReinit</span>(stiff_matrix);</span><br><span class="line">      solver.<span class="built_in">solve</span>(*v_h, rhs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      FEMFunction&lt;double,DIM&gt; old_u_h(*u_h);</span><br><span class="line"></span><br><span class="line">      <span class="function">Matrix <span class="title">stiff_matrix</span><span class="params">(*fem_space, dt, *v_h)</span></span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">      Vector&lt;<span class="keyword">double</span>&gt; rhs;</span><br><span class="line">      Operator::<span class="built_in">L2Discretize</span>(f, *fem_space, rhs, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">      FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator </span><br><span class="line">        the_ele = fem_space-&gt;<span class="built_in">beginElement</span>(),</span><br><span class="line">        end_ele = fem_space-&gt;<span class="built_in">endElement</span>();</span><br><span class="line">      <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele) &#123;</span><br><span class="line">        <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">          the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">          basis_value = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = last_u_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; v_h_val = last_v_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">          u_h_grad = last_u_h.<span class="built_in">gradient</span>(q_point, *the_ele);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">        u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">          <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">          <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">            <span class="built_in">rhs</span>(ele_dof[j]) += Jxw*((<span class="number">1</span>/dt)*u_h_val[l] - </span><br><span class="line">                                    u_h_val[l]*u_h_grad[l][<span class="number">0</span>] -</span><br><span class="line">                                    v_h_val[l]*u_h_grad[l][<span class="number">1</span>]</span><br><span class="line">                                    )*basis_value[j][l];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary1(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">1</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary2(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">2</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary3(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">3</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary4(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">4</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary5(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">5</span>, &amp;u_b);</span><br><span class="line">      BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(*fem_space);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary1);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary2);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary3);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary4);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary5);</span><br><span class="line">      boundary_admin.<span class="built_in">apply</span>(stiff_matrix, *u_h, rhs);</span><br><span class="line"></span><br><span class="line">      AMGSolver solver;</span><br><span class="line">      solver.<span class="built_in">lazyReinit</span>(stiff_matrix);</span><br><span class="line">      solver.<span class="built_in">solve</span>(*u_h, rhs);</span><br><span class="line"></span><br><span class="line">      old_u_h.<span class="built_in">add</span>(<span class="number">-1.0</span>, *u_h);</span><br><span class="line">      <span class="keyword">double</span> error = Functional::<span class="built_in">L2Norm</span>(old_u_h, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">      std::cout &lt;&lt; <span class="string">&quot;step &quot;</span> &lt;&lt; step ++ &lt;&lt; <span class="string">&quot;, error = &quot;</span> &lt;&lt; error &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (error &lt; <span class="number">1.0e-08</span>) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::getIndicator</span><span class="params">(Indicator&lt;DIM&gt;&amp; ind)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  RegularMesh&lt;DIM&gt;&amp; mesh = ir_mesh-&gt;<span class="built_in">regularMesh</span>();</span><br><span class="line">  u_int n_face = mesh.<span class="built_in">n_geometry</span>(DIM - <span class="number">1</span>);</span><br><span class="line">  <span class="function">std::vector&lt;<span class="keyword">bool</span>&gt; <span class="title">flag</span><span class="params">(n_face, <span class="literal">false</span>)</span></span>;</span><br><span class="line">  <span class="function">std::vector&lt;<span class="keyword">double</span>&gt; <span class="title">jump</span><span class="params">(n_face)</span></span>;</span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator</span><br><span class="line">    the_ele = fem_space-&gt;<span class="built_in">beginElement</span>(),</span><br><span class="line">    end_ele = fem_space-&gt;<span class="built_in">endElement</span>();</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;the_ele != end_ele;++ the_ele, ++ i) &#123;</span><br><span class="line">    Point&lt;DIM&gt; p;</span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; u_h_grad = u_h-&gt;<span class="built_in">gradient</span>(p, *the_ele);</span><br><span class="line">    GeometryBM&amp; geo = the_ele-&gt;<span class="built_in">geometry</span>();</span><br><span class="line">    u_int n_bnd = geo.<span class="built_in">n_boundary</span>();</span><br><span class="line">    <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_bnd;++ j) &#123;</span><br><span class="line">      GeometryBM&amp; bnd = mesh.<span class="built_in">geometry</span>(DIM<span class="number">-1</span>, geo.<span class="built_in">boundary</span>(j));</span><br><span class="line">      Point&lt;DIM&gt;&amp; p0 = mesh.<span class="built_in">point</span>(bnd.<span class="built_in">vertex</span>(<span class="number">0</span>));</span><br><span class="line">      Point&lt;DIM&gt;&amp; p1 = mesh.<span class="built_in">point</span>(bnd.<span class="built_in">vertex</span>(<span class="number">1</span>));</span><br><span class="line">      <span class="keyword">double</span> a = (u_h_grad[<span class="number">0</span>]*(p1[<span class="number">1</span>] - p0[<span class="number">1</span>]) -</span><br><span class="line">                  u_h_grad[<span class="number">1</span>]*(p1[<span class="number">0</span>] - p0[<span class="number">0</span>]));</span><br><span class="line">      <span class="keyword">if</span> (flag[bnd.<span class="built_in">index</span>()] == <span class="literal">false</span>) &#123;</span><br><span class="line">        jump[bnd.<span class="built_in">index</span>()] = a;</span><br><span class="line">        flag[bnd.<span class="built_in">index</span>()] = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        jump[bnd.<span class="built_in">index</span>()] -= a;</span><br><span class="line">        flag[bnd.<span class="built_in">index</span>()] = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  the_ele = fem_space-&gt;<span class="built_in">beginElement</span>();</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;the_ele != end_ele;++ the_ele, ++ i) &#123;</span><br><span class="line">    GeometryBM&amp; geo = the_ele-&gt;<span class="built_in">geometry</span>();</span><br><span class="line">    u_int n_bnd = geo.<span class="built_in">n_boundary</span>();</span><br><span class="line">    ind[i] = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_bnd;++ j) &#123;</span><br><span class="line">      GeometryBM&amp; bnd = mesh.<span class="built_in">geometry</span>(DIM<span class="number">-1</span>, geo.<span class="built_in">boundary</span>(j));</span><br><span class="line">      <span class="keyword">if</span> (flag[bnd.<span class="built_in">index</span>()]) <span class="keyword">continue</span>;</span><br><span class="line">      ind[i] += jump[bnd.<span class="built_in">index</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  problem the_app;</span><br><span class="line">  the_app.<span class="built_in">initialize</span>();</span><br><span class="line">  the_app.<span class="built_in">run</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure></p>
<h1 id="AFEPack-教学系列之十四-讨论班例子-III"><a href="#AFEPack-教学系列之十四-讨论班例子-III" class="headerlink" title="AFEPack 教学系列之十四: 讨论班例子(III)"></a>AFEPack 教学系列之十四: 讨论班例子(III)</h1><p>下面这个例子是在上面这个的基础上改成的，我们仅仅做了一点儿修改，那就是两个变量现在是在不同的有限元空间中了，但是，这两个有限元空间还是建立在同一个网格上的。请看代码：</p>
<p>头文件：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   prob.h</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Sat Jul 14 09:06:42 2007</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @brief  </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __prob_h__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __prob_h__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/EasyMesh.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/FEMSpace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/BilinearOperator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Operator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Functional.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/AMGSolver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/HGeometry.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Matrix</span> :</span> <span class="keyword">public</span> StiffMatrix&lt;DIM, <span class="keyword">double</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">double</span> _dt;</span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator v_it;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt; * p_u_h;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Matrix</span>(FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; sp,</span><br><span class="line">         <span class="keyword">double</span> dt,</span><br><span class="line">         FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;&amp; u_h) : </span><br><span class="line">    StiffMatrix&lt;DIM,<span class="keyword">double</span>&gt;(sp), _dt(dt), <span class="built_in">p_u_h</span>(&amp;u_h) &#123;&#125;;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">buildSparseMatrix</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="keyword">virtual</span> </span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">getElementMatrix</span><span class="params">(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele0, </span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele1, </span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> ActiveElementPairIterator&lt;DIM&gt;::State </span></span></span><br><span class="line"><span class="function"><span class="params">                        state=ActiveElementPairIterator&lt;DIM&gt;::EQUAL)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">problem</span> &#123;</span></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  TemplateGeometry&lt;DIM&gt;       template_geometry;</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt;     coord_transform;</span><br><span class="line">  TemplateDOF&lt;DIM&gt;            template_dof;</span><br><span class="line">  BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt;  basis_function;</span><br><span class="line"></span><br><span class="line">  TemplateGeometry&lt;DIM&gt;       template_geometry1;</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt;     coord_transform1;</span><br><span class="line">  TemplateDOF&lt;DIM&gt;            template_dof1;</span><br><span class="line">  BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt;  basis_function1;</span><br><span class="line"></span><br><span class="line">  TemplateDOF&lt;DIM&gt;            template_dof2;</span><br><span class="line">  BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt;  basis_function2;</span><br><span class="line"></span><br><span class="line">  TemplateDOF&lt;DIM&gt;            template_dof3;</span><br><span class="line">  BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt;  basis_function3;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;TemplateElement&lt;<span class="keyword">double</span>,DIM&gt; &gt; template_element;</span><br><span class="line"></span><br><span class="line">  HGeometryTree&lt;DIM&gt;          h_tree;</span><br><span class="line">  IrregularMesh&lt;DIM&gt;        * ir_mesh_u;</span><br><span class="line">  IrregularMesh&lt;DIM&gt;        * ir_mesh_v;</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;      * fem_space_u;</span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;      * fem_space_v;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;   * u_h;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;   * v_h;</span><br><span class="line">  <span class="keyword">double</span>                      t;</span><br><span class="line">  <span class="keyword">double</span>                      dt;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">stepForward</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">buildFEMSpace</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">getIndicator</span><span class="params">(Indicator&lt;DIM&gt;&amp;)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">adaptMesh</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __prob_h__</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><br>实现文件：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   prob.cpp</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Sat Jul 14 09:13:06 2007</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @brief  </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;prob.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">f</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>] + p[<span class="number">1</span>]*p[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">u_b</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">g</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">exp</span>(p[<span class="number">0</span>]) + <span class="built_in">sin</span>(p[<span class="number">1</span>]*p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">v_b</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>]*p[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">a</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (p[<span class="number">0</span>] &lt; <span class="number">0.6</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Matrix::buildSparseMatrix</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  SparseMatrix&lt;<span class="keyword">double</span>&gt;::<span class="built_in">reinit</span>(<span class="built_in">getSparsityPattern</span>());</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator </span><br><span class="line">    the_ele = <span class="built_in">FEMSpace0</span>()-&gt;<span class="built_in">beginElement</span>(),</span><br><span class="line">    end_ele = <span class="built_in">FEMSpace0</span>()-&gt;<span class="built_in">endElement</span>(),</span><br><span class="line">    v_it = p_u_h-&gt;<span class="built_in">femSpace</span>().<span class="built_in">beginElement</span>();</span><br><span class="line">  <span class="keyword">for</span> (;the_ele != end_ele;the_ele ++, v_it ++) &#123;</span><br><span class="line">    <span class="built_in">getElementPattern</span>(*the_ele, *the_ele);</span><br><span class="line">    <span class="built_in">elementMatrix</span>().<span class="built_in">reinit</span>(<span class="built_in">elementDof0</span>().<span class="built_in">size</span>(), <span class="built_in">elementDof1</span>().<span class="built_in">size</span>());</span><br><span class="line">    <span class="built_in">getElementMatrix</span>(*the_ele, *the_ele);</span><br><span class="line">    <span class="built_in">addElementMatrix</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Matrix::getElementMatrix</span><span class="params">(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele0, </span></span></span><br><span class="line"><span class="function"><span class="params">			      <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele1, </span></span></span><br><span class="line"><span class="function"><span class="params">			      ActiveElementPairIterator&lt;DIM&gt;::State)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">double</span> vol = ele0.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">  <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">    ele0.<span class="built_in">findQuadratureInfo</span>(<span class="built_in">algebricAccuracy</span>());</span><br><span class="line">  <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">  std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">    ele0.<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">  std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">    ele0.<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">  std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">    basis_value = ele0.<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">  std::vector&lt;std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; &gt; </span><br><span class="line">    basis_gradient = ele0.<span class="built_in">basis_function_gradient</span>(q_point);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = ele0.<span class="built_in">dof</span>();</span><br><span class="line">  u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">    <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">    <span class="keyword">double</span> a_value = <span class="built_in">a</span>(q_point[l]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">double</span> u_h_val = p_u_h-&gt;<span class="built_in">value</span>(q_point[l], *v_it);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n_ele_dof;++ i) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">        <span class="built_in">elementMatrix</span>(i, j) += Jxw*</span><br><span class="line">          ((<span class="number">1</span>/_dt)*basis_value[i][l]*basis_value[j][l]</span><br><span class="line">           + a_value*<span class="built_in">innerProduct</span>(basis_gradient[i][l], </span><br><span class="line">                                  basis_gradient[j][l])</span><br><span class="line">           + <span class="number">10000</span>*u_h_val*u_h_val*basis_value[i][l]*basis_value[j][l]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  h_tree.<span class="built_in">readEasyMesh</span>(<span class="string">&quot;M&quot;</span>);</span><br><span class="line">  ir_mesh = <span class="keyword">new</span> IrregularMesh&lt;DIM&gt;(h_tree);</span><br><span class="line">  ir_mesh-&gt;<span class="built_in">globalRefine</span>(<span class="number">3</span>);</span><br><span class="line">  ir_mesh-&gt;<span class="built_in">semiregularize</span>();</span><br><span class="line">  ir_mesh-&gt;<span class="built_in">regularize</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  template_geometry.<span class="built_in">readData</span>(<span class="string">&quot;triangle.tmp_geo&quot;</span>);</span><br><span class="line">  coord_transform.<span class="built_in">readData</span>(<span class="string">&quot;triangle.crd_trs&quot;</span>);</span><br><span class="line">  template_dof.<span class="built_in">reinit</span>(template_geometry);</span><br><span class="line">  template_dof.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  basis_function.<span class="built_in">reinit</span>(template_dof);</span><br><span class="line">  basis_function.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  template_dof2.<span class="built_in">reinit</span>(template_geometry);</span><br><span class="line">  template_dof2.<span class="built_in">readData</span>(<span class="string">&quot;triangle.2.tmp_dof&quot;</span>);</span><br><span class="line">  basis_function2.<span class="built_in">reinit</span>(template_dof2);</span><br><span class="line">  basis_function2.<span class="built_in">readData</span>(<span class="string">&quot;triangle.2.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  template_geometry1.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.tmp_geo&quot;</span>);</span><br><span class="line">  coord_transform1.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.crd_trs&quot;</span>);</span><br><span class="line">  template_dof1.<span class="built_in">reinit</span>(template_geometry1);</span><br><span class="line">  template_dof1.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  basis_function1.<span class="built_in">reinit</span>(template_dof1);</span><br><span class="line">  basis_function1.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  template_dof3.<span class="built_in">reinit</span>(template_geometry1);</span><br><span class="line">  template_dof3.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.2.tmp_dof&quot;</span>);</span><br><span class="line">  basis_function3.<span class="built_in">reinit</span>(template_dof3);</span><br><span class="line">  basis_function3.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.2.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  template_element.<span class="built_in">resize</span>(<span class="number">4</span>);</span><br><span class="line">  template_element[<span class="number">0</span>].<span class="built_in">reinit</span>(template_geometry,</span><br><span class="line">                             template_dof,</span><br><span class="line">                             coord_transform,</span><br><span class="line">                             basis_function);</span><br><span class="line">  template_element[<span class="number">1</span>].<span class="built_in">reinit</span>(template_geometry1,</span><br><span class="line">                             template_dof1,</span><br><span class="line">                             coord_transform1,</span><br><span class="line">                             basis_function1);</span><br><span class="line">  template_element[<span class="number">2</span>].<span class="built_in">reinit</span>(template_geometry,</span><br><span class="line">                             template_dof2,</span><br><span class="line">                             coord_transform,</span><br><span class="line">                             basis_function2);</span><br><span class="line">  template_element[<span class="number">3</span>].<span class="built_in">reinit</span>(template_geometry1,</span><br><span class="line">                             template_dof3,</span><br><span class="line">                             coord_transform1,</span><br><span class="line">                             basis_function3);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">buildFEMSpace</span>();</span><br><span class="line"></span><br><span class="line">  t = <span class="number">0</span>, dt = <span class="number">1.0e-02</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::buildFEMSpace</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  RegularMesh&lt;DIM&gt;&amp; mesh_u = ir_mesh_u-&gt;<span class="built_in">regularMesh</span>();</span><br><span class="line"></span><br><span class="line">  u_int n_ele = mesh_u.<span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">  fem_space_u = <span class="keyword">new</span> FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;(mesh_u, template_element);</span><br><span class="line">  fem_space_u-&gt;<span class="built_in">element</span>().<span class="built_in">resize</span>(n_ele);</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele;++ i) &#123;</span><br><span class="line">    u_int n_vtx = mesh_u.<span class="built_in">geometry</span>(DIM, i).<span class="built_in">n_vertex</span>();</span><br><span class="line">    <span class="keyword">if</span> (n_vtx == <span class="number">3</span>) &#123;</span><br><span class="line">      fem_space_u-&gt;<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(*fem_space_u, i, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      fem_space_u-&gt;<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(*fem_space_u, i, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  fem_space_u-&gt;<span class="built_in">buildElement</span>();</span><br><span class="line">  fem_space_u-&gt;<span class="built_in">buildDof</span>();</span><br><span class="line">  fem_space_u-&gt;<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line"></span><br><span class="line">  RegularMesh&lt;DIM&gt;&amp; mesh_v = ir_mesh_v-&gt;<span class="built_in">regularMesh</span>();</span><br><span class="line"></span><br><span class="line">  n_ele = mesh_v.<span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">  fem_space_v = <span class="keyword">new</span> FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;(mesh_v, template_element);</span><br><span class="line">  fem_space_v-&gt;<span class="built_in">element</span>().<span class="built_in">resize</span>(n_ele);</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele;++ i) &#123;</span><br><span class="line">    u_int n_vtx = mesh_v.<span class="built_in">geometry</span>(DIM, i).<span class="built_in">n_vertex</span>();</span><br><span class="line">    <span class="keyword">if</span> (n_vtx == <span class="number">3</span>) &#123;</span><br><span class="line">      fem_space_v-&gt;<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(*fem_space_v, i, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      fem_space_v-&gt;<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(*fem_space_v, i, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  fem_space_v-&gt;<span class="built_in">buildElement</span>();</span><br><span class="line">  fem_space_v-&gt;<span class="built_in">buildDof</span>();</span><br><span class="line">  fem_space_v-&gt;<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line"></span><br><span class="line">  u_h = <span class="keyword">new</span> FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;(*fem_space_u);</span><br><span class="line">  v_h = <span class="keyword">new</span> FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;(*fem_space_v);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::adaptMesh</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">Indicator&lt;DIM&gt; <span class="title">ind_u</span><span class="params">(ir_mesh_u-&gt;regularMesh())</span></span>;</span><br><span class="line">  <span class="built_in">getIndicator_u</span>(ind_u);</span><br><span class="line"></span><br><span class="line">  IrregularMesh&lt;DIM&gt; * old_ir_mesh_u = ir_mesh_u;</span><br><span class="line">  ir_mesh_u = <span class="keyword">new</span> IrregularMesh&lt;DIM&gt;(*old_ir_mesh_u);</span><br><span class="line"></span><br><span class="line">  <span class="function">MeshAdaptor&lt;DIM&gt; <span class="title">mesh_adaptor</span><span class="params">(*old_ir_mesh_u, *ir_mesh_u)</span></span>;</span><br><span class="line">  mesh_adaptor.<span class="built_in">setIndicator</span>(ind_u);</span><br><span class="line">  mesh_adaptor.<span class="built_in">tolerence</span>() = <span class="number">1.0e-04</span>;</span><br><span class="line">  mesh_adaptor.<span class="built_in">convergenceOrder</span>() = <span class="number">1</span>;</span><br><span class="line">  mesh_adaptor.<span class="built_in">adapt</span>();</span><br><span class="line"></span><br><span class="line">  ir_mesh_u-&gt;<span class="built_in">semiregularize</span>();</span><br><span class="line">  ir_mesh_u-&gt;<span class="built_in">regularize</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt; * old_fem_space_u = fem_space_u;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt; * old_u_h = u_h;</span><br><span class="line"></span><br><span class="line">  <span class="comment">///////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">  <span class="function">Indicator&lt;DIM&gt; <span class="title">ind_v</span><span class="params">(ir_mesh_v-&gt;regularMesh())</span></span>;</span><br><span class="line">  <span class="built_in">getIndicator_v</span>(ind_v);</span><br><span class="line"></span><br><span class="line">  IrregularMesh&lt;DIM&gt; * old_ir_mesh_v = ir_mesh_v;</span><br><span class="line">  ir_mesh_v = <span class="keyword">new</span> IrregularMesh&lt;DIM&gt;(*old_ir_mesh_v);</span><br><span class="line"></span><br><span class="line">  mesh_adaptor.<span class="built_in">reinit</span>(*old_ir_mesh_v, *ir_mesh_v);</span><br><span class="line">  mesh_adaptor.<span class="built_in">setIndicator</span>(ind_v);</span><br><span class="line">  mesh_adaptor.<span class="built_in">tolerence</span>() = <span class="number">1.0e-04</span>;</span><br><span class="line">  mesh_adaptor.<span class="built_in">convergenceOrder</span>() = <span class="number">1</span>;</span><br><span class="line">  mesh_adaptor.<span class="built_in">adapt</span>();</span><br><span class="line"></span><br><span class="line">  ir_mesh_v-&gt;<span class="built_in">semiregularize</span>();</span><br><span class="line">  ir_mesh_v-&gt;<span class="built_in">regularize</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt; * old_fem_space_v = fem_space_v;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt; * old_v_h = v_h;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">buildFEMSpace</span>();</span><br><span class="line"></span><br><span class="line">  Operator::<span class="built_in">L2Interpolate</span>(*old_u_h, *u_h);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> old_u_h;</span><br><span class="line">  <span class="keyword">delete</span> old_fem_space_u;</span><br><span class="line">  <span class="keyword">delete</span> old_ir_mesh_u;</span><br><span class="line"></span><br><span class="line">  <span class="comment">////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">  Operator::<span class="built_in">L2Interpolate</span>(*old_v_h, *v_h);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> old_v_h;</span><br><span class="line">  <span class="keyword">delete</span> old_fem_space_v;</span><br><span class="line">  <span class="keyword">delete</span> old_ir_mesh_v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="built_in">stepForward</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">adaptMesh</span>();</span><br><span class="line"></span><br><span class="line">    t += dt;</span><br><span class="line">    u_h-&gt;<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;u_h.dx&quot;</span>);</span><br><span class="line">    v_h-&gt;<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;v_h.dx&quot;</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;t = &quot;</span> &lt;&lt; t &lt;&lt; std::endl;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::stepForward</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FEMFunction&lt;double,DIM&gt; last_u_h(*u_h);</span><br><span class="line">  FEMFunction&lt;double,DIM&gt; last_v_h(*v_h);</span><br><span class="line"></span><br><span class="line">  u_int step = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function">Matrix <span class="title">stiff_matrix</span><span class="params">(*fem_space_v, dt, *u_h)</span></span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">      Vector&lt;<span class="keyword">double</span>&gt; rhs;</span><br><span class="line">      Operator::<span class="built_in">L2Discretize</span>(g, *fem_space_v, rhs, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">      <span class="function">IrregularMeshPair&lt;DIM&gt; <span class="title">mesh_pair</span><span class="params">(*ir_mesh_u, *ir_mesh_v)</span></span>;</span><br><span class="line">      ActiveElementPairIterator&lt;DIM&gt; </span><br><span class="line">        the_pair = mesh_pair.<span class="built_in">beginActiveElementPair</span>(),</span><br><span class="line">        end_pair = mesh_pair.<span class="built_in">endActiveElementPair</span>();</span><br><span class="line">      <span class="keyword">for</span> (;the_pair != end_pair;++ the_pair) &#123;</span><br><span class="line">        <span class="keyword">const</span> HElement&lt;DIM&gt;&amp; h_element0 = <span class="built_in">the_pair</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">const</span> HElement&lt;DIM&gt;&amp; h_element1 = <span class="built_in">the_pair</span>(<span class="number">1</span>);</span><br><span class="line">        Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; ele0 = fem_space_u-&gt;<span class="built_in">element</span>(h_element0.index);</span><br><span class="line">        Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; ele1 = fem_space_v-&gt;<span class="built_in">element</span>(h_element1.index);</span><br><span class="line">        <span class="keyword">if</span> (the_pair.<span class="built_in">State</span>() == <span class="number">-1</span>) &#123; <span class="comment">// GREAT_THAN</span></span><br><span class="line">          <span class="keyword">double</span> vol = ele1.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"> </span><br><span class="line">          <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">            ele1.<span class="built_in">findQuadratureInfo</span>(<span class="number">2</span>);</span><br><span class="line">          <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">          std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">            ele1.<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">          std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">            ele1.<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">          </span><br><span class="line">          std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">            basis_value = ele1.<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">          std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = last_u_h.<span class="built_in">value</span>(q_point, ele0);</span><br><span class="line">          std::vector&lt;<span class="keyword">double</span>&gt; v_h_val = last_v_h.<span class="built_in">value</span>(q_point, ele1);</span><br><span class="line">          std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">            v_h_grad = last_v_h.<span class="built_in">gradient</span>(q_point, ele1);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = ele1.<span class="built_in">dof</span>();</span><br><span class="line">          u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">            <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">            <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">              <span class="built_in">rhs</span>(ele_dof[j]) += Jxw*((<span class="number">1</span>/dt)*v_h_val[l] - </span><br><span class="line">                                      u_h_val[l]*v_h_grad[l][<span class="number">0</span>] -</span><br><span class="line">                                      v_h_val[l]*v_h_grad[l][<span class="number">1</span>]</span><br><span class="line">                                      )*basis_value[j][l];</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">double</span> vol = ele0.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"> </span><br><span class="line">          <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">            ele0.<span class="built_in">findQuadratureInfo</span>(<span class="number">2</span>);</span><br><span class="line">          <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">          std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">            ele0.<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">          std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">            ele0.<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">          </span><br><span class="line">          std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">            basis_value = ele1.<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">          std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = last_u_h.<span class="built_in">value</span>(q_point, ele0);</span><br><span class="line">          std::vector&lt;<span class="keyword">double</span>&gt; v_h_val = last_v_h.<span class="built_in">value</span>(q_point, ele1);</span><br><span class="line">          std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">            v_h_grad = last_v_h.<span class="built_in">gradient</span>(q_point, ele1);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = ele1.<span class="built_in">dof</span>();</span><br><span class="line">          u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">            <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">            <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">              <span class="built_in">rhs</span>(ele_dof[j]) += Jxw*((<span class="number">1</span>/dt)*v_h_val[l] - </span><br><span class="line">                                      u_h_val[l]*v_h_grad[l][<span class="number">0</span>] -</span><br><span class="line">                                      v_h_val[l]*v_h_grad[l][<span class="number">1</span>]</span><br><span class="line">                                      )*basis_value[j][l];</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator </span><br><span class="line">        the_ele = fem_space_v-&gt;<span class="built_in">beginElement</span>(),</span><br><span class="line">        end_ele = fem_space_v-&gt;<span class="built_in">endElement</span>(),</span><br><span class="line">        the_ele_u = fem_space_u-&gt;<span class="built_in">beginElement</span>();</span><br><span class="line">      <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele, ++ the_ele_u) &#123;</span><br><span class="line">        <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">          the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">          basis_value = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = last_u_h.<span class="built_in">value</span>(q_point, *the_ele_u);</span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; v_h_val = last_v_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">          v_h_grad = last_v_h.<span class="built_in">gradient</span>(q_point, *the_ele);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">        u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">          <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">          <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">            <span class="built_in">rhs</span>(ele_dof[j]) += Jxw*((<span class="number">1</span>/dt)*v_h_val[l] - </span><br><span class="line">                                    u_h_val[l]*v_h_grad[l][<span class="number">0</span>] -</span><br><span class="line">                                    v_h_val[l]*v_h_grad[l][<span class="number">1</span>]</span><br><span class="line">                                    )*basis_value[j][l];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary1(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">1</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary2(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">2</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary3(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">3</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary4(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">4</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary5(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">5</span>, &amp;v_b);</span><br><span class="line">      BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(*fem_space_v);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary1);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary2);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary3);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary4);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary5);</span><br><span class="line">      boundary_admin.<span class="built_in">apply</span>(stiff_matrix, *v_h, rhs);</span><br><span class="line"></span><br><span class="line">      AMGSolver solver;</span><br><span class="line">      solver.<span class="built_in">lazyReinit</span>(stiff_matrix);</span><br><span class="line">      solver.<span class="built_in">solve</span>(*v_h, rhs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      FEMFunction&lt;double,DIM&gt; old_u_h(*u_h);</span><br><span class="line"></span><br><span class="line">      <span class="function">Matrix <span class="title">stiff_matrix</span><span class="params">(*fem_space_u, dt, *v_h)</span></span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">      Vector&lt;<span class="keyword">double</span>&gt; rhs;</span><br><span class="line">      Operator::<span class="built_in">L2Discretize</span>(f, *fem_space_u, rhs, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">      FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator </span><br><span class="line">        the_ele = fem_space_u-&gt;<span class="built_in">beginElement</span>(),</span><br><span class="line">        end_ele = fem_space_u-&gt;<span class="built_in">endElement</span>(),</span><br><span class="line">        the_ele_v = fem_space_v-&gt;<span class="built_in">beginElement</span>();</span><br><span class="line">      <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele, ++ the_ele_v) &#123;</span><br><span class="line">        <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">          the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">          basis_value = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = last_u_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; v_h_val = last_v_h.<span class="built_in">value</span>(q_point, *the_ele_v);</span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">          u_h_grad = last_u_h.<span class="built_in">gradient</span>(q_point, *the_ele);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">        u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">          <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">          <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">            <span class="built_in">rhs</span>(ele_dof[j]) += Jxw*((<span class="number">1</span>/dt)*u_h_val[l] - </span><br><span class="line">                                    u_h_val[l]*u_h_grad[l][<span class="number">0</span>] -</span><br><span class="line">                                    v_h_val[l]*u_h_grad[l][<span class="number">1</span>]</span><br><span class="line">                                    )*basis_value[j][l];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary1(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">1</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary2(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">2</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary3(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">3</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary4(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">4</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary5(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">5</span>, &amp;u_b);</span><br><span class="line">      BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(*fem_space_u);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary1);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary2);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary3);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary4);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary5);</span><br><span class="line">      boundary_admin.<span class="built_in">apply</span>(stiff_matrix, *u_h, rhs);</span><br><span class="line"></span><br><span class="line">      AMGSolver solver;</span><br><span class="line">      solver.<span class="built_in">lazyReinit</span>(stiff_matrix);</span><br><span class="line">      solver.<span class="built_in">solve</span>(*u_h, rhs);</span><br><span class="line"></span><br><span class="line">      old_u_h.<span class="built_in">add</span>(<span class="number">-1.0</span>, *u_h);</span><br><span class="line">      <span class="keyword">double</span> error = Functional::<span class="built_in">L2Norm</span>(old_u_h, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">      std::cout &lt;&lt; <span class="string">&quot;step &quot;</span> &lt;&lt; step ++ &lt;&lt; <span class="string">&quot;, error = &quot;</span> &lt;&lt; error &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (error &lt; <span class="number">1.0e-08</span>) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::getIndicator</span><span class="params">(Indicator&lt;DIM&gt;&amp; ind)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  RegularMesh&lt;DIM&gt;&amp; mesh = ir_mesh-&gt;<span class="built_in">regularMesh</span>();</span><br><span class="line">  u_int n_face = mesh.<span class="built_in">n_geometry</span>(DIM - <span class="number">1</span>);</span><br><span class="line">  <span class="function">std::vector&lt;<span class="keyword">bool</span>&gt; <span class="title">flag</span><span class="params">(n_face, <span class="literal">false</span>)</span></span>;</span><br><span class="line">  <span class="function">std::vector&lt;<span class="keyword">double</span>&gt; <span class="title">jump</span><span class="params">(n_face)</span></span>;</span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator</span><br><span class="line">    the_ele = fem_space_u-&gt;<span class="built_in">beginElement</span>(),</span><br><span class="line">    end_ele = fem_space_u-&gt;<span class="built_in">endElement</span>();</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;the_ele != end_ele;++ the_ele, ++ i) &#123;</span><br><span class="line">    Point&lt;DIM&gt; p;</span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; u_h_grad = u_h-&gt;<span class="built_in">gradient</span>(p, *the_ele);</span><br><span class="line">    GeometryBM&amp; geo = the_ele-&gt;<span class="built_in">geometry</span>();</span><br><span class="line">    u_int n_bnd = geo.<span class="built_in">n_boundary</span>();</span><br><span class="line">    <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_bnd;++ j) &#123;</span><br><span class="line">      GeometryBM&amp; bnd = mesh.<span class="built_in">geometry</span>(DIM<span class="number">-1</span>, geo.<span class="built_in">boundary</span>(j));</span><br><span class="line">      Point&lt;DIM&gt;&amp; p0 = mesh.<span class="built_in">point</span>(bnd.<span class="built_in">vertex</span>(<span class="number">0</span>));</span><br><span class="line">      Point&lt;DIM&gt;&amp; p1 = mesh.<span class="built_in">point</span>(bnd.<span class="built_in">vertex</span>(<span class="number">1</span>));</span><br><span class="line">      <span class="keyword">double</span> a = (u_h_grad[<span class="number">0</span>]*(p1[<span class="number">1</span>] - p0[<span class="number">1</span>]) -</span><br><span class="line">                  u_h_grad[<span class="number">1</span>]*(p1[<span class="number">0</span>] - p0[<span class="number">0</span>]));</span><br><span class="line">      <span class="keyword">if</span> (flag[bnd.<span class="built_in">index</span>()] == <span class="literal">false</span>) &#123;</span><br><span class="line">        jump[bnd.<span class="built_in">index</span>()] = a;</span><br><span class="line">        flag[bnd.<span class="built_in">index</span>()] = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        jump[bnd.<span class="built_in">index</span>()] -= a;</span><br><span class="line">        flag[bnd.<span class="built_in">index</span>()] = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  the_ele = fem_space_u-&gt;<span class="built_in">beginElement</span>();</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;the_ele != end_ele;++ the_ele, ++ i) &#123;</span><br><span class="line">    GeometryBM&amp; geo = the_ele-&gt;<span class="built_in">geometry</span>();</span><br><span class="line">    u_int n_bnd = geo.<span class="built_in">n_boundary</span>();</span><br><span class="line">    ind[i] = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_bnd;++ j) &#123;</span><br><span class="line">      GeometryBM&amp; bnd = mesh.<span class="built_in">geometry</span>(DIM<span class="number">-1</span>, geo.<span class="built_in">boundary</span>(j));</span><br><span class="line">      <span class="keyword">if</span> (flag[bnd.<span class="built_in">index</span>()]) <span class="keyword">continue</span>;</span><br><span class="line">      ind[i] += jump[bnd.<span class="built_in">index</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  problem the_app;</span><br><span class="line">  the_app.<span class="built_in">initialize</span>();</span><br><span class="line">  the_app.<span class="built_in">run</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure></p>
<h1 id="AFEPack教学系列之十四-讨论班例子-IV"><a href="#AFEPack教学系列之十四-讨论班例子-IV" class="headerlink" title="AFEPack教学系列之十四: 讨论班例子(IV)"></a>AFEPack教学系列之十四: 讨论班例子(IV)</h1><p>下面这个例子算是我们这个系列的最终目标了 ：我们求解了</p>
<ul>
<li>两个变量耦合的偏微分方程组；</li>
<li>方程组中包含对流、扩散、非线性；</li>
<li>我们对两个变量在两个不同的网格上逼近；</li>
<li>两个变量在自己的网格上分别使用了一次元空 间和二次元空间来逼近；</li>
<li>两个变量还分别在自己的网格上做h-自适应； </li>
</ul>
<p>这个代码中有些重复的部分我没有写出来，请您自己去补全吧。</p>
<p>头文件：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   prob.h</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Sat Jul 14 09:06:42 2007</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @brief  </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __prob_h__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __prob_h__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/EasyMesh.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/FEMSpace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/BilinearOperator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Operator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/Functional.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/AMGSolver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;AFEPack/HGeometry.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIM 2</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Matrix</span> :</span> <span class="keyword">public</span> StiffMatrix&lt;DIM, <span class="keyword">double</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">double</span> _dt;</span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator v_it;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt; * p_u_h;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Matrix</span>(FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; sp,</span><br><span class="line">         <span class="keyword">double</span> dt,</span><br><span class="line">         FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;&amp; u_h) : </span><br><span class="line">    StiffMatrix&lt;DIM,<span class="keyword">double</span>&gt;(sp), _dt(dt), <span class="built_in">p_u_h</span>(&amp;u_h) &#123;&#125;;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">buildSparseMatrix</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="keyword">virtual</span> </span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">getElementMatrix</span><span class="params">(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele0, </span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele1, </span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> ActiveElementPairIterator&lt;DIM&gt;::State </span></span></span><br><span class="line"><span class="function"><span class="params">                        state=ActiveElementPairIterator&lt;DIM&gt;::EQUAL)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">problem</span> &#123;</span></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  TemplateGeometry&lt;DIM&gt;       template_geometry;</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt;     coord_transform;</span><br><span class="line">  TemplateDOF&lt;DIM&gt;            template_dof;</span><br><span class="line">  BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt;  basis_function;</span><br><span class="line"></span><br><span class="line">  TemplateGeometry&lt;DIM&gt;       template_geometry1;</span><br><span class="line">  CoordTransform&lt;DIM,DIM&gt;     coord_transform1;</span><br><span class="line">  TemplateDOF&lt;DIM&gt;            template_dof1;</span><br><span class="line">  BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt;  basis_function1;</span><br><span class="line"></span><br><span class="line">  TemplateDOF&lt;DIM&gt;            template_dof2;</span><br><span class="line">  BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt;  basis_function2;</span><br><span class="line"></span><br><span class="line">  TemplateDOF&lt;DIM&gt;            template_dof3;</span><br><span class="line">  BasisFunctionAdmin&lt;<span class="keyword">double</span>,DIM,DIM&gt;  basis_function3;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;TemplateElement&lt;<span class="keyword">double</span>,DIM&gt; &gt; template_element;</span><br><span class="line"></span><br><span class="line">  HGeometryTree&lt;DIM&gt;          h_tree;</span><br><span class="line">  IrregularMesh&lt;DIM&gt;        * ir_mesh_u;</span><br><span class="line">  IrregularMesh&lt;DIM&gt;        * ir_mesh_v;</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;      * fem_space_u;</span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;      * fem_space_v;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;   * u_h;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;   * v_h;</span><br><span class="line">  <span class="keyword">double</span>                      t;</span><br><span class="line">  <span class="keyword">double</span>                      dt;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">stepForward</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">buildFEMSpace</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">getIndicator</span><span class="params">(FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;&amp;,</span></span></span><br><span class="line"><span class="function"><span class="params">                    Indicator&lt;DIM&gt;&amp;)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">adaptMesh</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __prob_h__</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><br>实现文件：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @file   prob.cpp</span></span><br><span class="line"><span class="comment"> * @author Robert Lie</span></span><br><span class="line"><span class="comment"> * @date   Sat Jul 14 09:13:06 2007</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @brief  </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;prob.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">f</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>] + p[<span class="number">1</span>]*p[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">u_b</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">g</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">exp</span>(p[<span class="number">0</span>]) + <span class="built_in">sin</span>(p[<span class="number">1</span>]*p[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">v_b</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> p[<span class="number">0</span>]*p[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">a</span><span class="params">(<span class="keyword">const</span> <span class="keyword">double</span> * p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (p[<span class="number">0</span>] &lt; <span class="number">0.6</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Matrix::buildSparseMatrix</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  SparseMatrix&lt;<span class="keyword">double</span>&gt;::<span class="built_in">reinit</span>(<span class="built_in">getSparsityPattern</span>());</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; fem_space0 = <span class="built_in">FEMSpace0</span>();</span><br><span class="line">  femSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; fem_space1 = p_u_h-&gt;<span class="built_in">FEMSpace</span>();</span><br><span class="line">  RegularMesh&lt;DIM&gt;&amp; mesh0 = <span class="keyword">dynamic_cast</span>&lt;RegularMesh&lt;DIM&gt;&amp;&gt;(fem_space0.<span class="built_in">mesh</span>());</span><br><span class="line">  RegularMesh&lt;DIM&gt;&amp; mesh1 = <span class="keyword">dynamic_cast</span>&lt;RegularMesh&lt;DIM&gt;&amp;&gt;(fem_space1.<span class="built_in">mesh</span>());</span><br><span class="line">  IrregularMesh&lt;DIM&gt;&amp; ir_mesh0 = mesh0.<span class="built_in">irregularMesh</span>();</span><br><span class="line">  IrregularMesh&lt;DIM&gt;&amp; ir_mesh1 = mesh1.<span class="built_in">irregularMesh</span>();</span><br><span class="line">  <span class="function">MeshPair&lt;DIM&gt; <span class="title">mesh_pair</span><span class="params">(ir_mesh0, ir_mesh1)</span></span>;</span><br><span class="line">  ActiveElementPairIterator&lt;DIM&gt; </span><br><span class="line">    the_pair = mesh_pair.<span class="built_in">beginActiveElementPair</span>(),</span><br><span class="line">    end_pair = mesh_pair.<span class="built_in">endActiveElementPair</span>();</span><br><span class="line">  <span class="keyword">for</span> (;the_pair != end_pair;++ the_pair) &#123;</span><br><span class="line">    <span class="keyword">const</span> HElement&lt;DIM&gt;&amp; h_element0 = <span class="built_in">the_pair</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> HElement&lt;DIM&gt;&amp; h_element1 = <span class="built_in">the_pair</span>(<span class="number">1</span>);</span><br><span class="line">    Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; ele0 = fem_space0.<span class="built_in">element</span>(h_element0.index);</span><br><span class="line">    Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; ele1 = fem_space1.<span class="built_in">element</span>(h_element1.index);</span><br><span class="line">    <span class="built_in">getElementPattern</span>(ele0, ele0);</span><br><span class="line">    <span class="built_in">elementMatrix</span>().<span class="built_in">reinit</span>(<span class="built_in">elementDof0</span>().<span class="built_in">size</span>(), <span class="built_in">elementDof1</span>().<span class="built_in">size</span>());</span><br><span class="line">    <span class="built_in">getElementMatrix</span>(ele0, ele1, the_pair.<span class="built_in">state</span>());</span><br><span class="line">    <span class="built_in">addElementMatrix</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Matrix::getElementMatrix</span><span class="params">(<span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele0, </span></span></span><br><span class="line"><span class="function"><span class="params">			      <span class="keyword">const</span> Element&lt;<span class="keyword">double</span>,DIM&gt; &amp; ele1, </span></span></span><br><span class="line"><span class="function"><span class="params">			      ActiveElementPairIterator&lt;DIM&gt;::State state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (state == ActiveElementPairIterator&lt;DIM&gt;::GREAT_THAN) &#123;</span><br><span class="line">    <span class="comment">/// 此时单元 ele0 比较大，我们使用 ele1 上的积分公式</span></span><br><span class="line">    <span class="keyword">double</span> vol = ele1.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">    <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">      ele1.<span class="built_in">findQuadratureInfo</span>(<span class="built_in">algebricAccuracy</span>());</span><br><span class="line">    <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">      ele1.<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">    std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">      ele1.<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">      basis_value = ele0.<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; &gt; </span><br><span class="line">      basis_gradient = ele0.<span class="built_in">basis_function_gradient</span>(q_point);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = ele0.<span class="built_in">dof</span>();</span><br><span class="line">    u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">      <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">      <span class="keyword">double</span> a_value = <span class="built_in">a</span>(q_point[l]);</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">double</span> u_h_val = p_u_h-&gt;<span class="built_in">value</span>(q_point[l], ele1);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n_ele_dof;++ i) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">          <span class="built_in">elementMatrix</span>(i, j) += Jxw*</span><br><span class="line">            ((<span class="number">1</span>/_dt)*basis_value[i][l]*basis_value[j][l]</span><br><span class="line">             + a_value*<span class="built_in">innerProduct</span>(basis_gradient[i][l], </span><br><span class="line">                                    basis_gradient[j][l])</span><br><span class="line">             + <span class="number">10000</span>*u_h_val*u_h_val*basis_value[i][l]*basis_value[j][l]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/// 此时单元 ele1 比较大，我们使用 ele0 上的积分公式</span></span><br><span class="line">    <span class="keyword">double</span> vol = ele0.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line">    <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">      ele0.<span class="built_in">findQuadratureInfo</span>(<span class="built_in">algebricAccuracy</span>());</span><br><span class="line">    <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">      ele0.<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">    std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">      ele0.<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">      basis_value = ele0.<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; &gt; </span><br><span class="line">      basis_gradient = ele0.<span class="built_in">basis_function_gradient</span>(q_point);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = ele0.<span class="built_in">dof</span>();</span><br><span class="line">    u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">      <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">      <span class="keyword">double</span> a_value = <span class="built_in">a</span>(q_point[l]);</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">double</span> u_h_val = p_u_h-&gt;<span class="built_in">value</span>(q_point[l], ele1);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; n_ele_dof;++ i) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">          <span class="built_in">elementMatrix</span>(i, j) += Jxw*</span><br><span class="line">            ((<span class="number">1</span>/_dt)*basis_value[i][l]*basis_value[j][l]</span><br><span class="line">             + a_value*<span class="built_in">innerProduct</span>(basis_gradient[i][l], </span><br><span class="line">                                    basis_gradient[j][l])</span><br><span class="line">             + <span class="number">10000</span>*u_h_val*u_h_val*basis_value[i][l]*basis_value[j][l]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  h_tree.<span class="built_in">readEasyMesh</span>(<span class="string">&quot;M&quot;</span>);</span><br><span class="line">  ir_mesh = <span class="keyword">new</span> IrregularMesh&lt;DIM&gt;(h_tree);</span><br><span class="line">  ir_mesh-&gt;<span class="built_in">globalRefine</span>(<span class="number">3</span>);</span><br><span class="line">  ir_mesh-&gt;<span class="built_in">semiregularize</span>();</span><br><span class="line">  ir_mesh-&gt;<span class="built_in">regularize</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  template_geometry.<span class="built_in">readData</span>(<span class="string">&quot;triangle.tmp_geo&quot;</span>);</span><br><span class="line">  coord_transform.<span class="built_in">readData</span>(<span class="string">&quot;triangle.crd_trs&quot;</span>);</span><br><span class="line">  template_dof.<span class="built_in">reinit</span>(template_geometry);</span><br><span class="line">  template_dof.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  basis_function.<span class="built_in">reinit</span>(template_dof);</span><br><span class="line">  basis_function.<span class="built_in">readData</span>(<span class="string">&quot;triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  template_dof2.<span class="built_in">reinit</span>(template_geometry);</span><br><span class="line">  template_dof2.<span class="built_in">readData</span>(<span class="string">&quot;triangle.2.tmp_dof&quot;</span>);</span><br><span class="line">  basis_function2.<span class="built_in">reinit</span>(template_dof2);</span><br><span class="line">  basis_function2.<span class="built_in">readData</span>(<span class="string">&quot;triangle.2.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  template_geometry1.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.tmp_geo&quot;</span>);</span><br><span class="line">  coord_transform1.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.crd_trs&quot;</span>);</span><br><span class="line">  template_dof1.<span class="built_in">reinit</span>(template_geometry1);</span><br><span class="line">  template_dof1.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.1.tmp_dof&quot;</span>);</span><br><span class="line">  basis_function1.<span class="built_in">reinit</span>(template_dof1);</span><br><span class="line">  basis_function1.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.1.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  template_dof3.<span class="built_in">reinit</span>(template_geometry1);</span><br><span class="line">  template_dof3.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.2.tmp_dof&quot;</span>);</span><br><span class="line">  basis_function3.<span class="built_in">reinit</span>(template_dof3);</span><br><span class="line">  basis_function3.<span class="built_in">readData</span>(<span class="string">&quot;twin_triangle.2.bas_fun&quot;</span>);</span><br><span class="line"></span><br><span class="line">  template_element.<span class="built_in">resize</span>(<span class="number">4</span>);</span><br><span class="line">  template_element[<span class="number">0</span>].<span class="built_in">reinit</span>(template_geometry,</span><br><span class="line">                             template_dof,</span><br><span class="line">                             coord_transform,</span><br><span class="line">                             basis_function);</span><br><span class="line">  template_element[<span class="number">1</span>].<span class="built_in">reinit</span>(template_geometry1,</span><br><span class="line">                             template_dof1,</span><br><span class="line">                             coord_transform1,</span><br><span class="line">                             basis_function1);</span><br><span class="line">  template_element[<span class="number">2</span>].<span class="built_in">reinit</span>(template_geometry,</span><br><span class="line">                             template_dof2,</span><br><span class="line">                             coord_transform,</span><br><span class="line">                             basis_function2);</span><br><span class="line">  template_element[<span class="number">3</span>].<span class="built_in">reinit</span>(template_geometry1,</span><br><span class="line">                             template_dof3,</span><br><span class="line">                             coord_transform1,</span><br><span class="line">                             basis_function3);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">buildFEMSpace</span>();</span><br><span class="line"></span><br><span class="line">  t = <span class="number">0</span>, dt = <span class="number">1.0e-02</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::buildFEMSpace</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  RegularMesh&lt;DIM&gt;&amp; mesh_u = ir_mesh_u-&gt;<span class="built_in">regularMesh</span>();</span><br><span class="line"></span><br><span class="line">  u_int n_ele = mesh_u.<span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">  fem_space_u = <span class="keyword">new</span> FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;(mesh_u, template_element);</span><br><span class="line">  fem_space_u-&gt;<span class="built_in">element</span>().<span class="built_in">resize</span>(n_ele);</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele;++ i) &#123;</span><br><span class="line">    u_int n_vtx = mesh_u.<span class="built_in">geometry</span>(DIM, i).<span class="built_in">n_vertex</span>();</span><br><span class="line">    <span class="keyword">if</span> (n_vtx == <span class="number">3</span>) &#123;</span><br><span class="line">      fem_space_u-&gt;<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(*fem_space_u, i, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      fem_space_u-&gt;<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(*fem_space_u, i, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  fem_space_u-&gt;<span class="built_in">buildElement</span>();</span><br><span class="line">  fem_space_u-&gt;<span class="built_in">buildDof</span>();</span><br><span class="line">  fem_space_u-&gt;<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line"></span><br><span class="line">  RegularMesh&lt;DIM&gt;&amp; mesh_v = ir_mesh_v-&gt;<span class="built_in">regularMesh</span>();</span><br><span class="line"></span><br><span class="line">  n_ele = mesh_v.<span class="built_in">n_geometry</span>(DIM);</span><br><span class="line">  fem_space_v = <span class="keyword">new</span> FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;(mesh_v, template_element);</span><br><span class="line">  fem_space_v-&gt;<span class="built_in">element</span>().<span class="built_in">resize</span>(n_ele);</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;i &lt; n_ele;++ i) &#123;</span><br><span class="line">    u_int n_vtx = mesh_v.<span class="built_in">geometry</span>(DIM, i).<span class="built_in">n_vertex</span>();</span><br><span class="line">    <span class="keyword">if</span> (n_vtx == <span class="number">3</span>) &#123;</span><br><span class="line">      fem_space_v-&gt;<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(*fem_space_v, i, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      fem_space_v-&gt;<span class="built_in">element</span>(i).<span class="built_in">reinit</span>(*fem_space_v, i, <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  fem_space_v-&gt;<span class="built_in">buildElement</span>();</span><br><span class="line">  fem_space_v-&gt;<span class="built_in">buildDof</span>();</span><br><span class="line">  fem_space_v-&gt;<span class="built_in">buildDofBoundaryMark</span>();</span><br><span class="line"></span><br><span class="line">  u_h = <span class="keyword">new</span> FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;(*fem_space_u);</span><br><span class="line">  v_h = <span class="keyword">new</span> FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;(*fem_space_v);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::adaptMesh</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">Indicator&lt;DIM&gt; <span class="title">ind_u</span><span class="params">(ir_mesh_u-&gt;regularMesh())</span></span>;</span><br><span class="line">  <span class="built_in">getIndicator</span>(*u_h, ind_u);</span><br><span class="line"></span><br><span class="line">  IrregularMesh&lt;DIM&gt; * old_ir_mesh_u = ir_mesh_u;</span><br><span class="line">  ir_mesh_u = <span class="keyword">new</span> IrregularMesh&lt;DIM&gt;(*old_ir_mesh_u);</span><br><span class="line"></span><br><span class="line">  <span class="function">MeshAdaptor&lt;DIM&gt; <span class="title">mesh_adaptor</span><span class="params">(*old_ir_mesh_u, *ir_mesh_u)</span></span>;</span><br><span class="line">  mesh_adaptor.<span class="built_in">setIndicator</span>(ind_u);</span><br><span class="line">  mesh_adaptor.<span class="built_in">tolerence</span>() = <span class="number">1.0e-04</span>;</span><br><span class="line">  mesh_adaptor.<span class="built_in">convergenceOrder</span>() = <span class="number">1</span>;</span><br><span class="line">  mesh_adaptor.<span class="built_in">adapt</span>();</span><br><span class="line"></span><br><span class="line">  ir_mesh_u-&gt;<span class="built_in">semiregularize</span>();</span><br><span class="line">  ir_mesh_u-&gt;<span class="built_in">regularize</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt; * old_fem_space_u = fem_space_u;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt; * old_u_h = u_h;</span><br><span class="line"></span><br><span class="line">  <span class="comment">///////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">  <span class="function">Indicator&lt;DIM&gt; <span class="title">ind_v</span><span class="params">(ir_mesh_v-&gt;regularMesh())</span></span>;</span><br><span class="line">  <span class="built_in">getIndicator</span>(*v_h, ind_v);</span><br><span class="line"></span><br><span class="line">  IrregularMesh&lt;DIM&gt; * old_ir_mesh_v = ir_mesh_v;</span><br><span class="line">  ir_mesh_v = <span class="keyword">new</span> IrregularMesh&lt;DIM&gt;(*old_ir_mesh_v);</span><br><span class="line"></span><br><span class="line">  mesh_adaptor.<span class="built_in">reinit</span>(*old_ir_mesh_v, *ir_mesh_v);</span><br><span class="line">  mesh_adaptor.<span class="built_in">setIndicator</span>(ind_v);</span><br><span class="line">  mesh_adaptor.<span class="built_in">tolerence</span>() = <span class="number">1.0e-04</span>;</span><br><span class="line">  mesh_adaptor.<span class="built_in">convergenceOrder</span>() = <span class="number">1</span>;</span><br><span class="line">  mesh_adaptor.<span class="built_in">adapt</span>();</span><br><span class="line"></span><br><span class="line">  ir_mesh_v-&gt;<span class="built_in">semiregularize</span>();</span><br><span class="line">  ir_mesh_v-&gt;<span class="built_in">regularize</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt; * old_fem_space_v = fem_space_v;</span><br><span class="line">  FEMFunction&lt;<span class="keyword">double</span>,DIM&gt; * old_v_h = v_h;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">buildFEMSpace</span>();</span><br><span class="line"></span><br><span class="line">  Operator::<span class="built_in">L2Interpolate</span>(*old_u_h, *u_h);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> old_u_h;</span><br><span class="line">  <span class="keyword">delete</span> old_fem_space_u;</span><br><span class="line">  <span class="keyword">delete</span> old_ir_mesh_u;</span><br><span class="line"></span><br><span class="line">  <span class="comment">////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">  Operator::<span class="built_in">L2Interpolate</span>(*old_v_h, *v_h);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> old_v_h;</span><br><span class="line">  <span class="keyword">delete</span> old_fem_space_v;</span><br><span class="line">  <span class="keyword">delete</span> old_ir_mesh_v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="built_in">stepForward</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">adaptMesh</span>();</span><br><span class="line"></span><br><span class="line">    t += dt;</span><br><span class="line">    u_h-&gt;<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;u_h.dx&quot;</span>);</span><br><span class="line">    v_h-&gt;<span class="built_in">writeOpenDXData</span>(<span class="string">&quot;v_h.dx&quot;</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;t = &quot;</span> &lt;&lt; t &lt;&lt; std::endl;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::stepForward</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FEMFunction&lt;double,DIM&gt; last_u_h(*u_h);</span><br><span class="line">  FEMFunction&lt;double,DIM&gt; last_v_h(*v_h);</span><br><span class="line"></span><br><span class="line">  u_int step = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function">Matrix <span class="title">stiff_matrix</span><span class="params">(*fem_space_v, dt, *u_h)</span></span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">      Vector&lt;<span class="keyword">double</span>&gt; rhs;</span><br><span class="line">      Operator::<span class="built_in">L2Discretize</span>(g, *fem_space_v, rhs, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">      <span class="function">IrregularMeshPair&lt;DIM&gt; <span class="title">mesh_pair</span><span class="params">(*ir_mesh_u, *ir_mesh_v)</span></span>;</span><br><span class="line">      ActiveElementPairIterator&lt;DIM&gt; </span><br><span class="line">        the_pair = mesh_pair.<span class="built_in">beginActiveElementPair</span>(),</span><br><span class="line">        end_pair = mesh_pair.<span class="built_in">endActiveElementPair</span>();</span><br><span class="line">      <span class="keyword">for</span> (;the_pair != end_pair;++ the_pair) &#123;</span><br><span class="line">        <span class="keyword">const</span> HElement&lt;DIM&gt;&amp; h_element0 = <span class="built_in">the_pair</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">const</span> HElement&lt;DIM&gt;&amp; h_element1 = <span class="built_in">the_pair</span>(<span class="number">1</span>);</span><br><span class="line">        Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; ele0 = fem_space_u-&gt;<span class="built_in">element</span>(h_element0.index);</span><br><span class="line">        Element&lt;<span class="keyword">double</span>,DIM&gt;&amp; ele1 = fem_space_v-&gt;<span class="built_in">element</span>(h_element1.index);</span><br><span class="line">        <span class="keyword">if</span> (the_pair.<span class="built_in">State</span>() == ActiveElementPairIterator&lt;DIM&gt;::GREAT_THAN) &#123;</span><br><span class="line">          <span class="keyword">double</span> vol = ele1.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"> </span><br><span class="line">          <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">            ele1.<span class="built_in">findQuadratureInfo</span>(<span class="number">2</span>);</span><br><span class="line">          <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">          std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">            ele1.<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">          std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">            ele1.<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">          </span><br><span class="line">          std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">            basis_value = ele1.<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">          std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = last_u_h.<span class="built_in">value</span>(q_point, ele0);</span><br><span class="line">          std::vector&lt;<span class="keyword">double</span>&gt; v_h_val = last_v_h.<span class="built_in">value</span>(q_point, ele1);</span><br><span class="line">          std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">            v_h_grad = last_v_h.<span class="built_in">gradient</span>(q_point, ele1);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = ele1.<span class="built_in">dof</span>();</span><br><span class="line">          u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">            <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">            <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">              <span class="built_in">rhs</span>(ele_dof[j]) += Jxw*((<span class="number">1</span>/dt)*v_h_val[l] - </span><br><span class="line">                                      u_h_val[l]*v_h_grad[l][<span class="number">0</span>] -</span><br><span class="line">                                      v_h_val[l]*v_h_grad[l][<span class="number">1</span>]</span><br><span class="line">                                      )*basis_value[j][l];</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">double</span> vol = ele0.<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"> </span><br><span class="line">          <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">            ele0.<span class="built_in">findQuadratureInfo</span>(<span class="number">2</span>);</span><br><span class="line">          <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">          std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">            ele0.<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">          std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">            ele0.<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line">          </span><br><span class="line">          std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">            basis_value = ele1.<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">          std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = last_u_h.<span class="built_in">value</span>(q_point, ele0);</span><br><span class="line">          std::vector&lt;<span class="keyword">double</span>&gt; v_h_val = last_v_h.<span class="built_in">value</span>(q_point, ele1);</span><br><span class="line">          std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">            v_h_grad = last_v_h.<span class="built_in">gradient</span>(q_point, ele1);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = ele1.<span class="built_in">dof</span>();</span><br><span class="line">          u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">            <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">            <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">              <span class="built_in">rhs</span>(ele_dof[j]) += Jxw*((<span class="number">1</span>/dt)*v_h_val[l] - </span><br><span class="line">                                      u_h_val[l]*v_h_grad[l][<span class="number">0</span>] -</span><br><span class="line">                                      v_h_val[l]*v_h_grad[l][<span class="number">1</span>]</span><br><span class="line">                                      )*basis_value[j][l];</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator </span><br><span class="line">        the_ele = fem_space_v-&gt;<span class="built_in">beginElement</span>(),</span><br><span class="line">        end_ele = fem_space_v-&gt;<span class="built_in">endElement</span>(),</span><br><span class="line">        the_ele_u = fem_space_u-&gt;<span class="built_in">beginElement</span>();</span><br><span class="line">      <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele, ++ the_ele_u) &#123;</span><br><span class="line">        <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">          the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">          basis_value = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = last_u_h.<span class="built_in">value</span>(q_point, *the_ele_u);</span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; v_h_val = last_v_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">          v_h_grad = last_v_h.<span class="built_in">gradient</span>(q_point, *the_ele);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">        u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">          <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">          <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">            <span class="built_in">rhs</span>(ele_dof[j]) += Jxw*((<span class="number">1</span>/dt)*v_h_val[l] - </span><br><span class="line">                                    u_h_val[l]*v_h_grad[l][<span class="number">0</span>] -</span><br><span class="line">                                    v_h_val[l]*v_h_grad[l][<span class="number">1</span>]</span><br><span class="line">                                    )*basis_value[j][l];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary1(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">1</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary2(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">2</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary3(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">3</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary4(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">4</span>, &amp;v_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary5(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">5</span>, &amp;v_b);</span><br><span class="line">      BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(*fem_space_v);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary1);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary2);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary3);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary4);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary5);</span><br><span class="line">      boundary_admin.<span class="built_in">apply</span>(stiff_matrix, *v_h, rhs);</span><br><span class="line"></span><br><span class="line">      AMGSolver solver;</span><br><span class="line">      solver.<span class="built_in">lazyReinit</span>(stiff_matrix);</span><br><span class="line">      solver.<span class="built_in">solve</span>(*v_h, rhs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      FEMFunction&lt;double,DIM&gt; old_u_h(*u_h);</span><br><span class="line"></span><br><span class="line">      <span class="function">Matrix <span class="title">stiff_matrix</span><span class="params">(*fem_space_u, dt, *v_h)</span></span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">algebricAccuracy</span>() = <span class="number">3</span>;</span><br><span class="line">      stiff_matrix.<span class="built_in">build</span>();</span><br><span class="line"></span><br><span class="line">      Vector&lt;<span class="keyword">double</span>&gt; rhs;</span><br><span class="line">      Operator::<span class="built_in">L2Discretize</span>(f, *fem_space_u, rhs, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">      FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator </span><br><span class="line">        the_ele = fem_space_u-&gt;<span class="built_in">beginElement</span>(),</span><br><span class="line">        end_ele = fem_space_u-&gt;<span class="built_in">endElement</span>(),</span><br><span class="line">        the_ele_v = fem_space_v-&gt;<span class="built_in">beginElement</span>();</span><br><span class="line">      <span class="keyword">for</span> (;the_ele != end_ele;++ the_ele, ++ the_ele_v) &#123;</span><br><span class="line">        <span class="keyword">double</span> vol = the_ele-&gt;<span class="built_in">templateElement</span>().<span class="built_in">volume</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">const</span> QuadratureInfo&lt;DIM&gt;&amp; quad_info = </span><br><span class="line">          the_ele-&gt;<span class="built_in">findQuadratureInfo</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">int</span> n_quadrature_point = quad_info.<span class="built_in">n_quadraturePoint</span>();</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; jacobian = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global_jacobian</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;Point&lt;DIM&gt; &gt; q_point = </span><br><span class="line">          the_ele-&gt;<span class="built_in">local_to_global</span>(quad_info.<span class="built_in">quadraturePoint</span>());</span><br><span class="line"></span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt;</span><br><span class="line">          basis_value = the_ele-&gt;<span class="built_in">basis_function_value</span>(q_point);</span><br><span class="line"></span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; u_h_val = last_u_h.<span class="built_in">value</span>(q_point, *the_ele);</span><br><span class="line">        std::vector&lt;<span class="keyword">double</span>&gt; v_h_val = last_v_h.<span class="built_in">value</span>(q_point, *the_ele_v);</span><br><span class="line">        std::vector&lt;std::vector&lt;<span class="keyword">double</span>&gt; &gt; </span><br><span class="line">          u_h_grad = last_u_h.<span class="built_in">gradient</span>(q_point, *the_ele);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;&amp; ele_dof = the_ele-&gt;<span class="built_in">dof</span>();</span><br><span class="line">        u_int n_ele_dof = ele_dof.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>;l &lt; n_quadrature_point;++ l) &#123;</span><br><span class="line">          <span class="keyword">double</span> Jxw = vol*jacobian[l]*quad_info.<span class="built_in">weight</span>(l);</span><br><span class="line">          <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_ele_dof;++ j) &#123;</span><br><span class="line">            <span class="built_in">rhs</span>(ele_dof[j]) += Jxw*((<span class="number">1</span>/dt)*u_h_val[l] - </span><br><span class="line">                                    u_h_val[l]*u_h_grad[l][<span class="number">0</span>] -</span><br><span class="line">                                    v_h_val[l]*u_h_grad[l][<span class="number">1</span>]</span><br><span class="line">                                    )*basis_value[j][l];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary1(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">1</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary2(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">2</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary3(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">3</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary4(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">4</span>, &amp;u_b);</span><br><span class="line">      BoundaryFunction&lt;double,DIM&gt; boundary5(BoundaryConditionInfo::DIRICHLET, </span><br><span class="line">                                             <span class="number">5</span>, &amp;u_b);</span><br><span class="line">      BoundaryConditionAdmin&lt;double,DIM&gt; boundary_admin(*fem_space_u);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary1);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary2);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary3);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary4);</span><br><span class="line">      boundary_admin.<span class="built_in">add</span>(boundary5);</span><br><span class="line">      boundary_admin.<span class="built_in">apply</span>(stiff_matrix, *u_h, rhs);</span><br><span class="line"></span><br><span class="line">      AMGSolver solver;</span><br><span class="line">      solver.<span class="built_in">lazyReinit</span>(stiff_matrix);</span><br><span class="line">      solver.<span class="built_in">solve</span>(*u_h, rhs);</span><br><span class="line"></span><br><span class="line">      old_u_h.<span class="built_in">add</span>(<span class="number">-1.0</span>, *u_h);</span><br><span class="line">      <span class="keyword">double</span> error = Functional::<span class="built_in">L2Norm</span>(old_u_h, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">      std::cout &lt;&lt; <span class="string">&quot;step &quot;</span> &lt;&lt; step ++ &lt;&lt; <span class="string">&quot;, error = &quot;</span> &lt;&lt; error &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (error &lt; <span class="number">1.0e-08</span>) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">problem::getIndicator</span><span class="params">(FEMFunction&lt;<span class="keyword">double</span>,DIM&gt;&amp; w_h,</span></span></span><br><span class="line"><span class="function"><span class="params">                           Indicator&lt;DIM&gt;&amp; ind)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;&amp; fem_space = w_h.<span class="built_in">FEMSpace</span>();</span><br><span class="line">  Mesh&lt;DIM&gt;&amp; mesh = fem_space.<span class="built_in">mesh</span>();</span><br><span class="line">  u_int n_face = mesh.<span class="built_in">n_geometry</span>(DIM - <span class="number">1</span>);</span><br><span class="line">  <span class="function">std::vector&lt;<span class="keyword">bool</span>&gt; <span class="title">flag</span><span class="params">(n_face, <span class="literal">false</span>)</span></span>;</span><br><span class="line">  <span class="function">std::vector&lt;<span class="keyword">double</span>&gt; <span class="title">jump</span><span class="params">(n_face)</span></span>;</span><br><span class="line">  FEMSpace&lt;<span class="keyword">double</span>,DIM&gt;::ElementIterator</span><br><span class="line">    the_ele = fem_space.<span class="built_in">beginElement</span>(),</span><br><span class="line">    end_ele = fem_space.<span class="built_in">endElement</span>();</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;the_ele != end_ele;++ the_ele, ++ i) &#123;</span><br><span class="line">    Point&lt;DIM&gt; p;</span><br><span class="line">    std::vector&lt;<span class="keyword">double</span>&gt; w_h_grad = w_h.<span class="built_in">gradient</span>(p, *the_ele);</span><br><span class="line">    GeometryBM&amp; geo = the_ele-&gt;<span class="built_in">geometry</span>();</span><br><span class="line">    u_int n_bnd = geo.<span class="built_in">n_boundary</span>();</span><br><span class="line">    <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_bnd;++ j) &#123;</span><br><span class="line">      GeometryBM&amp; bnd = mesh.<span class="built_in">geometry</span>(DIM<span class="number">-1</span>, geo.<span class="built_in">boundary</span>(j));</span><br><span class="line">      Point&lt;DIM&gt;&amp; p0 = mesh.<span class="built_in">point</span>(bnd.<span class="built_in">vertex</span>(<span class="number">0</span>));</span><br><span class="line">      Point&lt;DIM&gt;&amp; p1 = mesh.<span class="built_in">point</span>(bnd.<span class="built_in">vertex</span>(<span class="number">1</span>));</span><br><span class="line">      <span class="keyword">double</span> a = (w_h_grad[<span class="number">0</span>]*(p1[<span class="number">1</span>] - p0[<span class="number">1</span>]) -</span><br><span class="line">                  w_h_grad[<span class="number">1</span>]*(p1[<span class="number">0</span>] - p0[<span class="number">0</span>]));</span><br><span class="line">      <span class="keyword">if</span> (flag[bnd.<span class="built_in">index</span>()] == <span class="literal">false</span>) &#123;</span><br><span class="line">        jump[bnd.<span class="built_in">index</span>()] = a;</span><br><span class="line">        flag[bnd.<span class="built_in">index</span>()] = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        jump[bnd.<span class="built_in">index</span>()] -= a;</span><br><span class="line">        flag[bnd.<span class="built_in">index</span>()] = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  the_ele = fem_space_u-&gt;<span class="built_in">beginElement</span>();</span><br><span class="line">  <span class="keyword">for</span> (u_int i = <span class="number">0</span>;the_ele != end_ele;++ the_ele, ++ i) &#123;</span><br><span class="line">    GeometryBM&amp; geo = the_ele-&gt;<span class="built_in">geometry</span>();</span><br><span class="line">    u_int n_bnd = geo.<span class="built_in">n_boundary</span>();</span><br><span class="line">    ind[i] = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">for</span> (u_int j = <span class="number">0</span>;j &lt; n_bnd;++ j) &#123;</span><br><span class="line">      GeometryBM&amp; bnd = mesh.<span class="built_in">geometry</span>(DIM<span class="number">-1</span>, geo.<span class="built_in">boundary</span>(j));</span><br><span class="line">      <span class="keyword">if</span> (flag[bnd.<span class="built_in">index</span>()]) <span class="keyword">continue</span>;</span><br><span class="line">      ind[i] += jump[bnd.<span class="built_in">index</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  problem the_app;</span><br><span class="line">  the_app.<span class="built_in">initialize</span>();</span><br><span class="line">  the_app.<span class="built_in">run</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * end of file</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure></p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Donate
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechat_reward.png" alt="Xin-Bo Qi(亓欣波) WeChat Pay">
        <p>WeChat Pay</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/linux/" rel="tag"># linux</a>
              <a href="/tags/AFEPack/" rel="tag"># AFEPack</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2016/03/08/appolaire-2008/" rel="prev" title="枝晶生长的宏微观模型">
      <i class="fa fa-chevron-left"></i> 枝晶生长的宏微观模型
    </a></div>
      <div class="post-nav-item">
    <a href="/2016/03/23/gcc-install/" rel="next" title="手动安装特定版本的gcc编译器">
      手动安装特定版本的gcc编译器 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9D%8E%E8%80%81%E5%B8%88%E7%9A%84%E8%AF%9D"><span class="nav-number">1.</span> <span class="nav-text">李老师的话</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E5%AE%89%E8%A3%85%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="nav-number">2.</span> <span class="nav-text">AFEPack安装的步骤</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BA%8C-%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%BE%8B%E5%AD%90%EF%BC%8D%EF%BC%8D%E6%B1%82%E8%A7%A3%E6%B3%8A%E6%9D%BE%E6%96%B9%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">AFEPack教学系列之二: 第一个例子－－求解泊松方程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E4%B8%89-%E5%8F%98%E4%BA%8C%E6%AC%A1%E7%B3%BB%E6%95%B0%E7%9A%84%E6%A4%AD%E5%9C%86%E5%9E%8B%E6%96%B9%E7%A8%8B"><span class="nav-number">4.</span> <span class="nav-text">AFEPack教学系列之三: 变二次系数的椭圆型方程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E5%9B%9B-%E7%AE%80%E5%8D%95%E7%9A%84%E6%8A%9B%E7%89%A9%E5%9E%8B%E6%96%B9%E7%A8%8B%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="nav-number">5.</span> <span class="nav-text">AFEPack教学系列之四: 简单的抛物型方程的例子</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BA%94-%E4%B8%80%E4%B8%AA%E6%B2%A1%E6%9C%89%E6%B3%A8%E9%87%8A%E7%9A%84%E7%A8%8B%E5%BA%8F%EF%BC%8C%E8%80%83%E8%80%83%E4%BD%A0%EF%BC%81"><span class="nav-number">6.</span> <span class="nav-text">AFEPack教学系列之五: 一个没有注释的程序，考考你！</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E5%85%AD-%E5%8A%A0%E5%85%A5%E7%A7%BB%E5%8A%A8%E7%BD%91%E6%A0%BC%E6%96%B9%E6%B3%95%E7%9A%84%E6%A4%AD%E5%9C%86%E5%9E%8B%E6%96%B9%E7%A8%8B"><span class="nav-number">7.</span> <span class="nav-text">AFEPack教学系列之六: 加入移动网格方法的椭圆型方程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E4%B8%83-%E5%8A%A0%E4%B8%80%E8%A1%8C%EF%BC%8C%E6%94%B9%E6%88%90Burgers%E6%96%B9%E7%A8%8B%E7%9A%84%E7%A8%8B%E5%BA%8F"><span class="nav-number">8.</span> <span class="nav-text">AFEPack教学系列之七: 加一行，改成Burgers方程的程序</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E5%85%AB-%E7%BD%91%E6%A0%BC%E5%92%8C%E5%87%A0%E4%BD%95%E4%BD%93"><span class="nav-number">9.</span> <span class="nav-text">AFEPack教学系列之八: 网格和几何体</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack-%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E4%B9%9D-%E5%B1%80%E9%83%A8%E5%8A%A0%E5%AF%86%E5%8A%9F%E8%83%BD%E7%9A%84%E5%B1%95%E7%A4%BA"><span class="nav-number">10.</span> <span class="nav-text">AFEPack 教学系列之九: 局部加密功能的展示</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E5%8D%81-%E5%A4%84%E7%90%86%E8%BE%B9%E7%95%8C%E6%9D%A1%E4%BB%B6-I"><span class="nav-number">11.</span> <span class="nav-text">AFEPack教学系列之十: 处理边界条件(I)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E5%8D%81-%E5%A4%84%E7%90%86%E8%BE%B9%E7%95%8C%E6%9D%A1%E4%BB%B6-II"><span class="nav-number">12.</span> <span class="nav-text">AFEPack教学系列之十: 处理边界条件(II)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E5%8D%81-%E5%A4%84%E7%90%86%E8%BE%B9%E7%95%8C%E6%9D%A1%E4%BB%B6-III"><span class="nav-number">13.</span> <span class="nav-text">AFEPack教学系列之十: 处理边界条件(III)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E5%8D%81%E4%B8%80%EF%BC%9A%E8%A7%A3%E4%BA%8C%E6%AC%A1%E6%96%B9%E7%A8%8B-%E5%B1%80%E9%83%A8%E5%8A%A0%E5%AF%86"><span class="nav-number">14.</span> <span class="nav-text">AFEPack教学系列之十一：解二次方程+局部加密</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E5%8D%81%E4%BA%8C-%E5%9C%A8%E6%B5%81%E5%BD%A2%E4%B8%8A%E5%81%9A%E7%BD%91%E6%A0%BC%E5%8A%A0%E5%AF%86%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="nav-number">15.</span> <span class="nav-text">AFEPack教学系列之十二: 在流形上做网格加密的例子</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E5%8D%81%E4%B8%89-%E8%AF%95%E8%AF%95%E7%89%B9%E5%BE%81%E7%BA%BF%E6%B3%95%E8%A7%A3%E5%AF%B9%E6%B5%81%E6%89%A9%E6%95%A3%E6%96%B9%E7%A8%8B"><span class="nav-number">16.</span> <span class="nav-text">AFEPack教学系列之十三: 试试特征线法解对流扩散方程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E5%8D%81%E5%9B%9B-%E8%AE%A8%E8%AE%BA%E7%8F%AD%E4%BE%8B%E5%AD%90-I"><span class="nav-number">17.</span> <span class="nav-text">AFEPack教学系列之十四: 讨论班例子(I)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E5%8D%81%E5%9B%9B-%E8%AE%A8%E8%AE%BA%E7%8F%AD%E4%BE%8B%E5%AD%90-II"><span class="nav-number">18.</span> <span class="nav-text">AFEPack教学系列之十四: 讨论班例子(II)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack-%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E5%8D%81%E5%9B%9B-%E8%AE%A8%E8%AE%BA%E7%8F%AD%E4%BE%8B%E5%AD%90-III"><span class="nav-number">19.</span> <span class="nav-text">AFEPack 教学系列之十四: 讨论班例子(III)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AFEPack%E6%95%99%E5%AD%A6%E7%B3%BB%E5%88%97%E4%B9%8B%E5%8D%81%E5%9B%9B-%E8%AE%A8%E8%AE%BA%E7%8F%AD%E4%BE%8B%E5%AD%90-IV"><span class="nav-number">20.</span> <span class="nav-text">AFEPack教学系列之十四: 讨论班例子(IV)</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xin-Bo Qi(亓欣波)"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Xin-Bo Qi(亓欣波)</p>
  <div class="site-description" itemprop="description">Digitize everything to realize Digitalization!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">166</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/qixinbo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qixinbo" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:qixinbo@gmail.com" title="E-Mail → mailto:qixinbo@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/qixinbo" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;qixinbo" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fas fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.tsinghua.edu.cn/" title="https:&#x2F;&#x2F;www.tsinghua.edu.cn" rel="noopener" target="_blank">THU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.imr.cas.cn/" title="http:&#x2F;&#x2F;www.imr.cas.cn" rel="noopener" target="_blank">IMR</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.sdu.edu.cn/" title="http:&#x2F;&#x2F;www.sdu.edu.cn" rel="noopener" target="_blank">SDU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://liam0205.me/" title="http:&#x2F;&#x2F;liam0205.me&#x2F;" rel="noopener" target="_blank">黄晨成</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xin-Bo Qi(亓欣波)</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://qixinbo.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "http://qixinbo.github.io/2016/03/11/afepack-tutorials/";
    this.page.identifier = "2016/03/11/afepack-tutorials/";
    this.page.title = "自适应有限元包AFEPack教学系列";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://qixinbo.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
