<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qixinbo.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="%%%%%%%%%%%%%% 2021-1-31更新：基于最新的sciwx修改了以前的失效代码。 %%%%%%%%%%%%%%  ImagePy&#x2F;sciwx有个Mark模式，即在图像上面可以再绘制其他图形，比如矩形、文本、ROI标识等，本质即是利用GDI绘图。 本文是对该Mark模式的解析。  demo 先给出一个小的demo，主要就是为了看Mark模式的输入输出，方便理解它的运行本质。  1 2">
<meta property="og:type" content="article">
<meta property="og:title" content="ImagePy解析：19 -- Mark模式">
<meta property="og:url" content="http://qixinbo.github.io/2020/03/28/ImagePy_19/index.html">
<meta property="og:site_name" content="亓欣波">
<meta property="og:description" content="%%%%%%%%%%%%%% 2021-1-31更新：基于最新的sciwx修改了以前的失效代码。 %%%%%%%%%%%%%%  ImagePy&#x2F;sciwx有个Mark模式，即在图像上面可以再绘制其他图形，比如矩形、文本、ROI标识等，本质即是利用GDI绘图。 本文是对该Mark模式的解析。  demo 先给出一个小的demo，主要就是为了看Mark模式的输入输出，方便理解它的运行本质。  1 2">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/6218739/77822795-eace9f00-7130-11ea-9033-a28077379552.png">
<meta property="article:published_time" content="2020-03-27T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-26T07:44:20.812Z">
<meta property="article:author" content="Xin-Bo Qi(亓欣波)">
<meta property="article:tag" content="ImagePy">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/6218739/77822795-eace9f00-7130-11ea-9033-a28077379552.png">

<link rel="canonical" href="http://qixinbo.github.io/2020/03/28/ImagePy_19/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>ImagePy解析：19 -- Mark模式 | 亓欣波</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="亓欣波" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">亓欣波</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Hi, I am Xin-Bo Qi (亓欣波)</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-scholar">

    <a href="/scholar/" rel="section"><i class="fa fa-chart-bar fa-fw"></i>scholar</a>

  </li>
        <li class="menu-item menu-item-sources">

    <a href="/sources/" rel="section"><i class="fa fa-rss fa-fw"></i>sources</a>

  </li>
        <li class="menu-item menu-item-gallery">

    <a href="/gallery/" rel="section"><i class="fa fa-file-image fa-fw"></i>gallery</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404.html" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2020/03/28/ImagePy_19/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ImagePy解析：19 -- Mark模式
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-03-28 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-28T00:00:00+08:00">2020-03-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-26 15:44:20" itemprop="dateModified" datetime="2021-03-26T15:44:20+08:00">2021-03-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computer-vision/" itemprop="url" rel="index"><span itemprop="name">computer vision</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/03/28/ImagePy_19/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/28/ImagePy_19/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>%%%%%%%%%%%%%%<br>2021-1-31更新：基于最新的sciwx修改了以前的失效代码。<br>%%%%%%%%%%%%%%</p>
<p>ImagePy/sciwx有个Mark模式，即在图像上面可以再绘制其他图形，比如矩形、文本、ROI标识等，本质即是利用GDI绘图。<br>本文是对该Mark模式的解析。</p>
<h1 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h1><p>先给出一个小的demo，主要就是为了看Mark模式的输入输出，方便理解它的运行本质。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sciwx.canvas.mark <span class="keyword">import</span> drawmark</span><br><span class="line"><span class="keyword">from</span> sciapp.<span class="built_in">object</span> <span class="keyword">import</span> mark2shp</span><br><span class="line"></span><br><span class="line">mark =  &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;layer&#x27;</span>, <span class="string">&#x27;body&#x27;</span>: [&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;rectangle&#x27;</span>, <span class="string">&#x27;body&#x27;</span>: (<span class="number">50</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">200</span>), <span class="string">&#x27;color&#x27;</span>: (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>)&#125;, &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;circle&#x27;</span>, <span class="string">&#x27;body&#x27;</span>: (<span class="number">150</span>, <span class="number">150</span>, <span class="number">5</span>), <span class="string">&#x27;color&#x27;</span>: (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>)&#125;, &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;body&#x27;</span>: (<span class="number">75</span>, <span class="number">75</span>, <span class="string">&#x27;S:30 W:48&#x27;</span>), <span class="string">&#x27;pt&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;color&#x27;</span>: (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>)&#125;]&#125;</span><br><span class="line"></span><br><span class="line">shape = mark2shp(mark)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>(<span class="params">x, y</span>):</span></span><br><span class="line">    <span class="keyword">return</span> x, y</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent, obj</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(parent)</span><br><span class="line">        self.obj = obj</span><br><span class="line"></span><br><span class="line">        self.Bind(wx.EVT_PAINT, self.DrawMarks)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">DrawMarks</span>(<span class="params">self, e</span>):</span></span><br><span class="line">        dc = wx.PaintDC(self)</span><br><span class="line">        drawmark(dc, f, self.obj, k=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">app = wx.App()</span><br><span class="line">ex = Example(<span class="literal">None</span>, shape)</span><br><span class="line">ex.Show()</span><br><span class="line">app.MainLoop()</span><br></pre></td></tr></table></figure>
<p>一定要使用这种PaintEvent事件来调用画图（或者调用CallLater），否则会看不到所绘制的图形，具体原因见下方链接：<br><a target="_blank" rel="noopener" href="http://zetcode.com/wxpython/gdi/">wxPython graphics</a></p>
<p>效果如图（注意这张是旧图，最新代码生成的图略有不同）：<br><img src="https://user-images.githubusercontent.com/6218739/77822795-eace9f00-7130-11ea-9033-a28077379552.png" alt="mark"></p>
<p>可以看出，整个程序的逻辑很简单，<br>（1）创建一个mark配置（具体写法后面介绍），传入mark2shp函数对其转换一下<br>（2）创建一个坐标映射函数f，这是为了坐标变换（这里不涉及坐标变换，所以直接原样返回）<br>（3）通过wx.PaintDC创建一个设备上下文dc<br>（4）将dc、f和缩放因子k传入drawmark方法，从而进行绘制</p>
<p>下面分步具体解析。</p>
<h1 id="mark配置"><a href="#mark配置" class="headerlink" title="mark配置"></a>mark配置</h1><p>mark写法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mark =  &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;layer&#x27;</span>, <span class="string">&#x27;body&#x27;</span>: [&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;rectangle&#x27;</span>, <span class="string">&#x27;body&#x27;</span>: (<span class="number">50</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">200</span>), <span class="string">&#x27;color&#x27;</span>: (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>)&#125;, &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;circle&#x27;</span>, <span class="string">&#x27;body&#x27;</span>: (<span class="number">150</span>, <span class="number">150</span>, <span class="number">5</span>), <span class="string">&#x27;color&#x27;</span>: (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>)&#125;, &#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;body&#x27;</span>: (<span class="number">75</span>, <span class="number">75</span>, <span class="string">&#x27;S:30 W:48&#x27;</span>), <span class="string">&#x27;pt&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;color&#x27;</span>: (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>)&#125;]&#125;</span><br></pre></td></tr></table></figure>
<p>（之所以这样书写，是因为这样写是人类友好的，后面会将这一阅读良好的字典转换成sciapp内部的特有的Shape数据结构。）</p>
<p>mark的写法是这样的：<br>（1）mark是个字典，里面的重要的键值比如type、body等；<br>（2）第一层的type是layer，表明这是多个图形的结合，那么这一层的body就是所包含的图形的list<br>（3）具体到某个具体所绘制的图形，以上面的配置为例：<br>（3.1）矩形，其键值对有：type是rectangle，body是四个整型数值，即x、y、w和h，其中x和y是矩形的左上角（这里跟之前旧代码不同，原先的是矩形中心），w和h是高和宽，color是绘制的颜色。<br>（3.2）圆形：其键值对有：type是circle，body是三个整型数值，即x、y和r，即圆形中心和半径。<br>（3.3）文字：其键值对有：type是text，body是两个整型数值和一个文本，即x、y和文本内容，x、y是绘制文本的左上角，pt是指定是否在该左上角绘制一个小圆点。</p>
<h1 id="坐标映射函数和缩放因子"><a href="#坐标映射函数和缩放因子" class="headerlink" title="坐标映射函数和缩放因子"></a>坐标映射函数和缩放因子</h1><p>这个函数f存在的意义是在imagepy/sciwx的canvas中，其需要将图像坐标系中的坐标转换到面板坐标系中，所以在canvas的源码中可以看到，该函数f就是传入的转换到面板坐标的函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drawmark(dc, self.to_panel_coor, self.marks[i], k=self.scale)</span><br></pre></td></tr></table></figure>
<p>同理，缩放因子也是为了适应canvas画布的缩放而需要传入的。<br>因为这里没有使用到canvas，所以f中没有做任何变换，而k也是为1。</p>
<h1 id="drawmark函数"><a href="#drawmark函数" class="headerlink" title="drawmark函数"></a>drawmark函数</h1><p>这里看一下该函数的源代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drawmark</span>(<span class="params">dc, f, body, **key</span>):</span></span><br><span class="line">	default_style = body.default</span><br><span class="line">	pen, brush, font = dc.GetPen(), dc.GetBrush(), dc.GetFont()</span><br><span class="line">	pen.SetColour(default_style[<span class="string">&#x27;color&#x27;</span>])</span><br><span class="line">	brush.SetColour(default_style[<span class="string">&#x27;fcolor&#x27;</span>])</span><br><span class="line">	brush.SetStyle((<span class="number">106</span>,<span class="number">100</span>)[default_style[<span class="string">&#x27;fill&#x27;</span>]])</span><br><span class="line">	pen.SetWidth(default_style[<span class="string">&#x27;lw&#x27;</span>])</span><br><span class="line">	dc.SetTextForeground(default_style[<span class="string">&#x27;tcolor&#x27;</span>])</span><br><span class="line">	font.SetPointSize(default_style[<span class="string">&#x27;size&#x27;</span>])</span><br><span class="line">	dc.SetPen(pen); dc.SetBrush(brush); dc.SetFont(font);</span><br><span class="line">	draw(body, dc, f, **key)</span><br></pre></td></tr></table></figure>
<p>该方法就是先获得设备上下文的画笔pen、画刷brush和字体font，然后通过SetColour设置颜色、SetStyle设置风格、SetWidth设置笔宽、SetPointSize设置字体尺寸等对上述工具进行属性设置。然后再调用全局的draw()函数。<br>通过该函数也可以看出来，它接收的body需要具有一定的格式，比如有default属性。因此，最开始的mark变量没法直接传入drawmark中，需要使用mark2shp方法来转换一下。</p>
<h1 id="mark2shp函数"><a href="#mark2shp函数" class="headerlink" title="mark2shp函数"></a>mark2shp函数</h1><p>仍然看一下该函数的源代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mark2shp</span>(<span class="params">mark</span>):</span></span><br><span class="line">    style = mark.copy()</span><br><span class="line">    style.pop(<span class="string">&#x27;body&#x27;</span>)</span><br><span class="line">    keys = &#123;<span class="string">&#x27;point&#x27;</span>:Point, <span class="string">&#x27;points&#x27;</span>:Points, <span class="string">&#x27;line&#x27;</span>:Line, <span class="string">&#x27;lines&#x27;</span>:Lines,</span><br><span class="line">            <span class="string">&#x27;polygon&#x27;</span>:Polygon, <span class="string">&#x27;polygons&#x27;</span>:Polygons, <span class="string">&#x27;circle&#x27;</span>:Circle,</span><br><span class="line">            <span class="string">&#x27;circles&#x27;</span>:Circles, <span class="string">&#x27;rectangle&#x27;</span>:Rectangle, <span class="string">&#x27;rectangles&#x27;</span>:Rectangles,</span><br><span class="line">            <span class="string">&#x27;ellipse&#x27;</span>:Ellipse, <span class="string">&#x27;ellipses&#x27;</span>:Ellipses, <span class="string">&#x27;text&#x27;</span>:Text, <span class="string">&#x27;texts&#x27;</span>:Texts&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> mark[<span class="string">&#x27;type&#x27;</span>] <span class="keyword">in</span> keys: <span class="keyword">return</span> keys[mark[<span class="string">&#x27;type&#x27;</span>]](mark[<span class="string">&#x27;body&#x27;</span>], **style)</span><br><span class="line">    <span class="keyword">if</span> mark[<span class="string">&#x27;type&#x27;</span>]==<span class="string">&#x27;layer&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> Layer([mark2shp(i) <span class="keyword">for</span> i <span class="keyword">in</span> mark[<span class="string">&#x27;body&#x27;</span>]], **style)</span><br><span class="line">    <span class="keyword">if</span> mark[<span class="string">&#x27;type&#x27;</span>]==<span class="string">&#x27;layers&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> Layers(<span class="built_in">dict</span>(<span class="built_in">zip</span>(mark[<span class="string">&#x27;body&#x27;</span>].keys(),</span><br><span class="line">            [mark2shp(i) <span class="keyword">for</span> i <span class="keyword">in</span> mark[<span class="string">&#x27;body&#x27;</span>].values()])), **style)</span><br></pre></td></tr></table></figure>
<p>这里就引出了sciapp中的自定义的矢量类Shape这一数据结构。<br>Shape类是这类对象的基类，上述代码中的Point、Line、Rectangle类等都是该类的派生类。<br>Shape类会在下一篇文章中详细解释，见<a target="_blank" rel="noopener" href="https://qixinbo.info/2020/06/14/imagepy_20/">这里</a>。<br>总之，该函数就是将mark字典转换成了sciapp内置的Shape数据结构。</p>
<h1 id="全局draw-函数"><a href="#全局draw-函数" class="headerlink" title="全局draw()函数"></a>全局draw()函数</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">draw_dic = &#123;<span class="string">&#x27;points&#x27;</span>:plot, <span class="string">&#x27;point&#x27;</span>:plot, <span class="string">&#x27;line&#x27;</span>:plot,</span><br><span class="line"><span class="string">&#x27;polygon&#x27;</span>:plot, <span class="string">&#x27;lines&#x27;</span>:plot, <span class="string">&#x27;polygons&#x27;</span>:plot,</span><br><span class="line"><span class="string">&#x27;circle&#x27;</span>:draw_circle, <span class="string">&#x27;circles&#x27;</span>:draw_circle,</span><br><span class="line"><span class="string">&#x27;ellipse&#x27;</span>:draw_ellipse, <span class="string">&#x27;ellipses&#x27;</span>:draw_ellipse,</span><br><span class="line"><span class="string">&#x27;rectangle&#x27;</span>:draw_rectangle, <span class="string">&#x27;rectangles&#x27;</span>:draw_rectangle,</span><br><span class="line"><span class="string">&#x27;text&#x27;</span>:draw_text, <span class="string">&#x27;texts&#x27;</span>:draw_text&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw</span>(<span class="params">obj, dc, f, **key</span>):</span> </span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(obj.body)==<span class="number">0</span>: <span class="keyword">return</span></span><br><span class="line">	draw_dic[obj.dtype](obj, dc, f, **key)</span><br><span class="line"></span><br><span class="line">draw_dic[<span class="string">&#x27;layer&#x27;</span>] = draw_layer</span><br></pre></td></tr></table></figure>
<p>可以看出，draw()函数中先从传入的obj中提取它的dtype这个key，从而找到obj中对应的key-value，然后这个value作为draw_dic字典中的键，找到所绘制的类型，从而定位到具体的绘制函数。</p>
<p>对于layer这个type，可以把layer认为是多个图形的集合，会调用draw_layer这个函数，该函数里也会遍历该集合里的所有图形来再调用draw绘制：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw_layer</span>(<span class="params">pts, dc, f, **key</span>):</span></span><br><span class="line">         …</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> pts[<span class="string">&#x27;body&#x27;</span>]:draw(i, dc, f, **key)</span><br></pre></td></tr></table></figure>
<p>以绘制矩形为例，会调用draw_rectangle函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw_rectangle</span>(<span class="params">pts, dc, f, **key</span>):</span></span><br><span class="line">	pen, brush = dc.GetPen(), dc.GetBrush()</span><br><span class="line">	width, color = pen.GetWidth(), pen.GetColour()</span><br><span class="line">	fcolor, style = brush.GetColour(), brush.GetStyle()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> pts.color <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line">		pen.SetColour(pts.color)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> pts.fcolor <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">		brush.SetColour(pts.fcolor)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> pts.lw <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">		pen.SetWidth(pts.lw)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> pts.fill <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">		brush.SetStyle((<span class="number">106</span>,<span class="number">100</span>)[pts.fill])</span><br><span class="line"></span><br><span class="line">	dc.SetPen(pen)</span><br><span class="line">	dc.SetBrush(brush)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> pts.dtype == <span class="string">&#x27;rectangle&#x27;</span>:</span><br><span class="line">		x, y, w, h = pts.body</span><br><span class="line">		w, h = f(x+w, y+h)</span><br><span class="line">		x, y = f(x, y)</span><br><span class="line">		dc.DrawRectangle(x.<span class="built_in">round</span>(), (y).<span class="built_in">round</span>(), </span><br><span class="line">			(w-x).<span class="built_in">round</span>(), (h-y).<span class="built_in">round</span>())</span><br><span class="line">	<span class="keyword">if</span> pts.dtype == <span class="string">&#x27;rectangles&#x27;</span>:</span><br><span class="line">		x, y, w, h = pts.body.T</span><br><span class="line">		w, h = f(x+w, y+h)</span><br><span class="line">		x, y = f(x, y)</span><br><span class="line">		lst = np.vstack((x,y,w-x,h-y)).T</span><br><span class="line">		dc.DrawRectangleList(lst.<span class="built_in">round</span>())</span><br><span class="line"></span><br><span class="line">	pen.SetWidth(width)</span><br><span class="line">	pen.SetColour(color)</span><br><span class="line">	brush.SetColour(fcolor)</span><br><span class="line">	brush.SetStyle(style)</span><br><span class="line">	dc.SetPen(pen)</span><br><span class="line">	dc.SetBrush(brush)</span><br></pre></td></tr></table></figure>

<p>可以看出，在绘制矩形时最基本的步骤就是：<br>（1）将之前的设备上下文传入；<br>（2）提取特定的Rectangle这一Shape数据结构中的body信息，即绘制矩形的坐标点；<br>（3）调用最底层的设备上下文的DrawRectangle方法将其绘制出来。</p>
<h1 id="保存mark"><a href="#保存mark" class="headerlink" title="保存mark"></a>保存mark</h1><p>上面的mark都是在最原始的wxPython的frame上进行绘制，是为了展示mark的本质，实际应用时这些mark都是在Canvas上进行绘制。<br>（以下内容已合并在ImagePy的master分支中）<br>如果想在ImagePy中保存mark，可以参考我提交的一个pull request，在<a target="_blank" rel="noopener" href="https://github.com/Image-Py/imagepy/pull/96/commits/770342625d320659d2c5c406b1a78a809be086b0">这里</a>。<br>原理就是将当前的dc中的内容都save出来。</p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Donate
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechat_reward.png" alt="Xin-Bo Qi(亓欣波) WeChat Pay">
        <p>WeChat Pay</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ImagePy/" rel="tag"># ImagePy</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/03/24/ImagePy_18/" rel="prev" title="ImagePy解析：18 -- 参数对话框ParaDialog详解">
      <i class="fa fa-chevron-left"></i> ImagePy解析：18 -- 参数对话框ParaDialog详解
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/04/09/book-refactoring/" rel="next" title="《重构：数字化转型的逻辑》读书笔记">
      《重构：数字化转型的逻辑》读书笔记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#demo"><span class="nav-number">1.</span> <span class="nav-text">demo</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#mark%E9%85%8D%E7%BD%AE"><span class="nav-number">2.</span> <span class="nav-text">mark配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9D%90%E6%A0%87%E6%98%A0%E5%B0%84%E5%87%BD%E6%95%B0%E5%92%8C%E7%BC%A9%E6%94%BE%E5%9B%A0%E5%AD%90"><span class="nav-number">3.</span> <span class="nav-text">坐标映射函数和缩放因子</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#drawmark%E5%87%BD%E6%95%B0"><span class="nav-number">4.</span> <span class="nav-text">drawmark函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#mark2shp%E5%87%BD%E6%95%B0"><span class="nav-number">5.</span> <span class="nav-text">mark2shp函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%A8%E5%B1%80draw-%E5%87%BD%E6%95%B0"><span class="nav-number">6.</span> <span class="nav-text">全局draw()函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BF%9D%E5%AD%98mark"><span class="nav-number">7.</span> <span class="nav-text">保存mark</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xin-Bo Qi(亓欣波)"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Xin-Bo Qi(亓欣波)</p>
  <div class="site-description" itemprop="description">Be interesting!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">124</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/qixinbo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qixinbo" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:qixinbo@gmail.com" title="E-Mail → mailto:qixinbo@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/qixinbo" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;qixinbo" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fas fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.tsinghua.edu.cn/" title="https:&#x2F;&#x2F;www.tsinghua.edu.cn" rel="noopener" target="_blank">THU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.imr.cas.cn/" title="http:&#x2F;&#x2F;www.imr.cas.cn" rel="noopener" target="_blank">IMR</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.sdu.edu.cn/" title="http:&#x2F;&#x2F;www.sdu.edu.cn" rel="noopener" target="_blank">SDU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://liam0205.me/" title="http:&#x2F;&#x2F;liam0205.me&#x2F;" rel="noopener" target="_blank">黄晨成</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xin-Bo Qi(亓欣波)</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://qixinbo.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "http://qixinbo.github.io/2020/03/28/ImagePy_19/";
    this.page.identifier = "2020/03/28/ImagePy_19/";
    this.page.title = "ImagePy解析：19 -- Mark模式";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://qixinbo.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
