<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qixinbo.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="概览 上一篇介绍了如何安装和使用Cellpose，相当于将Cellpose当做一个开箱即用的软件。实际上Cellpose还是一个开源的代码库，开发者可以深入研究它的算法，并进行调用、修改和完善等。 本文尝试对Cellpose的运行机理做一个研究，包括它的标注数据的格式、神经网络的架构、神经网络的输入和输出等。  标注数据格式 假设有这么一张要分割的图像，大小为10像素乘以10像素（选择这么小的像素">
<meta property="og:type" content="article">
<meta property="og:title" content="胞状物体通用分割算法Cellpose解析：开发篇">
<meta property="og:url" content="http://qixinbo.github.io/2020/10/24/cellpose-2/index.html">
<meta property="og:site_name" content="数字旗手">
<meta property="og:description" content="概览 上一篇介绍了如何安装和使用Cellpose，相当于将Cellpose当做一个开箱即用的软件。实际上Cellpose还是一个开源的代码库，开发者可以深入研究它的算法，并进行调用、修改和完善等。 本文尝试对Cellpose的运行机理做一个研究，包括它的标注数据的格式、神经网络的架构、神经网络的输入和输出等。  标注数据格式 假设有这么一张要分割的图像，大小为10像素乘以10像素（选择这么小的像素">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/6218739/95300876-65cbfb80-08b2-11eb-9148-49b2c43ca197.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/6218739/95643902-f68a1d80-0ae4-11eb-9796-4c604bf21d58.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/6218739/95644657-a615be80-0aea-11eb-93db-75f5b4fca58a.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/6218739/95644110-b3c94500-0ae6-11eb-97be-5002b4131cca.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/6218739/95644130-f3902c80-0ae6-11eb-888b-1b9f76e53981.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/6218739/95644140-0f93ce00-0ae7-11eb-8532-2495ddc6e2f8.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/6218739/95644288-3d2d4700-0ae8-11eb-8439-1e8e84ebf83b.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/6218739/95644699-f9880c80-0aea-11eb-855d-449da0bf1ef9.png">
<meta property="article:published_time" content="2020-10-23T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-26T06:47:03.286Z">
<meta property="article:author" content="Xin-Bo Qi(亓欣波)">
<meta property="article:tag" content="cellpose">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/6218739/95300876-65cbfb80-08b2-11eb-9148-49b2c43ca197.png">

<link rel="canonical" href="http://qixinbo.github.io/2020/10/24/cellpose-2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>胞状物体通用分割算法Cellpose解析：开发篇 | 数字旗手</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="数字旗手" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">数字旗手</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">电气化、自动化、数字化、智能化、智慧化</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-scholar">

    <a href="/scholar/" rel="section"><i class="fa fa-chart-bar fa-fw"></i>scholar</a>

  </li>
        <li class="menu-item menu-item-sources">

    <a href="/sources/" rel="section"><i class="fa fa-rss fa-fw"></i>sources</a>

  </li>
        <li class="menu-item menu-item-gallery">

    <a href="/gallery/" rel="section"><i class="fa fa-file-image fa-fw"></i>gallery</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404.html" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2020/10/24/cellpose-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Digitize everything to realize Digitalization!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="数字旗手">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          胞状物体通用分割算法Cellpose解析：开发篇
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-24 00:00:00" itemprop="dateCreated datePublished" datetime="2020-10-24T00:00:00+08:00">2020-10-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-26 14:47:03" itemprop="dateModified" datetime="2021-03-26T14:47:03+08:00">2021-03-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/machine-learning/" itemprop="url" rel="index"><span itemprop="name">machine learning</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/10/24/cellpose-2/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/10/24/cellpose-2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h1><p>上一篇介绍了如何安装和使用Cellpose，相当于将Cellpose当做一个开箱即用的软件。实际上Cellpose还是一个开源的代码库，开发者可以深入研究它的算法，并进行调用、修改和完善等。<br>本文尝试对Cellpose的运行机理做一个研究，包括它的标注数据的格式、神经网络的架构、神经网络的输入和输出等。</p>
<h1 id="标注数据格式"><a href="#标注数据格式" class="headerlink" title="标注数据格式"></a>标注数据格式</h1><p>假设有这么一张要分割的图像，大小为10像素乘以10像素（选择这么小的像素矩阵以方便打印和查看数值），背底为黑色，图像中间有一个白色圆盘，即：<br><img src="https://user-images.githubusercontent.com/6218739/95300876-65cbfb80-08b2-11eb-9148-49b2c43ca197.png" alt="demo"><br>它的像素矩阵为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">array([[  <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>],</span><br><span class="line">       [  <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>],</span><br><span class="line">       [  <span class="number">0.</span>,   <span class="number">0.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>],</span><br><span class="line">       [  <span class="number">0.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>],</span><br><span class="line">       [  <span class="number">0.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>],</span><br><span class="line">       [  <span class="number">0.</span>,   <span class="number">0.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>],</span><br><span class="line">       [  <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>, <span class="number">255.</span>, <span class="number">255.</span>, <span class="number">255.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>],</span><br><span class="line">       [  <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>],</span><br><span class="line">       [  <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>],</span><br><span class="line">       [  <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>,   <span class="number">0.</span>]],</span><br><span class="line">      dtype=float32)</span><br></pre></td></tr></table></figure><br>对其进行手动标注，得到标注后的目标矩阵为：<br><img src="https://user-images.githubusercontent.com/6218739/95643902-f68a1d80-0ae4-11eb-9796-4c604bf21d58.png" alt="mask"><br>即，白色区域标为1，背景区域标为0（这里因为是手动标注，得到的标注不一定非常严格准确）。如果是标注了多个区域，则该mask矩阵里的标注值依次递增，即1、2、3等等。（注意这个地方一定要通过skimage.io.imread读取，不要用opencv，否则读取的是错误的值）</p>
<h1 id="向量场数据格式"><a href="#向量场数据格式" class="headerlink" title="向量场数据格式"></a>向量场数据格式</h1><p>Cellpose不是直接使用上面的标注数据作为神经网络的输入，而是要将这些标注转为向量场（这才是Cellpose最最重要的创新点，不是将物体的边缘轮廓直接作为目标拟合，而是将物体内部的场作为目标，非常巧妙），即热源在中心的热扩散场Flow Field，原理图如下：</p>
<p><img src="https://user-images.githubusercontent.com/6218739/95644657-a615be80-0aea-11eb-93db-75f5b4fca58a.png" alt="flow-field"></p>
<p>该数据转换可以使用如下API函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.append(<span class="string">&#x27;D:\\repos\\cellpose&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> cellpose <span class="keyword">import</span> dynamics, io, plot</span><br><span class="line">flow1 = dynamics.labels_to_flows([mask])</span><br></pre></td></tr></table></figure><br>根据该函数的API介绍：<br><img src="https://user-images.githubusercontent.com/6218739/95644110-b3c94500-0ae6-11eb-97be-5002b4131cca.png" alt="flow-api"><br>可知，返回的flow1中包含了向量场的Y分量和X分量：<br><img src="https://user-images.githubusercontent.com/6218739/95644130-f3902c80-0ae6-11eb-888b-1b9f76e53981.png" alt="flow-Y"><br><img src="https://user-images.githubusercontent.com/6218739/95644140-0f93ce00-0ae7-11eb-8532-2495ddc6e2f8.png" alt="flow-X"></p>
<p>从这些数值可以看出，如果要实现可视化，还需要使用以下函数进行转换：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flow2 = plot.dx_to_circ([flow1[<span class="number">0</span>][<span class="number">2</span>], flow1[<span class="number">0</span>][<span class="number">3</span>]])</span><br></pre></td></tr></table></figure><br>得到的就是RGB图像，即：<br><img src="https://user-images.githubusercontent.com/6218739/95644288-3d2d4700-0ae8-11eb-8439-1e8e84ebf83b.png" alt="flow-visual"></p>
<p>因为上面的样例是一张非常小的图，可以通过另外一张大的样例图来更直观地看一下效果：<br><img src="https://user-images.githubusercontent.com/6218739/95644699-f9880c80-0aea-11eb-855d-449da0bf1ef9.png" alt="contrast"></p>
<h2 id="向量场计算原理"><a href="#向量场计算原理" class="headerlink" title="向量场计算原理"></a>向量场计算原理</h2><p>上面概览了向量场的计算和可视化方式。这一节具体解析它的计算原理。<br>仍然以最开始的10乘10的小图为例，其mask为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]]</span><br></pre></td></tr></table></figure><br>（1）计算向量场（cellpose中称为流场flow field），使用的是masks_to_flows这个函数：<br>首先寻找该mask中的物体：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slices = scipy.ndimage.find_objects(masks)</span><br></pre></td></tr></table></figure><br>返回的是物体所在的行列切片：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slices =  [(<span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">7</span>, <span class="literal">None</span>), <span class="built_in">slice</span>(<span class="number">1</span>, <span class="number">8</span>, <span class="literal">None</span>))]</span><br></pre></td></tr></table></figure><br>然后计算这些物体的中值直径大小：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dia = utils.diameters(masks)[<span class="number">0</span>]</span><br></pre></td></tr></table></figure><br>这里可以再插一句这个直径是怎样计算的：首先使用np.unique获得mask中特有元素的个数，元素个数就代表了每个物体的面积（unique函数去除其中重复的元素，并按元素由小到大返回一个新的无元素重复的元组或者列表），然后使用np.median计算这些面积的中值面积（如果有奇数个面积，则挑选中间的那个面积作为中值面积；如果有偶数个面积，则中间两个面积取平均作为中值面积），然后再求一个同样面积大小的圆的直径，即为中值直径。<br>接着计算在具体某个物体内它的质心的索引标识：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i,si <span class="keyword">in</span> <span class="built_in">enumerate</span>(slices):</span><br><span class="line">    <span class="keyword">if</span> si <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        sr,sc = si</span><br><span class="line">        ly, lx = sr.stop - sr.start + <span class="number">1</span>, sc.stop - sc.start + <span class="number">1</span></span><br><span class="line">        y,x = np.nonzero(masks[sr, sc] == (i+<span class="number">1</span>))</span><br><span class="line">        y = y.astype(np.int32) + <span class="number">1</span></span><br><span class="line">        x = x.astype(np.int32) + <span class="number">1</span></span><br><span class="line">        ymed = np.median(y)</span><br><span class="line">        xmed = np.median(x)</span><br><span class="line">        imin = np.argmin((x-xmed)**<span class="number">2</span> + (y-ymed)**<span class="number">2</span>)</span><br><span class="line">        xmed = x[imin]</span><br><span class="line">        ymed = y[imin]</span><br></pre></td></tr></table></figure><br>注意，这里的索引标识是以该物体内部自成一个坐标系，用到的关键一步就是代码中的nonzero那一行。然后同样使用np.median获取中位数，但因为不能确定该物体内是奇数还是偶数个像素（如果是偶数个像素，那么索引就是小数），所以先计算出中位数，再找出原来的索引序列中与该中位数最近的像素（即argmin那一行，通过距离判断），从而获得了真正的质心的索引标识。（这里还有一个伏笔：x和y在原有基础上又各加1，是为了后面计算扩散场时不从边界上开始计算）</p>
<p>接下来计算每个物体内的像素离其质心的距离，这种距离不是绝对距离，而是用之前的中位直径进行了某种归一化：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s2 = (<span class="number">.15</span> * dia)**<span class="number">2</span></span><br><span class="line">        d2 = (x-xmed)**<span class="number">2</span> + (y-ymed)**<span class="number">2</span></span><br><span class="line">        mu_c[sr.start+y-<span class="number">1</span>, sc.start+x-<span class="number">1</span>] = np.exp(-d2/s2)</span><br></pre></td></tr></table></figure><br>这里的mu_c就是与原mask同样大小的距离变换图，因此在计算归一化距离时，虽然是相对于物体自己的质心的距离，但也通过sr.start的索引转换成了全局索引，即mu_c就是一幅以物体各自质心为中心的距离的一个个孤岛。</p>
<p>接下来计算热扩散场：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">            T = np.zeros((ly+<span class="number">2</span>)*(lx+<span class="number">2</span>), np.float64)</span><br><span class="line">            T = _extend_centers(T, y, x, ymed, xmed, np.int32(lx), niter)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_extend_centers</span>(<span class="params">T,y,x,ymed,xmed,Lx, niter</span>):</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(niter):</span><br><span class="line">        T[ymed*Lx + xmed] += <span class="number">1</span></span><br><span class="line">        T[y*Lx + x] = <span class="number">1</span>/<span class="number">9.</span> * (T[y*Lx + x] + T[(y-<span class="number">1</span>)*Lx + x]   + T[(y+<span class="number">1</span>)*Lx + x] +</span><br><span class="line">                                            T[y*Lx + x-<span class="number">1</span>]     + T[y*Lx + x+<span class="number">1</span>] +</span><br><span class="line">                                            T[(y-<span class="number">1</span>)*Lx + x-<span class="number">1</span>] + T[(y-<span class="number">1</span>)*Lx + x+<span class="number">1</span>] +</span><br><span class="line">                                            T[(y+<span class="number">1</span>)*Lx + x-<span class="number">1</span>] + T[(y+<span class="number">1</span>)*Lx + x+<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> T</span><br></pre></td></tr></table></figure><br>T是一个ly+2乘以lx+2大小的一维数组，即它将原来的二维的物体区域给拉直成一个一维长条进行计算。<br>这里模拟的动作就是在质心处每次循环都投入一个数值为1的新的热源，然后计算整个物体内在这一热源下的热扩散，用的是八邻域计算。温度场在每次循环中都累加。<br>迭代循环结束后，还要叠加一个log型的温度场，这一步没有弄明白什么意思：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T[(y+<span class="number">1</span>)*lx + x+<span class="number">1</span>] = np.log(<span class="number">1.</span>+T[(y+<span class="number">1</span>)*lx + x+<span class="number">1</span>])</span><br></pre></td></tr></table></figure><br>接下来计算物体内的温度梯度场（即某点的x方向梯度就是左右两个邻居的温度的差，y方向梯度就是上下两个邻居的温度的差）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dy = T[(y+<span class="number">1</span>)*lx + x] - T[(y-<span class="number">1</span>)*lx + x]</span><br><span class="line">dx = T[y*lx + x+<span class="number">1</span>] - T[y*lx + x-<span class="number">1</span>]</span><br></pre></td></tr></table></figure><br>并将其存入场变量mu中：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mu = np.zeros((<span class="number">2</span>, Ly, Lx), np.float64)</span><br><span class="line">mu[:, sr.start+y-<span class="number">1</span>, sc.start+x-<span class="number">1</span>] = np.stack((dy,dx))</span><br></pre></td></tr></table></figure><br>注意mu的shape，dy和dx是分别存储的，分别存入mu的第0维和第1维。<br>最后将dx和dy进行标准化：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mu /= (<span class="number">1e-20</span> + (mu**<span class="number">2</span>).<span class="built_in">sum</span>(axis=<span class="number">0</span>)**<span class="number">0.5</span>)</span><br></pre></td></tr></table></figure><br>即：先求(dy)^2和(dx)^2，然后通过sum求((dy)^2+(dx)^2)，然后对其开平方，最后将原值除以该值，得到：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dy/[((dy)^<span class="number">2</span>+(dx)^<span class="number">2</span>)**<span class="number">0.5</span>]</span><br><span class="line">和</span><br><span class="line">dx/[((dy)^<span class="number">2</span>+(dx)^<span class="number">2</span>)**<span class="number">0.5</span>]</span><br></pre></td></tr></table></figure></p>
<p>（2）将流场与物体概率结合起来：<br>上面计算了流场后，在labels_to_flows中将该流场与是否是物体的概率结合起来：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">veci = [masks_to_flows(labels[n][<span class="number">0</span>])[<span class="number">0</span>] <span class="keyword">for</span> n <span class="keyword">in</span> trange(nimg)]</span><br><span class="line">flows = [np.concatenate((labels[n][[<span class="number">0</span>]], labels[n][[<span class="number">0</span>]]&gt;<span class="number">0.5</span>, veci[n]), axis=<span class="number">0</span>).astype(np.float32)</span><br><span class="line">                    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(nimg)]</span><br></pre></td></tr></table></figure><br>即这里的flows是四个量的结合：flows的形状是(4, Ly, Lx)，其中flows[k][0] 是标签labels[k]，flows[k][1]判断是否是细胞，所以值也就只有两个，0和1，其中在计算时判断是否是物体的阈值设为了0.5，flows[k][2]是Y方向的流场，flows[k][3]是X方向的流场。</p>
<h2 id="从流场复原掩膜"><a href="#从流场复原掩膜" class="headerlink" title="从流场复原掩膜"></a>从流场复原掩膜</h2><p>上面解析了如何通过掩膜计算向量场（即流场）。流场是作为该算法中的输出，因此，算法推理后得到的输出也是流场形式，那么进一步地，需要根据流场反推出掩膜，以标识物体的形貌。<br>这里的分析要用到上面计算出来的流场flows。<br>为了更具通用性，在这一节中使用的掩膜中有两个物体，从而探究更一般的掩膜复原过程。<br>原始掩膜的矩阵为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]]</span><br></pre></td></tr></table></figure><br>下面的步骤默认是不知道这个原始掩膜的，已知条件只有它的流场形式，通过上节的计算方法，得到该流场为（这里只显示第3和第4个元素，即X和Y方向的流场）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[[[ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.7728456</span>   <span class="number">0.7343627</span>   <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>         -<span class="number">0.07701479</span>  <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>         -<span class="number">0.8023549</span>  -<span class="number">0.7343627</span>   <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.6282049</span>   <span class="number">0.9970669</span>   <span class="number">0.72136474</span>  <span class="number">0.26260668</span>]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>         -<span class="number">0.67413443</span> -<span class="number">0.99975467</span> -<span class="number">0.80442435</span> -<span class="number">0.29906148</span>]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]]</span><br><span class="line"></span><br><span class="line"> [[ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.6345941</span>  -<span class="number">0.67875725</span>  <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">1.</span>         -<span class="number">0.99702996</span>  <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.59684724</span> -<span class="number">0.67875725</span>  <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.778048</span>    <span class="number">0.07653494</span> -<span class="number">0.69255537</span> -<span class="number">0.96490294</span>]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.73860866</span> -<span class="number">0.0221485</span>  -<span class="number">0.5940551</span>  -<span class="number">0.9542338</span> ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]</span><br><span class="line">  [ <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span></span><br><span class="line">    <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>          <span class="number">0.</span>        ]]]</span><br></pre></td></tr></table></figure>
<p>接下来看怎样通过流场复原掩膜的。</p>
<p>（1）动力学计算<br>这一步在follow_flows函数中进行。该函数用到的参数只有一个与dP相关的数（还有一个迭代步数，有默认值）。<br>dP是流场flows的一部分，包含Y方向的流场和X方向的流场，可由下面的方式获得：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dP = flows[<span class="number">0</span>][<span class="number">2</span>:]</span><br></pre></td></tr></table></figure><br>follow_flows函数所传入的实际参数在Cellpose中为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-<span class="number">1</span> * dP * (cellprob &gt; cellprob_threshold) / <span class="number">5.</span></span><br></pre></td></tr></table></figure><br>这其中有两个系数非常重要，一个是-1，另一个是5。<br>它们两者的作用分别是：-1是为了使符号反转，即原来正向热流，现在要使它往回流，即原流场是热源中的热往四周散，现在要复原了，所以要把热流反向，让热流都汇聚到热源上；5是为了将热流梯度值变小，这样能缓缓地流，保证热流流向临近点，防止一下冲到别的点上。<br>将这个表达式记为新dP，其值变为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[[[-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.15456912</span> -<span class="number">0.14687255</span> -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>          <span class="number">0.01540296</span> -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>          <span class="number">0.16047098</span>  <span class="number">0.14687255</span> -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.12564097</span> -<span class="number">0.19941339</span> -<span class="number">0.14427295</span> -<span class="number">0.05252134</span>]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>          <span class="number">0.13482688</span>  <span class="number">0.19995093</span>  <span class="number">0.16088487</span>  <span class="number">0.0598123</span> ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]]</span><br><span class="line"></span><br><span class="line"> [[-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.12691882</span>  <span class="number">0.13575146</span> -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.2</span>         <span class="number">0.199406</span>   -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.11936945</span>  <span class="number">0.13575146</span> -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.1556096</span>  -<span class="number">0.01530699</span>  <span class="number">0.13851108</span>  <span class="number">0.19298059</span>]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.14772174</span>  <span class="number">0.0044297</span>   <span class="number">0.11881103</span>  <span class="number">0.19084677</span>]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]</span><br><span class="line">  [-<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span></span><br><span class="line">   -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>         -<span class="number">0.</span>        ]]]</span><br></pre></td></tr></table></figure><br>首先根据dP的尺寸来生成动力学计算所在的网格（Cellpose能进行三维分割，不过这里只分析二维情形，即生成二维网格），即：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shape = np.array(dP.shape[<span class="number">1</span>:]).astype(np.int32)</span><br><span class="line">p = np.meshgrid(np.arange(shape[<span class="number">0</span>]), np.arange(shape[<span class="number">1</span>]), indexing=<span class="string">&#x27;ij&#x27;</span>)</span><br><span class="line">p = np.array(p).astype(np.float32)</span><br></pre></td></tr></table></figure><br>因为原图是一个10乘10的图像，那么这里的网格节点就是：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[[[<span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span>]</span><br><span class="line">  [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line">  [<span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span>]</span><br><span class="line">  [<span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span>]</span><br><span class="line">  [<span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span>]</span><br><span class="line">  [<span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span>]</span><br><span class="line">  [<span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span>]</span><br><span class="line">  [<span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span>]</span><br><span class="line">  [<span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span>]</span><br><span class="line">  [<span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span>]]</span><br><span class="line"></span><br><span class="line"> [[<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]]]</span><br></pre></td></tr></table></figure><br>然后只计算流场梯度不为0的节点以加快计算速度，因此先得到这些不为0节点的索引：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inds = np.array(np.nonzero(np.<span class="built_in">abs</span>(dP[<span class="number">0</span>])&gt;<span class="number">1e-3</span>)).astype(np.int32).T</span><br></pre></td></tr></table></figure><br>这些索引在该例中为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span> <span class="number">2</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span>]</span><br><span class="line"> [<span class="number">1</span> <span class="number">3</span>]</span><br><span class="line"> [<span class="number">2</span> <span class="number">2</span>]</span><br><span class="line"> [<span class="number">2</span> <span class="number">3</span>]</span><br><span class="line"> [<span class="number">3</span> <span class="number">6</span>]</span><br><span class="line"> [<span class="number">3</span> <span class="number">7</span>]</span><br><span class="line"> [<span class="number">3</span> <span class="number">8</span>]</span><br><span class="line"> [<span class="number">3</span> <span class="number">9</span>]</span><br><span class="line"> [<span class="number">4</span> <span class="number">6</span>]</span><br><span class="line"> [<span class="number">4</span> <span class="number">7</span>]</span><br><span class="line"> [<span class="number">4</span> <span class="number">8</span>]</span><br><span class="line"> [<span class="number">4</span> <span class="number">9</span>]]</span><br></pre></td></tr></table></figure><br>然后执行以下函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p = steps2D(p, dP, inds, niter)</span><br></pre></td></tr></table></figure><br>具体它干的工作就是不断地在格点上累加热流。<br>结果就是：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[[[<span class="number">0.</span>        <span class="number">0.</span>        <span class="number">1.0098284</span> <span class="number">1.1413077</span> <span class="number">0.</span>        <span class="number">0.</span>        <span class="number">0.</span></span><br><span class="line">   <span class="number">0.</span>        <span class="number">0.</span>        <span class="number">0.</span>       ]</span><br><span class="line">  [<span class="number">1.</span>        <span class="number">1.</span>        <span class="number">1.</span>        <span class="number">1.0362048</span> <span class="number">1.</span>        <span class="number">1.</span>        <span class="number">1.</span></span><br><span class="line">   <span class="number">1.</span>        <span class="number">1.</span>        <span class="number">1.</span>       ]</span><br><span class="line">  [<span class="number">2.</span>        <span class="number">2.</span>        <span class="number">1.1182916</span> <span class="number">1.1164871</span> <span class="number">2.</span>        <span class="number">2.</span>        <span class="number">2.</span></span><br><span class="line">   <span class="number">2.</span>        <span class="number">2.</span>        <span class="number">2.</span>       ]</span><br><span class="line">  [<span class="number">3.</span>        <span class="number">3.</span>        <span class="number">3.</span>        <span class="number">3.</span>        <span class="number">3.</span>        <span class="number">3.</span>        <span class="number">4.105441</span></span><br><span class="line">   <span class="number">3.8231199</span> <span class="number">4.041441</span>  <span class="number">4.0182114</span>]</span><br><span class="line">  [<span class="number">4.</span>        <span class="number">4.</span>        <span class="number">4.</span>        <span class="number">4.</span>        <span class="number">4.</span>        <span class="number">4.</span>        <span class="number">3.8856084</span></span><br><span class="line">   <span class="number">3.9896855</span> <span class="number">3.9375546</span> <span class="number">3.935263</span> ]</span><br><span class="line">  [<span class="number">5.</span>        <span class="number">5.</span>        <span class="number">5.</span>        <span class="number">5.</span>        <span class="number">5.</span>        <span class="number">5.</span>        <span class="number">5.</span></span><br><span class="line">   <span class="number">5.</span>        <span class="number">5.</span>        <span class="number">5.</span>       ]</span><br><span class="line">  [<span class="number">6.</span>        <span class="number">6.</span>        <span class="number">6.</span>        <span class="number">6.</span>        <span class="number">6.</span>        <span class="number">6.</span>        <span class="number">6.</span></span><br><span class="line">   <span class="number">6.</span>        <span class="number">6.</span>        <span class="number">6.</span>       ]</span><br><span class="line">  [<span class="number">7.</span>        <span class="number">7.</span>        <span class="number">7.</span>        <span class="number">7.</span>        <span class="number">7.</span>        <span class="number">7.</span>        <span class="number">7.</span></span><br><span class="line">   <span class="number">7.</span>        <span class="number">7.</span>        <span class="number">7.</span>       ]</span><br><span class="line">  [<span class="number">8.</span>        <span class="number">8.</span>        <span class="number">8.</span>        <span class="number">8.</span>        <span class="number">8.</span>        <span class="number">8.</span>        <span class="number">8.</span></span><br><span class="line">   <span class="number">8.</span>        <span class="number">8.</span>        <span class="number">8.</span>       ]</span><br><span class="line">  [<span class="number">9.</span>        <span class="number">9.</span>        <span class="number">9.</span>        <span class="number">9.</span>        <span class="number">9.</span>        <span class="number">9.</span>        <span class="number">9.</span></span><br><span class="line">   <span class="number">9.</span>        <span class="number">9.</span>        <span class="number">9.</span>       ]]</span><br><span class="line"></span><br><span class="line"> [[<span class="number">0.</span>        <span class="number">1.</span>        <span class="number">2.8871436</span> <span class="number">3.0260515</span> <span class="number">4.</span>        <span class="number">5.</span>        <span class="number">6.</span></span><br><span class="line">   <span class="number">7.</span>        <span class="number">8.</span>        <span class="number">9.</span>       ]</span><br><span class="line">  [<span class="number">0.</span>        <span class="number">1.</span>        <span class="number">2.</span>        <span class="number">3.1274133</span> <span class="number">4.</span>        <span class="number">5.</span>        <span class="number">6.</span></span><br><span class="line">   <span class="number">7.</span>        <span class="number">8.</span>        <span class="number">9.</span>       ]</span><br><span class="line">  [<span class="number">0.</span>        <span class="number">1.</span>        <span class="number">2.811595</span>  <span class="number">3.157068</span>  <span class="number">4.</span>        <span class="number">5.</span>        <span class="number">6.</span></span><br><span class="line">   <span class="number">7.</span>        <span class="number">8.</span>        <span class="number">9.</span>       ]</span><br><span class="line">  [<span class="number">0.</span>        <span class="number">1.</span>        <span class="number">2.</span>        <span class="number">3.</span>        <span class="number">4.</span>        <span class="number">5.</span>        <span class="number">7.9200172</span></span><br><span class="line">   <span class="number">7.898424</span>  <span class="number">7.9439383</span> <span class="number">7.9862995</span>]</span><br><span class="line">  [<span class="number">0.</span>        <span class="number">1.</span>        <span class="number">2.</span>        <span class="number">3.</span>        <span class="number">4.</span>        <span class="number">5.</span>        <span class="number">7.990998</span></span><br><span class="line">   <span class="number">7.884873</span>  <span class="number">7.924165</span>  <span class="number">7.893717</span> ]</span><br><span class="line">  [<span class="number">0.</span>        <span class="number">1.</span>        <span class="number">2.</span>        <span class="number">3.</span>        <span class="number">4.</span>        <span class="number">5.</span>        <span class="number">6.</span></span><br><span class="line">   <span class="number">7.</span>        <span class="number">8.</span>        <span class="number">9.</span>       ]</span><br><span class="line">  [<span class="number">0.</span>        <span class="number">1.</span>        <span class="number">2.</span>        <span class="number">3.</span>        <span class="number">4.</span>        <span class="number">5.</span>        <span class="number">6.</span></span><br><span class="line">   <span class="number">7.</span>        <span class="number">8.</span>        <span class="number">9.</span>       ]</span><br><span class="line">  [<span class="number">0.</span>        <span class="number">1.</span>        <span class="number">2.</span>        <span class="number">3.</span>        <span class="number">4.</span>        <span class="number">5.</span>        <span class="number">6.</span></span><br><span class="line">   <span class="number">7.</span>        <span class="number">8.</span>        <span class="number">9.</span>       ]</span><br><span class="line">  [<span class="number">0.</span>        <span class="number">1.</span>        <span class="number">2.</span>        <span class="number">3.</span>        <span class="number">4.</span>        <span class="number">5.</span>        <span class="number">6.</span></span><br><span class="line">   <span class="number">7.</span>        <span class="number">8.</span>        <span class="number">9.</span>       ]</span><br><span class="line">  [<span class="number">0.</span>        <span class="number">1.</span>        <span class="number">2.</span>        <span class="number">3.</span>        <span class="number">4.</span>        <span class="number">5.</span>        <span class="number">6.</span></span><br><span class="line">   <span class="number">7.</span>        <span class="number">8.</span>        <span class="number">9.</span>       ]]]</span><br></pre></td></tr></table></figure><br>p的值域也是有规则的，即大于0且小于原图尺寸，因为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p[<span class="number">0</span>,y,x] = <span class="built_in">min</span>(shape[<span class="number">0</span>]-<span class="number">1</span>, <span class="built_in">max</span>(<span class="number">0</span>, p[<span class="number">0</span>,y,x] - dP[<span class="number">0</span>,p0,p1]))</span><br></pre></td></tr></table></figure><br>单看p中具体数值，没有意义，应该看p现在的值与之前的网格格点标识之间的差值，这才是有意义的，表明在该点上的热流累加（或散失），由此来标识经过动力学计算后热源所在位置。<br>另外剧透一下，从下面的分析可以看出，目前p中的值经过整型化后，与原先的格点索引不同的位置上的数值正是热源所在位置，比如第一排第三个元素的原先索引是[0, 2]，现在变成了[1, 2]，那么这个[1, 2]正是热源所在位置。</p>
<p>（2）复原掩膜：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(dims):</span><br><span class="line">    pflows.append(p[i].flatten().astype(<span class="string">&#x27;int32&#x27;</span>))</span><br><span class="line">    edges.append(np.arange(-<span class="number">.5</span>-rpad, shape0[i]+<span class="number">.5</span>+rpad, <span class="number">1</span>))</span><br></pre></td></tr></table></figure><br>pflows是对浮点数的p展平后进行整型化，即：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[array([<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>,</span><br><span class="line">       <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>,</span><br><span class="line">       <span class="number">4</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>,</span><br><span class="line">       <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>,</span><br><span class="line">       <span class="number">8</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>]), </span><br><span class="line"> array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>,</span><br><span class="line">       <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>,</span><br><span class="line">       <span class="number">4</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>,</span><br><span class="line">       <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>,</span><br><span class="line">       <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>])]</span><br></pre></td></tr></table></figure><br>而edges是直方图中的各个区间范围，其中的参数rpad控制了直方图的边缘填充大小，比如rpad如果为0，那么直方图的大小就是与原图大小相等，即周围没有填充0，而如果设置rpad为非零，比如设rpad为1，那么：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[array([-<span class="number">1.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.5</span>,  <span class="number">2.5</span>,  <span class="number">3.5</span>,  <span class="number">4.5</span>,  <span class="number">5.5</span>,  <span class="number">6.5</span>,  <span class="number">7.5</span>,  <span class="number">8.5</span>,</span><br><span class="line">        <span class="number">9.5</span>, <span class="number">10.5</span>]), </span><br><span class="line"> array([-<span class="number">1.5</span>, -<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.5</span>,  <span class="number">2.5</span>,  <span class="number">3.5</span>,  <span class="number">4.5</span>,  <span class="number">5.5</span>,  <span class="number">6.5</span>,  <span class="number">7.5</span>,  <span class="number">8.5</span>,</span><br><span class="line">        <span class="number">9.5</span>, <span class="number">10.5</span>])]</span><br></pre></td></tr></table></figure><br>而因为pflows中的值都是大于0且小于原图尺寸的（step2D中的操作），即-1.5和-0.5之间以及9.5和10.5之间是没有元素的，就相等于在直方图周围填充了一圈0的边界，如果rpad为更多，比如默认为20，那么填充的边界宽度则为20。<br>这里将rpad设为0，即不要填充边界，那么：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">edges = [array([-<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.5</span>,  <span class="number">2.5</span>,  <span class="number">3.5</span>,  <span class="number">4.5</span>,  <span class="number">5.5</span>,  <span class="number">6.5</span>,  <span class="number">7.5</span>,  <span class="number">8.5</span>,  <span class="number">9.5</span>]), </span><br><span class="line">         array([-<span class="number">0.5</span>,  <span class="number">0.5</span>,  <span class="number">1.5</span>,  <span class="number">2.5</span>,  <span class="number">3.5</span>,  <span class="number">4.5</span>,  <span class="number">5.5</span>,  <span class="number">6.5</span>,  <span class="number">7.5</span>,  <span class="number">8.5</span>,  <span class="number">9.5</span>])]</span><br></pre></td></tr></table></figure><br>这样以0.5为后缀，是为了方便取得下面的整型，比如0.5到1.5之间就是取的1。<br>然后就是至关重要的直方图计算环节：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">h,_ = np.histogramdd(<span class="built_in">tuple</span>(pflows), bins=edges)</span><br></pre></td></tr></table></figure><br>这一步就是根据edges区间统计这些区间内相应流场强度，先从结果来向前推比较好理解，这里h.T（注意是将原来的h进行了以下转置，方便描述）的值为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">0.</span> <span class="number">3.</span> <span class="number">0.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">0.</span> <span class="number">3.</span> <span class="number">0.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">5.</span> <span class="number">3.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]]</span><br></pre></td></tr></table></figure><br>第一个元素就代表当y方向的pflows为-0.5到0.5之间（就是0）时x方向的pflows为-0.5到0.5之间（就是0）的数的个数，那么看pflows就是(0, 0)这个元素；第二个元素就代表y方向的pflows为0时x方向的pflows为1的数的个数，发现就是(1, 0)这一对。比如第三行的3代表当y方向的pflows为1.5到2.5之间（就是2）时，x方向的pflows为0.5到1.5之间（就是1）的数的个数是3个，分别在第3个、第13个、第23个元素对。</p>
<p>这部分的理解可以根据下面更通俗的一个例子来辅助。<br>np.histgram就是在一维上看数据落在bins上的个数。<br>np.histgram2d就是在二维上看数据落在bins上的个数，以如下例子为例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">xedges = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br><span class="line">yedges = [<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>]</span><br><span class="line"></span><br><span class="line">x = np.random.normal(<span class="number">2</span>, <span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">y = np.arange(<span class="number">10</span>)</span><br><span class="line">H, xedges, yedges = np.histogram2d(x, y, bins=(xedges, yedges))</span><br></pre></td></tr></table></figure><br>上述代码中xedges定义了x维度上的值所划分的范围（即统计0到1之间（注意不含1）的值的个数、1到3之间（注意不含3）的值的个数、3到5之间（注意这里包含5）的值的个数），yedges定义了y维度上的值所划分的范围，x是一个含有10个以2为期望、以1为标准差的正态分布的数值：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">array([<span class="number">1.4965097</span> , <span class="number">0.46480962</span>, <span class="number">1.65365048</span>, <span class="number">1.56658642</span>, <span class="number">2.05414053</span>,</span><br><span class="line">       <span class="number">3.209907</span>  , <span class="number">2.87861765</span>, <span class="number">0.17336843</span>, <span class="number">2.97341494</span>, <span class="number">2.12467305</span>])</span><br></pre></td></tr></table></figure><br>y就是一个从0到9依次递增的10个数值：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>])</span><br></pre></td></tr></table></figure><br>而得到的H为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="number">1.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>],</span><br><span class="line">       [<span class="number">1.</span>, <span class="number">1.</span>, <span class="number">1.</span>, <span class="number">2.</span>],</span><br><span class="line">       [<span class="number">0.</span>, <span class="number">0.</span>, <span class="number">0.</span>, <span class="number">1.</span>]])</span><br></pre></td></tr></table></figure><br>将其转置一下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>H.T</span><br><span class="line">array([[<span class="number">1.</span>, <span class="number">1.</span>, <span class="number">0.</span>],</span><br><span class="line">       [<span class="number">0.</span>, <span class="number">1.</span>, <span class="number">0.</span>],</span><br><span class="line">       [<span class="number">0.</span>, <span class="number">1.</span>, <span class="number">0.</span>],</span><br><span class="line">       [<span class="number">0.</span>, <span class="number">2.</span>, <span class="number">1.</span>]])</span><br></pre></td></tr></table></figure><br>H.T是一个4乘3的矩阵，第一个元素代表x维度上0到1之间（注意不含1）且y维度上0到2之间（注意不含2）的数的个数，即(0.46480962, 1)这个数，第二个元素代表x维度上1到3之间（注意不含3）且y维度上0到2之间（注意不含2）的数的个数，即(1.4965097, 0)这个数，第三个元素代表x维度上3到5之间（注意!!这里包含5）且y维度上0到2之间（注意不含2）的数的个数，没有这样的数，所以为0。看一下H.T中倒数第二个元素，它代表x维度上1到3之间（注意不含3）且y维度上4到6之间（注意!!包含6）的数的个数，即(2.05414053, 4)和(2.87861765, 6)这两个数。因此，在edges范围两端的值，都是包含在范围内，而在内部的值，左边值包含，而右边值不包含。<br>对于bins这个参数，上面是指定的范围序列，也可以指定一个整数值，表示分成多少份。</p>
<p>以上是关于那个直方图矩阵的理解，对于其实际物理意义，可以想象成这样：如果pflows还是保持原来的格点索引，即：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[[[<span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">0.</span>]</span><br><span class="line">  [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line">  [<span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span> <span class="number">2.</span>]</span><br><span class="line">  [<span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span>]</span><br><span class="line">  [<span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span> <span class="number">4.</span>]</span><br><span class="line">  [<span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span>]</span><br><span class="line">  [<span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span> <span class="number">6.</span>]</span><br><span class="line">  [<span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span> <span class="number">7.</span>]</span><br><span class="line">  [<span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span> <span class="number">8.</span>]</span><br><span class="line">  [<span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span> <span class="number">9.</span>]]</span><br><span class="line"></span><br><span class="line"> [[<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]</span><br><span class="line">  [<span class="number">0.</span> <span class="number">1.</span> <span class="number">2.</span> <span class="number">3.</span> <span class="number">4.</span> <span class="number">5.</span> <span class="number">6.</span> <span class="number">7.</span> <span class="number">8.</span> <span class="number">9.</span>]]]</span><br></pre></td></tr></table></figure><br>那么上面的统计矩阵上的元素应该都为1，可以想象成这个棋盘上每个格点上都有一粒米，那么再看pflows经过了动力学计算后的形式：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[array([<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>,</span><br><span class="line">       <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>,</span><br><span class="line">       <span class="number">4</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>,</span><br><span class="line">       <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>,</span><br><span class="line">       <span class="number">8</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>]),</span><br><span class="line"> array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>,</span><br><span class="line">       <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>,</span><br><span class="line">       <span class="number">4</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>,</span><br><span class="line">       <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>,</span><br><span class="line">       <span class="number">8</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>])]</span><br></pre></td></tr></table></figure><br>以及再贴一遍直方图统计结果：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">0.</span> <span class="number">3.</span> <span class="number">0.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">0.</span> <span class="number">3.</span> <span class="number">0.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">5.</span> <span class="number">3.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">0.</span> <span class="number">0.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]]</span><br></pre></td></tr></table></figure><br>看pflows，比如第一行，x维度上两个0变成了两个1，表示x维度上原来0号标识的位置上的米移到了1号标识上，y维度保持不变，对应于直方图统计就是将两粒米右移一格，x维度上有两个2也变成了1，意味着这两个x维度上2号标识上的米左移到了1号标识上。同理，x、y坐标为(3, 6)的点现在变成了(4, 7)，也是把这个米从这两个坐标点上进行了移动。</p>
<p>上面是以相对位置角度来理解，另一个角度来看，从绝对位置来看，pflows中的要移动米粒的位置上面的值正是热源所在坐标位置：还是看x维度上的那两个变为1标识的0标识，它原来的标识是[0, 2]，现在变成了[1, 2]，这[1, 2]正是热源位置（下面的求解可知道）。</p>
<p>关于直方图统计这一部分理解结束！</p>
<p>下面接着看。<br>得到直方图统计结果后，对其进行一个核为5的最大化池化（池化的目的是为了滤波，去掉噪声）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(dims):</span><br><span class="line">    hmax = maximum_filter1d(hmax, <span class="number">5</span>, axis=i)</span><br></pre></td></tr></table></figure><br>结果为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span>]</span><br><span class="line"> [<span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span>]</span><br><span class="line"> [<span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span> <span class="number">5.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span> <span class="number">3.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]</span><br><span class="line"> [<span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span> <span class="number">1.</span>]]</span><br></pre></td></tr></table></figure><br>然后找出原直方图统计中局部最大值的位置：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">seeds = np.nonzero(np.logical_and(h-hmax&gt;-<span class="number">1e-6</span>, h&gt;<span class="number">2</span>))</span><br></pre></td></tr></table></figure><br>具体判断标准有两个：一是看原值与经过池化后的值的差值，如果差值为0，则表明这个位置是局部极大值；二是该局部极大值需要大于2（注意，原代码中这个地方是10，这里因为原图只有10乘10，所以改了一下，变为2，这样才能检测出来，所以这个10也是一个可调参数），即它的热流汇聚要足够大，是一个大的热源，也是为了排除小的干扰。</p>
<p>seeds的值为（即局部极大值的坐标）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">seeds =  (array([<span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>], dtype=int64), array([<span class="number">2</span>, <span class="number">3</span>, <span class="number">7</span>], dtype=int64))</span><br></pre></td></tr></table></figure><br>seeds的第0个元素是局部极大值的x坐标，第1个元素是其对应的y坐标。下面将这些坐标成对提取出来：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pix = <span class="built_in">list</span>(np.array(seeds).T)</span><br></pre></td></tr></table></figure><br>即：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pix =  [array([<span class="number">1</span>, <span class="number">2</span>], dtype=int64), array([<span class="number">1</span>, <span class="number">3</span>], dtype=int64), array([<span class="number">3</span>, <span class="number">7</span>], dtype=int64)]</span><br></pre></td></tr></table></figure><br>然后构建一个3乘3（注意这是二维，三维下是3乘3乘3）的窗口：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expand = np.nonzero(np.ones((<span class="number">3</span>,<span class="number">3</span>)))</span><br></pre></td></tr></table></figure><br>这个窗口内的数值是节点索引：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expand =  (array([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>], dtype=int64), array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>], dtype=int64))</span><br></pre></td></tr></table></figure><br>接下来是两层循环。先看内部循环，它是对pix的长度进行循环（再次明确一下，pix是局部极大值的坐标索引）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(pix)):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">iter</span>==<span class="number">0</span>:</span><br><span class="line">        pix[k] = <span class="built_in">list</span>(pix[k])</span><br><span class="line">    newpix = []</span><br><span class="line">    iin = []</span><br><span class="line">    <span class="keyword">for</span> i,e <span class="keyword">in</span> <span class="built_in">enumerate</span>(expand):</span><br><span class="line">        epix = e[:,np.newaxis] + np.expand_dims(pix[k][i], <span class="number">0</span>) - <span class="number">1</span></span><br><span class="line">        epix = epix.flatten()</span><br><span class="line">        iin.append(np.logical_and(epix&gt;=<span class="number">0</span>, epix&lt;shape[i]))</span><br><span class="line">        newpix.append(epix)</span><br><span class="line">    iin = np.<span class="built_in">all</span>(<span class="built_in">tuple</span>(iin), axis=<span class="number">0</span>)</span><br><span class="line">    newpix = <span class="built_in">tuple</span>(newpix)</span><br><span class="line">    igood = h[newpix]&gt;<span class="number">2</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(dims):</span><br><span class="line">        pix[k][i] = newpix[i][igood]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">iter</span>==<span class="number">4</span>:</span><br><span class="line">        pix[k] = <span class="built_in">tuple</span>(pix[k])</span><br></pre></td></tr></table></figure><br>这里面的变量较多，各自具体的意义为：pix刚开始是局部极大值的坐标索引，epix是在某一个维度上expand滑动窗加上pix索引减去1，newpix是在两个维度上对epix进行合成，这样来说，newpix就是以pix中的坐标为中心的九个像素坐标索引，比如pix中某个像素是[1, 2]，那么newpix就是：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newpix =  [array([<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>], dtype=int64), array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], dtype=int64)]</span><br></pre></td></tr></table></figure><br>然后看之前的直方图统计矩阵h在这九个像素点上是否大于2，即为igood的值，即是否有热流流入，以上面的[1, 2]中心像素所产生的九个像素为例，igood就是：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">igood =  [<span class="literal">False</span> <span class="literal">False</span> <span class="literal">False</span> <span class="literal">False</span>  <span class="literal">True</span>  <span class="literal">True</span> <span class="literal">False</span> <span class="literal">False</span> <span class="literal">False</span>]</span><br></pre></td></tr></table></figure><br>即仍然是[1, 2]和[1, 3]中的热流强度大于2，然后把这两个坐标提取出来再次放入pix中，即下面这句：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(dims):</span><br><span class="line">    pix[k][i] = newpix[i][igood]</span><br></pre></td></tr></table></figure><br>此时pix变为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pix =  [[array([<span class="number">1</span>, <span class="number">1</span>], dtype=int64), array([<span class="number">2</span>, <span class="number">3</span>], dtype=int64)], array([<span class="number">1</span>, <span class="number">3</span>], dtype=int64), array([<span class="number">3</span>, <span class="number">7</span>], dtype=int64)]</span><br></pre></td></tr></table></figure><br>对比一下pix最开始的坐标索引，可以发现pix中第一个元素由原来的局部极大值索引[1, 2]，变成了以它为中心的九个像素中直方图统计大于2的像素坐标索引。<br>那么对原来pix中所有极大值索引都循环一遍后，得到了新的pix：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[array([<span class="number">1</span>, <span class="number">1</span>], dtype=int64), array([<span class="number">2</span>, <span class="number">3</span>], dtype=int64)], </span><br><span class="line"> [array([<span class="number">1</span>, <span class="number">1</span>], dtype=int64), array([<span class="number">2</span>, <span class="number">3</span>], dtype=int64)],</span><br><span class="line"> [array([<span class="number">3</span>, <span class="number">4</span>], dtype=int64), array([<span class="number">7</span>, <span class="number">7</span>], dtype=int64)]]</span><br></pre></td></tr></table></figure><br>以上就是内层循环的作用：以最开始的局部极大值所在像素为中心，在其上罩一个3乘3的窗口，看该窗口内直方图统计是否大于2，如果是，就将该邻居像素的坐标索引加入pix中。<br>那么外层循环就是不断地重复这个内层循环5次（这里的5也是一个可调参数），即一步步地查找是否由邻居像素的热流大于2。<br>内层循环和外层循环加起来实现的效果就是：模仿漫水填充，查找最开始的最大热源所辐射的范围，看哪些邻居像素属于该热源。</p>
<p>在该例中，经过上述内外循环后，pix的值为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[(array([<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">       <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], dtype=int64), </span><br><span class="line">  array([<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>,</span><br><span class="line">       <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>], dtype=int64)),</span><br><span class="line"> (array([<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">       <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], dtype=int64),</span><br><span class="line">  array([<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>,</span><br><span class="line">       <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>], dtype=int64)),</span><br><span class="line"> (array([<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>,</span><br><span class="line">       <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>], dtype=int64), </span><br><span class="line">  array([<span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>,</span><br><span class="line">       <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>], dtype=int64))]</span><br></pre></td></tr></table></figure><br>虽然看起来里面有很多元素，但pix的length只有3，表明这些元素都是由最开始的3个局部极大值所辐射的；另一方面，很多元素都是重复的，实际只有[1, 2]、[1, 3]、[3, 7]、[4, 7]这四个元素。<br>然后对这些元素进行label：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">M = np.zeros(h.shape, np.int32)</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(pix)):</span><br><span class="line">    M[pix[k]] = <span class="number">1</span>+k</span><br></pre></td></tr></table></figure><br>可得M矩阵的数值（注意它这里是h.shape，即M是与直方图统计所对应的，不是原图）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]]</span><br></pre></td></tr></table></figure><br>从上面已经知道，pflows中异常值就代表了热源位置，所以这里根据pflows的索引，得到其上的label值（即将pflows传入M）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(dims):</span><br><span class="line">    pflows[i] = pflows[i] + rpad</span><br><span class="line"></span><br><span class="line">M0 = M[<span class="built_in">tuple</span>(pflows)]</span><br></pre></td></tr></table></figure><br>所以，与原图对应的label值（就是掩膜）就是：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3</span></span><br><span class="line"> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br></pre></td></tr></table></figure><br>这里得到掩膜后，中间还插了一段去掉非常大的掩膜的代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_,counts = np.unique(M0, return_counts=<span class="literal">True</span>)</span><br><span class="line">big = np.prod(shape0) * <span class="number">0.4</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> np.nonzero(counts &gt; big)[<span class="number">0</span>]:</span><br><span class="line">    M0[M0==i] = <span class="number">0</span></span><br></pre></td></tr></table></figure><br>因为这个例子的掩膜比较小，因此这段代码没起作用。<br>从目前掩膜M0的值来看，它里面的数值是2和3，没有从1开始。<br>下面就是转换一下（这里用到的技术就是np.unique中的return_inverse这个参数，是返回这些unique数的索引，非常巧妙）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_,M0 = np.unique(M0, return_inverse=<span class="literal">True</span>)</span><br><span class="line">M0 = np.reshape(M0, shape0)</span><br></pre></td></tr></table></figure><br>此时M0变为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span></span><br><span class="line"> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br></pre></td></tr></table></figure><br>最后再变成原图的尺寸即可：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">M0 = np.reshape(M0, shape0)</span><br></pre></td></tr></table></figure><br>即：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]]</span><br></pre></td></tr></table></figure></p>
<h1 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h1><h2 id="UnetModel模型类"><a href="#UnetModel模型类" class="headerlink" title="UnetModel模型类"></a>UnetModel模型类</h2><p>Cellpose的算法是基于Unet架构的。<br>基础模型调用在：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnetModel</span>():</span></span><br><span class="line">        self.net = resnet_style.CPnet(nbase, nout=self.nclasses,</span><br><span class="line">                                      residual_on=residual_on,</span><br><span class="line">                                      style_on=style_on,</span><br><span class="line">                                      concatenation=concatenation)</span><br><span class="line">        self.net.hybridize(static_alloc=<span class="literal">True</span>, static_shape=<span class="literal">True</span>)</span><br><span class="line">        self.net.initialize(ctx = self.device)</span><br></pre></td></tr></table></figure><br>即，UnetModel这个类实际是CPnet类的一个实例化对象，因此，CPnet类才是最基础的算法架构所在：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CPnet</span>(<span class="params">gluon.HybridBlock</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, nbase, nout, residual_on=<span class="literal">True</span>, style_on=<span class="literal">True</span>, concatenation=<span class="literal">False</span>, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(CPnet, self).__init__(**kwargs)</span><br><span class="line">        <span class="keyword">with</span> self.name_scope():</span><br><span class="line">            self.nbase = nbase</span><br><span class="line">            self.downsample = downsample(nbase, residual_on=residual_on)</span><br><span class="line">            self.upsample = upsample(nbase, residual_on=residual_on, concatenation=concatenation)</span><br><span class="line">            self.output = batchconv(nout, <span class="number">1</span>)</span><br><span class="line">            self.make_style = make_style()</span><br><span class="line">            self.style_on = style_on</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hybrid_forward</span>(<span class="params">self, F, data</span>):</span></span><br><span class="line">        <span class="comment">#data     = self.conv1(data)</span></span><br><span class="line">        T0    = self.downsample(data)</span><br><span class="line">        style = self.make_style(T0[-<span class="number">1</span>])</span><br><span class="line">        style0 = style</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.style_on:</span><br><span class="line">            style = style * <span class="number">0</span></span><br><span class="line">        T0    = self.upsample(style, T0)</span><br><span class="line">        T0    = self.output(T0)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> T0, style0</span><br></pre></td></tr></table></figure><br>CPnet基于MXNet/Gluon（Gluon是MXNet的动态图接口），这里还使用了MXNet的混合式编程方法，即继承自gluon.HybridBlock类。混合式编程是将命令式编程与符号式编程混合在一起，既可以通过命令式编程使代码编写起来更容易和直观，也可以通过符号式编程来获得更好的计算性能和可移植性。MXNet通过HybridSequential类和HybridBlock类构建的模型可以调用hybridize函数将命令式程序转成符号式程序。具体教程见下方链接：<br><a target="_blank" rel="noopener" href="http://zh.gluon.ai/chapter_computational-performance/hybridize.html?highlight=hybrid">命令式和符号式混合编程</a><br>CPnet类有两种算法结构可以选择，一种是经典的Unet结构，一种是以ResNet为backbone的Unet结构，两者可以通过residual_on这个参数来开关。</p>
<h2 id="CellposeModel模型类"><a href="#CellposeModel模型类" class="headerlink" title="CellposeModel模型类"></a>CellposeModel模型类</h2><p>CellposeModel类是基于上面的UnetModel类，但两者也有不同：UnetModel是通用的算法架构，其训练集的data和label是通用的、未经特殊处理的；而CellposeModel的训练集的label实际是在原mask基础上计算的flow field，即定制化的label。<br>主要区别在这里：<br>对于UnetModel，其label为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.nclasses==<span class="number">3</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;computing boundary pixels&#x27;</span>)</span><br><span class="line">    train_classes = [np.stack((label, label&gt;<span class="number">0</span>, utils.distance_to_boundary(label)), axis=<span class="number">0</span>).astype(np.float32)</span><br><span class="line">                        <span class="keyword">for</span> label <span class="keyword">in</span> tqdm(train_labels)]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    train_classes = [np.stack((label, label&gt;<span class="number">0</span>), axis=<span class="number">0</span>).astype(np.float32)</span><br><span class="line">                        <span class="keyword">for</span> label <span class="keyword">in</span> tqdm(train_labels)]</span><br></pre></td></tr></table></figure><br>对于CellposeModel，其label为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train_flows = dynamics.labels_to_flows(train_labels, files=train_files)</span><br></pre></td></tr></table></figure></p>
<h2 id="SizeModel模型类"><a href="#SizeModel模型类" class="headerlink" title="SizeModel模型类"></a>SizeModel模型类</h2><p>SizeModel类是用来估计图像中物体尺寸（中位直径）的模型。</p>
<h2 id="Cellpose类"><a href="#Cellpose类" class="headerlink" title="Cellpose类"></a>Cellpose类</h2><p>Cellpose类是对CellposeModel和SizeModel的整合，即对这两个模型的统一调用。</p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Donate
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechat_reward.png" alt="Xin-Bo Qi(亓欣波) WeChat Pay">
        <p>WeChat Pay</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/cellpose/" rel="tag"># cellpose</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/09/26/wxpython/" rel="prev" title="wxPython知识点">
      <i class="fa fa-chevron-left"></i> wxPython知识点
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/10/24/cellpose-1/" rel="next" title="胞状物体通用分割算法Cellpose解析：使用篇">
      胞状物体通用分割算法Cellpose解析：使用篇 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A6%82%E8%A7%88"><span class="nav-number">1.</span> <span class="nav-text">概览</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A0%87%E6%B3%A8%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="nav-number">2.</span> <span class="nav-text">标注数据格式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%91%E9%87%8F%E5%9C%BA%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="nav-number">3.</span> <span class="nav-text">向量场数据格式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%91%E9%87%8F%E5%9C%BA%E8%AE%A1%E7%AE%97%E5%8E%9F%E7%90%86"><span class="nav-number">3.1.</span> <span class="nav-text">向量场计算原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E%E6%B5%81%E5%9C%BA%E5%A4%8D%E5%8E%9F%E6%8E%A9%E8%86%9C"><span class="nav-number">3.2.</span> <span class="nav-text">从流场复原掩膜</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B"><span class="nav-number">4.</span> <span class="nav-text">模型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#UnetModel%E6%A8%A1%E5%9E%8B%E7%B1%BB"><span class="nav-number">4.1.</span> <span class="nav-text">UnetModel模型类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CellposeModel%E6%A8%A1%E5%9E%8B%E7%B1%BB"><span class="nav-number">4.2.</span> <span class="nav-text">CellposeModel模型类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SizeModel%E6%A8%A1%E5%9E%8B%E7%B1%BB"><span class="nav-number">4.3.</span> <span class="nav-text">SizeModel模型类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cellpose%E7%B1%BB"><span class="nav-number">4.4.</span> <span class="nav-text">Cellpose类</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xin-Bo Qi(亓欣波)"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Xin-Bo Qi(亓欣波)</p>
  <div class="site-description" itemprop="description">Digitize everything to realize Digitalization!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">150</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/qixinbo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qixinbo" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:qixinbo@gmail.com" title="E-Mail → mailto:qixinbo@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/qixinbo" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;qixinbo" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fas fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.tsinghua.edu.cn/" title="https:&#x2F;&#x2F;www.tsinghua.edu.cn" rel="noopener" target="_blank">THU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.imr.cas.cn/" title="http:&#x2F;&#x2F;www.imr.cas.cn" rel="noopener" target="_blank">IMR</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.sdu.edu.cn/" title="http:&#x2F;&#x2F;www.sdu.edu.cn" rel="noopener" target="_blank">SDU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://liam0205.me/" title="http:&#x2F;&#x2F;liam0205.me&#x2F;" rel="noopener" target="_blank">黄晨成</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xin-Bo Qi(亓欣波)</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://qixinbo.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "http://qixinbo.github.io/2020/10/24/cellpose-2/";
    this.page.identifier = "2020/10/24/cellpose-2/";
    this.page.title = "胞状物体通用分割算法Cellpose解析：开发篇";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://qixinbo.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
