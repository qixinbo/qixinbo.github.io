<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qixinbo.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Be interesting!">
<meta property="og:type" content="website">
<meta property="og:title" content="亓欣波">
<meta property="og:url" content="http://qixinbo.github.io/page/5/index.html">
<meta property="og:site_name" content="亓欣波">
<meta property="og:description" content="Be interesting!">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Xin-Bo Qi(亓欣波)">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://qixinbo.github.io/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>亓欣波</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">亓欣波</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Hi, I am Xin-Bo Qi (亓欣波)</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-scholar">

    <a href="/scholar/" rel="section"><i class="bar-chart fa-fw"></i>scholar</a>

  </li>
        <li class="menu-item menu-item-sources">

    <a href="/sources/" rel="section"><i class="rss fa-fw"></i>sources</a>

  </li>
        <li class="menu-item menu-item-gallery">

    <a href="/gallery/" rel="section"><i class="file-image-o fa-fw"></i>gallery</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404.html" rel="section"><i class="heartbeat fa-fw"></i>Commonweal 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/07/20/cmd-proxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/20/cmd-proxy/" class="post-title-link" itemprop="url">命令行终端设置代理上网（pac文件）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-07-20 00:00:00" itemprop="dateCreated datePublished" datetime="2019-07-20T00:00:00+08:00">2019-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/07/20/cmd-proxy/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/07/20/cmd-proxy/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>==== 2019.7.20 更新：增加docker走代理 ====<br>docker也是不走.bashrc中配置的代理，需要走自己的配置文件，修改/etc/default/docker文件，增加：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTP_PROXY=<span class="string">&quot;http://[proxy-addr]:[proxy-port]/&quot;</span></span><br><span class="line">HTTPS_PROXY=<span class="string">&quot;https://[proxy-addr]:[proxy-port]/&quot;</span></span><br></pre></td></tr></table></figure>
<p>然后重启docker服务。<br>参考见：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/styshoo/article/details/55657714">Docker网络代理设置</a></p>
<p>==== 2019.7.2更新：增加apt走代理 ===<br>Linux系统下经过下面的设置后，pip可以正常联网，但apt仍然无法联网，这是因为apt已经不读取http_proxy，需要编辑</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/apt/apt.conf</span><br></pre></td></tr></table></figure>
<p>文件，加入：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Acquire::http::proxy <span class="string">&quot;http://username:password@proxyserver:port/&quot;</span>;</span><br><span class="line">Acquire::https::proxy <span class="string">&quot;https://username:password@proxyserver:port/&quot;</span>;</span><br><span class="line">Acquire::socks::proxy <span class="string">&quot;socks://username:password@proxyserver:port/&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>具体参考见：<br><a target="_blank" rel="noopener" href="https://askubuntu.com/questions/641409/how-to-config-proxy-in-ubuntu-on-virtualbox">How to config proxy in Ubuntu on VirtualBox</a><br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/29442534">怎样设置 Linux 虚拟机通过代理服务器上网？</a><br>多说一句，虚拟机下的设置，首先设置虚拟机与主机的连接方式为NAT。</p>
<p>==== 2019.5.26更新：增加socks代理 ===<br>一般我们使用SSR来代理，所以这里增加这种方式的设置。<br>首先，还是需要先设置好SSR，这部分不详述。<br>然后，终端配置的命令是：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> ALL_PROXY=socks5:<span class="comment">//127.0.0.1:1080</span></span><br></pre></td></tr></table></figure>
<p>但实测这样还是不走ssr代理，此时可以借助proxychains这个软件。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install proxychains</span><br></pre></td></tr></table></figure>
<p>然后修改：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/proxychains.conf</span><br></pre></td></tr></table></figure>
<p>加入：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socks5 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">1080</span></span><br></pre></td></tr></table></figure>
<p>然后，运行需要代理的命令时都在前面加上proxychains，比如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains wget www.google.com</span><br></pre></td></tr></table></figure>


<p>这样设置好了以后，通过pip下载时又报如下错误：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Missing dependencies <span class="keyword">for</span> SOCKS support</span><br></pre></td></tr></table></figure>
<p>此时，可以：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pysocks</span><br></pre></td></tr></table></figure>
<p>=======================================================================</p>
<p>以下是正文。</p>
<h1 id="事件起因"><a href="#事件起因" class="headerlink" title="事件起因"></a>事件起因</h1><p>之前公司给了一个pac文件，可以实现对国外网站的访问，具体加载该文件的过程也非常简单，即：</p>
<ul>
<li>在IE浏览器中通过「Internet选项 -&gt; 连接 -&gt; 局域网设置 -&gt; 使用自动配置脚本」，在地址栏中填写PAC文件的URI，这个 URI 可以是本地资源路径(file:///)，也可以是网络资源路径(http:// )。</li>
<li>在Chrome中则是「chrome://settings/ -&gt; 显示高级设置 -&gt; 更改代理服务器设置」。</li>
</ul>
<p>但问题来了：这样的设置可以在浏览器中实现科学上网，对于命令行终端仍然是老样子。于是，需要对终端进行一番配置才行。</p>
<h1 id="事件经过"><a href="#事件经过" class="headerlink" title="事件经过"></a>事件经过</h1><h2 id="方式1：直接设置代理IP地址"><a href="#方式1：直接设置代理IP地址" class="headerlink" title="方式1：直接设置代理IP地址"></a>方式1：直接设置代理IP地址</h2><p>从网上搜索“Windows 终端 代理”，很容易就找到很多教程，搜索结果如下：<br><a target="_blank" rel="noopener" href="https://www.google.com/search?newwindow=1&rlz=1C1GCEV_enCN824US824&ei=lVLRXOfQDon5wAKc0KKIAw&q=windows+%E7%BB%88%E7%AB%AF+%E4%BB%A3%E7%90%86&oq=windows+%E7%BB%88%E7%AB%AF+%E4%BB%A3%E7%90%86&gs_l=psy-ab.12...0.0..68252...0.0..0.0.0.......0......gws-wiz._htvS52bUVQ">Google “Windows 终端 代理”</a></p>
<p>大家给出的最常用的方法就是如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> http_proxy=http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1189</span></span><br><span class="line"><span class="built_in">set</span> https_proxy=http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1189</span></span><br></pre></td></tr></table></figure>
<p>即通过对如上两个环境变量设置代理IP地址和端口号来实现代理。<br>这种方式大家都给出了，说明大家都通过它成功了，但我这里没有IP地址和端口号，只有pac文件。。于是此法对我不适用（实际是适用的，只是我是网络小白，没意识到。。），还得继续探索。</p>
<h2 id="方式2：继承IE的代理配置"><a href="#方式2：继承IE的代理配置" class="headerlink" title="方式2：继承IE的代理配置"></a>方式2：继承IE的代理配置</h2><p>一番搜索后，发现知乎上有一个回答，见如下链接：<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23059121/answer/130382105">如何对windows的command(命令行)设置代理IP？ - 潘小潘的回答 - 知乎</a><br>答主给出的解决方法是：</p>
<blockquote>
<p>先设置ie代理IE -&gt; Settings -&gt; Internet options -&gt; connections -&gt; LAN,<br>然后以管理员身份打开命令行执行如下命令：<br>netsh winhttp import proxy source=ie<br>然后会提示如下信息：<br>当前的 WinHTTP 代理服务器设置:<br>代理服务器: <a target="_blank" rel="noopener" href="http://xxx.sss.com:8080/">http://xxx.sss.com:8080</a><br>绕过列表 : &lt;-loopback&gt;;*.ddd.com<br>=======如何取消代理=========<br>netsh winhttp reset proxy</p>
</blockquote>
<p>并且答主在评论里也说到：</p>
<blockquote>
<p>这个主要是解决cmd使用ie 中设置的代理。尤其是使用pac文件设置的自动代理</p>
</blockquote>
<p>但为什么我照做了，仍然不行！！说是“no proxy”。。。<br>所以这个方法对我也不适用，不过这里也放上了，没准正在看该文的你是个有缘人。。</p>
<h2 id="方式3（正解）：解析pac文件"><a href="#方式3（正解）：解析pac文件" class="headerlink" title="方式3（正解）：解析pac文件"></a>方式3（正解）：解析pac文件</h2><p>在搜索的过程中，发现了一片对pac文件的讲解，发现它就是个JavaScript函数！！正好前几天学了一下JavaScript，说明此时我是有缘人。。有缘的讲解链接如下：<br><a target="_blank" rel="noopener" href="https://exp-team.github.io/blog/2017/01/13/tool/using-pac/">如何使用PAC文件“科学上网”</a><br>可以看出，pac文件就是为了让代理能够有意识地判断何种情况去怎样代理，它的主要三个归处有：</p>
<blockquote>
<p>DIRECT 直接联机而不透过 Proxy<br>PROXY host:port 使用指定的 Proxy 伺服机<br>SOCKS host:port 使用指定的 Socks 伺服机</p>
</blockquote>
<p>哈哈，这里就出现了代理IP地址和端口号！接下来就很简单了，就是找到公司给的pac文件中PROXY后面的那个host和port（不过也要仔细排查，因为有很多if语句，那么该if语句后面的PROXY就不是想要的那个通用的proxy），然后再用方式1进行设置即可！<br>按说按上面的来就行了，但这里还很有必要地再加一个小节，因为有个巨坑。。</p>
<h2 id="方式3-Plus-（更完美的正解）"><a href="#方式3-Plus-（更完美的正解）" class="headerlink" title="方式3 Plus （更完美的正解）"></a>方式3 Plus （更完美的正解）</h2><p>我第一次按方式3设置后，还是没生效。。。:( :(<br>为啥呢，答案见下面链接：<br><a target="_blank" rel="noopener" href="https://zcdll.github.io/2018/01/27/proxy-on-windows-terminal/">给 Windows 的终端配置代理</a><br>具体为：</p>
<blockquote>
<p>cmd 中用 set http_proxy 设置<br>Git Bash 中用 export http_proxy 设置<br>PowerShell 中按照这样设置</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> registry keys for IE 8, may vary for other versions</span></span><br><span class="line">$regPath = <span class="string">&#x27;HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings&#x27;</span></span><br><span class="line"></span><br><span class="line">function Clear-Proxy</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">Set</span>-ItemProperty -Path $regPath -Name ProxyEnable -Value <span class="number">0</span></span><br><span class="line">    <span class="type">Set</span>-ItemProperty -Path $regPath -Name ProxyServer -Value <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="type">Set</span>-ItemProperty -Path $regPath -Name ProxyOverride -Value <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    [Environment]::SetEnvironmentVariable(<span class="string">&#x27;http_proxy&#x27;</span>, $null, <span class="string">&#x27;User&#x27;</span>)</span><br><span class="line">    [Environment]::SetEnvironmentVariable(<span class="string">&#x27;https_proxy&#x27;</span>, $null, <span class="string">&#x27;User&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function <span class="type">Set</span>-Proxy</span><br><span class="line">&#123;</span><br><span class="line">    $proxy = <span class="string">&#x27;http://example.com&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">Set</span>-ItemProperty -Path $regPath -Name ProxyEnable -Value <span class="number">1</span></span><br><span class="line">    <span class="type">Set</span>-ItemProperty -Path $regPath -Name ProxyServer -Value $proxy</span><br><span class="line">    <span class="type">Set</span>-ItemProperty -Path $regPath -Name ProxyOverride -Value <span class="string">&#x27;&lt;local&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">    [Environment]::SetEnvironmentVariable(<span class="string">&#x27;http_proxy&#x27;</span>, $proxy, <span class="string">&#x27;User&#x27;</span>)</span><br><span class="line">    [Environment]::SetEnvironmentVariable(<span class="string">&#x27;https_proxy&#x27;</span>, $proxy, <span class="string">&#x27;User&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我是用的方式1中的set命令，但我用的终端是Cygwin，虽然Cygwin认识了set，但就是没生效。于是我灵机一动换成了Windows官方的终端cmd。。。<br>Love and Peace!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/07/20/opencv-watershed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/20/opencv-watershed/" class="post-title-link" itemprop="url">OpenCV分水岭Watershed算法的前因后果[转载]</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-07-20 00:00:00" itemprop="dateCreated datePublished" datetime="2019-07-20T00:00:00+08:00">2019-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/07/20/opencv-watershed/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/07/20/opencv-watershed/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在学习OpenCV的分水岭算法时，找到Xuhui Zhao小朋友的一篇总结文章，把分水岭算法所需要的预处理和背景知识都讲解得非常透彻细致，特向他申请了转载权限，致谢～<br>原文链接在<a target="_blank" rel="noopener" href="https://zhaoxuhui.top/blog/2017/06/23/%E5%9F%BA%E4%BA%8EPython%E7%9A%84OpenCV%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%8615.html#%E5%9B%9B%E5%88%86%E6%B0%B4%E5%B2%AD%E7%AE%97%E6%B3%95%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2">这里</a>。</p>
<p>===============================================================================</p>
<h1 id="二值图像距离变换"><a href="#二值图像距离变换" class="headerlink" title="二值图像距离变换"></a>二值图像距离变换</h1><p>图像距离变换是二值化图像处理与操作中的常用手段， 其主要思想是通过标识空间点(目标点与背景点)距离，将二值化图像转换为灰度图像。 可用于骨架提取、图像窄化等等。它的结果是得到一张与输入影像类似的灰度图像， 但是灰度值只出现在前景区域，并且离物体边缘越远的像素灰度值越大。</p>
<h2 id="主要过程"><a href="#主要过程" class="headerlink" title="主要过程"></a>主要过程</h2><ol>
<li>将图像中的目标像素点分类，分为内部点、外部点和孤立点。 以中心像素的四邻域为例，如果中心像素为目标像素(值为1)且四邻域都为目标像素(值为1)， 则该点为内部点。如果该中心像素为目标像素，四邻域为背景像素(值为0)，则该中心点为孤立点，如下图所示。<br><img src="https://ws1.sinaimg.cn/large/006Xmmmgly1g56azq3bb4j30jc08it8u.jpg"><br>除了内部点和孤立点之外的目标区域点为边界点。</li>
<li>统计图像中所有的内部点和非内部点，分别用S1、S2表示。</li>
<li>对于S1中的每个内部点P(x,y)，使用距离计算公式dist()计算其与S2中所有点的最小距离。每一个点对应一个最小距离， 这些最小距离构成集合S3。</li>
<li>计算S3中的最大值Max、最小值Min。</li>
<li>对于S1中的所有内部点，其对应灰度按下式计算：<br>$$<br>G(x,y)=\frac{\left | S_{3}(x,y) - Min\right |}{\left | Max-Min \right |}\cdot 255<br>$$<br>S3(x,y)表示(x,y)对应的像素与S2中所有点的最短距离。</li>
<li>对于孤立点灰度值保持不变。</li>
</ol>
<h2 id="距离变换算法"><a href="#距离变换算法" class="headerlink" title="距离变换算法"></a>距离变换算法</h2><p>在上面步骤中，提到了计算距离的函数dist()，这便是不同算法体现之处。按照变换类型可以分为欧式距离变换和非欧式距离变换两种。 非欧式距离变换包括棋盘距离变换、城市街区距离变换、倒角距离变换等。主要算法公式如下：<br>(1)欧氏距离<br>$$<br>dist((x_{1},y_{1}),(x_{2},y_{2}))=\sqrt{(x_{1}-x_{2})^{2}+(y_{1}-y_{2})^{2}}<br>$$<br>(2)曼哈顿距离<br>$$<br>dist((x_{1},y_{1}),(x_{2},y_{2}))=\left | x_{1}-x_{2} \right |+\left | y_{1}-y_{2} \right |<br>$$<br>(3)切比雪夫距离<br>$$<br>dist((x_{1},y_{1}),(x_{2},y_{2}))=max(\left | x_{1}-x_{2} \right |,\left | y_{1}-y_{2} \right |)<br>$$</p>
<p>##OpenCV实现<br>在OpenCV中有方便的cv2.distanceTransform()用于实现距离变换。代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以灰度模式读取图像</span></span><br><span class="line">img = cv2.imread(<span class="string">&quot;E:\\dist.png&quot;</span>, <span class="number">0</span>)</span><br><span class="line"><span class="comment"># 设置阈值进行二值化</span></span><br><span class="line"><span class="comment"># 注意这里二值化的同时对图像进行了反色，因为背景比前景颜色要浅，</span></span><br><span class="line"><span class="comment"># 直接二值化的结果是背景是白色的，前景是黑色的，这显然不是我们想要的结果</span></span><br><span class="line"><span class="comment"># 同时注意这样两个操作相加的这种写法</span></span><br><span class="line">ret, binary = cv2.threshold(img, <span class="number">0</span>, <span class="number">255</span>, cv2.THRESH_OTSU + cv2.THRESH_BINARY_INV)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用距离变换函数</span></span><br><span class="line"><span class="comment"># 第一个参数是二值化图像</span></span><br><span class="line"><span class="comment"># 第二个参数是类型distanceType</span></span><br><span class="line"><span class="comment"># 第三个参数是maskSize</span></span><br><span class="line"><span class="comment"># 返回的结果是一张灰度图像，但注意这个图像直接采用OpenCV的imshow显示是有问题的</span></span><br><span class="line"><span class="comment"># 所以采用Matplotlib的imshow显示或者对其进行归一化再用OpenCV显示</span></span><br><span class="line">dist = cv2.distanceTransform(binary, cv2.DIST_L2, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将灰度、二值化图像合并到一个窗口中显示</span></span><br><span class="line">result = np.hstack((img, binary))</span><br><span class="line"></span><br><span class="line">cv2.imshow(<span class="string">&quot;result&quot;</span>, result)</span><br><span class="line">plt.imshow(dist, cmap=<span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">plt.show()</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>效果如下：<br><img src="https://ws3.sinaimg.cn/large/006Xmmmggy1g56b5o0velj30f708c745.jpg"><br><img src="https://ws3.sinaimg.cn/large/006Xmmmggy1g56b684ge0j30bx0be74a.jpg"></p>
<p>可以看到，通过距离变换的图像越靠近物体中心的地方越亮。</p>
<h1 id="灰度三维模型"><a href="#灰度三维模型" class="headerlink" title="灰度三维模型"></a>灰度三维模型</h1><p>在介绍分水岭法之前，先介绍图像的另一种表达形式，灰度三维模型。简单来说就是把某个像素的灰度值当作高程， 图像的宽高为x、y轴，这样就可以做出一个三维模型。例如有一幅图像如下所示：<br><img src="https://ws4.sinaimg.cn/large/006Xmmmggy1g56b79f6eyj30cj04i741.jpg"><br>我们以灰度为高程，可以做出如下图形：<br><img src="https://ws2.sinaimg.cn/large/006Xmmmggy1g56b83pqutj30i208yq3j.jpg"><br>可以看到，图中蓝色越深的地方表示灰度值越低，越黄的地方表示灰度值越高。该图是采用Matlab绘制的。代码非常简单。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function [] = Draw3DGray( path )</span><br><span class="line">%将RGB图像转换成对应的灰度图像并以各像素灰度数值画出3D模型</span><br><span class="line">%   例如输入文件路径为：E:\p1.png</span><br><span class="line">    I = imread(path);</span><br><span class="line">    GrayScaleImage = rgb2gray(I);</span><br><span class="line">    mesh(GrayScaleImage);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>那么在Python下如何绘制呢，这是我们下面讨论的问题。</p>
<h2 id="绘制图像的灰度三维模型"><a href="#绘制图像的灰度三维模型" class="headerlink" title="绘制图像的灰度三维模型"></a>绘制图像的灰度三维模型</h2><p>代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> mpl_toolkits.mplot3d <span class="keyword">import</span> Axes3D</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line">img = cv2.imread(<span class="string">&quot;E:\\color.png&quot;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fig = plt.figure()</span><br><span class="line">ax = Axes3D(fig)</span><br><span class="line">X = np.arange(<span class="number">0</span>, img.shape[<span class="number">0</span>], <span class="number">1</span>)</span><br><span class="line">Y = np.arange(<span class="number">0</span>, img.shape[<span class="number">1</span>], <span class="number">1</span>)</span><br><span class="line">X, Y = np.meshgrid(X, Y)</span><br><span class="line">Z = img[X, Y]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 具体函数方法可用 help(function) 查看</span></span><br><span class="line">ax.plot_surface(X, Y, Z, rstride=<span class="number">1</span>, cstride=<span class="number">1</span>, cmap=<span class="string">&#x27;rainbow&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cv2.imshow(<span class="string">&quot;img&quot;</span>, img)</span><br><span class="line">plt.show()</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>在代码中用到了Matplotlib以及绘制三维图像的库。效果如下：<br><img src="https://ws2.sinaimg.cn/large/006Xmmmggy1g56bac479ij30hs0dcjse.jpg"><br>下面的动图更好地展示了三维灰度模型的效果。这里为了绘制更快，将行列的采样间隔设置为6，以减少绘制的点数。 仔细观察边缘会发现精度有一定损失。<br><img src="https://ws2.sinaimg.cn/large/006Xmmmggy1g56bbuuap3g30hp0cx1l1.gif"><br>下图是对一块真实地物进行绘制的效果。原图如下：<br><img src="https://ws2.sinaimg.cn/large/006Xmmmggy1g56bbg7cn0j3074074t8q.jpg"><br>三维灰度地形图如下：<br><img src="https://ws1.sinaimg.cn/large/006Xmmmggy1g56bbg7e3fj30cf09b3zt.jpg"></p>
<h1 id="图像梯度"><a href="#图像梯度" class="headerlink" title="图像梯度"></a>图像梯度</h1><p>图像梯度和数学上的梯度其实是类似的，可以用一阶导数或二阶偏导数求解。 沿梯度方向导数变化量达到最大值，也就是说，梯度的方向是函数在这点变化最快的方向。 反映的是图像灰度在某点的变化，梯度越大表示变化越明显。 但是图像以矩阵的形式存储的，不能像数学理论中对直线或者曲线求导一样， 对一幅图像的求导相当于对一个平面、曲面求导。对图像的操作， 采用模板对原图进行卷积运算，从而达到想要的效果。 而获取一幅图像的梯度就转化为：模板（Roberts、Prewitt、Sobel、Lapacian算子）对原图像进行卷积。</p>
<h2 id="推导过程"><a href="#推导过程" class="headerlink" title="推导过程"></a>推导过程</h2><p>(1)Roberts算子<br>在一维连续数集上求导，有如下公式：<br>$$<br>{f}’(x)=\frac{f(x+ \Delta x)-f(x)}{\Delta x}<br>$$<br>在二维连续数集上，在x、y方向有偏导数，公式如下：<br>$$<br>\frac{\partial f(x,y)}{\partial x}=\frac{f(x+\Delta x,y)-f(x,y)}{\Delta x}<br>$$<br>$$<br>\frac{\partial f(x,y)}{\partial y}=\frac{f(x,y+\Delta y)-f(x,y)}{\Delta y}<br>$$<br>在某点的梯度为一矢量，如下：<br>$$<br>grad(f)=\left ( \frac{\partial f}{\partial x}, \frac{\partial f}{\partial y}\right )<br>$$<br>其对应的梯度的大小为：<br>$$<br>\left | grad(f) \right |=\sqrt{\left ( \frac{\partial f}{\partial x} \right )^{2}+ \left ( \frac{\partial f}{\partial y} \right )^{2}}<br>$$<br>而在二维离散数集上，令$\Delta x =1$、$\Delta y =1$则可得到对应离散情况下的公式，也可以为2，只是表示一个单位的度量。 因此对于图像而言，其偏导数以及梯度公式如下：<br>$$<br>g_{x}=\frac{\partial f(x,y)}{\partial x}=f(x+1,y)-f(x,y)<br>$$<br>$$<br>g_{y}=\frac{\partial f(x,y)}{\partial y}=f(x,y+1)-f(x,y)<br>$$<br>$$<br>\left | grad(f) \right |=\sqrt{g_{x}^{2}+ {g_{y}^{2}}}\approx \left | g_{x}^{2} \right |+\left | g_{y}^{2} \right |<br>$$<br>因此，在x方向，由偏导公式可知，其实就是相邻两个像素的值相减。同理，y方向也是如此。因此可以得到如下算子。<br><img src="https://ws2.sinaimg.cn/large/006Xmmmgly1g56bi4ohn6j30gj0aoq32.jpg"><br>类似地，对于对角线方向梯度，公式和算子如下：<br>$$<br>g_{x}=\frac{\partial f(x,y)}{\partial x}=f(x+1,y+1)-f(x,y)<br>$$<br>$$<br>g_{y}=\frac{\partial f(x,y)}{\partial x}=f(x+1,y)-f(x,y+1)<br>$$<br><img src="https://ws4.sinaimg.cn/large/006Xmmmggy1g56bjk190cj30fs0abjrp.jpg"><br>上述算子为Robert算子。</p>
<p>(2)Prewitt算子<br>2×2模板在概念上很简单，但是对于计算边缘方向不是很有用。一般模板最小为3×3。 在3×3模板中，定义图像梯度如下：<br><img src="https://ws1.sinaimg.cn/large/006Xmmmggy1g56blvi5q8j30fk0act99.jpg"><br>$$<br>g_{x}=\frac{\partial f}{\partial x}=(z_{7}+z_{8}+z_{9})-(z_{1}+z_{2}+z_{3})<br>$$<br>$$<br>g_{y}=\frac{\partial f}{\partial y}=(z_{3}+z_{6}+z_{9})-(z_{1}+z_{4}+z_{7})<br>$$<br>$$<br>g_{x}^{‘}==(z_{2}+z_{3}+z_{6})-(z_{4}+z_{7}+z_{8})<br>$$<br>$$<br>g_{y}^{‘}==(z_{6}+z_{8}+z_{9})-(z_{1}+z_{2}+z_{4})<br>$$<br>以上公式对应的算子如下：<br><img src="https://ws1.sinaimg.cn/large/006Xmmmgly1g56bnimc4dj30i205gt8m.jpg"><br>这些算子称为Prewitt算子。</p>
<p>(3)Sobel算子<br>Sobel算子是在Prewitt算子的基础上改进的，在中心系数上使用一个权值2， 相比较Prewitt算子，Sobel模板能够较好的抑制（平滑）噪声。<br>$$<br>g_{x}=\frac{\partial f}{\partial x}=(z_{7}+2z_{8}+z_{9})-(z_{1}+2z_{2}+z_{3})<br>$$<br>$$<br>g_{y}=\frac{\partial f}{\partial y}=(z_{3}+2z_{6}+z_{9})-(z_{1}+2z_{4}+z_{7})<br>$$<br>对应算子如下：<br><img src="https://ws3.sinaimg.cn/large/006Xmmmggy1g56bp2brdmj30i205gmx3.jpg"></p>
<p>(4)Lapacian算子<br>上述所有算子都是通过求一阶导数来计算梯度的，通常用于边缘检测。 在图像处理过程中，除了检测线，有时候也需要检测特殊点，这就需要用二阶导数进行检测。 离散二阶导数计算公式如下：<br>$$<br>\frac{\partial ^{2}f}{\partial x^{2}}=\frac{ {\partial}’ f}{\partial x}<br>\={(f(x+1)-f(x))}’<br>\={f(x+1)}’-{f(x)}’<br>\=(f(x+2)-f(x+1))-(f(x+1)-f(x))<br>\=f(x+2)-2f(x+1)+f(x)<br>$$<br>但我们想要的是x位置的偏导，因此x整体减一，得到：<br>$$<br>\frac{\partial ^{2}f}{\partial x^{2}}=\frac{ {\partial}’ f}{\partial x}<br>\={(f(x+1)-f(x))}’<br>\={f(x+1)}’-{f(x)}’<br>\=(f(x+2)-f(x+1))-(f(x+1)-f(x))<br>\=f(x+2)-2f(x+1)+f(x)<br>$$<br>$$<br>\frac{\partial ^{2}f}{\partial x^{2}}=f(x+1)-2f(x)+f(x-1)<br>$$<br>同理可以得到y的二阶导数。求梯度时使用拉普拉斯模板，即可以得到拉普拉斯算子计算公式：<br>$$<br>\bigtriangledown ^{2}f(x,y)=\frac{\partial ^{2}f}{\partial x^{2}}+\frac{\partial ^{2}f}{\partial y^{2}}<br>\=[f(x+1,y)-2f(x,y)+f(x-1,y)]+[f(x,y+1)-2f(x,y)+f(x,y-1)]<br>\=f(x+1,y)+f(x,y+1)+f(x,y-1)+f(x-1,y)-4f(x,y)<br>$$<br>算子为：<br><img src="https://ws1.sinaimg.cn/large/006Xmmmggy1g56brxk8ltj30i609yt8p.jpg"><br>模板中心位置的数字是-8而不是-4，是因为要使模板中的这些系数之和为0。 这样不至于改变原图的明暗程度。如果模板的系数大于0，则使用该模板处理完后，所有像素的灰度值都变大了， 直观反映就是图像变亮了。 在用Lapacian算子图像进行卷积运算时，当响应的绝对值超过指定阈值时，那么该点就是被检测出来的孤立点。</p>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p>如下代码计算x方向的Prewitt算子。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">img = cv2.imread(<span class="string">&quot;E:\\jack_fruit.jpg&quot;</span>)</span><br><span class="line"></span><br><span class="line">gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span><br><span class="line"></span><br><span class="line">grad_x = np.matrix(<span class="string">&#x27;-1,-1,-1;&#x27;</span></span><br><span class="line">                   <span class="string">&#x27;0,0,0;&#x27;</span></span><br><span class="line">                   <span class="string">&#x27;1,1,1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">grad_y = np.matrix(<span class="string">&#x27;-1,0,1;&#x27;</span></span><br><span class="line">                   <span class="string">&#x27;-1,0,1;&#x27;</span></span><br><span class="line">                   <span class="string">&#x27;-1,0,1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dst_x = cv2.filter2D(gray, -<span class="number">1</span>, grad_x)</span><br><span class="line">dst_y = cv2.filter2D(gray, -<span class="number">1</span>, grad_y)</span><br><span class="line"></span><br><span class="line">dst = cv2.add(dst_x, dst_y)</span><br><span class="line"></span><br><span class="line">cv2.imshow(<span class="string">&quot;fruit&quot;</span>, img)</span><br><span class="line">cv2.imshow(<span class="string">&quot;dst&quot;</span>, dst)</span><br><span class="line">cv2.imshow(<span class="string">&quot;dst_x&quot;</span>, dst_x)</span><br><span class="line">cv2.imshow(<span class="string">&quot;dst_y&quot;</span>, dst_y)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>效果如下：<br><img src="https://ws4.sinaimg.cn/large/006Xmmmggy1g56btfiun6j30i20gdtd1.jpg"><br><img src="https://ws4.sinaimg.cn/large/006Xmmmggy1g56bu1k7jaj30i20gdgqd.jpg"><br>得到了x、y以及总的梯度图像。</p>
<h1 id="分水岭算法图像分割"><a href="#分水岭算法图像分割" class="headerlink" title="分水岭算法图像分割"></a>分水岭算法图像分割</h1><h2 id="思路与原理"><a href="#思路与原理" class="headerlink" title="思路与原理"></a>思路与原理</h2><p>有了上面对图像灰度三维模型的直观感受，会更好理解分水岭算法的思想。 在分水岭算法中，一幅图像中灰度值高的区域被看作山峰，灰度值低的区域被看作山谷。 然后从山谷的最低点灌水，水会慢慢在不同的地方汇合，而这些汇合的地方就是需要对图像分割的地方。 分水岭算法的核心思想就是建立堤坝阻止不同盆地的水汇合。 在一般分水岭算法中，通常是把一副彩色图像灰度化，然后再求梯度图， 最后在梯度图的基础上进行分水岭算法，求得分段图像的边缘线。如下所示是一个“地形”的剖面示意图。<br><img src="https://ws1.sinaimg.cn/large/006Xmmmggy1g56bvl2r4bj30hp0amweh.jpg"><br>以绿色虚线为界，左边表示地物1，右边表示地物2。A为地物1在当前范围内的最小值点， E为地物2在当前范围内的最小值点，两个盆地的交汇点为D。在地物1中C为小范围内的极小值点。</p>
<p>首先在两个盆地的最小值点A、E开始向盆地中注水，水会缓慢上升。 在两个盆地的水汇集的时刻，在交接的边缘线上(D点所在位置，也即分水岭线)， 建一个堤坝(图中黑色线段)，来阻止两个盆地的水汇集成一片水域。 这样图像就被分成2个像素集，一个是注水盆地像素集，一个是分水岭线像素集。</p>
<p>但仔细观察就会发现问题，传统的基于图像梯度的分水岭算法由于存在太多极小区域而产生许多小的集水盆地， 带来的结果就是图像过分割。 如图C点所在的极小值区域会形成一个小盆地，从而让地物1被分成两部分， 当C盆地的水和A盆地的水要汇合时，会在B点建立个水坝(图中灰色虚线)， 这显然不是我们想要的结果。 所以必须对分割相似的结果进行合并。 举个例子如一个桌面的图片，由于光照、纹理等因素，桌面会有很多明暗变化，反映在梯度图上就是一个个圈， 此时利用分水岭算法就会出现很多小盆地，从而分割出很多小区域。但这显而易见是不符合常识的。 因为桌面是一个整体，应该属于同一类，而不是因为纹理而分成不同的部分。</p>
<p>因此需要对分水岭算法进行改进。在OpenCV中采用的是基于标记的分水岭算法。 水淹过程从预先定义好的标记图像（像素）开始， 这样可以减少很多极小值点盆地产生的影响。 较好的克服了过度分割的不足。 本质上讲，基于标记点的改进算法是利用先验知识来帮助分割的一种方法。 对比如下图所示。<br><img src="https://ws1.sinaimg.cn/large/006Xmmmggy1g56bweiqxvj30i209ogmk.jpg"></p>
<h2 id="OpenCV实现"><a href="#OpenCV实现" class="headerlink" title="OpenCV实现"></a>OpenCV实现</h2><p>在OpenCV中实现分水岭算法可以使用cv2.watershed()函数实现，主要有以下步骤：</p>
<ol>
<li>输入图像，对图像进行二值化</li>
<li>对二值化后的图像进行噪声去除</li>
<li>通过腐蚀、膨胀运算对图像进行前景、背景标注</li>
<li>运用分水岭算法对图像进行分割<br>从调用API的角度而言，在整个过程中并没有对原始影像求梯度，而是直接进行二值化， 进行像素标记。然后将标记图像与原图一起传入函数。 具体求梯度的操作封装在了函数中，用户无需关心。</li>
</ol>
<p>具体实例如下，下面是待分割的影像。影像中有很多彼此连接的硬币， 我们需要将这些硬币彼此分开。<br><img src="https://ws4.sinaimg.cn/large/006Xmmmggy1g56bxmda6fj307008owen.jpg"><br>(1) 读取图像进行二值化操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">img = cv2.imread(<span class="string">&quot;E:\\coins.jpg&quot;</span>)</span><br><span class="line">gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span><br><span class="line">ret, thresh = cv2.threshold(gray, <span class="number">0</span>, <span class="number">255</span>, cv2.THRESH_OTSU + cv2.THRESH_BINARY_INV)</span><br></pre></td></tr></table></figure>
<p>需要注意的是，由于这里前景比背景颜色深，所以需要在二值化后反色操作一下。 下图是反色前与反色后的效果，我们希望得到的是右边的效果(前景比背景亮)。<br><img src="https://ws2.sinaimg.cn/large/006Xmmmggy1g56byzx4jtj30eb09imx0.jpg"></p>
<p>(2)对二值化图像进行噪声去除</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kernel = np.ones((<span class="number">3</span>, <span class="number">3</span>), np.uint8)</span><br><span class="line"><span class="built_in">open</span> = cv2.morphologyEx(thresh, cv2.MORPH_OPEN, kernel, iterations=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>仔细观察二值化后的图像，会发现有一些噪声点。如果这些噪声点不去除，则在后续步骤中会被标记成前景或背景， 从而影响分割。由前面形态学知识可知，对于白噪声，如黑色背景中的小白点，可以使用开运算(先腐蚀后膨胀)去除，效果很好。 同理，对于硬币中的黑色小洞(白色背景中的小黑点)，可以使用闭运算(先膨胀后腐蚀)。 在这里主要是白噪声，硬币内部并没有空洞，因此只需要进行开运算即可。完成后效果如下。<br><img src="https://ws2.sinaimg.cn/large/006Xmmmggy1g56bzysfhnj30ek09i3yc.jpg"></p>
<p>(3)图像标记<br>在完成了前期工作后，就可以对图像进行标记了。简单说来，对图像进行标记主要是将图像标记成三个部分： 前景(物体)、背景以及未知区域。 我们现在知道靠近对象中心的区域肯定是前景，而远离对象中心的区域肯定是背景，不能确定的区域即是图像边界。 对于前景区域，可以在第二步得到的图像上进行多次腐蚀运算， 这样就可以得到肯定是前景的区域。同样，对该图像进行多次膨胀运算，可以得到比前景大的范围， 除去这些范围的部分肯定是背景。至于在两者之间的就是未知区域，也就是需要运用分水岭算法， 从而给出分水岭边界的地方。</p>
<p>a.前景标记<br>提取肯定是硬币的区域(前景)，可以使用腐蚀操作。腐蚀操作可以去除边缘像素，剩下就可以肯定是硬币了。 当硬币之间没有接触时，这种操作是有效的。但是由于硬币之间是相互接触的， 我们就有了另外一个更好的选择：距离变换再加上合适的阈值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">distance_transform = cv2.distanceTransform(<span class="built_in">open</span>, <span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">ret, sure_fg = cv2.threshold(distance_transform, <span class="number">0.7</span> * distance_transform.<span class="built_in">max</span>(), <span class="number">255</span>, cv2.THRESH_BINARY)</span><br></pre></td></tr></table></figure>
<p>效果如下：<br><img src="https://ws1.sinaimg.cn/large/006Xmmmggy1g56c1cvv98j309z0bg0sr.jpg"><br><img src="https://ws3.sinaimg.cn/large/006Xmmmggy1g56c1cspgoj307709iq2p.jpg"></p>
<p>图中白色的部分我们可以肯定是硬币，也就是前景。</p>
<p>b.背景标记<br>背景标记相对简单。在开运算结果的基础上，对其进行多次膨胀。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sure_bg = cv2.dilate(<span class="built_in">open</span>, kernel, iterations=<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>结果如下：<br><img src="https://ws1.sinaimg.cn/large/006Xmmmggy1g56c2yivrzj307709i3ya.jpg"><br>图中黑色部分肯定是背景。</p>
<p>c.未知区域<br>背景、前景对比图如下：<br><img src="https://ws2.sinaimg.cn/large/006Xmmmggy1g56c3yp50ej30el09iglf.jpg"><br>所以可以用背景减去前景，就可以得到边界所在的范围，形成一个白色环。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sure_fg = np.uint8(sure_fg)</span><br><span class="line">unknown = cv2.subtract(sure_bg, sure_fg)</span><br></pre></td></tr></table></figure>
<p>需要注意的是，距离变换后获得的图像数据类型是float32，因此需要转成uint8才能和sure_bg做运算。 效果如下：<br><img src="https://ws4.sinaimg.cn/large/006Xmmmggy1g56c4vxubbj307709igle.jpg"></p>
<p>(4)创建标签<br>在知道了哪些肯定是前景区域后，就可以给它们创建标签了(一个与原图像大小相同，数据类型为int32的数组)。 对我们已经确定分类的区域（无论是前景还是背景）使用不同的正整数标记，对不确定的区域使用0标记。 我们可以使用函数cv2.connectedComponents()来完成。 它会把将背景标记为0，其它对象使用从1开始的正整数标记。 但我们知道如果背景标记为0，那分水岭算法就会把它当成未知区域了。 因此我们还需要对返回的结果进行一些修改，如统一加1或其它数字。 但这里不能减。因为OpenCV会把边界标记成负数。因此这里都使用正数。 在把背景和前景标记完后，最后是将未知区域标记为0。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ret, markers1 = cv2.connectedComponents(sure_fg)</span><br><span class="line">markers = markers1 + <span class="number">1</span></span><br><span class="line">markers[unknown == <span class="number">255</span>] = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>标记完成后，利用Matplotlib中Jet ColorMap显示效果如下：<br><img src="https://ws2.sinaimg.cn/large/006Xmmmgly1g56c5vxim1j309x0b93yc.jpg"><br>深蓝色区域为未知区域。肯定是硬币的区域使用不同的颜色标记。其余区域就是用浅蓝色标记的背景了。 这里不能使用OpenCV的cv2.imshow()显示，否则效果如下：<br><img src="https://ws1.sinaimg.cn/large/006Xmmmggy1g56c6iz8v9j307709i741.jpg"></p>
<p>原因是，由于每个像素的标记值都很小，而且彼此差异不大，所以在OpenCV中显示一片黑，灰度虽然和0有差别，但人眼几乎无法分辨。 所以不是理想的效果。如果要使用OpenCV显示，则需要先对标记影像进行拉伸，拉伸到0-255范围。</p>
<p>(5)实施分水岭算法<br>之前的工作都是为这一步做准备。这一步最核心，也最简单，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">markers3 = cv2.watershed(img, markers)</span><br><span class="line">img[markers3 == -<span class="number">1</span>] = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>]</span><br></pre></td></tr></table></figure>
<p>分割效果如下：<br><img src="https://ws2.sinaimg.cn/large/006Xmmmgly1g56c7nvj4pj30a30bddfp.jpg"><br><img src="https://ws3.sinaimg.cn/large/006Xmmmggy1g56c7nre97j307709i75c.jpg"></p>
<p>可以看到有些硬币边缘分割很好，有些不够好。</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开影像</span></span><br><span class="line">img = cv2.imread(<span class="string">&quot;E:\\coins.jpg&quot;</span>)</span><br><span class="line"><span class="comment"># 转换为灰度图</span></span><br><span class="line">gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 阈值+反色操作</span></span><br><span class="line"><span class="comment"># 注意将两个操作放在一起的用法</span></span><br><span class="line">ret, thresh = cv2.threshold(gray, <span class="number">0</span>, <span class="number">255</span>, cv2.THRESH_OTSU + cv2.THRESH_BINARY_INV)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进行开运算操作，去除噪声</span></span><br><span class="line">kernel = np.ones((<span class="number">3</span>, <span class="number">3</span>), np.uint8)</span><br><span class="line"><span class="built_in">open</span> = cv2.morphologyEx(thresh, cv2.MORPH_OPEN, kernel, iterations=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 膨胀操作获取背景</span></span><br><span class="line">sure_bg = cv2.dilate(<span class="built_in">open</span>, kernel, iterations=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 距离变换+阈值获取前景</span></span><br><span class="line"><span class="comment"># 距离变换第一个参数是输入图像</span></span><br><span class="line"><span class="comment"># 第二个参数是距离类型</span></span><br><span class="line"><span class="comment"># 第三个参数是范围大小</span></span><br><span class="line">distance_transform = cv2.distanceTransform(<span class="built_in">open</span>, cv2.DIST_L2, <span class="number">5</span>)</span><br><span class="line"><span class="comment"># 注意获取某幅图像最大值max()的用法</span></span><br><span class="line">ret, sure_fg = cv2.threshold(distance_transform, <span class="number">0.7</span> * distance_transform.<span class="built_in">max</span>(), <span class="number">255</span>, cv2.THRESH_BINARY)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 背景、前景相减，得到未知区域</span></span><br><span class="line">sure_fg = np.uint8(sure_fg)</span><br><span class="line">unknown = cv2.subtract(sure_bg, sure_fg)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 标记图像</span></span><br><span class="line">ret, markers1 = cv2.connectedComponents(sure_fg)</span><br><span class="line">markers = markers1 + <span class="number">1</span></span><br><span class="line"><span class="comment"># 注意这种简便用法</span></span><br><span class="line"><span class="comment"># markers和unknown是规模相等的两个矩阵</span></span><br><span class="line"><span class="comment"># 如果unknown某个元素为255，则在markers对应位置上的元素赋为0</span></span><br><span class="line">markers[unknown == <span class="number">255</span>] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用分水岭算法</span></span><br><span class="line">markers3 = cv2.watershed(img, markers)</span><br><span class="line"><span class="comment"># 注意OpenCV读取的图像顺序是BGR</span></span><br><span class="line"><span class="comment"># OpenCV中将分水岭边界标记为-1</span></span><br><span class="line">img[markers3 == -<span class="number">1</span>] = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示结果</span></span><br><span class="line">plt.imshow(markers3, cmap=<span class="string">&#x27;jet&#x27;</span>)</span><br><span class="line">cv2.imshow(<span class="string">&quot;result&quot;</span>, img)</span><br><span class="line">plt.show()</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/05/08/aliyun/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/08/aliyun/" class="post-title-link" itemprop="url">阿里云服务器：购买、连接和部署</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-05-08 00:00:00" itemprop="dateCreated datePublished" datetime="2019-05-08T00:00:00+08:00">2019-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/05/08/aliyun/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/05/08/aliyun/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这是记录一下第一次跟阿里云服务器打交道的过程。。</p>
<h1 id="购买"><a href="#购买" class="headerlink" title="购买"></a>购买</h1><p>阿里云服务器有两种：<br>（1）轻量应用服务器；<br>（2）云服务器ECS<br>两者的区别可以参考如下：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://yq.aliyun.com/articles/202688">ECS 还是轻量应用服务器，看完评测你就知道了</a></li>
<li><a target="_blank" rel="noopener" href="https://www.chukuangren.com/qingliang.html">轻量应用服务器和ecs云服务器怎么选?</a></li>
</ul>
<p>这里购买了Ubuntu服务器，所以下面的操作都是适用于Linux系统，关于Windows系统的配置详见阿里云文档。<br>配置为：2核 CPU | 2GB 内存 | 80GB SSD | 30Mbps 限制峰值带宽 | 3TB 每月流量 | 香港，<br>价格为：每月67元。</p>
<h1 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h1><p>有三种连接方式：</p>
<h2 id="浏览器直连："><a href="#浏览器直连：" class="headerlink" title="浏览器直连："></a>浏览器直连：</h2><p>直接通过浏览器点击网页上的“远程连接”，即可连接到购买的服务器。优点是不需要设置，无需密码，缺点是没法与本地互动，如传输文件等。</p>
<h2 id="SSH客户端使用账号密码进行连接"><a href="#SSH客户端使用账号密码进行连接" class="headerlink" title="SSH客户端使用账号密码进行连接"></a>SSH客户端使用账号密码进行连接</h2><p>这里的SSH客户端比如Windows系统下的Putty、Linux系统下的各种终端等。<br>首先要先设置管理员密码，具体方法见：<br><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/60055.html?spm=a2c4g.11186623.2.15.5e512eebolLgUZ">重置服务器密码</a><br>然后SSH客户端中配置Host、端口和密码等。<br>具体方法见：<br><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/59083.html?spm=5176.10173289.107.4.4db62e774lYrrT">通过账号密码方式连接</a><br>优点是能在本地操作服务器，且与本地进行互动，如下面的传输文件等。这种使用账号密码的方式的安全性要比下面的使用密钥要低一些。</p>
<h2 id="SSH客户端使用密钥进行连接："><a href="#SSH客户端使用密钥进行连接：" class="headerlink" title="SSH客户端使用密钥进行连接："></a>SSH客户端使用密钥进行连接：</h2><p>这种方式要比第二步的使用账号密码多了个密钥验证，所以更安全。<br>首先要先设置密钥并下载私钥，然后在各种SSH客户端中加载该私钥。具体的设置方式如下：<br><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/59083.html?spm=5176.10173289.107.4.4db62e774lYrrT">使用密钥方式连接</a><br>注意，开启密钥验证后，默认自动禁止使用账号密码登录。如需开启，也见上面链接。</p>
<h1 id="传输文件"><a href="#传输文件" class="headerlink" title="传输文件"></a>传输文件</h1><p>本地为Linux系统，可以在终端使用scp命令。<br>本地为Windows系统，推荐使用有图形化界面的WinSCP软件，下载链接为：<br><a target="_blank" rel="noopener" href="https://winscp.net/eng/index.php">WinSCP</a><br>跟上面配置SSH相同（注意如果启用了密钥验证，在WinSCP中也要通过Advanced加载私钥文件）。<br>然后就可以通过自由拖拽在本地和服务器之间方便地传输文件。</p>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><p>通过pip安装必要的包，比如flask、opencv-python、opencv-contrib-python、plotly等。<br>通过gunicorn来启动flask应用，使用方法见：<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e8d125372ca5">flask下 gunicorn在Python中的使用</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/y472360651/article/details/78538188">Gunicorn-配置详解</a><br>（注意这个地方踩了一个坑，主要是因为自己对网络编程不熟：gnicorn会使用多线程，而自己编写的程序中使用的是传统的Python的全局变量，而没有引用flask的那些与request、context相关的全局变量，导致在程序运行时每点一下按钮，会出现不同结果。）<br>一个较详细的部署教程见：<br><a target="_blank" rel="noopener" href="https://juejin.im/post/5a5a1408518825733060e232">通过Gunicorn部署flask应用（阿里云服务器：Ubuntu 16.04）</a><br>中间出现了以下几个问题，并给出解决方法：<br>（1）导入opencv时，报错：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ImportError: libSM.so<span class="number">.6</span>: cannot <span class="built_in">open</span> shared <span class="built_in">object</span> file: No such file <span class="keyword">or</span> directory</span><br><span class="line">ImportError: libXrender.so<span class="number">.1</span>: cannot <span class="built_in">open</span> shared <span class="built_in">object</span> file: No such file <span class="keyword">or</span> directory</span><br></pre></td></tr></table></figure>
<p>原因是：服务器在安装时没有安装图形库。解决方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libsm6 libxrender1</span><br></pre></td></tr></table></figure>
<p>参考见下面链接：<br><a target="_blank" rel="noopener" href="https://my.oschina.net/u/2422458/blog/1815712">服务器opencv-python使用问题及解决</a></p>
<p>（2）在执行到imgproc时，出现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError: Expected cv::UMat <span class="keyword">for</span> argument <span class="string">&#x27;M&#x27;</span></span><br></pre></td></tr></table></figure>
<p>怀疑是python2.7的锅，所以重新配置了pipenv，使用python3环境就好了。以下是具体配置过程：<br>（a）安装pip3<br>首先需要升级一下，否则阿里云找不到pip3：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br></pre></td></tr></table></figure>
<p>然后安装pip3：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install python3-pip</span><br></pre></td></tr></table></figure>
<p>然后使用pip3安装pipenv</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install pipenv</span><br></pre></td></tr></table></figure>
<p>使用pipenv创建虚拟环境时，指定python版本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipenv --python <span class="number">3</span> install</span><br></pre></td></tr></table></figure>
<p>（3）启动了flask服务器，但是外部无法连接，总是“time out”：<br>这是因为阿里云默认只开启几个端口，如果需要额外的端口，需要自己去防火墙那开启。<br>参考见：<br><a target="_blank" rel="noopener" href="https://yq.aliyun.com/ask/57796">在ecs上启动flask应用后，无法通过公网ip访问网站</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/03/17/ImagePy_1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/17/ImagePy_1/" class="post-title-link" itemprop="url">ImagePy解析：1 -- 简介、安装和启动</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-17 00:00:00" itemprop="dateCreated datePublished" datetime="2019-03-17T00:00:00+08:00">2019-03-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/03/17/ImagePy_1/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/17/ImagePy_1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ImagePy简介"><a href="#ImagePy简介" class="headerlink" title="ImagePy简介"></a>ImagePy简介</h1><p>“ImagePy是一款基于 Python 的可扩展图像处理框架，融合了ImageJ与Python的优势，是一个轻量级的、可扩展的图像处理框架。”（语出ImagePy官网：<a target="_blank" rel="noopener" href="http://www.imagepy.org/about/%EF%BC%89">http://www.imagepy.org/about/）</a><br>ImagePy作为一个GUI框架，可以快速接入opencv、scikit-image、mayavi等python的第三方库，因此，在功能性和易用性上都有很好的表现。<br>ImagePy的作者是闫霄龙yxdragon，目前是成都坐标创意科技有限公司的CEO，真牛人~~<br>项目的GitHub主页是：<a target="_blank" rel="noopener" href="https://github.com/Image-Py/imagepy">https://github.com/Image-Py/imagepy</a><br>GitHub上还有基于ImagePy的更多的扩展，比如opencv扩展、itk扩展、IBook扩展、海冰影像分析项目：<a target="_blank" rel="noopener" href="https://github.com/Image-Py">https://github.com/Image-Py</a><br>项目在知乎上的介绍：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/imagepy">https://zhuanlan.zhihu.com/imagepy</a><br>项目在image.sc上的讨论频道是：<a target="_blank" rel="noopener" href="https://forum.image.sc/tags/imagepy">https://forum.image.sc/tags/imagepy</a><br>闫霄龙的一个视频直播分享：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av39218282">B站</a>或<a target="_blank" rel="noopener" href="https://v.qq.com/x/page/b08204k4bjb.html">腾讯视频</a></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>如果想直接使用的话，可以直接下载release版本：<br><a target="_blank" rel="noopener" href="https://github.com/Image-Py/imagepy/releases">https://github.com/Image-Py/imagepy/releases</a><br>如果想二次开发的话，可以自己搭建python环境，并通过pip或conda安装必要的包，然后直接clone源码：<br><a target="_blank" rel="noopener" href="https://github.com/Image-Py/imagepy">https://github.com/Image-Py/imagepy</a></p>
<h1 id="设计架构"><a href="#设计架构" class="headerlink" title="设计架构"></a>设计架构</h1><p>如图：<br><img src="https://ws4.sinaimg.cn/large/006Xmmmggy1g5nhfqnr12j30qf0e20vv.jpg"></p>
<h2 id="展示层"><a href="#展示层" class="headerlink" title="展示层"></a>展示层</h2><p>即软件界面，包括菜单栏、工具条、状态栏、图像窗口等组成，ImagePy是基于wxPython来开发GUI。</p>
<h2 id="管理层"><a href="#管理层" class="headerlink" title="管理层"></a>管理层</h2><p>即系统底层，包括很多管理器，如插件管理器、工具管理器、图像窗口管理器等。</p>
<h2 id="逻辑层"><a href="#逻辑层" class="headerlink" title="逻辑层"></a>逻辑层</h2><p>即交互逻辑，将用户的界面操作与系统底层联系起来。同时该层也包括两种加载器：插件加载器PluginLoader和工具加载器ToolsLoader，来在软件初始化时来生成菜单栏和工具栏。</p>
<h1 id="设计思想"><a href="#设计思想" class="headerlink" title="设计思想"></a>设计思想</h1><p>ImagePy采用插件式设计思想，根据功能的形式，制定了多种引擎模板engines，即基类（比如Filter、Free、table、tool等基类）。具体功能都是它们的子类，按照一定方式组织起来，然后由相应的加载器Loader和管理器Manager维护。某种意义上说，功能即文件，菜单即目录。</p>
<h1 id="物理文件组织"><a href="#物理文件组织" class="headerlink" title="物理文件组织"></a>物理文件组织</h1><p>注意，这里是ImagePy 2019 7月份master分支的结构，不同版本可能有差别。<br>设计架构和设计思想要体现在具体的物理文件上，这里就体现了上面的“功能即文件，菜单即目录”。更具体地说，Python文件就是一个功能模块，或称功能包；ImagePy通过解析文件目录来生成GUI界面的菜单和目录。</p>
<h2 id="core包"><a href="#core包" class="headerlink" title="core包"></a>core包</h2><h3 id="wraper包"><a href="#wraper包" class="headerlink" title="wraper包"></a>wraper包</h3><p>里面包含了两个ImagePy自定义的图像封装类ImagePlus和表格封装类TablePlus，用于更灵活地操纵图像和表格。</p>
<h3 id="loader包"><a href="#loader包" class="headerlink" title="loader包"></a>loader包</h3><p>里面定义了如何解析插件Plugins和工具tools的函数。</p>
<h3 id="engine包"><a href="#engine包" class="headerlink" title="engine包"></a>engine包</h3><p>里面定义了前面所述的各种引擎模板，用作其他类的基类。<br>具体的比如有：</p>
<blockquote>
<p>Filter:滤波器基类，用于图像处理类的插件，它将帮助你做一系列的工作，比如处理多通道和图像栈、支持选区等。<br>Simple:简单插件基类，不同于Filter，它处理的对象不是图像，而是ImagePlus整体（比如处理图像栈或 ROI）<br>Free:自由插件基类，其运行不需要依赖图像，可以在任何情况下执行（比如图像的打开功能）<br>Macros:宏插件基类，它可以由一组命令字符串构成，并依次执行。<br>Tool:工具基类，定义一组鼠标事件的处理函数，可以在Canvas的鼠标事件中被回调。</p>
</blockquote>
<h3 id="roi包"><a href="#roi包" class="headerlink" title="roi包"></a>roi包</h3><p>包含各种选区操作，如点选区、线选区、多边形选区等。</p>
<h3 id="manager包"><a href="#manager包" class="headerlink" title="manager包"></a>manager包</h3><p>包含前面所述的各种管理器，如插件管理器等。</p>
<h2 id="ui包"><a href="#ui包" class="headerlink" title="ui包"></a>ui包</h2><p>包含与UI操作相关的功能包。如：</p>
<blockquote>
<p>Canvas:负责绘制ImagePlus，这其中包括绘制图像数据、绘制选区、以及 Mark 标记。<br>CanvasFrame:Canvas的包裹类，使之能以一个窗口的形式展示。<br>ParaDialog:参数交互类，图像处理的诸多函数有各种的参数，ParaDialog采用数据驱动视图的方式，可以自动生成各类交互对话框。<br>pluginloader:解析菜单栏<br>toolsloader：解析工具条</p>
</blockquote>
<h2 id="menus包"><a href="#menus包" class="headerlink" title="menus包"></a>menus包</h2><p>存放全部的插件，可以按照任意目录解析</p>
<h2 id="tools包"><a href="#tools包" class="headerlink" title="tools包"></a>tools包</h2><p>存放所有的工具。</p>
<h2 id="IPy"><a href="#IPy" class="headerlink" title="IPy"></a>IPy</h2><p>对一些常用功能的引用类，可以通过Ipy访问ImagePy的许多常用功能，比如打开图像、输出日志等。</p>
<h1 id="启动分析"><a href="#启动分析" class="headerlink" title="启动分析"></a>启动分析</h1><p>Windows下双击ImagePy.bat或Linux下运行ImagePy.sh，皆可启动ImagePy主程序，两者都是执行：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m imagepy</span><br></pre></td></tr></table></figure>
<p>ImagePy软件是以imagepy这个包来组织代码的，所以上面命令以模块形式运行imagepy，会首先运行该包的__init__.py文件，然后再运行__main__.py文件，这里面会有几个添加并识别路径的语句，保证程序能够被顺利找到。具体地：在__init__.py文件中先将系统路径切换到imagepy路径下，这样就可以通过相对路径来引用内部模块、图片等静态文件，然后在__main__.py中通过相对路径将上一层路径加入到sys.path中，从而让python能找到imagepy这个包，然后调用imagepy.show()这个方法开始真正执行具体的逻辑。</p>
<p>具体地，ImagePy使用wxPython作为GUI框架：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app = wx.<span class="built_in">App</span>(False) #创建application</span><br><span class="line"><span class="built_in">ImagePy</span>(None).<span class="built_in">Show</span>() #显示</span><br><span class="line">app.<span class="built_in">MainLoop</span>() #进入主循环，等待交互</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ImagePy类是自定义的继承自wx.Frame的框架。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2018/10/06/imagej-plugins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/06/imagej-plugins/" class="post-title-link" itemprop="url">ImageJ的插件开发</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-06 00:00:00" itemprop="dateCreated datePublished" datetime="2018-10-06T00:00:00+08:00">2018-10-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/10/06/imagej-plugins/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/06/imagej-plugins/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="开篇说明"><a href="#开篇说明" class="headerlink" title="开篇说明"></a>开篇说明</h1><p>前面介绍过开发ImageJ的Python脚本的过程（<a target="_blank" rel="noopener" href="http://qixinbo.info/2018/09/15/imagej-python/">在这里</a>），这里介绍怎样开发ImageJ的插件。<br>插件相对于脚本来说，一方面，它的功能更加强大，可以认为是寄生在ImageJ上面的一个完备的小程序；另一方面，它使用Java开发，格式可以采用编译好的class文件，有利于保护代码不被泄露。<br>ImageJ由于历史原因，存在着ImageJ1和ImageJ2两个版本，且两者的API是迥然不同的，底层架构更是不同，导致两者的开发套路有很大差别。在写这篇tutorial时，深感两者在网上的文档资源相互交叉，论坛里的答案在不同版本间有时不适用。所以这里尝试从零开始一步步地记录ImageJ2的插件开发过程。<br>所基于的Fiji/ImageJ版本为：<br><img src="https://ws1.sinaimg.cn/large/0072Lfvtly1fvylcrof71j30bg095wff.jpg"><br>参考资源有：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://imagej.net/Writing_plugins">Writing plugins</a></li>
<li><a target="_blank" rel="noopener" href="https://imagej.net/Developing_Fiji">Developing Fiji</a></li>
</ul>
<p>ImageJ1的开发的参考资源有：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://imagej.net/Developing_Plugins_for_ImageJ_1.x">Developing Plugins for ImageJ 1.x</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/imagej/example-legacy-plugin/">A simple Maven project implementing an ImageJ 1.x plugin</a></li>
</ul>
<h1 id="上手例子"><a href="#上手例子" class="headerlink" title="上手例子"></a>上手例子</h1><p>下载ImageJ的一个简单事例（在<a target="_blank" rel="noopener" href="https://github.com/imagej/example-imagej-command">这里</a>），看看插件的源代码是什么样子以及怎样编译和安装。</p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>这个例子是一个Maven工程（Maven是Java的一种项目管理软件），即遵循了Maven的代码约定：有一个关键的配置文件pom.xml，以及源代码放在src文件夹下。pom.xml文件中指明了src目录下的java源码的依赖，如果直接使用传统的javac编译该源码，就会报“找不到ij包”的错误，所以这里要使用Maven进行编译（Maven的下载、安装和配置不在这里赘述）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package</span><br></pre></td></tr></table></figure>
<p>上述命令就是使用Maven进行打包，结果就是生成target文件夹及下面的“GaussFiltering-0.1.0-SNAPSHOT.jar”这个jar包。<br>（Attention!!：这里生成的jar包中并没有下划线，这是ImageJ2允许的，它可以通过在源码的Plugin注解中指明menuPath即可在ImageJ对应菜单下显示，而ImageJ1则不允许，其明确要求jar包中必须有下划线，且它自定义在菜单中的显示是通过plugins.config配置文件指定，说明在<a target="_blank" rel="noopener" href="https://imagej.net/Description_of_ImageJ%27s_plugin_architecture">这里</a>）</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>第二步是将该jar包“安装”到Fiji目录中，这里就是直接复制过去就行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy target/GaussFiltering-0.1.0-SNAPSHOT.jar /Path/to/Fiji.app/plugins/</span><br></pre></td></tr></table></figure>
<p>然后启动Fiji（如果Fiji本来就运行着，则退出重启）。</p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>那么，这个插件怎么在Fiji中调用呢？有两种方法：</p>
<ul>
<li>直接使用命令查找功能，即Ctrl+l（小写的字母L），然后输入该插件的名字Gauss Filtering，这是最快捷的一种方式。</li>
<li>第二种方式是可以在Plugins菜单下找到Gauss Filtering该插件。默认情形下插件是安装在Plugins菜单下，但也可以在java源码中自定义，即在Plugin注解中指定参数menuPath，前面已提到过）。</li>
</ul>
<h2 id="使用IDE编译"><a href="#使用IDE编译" class="headerlink" title="使用IDE编译"></a>使用IDE编译</h2><p>上面是使用Maven的命令行进行编译，实际上Maven已经与常用的Java集成开发环境IDE进行了集成，同时IDE还方便对代码的编辑，所以推荐使用IDE进行源码编写和编译。<br>常用的Java开发的IDE有Eclipse、NetBeans和IDEA等，以下是三种软件打开Maven工程的方法：</p>
<ul>
<li>Eclipse：File &gt; Import &gt; Existing Maven Projects</li>
<li>NetBeans：File &gt; Open Project</li>
<li>IDEA：File &gt; Open Project (Select pom.xml)</li>
</ul>
<p>这里使用IDEA-2018-2进行操作，将pom.xml作为Project打开后，IDEA会根据pom中指定的依赖dependencies联网下载所依赖的jar包。然后点击左侧的Maven Projects，选择LifeCycle下面的Package，双击即可进行打包操作，如下：<br><img src="https://ws1.sinaimg.cn/large/0072Lfvtly1fvyiyh836ej30lb0g9my8.jpg"></p>
<h1 id="ImageJ插件开发的“Hello-World”"><a href="#ImageJ插件开发的“Hello-World”" class="headerlink" title="ImageJ插件开发的“Hello World”"></a>ImageJ插件开发的“Hello World”</h1><p>学习任何一名编程语言，第一个例子肯定是向新世界打招呼——“Hello, World!”。基于ImageJ开发的插件也不例外。从<a target="_blank" rel="noopener" href="https://github.com/imagej/tutorials/">这里</a>下载ImageJ的入门例子，其中就包含了“Hello, World!”的书写方式。</p>
<h2 id="编译运行"><a href="#编译运行" class="headerlink" title="编译运行"></a>编译运行</h2><p>依然是用IDEA-2018-2来打开该项目的pom.xml文件，点击窗口左侧的Maven Projects，找到”Simple ImageJ Commands”这个项目，然后在LifeCycle下双击package命令进行打包，如图：<br><img src="https://ws1.sinaimg.cn/large/0072Lfvtly1fvym64ybm2j31hc0suk0s.jpg"><br>生成jar包后，复制到Fiji的plugins文件夹下，重启Fiji，然后可以在Help菜单下发现”Hello, World!”命令。</p>
<h2 id="代码解析"><a href="#代码解析" class="headerlink" title="代码解析"></a>代码解析</h2><p>下面是一步步地分析HelloWorld的代码。</p>
<h3 id="插件声明"><a href="#插件声明" class="headerlink" title="插件声明"></a>插件声明</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Plugin(type = Command.class, headless = true, menuPath = &quot;Help&gt;Hello, World!&quot;)</span></span><br></pre></td></tr></table></figure>
<p>技术上讲，ImageJ插件是一个名为Plugin的注解（ImageJ基于SciJava插件系统），这样注解的类可以在运行时自动查找到并索引。有很多种插件类型，HelloWorld用的是Command类型的插件，这种类型的插件是应用最广泛的：Command接收输入，然后产生输出。Command插件最常用的就是与菜单绑定，这里使用menuPath指定在哪个菜单下显示及其显示名称。<br>关于插件，多说两句：<br>（1）插件类型<br>除了上面的Command类型的插件，还有一些基于Service的插件。显式地指定插件type后，可以有效地找到某种类型的插件。比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Plugin(type=Service.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> <span class="keyword">implements</span> <span class="title">Service</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Plugin(type=SpecialService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpecialService</span> <span class="keyword">implements</span> <span class="title">Service</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>那么问题来了，上述代码中，如果软件上下文想要的插件是Service，那么将会找到哪个插件？<br>答案是MyService和SpecialService都会返回，因为SpecialService是Service的Service的一个子类；而如果想要的是SpecialService插件，那么就只返回SpecialService类。<br>（2）插件优先级<br>当匹配的插件有很多时，插件会按类的priority的顺序来呈现，这个变量是double类型的数值，也可以使用已规定好的静态常量来表示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Plugin(priority=Priority.HIGH_PRIORITY)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> <span class="keyword">implements</span> <span class="title">Service</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Plugin(priority=224)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpecialService</span> <span class="keyword">implements</span> <span class="title">Service</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>那么问题是，当寻找Service插件时，上面哪个插件会排在前面？<br>答案是SpecialService，因为从<a target="_blank" rel="noopener" href="https://github.com/scijava/scijava-common/blob/scijava-common-2.47.0/src/main/java/org/scijava/Priority.java">SciJava-Common的源码</a>上可以看出HIGH_PRIORITY的数值是100。<br>更好的一种方式是使用相对优先级，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Plugin(priority=Priority.HIGH_PRIORITY+124)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpecialService</span> <span class="keyword">implements</span> <span class="title">Service</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<h3 id="该命令的输入输出，两者都是使用Parameter注解。"><a href="#该命令的输入输出，两者都是使用Parameter注解。" class="headerlink" title="该命令的输入输出，两者都是使用Parameter注解。"></a>该命令的输入输出，两者都是使用Parameter注解。</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> <span class="keyword">implements</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Parameter(label = &quot;What is your name?&quot;)</span></span><br><span class="line">	<span class="keyword">private</span> String name = <span class="string">&quot;J. Doe&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Parameter(type = ItemIO.OUTPUT)</span></span><br><span class="line">	<span class="keyword">private</span> String greeting;</span><br></pre></td></tr></table></figure>
<p>从command类中派生出helloWorld类。每个command类都有input和output，所以这里使用两个成员变量来承载，两者都要用Parameter来注解，所不同的是output需要Parameter的type明确指定为”ItemIO.OUTPUT”。<br>即，使用Parameter来注解的变量都是该命令的输入或输出，其中非Service类的变量会明确显示出来，而Service类的变量是用来隐式地调用。</p>
<h3 id="命令的运行函数"><a href="#命令的运行函数" class="headerlink" title="命令的运行函数"></a>命令的运行函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	greeting = <span class="string">&quot;Hello, &quot;</span> + name + <span class="string">&quot;!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的run函数是ImageJ的每个command的入口点，当用户点击菜单上的该命令时，先让用户输入input值，然后就会执行该函数。</p>
<h3 id="命令的调试"><a href="#命令的调试" class="headerlink" title="命令的调试"></a>命令的调试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String... args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// Launch ImageJ as usual.</span></span><br><span class="line">		<span class="keyword">final</span> ImageJ ij = <span class="keyword">new</span> ImageJ();</span><br><span class="line">		ij.launch(args);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Launch our &quot;Hello World&quot; command right away.</span></span><br><span class="line">		ij.command().run(HelloWorld.class, <span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码是用来在IDE中调试所用。通过创建main函数，使得IDE创建一个ImageJ的上下文环境，然后调用该插件。<br>更一般的调用方式是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ij.command().run(MyPlugin.class, <span class="string">&quot;inputImage&quot;</span>, myImage)&#125;</span><br></pre></td></tr></table></figure>

<p>这就是最基本的ImageJ插件。<br>上面的代码中除了HelloWorld，还包含了更多ImageJ插件开发的入门例子，自行探索吧！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2018/09/18/skopt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/18/skopt/" class="post-title-link" itemprop="url">使用skopt贝叶斯搜索寻找scikit-learn中算法的最优超参数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-18 00:00:00" itemprop="dateCreated datePublished" datetime="2018-09-18T00:00:00+08:00">2018-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/09/18/skopt/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/09/18/skopt/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>机器学习的寻找最优超参数是个老大难问题，scikit-learn提供了网格搜索GridSearchCV和随机搜索RandomizedSearchCV这两个函数来帮助寻找这些超参数。网格搜索的本质就是对参数空间形成的所有参数组合进行一个个的尝试，然后选出得分最高的那个，可能会忽略这些组合以外的参数，同时随着参数的增多，计算量也会指数增加。随机搜索是对参数的随机搜索，但没有充分利用搜索空间的结构。<br>skopt是一个超参数优化库，包括随机搜索、贝叶斯搜索、决策森林和梯度提升树等，用于辅助寻找机器学习算法中的最优超参数。这里是利用skopt的贝叶斯搜索来替代scikit-learn中的默认搜索方法，从而更快更好地寻找到最优超参数。<br>本文是对这个<a target="_blank" rel="noopener" href="https://scikit-optimize.github.io/notebooks/sklearn-gridsearchcv-replacement.html">官方文档</a>的翻译。</p>
<h1 id="上手实例"><a href="#上手实例" class="headerlink" title="上手实例"></a>上手实例</h1><p>用skopt来优化sklearn的支持向量机分类器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> skopt <span class="keyword">import</span> BayesSearchCV</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_digits</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line">X, y = load_digits(<span class="number">10</span>, <span class="literal">True</span>)</span><br><span class="line">X_train, X_test, y_train, y_test = train_test_split(X, y, train_size=<span class="number">0.75</span>, random_state=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">opt = BayesSearchCV(</span><br><span class="line">    SVC(),</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;C&#x27;</span>: (<span class="number">1e-6</span>, <span class="number">1e+6</span>, <span class="string">&#x27;log-uniform&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;gamma&#x27;</span>: (<span class="number">1e-6</span>, <span class="number">1e+1</span>, <span class="string">&#x27;log-uniform&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;degree&#x27;</span>: (<span class="number">1</span>, <span class="number">8</span>), <span class="comment"># 整型类型的空间</span></span><br><span class="line">        <span class="string">&#x27;kernel&#x27;</span>: [<span class="string">&#x27;linear&#x27;</span>, <span class="string">&#x27;poly&#x27;</span>, <span class="string">&#x27;rbf&#x27;</span>], <span class="comment"># Categorical类型的空间</span></span><br><span class="line">    &#125;,</span><br><span class="line">    n_iter = <span class="number">32</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">opt.fit(X_train, y_train)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;val. score: %s&quot;</span> % opt.best_score_)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;test score: %s&quot;</span> % opt.score(X_test, y_test))</span><br></pre></td></tr></table></figure>
<p>由上面定义的搜索空间可以看出，skopt只需给定参数的上下界即可，它会自动在此范围内寻找。注意那个log-uniform，这样指定的话，就会以通过改变x而改变exp(x)这样的形式变动参数。</p>
<h1 id="进阶实例"><a href="#进阶实例" class="headerlink" title="进阶实例"></a>进阶实例</h1><p>这个例子给出了使用多个模型及其对应的搜索空间：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> skopt <span class="keyword">import</span> BayesSearchCV</span><br><span class="line"><span class="keyword">from</span> skopt.space <span class="keyword">import</span> Real, Categorical, Integer</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_digits</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> LinearSVC, SVC</span><br><span class="line"><span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line">X, y = load_digits(<span class="number">10</span>, <span class="literal">True</span>)</span><br><span class="line">X_train, X_test, y_train, y_test = train_test_split(X, y, train_size=<span class="number">0.75</span>, random_state=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">pipe = Pipeline(</span><br><span class="line">    [</span><br><span class="line">        (<span class="string">&#x27;model&#x27;</span>, SVC())</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 隐式地指定参数类型</span></span><br><span class="line">linsvc_search = &#123;</span><br><span class="line">    <span class="string">&#x27;model&#x27;</span>: [LinearSVC(max_iter=<span class="number">10000</span>)],</span><br><span class="line">    <span class="string">&#x27;model__C&#x27;</span>: (<span class="number">1e-6</span>, <span class="number">1e+6</span>, <span class="string">&#x27;log-uniform&#x27;</span>),</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 显式地指定参数类型</span></span><br><span class="line">svc_search = &#123;</span><br><span class="line">    <span class="string">&#x27;model&#x27;</span>: Categorical([SVC()]),</span><br><span class="line">    <span class="string">&#x27;model__C&#x27;</span>: Real(<span class="number">1e-6</span>, <span class="number">1e+6</span>, prior=<span class="string">&#x27;log-uniform&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;model__gamma&#x27;</span>: Real(<span class="number">1e-6</span>, <span class="number">1e+1</span>, prior=<span class="string">&#x27;log-uniform&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;model__degree&#x27;</span>: Integer(<span class="number">1</span>,<span class="number">8</span>),</span><br><span class="line">    <span class="string">&#x27;model__kernel&#x27;</span>: Categorical([<span class="string">&#x27;linear&#x27;</span>, <span class="string">&#x27;poly&#x27;</span>, <span class="string">&#x27;rbf&#x27;</span>]),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">opt = BayesSearchCV(</span><br><span class="line">    pipe,</span><br><span class="line">    [(svc_search, <span class="number">20</span>), (linsvc_search, <span class="number">16</span>)], <span class="comment"># (parameter space, # of evaluations)</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">opt.fit(X_train, y_train)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;val. score: %s&quot;</span> % opt.best_score_)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;test score: %s&quot;</span> % opt.score(X_test, y_test))</span><br></pre></td></tr></table></figure>

<h1 id="使用fit函数的callback参数实现过程监控"><a href="#使用fit函数的callback参数实现过程监控" class="headerlink" title="使用fit函数的callback参数实现过程监控"></a>使用fit函数的callback参数实现过程监控</h1><p>可以实现在每一步子空间探索过程中通过一个事件句柄来监控BayesSearchCV的进度。对于串行任务，每一步评估后调用，对于并行任务，当并行执行了n_jobs后调用。<br>除此以外，如果callback返回了True，还可以停止进程。这可以用于当精度足够高时提前终止学习。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> skopt <span class="keyword">import</span> BayesSearchCV</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_iris</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br><span class="line"></span><br><span class="line">X, y = load_iris(<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">searchcv = BayesSearchCV(</span><br><span class="line">    SVC(),</span><br><span class="line">    search_spaces=&#123;<span class="string">&#x27;C&#x27;</span>: (<span class="number">0.01</span>, <span class="number">100.0</span>, <span class="string">&#x27;log-uniform&#x27;</span>)&#125;,</span><br><span class="line">    n_iter=<span class="number">10</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_step</span>(<span class="params">optim_result</span>):</span></span><br><span class="line">    score = searchcv.best_score_</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;best score: %s&quot;</span> % score)</span><br><span class="line">    <span class="keyword">if</span> score &gt;= <span class="number">0.98</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Interrupting!&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">searchcv.fit(X, y, callback=on_step)</span><br></pre></td></tr></table></figure>

<h1 id="计算探索所有子空间所需的总迭代次数"><a href="#计算探索所有子空间所需的总迭代次数" class="headerlink" title="计算探索所有子空间所需的总迭代次数"></a>计算探索所有子空间所需的总迭代次数</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> skopt <span class="keyword">import</span> BayesSearchCV</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_iris</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br><span class="line"></span><br><span class="line">X, y = load_iris(<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">searchcv = BayesSearchCV(</span><br><span class="line">    SVC(),</span><br><span class="line">    search_spaces=[</span><br><span class="line">        (&#123;<span class="string">&#x27;C&#x27;</span>: (<span class="number">0.1</span>, <span class="number">1.0</span>)&#125;, <span class="number">19</span>),  <span class="comment"># 19 iterations for this subspace</span></span><br><span class="line">        &#123;<span class="string">&#x27;gamma&#x27;</span>:(<span class="number">0.1</span>, <span class="number">1.0</span>)&#125;</span><br><span class="line">    ],</span><br><span class="line">    n_iter=<span class="number">23</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(searchcv.total_iterations)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2018/09/15/imagej-python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/15/imagej-python/" class="post-title-link" itemprop="url">ImageJ的Python脚本编程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-15 00:00:00" itemprop="dateCreated datePublished" datetime="2018-09-15T00:00:00+08:00">2018-09-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/09/15/imagej-python/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/09/15/imagej-python/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="开篇说明"><a href="#开篇说明" class="headerlink" title="开篇说明"></a>开篇说明</h1><p>原生ImageJ仅支持JS脚本，而ImageJ的衍生版本Fiji支持Python脚本编程，所以这里的ImageJ实际是Fiji。<br>本文是对这个<a target="_blank" rel="noopener" href="http://www.ini.uzh.ch/~acardona/fiji-tutorial/">Tutorial</a>的翻译。<br>Fiji官方的Jython指南在<a target="_blank" rel="noopener" href="https://imagej.net/Jython_Scripting">这里</a>。</p>
<h1 id="上手"><a href="#上手" class="headerlink" title="上手"></a>上手</h1><p>有两种方式可以打开脚本编辑器：</p>
<ul>
<li>通过File-New-Script打开。</li>
<li>使用Command finder：具体就是按字母“l”，然后输入script，然后选择下面的script。</li>
</ul>
<p>打开编辑器后，选择Language为Python。</p>
<h1 id="你的第一个Fiji脚本"><a href="#你的第一个Fiji脚本" class="headerlink" title="你的第一个Fiji脚本"></a>你的第一个Fiji脚本</h1><p>首先随便打开一个图片。</p>
<h2 id="获取打开的图片"><a href="#获取打开的图片" class="headerlink" title="获取打开的图片"></a>获取打开的图片</h2><p>在编辑器中输入以下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ</span><br><span class="line"></span><br><span class="line">imp = IJ.getImage()</span><br><span class="line"><span class="built_in">print</span> imp</span><br></pre></td></tr></table></figure>
<p>然后点击“Run”，或者使用快捷键“Ctrl+R”，这样程序就会运行，且在下方的窗口中打印出结果。<br>值得一提的是，imp是一个常用的名字，用来表示ImagePlus类的一个实例。ImagePlus是ImageJ表示一张图片的抽象，实际上在ImageJ中打开的每一个图像都是一个ImagePlus的实例。</p>
<p>注意：从下面可以看到，也可以通过IJ.openImage直接在脚本中获取某个未打开的图像。</p>
<h2 id="通过一个文件对话框保存图像"><a href="#通过一个文件对话框保存图像" class="headerlink" title="通过一个文件对话框保存图像"></a>通过一个文件对话框保存图像</h2><p>这里在图像上的第一个操作是“保存”它。<br>在编辑器中增加以下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij.io <span class="keyword">import</span> FileSaver</span><br><span class="line">fs = FileSaver(imp)</span><br><span class="line">fs.save()</span><br></pre></td></tr></table></figure>
<p>这部分代码是导入FileSaver这个命名空间，然后创建一个参数为上面imp的FileSaver的实例，然后调用它的save函数。</p>
<h2 id="将图像直接写入文件"><a href="#将图像直接写入文件" class="headerlink" title="将图像直接写入文件"></a>将图像直接写入文件</h2><p>编写脚本的一个目的是避免与人交互，因此这里直接将图像写入文件中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">folder = <span class="string">&quot;/home/qixinbo/temp/&quot;</span></span><br><span class="line">filepath = folder + <span class="string">&quot;boats.tif&quot;</span></span><br><span class="line">fs.saveAsTiff(filepath)</span><br></pre></td></tr></table></figure>
<p>这里指定了文件保存路径，然后调用FileSaver的saveAsTiff方法，同理还有saveAsPng、saveAsJpeg等。</p>
<h2 id="保存文件时事先检查路径和文件"><a href="#保存文件时事先检查路径和文件" class="headerlink" title="保存文件时事先检查路径和文件"></a>保存文件时事先检查路径和文件</h2><p>FileSaver将会覆盖给定路径下的文件，因此需要事先检查一下，防止误操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">folder = <span class="string">&quot;/home/qixinbo/temp/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> path.exists(folder) <span class="keyword">and</span> path.isdir(folder):</span><br><span class="line">	<span class="built_in">print</span> <span class="string">&quot;folder exists:&quot;</span>, folder</span><br><span class="line">	filepath = path.join(folder, <span class="string">&quot;boats.tif&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> path.exists(filepath):</span><br><span class="line">		<span class="built_in">print</span> <span class="string">&quot;File exists! Not saving the image, would overwrite a file!&quot;</span></span><br><span class="line">	<span class="keyword">elif</span> fs.saveAsTiff(filepath):</span><br><span class="line">		<span class="built_in">print</span> <span class="string">&quot;File saved successfully at &quot;</span>, filepath	</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="built_in">print</span> <span class="string">&quot;Folder does not exist or it&#x27;s not a folder!&quot;</span></span><br></pre></td></tr></table></figure>
<p>首先检查上面的folder是否存在及它是否是一个路径；然后检查该路径下是否有与要写入的文件有相同名字的文件，如果有，则提示，且不覆盖；最后检查FileSaver的saveAsTiff函数是否工作正常，如果该方法工作正常，将会返回true，因此这里会打印成功提示，否则则报错。</p>
<h1 id="探究图像的属性和像素"><a href="#探究图像的属性和像素" class="headerlink" title="探究图像的属性和像素"></a>探究图像的属性和像素</h1><p>如前所述，ImageJ或Fiji中的一张图像实际是ImagePlus类的一个实例。</p>
<h2 id="输出图片基本信息"><a href="#输出图片基本信息" class="headerlink" title="输出图片基本信息"></a>输出图片基本信息</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ, ImagePlus</span><br><span class="line"></span><br><span class="line">imp = IJ.getImage()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;title:&quot;</span>, imp.title</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;width:&quot;</span>, imp.width</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;height:&quot;</span>, imp.height</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;number of pixels:&quot;</span>, imp.width*imp.height</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;number of slices:&quot;</span>, imp.getNSlices()</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;number of channels:&quot;</span>, imp.getNChannels()</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;number of time frames:&quot;</span>, imp.getNFrames()</span><br><span class="line"></span><br><span class="line">types = &#123;ImagePlus.COLOR_RGB: <span class="string">&quot;RGB&quot;</span>,</span><br><span class="line">	ImagePlus.GRAY8: <span class="string">&quot;8-bit&quot;</span>,</span><br><span class="line">	ImagePlus.GRAY16: <span class="string">&quot;16-bit&quot;</span>,</span><br><span class="line">	ImagePlus.GRAY32: <span class="string">&quot;32-bit&quot;</span>,</span><br><span class="line">	ImagePlus.COLOR_256: <span class="string">&quot;8-bit color&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;image type:&quot;</span>, types[imp.<span class="built_in">type</span>]</span><br></pre></td></tr></table></figure>
<p>ImagePlus包含诸如图像标题、尺寸（宽度、高度、slices数目、时间帧数目、通道数目），以及像素（被包装在ImageProcessor实例中）。这些数据都是ImagePlus的field，可以通过点号来获取，如img.title就能得到图像标题，如果没有发现某些fields，可以通过get方法得到，如getNChannels得到通道数。<br>对于image的type，上述代码是定义了一个types字典，这样就通过键值对的方式更加直观地显示image的type。</p>
<h2 id="获得图像的像素统计"><a href="#获得图像的像素统计" class="headerlink" title="获得图像的像素统计"></a>获得图像的像素统计</h2><p>ImageJ/Fiji提供了ImageStatistics类做像素统计，其中又使用了这个类的getStatistics的静态方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ</span><br><span class="line"><span class="keyword">from</span> ij.process <span class="keyword">import</span> ImageStatistics <span class="keyword">as</span> IS</span><br><span class="line"></span><br><span class="line">imp = IJ.getImage()</span><br><span class="line"></span><br><span class="line">ip = imp.getProcessor()</span><br><span class="line"></span><br><span class="line">options = IS.MEAN | IS.MEDIAN | IS.MIN_MAX</span><br><span class="line">stats = IS.getStatistics(ip, options, imp.getCalibration())</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Image statistics for&quot;</span>, imp.title</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Mean:&quot;</span>, stats.mean</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Median:&quot;</span>, stats.median</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Min and max:&quot;</span>, stats.<span class="built_in">min</span>, <span class="string">&quot;-&quot;</span>, stats.<span class="built_in">max</span></span><br></pre></td></tr></table></figure>
<p>注意，用getProcessor得到像素信息。如果图像是stacks，那么使用StackStatistics。</p>
<p>如果是很多图片，该怎样做统计？可以像下面这样写一个函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ</span><br><span class="line"><span class="keyword">from</span> ij.process <span class="keyword">import</span> ImageStatistics <span class="keyword">as</span> IS</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">options = IS.MEAN | IS.MEDIAN | IS.MIN_MAX</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getStatistics</span>(<span class="params">imp</span>):</span></span><br><span class="line">	<span class="string">&quot;&quot;&quot; Return statistics for the given ImagePlus &quot;&quot;&quot;</span></span><br><span class="line">	<span class="keyword">global</span> options</span><br><span class="line">	ip = imp.getProcessor()	</span><br><span class="line">	stats = IS.getStatistics(ip, options, imp.getCalibration())	</span><br><span class="line">	<span class="keyword">return</span> stats.mean, stats.median, stats.<span class="built_in">min</span>, stats.<span class="built_in">max</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">folder = <span class="string">&quot;/home/qixinbo/temp/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(folder):</span><br><span class="line">	<span class="keyword">if</span> filename.endswith(<span class="string">&quot;.png&quot;</span>):</span><br><span class="line">		<span class="built_in">print</span> <span class="string">&quot;Processing&quot;</span>, filename</span><br><span class="line">		imp = IJ.openImage(os.path.join(folder, filename))</span><br><span class="line">		<span class="keyword">if</span> imp <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">			<span class="built_in">print</span> <span class="string">&quot;Could not open image from file:&quot;</span>, filename</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		mean, median, <span class="built_in">min</span>, <span class="built_in">max</span> = getStatistics(imp)</span><br><span class="line">		<span class="built_in">print</span> <span class="string">&quot;Image statistics for&quot;</span>, imp.title</span><br><span class="line">		<span class="built_in">print</span> <span class="string">&quot;Mean:&quot;</span>, mean</span><br><span class="line">		<span class="built_in">print</span> <span class="string">&quot;Median:&quot;</span>, median</span><br><span class="line">		<span class="built_in">print</span> <span class="string">&quot;Min and max:&quot;</span>, <span class="built_in">min</span>, <span class="string">&quot;-&quot;</span>, <span class="built_in">max</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="built_in">print</span> <span class="string">&quot;Ignoring&quot;</span>, filename</span><br></pre></td></tr></table></figure>

<h2 id="像素迭代"><a href="#像素迭代" class="headerlink" title="像素迭代"></a>像素迭代</h2><p>像素迭代是一个低层操作，很少用到。但如果真需要用到，下面提供了三种迭代方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> java.lang <span class="keyword">import</span> Float</span><br><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ</span><br><span class="line"></span><br><span class="line">imp = IJ.getImage()</span><br><span class="line"></span><br><span class="line">ip = imp.getProcessor().convertToFloat()</span><br><span class="line">pixels = ip.getPixels()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Image is&quot;</span>, imp.title, <span class="string">&quot;of type&quot;</span>, imp.<span class="built_in">type</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 1: the for loop, C style</span></span><br><span class="line">minimum = Float.MAX_VALUE</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="built_in">len</span>(pixels)):</span><br><span class="line">	<span class="keyword">if</span> pixels[i] &lt; minimum:</span><br><span class="line">		minimum = pixels[i]</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;1. Minimum is:&quot;</span>, minimum</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 2: iterate pixels as a list</span></span><br><span class="line">minimum = Float.MAX_VALUE</span><br><span class="line"><span class="keyword">for</span> pix <span class="keyword">in</span> pixels:</span><br><span class="line">	<span class="keyword">if</span> pix &lt; minimum:</span><br><span class="line">		minimum = pix</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;2. Minimum is:&quot;</span>, minimum</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 3: apply the built-in min function</span></span><br><span class="line"><span class="comment"># to the first pair of pixels,</span></span><br><span class="line"><span class="comment"># and then to the result of that and the next pixel, etc.</span></span><br><span class="line">minimum = reduce(<span class="built_in">min</span>, pixels)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;3. Minium is:&quot;</span>, minimum</span><br></pre></td></tr></table></figure>
<p>对于上面的pixels，根据不同类型的图像，可以有不同的形式，具体可以打印出来看一下。对于RGB图像，可以调用getBrightness来看看哪个像素最亮，可以通过ip.toFloat(0,None)来获得第一个通道。<br>上面使用了三种风格来处理像素列表，一种是C风格的形式，第二种是列表形式，第三种是函数式编程风格。</p>
<h2 id="对列表或集合的迭代或循环操作"><a href="#对列表或集合的迭代或循环操作" class="headerlink" title="对列表或集合的迭代或循环操作"></a>对列表或集合的迭代或循环操作</h2><p>对于上面三种处理列表的风格，前两种都使用了for循环来进行迭代，好处是特别容易理解，坏处是性能上会有点弱，且不简洁；第三种采用reduce这种函数式编程的风格，其他还有map、filter等操作，好处是性能好且形式简洁，但坏处是较难理解。<br>下面通过几个例子更详细地介绍这几种风格的对比。</p>
<h3 id="map操作"><a href="#map操作" class="headerlink" title="map操作"></a>map操作</h3><p>map操作接收一个长度为N的列表，然后施加一个函数，返回一个长度也为N的列表。比如，你想得到Fiji中打开的一系列的图片，如果用for循环，需要先显式创建一个列表，然后一个一个地把图片附加进去。<br>如果使用python的列表解析的语法糖，列表可以直接创建，然后在中括号里直接写上for循环的逻辑。因此，本质上它仍然是个序列化的循环，无法并行操作。<br>通过使用map，则可直接在ID列表中对每个ID进行WM.getImage作用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> WindowManager <span class="keyword">as</span> WM</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 1: with a for loop</span></span><br><span class="line">images = []</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">id</span> <span class="keyword">in</span> WM.getIDList():</span><br><span class="line">	images.append(WM.getImage(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 2: with list comprehension</span></span><br><span class="line">images = [WM.getImage(<span class="built_in">id</span>) <span class="keyword">for</span> <span class="built_in">id</span> <span class="keyword">in</span> WM.getIDList()]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 3: with a map openration</span></span><br><span class="line">images = <span class="built_in">map</span>(WM.getImage, WM.getIDList())</span><br></pre></td></tr></table></figure>

<h3 id="filter操作"><a href="#filter操作" class="headerlink" title="filter操作"></a>filter操作</h3><p>filter操作接收一个长度为N的列表，然后返回一个更短的列表，只有通过特定条件的元素才能进入到新列表中。比如下面这个列子就是找到Fiji打开的图片中标题中有特定字符串的图片。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> WindowManager <span class="keyword">as</span> WM</span><br><span class="line"></span><br><span class="line">imps = <span class="built_in">map</span>(WM.getImage, WM.getIDList())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">match</span>(<span class="params">imp</span>):</span></span><br><span class="line">	<span class="string">&quot;&quot;&quot; Returns true if the image title contains the word &#x27;boat&#x27; &quot;&quot;&quot;</span></span><br><span class="line">	<span class="keyword">return</span> imp.title.find(<span class="string">&quot;boat&quot;</span>) &gt; -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 1: with a for loop</span></span><br><span class="line">matching = []</span><br><span class="line"><span class="keyword">for</span> imp <span class="keyword">in</span> imps:</span><br><span class="line">	<span class="keyword">if</span> match(imp):</span><br><span class="line">		matching.append(imp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 2: with list comprehension</span></span><br><span class="line">matching = [imp <span class="keyword">for</span> imp <span class="keyword">in</span> imps <span class="keyword">if</span> match(imp)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 3: with a filter operation</span></span><br><span class="line">matching = <span class="built_in">filter</span>(match, imps)</span><br></pre></td></tr></table></figure>

<h3 id="reduce操作"><a href="#reduce操作" class="headerlink" title="reduce操作"></a>reduce操作</h3><p>reduce操作接收一个长度为N的列表，然后返回一个单值。比如你想找到Fiji当前打开的图片中面积最大的那个。如果使用for循环，需要设置临时变量，以及判断列表中是否有至少一个元素等，而使用reduce则不需要临时变量，只需要一个辅助函数（其实甚至这里只需要一个匿名lambda函数，但这里显式定义，从而更好理解及可用性更好）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ</span><br><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> WindowManager <span class="keyword">as</span> WM</span><br><span class="line"></span><br><span class="line">imps = <span class="built_in">map</span>(WM.getImage, WM.getIDList())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">area</span>(<span class="params">imp</span>):</span></span><br><span class="line">	<span class="keyword">return</span> imp.width * imp.height</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 1: with a for loop</span></span><br><span class="line">largest = <span class="literal">None</span></span><br><span class="line">largestArea = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> imp <span class="keyword">in</span> imps:</span><br><span class="line">	<span class="keyword">if</span> largest <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">		largest = imp</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		a = area(imp)</span><br><span class="line">		<span class="keyword">if</span> a &gt; largestArea:</span><br><span class="line">			largest = imp</span><br><span class="line">			largestArea = a</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 2: with a reduce operation</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">largestImage</span>(<span class="params">imp1, imp2</span>):</span></span><br><span class="line">	<span class="keyword">return</span> imp1 <span class="keyword">if</span> area(imp1) &gt; area(imp2) <span class="keyword">else</span> imp2</span><br><span class="line"></span><br><span class="line">largest = reduce(largestImage, imps)</span><br></pre></td></tr></table></figure>

<h2 id="对每一个像素减去最小值"><a href="#对每一个像素减去最小值" class="headerlink" title="对每一个像素减去最小值"></a>对每一个像素减去最小值</h2><p>首先使用上面的reduce方法得到最小的像素值，然后使用下面两种方法对每个像素减去该最小值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ, ImagePlus</span><br><span class="line"><span class="keyword">from</span> ij.process <span class="keyword">import</span> FloatProcessor</span><br><span class="line"></span><br><span class="line">imp = IJ.getImage()</span><br><span class="line">ip = imp.getProcessor().convertToFloat()</span><br><span class="line">pixels = ip.getPixels()</span><br><span class="line"></span><br><span class="line">minimum = reduce(<span class="built_in">min</span>, pixels)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 1: subtract the minimum from every pixel</span></span><br><span class="line"><span class="comment"># in place, modifying the pixels array</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="built_in">len</span>(pixels)):</span><br><span class="line">	pixels[i] -= minimum</span><br><span class="line"></span><br><span class="line">imp2 = ImagePlus(imp.title, ip)</span><br><span class="line">imp2.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 2: subtract the minimum from every pixel</span></span><br><span class="line"><span class="comment"># and store the result in a new array</span></span><br><span class="line">pixels3= <span class="built_in">map</span>(<span class="keyword">lambda</span> x: x-minimum, pixels)</span><br><span class="line">ip3 = FloatProcessor(ip.width, ip.height, pixels3, <span class="literal">None</span>)</span><br><span class="line">imp3 = ImagePlus(imp.title, ip3)</span><br><span class="line">imp3.show()</span><br></pre></td></tr></table></figure>

<h2 id="将像素列表概括为单值"><a href="#将像素列表概括为单值" class="headerlink" title="将像素列表概括为单值"></a>将像素列表概括为单值</h2><h3 id="统计在阈值以上的像素个数"><a href="#统计在阈值以上的像素个数" class="headerlink" title="统计在阈值以上的像素个数"></a>统计在阈值以上的像素个数</h3><p>本例将计算有多少像素在特定阈值之上，使用reduce函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ</span><br><span class="line"></span><br><span class="line">imp = IJ.getImage()</span><br><span class="line">ip = imp.getProcessor().convertToFloat()</span><br><span class="line">pixels = ip.getPixels()</span><br><span class="line"></span><br><span class="line">mean = <span class="built_in">sum</span>(pixels) / <span class="built_in">len</span>(pixels)</span><br><span class="line"></span><br><span class="line">n_pix_above = reduce(<span class="keyword">lambda</span> count, a: count+<span class="number">1</span> <span class="keyword">if</span> a &gt; mean <span class="keyword">else</span> count, pixels, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Mean value&quot;</span>, mean</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;% pixels above mean:&quot;</span>, n_pix_above / <span class="built_in">float</span>(<span class="built_in">len</span>(pixels)) * <span class="number">100</span></span><br></pre></td></tr></table></figure>
<h3 id="统计在阈值以上的所有像素的坐标，并计算重心"><a href="#统计在阈值以上的所有像素的坐标，并计算重心" class="headerlink" title="统计在阈值以上的所有像素的坐标，并计算重心"></a>统计在阈值以上的所有像素的坐标，并计算重心</h3><p>所有像素值在阈值（这里是均值）以上的坐标点都通过filter函数收集在一个列表中。注意，在ImageJ中，一张图像的所有像素都存储在一个线性数组中，数组的长度是width与height的乘积。因此，某个像素的索引除以width的余数（即模）是该像素的X坐标，索引除以width的商是该像素的Y坐标。<br>同时，给出了四种计算中心的方法，第一种是使用for循环，第二种是使用map和sum，第三种是使用reduce，第四种是对第三种的简化，使用了functools包中的partial函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ</span><br><span class="line"></span><br><span class="line">imp = IJ.getImage()</span><br><span class="line">ip = imp.getProcessor().convertToFloat()</span><br><span class="line">pixels = ip.getPixels()</span><br><span class="line"></span><br><span class="line">mean = <span class="built_in">sum</span>(pixels) / <span class="built_in">len</span>(pixels)</span><br><span class="line"></span><br><span class="line">above = <span class="built_in">filter</span>(<span class="keyword">lambda</span> i: pixels[i] &gt; mean, xrange(<span class="built_in">len</span>(pixels)))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Number of pixels above mean value:&quot;</span>, <span class="built_in">len</span>(above)</span><br><span class="line"></span><br><span class="line">width = imp.width</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 1: with a for loop</span></span><br><span class="line">xc = <span class="number">0</span></span><br><span class="line">yc = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> above:</span><br><span class="line">	xc += i % width</span><br><span class="line">	yc += i / width</span><br><span class="line">xc = xc / <span class="built_in">len</span>(above)</span><br><span class="line">yc = yc / <span class="built_in">len</span>(above)</span><br><span class="line"><span class="built_in">print</span> xc, yc</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 2: with sum and map</span></span><br><span class="line">xc = <span class="built_in">sum</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> i: i % width, above)) / <span class="built_in">len</span>(above)</span><br><span class="line">yc = <span class="built_in">sum</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> i: i / width, above)) / <span class="built_in">len</span>(above)</span><br><span class="line"><span class="built_in">print</span> xc, yc</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 3: iterating the list &quot;above&quot; just once</span></span><br><span class="line">xc, yc = [d / <span class="built_in">len</span>(above) <span class="keyword">for</span> d <span class="keyword">in</span> </span><br><span class="line">		reduce(<span class="keyword">lambda</span> c, i: [c[<span class="number">0</span>] + i%width, c[<span class="number">1</span>] + i/width], above, [<span class="number">0</span>,<span class="number">0</span>])]</span><br><span class="line"><span class="built_in">print</span> xc, yc</span><br><span class="line"></span><br><span class="line"><span class="comment"># Method 4: iterating the list &quot;above&quot; just once, more clearly and performant</span></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">accum</span>(<span class="params">width, c, i</span>):</span></span><br><span class="line">	c[<span class="number">0</span>] += i % width</span><br><span class="line">	c[<span class="number">1</span>] += i / width</span><br><span class="line">	<span class="keyword">return</span> c</span><br><span class="line">xc, yc = [d/<span class="built_in">len</span>(above) <span class="keyword">for</span> d <span class="keyword">in</span> reduce(partial(accum, width), above, [<span class="number">0</span>,<span class="number">0</span>])]</span><br><span class="line"><span class="built_in">print</span> xc, yc</span><br></pre></td></tr></table></figure>

<h1 id="运行ImageJ-Fiji插件"><a href="#运行ImageJ-Fiji插件" class="headerlink" title="运行ImageJ/Fiji插件"></a>运行ImageJ/Fiji插件</h1><p>下面是一个对当前图片施加中值滤波的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ, ImagePlus</span><br><span class="line"><span class="keyword">from</span> ij.plugin.<span class="built_in">filter</span> <span class="keyword">import</span> RankFilters</span><br><span class="line"></span><br><span class="line">imp = IJ.getImage()</span><br><span class="line">ip = imp.getProcessor().convertToFloat()</span><br><span class="line"></span><br><span class="line">radius = <span class="number">2</span></span><br><span class="line">RankFilters().rank(ip, radius, RankFilters.MEDIAN)</span><br><span class="line"></span><br><span class="line">imp2 = ImagePlus(imp.title + <span class="string">&quot; median filtered&quot;</span>, ip)</span><br><span class="line">imp2.show()</span><br></pre></td></tr></table></figure>
<h2 id="查找哪个类用了哪个插件"><a href="#查找哪个类用了哪个插件" class="headerlink" title="查找哪个类用了哪个插件"></a>查找哪个类用了哪个插件</h2><p>现在的问题是怎样知道上面的中值滤波在RankFilters中。可以通过Command Finder来查找。</p>
<h2 id="查找插件所需要的参数"><a href="#查找插件所需要的参数" class="headerlink" title="查找插件所需要的参数"></a>查找插件所需要的参数</h2><p>可以通过Macro Recorder来查看一个插件必要的参数。</p>
<ul>
<li>打开Plugins-Macros-Record</li>
<li>运行命令，比如上面的Process-Filters-Median。此时会出现一个对话框，要求输入半径，点击OK</li>
<li>查看Recorder窗口中的显示：run(“Median…”, “radius=2”);</li>
</ul>
<p>这说明中值滤波的一个必要参数就是radius。</p>
<h2 id="运行命令command"><a href="#运行命令command" class="headerlink" title="运行命令command"></a>运行命令command</h2><p>上面的插件plugin其实可以通过刚才录制的宏命令来替代：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IJ.run(imp, <span class="string">&quot;Median...&quot;</span>, <span class="string">&quot;radius=2&quot;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="创建图像及其ROI"><a href="#创建图像及其ROI" class="headerlink" title="创建图像及其ROI"></a>创建图像及其ROI</h1><h2 id="从零开始创建一张图像"><a href="#从零开始创建一张图像" class="headerlink" title="从零开始创建一张图像"></a>从零开始创建一张图像</h2><p>一张ImageJ/Fiji图像至少包含三个部分：</p>
<ul>
<li>像素数组：一个含有原始类型数据的数组，数据类型可以是byte、short、int或float</li>
<li>ImageProcessor子类实例：用来承载像素数组</li>
<li>ImagePlus实例：用来承载ImageProcessor实例</li>
</ul>
<p>下面的例子中创建了一个空的float型数组，然后用随机的浮点数填充，然后把它传给FloatProcessor，最后传给ImagePlus：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> ImagePlus</span><br><span class="line"><span class="keyword">from</span> ij.process <span class="keyword">import</span> FloatProcessor</span><br><span class="line"><span class="keyword">from</span> array <span class="keyword">import</span> zeros</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">width = <span class="number">1024</span></span><br><span class="line">height = <span class="number">1024</span></span><br><span class="line">pixels = zeros(<span class="string">&#x27;f&#x27;</span>, width * height)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="built_in">len</span>(pixels)):</span><br><span class="line">	pixels[i] = random()</span><br><span class="line"></span><br><span class="line">fp = FloatProcessor(width, height, pixels, <span class="literal">None</span>)</span><br><span class="line">imp = ImagePlus(<span class="string">&quot;White noise&quot;</span>, fp)</span><br><span class="line"></span><br><span class="line">imp.show()</span><br></pre></td></tr></table></figure>
<h2 id="用给定值填充一个ROI"><a href="#用给定值填充一个ROI" class="headerlink" title="用给定值填充一个ROI"></a>用给定值填充一个ROI</h2><p>为了填充一个ROI，我们可以对像素进行迭代，知道在ROI内部的像素，然后将它们的值设为指定值。但这个过程是繁杂且容易出错。更有效的方式是创建一个Roi类的实例或它的子类PolygonRoi、OvalRoi、ShapeRoi等的实例，然后告诉ImageProcessor来填充这个区域。<br>下面的例子使用了上面创建的白噪声图像，然后在其中定义了一个矩形区域，然后用2填充。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij.gui <span class="keyword">import</span> Roi, PolygonRoi</span><br><span class="line"></span><br><span class="line">roi = Roi(<span class="number">400</span>, <span class="number">200</span>, <span class="number">400</span>, <span class="number">300</span>)</span><br><span class="line">fp.setRoi(roi)</span><br><span class="line">fp.setValue(<span class="number">2.0</span>)</span><br><span class="line">fp.fill()</span><br><span class="line"></span><br><span class="line">imp.show()</span><br></pre></td></tr></table></figure>
<p>因为原来的白噪声的值是0到1的随机数，现在加上的值是2，是新的最大值，所以看起来是白色的。<br>在上面的代码基础上再增加一个新的多边形区域，用-3填充：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">xs = [<span class="number">234</span>, <span class="number">174</span>, <span class="number">162</span>, <span class="number">102</span>, <span class="number">120</span>, <span class="number">123</span>, <span class="number">153</span>, <span class="number">177</span>, <span class="number">171</span>,  </span><br><span class="line">      <span class="number">60</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">63</span>, <span class="number">132</span>, <span class="number">84</span>, <span class="number">129</span>, <span class="number">69</span>, <span class="number">174</span>, <span class="number">150</span>,  </span><br><span class="line">      <span class="number">183</span>, <span class="number">207</span>, <span class="number">198</span>, <span class="number">303</span>, <span class="number">231</span>, <span class="number">258</span>, <span class="number">234</span>, <span class="number">276</span>, <span class="number">327</span>,  </span><br><span class="line">      <span class="number">378</span>, <span class="number">312</span>, <span class="number">228</span>, <span class="number">225</span>, <span class="number">246</span>, <span class="number">282</span>, <span class="number">261</span>, <span class="number">252</span>]  </span><br><span class="line">ys = [<span class="number">48</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">18</span>, <span class="number">78</span>, <span class="number">156</span>, <span class="number">201</span>, <span class="number">213</span>, <span class="number">270</span>, <span class="number">279</span>,  </span><br><span class="line">      <span class="number">336</span>, <span class="number">405</span>, <span class="number">345</span>, <span class="number">348</span>, <span class="number">483</span>, <span class="number">615</span>, <span class="number">654</span>, <span class="number">639</span>, <span class="number">495</span>,  </span><br><span class="line">      <span class="number">444</span>, <span class="number">480</span>, <span class="number">648</span>, <span class="number">651</span>, <span class="number">609</span>, <span class="number">456</span>, <span class="number">327</span>, <span class="number">330</span>, <span class="number">432</span>,  </span><br><span class="line">      <span class="number">408</span>, <span class="number">273</span>, <span class="number">273</span>, <span class="number">204</span>, <span class="number">189</span>, <span class="number">126</span>, <span class="number">57</span>, <span class="number">6</span>]</span><br><span class="line">proi = PolygonRoi(xs, ys, <span class="built_in">len</span>(xs), Roi.POLYGON)</span><br><span class="line">fp.setRoi(proi)</span><br><span class="line">fp.setValue(-<span class="number">3</span>)</span><br><span class="line">fp.fill(proi.getMask()) <span class="comment"># Attention here!</span></span><br><span class="line"></span><br><span class="line">imp.show()</span><br></pre></td></tr></table></figure>

<h1 id="创建和操作图像的stacks和hyperstacks"><a href="#创建和操作图像的stacks和hyperstacks" class="headerlink" title="创建和操作图像的stacks和hyperstacks"></a>创建和操作图像的stacks和hyperstacks</h1><h2 id="加载一张多彩图像stack并提取绿色通道"><a href="#加载一张多彩图像stack并提取绿色通道" class="headerlink" title="加载一张多彩图像stack并提取绿色通道"></a>加载一张多彩图像stack并提取绿色通道</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ, ImagePlus, ImageStack</span><br><span class="line"></span><br><span class="line">imp = IJ.openImage(<span class="string">&quot;/home/qixinbo/temp/flybrain.zip&quot;</span>)</span><br><span class="line">stack = imp.getImageStack()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Number of slices:&quot;</span>, imp.getNSlices()</span><br><span class="line"></span><br><span class="line">greens = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, imp.getNSlices()+<span class="number">1</span>):</span><br><span class="line">	cp = stack.getProcessor(i) <span class="comment"># Get the ColorProcessor slice at index i</span></span><br><span class="line">	fp = cp.toFloat(<span class="number">1</span>, <span class="literal">None</span>) <span class="comment"># Get its green channel as a FloatProcessor</span></span><br><span class="line">	greens.append(fp) <span class="comment"># store it in a list</span></span><br><span class="line"></span><br><span class="line">stack2 = ImageStack(imp.width, imp.height) <span class="comment"># Create a new stack with only the green channel</span></span><br><span class="line"><span class="keyword">for</span> fp <span class="keyword">in</span> greens:</span><br><span class="line">	stack2.addSlice(<span class="literal">None</span>, fp)</span><br><span class="line"></span><br><span class="line">imp2 = ImagePlus(<span class="string">&quot;Green channel&quot;</span>, stack2) <span class="comment"># Create a new image with stack of green channel slices</span></span><br><span class="line">IJ.run(imp2, <span class="string">&quot;Green&quot;</span>, <span class="string">&quot;&quot;</span>) <span class="comment"># Set a green look-up table</span></span><br><span class="line">imp2.show()</span><br></pre></td></tr></table></figure>
<p>首先加载名为”Fly Brain”的样例。然后对它的slices进行迭代。每个slices都是一个ColorProcessor，它有一个toFloat的方法，可以得到一个特定颜色通道的FloatProcessor。将颜色通道用浮点数表示是最方便的处理像素值的方法，它不像字节类型那样会溢出。最后一个创建绿色的LUT命令，可以通过录制宏命令的形式得到具体的写法。如果不加这个绿色的LUT，整个图像虽然是绿色通道的像素值，但是以灰度图呈现的。</p>
<h2 id="将一个RGB-stack转换为双通道的32-bit-hyperstack"><a href="#将一个RGB-stack转换为双通道的32-bit-hyperstack" class="headerlink" title="将一个RGB stack转换为双通道的32-bit hyperstack"></a>将一个RGB stack转换为双通道的32-bit hyperstack</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ, ImagePlus, ImageStack, CompositeImage</span><br><span class="line"></span><br><span class="line">imp = IJ.openImage(<span class="string">&quot;/home/qixinbo/temp/flybrain.zip&quot;</span>)</span><br><span class="line">stack = imp.getImageStack()</span><br><span class="line"></span><br><span class="line">stack2 = ImageStack(imp.width, imp.height) <span class="comment"># Create a new stack with only the green channel</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, imp.getNSlices()+<span class="number">1</span>):</span><br><span class="line">	cp = stack.getProcessor(i) <span class="comment"># Get the ColorProcessor slice at index i</span></span><br><span class="line">	red = cp.toFloat(<span class="number">0</span>, <span class="literal">None</span>) <span class="comment"># Get the red channel as a FloatProcessor</span></span><br><span class="line">	green = cp.toFloat(<span class="number">1</span>, <span class="literal">None</span>) <span class="comment"># Get its green channel as a FloatProcessor</span></span><br><span class="line">	stack2.addSlice(<span class="literal">None</span>, red)</span><br><span class="line">	stack2.addSlice(<span class="literal">None</span>, green)</span><br><span class="line"></span><br><span class="line">imp2 = ImagePlus(<span class="string">&quot;32-bit 2-channel composite&quot;</span>, stack2)</span><br><span class="line">imp2.setCalibration(imp.getCalibration().copy())</span><br><span class="line"></span><br><span class="line">nChannels = <span class="number">2</span></span><br><span class="line">nSlices = stack.getSize()</span><br><span class="line">nFrames = <span class="number">1</span></span><br><span class="line">imp2.setDimensions(nChannels, nSlices, nFrames)</span><br><span class="line">comp = CompositeImage(imp2, CompositeImage.COLOR)</span><br><span class="line">comp.show()</span><br></pre></td></tr></table></figure>
<p>其中比较重要的是告诉hyperstack怎样解释它的图像，即setDimensions中的参数，即有多少个通道、多少个slices和多少个时间帧。</p>
<h1 id="人机交互：文件和选项对话框、消息、进度条"><a href="#人机交互：文件和选项对话框、消息、进度条" class="headerlink" title="人机交互：文件和选项对话框、消息、进度条"></a>人机交互：文件和选项对话框、消息、进度条</h1><h2 id="询问打开文件夹"><a href="#询问打开文件夹" class="headerlink" title="询问打开文件夹"></a>询问打开文件夹</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij.io <span class="keyword">import</span> DirectoryChooser</span><br><span class="line"></span><br><span class="line">dc = DirectoryChooser(<span class="string">&quot;Choose a folder&quot;</span>)</span><br><span class="line">folder = dc.getDirectory()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> folder <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">	<span class="built_in">print</span> <span class="string">&quot;User cancelled the dialog!&quot;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="built_in">print</span> <span class="string">&quot;Selected folder:&quot;</span>, folder</span><br></pre></td></tr></table></figure>
<h2 id="询问打开文件"><a href="#询问打开文件" class="headerlink" title="询问打开文件"></a>询问打开文件</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij.io <span class="keyword">import</span> OpenDialog</span><br><span class="line"></span><br><span class="line">od = OpenDialog(<span class="string">&quot;Choose a file&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">filename = od.getFileName()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> filename <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">	<span class="built_in">print</span> <span class="string">&quot;User canceled the dialog!&quot;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	directory = od.getDirectory()</span><br><span class="line">	filepath = directory + filename</span><br><span class="line">	<span class="built_in">print</span> <span class="string">&quot;Selected file path:&quot;</span>, filepath</span><br></pre></td></tr></table></figure>
<h2 id="询问输入参数"><a href="#询问输入参数" class="headerlink" title="询问输入参数"></a>询问输入参数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij.gui <span class="keyword">import</span> GenericDialog</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getOptions</span>():</span></span><br><span class="line">	gd = GenericDialog(<span class="string">&quot;Options&quot;</span>)</span><br><span class="line">	gd.addStringField(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Untitled&quot;</span>)</span><br><span class="line">	gd.addNumericField(<span class="string">&quot;alpha&quot;</span>, <span class="number">0.25</span>, <span class="number">2</span>)</span><br><span class="line">	gd.addCheckbox(<span class="string">&quot;Optimize&quot;</span>, <span class="literal">True</span>)</span><br><span class="line">	types = [<span class="string">&quot;8-bit&quot;</span>, <span class="string">&quot;16-bit&quot;</span>, <span class="string">&quot;32-bit&quot;</span>]</span><br><span class="line">	gd.addChoice(<span class="string">&quot;Output as&quot;</span>, types, types[<span class="number">2</span>])</span><br><span class="line">	gd.addSlider(<span class="string">&quot;Scale&quot;</span>, <span class="number">1</span>, <span class="number">100</span>, <span class="number">100</span>)</span><br><span class="line">	gd.showDialog()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> gd.wasCanceled():</span><br><span class="line">		<span class="built_in">print</span> <span class="string">&quot;User canceled dialog!&quot;</span></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">	name = gd.getNextString()</span><br><span class="line">	alpha = gd.getNextNumber()</span><br><span class="line">	optimize = gd.getNextBoolean()</span><br><span class="line">	output = gd.getNextChoice()</span><br><span class="line">	scale = gd.getNextNumber()</span><br><span class="line">	<span class="keyword">return</span> name, alpha, optimize, output, scale</span><br><span class="line"></span><br><span class="line">options = getOptions()</span><br><span class="line"><span class="keyword">if</span> options <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">	name, alpha, optimize, output, scale = options</span><br><span class="line">	<span class="built_in">print</span> name, alpha, optimize, output, scale</span><br></pre></td></tr></table></figure>

<h2 id="显示进度条"><a href="#显示进度条" class="headerlink" title="显示进度条"></a>显示进度条</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ</span><br><span class="line"></span><br><span class="line">imp = IJ.getImage()</span><br><span class="line">stack = imp.getImageStack()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, stack.getSize()+<span class="number">1</span>):</span><br><span class="line">	IJ.showProgress(i, stack.getSize()+<span class="number">1</span>)</span><br><span class="line">	ip = stack.getProcessor(i)</span><br><span class="line"></span><br><span class="line">IJ.showProgress(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h1 id="将脚本转换为插件"><a href="#将脚本转换为插件" class="headerlink" title="将脚本转换为插件"></a>将脚本转换为插件</h1><p>将脚本存储在Fiji插件文件夹或其子文件夹下，注意：</p>
<ul>
<li>文件名中要有一个下划线</li>
<li>后缀是.py</li>
</ul>
<p>比如”my_script.py”。然后运行“Help-Update Menus”，或者重启Fiji。<br>脚本就会作为”Plugins”中的菜单命令出现，也可以使用Command Finder找到。<br>插件文件夹在哪呢：对于Ubuntu和Windows系统，在Fiji.app文件夹中。</p>
<h1 id="列表、原生数组及与Java类的交互"><a href="#列表、原生数组及与Java类的交互" class="headerlink" title="列表、原生数组及与Java类的交互"></a>列表、原生数组及与Java类的交互</h1><h2 id="Jython列表以只读数组的形式传给Java类"><a href="#Jython列表以只读数组的形式传给Java类" class="headerlink" title="Jython列表以只读数组的形式传给Java类"></a>Jython列表以只读数组的形式传给Java类</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> java.awt.geom <span class="keyword">import</span> AffineTransform</span><br><span class="line"><span class="keyword">from</span> array <span class="keyword">import</span> array</span><br><span class="line"></span><br><span class="line">x = <span class="number">10</span></span><br><span class="line">y = <span class="number">40</span></span><br><span class="line"></span><br><span class="line">aff = AffineTransform(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">45</span>, <span class="number">56</span>)</span><br><span class="line"></span><br><span class="line">p = [x, y]</span><br><span class="line">aff.transform(p, <span class="number">0</span>, p, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span> p</span><br><span class="line"></span><br><span class="line">q = array(<span class="string">&#x27;f&#x27;</span>, [x, y])</span><br><span class="line">aff.transform(q, <span class="number">0</span>, q, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span> q</span><br></pre></td></tr></table></figure>
<p>上面的p没有被更新，而q被更新了，所以Jython列表只是可读，而array类型可写。</p>
<h2 id="创建原生数组"><a href="#创建原生数组" class="headerlink" title="创建原生数组"></a>创建原生数组</h2><p>array包有两个函数：</p>
<ul>
<li>zeros：创建空的原生数组</li>
<li>array：从列表或另一个相同类型的array中创建数组</li>
</ul>
<p>array的第一个参数是type。对于原生类型，如char、short、int、float、long和double，可以使用带引号的单个字母。下面的例子中创建了ImagePlus类型的array。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ</span><br><span class="line"><span class="keyword">from</span> array <span class="keyword">import</span> array, zeros</span><br><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> ImagePlus</span><br><span class="line"></span><br><span class="line">a = zeros(<span class="string">&#x27;f&#x27;</span>, <span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span> a</span><br><span class="line"></span><br><span class="line">b = array(<span class="string">&#x27;f&#x27;</span>, [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"><span class="built_in">print</span> b</span><br><span class="line"></span><br><span class="line">imps = zeros(ImagePlus, <span class="number">5</span>) <span class="comment"># An empty native ImagePlus array of length 5</span></span><br><span class="line"><span class="built_in">print</span> imps</span><br><span class="line"></span><br><span class="line">imps[<span class="number">0</span>] = IJ.getImage() <span class="comment"># Assign the current image to the first element of the array</span></span><br><span class="line"><span class="built_in">print</span> imps</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;length:&quot;</span>, <span class="built_in">len</span>(imps)</span><br></pre></td></tr></table></figure>

<h1 id="可作用于任意类型图像的通用算法：ImgLib库"><a href="#可作用于任意类型图像的通用算法：ImgLib库" class="headerlink" title="可作用于任意类型图像的通用算法：ImgLib库"></a>可作用于任意类型图像的通用算法：ImgLib库</h1><p>Imglib是一个处理n维数据的通用库，主要是面向图像处理。用Imglib编程能够极大地简化在不同类型图片上的操作。</p>
<h2 id="对图片进行数学操作"><a href="#对图片进行数学操作" class="headerlink" title="对图片进行数学操作"></a>对图片进行数学操作</h2><p>主要有以下几类的操作：</p>
<ul>
<li>script.imglib.math：提供操作每一个像素的函数。这些函数是可组合的，即某个函数的输出可作为另一个的输入。</li>
<li>script.imglib.color：提供创建和操纵彩色图片的函数，比如在RGB色彩空间中提取特定的色彩通道。</li>
<li>script.imglib.algorithm：提供诸如Gauss、Scale3D、Affine3D、Resample、Downsample等函数，一次对多个像素进行操作，而不是逐个像素的操作。一些函数可能改变图像的尺寸。这些算法全部都返回图像，换句话说，是对原始图像施加这些算法后得到的新图像。</li>
<li>script.imglib.analysis：提供提取或测量图像或者评价图像的函数。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> script.imglib.math <span class="keyword">import</span> Compute, Subtract</span><br><span class="line"><span class="keyword">from</span> script.imglib.color <span class="keyword">import</span> Red, Green, Blue, RGBA</span><br><span class="line"><span class="keyword">from</span> script.imglib <span class="keyword">import</span> ImgLib</span><br><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ</span><br><span class="line"></span><br><span class="line">imp = IJ.openImage(<span class="string">&quot;/home/qixinbo/temp/flybrain.zip&quot;</span>)</span><br><span class="line"></span><br><span class="line">img = ImgLib.wrap(imp) <span class="comment"># Wrap it as an Imglib image</span></span><br><span class="line"></span><br><span class="line">sub = Compute.inFloats(Subtract(Green(img), Red(img)))</span><br><span class="line"></span><br><span class="line">ImgLib.wrap(sub).show()</span><br><span class="line"></span><br><span class="line">rgb = RGBA(Red(img), Subtract(Green(img), Red(img)), Blue(img)).asImage()</span><br><span class="line"></span><br><span class="line">ImgLib.wrap(rgb).show()</span><br></pre></td></tr></table></figure>
<h2 id="使用图像数学进行平场校正"><a href="#使用图像数学进行平场校正" class="headerlink" title="使用图像数学进行平场校正"></a>使用图像数学进行平场校正</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> script.imglib.math <span class="keyword">import</span> Compute, Subtract, Divide, Multiply</span><br><span class="line"><span class="keyword">from</span> script.imglib.algorithm <span class="keyword">import</span> Gauss, Scale2D, Resample</span><br><span class="line"><span class="keyword">from</span> script.imglib <span class="keyword">import</span> ImgLib</span><br><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ</span><br><span class="line"></span><br><span class="line">img = ImgLib.wrap(IJ.openImage(<span class="string">&quot;/home/qixinbo/temp/bridge.gif&quot;</span>))</span><br><span class="line"></span><br><span class="line">brightfield = Resample(Gauss(Scale2D(img, <span class="number">0.25</span>), <span class="number">20</span>), img.getDimensions())  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 3. Simulate a perfect darkfield  </span></span><br><span class="line">darkfield = <span class="number">0</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 4. Compute the mean pixel intensity value of the image  </span></span><br><span class="line">mean = reduce(<span class="keyword">lambda</span> s, t: s + t.get(), img, <span class="number">0</span>) / img.size()  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 5. Correct the illumination  </span></span><br><span class="line">corrected = Compute.inFloats(Multiply(Divide(Subtract(img, brightfield),  </span><br><span class="line">                                             Subtract(brightfield, darkfield)), mean))  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 6. ... and show it in ImageJ  </span></span><br><span class="line">ImgLib.wrap(corrected).show() </span><br></pre></td></tr></table></figure>

<h2 id="提取和操纵图像色彩通道：RGBA和HSB"><a href="#提取和操纵图像色彩通道：RGBA和HSB" class="headerlink" title="提取和操纵图像色彩通道：RGBA和HSB"></a>提取和操纵图像色彩通道：RGBA和HSB</h2><p>下面的代码是对RGBA色彩空间的操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> script.imglib.math <span class="keyword">import</span> Compute, Subtract, Multiply  </span><br><span class="line"><span class="keyword">from</span> script.imglib.color <span class="keyword">import</span> Red, Blue, RGBA  </span><br><span class="line"><span class="keyword">from</span> script.imglib.algorithm <span class="keyword">import</span> Gauss, Dither</span><br><span class="line"><span class="keyword">from</span> script.imglib <span class="keyword">import</span> ImgLib</span><br><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Obtain a color image from the ImageJ samples    </span></span><br><span class="line">clown = ImgLib.wrap(IJ.openImage(<span class="string">&quot;https://imagej.nih.gov/ij/images/clown.jpg&quot;</span>))  </span><br><span class="line">    </span><br><span class="line"><span class="comment"># Example 1: compose a new image manipulating the color channels of the clown image:    </span></span><br><span class="line">img = RGBA(Gauss(Red(clown), <span class="number">10</span>), <span class="number">40</span>, Multiply(<span class="number">255</span>, Dither(Blue(clown)))).asImage()    </span><br><span class="line">    </span><br><span class="line">ImgLib.wrap(img).show()</span><br></pre></td></tr></table></figure>
<p>下面的代码是对HSB色彩空间的操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> script.imglib.math <span class="keyword">import</span> Compute, Add, Subtract  </span><br><span class="line"><span class="keyword">from</span> script.imglib.color <span class="keyword">import</span> HSB, Hue, Saturation, Brightness  </span><br><span class="line"><span class="keyword">from</span> script.imglib <span class="keyword">import</span> ImgLib  </span><br><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Obtain an image  </span></span><br><span class="line">img = ImgLib.wrap(IJ.openImage(<span class="string">&quot;https://imagej.nih.gov/ij/images/clown.jpg&quot;</span>))  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Obtain a new clown, whose hue has been shifted by half  </span></span><br><span class="line"><span class="comment"># with the same saturation and brightness of the original  </span></span><br><span class="line">bluey = Compute.inRGBA(HSB(Add(Hue(img), <span class="number">0.5</span>), Saturation(img), Brightness(img)))  </span><br><span class="line">  </span><br><span class="line">ImgLib.wrap(bluey).show()  </span><br></pre></td></tr></table></figure>
<p>下面的代码是对一个RGB confocal stack进行伽马校正：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Correct gamma  </span></span><br><span class="line"><span class="keyword">from</span> script.imglib.math <span class="keyword">import</span> Min, Max, Exp, Multiply, Divide, Log  </span><br><span class="line"><span class="keyword">from</span> script.imglib.color <span class="keyword">import</span> RGBA, Red, Green, Blue  </span><br><span class="line"><span class="keyword">from</span> script.imglib <span class="keyword">import</span> ImgLib</span><br><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ  </span><br><span class="line">  </span><br><span class="line">gamma = <span class="number">0.5</span>  </span><br><span class="line">img = ImgLib.wrap(IJ.openImage(<span class="string">&quot;/home/qixinbo/temp/flybrain.zip&quot;</span>))  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span>(<span class="params">channel, gamma</span>):</span>  </span><br><span class="line">  <span class="string">&quot;&quot;&quot; Return a function that, when evaluated, computes the gamma </span></span><br><span class="line"><span class="string">        of the given color channel. </span></span><br><span class="line"><span class="string">      If &#x27;i&#x27; was the pixel value, then this function would do: </span></span><br><span class="line"><span class="string">      double v = Math.exp(Math.log(i/255.0) * gamma) * 255.0); </span></span><br><span class="line"><span class="string">      if (v &lt; 0) v = 0; </span></span><br><span class="line"><span class="string">      if (v &gt;255) v = 255; </span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span>  </span><br><span class="line">  <span class="keyword">return</span> Min(<span class="number">255</span>, Max(<span class="number">0</span>, Multiply(Exp(Multiply(gamma, Log(Divide(channel, <span class="number">255</span>)))), <span class="number">255</span>)))  </span><br><span class="line">  </span><br><span class="line">corrected = RGBA(g(Red(img), gamma), g(Green(img), gamma), g(Blue(img), gamma)).asImage()  </span><br><span class="line">  </span><br><span class="line">ImgLib.wrap(corrected).show()</span><br></pre></td></tr></table></figure>
<h2 id="通过高斯差寻找、计数和显示三维stack中的cell"><a href="#通过高斯差寻找、计数和显示三维stack中的cell" class="headerlink" title="通过高斯差寻找、计数和显示三维stack中的cell"></a>通过高斯差寻找、计数和显示三维stack中的cell</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Load an image of the Drosophila larval fly brain and segment  </span></span><br><span class="line"><span class="comment"># the 5-micron diameter cells present in the red channel.  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">from</span> script.imglib.analysis <span class="keyword">import</span> DoGPeaks  </span><br><span class="line"><span class="keyword">from</span> script.imglib.color <span class="keyword">import</span> Red  </span><br><span class="line"><span class="keyword">from</span> script.imglib.algorithm <span class="keyword">import</span> Scale2D  </span><br><span class="line"><span class="keyword">from</span> script.imglib.math <span class="keyword">import</span> Compute  </span><br><span class="line"><span class="keyword">from</span> script.imglib <span class="keyword">import</span> ImgLib  </span><br><span class="line"><span class="keyword">from</span> ij3d <span class="keyword">import</span> Image3DUniverse  </span><br><span class="line"><span class="keyword">from</span> javax.vecmath <span class="keyword">import</span> Color3f, Point3f  </span><br><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ  </span><br><span class="line">  </span><br><span class="line">cell_diameter = <span class="number">5</span>  <span class="comment"># in microns  </span></span><br><span class="line">minPeak = <span class="number">40</span> <span class="comment"># The minimum intensity for a peak to be considered so.  </span></span><br><span class="line">imp = IJ.openImage(<span class="string">&quot;http://samples.fiji.sc/first-instar-brain.zip&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Scale the X,Y axis down to isotropy with the Z axis  </span></span><br><span class="line">cal = imp.getCalibration()  </span><br><span class="line">scale2D = cal.pixelWidth / cal.pixelDepth  </span><br><span class="line">iso = Compute.inFloats(Scale2D(Red(ImgLib.wrap(imp)), scale2D))  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Find peaks by difference of Gaussian  </span></span><br><span class="line">sigma = (cell_diameter  / cal.pixelWidth) * scale2D  </span><br><span class="line">peaks = DoGPeaks(iso, sigma, sigma * <span class="number">0.5</span>, minPeak, <span class="number">1</span>)  </span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Found&quot;</span>, <span class="built_in">len</span>(peaks), <span class="string">&quot;peaks&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Convert the peaks into points in calibrated image space  </span></span><br><span class="line">ps = []  </span><br><span class="line"><span class="keyword">for</span> peak <span class="keyword">in</span> peaks:  </span><br><span class="line">  p = Point3f(peak)  </span><br><span class="line">  p.scale(cal.pixelWidth * <span class="number">1</span>/scale2D)  </span><br><span class="line">  ps.append(p)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Show the peaks as spheres in 3D, along with orthoslices:  </span></span><br><span class="line">univ = Image3DUniverse(<span class="number">512</span>, <span class="number">512</span>)  </span><br><span class="line">univ.addIcospheres(ps, Color3f(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">2</span>, cell_diameter/<span class="number">2</span>, <span class="string">&quot;Cells&quot;</span>).setLocked(<span class="literal">True</span>)  </span><br><span class="line">univ.addOrthoslice(imp).setLocked(<span class="literal">True</span>)  </span><br><span class="line">univ.show()  </span><br></pre></td></tr></table></figure>

<h1 id="ImgLib2：编写通用且高性能的图像处理程序"><a href="#ImgLib2：编写通用且高性能的图像处理程序" class="headerlink" title="ImgLib2：编写通用且高性能的图像处理程序"></a>ImgLib2：编写通用且高性能的图像处理程序</h1><p>ImgLib2是一个非常强大的图像处理库：</p>
<ul>
<li>它的介绍在<a target="_blank" rel="noopener" href="https://academic.oup.com/bioinformatics/article/28/22/3009/240540">这篇论文</a>中</li>
<li>GitHub库在<a target="_blank" rel="noopener" href="https://github.com/imglib/imglib2">这里</a></li>
<li>ImageJ官网上关于ImgLib2的<a target="_blank" rel="noopener" href="https://imagej.net/ImgLib2_Examples">教学例子</a></li>
</ul>
<h2 id="ImgLib2对于图像的Views"><a href="#ImgLib2对于图像的Views" class="headerlink" title="ImgLib2对于图像的Views"></a>ImgLib2对于图像的Views</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ  </span><br><span class="line"><span class="keyword">from</span> net.imglib2.img.display.imagej <span class="keyword">import</span> ImageJFunctions <span class="keyword">as</span> IL  </span><br><span class="line"><span class="keyword">from</span> net.imglib2.view <span class="keyword">import</span> Views  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Load an image (of any dimensions) such as the clown sample image  </span></span><br><span class="line">imp = IJ.getImage()  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Convert to 8-bit if it isn&#x27;t yet, using macros  </span></span><br><span class="line">IJ.run(imp, <span class="string">&quot;8-bit&quot;</span>, <span class="string">&quot;&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Access its pixel data from an ImgLib2 RandomAccessibleInterval  </span></span><br><span class="line">img = IL.wrapReal(imp)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># View as an infinite image, with a value of zero beyond the image edges  </span></span><br><span class="line">imgE = Views.extendZero(img)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Limit the infinite image with an interval twice as large as the original,  </span></span><br><span class="line"><span class="comment"># so that the original image remains at the center.  </span></span><br><span class="line"><span class="comment"># It starts at minus half the image width, and ends at 1.5x the image width.  </span></span><br><span class="line">minC = [<span class="built_in">int</span>(-<span class="number">0.5</span> * img.dimension(i)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(img.numDimensions())]  </span><br><span class="line">maxC = [<span class="built_in">int</span>( <span class="number">1.5</span> * img.dimension(i)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(img.numDimensions())]  </span><br><span class="line">imgL = Views.interval(imgE, minC, maxC)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Visualize the enlarged canvas, so to speak  </span></span><br><span class="line">imp2 = IL.wrap(imgL, imp.getTitle() + <span class="string">&quot; - enlarged canvas&quot;</span>) <span class="comment"># an ImagePlus  </span></span><br><span class="line">imp2.show()</span><br></pre></td></tr></table></figure>
<p>对上面的图片的边缘进行填充：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">imgE = Views.extendMirrorSingle(img)  </span><br><span class="line">imgL = Views.interval(imgE, minC, maxC)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Visualize the enlarged canvas, so to speak  </span></span><br><span class="line">imp2 = IL.wrap(imgL, imp.getTitle() + <span class="string">&quot; - enlarged canvas&quot;</span>) <span class="comment"># an ImagePlus  </span></span><br><span class="line">imp2.show()  </span><br></pre></td></tr></table></figure>

<h2 id="ImgLib2的高斯差分检测"><a href="#ImgLib2的高斯差分检测" class="headerlink" title="ImgLib2的高斯差分检测"></a>ImgLib2的高斯差分检测</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">from ij <span class="keyword">import</span> IJ  </span><br><span class="line">from ij.gui <span class="keyword">import</span> PointRoi  </span><br><span class="line">from ij.measure <span class="keyword">import</span> ResultsTable  </span><br><span class="line">from net.imglib2.img.display.imagej <span class="keyword">import</span> ImageJFunctions as IL  </span><br><span class="line">from net.imglib2.view <span class="keyword">import</span> Views  </span><br><span class="line">from net.imglib2.algorithm.dog <span class="keyword">import</span> DogDetection  </span><br><span class="line">from jarray <span class="keyword">import</span> zeros  </span><br><span class="line">  </span><br><span class="line"># Load a greyscale single-channel image: the <span class="string">&quot;Embryos&quot;</span> sample image  </span><br><span class="line">imp = IJ.<span class="built_in">openImage</span>(<span class="string">&quot;https://imagej.nih.gov/ij/images/embryos.jpg&quot;</span>)  </span><br><span class="line"># Convert it to <span class="number">8</span>-bit  </span><br><span class="line">IJ.<span class="built_in">run</span>(imp, <span class="string">&quot;8-bit&quot;</span>, <span class="string">&quot;&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"># Access its pixel data from an ImgLib2 data structure: a RandomAccessibleInterval  </span><br><span class="line">img = IL.<span class="built_in">wrapReal</span>(imp)  </span><br><span class="line">  </span><br><span class="line"># View as an infinite image, mirrored at the edges which is ideal <span class="keyword">for</span> Gaussians  </span><br><span class="line">imgE = Views.<span class="built_in">extendMirrorSingle</span>(img)  </span><br><span class="line">  </span><br><span class="line"># Parameters <span class="keyword">for</span> a Difference of Gaussian to detect embryo positions  </span><br><span class="line">calibration = [<span class="number">1.0</span> <span class="keyword">for</span> i in <span class="built_in">range</span>(img.<span class="built_in">numDimensions</span>())] <span class="meta"># no calibration: identity  </span></span><br><span class="line">sigmaSmaller = <span class="number">15</span> <span class="meta"># in pixels: a quarter of the radius of an embryo  </span></span><br><span class="line">sigmaLarger = <span class="number">30</span>  <span class="meta"># pixels: half the radius of an embryo  </span></span><br><span class="line">extremaType = DogDetection.ExtremaType.MAXIMA  </span><br><span class="line">minPeakValue = <span class="number">10</span>  </span><br><span class="line">normalizedMinPeakValue = False  </span><br><span class="line">  </span><br><span class="line"># In the differece of gaussian peak detection, the img acts as the interval  </span><br><span class="line"><span class="meta"># within which to look for peaks. The processing is done on the infinite imgE.  </span></span><br><span class="line">dog = <span class="built_in">DogDetection</span>(imgE, img, calibration, sigmaSmaller, sigmaLarger,  </span><br><span class="line">  extremaType, minPeakValue, normalizedMinPeakValue)  </span><br><span class="line">  </span><br><span class="line">peaks = dog.<span class="built_in">getPeaks</span>()  </span><br><span class="line">  </span><br><span class="line"># Create a PointRoi from the DoG peaks, <span class="keyword">for</span> visualization  </span><br><span class="line">roi = <span class="built_in">PointRoi</span>(<span class="number">0</span>, <span class="number">0</span>)  </span><br><span class="line"># A temporary array of integers, one per dimension the image has  </span><br><span class="line">p = <span class="built_in">zeros</span>(img.<span class="built_in">numDimensions</span>(), <span class="string">&#x27;i&#x27;</span>)  </span><br><span class="line"># Load every peak as a point in the PointRoi  </span><br><span class="line"><span class="keyword">for</span> peak in peaks:  </span><br><span class="line">  # Read peak coordinates into an array of integers  </span><br><span class="line">  peak.<span class="built_in">localize</span>(p)  </span><br><span class="line">  roi.<span class="built_in">addPoint</span>(imp, p[<span class="number">0</span>], p[<span class="number">1</span>])  </span><br><span class="line">  </span><br><span class="line">imp.<span class="built_in">setRoi</span>(roi)  </span><br><span class="line">  </span><br><span class="line"># Now, iterate each peak, defining a small interval centered at each peak,  </span><br><span class="line"><span class="meta"># and measure the sum of total pixel intensity,  </span></span><br><span class="line"><span class="meta"># and display the results in an ImageJ ResultTable.  </span></span><br><span class="line">table = <span class="built_in">ResultsTable</span>()  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">for</span> peak in peaks:  </span><br><span class="line">  # Read peak coordinates into an array of integers  </span><br><span class="line">  peak.<span class="built_in">localize</span>(p)  </span><br><span class="line">  # Define limits of the interval around the peak:  </span><br><span class="line">  # (sigmaSmaller is half the radius of the embryo)  </span><br><span class="line">  minC = [p[i] - sigmaSmaller <span class="keyword">for</span> i in <span class="built_in">range</span>(img.<span class="built_in">numDimensions</span>())]  </span><br><span class="line">  maxC = [p[i] + sigmaSmaller <span class="keyword">for</span> i in <span class="built_in">range</span>(img.<span class="built_in">numDimensions</span>())]  </span><br><span class="line">  # View the interval around the peak, as a flat <span class="built_in">iterable</span> (like an array)  </span><br><span class="line">  fov = Views.<span class="built_in">interval</span>(img, minC, maxC)  </span><br><span class="line">  # Compute sum of pixel intensity values of the interval  </span><br><span class="line">  # (The t is the Type that mediates access to the pixels, via its get* methods)  </span><br><span class="line">  s = <span class="built_in">sum</span>(t.<span class="built_in">getInteger</span>() <span class="keyword">for</span> t in fov)  </span><br><span class="line">  # Add to results table  </span><br><span class="line">  table.<span class="built_in">incrementCounter</span>()  </span><br><span class="line">  table.<span class="built_in">addValue</span>(<span class="string">&quot;x&quot;</span>, p[<span class="number">0</span>])  </span><br><span class="line">  table.<span class="built_in">addValue</span>(<span class="string">&quot;y&quot;</span>, p[<span class="number">1</span>])  </span><br><span class="line">  table.<span class="built_in">addValue</span>(<span class="string">&quot;sum&quot;</span>, s)  </span><br><span class="line">  </span><br><span class="line">table.<span class="built_in">show</span>(<span class="string">&quot;Embryo intensities at peaks&quot;</span>)  </span><br></pre></td></tr></table></figure>
<p>此时会得到一个table。有两种方法来将table中的data存入一个CSV文件中：<br>第一种是直接在Table窗口中，点击File-Save，这是最简单的方式了。<br>第二种是使用python内置的csv库，在上面的代码中加入以下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> with_statement  </span><br><span class="line"><span class="comment"># IMPORTANT: imports from __future__ must go at the top of the file.  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># ... same code as above here to obtain the peaks  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> add  </span><br><span class="line"><span class="keyword">import</span> csv  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># The minumum and maximum coordinates, for each image dimension,  </span></span><br><span class="line"><span class="comment"># defining an interval within which pixel values will be summed.  </span></span><br><span class="line">minC = [-sigmaSmaller <span class="keyword">for</span> i <span class="keyword">in</span> xrange(img.numDimensions())]  </span><br><span class="line">maxC = [ sigmaSmaller <span class="keyword">for</span> i <span class="keyword">in</span> xrange(img.numDimensions())]  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">centerAt</span>(<span class="params">p, minC, maxC</span>):</span>  </span><br><span class="line">  <span class="string">&quot;&quot;&quot; Translate the minC, maxC coordinate bounds to the peak. &quot;&quot;&quot;</span>  </span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">map</span>(add, p, minC), <span class="built_in">map</span>(add, p, maxC)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">peakData</span>(<span class="params">peaks, p, minC, maxC</span>):</span>  </span><br><span class="line">  <span class="string">&quot;&quot;&quot; A generator function that returns all peaks and their pixel sum, </span></span><br><span class="line"><span class="string">      one at a time. &quot;&quot;&quot;</span>  </span><br><span class="line">  <span class="keyword">for</span> peak <span class="keyword">in</span> peaks:  </span><br><span class="line">    peak.localize(p)  </span><br><span class="line">    minCoords, maxCoords = centerAt(p, minC, maxC)  </span><br><span class="line">    fov = Views.interval(img, minCoords, maxCoords)  </span><br><span class="line">    s = <span class="built_in">sum</span>(t.getInteger() <span class="keyword">for</span> t <span class="keyword">in</span> fov)  </span><br><span class="line">    <span class="keyword">yield</span> p, s  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Save as CSV file  </span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/tmp/peaks.csv&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> csvfile:  </span><br><span class="line">  w = csv.writer(csvfile, delimiter=<span class="string">&#x27;,&#x27;</span>, quotechar=<span class="string">&#x27;&quot;&#x27;</span><span class="string">&#x27;&quot;&#x27;</span>, quoting=csv.QUOTE_NONNUMERIC) </span><br><span class="line">  w.writerow([<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;sum&#x27;</span>]) </span><br><span class="line">  <span class="keyword">for</span> p, s <span class="keyword">in</span> peakData(peaks, p, minC, maxC): </span><br><span class="line">    w.writerow([p[<span class="number">0</span>], p[<span class="number">1</span>], s]) </span><br><span class="line"> </span><br><span class="line"><span class="comment"># Read the CSV file into an ROI </span></span><br><span class="line">roi = PointRoi(<span class="number">0</span>, <span class="number">0</span>) </span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/tmp/peaks.csv&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> csvfile: </span><br><span class="line">  reader = csv.reader(csvfile, delimiter=<span class="string">&#x27;,&#x27;</span>, quotechar=<span class="string">&#x27;&quot;&#x27;</span>)  </span><br><span class="line">  header = reader.<span class="built_in">next</span>() <span class="comment"># advance reader by one line  </span></span><br><span class="line">  <span class="keyword">for</span> x, y, s <span class="keyword">in</span> reader:  </span><br><span class="line">    roi.addPoint(imp, <span class="built_in">float</span>(x), <span class="built_in">float</span>(y))  </span><br><span class="line">  </span><br><span class="line">imp.show()  </span><br><span class="line">imp.setRoi(roi)  </span><br></pre></td></tr></table></figure>
<h2 id="使用ImgLib2进行图像变换"><a href="#使用ImgLib2进行图像变换" class="headerlink" title="使用ImgLib2进行图像变换"></a>使用ImgLib2进行图像变换</h2><p>以下是使用ImgLib2进行图像变换，如平移、旋转、缩放等。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> net.imglib2.realtransform <span class="keyword">import</span> RealViews <span class="keyword">as</span> RV  </span><br><span class="line"><span class="keyword">from</span> net.imglib2.img.display.imagej <span class="keyword">import</span> ImageJFunctions <span class="keyword">as</span> IL  </span><br><span class="line"><span class="keyword">from</span> net.imglib2.realtransform <span class="keyword">import</span> Scale  </span><br><span class="line"><span class="keyword">from</span> net.imglib2.view <span class="keyword">import</span> Views  </span><br><span class="line"><span class="keyword">from</span> net.imglib2.interpolation.randomaccess <span class="keyword">import</span> NLinearInterpolatorFactory  </span><br><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Load an image (of any dimensions)  </span></span><br><span class="line">imp = IJ.getImage()  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Access its pixel data as an ImgLib2 RandomAccessibleInterval  </span></span><br><span class="line">img = IL.wrapReal(imp)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># View as an infinite image, with a value of zero beyond the image edges  </span></span><br><span class="line">imgE = Views.extendZero(img)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># View the pixel data as a RealRandomAccessible  </span></span><br><span class="line"><span class="comment"># (that is, accessible with sub-pixel precision)  </span></span><br><span class="line"><span class="comment"># by using an interpolator  </span></span><br><span class="line">imgR = Views.interpolate(imgE, NLinearInterpolatorFactory())  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Obtain a view of the 2D image twice as big  </span></span><br><span class="line">s = [<span class="number">2.0</span> <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(img.numDimensions())] <span class="comment"># as many 2.0 as image dimensions  </span></span><br><span class="line">bigger = RV.transform(imgR, Scale(s))  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Define the interval we want to see: the original image, enlarged by 2X  </span></span><br><span class="line"><span class="comment"># E.g. from 0 to 2*width, from 0 to 2*height, etc. for every dimension  </span></span><br><span class="line">minC = [<span class="number">0</span> <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(img.numDimensions())]  </span><br><span class="line">maxC = [<span class="built_in">int</span>(img.dimension(i) * scale) <span class="keyword">for</span> i, scale <span class="keyword">in</span> <span class="built_in">enumerate</span>(s)]  </span><br><span class="line">imgI = Views.interval(bigger, minC, maxC)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Visualize the bigger view  </span></span><br><span class="line">imp2x = IL.wrap(imgI, imp.getTitle() + <span class="string">&quot; - 2X&quot;</span>) <span class="comment"># an ImagePlus  </span></span><br><span class="line">imp2x.show()  </span><br></pre></td></tr></table></figure>

<h2 id="使用ImgLib2旋转图片"><a href="#使用ImgLib2旋转图片" class="headerlink" title="使用ImgLib2旋转图片"></a>使用ImgLib2旋转图片</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> net.imglib2.realtransform <span class="keyword">import</span> RealViews <span class="keyword">as</span> RV  </span><br><span class="line"><span class="keyword">from</span> net.imglib2.realtransform <span class="keyword">import</span> AffineTransform  </span><br><span class="line"><span class="keyword">from</span> net.imglib2.img.display.imagej <span class="keyword">import</span> ImageJFunctions <span class="keyword">as</span> IL  </span><br><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ  </span><br><span class="line"><span class="keyword">from</span> net.imglib2.view <span class="keyword">import</span> Views  </span><br><span class="line"><span class="keyword">from</span> net.imglib2.interpolation.randomaccess <span class="keyword">import</span> NLinearInterpolatorFactory  </span><br><span class="line"><span class="keyword">from</span> java.awt.geom <span class="keyword">import</span> AffineTransform <span class="keyword">as</span> Affine2D  </span><br><span class="line"><span class="keyword">from</span> java.awt <span class="keyword">import</span> Rectangle  </span><br><span class="line"><span class="keyword">from</span> Jama <span class="keyword">import</span> Matrix  </span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> radians  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Load an image (of any dimensions)  </span></span><br><span class="line">imp = IJ.getImage()  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Access its pixel data as an ImgLib2 RandomAccessibleInterval  </span></span><br><span class="line">img = IL.wrapReal(imp)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># View as an infinite image, with value zero beyond the image edges  </span></span><br><span class="line">imgE = Views.extendZero(img)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># View the pixel data as a RealRandomAccessible  </span></span><br><span class="line"><span class="comment"># (that is, accessible with sub-pixel precision)  </span></span><br><span class="line"><span class="comment"># by using an interpolator  </span></span><br><span class="line">imgR = Views.interpolate(imgE, NLinearInterpolatorFactory())  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Define a rotation by +30 degrees relative to the image center in the XY axes  </span></span><br><span class="line"><span class="comment"># (not explicitly XY but the first two dimensions)  </span></span><br><span class="line"><span class="comment"># by filling in a rotation matrix with values taken  </span></span><br><span class="line"><span class="comment"># from a java.awt.geom.AffineTransform (aliased as Affine2D)  </span></span><br><span class="line"><span class="comment"># and by filling in the rest of the diagonal with 1.0  </span></span><br><span class="line"><span class="comment"># (for the case where the image has more than 2 dimensions)  </span></span><br><span class="line">angle = radians(<span class="number">30</span>)  </span><br><span class="line">rot2d = Affine2D.getRotateInstance(  </span><br><span class="line">  angle, img.dimension(<span class="number">0</span>) / <span class="number">2</span>, img.dimension(<span class="number">1</span>) / <span class="number">2</span>)  </span><br><span class="line">ndims = img.numDimensions()  </span><br><span class="line">matrix = Matrix(ndims, ndims + <span class="number">1</span>)  </span><br><span class="line">matrix.<span class="built_in">set</span>(<span class="number">0</span>, <span class="number">0</span>, rot2d.getScaleX())  </span><br><span class="line">matrix.<span class="built_in">set</span>(<span class="number">0</span>, <span class="number">1</span>, rot2d.getShearX())  </span><br><span class="line">matrix.<span class="built_in">set</span>(<span class="number">0</span>, ndims, rot2d.getTranslateX())  </span><br><span class="line">matrix.<span class="built_in">set</span>(<span class="number">1</span>, <span class="number">0</span>, rot2d.getShearY())  </span><br><span class="line">matrix.<span class="built_in">set</span>(<span class="number">1</span>, <span class="number">1</span>, rot2d.getScaleY())  </span><br><span class="line">matrix.<span class="built_in">set</span>(<span class="number">1</span>, ndims, rot2d.getTranslateY())  </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, img.numDimensions()):  </span><br><span class="line">  matrix.<span class="built_in">set</span>(i, i, <span class="number">1.0</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="built_in">print</span> matrix.getArray()  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Define a rotated view of the image  </span></span><br><span class="line">rotated = RV.transform(imgR, AffineTransform(matrix))  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># View the image rotated, without enlarging the canvas  </span></span><br><span class="line"><span class="comment"># so we define the interval as the original image dimensions.  </span></span><br><span class="line"><span class="comment"># (Notice the -1 on the max coordinate: the interval is inclusive)  </span></span><br><span class="line">minC = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(img.numDimensions())]  </span><br><span class="line">maxC = [img.dimension(i) -<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(img.numDimensions())]  </span><br><span class="line">imgRot2d = IL.wrap(Views.interval(rotated, minC, maxC),  </span><br><span class="line">  imp.getTitle() + <span class="string">&quot; - rot2d&quot;</span>)  </span><br><span class="line">imgRot2d.show()  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># View the image rotated, enlarging the interval to fit it.  </span></span><br><span class="line"><span class="comment"># (This is akin to enlarging the canvas.)  </span></span><br><span class="line"><span class="comment"># We compute the bounds of the enlarged canvas by transforming a rectangle,  </span></span><br><span class="line"><span class="comment"># then define the interval min and max coordinates by subtracting  </span></span><br><span class="line"><span class="comment"># and adding as appropriate to exactly capture the complete rotated image.  </span></span><br><span class="line"><span class="comment"># Notice the min coordinates have negative values, as the rotated image  </span></span><br><span class="line"><span class="comment"># has pixels now somewhere to the left and up from the top-left 0,0 origin  </span></span><br><span class="line"><span class="comment"># of coordinates.  </span></span><br><span class="line">bounds = rot2d.createTransformedShape(  </span><br><span class="line">  Rectangle(img.dimension(<span class="number">0</span>), img.dimension(<span class="number">1</span>))).getBounds()  </span><br><span class="line">minC[<span class="number">0</span>] = (img.dimension(<span class="number">0</span>) - bounds.width) / <span class="number">2</span>  </span><br><span class="line">minC[<span class="number">1</span>] = (img.dimension(<span class="number">1</span>) - bounds.height) / <span class="number">2</span>  </span><br><span class="line">maxC[<span class="number">0</span>] += <span class="built_in">abs</span>(minC[<span class="number">0</span>]) -<span class="number">1</span> <span class="comment"># -1 because its inclusive  </span></span><br><span class="line">maxC[<span class="number">1</span>] += <span class="built_in">abs</span>(minC[<span class="number">1</span>]) -<span class="number">1</span>  </span><br><span class="line">imgRot2dFit = IL.wrap(Views.interval(rotated, minC, maxC),  </span><br><span class="line">  imp.getTitle() + <span class="string">&quot; - rot2dFit&quot;</span>)  </span><br><span class="line">imgRot2dFit.show()  </span><br></pre></td></tr></table></figure>

<h2 id="使用ImgLib2处理RGB和ARGB图片"><a href="#使用ImgLib2处理RGB和ARGB图片" class="headerlink" title="使用ImgLib2处理RGB和ARGB图片"></a>使用ImgLib2处理RGB和ARGB图片</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> net.imglib2.converter <span class="keyword">import</span> Converters  </span><br><span class="line"><span class="keyword">from</span> net.imglib2.view <span class="keyword">import</span> Views  </span><br><span class="line"><span class="keyword">from</span> net.imglib2.img.display.imagej <span class="keyword">import</span> ImageJFunctions <span class="keyword">as</span> IL  </span><br><span class="line"><span class="keyword">from</span> ij <span class="keyword">import</span> IJ  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># # Load an RGB or ARGB image  </span></span><br><span class="line">imp = IJ.getImage()  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Access its pixel data from an ImgLib2 data structure:  </span></span><br><span class="line"><span class="comment"># a RandomAccessibleInterval&lt;argbtype&gt;  </span></span><br><span class="line">img = IL.wrapRGBA(imp)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Convert an ARGB image to a stack of 4 channels: a RandomAccessibleInterval&lt;unsignedbyte&gt;  </span></span><br><span class="line"><span class="comment"># with one more dimension that before.  </span></span><br><span class="line"><span class="comment"># The order of channels in the stack can be changed by changing their indices.  </span></span><br><span class="line">channels = Converters.argbChannels(img, [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Equivalent to ImageJ&#x27;s CompositeImage: channels are separate  </span></span><br><span class="line">impChannels = IL.wrap(channels, imp.getTitle() + <span class="string">&quot; channels&quot;</span>)  </span><br><span class="line">impChannels.show()  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Read out a single channel directly  </span></span><br><span class="line">red = Converters.argbChannel(img, <span class="number">1</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># Alternatively, pick a view of the red channel in the channels stack.  </span></span><br><span class="line"><span class="comment"># Takes the last dimension, which are the channels,  </span></span><br><span class="line"><span class="comment"># and fixes it to just one: that of the red channel (1) in the stack.  </span></span><br><span class="line">red = Views.hyperSlice(channels, channels.numDimensions() -<span class="number">1</span>, <span class="number">1</span>)  </span><br><span class="line">  </span><br><span class="line">impRed = IL.wrap(red, imp.getTitle() + <span class="string">&quot; red channel&quot;</span>)  </span><br><span class="line">impRed.show()</span><br></pre></td></tr></table></figure>

<h2 id="Image-Calculator：在两张或多张图片间进行逐像素操作"><a href="#Image-Calculator：在两张或多张图片间进行逐像素操作" class="headerlink" title="Image Calculator：在两张或多张图片间进行逐像素操作"></a>Image Calculator：在两张或多张图片间进行逐像素操作</h2><p>ImageJ有一个内置的命令，叫Image Calculator，在Process- Image Calculator下，可以对两张图片进行数学操作，比如从一张图片中减去另一张。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2018/09/11/imagej-ui-menu-window-help/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/11/imagej-ui-menu-window-help/" class="post-title-link" itemprop="url">ImageJ 用户指南 -- 11. 菜单栏之Window和Help</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-11 00:00:00" itemprop="dateCreated datePublished" datetime="2018-09-11T00:00:00+08:00">2018-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/09/11/imagej-ui-menu-window-help/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/09/11/imagej-ui-menu-window-help/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="本章说明"><a href="#本章说明" class="headerlink" title="本章说明"></a>本章说明</h1><p>这里详解Window和Help菜单的功能。</p>
<h2 id="WIndow"><a href="#WIndow" class="headerlink" title="WIndow"></a>WIndow</h2><h3 id="Show-All"><a href="#Show-All" class="headerlink" title="Show All"></a>Show All</h3><p>显示所有的窗口。</p>
<h3 id="Put-Behind"><a href="#Put-Behind" class="headerlink" title="Put Behind"></a>Put Behind</h3><p>显示下一个窗口。</p>
<h3 id="Cascade"><a href="#Cascade" class="headerlink" title="Cascade"></a>Cascade</h3><p>将所有的图片都移动到屏幕的左上角，互相之间稍有偏移。</p>
<h3 id="Tile"><a href="#Tile" class="headerlink" title="Tile"></a>Tile</h3><p>以“磁贴”的形式显示图片，尽量不互相覆盖。</p>
<h2 id="Help"><a href="#Help" class="headerlink" title="Help"></a>Help</h2><h3 id="ImageJ-Website"><a href="#ImageJ-Website" class="headerlink" title="ImageJ Website"></a>ImageJ Website</h3><p>打开ImageJ的官网。</p>
<h3 id="ImageJ-News"><a href="#ImageJ-News" class="headerlink" title="ImageJ News"></a>ImageJ News</h3><p>打开ImageJ官网的新闻频道。</p>
<h3 id="Documentation"><a href="#Documentation" class="headerlink" title="Documentation"></a>Documentation</h3><p>打开ImageJ官网的文档部分。</p>
<h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><p>打开ImageJ官网的安装部分。</p>
<h3 id="Mailing-List"><a href="#Mailing-List" class="headerlink" title="Mailing List"></a>Mailing List</h3><p>打开ImageJ的邮件列表。</p>
<h3 id="Dev-Resources"><a href="#Dev-Resources" class="headerlink" title="Dev. Resources"></a>Dev. Resources</h3><p>打开ImageJ官网的开发者资源。</p>
<h3 id="Plugins"><a href="#Plugins" class="headerlink" title="Plugins"></a>Plugins</h3><p>打开ImageJ官网的插件资源，其有超过500个插件。</p>
<h3 id="Macros"><a href="#Macros" class="headerlink" title="Macros"></a>Macros</h3><p>打开ImageJ官网的宏资源，其有超过400个插件。</p>
<h3 id="Macro-Functions"><a href="#Macro-Functions" class="headerlink" title="Macro Functions"></a>Macro Functions</h3><p>打开ImageJ官网的宏函数参考页。</p>
<h3 id="Update-ImageJ"><a href="#Update-ImageJ" class="headerlink" title="Update ImageJ"></a>Update ImageJ</h3><p>升级ImageJ到最新版本，将最新的ij.jar放在../../upgrade/，或者降级到../../download/jars/中的某个早期版本。</p>
<h3 id="Refresh-Menus"><a href="#Refresh-Menus" class="headerlink" title="Refresh Menus"></a>Refresh Menus</h3><p>在添加（或移除）插件和宏后，使用该命令来更新菜单。</p>
<h3 id="About-Plugins"><a href="#About-Plugins" class="headerlink" title="About Plugins"></a>About Plugins</h3><p>显示插件文件夹下的插件信息。</p>
<h3 id="About-ImageJ"><a href="#About-ImageJ" class="headerlink" title="About ImageJ"></a>About ImageJ</h3><p>显示ImageJ的版本、作者、网站、Java版本和可用内存等。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2018/09/10/imagej-ui-menu-plugins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/10/imagej-ui-menu-plugins/" class="post-title-link" itemprop="url">ImageJ 用户指南 -- 10. 菜单栏之Plugins</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-10 00:00:00" itemprop="dateCreated datePublished" datetime="2018-09-10T00:00:00+08:00">2018-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/09/10/imagej-ui-menu-plugins/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/09/10/imagej-ui-menu-plugins/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="本章说明"><a href="#本章说明" class="headerlink" title="本章说明"></a>本章说明</h1><p>这里详解Plugins菜单的功能。<br>Plugins菜单反映了ImageJ/plugins文件夹（至多两个子文件夹）的层级结构，因此可以创建子菜单（即子文件夹）来保持该菜单的简洁性，比如将EPS_Writer.class移动到ImageJ/Plugins/Input/PDF文件夹就可以实现将EPS Writer插件移入Plugins-Input-PDF子菜单下。<br>另外，勾选Edit-Options-Misc中的Move isolated plugins，就可以将仅有一个命令的插件移入Plugins-Miscellaneous菜单中。</p>
<h1 id="Plugins"><a href="#Plugins" class="headerlink" title="Plugins"></a>Plugins</h1><h2 id="Macros"><a href="#Macros" class="headerlink" title="Macros"></a>Macros</h2><p>该菜单包含了安装、运行、录制宏等命令。在文件StartupMacros.txt中包含的宏会在ImageJ启动时自动加载。ImageJ被设计成一次仅能安装一个集合的宏，因此，通过Install加载的最后一个集合的宏总会替换上一次的宏。</p>
<h3 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h3><p>安装宏。</p>
<h3 id="Run"><a href="#Run" class="headerlink" title="Run"></a>Run</h3><p>加载宏并运行，而不在Editor中打开。为了运行一个宏，同时查看它的代码，使用File-Open，然后在编辑器里点Macros-Run Macro。</p>
<h3 id="Startup-Macro"><a href="#Startup-Macro" class="headerlink" title="Startup Macro"></a>Startup Macro</h3><p>打开ImageJ/macros/StartupMacro.txt文件。</p>
<h3 id="Record"><a href="#Record" class="headerlink" title="Record"></a>Record</h3><p>打开ImageJ的命令录制器。为了创建一个宏，先打开录制器，然后使用一个或多个命令，然后点击Create。当录制器打开时，使用的每一个菜单命令都将产生一个run函数。</p>
<h2 id="Shortcuts"><a href="#Shortcuts" class="headerlink" title="Shortcuts"></a>Shortcuts</h2><p>快捷键相关的操作。</p>
<h3 id="List-Shortcuts"><a href="#List-Shortcuts" class="headerlink" title="List Shortcuts"></a>List Shortcuts</h3><p>该命令显示快捷键列表。在command一列中用星号开头的快捷键是用Create Shortcuts创建的，而用^号开头的表明是通过所安装的macro创建，其会覆盖掉ImageJ的默认热键。</p>
<h3 id="Create-Shortcuts"><a href="#Create-Shortcuts" class="headerlink" title="Create Shortcuts"></a>Create Shortcuts</h3><p>为ImageJ的菜单命令指定一个快捷键。</p>
<h3 id="Install-Plugins"><a href="#Install-Plugins" class="headerlink" title="Install Plugins"></a>Install Plugins</h3><p>在用户指定的子菜单下安装一个插件。如果一个插件有showAbout()函数，那么它会自动添加到Help-About Plugins子菜单下。<br>注意，新版的ImageJ将Install Plugins单独提到Plugins这个一级菜单下了。</p>
<h3 id="Remove"><a href="#Remove" class="headerlink" title="Remove"></a>Remove</h3><p>删除通过Create Shortcuts添加的命令。</p>
<h2 id="Utilities"><a href="#Utilities" class="headerlink" title="Utilities"></a>Utilities</h2><h3 id="Control-Panel"><a href="#Control-Panel" class="headerlink" title="Control Panel"></a>Control Panel</h3><p>该命令用一个遗传树的结构来显示ImageJ的菜单。点击一个叶子节点来启动对应的命令。双击一个主干节点（文件夹图标）会展开或收起它。点击和拖拽一个主干节点可以在另外一个窗口中显示它的子节点。</p>
<h3 id="Find-Commands"><a href="#Find-Commands" class="headerlink" title="Find Commands"></a>Find Commands</h3><p>无需浏览所有菜单而直接找到一个命令的最快捷的方式。<br>快捷键是“L”。</p>
<h3 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h3><p>查找包含某个特定字符串的宏、脚本、插件源代码等。</p>
<h3 id="Monitor-Events"><a href="#Monitor-Events" class="headerlink" title="Monitor Events"></a>Monitor Events</h3><p>通过使用IJEventListener、CommandListener、ImageLister界面，可以监视前景色和背景色的变化、工具切换、日志窗口、命令执行、图形窗口的打开、关闭和升级等。</p>
<h3 id="Monitor-Memory"><a href="#Monitor-Memory" class="headerlink" title="Monitor Memory"></a>Monitor Memory</h3><p>显示内存使用情况。</p>
<h3 id="Capture-Screen"><a href="#Capture-Screen" class="headerlink" title="Capture Screen"></a>Capture Screen</h3><p>将电脑的当前屏幕截屏，显示成一个RGB图片。</p>
<h3 id="Capture-Image"><a href="#Capture-Image" class="headerlink" title="Capture Image"></a>Capture Image</h3><p>将当前显示的图片保存进一个RGB图片，所见即所得。</p>
<h3 id="ImageJ-Properties"><a href="#ImageJ-Properties" class="headerlink" title="ImageJ Properties"></a>ImageJ Properties</h3><p>显示ImageJ的属性，如Java版本、OS名字和版本、文件路径、屏幕尺寸等信息。</p>
<h3 id="Threads"><a href="#Threads" class="headerlink" title="Threads"></a>Threads</h3><p>显示当前运行的线程和优先级。</p>
<h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h3><p>在当前图片上运行62种图像处理操作，然后在状态栏上显示运行时间。</p>
<h3 id="Reset"><a href="#Reset" class="headerlink" title="Reset"></a>Reset</h3><p>使用该命令解锁一个锁定的图片、释放剪贴板所使用的内存和undo的缓存。</p>
<h2 id="New"><a href="#New" class="headerlink" title="New"></a>New</h2><p>打开一个编辑窗口，用来编辑和运行宏、脚本和插件。</p>
<h3 id="Macro"><a href="#Macro" class="headerlink" title="Macro"></a>Macro</h3><p>打开一个空白的编辑器窗口。</p>
<h3 id="Macro-Tool"><a href="#Macro-Tool" class="headerlink" title="Macro Tool"></a>Macro Tool</h3><p>打开一个创建圆形选区的宏demo。</p>
<h3 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h3><p>打开一个名为Script.js的空白的编辑器窗口。</p>
<h3 id="Plugin"><a href="#Plugin" class="headerlink" title="Plugin"></a>Plugin</h3><p>打开一个使用PlugIn接口的原型插件。该类型的插件打开、捕捉和差生图片。使用Ctrl+R来编译和运行。注意插件的名字应该包含至少一个下划线。</p>
<h3 id="Plugin-Filter"><a href="#Plugin-Filter" class="headerlink" title="Plugin Filter"></a>Plugin Filter</h3><p>打开一个使用PlugInFilter接口的原型插件。该类型的插件处理当前图片。</p>
<h3 id="Plugin-Frame"><a href="#Plugin-Frame" class="headerlink" title="Plugin Frame"></a>Plugin Frame</h3><p>打开一个使用PlugInFrame类的原型插件。该类型的插件显示一个包含控制体（如按钮和滑块）的窗口。</p>
<h3 id="Plugin-Tool"><a href="#Plugin-Tool" class="headerlink" title="Plugin Tool"></a>Plugin Tool</h3><p>打开一个使用PlugInTool的原型插件，该插件用于与画布交互。</p>
<h3 id="Text-Window"><a href="#Text-Window" class="headerlink" title="Text Window"></a>Text Window</h3><p>打开一个特定尺寸的文本窗口，用于宏的写入。</p>
<h3 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h3><p>打开一个类似于Results Table的空白table，用于宏的写入。</p>
<h2 id="Compile-and-Run"><a href="#Compile-and-Run" class="headerlink" title="Compile and Run"></a>Compile and Run</h2><p>编译和运行一个插件。如果一个文件的名字后缀是.class，则运行该插件。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2018/09/09/imagej-ui-menu-analyze/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/09/imagej-ui-menu-analyze/" class="post-title-link" itemprop="url">ImageJ 用户指南 -- 9. 菜单栏之Analyze</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-09 00:00:00" itemprop="dateCreated datePublished" datetime="2018-09-09T00:00:00+08:00">2018-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/09/09/imagej-ui-menu-analyze/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/09/09/imagej-ui-menu-analyze/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="本章说明"><a href="#本章说明" class="headerlink" title="本章说明"></a>本章说明</h1><p>这里详解Analyze菜单的功能。</p>
<h1 id="Analyze"><a href="#Analyze" class="headerlink" title="Analyze"></a>Analyze</h1><h2 id="Measure"><a href="#Measure" class="headerlink" title="Measure"></a>Measure</h2><p>基于当前选择，在Results Table中计算和显示区域统计、线长、角度或者点坐标等信息。具体的测量操作可以在下方的Set Measurment对话框中进行指定。</p>
<h2 id="Analyze-Particles"><a href="#Analyze-Particles" class="headerlink" title="Analyze Particles"></a>Analyze Particles</h2><p>在二值图片或阈值处理过的图片上，对对象进行计算和测量。它是通过扫描图片或选区直到找到对象的边缘，然后用魔棒工具将对象的轮廓画出来，使用上面的Measure命令计算测量。</p>
<ul>
<li>Size：给定一个面积范围，如果particle的尺寸面积在该范围之外，其将被忽略。如果标度过图片，则使用真实单位所形成的物理面积，否则使用像素的平方做单位。</li>
<li>Circularity：球形度范围，在此范围以外的particle将被忽略。</li>
<li>Show：决定在分析之后怎样显示结果。Nothing：图片或Overlay都不显示，注意，如果该particle analyzer测量到的particles数目为0以及Show选择Nothing，那么就会显示一个空白图片；Outline：显示一张含有用数字标示的particle的轮廓的8-bit图片；Bare Outlines：8-bit图仅显示轮廓，不显示标签；Masks：一张8-bit图片，包含particles的对轮廓的填充；Ellipses：8-bit图片，包括最近似的椭圆；Count Masks：16-bit图片，包含particle的对轮廓的填充，同时用与particle number相对应的灰度值显示；Overlay Outlines：在overlay中显示particle的轮廓，删除之前的overlay；Overlay Masks：在overlay中显示particle的轮廓的填充，删除之前的overlay。</li>
<li>Display Results：勾选后，每个particle的测量结果将在Results Table中显示</li>
<li>Clear Results：勾选后，Results Table中的之前的结果将被清除</li>
<li>Summarize：勾选后，将在一个Summary的表格中显示particle的个数、总面积、平均尺寸、面积分数和Set Measurements中的所有参数的平均值。</li>
<li>Add to Manager：勾选后，测量到的particles都将添加进ROI管理器。</li>
<li>Exclude on Edges：勾选后，碰到图片或选区边缘的particle将被忽略。</li>
<li>Include Holes：勾选后，内部的孔洞将被作为每个Particle的内部区域，即ImageJ将会仅通过外边界来寻找每个Particle，内部的。不勾选此项，将会通过泛洪填充来寻找对象，然后会在Particle中排除孔洞。</li>
<li>Record Starts：该选项允许插件和宏使用doWand函数来重新创建边界，CircularParticles宏展示了使用方法。</li>
<li>In situ Show：勾选后，原始图片将被新图片替代，该选项对上面的overlay无效。</li>
</ul>
<h2 id="Summarize"><a href="#Summarize" class="headerlink" title="Summarize"></a>Summarize</h2><p>对于Results Table中的每一列，计算这一项的均值、标准差、最小和最大值。</p>
<h2 id="Distribution"><a href="#Distribution" class="headerlink" title="Distribution"></a>Distribution</h2><p>从Results Table的选定列中创建该列数据的频率直方图。</p>
<h2 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h2><p>该命令使用Results Table的行数来对当前的选区进行标注。</p>
<h2 id="Clear-Results"><a href="#Clear-Results" class="headerlink" title="Clear Results"></a>Clear Results</h2><p>清除结果</p>
<h2 id="Set-Measurements"><a href="#Set-Measurements" class="headerlink" title="Set Measurements"></a>Set Measurements</h2><p>使用该对话框来指定Analyze-Measure、ROI管理器的Measure和Analyze-Analyze Particles怎样进行测量。对于阈值处理的图片，如果勾选了Limit to Threshold，则可以仅对高亮的像素点进行测量。<br>这些选项分成了两类：第一类是控制输出到Results Table中的测量的类型有哪些；第二类是怎样测量。<br>第一类的18个选项有：</p>
<ul>
<li>Area：面积，如果下面的Analyze-Set scale用来进行空间标度，那么面积就是真实面积，否则用像素面积</li>
<li>Mean gray value：当前选区的平均灰度值。对于灰度图，就是所有灰度值加起来除以总个数；对于RGB图，使用之前介绍过的转换法则将每个像素转为灰度值；</li>
<li>Standard deviation：灰度值的标准差。</li>
<li>Modal gray value：出现频率最大的灰度值，即直方图中的高峰</li>
<li>Min &amp; Max gray level：最小和最大灰度值</li>
<li>Centroid：中心点，即图片或选区中的所有像素点的XY坐标的平均</li>
<li>Center of mass：这是用亮度加权的XY坐标点的平均。</li>
<li>Perimeter：选区的外边界的长度。</li>
<li>Bounding rectangle：包住选区的最小矩形。使用矩形的左上角的坐标及长宽表示。</li>
<li>Fit ellipse：用椭圆来拟合选区，使用椭圆的主轴和次轴和角度来表示。如果上面的Centroid勾选后，椭圆的中心店也显示出来。注意，如果Analyze-Set Scale中的Pixel Aspect Ratio不勾选，那么ImageJ不能计算主轴和次轴的长度。</li>
<li>Shape descriptors：计算和显示以下形状因子：Circularity球形度、Aspect ratio长宽比、Roundness和Solidity。</li>
<li>Feret’s dismeter：在选区边缘上两点之间的最大距离</li>
<li>Integrated density：像素值的总和，它等于Area和Mean Gray Value的乘积。</li>
<li>Median：像素值的平均值</li>
<li>Skewness：均值的三次矩</li>
<li>kurtosis：均值的四次矩</li>
<li>Area Fraction：面积分数，对于阈值处理过的图片，它是红色高亮的像素的分数；对于非阈值处理过的图片，它是非零像素的分数。</li>
<li>Stack position：在stack或hyperstack中的位置：slice、channel和frame。</li>
</ul>
<p>第二类的选项是控制怎样测量：</p>
<ul>
<li>Limit to threshold：勾选后，仅阈值范围内的像素被测量</li>
<li>Display level：勾选后，图片名字和slice的序号会在Results Table中记录。</li>
<li>Invert Y coordinates：勾选后，XY的原点变成窗口的左下角，而不是默认的左上角。</li>
<li>Scientific notation：勾选后，用科学计数法显示结果</li>
<li>Add to Overlay：勾选后，所测量的ROI自动添加进Overlay</li>
<li>Redirect to：从该菜单中选择要统计的图片，这使得可以在一张图片中的统计同样应用于另一张图片的相应区域。</li>
<li>Decimal places：显示小数点的位数。</li>
</ul>
<h2 id="Set-Scale"><a href="#Set-Scale" class="headerlink" title="Set Scale"></a>Set Scale</h2><p>使用该对话框来定义空间比例，从而使得测量能用真实单位显示，比如$mm$和$\mu m$。<br>在使用该命令之前，先用一个直线选区工具在已知距离上进行划线，然后再调用该对话框，在Known Distance和Unit中填入真实距离及单位即可。<br>如果将Pixel Aspect Ratio设为非1，还可以支持水平和垂直两个方向上不同的空间比例。<br>当勾选Global后，该比例将会应用于所有的当前session已打开的图片中。</p>
<h2 id="Calibrate"><a href="#Calibrate" class="headerlink" title="Calibrate"></a>Calibrate</h2><p>功能是使用不同的函数来拟合像素值和灰度值之间的关系。</p>
<h2 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h2><p>计算和显示当前图片或选区的灰度值的分布直方图。<br>X轴是可能的灰度图，Y轴是该灰度值的像素个数。X轴下方的LUT用来显示图片的显示范围。再下方会显示总的像素个数、灰度值的平均值、标准差、最小、最大和modal值。<br>点击list或copy来存储直方图数据。点击Log来显示一个对数坐标的直方图。点击live可以在浏览stack或移动ROI时见识直方图的变化。</p>
<h2 id="Plot-Profile"><a href="#Plot-Profile" class="headerlink" title="Plot Profile"></a>Plot Profile</h2><p>显示沿着一条线或一个矩形选区的像素值的强度的变化曲线。为了得到多个选区的作图，可以使用ROI管理的Multi Plot命令。<br>其他类型的选区，可以先运行Edit-Selction-Area to Line将其转化为直线选择。</p>
<h2 id="Surface-Plot"><a href="#Surface-Plot" class="headerlink" title="Surface Plot"></a>Surface Plot</h2><p>在一个灰度图或伪彩色图上显示一个三维的像素值的图。作图是基于现有的矩形选区或整个图片。</p>
<h2 id="Gels"><a href="#Gels" class="headerlink" title="Gels"></a>Gels</h2><p>使用该命令来分析一个一维的电泳凝胶。</p>
<h2 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h2><p>该菜单提供了多种图像分析插件。</p>
<h3 id="Save-XY-Coordinates"><a href="#Save-XY-Coordinates" class="headerlink" title="Save XY Coordinates"></a>Save XY Coordinates</h3><p>将当前图片的所有非背景像素点的XY坐标值和像素值写入一个文本文件中。背景假设为图片左上角的像素点的值。对于灰度图，每行写入三个值，用空格分割。对于RGB图，每行写入五个值。坐标系的原点是在图片的左下角。</p>
<h3 id="Fractal-Box-Count"><a href="#Fractal-Box-Count" class="headerlink" title="Fractal Box Count"></a>Fractal Box Count</h3><p>估计一个二值图片的分形维度。</p>
<h3 id="Analyze-Line-Graph"><a href="#Analyze-Line-Graph" class="headerlink" title="Analyze Line Graph"></a>Analyze Line Graph</h3><p>该命令使用上面的Particle Analyzer来提取线图的坐标值。这个功能跟GetData软件一样，但明显不如专业的GetData好用。</p>
<h3 id="Curve-Fitting"><a href="#Curve-Fitting" class="headerlink" title="Curve Fitting"></a>Curve Fitting</h3><p>曲线拟合。这块还是使用专业的软件吧。。</p>
<h3 id="ROI-Manager"><a href="#ROI-Manager" class="headerlink" title="ROI Manager"></a>ROI Manager</h3><p>可以用来管理多个ROI。</p>
<h3 id="Scale-Bar"><a href="#Scale-Bar" class="headerlink" title="Scale Bar"></a>Scale Bar</h3><p>绘制一个带标注的空间比例尺。</p>
<h3 id="Calibration-Bar"><a href="#Calibration-Bar" class="headerlink" title="Calibration Bar"></a>Calibration Bar</h3><p>绘制一个带标注的色度条。</p>
<h3 id="Synchronize-WIndows"><a href="#Synchronize-WIndows" class="headerlink" title="Synchronize WIndows"></a>Synchronize WIndows</h3><p>在多个窗口上同步鼠标移动和输入，使得某个图片上绘制的ROI能够复制到其他同步窗口中。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xin-Bo Qi(亓欣波)"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Xin-Bo Qi(亓欣波)</p>
  <div class="site-description" itemprop="description">Be interesting!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">120</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/qixinbo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qixinbo" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:qixinbo@gmail.com" title="E-Mail → mailto:qixinbo@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.tsinghua.edu.cn/" title="https:&#x2F;&#x2F;www.tsinghua.edu.cn" rel="noopener" target="_blank">THU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.imr.cas.cn/" title="http:&#x2F;&#x2F;www.imr.cas.cn" rel="noopener" target="_blank">IMR</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.sdu.edu.cn/" title="http:&#x2F;&#x2F;www.sdu.edu.cn" rel="noopener" target="_blank">SDU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://liam0205.me/" title="http:&#x2F;&#x2F;liam0205.me&#x2F;" rel="noopener" target="_blank">黄晨成</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xin-Bo Qi(亓欣波)</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://qixinbo.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
