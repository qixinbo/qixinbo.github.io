<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qixinbo.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Be interesting!">
<meta property="og:type" content="website">
<meta property="og:title" content="亓欣波">
<meta property="og:url" content="http://qixinbo.github.io/page/3/index.html">
<meta property="og:site_name" content="亓欣波">
<meta property="og:description" content="Be interesting!">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Xin-Bo Qi(亓欣波)">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://qixinbo.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>亓欣波</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">亓欣波</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Hi, I am Xin-Bo Qi (亓欣波)</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-scholar">

    <a href="/scholar/" rel="section"><i class="bar-chart fa-fw"></i>scholar</a>

  </li>
        <li class="menu-item menu-item-sources">

    <a href="/sources/" rel="section"><i class="rss fa-fw"></i>sources</a>

  </li>
        <li class="menu-item menu-item-gallery">

    <a href="/gallery/" rel="section"><i class="file-image-o fa-fw"></i>gallery</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404.html" rel="section"><i class="heartbeat fa-fw"></i>Commonweal 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2020/02/10/ImagePy_16/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/10/ImagePy_16/" class="post-title-link" itemprop="url">ImagePy解析：16 -- 细胞分析Cell Analysis</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-10 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-10T00:00:00+08:00">2020-02-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/02/10/ImagePy_16/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/10/ImagePy_16/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文是对ImagePy的IBook中的<a target="_blank" rel="noopener" href="https://github.com/Image-Py/IBook/blob/master/menus/IBook/Chapter7%20Binary-Image/Show%20Cell%20Analysis.mc">Cell Analysis</a>的解析。<br>该例子用到了很多功能，从中可以一窥图像处理的常用流程和ImagePy常用组件的用法。<br>该文件是个录制的宏文件，因此，命令都是“插件名称&gt;参数字典”的形式。</p>
<h1 id="打开图像"><a href="#打开图像" class="headerlink" title="打开图像"></a>打开图像</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cell&gt;<span class="literal">None</span></span><br></pre></td></tr></table></figure>
<p>该宏命令就是打开了cell图像，如图：<br><img src="https://user-images.githubusercontent.com/6218739/71238417-f7c44100-233e-11ea-8ec2-5bd1066ff0b6.JPG" alt="cell"><br>之所以能这样打开图像，是因为在生成ImagePy主界面时，已经将该图像解析成了插件，具体过程可以参见<a target="_blank" rel="noopener" href="http://qixinbo.info/2019/08/31/ImagePy_4/">之前解析主界面渲染的文章</a>。<br>主要原理通过查看IBook下的Image Referenced文件夹下的image_plgs文件就一目了然：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Data</span>(<span class="params">Free</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.title = name.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, para = <span class="literal">None</span></span>):</span></span><br><span class="line">        root_dir = osp.abspath(osp.dirname(__file__))</span><br><span class="line">        img = imread(osp.join(root_dir, self.name))</span><br><span class="line">        <span class="keyword">if</span> img.ndim==<span class="number">3</span> <span class="keyword">and</span> img.shape[<span class="number">2</span>]==<span class="number">4</span>:</span><br><span class="line">            img = img[:,:,:<span class="number">3</span>].copy()</span><br><span class="line">        IPy.show_img([img], self.title)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">datas = [<span class="string">&#x27;Angkor.jpg&#x27;</span>,<span class="string">&#x27;qrcode.png&#x27;</span>,<span class="string">&#x27;street.jpg&#x27;</span>,<span class="string">&#x27;road.jpg&#x27;</span>,<span class="string">&#x27;house.jpg&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;neubauer.jpg&#x27;</span>,<span class="string">&#x27;windmill.jpg&#x27;</span>,<span class="string">&#x27;sunglow.jpg&#x27;</span>,<span class="string">&#x27;ailurus.jpg&#x27;</span>,<span class="string">&#x27;Yuan.jpg&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;saltpepper.jpg&#x27;</span>,<span class="string">&#x27;dem.jpg&#x27;</span>, <span class="string">&#x27;honeycomb.jpg&#x27;</span>, <span class="string">&#x27;necklace.jpg&#x27;</span>,<span class="string">&#x27;universe.jpg&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;towel-far.jpg&#x27;</span>,<span class="string">&#x27;towel-near.jpg&#x27;</span>,<span class="string">&#x27;trafficsign.jpg&#x27;</span>,<span class="string">&#x27;bee.png&#x27;</span>,<span class="string">&#x27;insect.png&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;game.jpg&#x27;</span>,<span class="string">&#x27;gear.png&#x27;</span>,<span class="string">&#x27;block.png&#x27;</span>,<span class="string">&#x27;distance.png&#x27;</span>,<span class="string">&#x27;points.png&#x27;</span>, <span class="string">&#x27;qin.png&#x27;</span>, </span><br><span class="line"><span class="string">&#x27;img.png&#x27;</span>,<span class="string">&#x27;pointline.png&#x27;</span>,<span class="string">&#x27;marble.png&#x27;</span>,<span class="string">&#x27;cell.jpg&#x27;</span>,<span class="string">&#x27;rust.jpg&#x27;</span>, <span class="string">&#x27;rose.jpg&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;roses.jpg&#x27;</span>]</span><br><span class="line">plgs = [Data(i) <span class="keyword">for</span> i <span class="keyword">in</span> datas]</span><br></pre></td></tr></table></figure>

<h1 id="复制图像"><a href="#复制图像" class="headerlink" title="复制图像"></a>复制图像</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Duplicate&gt;&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;cell-gray&#x27;</span>, <span class="string">&#x27;stack&#x27;</span>: <span class="literal">True</span>&#125;</span><br></pre></td></tr></table></figure>
<p>将上述图像复制一份，便于后续处理。<br>调用的Duplicate命令的原理见menus的Image的duplicate_plg.py文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Duplicate</span>(<span class="params">Simple</span>):</span></span><br><span class="line">    title = <span class="string">&#x27;Duplicate&#x27;</span></span><br><span class="line">    note = [<span class="string">&#x27;all&#x27;</span>]</span><br><span class="line">    para = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;Undefined&#x27;</span>,<span class="string">&#x27;stack&#x27;</span>:<span class="literal">True</span>&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, ips, imgs, para = <span class="literal">None</span></span>):</span></span><br><span class="line">        name = para[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> ips.get_nslices()==<span class="number">1</span> <span class="keyword">or</span> self.para[<span class="string">&#x27;stack&#x27;</span>]==<span class="literal">False</span>:</span><br><span class="line">            <span class="keyword">if</span> ips.roi == <span class="literal">None</span>:</span><br><span class="line">                img = ips.img.copy()</span><br><span class="line">                ipsd = ImagePlus([img], name)</span><br><span class="line">                ipsd.back = ips.back</span><br><span class="line">            ipsd = ImagePlus(imgs, name)</span><br><span class="line">        ipsd.chan_mode = ips.chan_mode</span><br><span class="line">        IPy.show_ips(ipsd)</span><br></pre></td></tr></table></figure>
<p>注意将img复制完后，还要组装成ImagePy特有的ImagePlus类型的结构。</p>
<h1 id="图像灰度化"><a href="#图像灰度化" class="headerlink" title="图像灰度化"></a>图像灰度化</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8</span>-bit&gt;<span class="literal">None</span></span><br></pre></td></tr></table></figure>
<p>这一步就是将RGB图像转为8位灰度图像</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">To8bit</span>(<span class="params">Simple</span>):</span></span><br><span class="line">    title = <span class="string">&#x27;8-bit&#x27;</span></span><br><span class="line">    note = [<span class="string">&#x27;all&#x27;</span>]</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, ips, imgs, para = <span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> ips.imgtype == <span class="string">&#x27;8-bit&#x27;</span>: <span class="keyword">return</span></span><br><span class="line">        n = ips.get_nslices()</span><br><span class="line">        <span class="keyword">if</span> ips.is3d:</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            img8 = []</span><br><span class="line">            minv, maxv = ips.get_updown()</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">                self.progress(i, <span class="built_in">len</span>(imgs))</span><br><span class="line">                <span class="keyword">if</span> ips.imgtype == <span class="string">&#x27;rgb&#x27;</span>:</span><br><span class="line">                    img8.append(imgs[i].mean(axis=<span class="number">2</span>).astype(np.uint8))</span><br><span class="line">        ips.set_imgs(img8)</span><br></pre></td></tr></table></figure>
<p>可以看出，这里灰度化所使用的方法是取三通道的平均值。<br>这一步处理得到的结果如图：<br><img src="https://user-images.githubusercontent.com/6218739/72133839-5f5d3180-33bd-11ea-9867-8b5b79f620b0.png" alt="grey"></p>
<h1 id="复制图像-1"><a href="#复制图像-1" class="headerlink" title="复制图像"></a>复制图像</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Duplicate&gt;&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;cell-msk&#x27;</span>, <span class="string">&#x27;stack&#x27;</span>: <span class="literal">True</span>&#125;</span><br></pre></td></tr></table></figure>
<p>将灰度化的图像又复制了一份。。</p>
<h1 id="阈值分割"><a href="#阈值分割" class="headerlink" title="阈值分割"></a>阈值分割</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Threshold&gt;&#123;<span class="string">&#x27;thr1&#x27;</span>: <span class="number">193</span>, <span class="string">&#x27;thr2&#x27;</span>: <span class="number">255</span>&#125;</span><br></pre></td></tr></table></figure>
<p>将图像根据上下阈值进行二值化分割。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plugin</span>(<span class="params">Filter</span>):</span></span><br><span class="line">    modal = <span class="literal">False</span></span><br><span class="line">    title = <span class="string">&#x27;Threshold&#x27;</span></span><br><span class="line">    note = [<span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;auto_msk&#x27;</span>, <span class="string">&#x27;auto_snap&#x27;</span>, <span class="string">&#x27;not_channel&#x27;</span>, <span class="string">&#x27;preview&#x27;</span>]</span><br><span class="line">    arange = (<span class="number">0</span>,<span class="number">255</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, ips, snap, img, para = <span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> para == <span class="literal">None</span>: para = self.para</span><br><span class="line">        ips.lut = self.lut</span><br><span class="line">        img[:] = <span class="number">0</span></span><br><span class="line">        img[snap&gt;=para[<span class="string">&#x27;thr2&#x27;</span>]] = <span class="number">255</span></span><br><span class="line">        img[snap&lt;para[<span class="string">&#x27;thr1&#x27;</span>]] = <span class="number">255</span></span><br><span class="line">        ips.<span class="built_in">range</span> = (<span class="number">0</span>, <span class="number">255</span>)</span><br></pre></td></tr></table></figure>
<p>可以看出，首先将img都置为0，然后将原图中大于thr2和小于thr1的像素在img中都置为255。具体地，这里thr2是255， thr1是193，所以这里就是将小于193的像素值都置为白色，大于193的像素都置为黑色。<br>这一步处理后结果如图：<br><img src="https://user-images.githubusercontent.com/6218739/72133901-8582d180-33bd-11ea-9e38-d8c47f3f633e.png" alt="threshold"></p>
<h1 id="填充孔洞"><a href="#填充孔洞" class="headerlink" title="填充孔洞"></a>填充孔洞</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Fill Holes&gt;<span class="literal">None</span></span><br></pre></td></tr></table></figure>
<p>从上图可以看出，二值分割后有很多细胞中间都有孔洞，因此这一步目的是将这些孔洞填充。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FillHoles</span>(<span class="params">Filter</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;FillHoles: derived from imagepy.core.engine.Filter &quot;&quot;&quot;</span></span><br><span class="line">    title = <span class="string">&#x27;Fill Holes&#x27;</span></span><br><span class="line">    note = [<span class="string">&#x27;8-bit&#x27;</span>, <span class="string">&#x27;auto_msk&#x27;</span>, <span class="string">&#x27;auto_snap&#x27;</span>,<span class="string">&#x27;preview&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, ips, snap, img, para = <span class="literal">None</span></span>):</span></span><br><span class="line">        ndimg.binary_fill_holes(snap, output=img)</span><br><span class="line">        img *= <span class="number">25</span></span><br></pre></td></tr></table></figure>
<p>具体操作是调用了scipy的ndimage模块的binary_fill_holes函数，结果如下：<br><img src="https://user-images.githubusercontent.com/6218739/72134539-55d4c900-33bf-11ea-83d5-3009575d3aa2.png" alt="fill-holes"></p>
<h1 id="几何过滤"><a href="#几何过滤" class="headerlink" title="几何过滤"></a>几何过滤</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Geometry Filter&gt;&#123;<span class="string">&#x27;con&#x27;</span>: <span class="string">&#x27;4-connect&#x27;</span>, <span class="string">&#x27;inv&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;area&#x27;</span>: <span class="number">1100.0</span>, <span class="string">&#x27;l&#x27;</span>: <span class="number">0.0</span>, <span class="string">&#x27;holes&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;solid&#x27;</span>: <span class="number">0.0</span>, <span class="string">&#x27;e&#x27;</span>: <span class="number">0.0</span>, <span class="string">&#x27;front&#x27;</span>: <span class="number">255</span>, <span class="string">&#x27;back&#x27;</span>: <span class="number">0</span>&#125;</span><br></pre></td></tr></table></figure>
<p>由上图可以看出，填充孔洞后的图像依然有很多杂点，这一步是通过面积来过滤掉这些杂点。<br>该插件名为“几何过滤”，因此不只是可以通过面积来过滤，还可以通过周长、偏心率等来过滤：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegionFilter</span>(<span class="params">Filter</span>):</span></span><br><span class="line">    title = <span class="string">&#x27;Geometry Filter&#x27;</span></span><br><span class="line">    note = [<span class="string">&#x27;8-bit&#x27;</span>, <span class="string">&#x27;16-bit&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;auto_msk&#x27;</span>, <span class="string">&#x27;auto_snap&#x27;</span>,<span class="string">&#x27;preview&#x27;</span>]</span><br><span class="line">    para = &#123;<span class="string">&#x27;con&#x27;</span>:<span class="string">&#x27;4-connect&#x27;</span>, <span class="string">&#x27;inv&#x27;</span>:<span class="literal">False</span>, <span class="string">&#x27;area&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;l&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;holes&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;solid&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;e&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;front&#x27;</span>:<span class="number">255</span>, <span class="string">&#x27;back&#x27;</span>:<span class="number">100</span>&#125;</span><br><span class="line">    view = [(<span class="built_in">list</span>, <span class="string">&#x27;con&#x27;</span>, [<span class="string">&#x27;4-connect&#x27;</span>, <span class="string">&#x27;8-connect&#x27;</span>], <span class="built_in">str</span>, <span class="string">&#x27;conection&#x27;</span>, <span class="string">&#x27;pix&#x27;</span>),</span><br><span class="line">            (<span class="built_in">bool</span>, <span class="string">&#x27;inv&#x27;</span>, <span class="string">&#x27;invert&#x27;</span>),</span><br><span class="line">            (<span class="string">&#x27;lab&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Filter: &quot;+&quot; means &gt;=, &quot;-&quot; means &lt;&#x27;</span>),</span><br><span class="line">            (<span class="built_in">int</span>, <span class="string">&#x27;front&#x27;</span>, (<span class="number">0</span>, <span class="number">255</span>), <span class="number">0</span>, <span class="string">&#x27;front color&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            (<span class="built_in">int</span>, <span class="string">&#x27;back&#x27;</span>, (<span class="number">0</span>, <span class="number">255</span>), <span class="number">0</span>, <span class="string">&#x27;back color&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            (<span class="built_in">float</span>, <span class="string">&#x27;area&#x27;</span>, (-<span class="number">1e6</span>, <span class="number">1e6</span>), <span class="number">1</span>, <span class="string">&#x27;area&#x27;</span>, <span class="string">&#x27;unit^2&#x27;</span>),</span><br><span class="line">            (<span class="built_in">float</span>, <span class="string">&#x27;l&#x27;</span>, (-<span class="number">1e6</span>, <span class="number">1e6</span>), <span class="number">1</span>, <span class="string">&#x27;perimeter&#x27;</span>, <span class="string">&#x27;unit&#x27;</span>),</span><br><span class="line">            (<span class="built_in">int</span>, <span class="string">&#x27;holes&#x27;</span>, (-<span class="number">10</span>,<span class="number">10</span>), <span class="number">0</span>, <span class="string">&#x27;holes&#x27;</span>, <span class="string">&#x27;num&#x27;</span>),</span><br><span class="line">            (<span class="built_in">float</span>, <span class="string">&#x27;solid&#x27;</span>, (-<span class="number">1</span>, <span class="number">1</span>,), <span class="number">1</span>, <span class="string">&#x27;solidity&#x27;</span>, <span class="string">&#x27;ratio&#x27;</span>),</span><br><span class="line">            (<span class="built_in">float</span>, <span class="string">&#x27;e&#x27;</span>, (-<span class="number">100</span>,<span class="number">100</span>), <span class="number">1</span>, <span class="string">&#x27;eccentricity&#x27;</span>, <span class="string">&#x27;ratio&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="comment">#process</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, ips, snap, img, para = <span class="literal">None</span></span>):</span></span><br><span class="line">        k, unit = ips.unit</span><br><span class="line">        strc = generate_binary_structure(<span class="number">2</span>, <span class="number">1</span> <span class="keyword">if</span> para[<span class="string">&#x27;con&#x27;</span>]==<span class="string">&#x27;4-connect&#x27;</span> <span class="keyword">else</span> <span class="number">2</span>)</span><br><span class="line">        lab, n = label(snap==<span class="number">0</span> <span class="keyword">if</span> para[<span class="string">&#x27;inv&#x27;</span>] <span class="keyword">else</span> snap, strc, output=np.uint32)</span><br><span class="line">        idx = (np.ones(n+<span class="number">1</span>)*(<span class="number">0</span> <span class="keyword">if</span> para[<span class="string">&#x27;inv&#x27;</span>] <span class="keyword">else</span> para[<span class="string">&#x27;front&#x27;</span>])).astype(np.uint8)</span><br><span class="line">        ls = regionprops(lab)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> ls:</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;area&#x27;</span>] == <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;area&#x27;</span>]&gt;<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> i.area*k**<span class="number">2</span> &lt; para[<span class="string">&#x27;area&#x27;</span>]: idx[i.label] = para[<span class="string">&#x27;back&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;area&#x27;</span>]&lt;<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> i.area*k**<span class="number">2</span> &gt;= -para[<span class="string">&#x27;area&#x27;</span>]: idx[i.label] = para[<span class="string">&#x27;back&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> ls:</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;l&#x27;</span>] == <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;l&#x27;</span>]&gt;<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> i.perimeter*k &lt; para[<span class="string">&#x27;l&#x27;</span>]: idx[i.label] = para[<span class="string">&#x27;back&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;l&#x27;</span>]&lt;<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> i.perimeter*k &gt;= -para[<span class="string">&#x27;l&#x27;</span>]: idx[i.label] = para[<span class="string">&#x27;back&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> ls:</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;holes&#x27;</span>] == <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;holes&#x27;</span>]&gt;<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="number">1</span>-i.euler_number &lt; para[<span class="string">&#x27;holes&#x27;</span>]: idx[i.label] = para[<span class="string">&#x27;back&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;holes&#x27;</span>]&lt;<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="number">1</span>-i.euler_number &gt;= -para[<span class="string">&#x27;holes&#x27;</span>]: idx[i.label] = para[<span class="string">&#x27;back&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> ls:</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;solid&#x27;</span>] == <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;solid&#x27;</span>]&gt;<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> i.solidity &lt; para[<span class="string">&#x27;solid&#x27;</span>]: idx[i.label] = para[<span class="string">&#x27;back&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;solid&#x27;</span>]&lt;<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> i.solidity &gt;= -para[<span class="string">&#x27;solid&#x27;</span>]: idx[i.label] = para[<span class="string">&#x27;back&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> ls:</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;e&#x27;</span>] == <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;e&#x27;</span>]&gt;<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> i.minor_axis_length&gt;<span class="number">0</span> <span class="keyword">and</span> i.major_axis_length/i.minor_axis_length &lt; para[<span class="string">&#x27;e&#x27;</span>]:</span><br><span class="line">                    idx[i.label] = para[<span class="string">&#x27;back&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;e&#x27;</span>]&lt;<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> i.minor_axis_length&gt;<span class="number">0</span> <span class="keyword">and</span> i.major_axis_length/i.minor_axis_length &gt;= -para[<span class="string">&#x27;e&#x27;</span>]:</span><br><span class="line">                    idx[i.label] = para[<span class="string">&#x27;back&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        idx[<span class="number">0</span>] = para[<span class="string">&#x27;front&#x27;</span>] <span class="keyword">if</span> para[<span class="string">&#x27;inv&#x27;</span>] <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">       img[:] = idx[lab]</span><br></pre></td></tr></table></figure>
<p>具体解析一下：</p>
<h2 id="生成结构单元"><a href="#生成结构单元" class="headerlink" title="生成结构单元"></a>生成结构单元</h2><p>首先生成一个结构单元，该单元的形式由con参数决定，如果选择了4-connect，则代表处理四邻域，否则就是处理八邻域：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strc = generate_binary_structure(<span class="number">2</span>, <span class="number">1</span> <span class="keyword">if</span> para[<span class="string">&#x27;con&#x27;</span>]==<span class="string">&#x27;4-connect&#x27;</span> <span class="keyword">else</span> <span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>该结构是为了下面的连通域的标记，即在标记区域是否连通时，考察中心像素与周围像素的连通性，该参数非常重要，因为有时考察四邻域不连通，但考察八邻域就连通了。</p>
<h2 id="连通域标记"><a href="#连通域标记" class="headerlink" title="连通域标记"></a>连通域标记</h2><p>然后就是对连通域进行标记：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lab, n = label(snap==<span class="number">0</span> <span class="keyword">if</span> para[<span class="string">&#x27;inv&#x27;</span>] <span class="keyword">else</span> snap, strc, output=np.uint32)</span><br></pre></td></tr></table></figure>
<p>这个地方还提供了一个选项inv来选择处理哪一部分。如果inv是false，那么就是处理原二值图中的1，如果inv是true，那么就通过”snap==0”将原图中的0转化为1。</p>
<h2 id="连通域属性计算"><a href="#连通域属性计算" class="headerlink" title="连通域属性计算"></a>连通域属性计算</h2><p>这一步就是skimage的measure模块的regionprops函数对上面的连通域的属性进行计算，常用的属性有：</p>
<ul>
<li>area：区域内像素点总数</li>
<li>perimeter: 区域周长</li>
<li>euler_number:区域欧拉数，可以用来计算一个连通域内的孔洞数，公式为1-euler_number，比如B字符这个连通域的欧拉数为-1，那么孔洞数就是1-（-1）=2</li>
<li>solidity: 坚实度，区域内像素点数目与其凸包图像的像素点数目的比值</li>
<li>eccentricity: 离心率，这里是长轴与短轴的长度的比值</li>
</ul>
<p>这里的参考文献有：<br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1357073">OpenCV轮廓层次分析实现欧拉数计算</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/pursuit_zhangyu/article/details/94209489">skimage.measure.label和skimage.measure.regionprops()</a></p>
<p>然后调用regionprops函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">idx = (np.ones(n+<span class="number">1</span>)*(<span class="number">0</span> <span class="keyword">if</span> para[<span class="string">&#x27;inv&#x27;</span>] <span class="keyword">else</span> para[<span class="string">&#x27;front&#x27;</span>])).astype(np.uint8)</span><br><span class="line">ls = regionprops(lab)</span><br></pre></td></tr></table></figure>
<p>这里首先又创建了一个idx来临时存储过滤结果，如果没有设置inv的话，就用参数front的灰度值来填充它。<br>然后在不同的过滤器起作用时，将参数back的灰度值填入被过滤掉的像素中。</p>
<p>经过上面的处理后，结果为：<br><img src="https://user-images.githubusercontent.com/6218739/72135032-77828000-33c0-11ea-9574-c3e0c5edbf11.png" alt="geom-filter"></p>
<h1 id="开运算"><a href="#开运算" class="headerlink" title="开运算"></a>开运算</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Binary Opening&gt;&#123;<span class="string">&#x27;w&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;h&#x27;</span>: <span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure>
<p>开运算是一种形态学计算，计算步骤是先腐蚀，后膨胀。通过腐蚀运算能去除小的非关键区域，也可以把离得很近的元素分割开，再通过膨胀填补过度腐蚀留下的空隙。因此，通过开运算能去除一些孤立的、细小的点，平滑毛糙的边缘线，同时原区域面积也不会有明显的改变，类似于“去毛刺”的效果。（以上摘抄自《机器视觉算法原理与编程实战》一书）<br>开运算后的结果如下：<br><img src="https://user-images.githubusercontent.com/6218739/72236302-3b922980-3611-11ea-814d-7d1d3ebde463.png" alt="open"></p>
<h1 id="二值分水岭"><a href="#二值分水岭" class="headerlink" title="二值分水岭"></a>二值分水岭</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Binary Watershed&gt;&#123;<span class="string">&#x27;tor&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;con&#x27;</span>: <span class="literal">False</span>&#125;</span><br></pre></td></tr></table></figure>
<p>这一步是做二值分水岭。之前有过对该算法的详细解析，见<a target="_blank" rel="noopener" href="http://qixinbo.info/2019/12/20/ImagePy_15/">这里</a><br>这一步的目的就是将黏连的细胞分割开：<br><img src="https://user-images.githubusercontent.com/6218739/72236532-3e414e80-3612-11ea-9955-c3f9615166fb.png" alt="watershed-cell"></p>
<h1 id="几何分析"><a href="#几何分析" class="headerlink" title="几何分析"></a>几何分析</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Geometry Analysis&gt;&#123;<span class="string">&#x27;con&#x27;</span>: <span class="string">&#x27;4-connect&#x27;</span>, <span class="string">&#x27;center&#x27;</span>: <span class="literal">True</span>, <span class="string">&#x27;area&#x27;</span>: <span class="literal">True</span>, <span class="string">&#x27;l&#x27;</span>: <span class="literal">True</span>, <span class="string">&#x27;extent&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;cov&#x27;</span>: <span class="literal">True</span>, <span class="string">&#x27;slice&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;ed&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;holes&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;ca&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;fa&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;solid&#x27;</span>: <span class="literal">False</span>&#125;</span><br></pre></td></tr></table></figure>
<p>这一步“几何分析”与上面的“几何过滤”本质操作是一样的，都是先生成结构单元，然后标记连通域，再调用regionprops计算各个连通域的各种属性。只不过这里没有过滤功能，是对最后的连通域的分析。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegionCounter</span>(<span class="params">Simple</span>):</span></span><br><span class="line">    title = <span class="string">&#x27;Geometry Analysis&#x27;</span></span><br><span class="line">    note = [<span class="string">&#x27;8-bit&#x27;</span>, <span class="string">&#x27;16-bit&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]</span><br><span class="line">    para = &#123;<span class="string">&#x27;con&#x27;</span>:<span class="string">&#x27;8-connect&#x27;</span>, <span class="string">&#x27;center&#x27;</span>:<span class="literal">True</span>, <span class="string">&#x27;area&#x27;</span>:<span class="literal">True</span>, <span class="string">&#x27;l&#x27;</span>:<span class="literal">True</span>, <span class="string">&#x27;extent&#x27;</span>:<span class="literal">False</span>, <span class="string">&#x27;cov&#x27;</span>:<span class="literal">False</span>, <span class="string">&#x27;slice&#x27;</span>:<span class="literal">False</span>,</span><br><span class="line">            <span class="string">&#x27;ed&#x27;</span>:<span class="literal">False</span>, <span class="string">&#x27;holes&#x27;</span>:<span class="literal">False</span>, <span class="string">&#x27;ca&#x27;</span>:<span class="literal">False</span>, <span class="string">&#x27;fa&#x27;</span>:<span class="literal">False</span>, <span class="string">&#x27;solid&#x27;</span>:<span class="literal">False</span>&#125;</span><br><span class="line">    view = [(<span class="built_in">list</span>, <span class="string">&#x27;con&#x27;</span>, [<span class="string">&#x27;4-connect&#x27;</span>, <span class="string">&#x27;8-connect&#x27;</span>], <span class="built_in">str</span>, <span class="string">&#x27;conection&#x27;</span>, <span class="string">&#x27;pix&#x27;</span>),</span><br><span class="line">            (<span class="built_in">bool</span>, <span class="string">&#x27;slice&#x27;</span>, <span class="string">&#x27;slice&#x27;</span>),</span><br><span class="line">            (<span class="string">&#x27;lab&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;=========  indecate  =========&#x27;</span>),</span><br><span class="line">            (<span class="built_in">bool</span>, <span class="string">&#x27;center&#x27;</span>, <span class="string">&#x27;center&#x27;</span>),</span><br><span class="line">            (<span class="built_in">bool</span>, <span class="string">&#x27;area&#x27;</span>, <span class="string">&#x27;area&#x27;</span>),</span><br><span class="line">            (<span class="built_in">bool</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;perimeter&#x27;</span>),</span><br><span class="line">            (<span class="built_in">bool</span>, <span class="string">&#x27;extent&#x27;</span>, <span class="string">&#x27;extent&#x27;</span>),</span><br><span class="line">            (<span class="built_in">bool</span>, <span class="string">&#x27;ed&#x27;</span>, <span class="string">&#x27;equivalent diameter&#x27;</span>),</span><br><span class="line">            (<span class="built_in">bool</span>, <span class="string">&#x27;ca&#x27;</span>, <span class="string">&#x27;convex area&#x27;</span>),</span><br><span class="line">            (<span class="built_in">bool</span>, <span class="string">&#x27;holes&#x27;</span>, <span class="string">&#x27;holes&#x27;</span>),</span><br><span class="line">            (<span class="built_in">bool</span>, <span class="string">&#x27;fa&#x27;</span>, <span class="string">&#x27;filled area&#x27;</span>),</span><br><span class="line">            (<span class="built_in">bool</span>, <span class="string">&#x27;solid&#x27;</span>, <span class="string">&#x27;solidity&#x27;</span>),</span><br><span class="line">            (<span class="built_in">bool</span>, <span class="string">&#x27;cov&#x27;</span>, <span class="string">&#x27;cov&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="comment">#process</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, ips, imgs, para = <span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> para[<span class="string">&#x27;slice&#x27;</span>]:imgs = [ips.img]</span><br><span class="line">        k = ips.unit[<span class="number">0</span>]</span><br><span class="line">        titles = [<span class="string">&#x27;Slice&#x27;</span>, <span class="string">&#x27;ID&#x27;</span>][<span class="number">0</span> <span class="keyword">if</span> para[<span class="string">&#x27;slice&#x27;</span>] <span class="keyword">else</span> <span class="number">1</span>:]</span><br><span class="line">        <span class="keyword">if</span> para[<span class="string">&#x27;center&#x27;</span>]:titles.extend([<span class="string">&#x27;Center-X&#x27;</span>,<span class="string">&#x27;Center-Y&#x27;</span>])</span><br><span class="line">        <span class="keyword">if</span> para[<span class="string">&#x27;area&#x27;</span>]:titles.append(<span class="string">&#x27;Area&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> para[<span class="string">&#x27;l&#x27;</span>]:titles.append(<span class="string">&#x27;Perimeter&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> para[<span class="string">&#x27;extent&#x27;</span>]:titles.extend([<span class="string">&#x27;Min-Y&#x27;</span>,<span class="string">&#x27;Min-X&#x27;</span>,<span class="string">&#x27;Max-Y&#x27;</span>,<span class="string">&#x27;Max-X&#x27;</span>])</span><br><span class="line">        <span class="keyword">if</span> para[<span class="string">&#x27;ed&#x27;</span>]:titles.extend([<span class="string">&#x27;Diameter&#x27;</span>])</span><br><span class="line">        <span class="keyword">if</span> para[<span class="string">&#x27;ca&#x27;</span>]:titles.extend([<span class="string">&#x27;ConvexArea&#x27;</span>])</span><br><span class="line">        <span class="keyword">if</span> para[<span class="string">&#x27;holes&#x27;</span>]:titles.extend([<span class="string">&#x27;Holes&#x27;</span>])</span><br><span class="line">        <span class="keyword">if</span> para[<span class="string">&#x27;fa&#x27;</span>]:titles.extend([<span class="string">&#x27;FilledArea&#x27;</span>])</span><br><span class="line">        <span class="keyword">if</span> para[<span class="string">&#x27;solid&#x27;</span>]:titles.extend([<span class="string">&#x27;Solidity&#x27;</span>])</span><br><span class="line">        <span class="keyword">if</span> para[<span class="string">&#x27;cov&#x27;</span>]:titles.extend([<span class="string">&#x27;Major&#x27;</span>,<span class="string">&#x27;Minor&#x27;</span>,<span class="string">&#x27;Ori&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        buf = imgs[<span class="number">0</span>].astype(np.uint32)</span><br><span class="line">        data, mark = [], &#123;<span class="string">&#x27;type&#x27;</span>:<span class="string">&#x27;layers&#x27;</span>, <span class="string">&#x27;body&#x27;</span>:&#123;&#125;&#125;</span><br><span class="line">        strc = generate_binary_structure(<span class="number">2</span>, <span class="number">1</span> <span class="keyword">if</span> para[<span class="string">&#x27;con&#x27;</span>]==<span class="string">&#x27;4-connect&#x27;</span> <span class="keyword">else</span> <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(imgs)):</span><br><span class="line">            label(imgs[i], strc, output=buf)</span><br><span class="line">            ls = regionprops(buf)</span><br><span class="line"></span><br><span class="line">            dt = [[i]*<span class="built_in">len</span>(ls), <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(ls)))]</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> para[<span class="string">&#x27;slice&#x27;</span>]:dt = dt[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">            layer = &#123;<span class="string">&#x27;type&#x27;</span>:<span class="string">&#x27;layer&#x27;</span>, <span class="string">&#x27;body&#x27;</span>:[]&#125;</span><br><span class="line">            texts = [(i.centroid[::-<span class="number">1</span>])+(<span class="string">&#x27;id=%d&#x27;</span>%n,) <span class="keyword">for</span> i,n <span class="keyword">in</span> <span class="built_in">zip</span>(ls,<span class="built_in">range</span>(<span class="built_in">len</span>(ls)))]</span><br><span class="line">            layer[<span class="string">&#x27;body&#x27;</span>].append(&#123;<span class="string">&#x27;type&#x27;</span>:<span class="string">&#x27;texts&#x27;</span>, <span class="string">&#x27;body&#x27;</span>:texts&#125;)</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;cov&#x27;</span>]:</span><br><span class="line">                ellips = [i.centroid[::-<span class="number">1</span>] + (i.major_axis_length/<span class="number">2</span>,i.minor_axis_length/<span class="number">2</span>,i.orientation) <span class="keyword">for</span> i <span class="keyword">in</span> ls]</span><br><span class="line">                layer[<span class="string">&#x27;body&#x27;</span>].append(&#123;<span class="string">&#x27;type&#x27;</span>:<span class="string">&#x27;ellipses&#x27;</span>, <span class="string">&#x27;body&#x27;</span>:ellips&#125;)</span><br><span class="line">            mark[<span class="string">&#x27;body&#x27;</span>][i] = layer</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;center&#x27;</span>]:</span><br><span class="line">                dt.append([<span class="built_in">round</span>(i.centroid[<span class="number">1</span>]*k,<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line">                dt.append([<span class="built_in">round</span>(i.centroid[<span class="number">0</span>]*k,<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;area&#x27;</span>]:</span><br><span class="line">                dt.append([i.area*k**<span class="number">2</span> <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;l&#x27;</span>]:</span><br><span class="line">                dt.append([<span class="built_in">round</span>(i.perimeter*k,<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;extent&#x27;</span>]:</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> (<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>):</span><br><span class="line">                    dt.append([i.bbox[j]*k <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;ed&#x27;</span>]:</span><br><span class="line">                dt.append([<span class="built_in">round</span>(i.equivalent_diameter*k, <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;ca&#x27;</span>]:</span><br><span class="line">                dt.append([i.convex_area*k**<span class="number">2</span> <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;holes&#x27;</span>]:</span><br><span class="line">                dt.append([<span class="number">1</span>-i.euler_number <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;fa&#x27;</span>]:</span><br><span class="line">                dt.append([i.filled_area*k**<span class="number">2</span> <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;solid&#x27;</span>]:</span><br><span class="line">                dt.append([<span class="built_in">round</span>(i.solidity, <span class="number">2</span>) <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line">            <span class="keyword">if</span> para[<span class="string">&#x27;cov&#x27;</span>]:</span><br><span class="line">                dt.append([<span class="built_in">round</span>(i.major_axis_length*k, <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line">                dt.append([<span class="built_in">round</span>(i.minor_axis_length*k, <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line">                dt.append([<span class="built_in">round</span>(i.orientation*k, <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line"></span><br><span class="line">            data.extend(<span class="built_in">list</span>(<span class="built_in">zip</span>(*dt)))</span><br><span class="line">        ips.mark = GeometryMark(mark)</span><br><span class="line">        IPy.show_table(pd.DataFrame(data, columns=titles), ips.title+<span class="string">&#x27;-region&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>可以从最后面两行代码看出，几何分析比几何过滤还多了两个功能，一个是对连通域的绘制，一个是对连通域属性的表格统计。<br>这两个功能值得深究一下，因为它们提供了怎样统一管理各个连通域并可视化呈现的思路。</p>
<h2 id="连通域绘制"><a href="#连通域绘制" class="headerlink" title="连通域绘制"></a>连通域绘制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">data, mark &#x3D; [], &#123;&#39;type&#39;:&#39;layers&#39;, &#39;body&#39;:&#123;&#125;&#125;</span><br><span class="line">for i in range(len(imgs)):</span><br><span class="line">    label(imgs[i], strc, output&#x3D;buf)</span><br><span class="line">    ls &#x3D; regionprops(buf)</span><br><span class="line"></span><br><span class="line">    layer &#x3D; &#123;&#39;type&#39;:&#39;layer&#39;, &#39;body&#39;:[]&#125;</span><br><span class="line">    texts &#x3D; [(i.centroid[::-1])+(&#39;id&#x3D;%d&#39;%n,) for i,n in zip(ls,range(len(ls)))]</span><br><span class="line">    layer[&#39;body&#39;].append(&#123;&#39;type&#39;:&#39;texts&#39;, &#39;body&#39;:texts&#125;)</span><br><span class="line">    if para[&#39;cov&#39;]:</span><br><span class="line">        ellips &#x3D; [i.centroid[::-1] + (i.major_axis_length&#x2F;2,i.minor_axis_length&#x2F;2,i.orientation) for i in ls]</span><br><span class="line">        layer[&#39;body&#39;].append(&#123;&#39;type&#39;:&#39;ellipses&#39;, &#39;body&#39;:ellips&#125;)</span><br><span class="line">    mark[&#39;body&#39;][i] &#x3D; layer</span><br><span class="line">ips.mark &#x3D; GeometryMark(mark)</span><br></pre></td></tr></table></figure>
<p>首先是对整个图像栈进行循环，因为这里只有一张图像，所以imgs的length是1。<br>然后就是对该图像使用label()函数进行标记，及使用reginprops()函数进行连通域属性分析。得到的ls变量为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&lt;skimage.measure._re...CFF7AF8D0&gt;, &lt;skimage.measure._re...CFE7B2D30&gt;, &lt;skimage.measure._re...CFE7B25C0&gt;, &lt;skimage.measure._re...CFE7B25F8&gt;, &lt;skimage.measure._re...CFE7B2978&gt;, &lt;skimage.measure._re...CFE7B2AC8&gt;, &lt;skimage.measure._re...CFE7B29E8&gt;, &lt;skimage.measure._re...CFE7B2BA8&gt;, &lt;skimage.measure._re...CFE7B2DA0&gt;, &lt;skimage.measure._re...CFE7B2898&gt;, &lt;skimage.measure._re...CFE7B2DD8&gt;, &lt;skimage.measure._re...CFE7B2828&gt;, &lt;skimage.measure._re...CFE7B27F0&gt;, &lt;skimage.measure._re...CFE7B2780&gt;, ...]</span><br></pre></td></tr></table></figure>
<p>其中第0个元素为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;skimage.measure._regionprops._RegionProperties <span class="built_in">object</span> at <span class="number">0x000001ECFF7AF8D0</span>&gt;</span><br></pre></td></tr></table></figure>
<p>可以看出ls变量是一个这种RegionProperties类型的列表，该类型又包含了area、bbox、centroid等连通域的具体属性。针对于该图像，ls的length为35，表明有35个连通域。</p>
<p>再建立一个字典layer，用来盛放各个连通域的标识：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">layer = &#123;<span class="string">&#x27;type&#x27;</span>:<span class="string">&#x27;layer&#x27;</span>, <span class="string">&#x27;body&#x27;</span>:[]&#125;</span><br><span class="line">texts = [(i.centroid[::-<span class="number">1</span>])+(<span class="string">&#x27;id=%d&#x27;</span>%n,) <span class="keyword">for</span> i,n <span class="keyword">in</span> <span class="built_in">zip</span>(ls,<span class="built_in">range</span>(<span class="built_in">len</span>(ls)))]</span><br><span class="line">layer[<span class="string">&#x27;body&#x27;</span>].append(&#123;<span class="string">&#x27;type&#x27;</span>:<span class="string">&#x27;texts&#x27;</span>, <span class="string">&#x27;body&#x27;</span>:texts&#125;)</span><br></pre></td></tr></table></figure>
<p>texts中是提取了各个连通域的centroid及附上’id=0’类似的标识，然后在layer的body中再添加一个字典。所以，layer是一个嵌套型的字典，最上层的字段type是”layer”，字段body中又包含一个字典，该字典的字段type是”texts”，字段body是一个列表，里面包含了35个连通域的位置和标识。</p>
<p>从接下来代码可以看出，如果para中设置了conv，那么再在layer的body字段中添加一个字典，其字段type为ellipse，字段body则是centroid与半长轴、半短轴和取向的加和。</p>
<p>然后将layer加入到最高级别的mark的body字段中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mark[<span class="string">&#x27;body&#x27;</span>][i] = layer</span><br></pre></td></tr></table></figure>
<p>mark字典的字段type则是layers。<br>而这个mark则会被当做GeometryMark类的参数被封装一下后传给ips图像类的mark属性，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ips.mark = GeometryMark(mark)</span><br></pre></td></tr></table></figure>
<p>这一步的信息量非常大，其包含了多个操作：<br>（1）将mark传入GeometryMark类中，形成一个该类的对象，并传给ips的mark属性：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drawmark</span>(<span class="params">dc, f, body, **key</span>):</span></span><br><span class="line">	pen, brush, font = dc.GetPen(), dc.GetBrush(), dc.GetFont()</span><br><span class="line">	pen.SetColour(default_color <span class="keyword">or</span> (<span class="number">255</span>,<span class="number">255</span>,<span class="number">0</span>))</span><br><span class="line">	brush.SetColour(default_face <span class="keyword">or</span> (<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>))</span><br><span class="line">	brush.SetStyle((<span class="number">106</span>,<span class="number">100</span>)[default_fill <span class="keyword">or</span> <span class="literal">False</span>])</span><br><span class="line">	pen.SetWidth(default_lw <span class="keyword">or</span> <span class="number">1</span>)</span><br><span class="line">	dc.SetTextForeground(default_tcolor <span class="keyword">or</span> (<span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>))</span><br><span class="line">	font.SetPointSize(default_tsize <span class="keyword">or</span> <span class="number">8</span>)</span><br><span class="line">	dc.SetPen(pen); dc.SetBrush(brush); dc.SetFont(font);</span><br><span class="line">	draw(body, dc, f, **key)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GeometryMark</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, body</span>):</span></span><br><span class="line">		self.body = body</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">draw</span>(<span class="params">self, dc, f, **key</span>):</span></span><br><span class="line">		drawmark(dc, f, self.body, key)</span><br></pre></td></tr></table></figure>
<p>可以看出，该类有一个draw()函数，接着调用了drawmark()函数，即调用了该python文件上面的一系列的自定义的绘图方法，如draw_text()、draw_ellipse()、draw_circle()等等，具体的绘图参数也是按照上面mark变量的层级进行提取和使用。</p>
<p>（2）ips的mark属性的draw方法会传入画布canvas的marks属性中：<br>这一步是发生在canvasframe.py文件的CanvasPanel类的on_idle()函数中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.ips.dirty != <span class="literal">False</span>:</span><br><span class="line">    <span class="keyword">if</span> self.ips.mark <span class="keyword">is</span> <span class="literal">None</span>: self.canvas.marks[<span class="string">&#x27;mark&#x27;</span>] = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        draw = <span class="keyword">lambda</span> dc, f, **key: self.ips.mark.draw(dc, f, cur=self.ips.cur, **key)</span><br><span class="line">        self.canvas.marks[<span class="string">&#x27;mark&#x27;</span>] = draw</span><br></pre></td></tr></table></figure>
<p>注意，该CanvasPanel类实际会继续调用Canvas类来进行显示图像，上述函数中调用了Canvas类的update()函数进行画布更新显示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.canvas.update()</span><br></pre></td></tr></table></figure>
<p>（3）画布更新的同时进行标注显示<br>在Canvas类的update()函数中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self</span>):</span></span><br><span class="line">…</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.marks:</span><br><span class="line">            <span class="keyword">if</span> self.marks[i] <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">callable</span>(self.marks[i]):</span><br><span class="line">                self.marks[i](dc, self.to_panel_coor, k = self.scale)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                drawmark(dc, self.to_panel_coor, self.marks[i], k=self.scale)</span><br></pre></td></tr></table></figure>
<p>可以看出，有一个callable判定（对于函数、方法、lambda 函式、 类以及实现了 <strong>call</strong> 方法的类实例, 它都返回 True。），在这里进行那些标识的绘制。<br>结果如图：<br><img src="https://user-images.githubusercontent.com/6218739/74136499-1a7d2280-4c29-11ea-9381-080d05bb4e75.png" alt="mark"></p>
<h2 id="连通域属性的表格统计"><a href="#连通域属性的表格统计" class="headerlink" title="连通域属性的表格统计"></a>连通域属性的表格统计</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dt = [[i]*<span class="built_in">len</span>(ls), <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(ls)))]</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> para[<span class="string">&#x27;slice&#x27;</span>]:dt = dt[<span class="number">1</span>:]</span><br></pre></td></tr></table></figure>
<p>根据上面ls变量的长度构建一个新的容器dt：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dt = [[i]*<span class="built_in">len</span>(ls), <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(ls)))]</span><br></pre></td></tr></table></figure>
<p>具体地，dt的值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, ...], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, ...]]</span><br></pre></td></tr></table></figure>
<p>如果在para没有选定slice，那么就只取dt的后一部分：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> para[<span class="string">&#x27;slice&#x27;</span>]:dt = dt[<span class="number">1</span>:]</span><br></pre></td></tr></table></figure>
<p>即，dt变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, ...]]</span><br></pre></td></tr></table></figure>
<p>然后，再依次将各个连通域的各个属性值依次提取到dt中，比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> para[<span class="string">&#x27;center&#x27;</span>]:</span><br><span class="line">    dt.append([<span class="built_in">round</span>(i.centroid[<span class="number">1</span>]*k,<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br><span class="line">    dt.append([<span class="built_in">round</span>(i.centroid[<span class="number">0</span>]*k,<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> ls])</span><br></pre></td></tr></table></figure>
<p>最后将dt打包成data：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.extend(<span class="built_in">list</span>(<span class="built_in">zip</span>(*dt)))</span><br></pre></td></tr></table></figure>
<p>data中的数据形如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(<span class="number">0</span>, <span class="number">243.6</span>, <span class="number">28.1</span>, <span class="number">1785</span>, <span class="number">155.4</span>, <span class="number">49.3</span>, <span class="number">46.2</span>, -<span class="number">0.9</span>), (<span class="number">1</span>, <span class="number">45.4</span>, <span class="number">48.4</span>, <span class="number">1443</span>, <span class="number">141.1</span>, <span class="number">44.1</span>, <span class="number">41.7</span>, <span class="number">1.5</span>), ...]</span><br></pre></td></tr></table></figure>
<p>即每个连通域的各个属性打包在一块。<br>然后使用IPy的show_table()函数将其显示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPy.show_table(pd.DataFrame(data, columns=titles), ips.title+<span class="string">&#x27;-region&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>ImagePy也提供了专门的TablePlus类来存储table数据和TablePanel类来显示table数据。</p>
<p>结果如图：<br><img src="https://user-images.githubusercontent.com/6218739/74136683-79db3280-4c29-11ea-8309-86c575fdbbc0.png" alt="tables"></p>
<h1 id="做散点图"><a href="#做散点图" class="headerlink" title="做散点图"></a>做散点图</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Scatter Chart&gt;&#123;<span class="string">&#x27;x&#x27;</span>: <span class="string">&#x27;Center-X&#x27;</span>, <span class="string">&#x27;y&#x27;</span>: <span class="string">&#x27;Center-Y&#x27;</span>, <span class="string">&#x27;s&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;alpha&#x27;</span>: <span class="number">1.0</span>, <span class="string">&#x27;rs&#x27;</span>: <span class="string">&#x27;Perimeter&#x27;</span>, <span class="string">&#x27;c&#x27;</span>: (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="string">&#x27;cs&#x27;</span>: <span class="string">&#x27;Area&#x27;</span>, <span class="string">&#x27;cm&#x27;</span>: <span class="string">&#x27;Red_Hot&#x27;</span>, <span class="string">&#x27;grid&#x27;</span>: <span class="literal">True</span>, <span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;Cells Scatter&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>这里的散点图绘制用的是Table引擎，该引擎原理类似于之前的引擎，不再详述。<br>作图是调用的matplotlib库，结果为：<br><img src="https://user-images.githubusercontent.com/6218739/74138224-30d8ad80-4c2c-11ea-8410-120807b8548f.png" alt="scatter"></p>
<p>这一篇太长了。。等着再接着写吧。。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/12/20/ImagePy_15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/20/ImagePy_15/" class="post-title-link" itemprop="url">ImagePy解析：15 -- 分水岭Watershed算法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-20 00:00:00" itemprop="dateCreated datePublished" datetime="2019-12-20T00:00:00+08:00">2019-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/12/20/ImagePy_15/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/12/20/ImagePy_15/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>%%%%%%%%%%%%%%<br>2020-8-2更新：增加寻找邻居标识的过程解析<br>%%%%%%%%%%%%%%</p>
<p>参考文献：<br><a target="_blank" rel="noopener" href="http://qixinbo.info/2019/07/20/opencv-watershed/">OpenCV分水岭Watershed算法的前因后果</a><br><a target="_blank" rel="noopener" href="http://www.cmm.mines-paristech.fr/~beucher/wtshed.html">The Watershed Transformation</a></p>
<h1 id="图像准备"><a href="#图像准备" class="headerlink" title="图像准备"></a>图像准备</h1><p>此处分水岭算法所使用的样例图像为：<br><img src="https://user-images.githubusercontent.com/6218739/70704608-49e8df00-1d0d-11ea-8abc-b3c321d689ea.png" alt="watershed-display"><br>上述图像仅是为了便于展示，其实际尺寸为15乘以15像素，即像素矩阵为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[[  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,     <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,     <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,     <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,     <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">[  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>]]</span><br></pre></td></tr></table></figure>

<h1 id="算法准备"><a href="#算法准备" class="headerlink" title="算法准备"></a>算法准备</h1><p>分水岭算法需要配合其他的一些算法一块使用，才能获得较好的分割效果，即该算法需要一些前置算法的帮助，如获得种子标记等。<br>经过仔细对比，发现ImagePy的Process下的Binary下的Binary Watershed的流程较为简单，适合入手：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watershed</span>(<span class="params">Filter</span>):</span></span><br><span class="line">	<span class="string">&quot;&quot;&quot;Mark class plugin with events callback functions&quot;&quot;&quot;</span></span><br><span class="line">	title = <span class="string">&#x27;Binary Watershed&#x27;</span></span><br><span class="line">	note = [<span class="string">&#x27;8-bit&#x27;</span>, <span class="string">&#x27;auto_msk&#x27;</span>, <span class="string">&#x27;auto_snap&#x27;</span>, <span class="string">&#x27;preview&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	para = &#123;<span class="string">&#x27;tor&#x27;</span>:<span class="number">2</span>, <span class="string">&#x27;con&#x27;</span>:<span class="literal">False</span>&#125;</span><br><span class="line">	view = [(<span class="built_in">int</span>, <span class="string">&#x27;tor&#x27;</span>, (<span class="number">0</span>,<span class="number">255</span>), <span class="number">0</span>, <span class="string">&#x27;tolerance&#x27;</span>, <span class="string">&#x27;value&#x27;</span>),</span><br><span class="line">			(<span class="built_in">bool</span>, <span class="string">&#x27;con&#x27;</span>, <span class="string">&#x27;full connectivity&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, ips, snap, img, para = <span class="literal">None</span></span>):</span></span><br><span class="line">		img[:] = snap&gt;<span class="number">0</span></span><br><span class="line">		dist = distance_transform_edt(snap, output=np.uint16)</span><br><span class="line">		pts = find_maximum(dist, para[<span class="string">&#x27;tor&#x27;</span>], <span class="literal">True</span>)</span><br><span class="line">		buf = np.zeros(ips.size, dtype=np.uint32)</span><br><span class="line">		buf[pts[:,<span class="number">0</span>], pts[:,<span class="number">1</span>]] = img[pts[:,<span class="number">0</span>], pts[:,<span class="number">1</span>]] = <span class="number">2</span></span><br><span class="line">		markers, n = ndimg.label(buf, np.ones((<span class="number">3</span>,<span class="number">3</span>)))</span><br><span class="line">		line = watershed(dist, markers, line=<span class="literal">True</span>, conn=para[<span class="string">&#x27;con&#x27;</span>]+<span class="number">1</span>, up=<span class="literal">False</span>)</span><br><span class="line">		msk = apply_hysteresis_threshold(img, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">		img[:] = snap * ~((line==<span class="number">0</span>) &amp; msk)</span><br></pre></td></tr></table></figure>
<p>该算法的源程序在<a target="_blank" rel="noopener" href="https://github.com/Image-Py/imagepy/blob/c6d715cc06d9e0567ef973b9de7bac42467256fe/imagepy/menus/Process/Binary/distance_plgs.py#L45">这里</a>。<br>可以看出，该算法有两个参数tolerance和是否Full connectivity，以及需要前面的二值图。<br>另外，在Process的Hydrology下也有一个<a target="_blank" rel="noopener" href="https://github.com/Image-Py/imagepy/blob/10fff38d95626d57db9480eaa9b3731e7409d334/imagepy/menus/Process/Hydrology/hydrology_plgs.py#L120">Find Watershed</a>，它接收的参数多了sigma和thr，因为它接收一个灰度图，对其先做一个高斯滤波，然后根据阈值分割来确定标记种子。<br>这两处的分水岭原理都是一样的，都是调用了主文件夹下的ipyalg下的hydrology下的watershed算法，只是种子点的选取方式不同。</p>
<p>下面就是对二值分水岭Binary Watershed的run()函数的逐步解析。</p>
<h1 id="二值化"><a href="#二值化" class="headerlink" title="二值化"></a>二值化</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img[:] = snap&gt;<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>前面的解析文章已经说过，snap是在图像被处理之前的一个快照。这一步是根据其是否大于0来对图像进行二值化操作，即0值保留，大于0的值都设为1。那么img经过二值化操作后，就变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]], dtype=uint8)</span><br></pre></td></tr></table></figure>
<p>注意，snap的值不变，最后一步还要用到它。</p>
<h1 id="距离变换"><a href="#距离变换" class="headerlink" title="距离变换"></a>距离变换</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dist = distance_transform_edt(snap, output=np.uint16)</span><br></pre></td></tr></table></figure>
<p>这一步是得到距离变换图，具体距离变换的原理留待后续解析，这里直接给出距离变换的结果，即dist的值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]], dtype=uint16)</span><br></pre></td></tr></table></figure>
<p>可以看出，两个白色方块的边缘上的距离值都是1，方块中心的距离值都是4，即计算结果为某一点与背景像素点（值为0）的棋盘距离（也许这里函数后缀为edt不合适？意味着是欧几里得距离？）。</p>
<h1 id="寻找局部极值"><a href="#寻找局部极值" class="headerlink" title="寻找局部极值"></a>寻找局部极值</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pts = find_maximum(dist, para[<span class="string">&#x27;tor&#x27;</span>], <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>这一步是根据上面的距离变换图寻找局部极值（这里是极大值），具体的寻找原理见之前的解析，在<a target="_blank" rel="noopener" href="http://qixinbo.info/2019/11/17/ImagePy_14/">这里</a>。<br>这里的tolerance参数非常重要，它决定着每个局部极大值的“领地”，如果设置不当，就有可能找不到。针对这张图，因为其尺寸很小，这里只能设置为1。<br>经过计算后，pts的值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="number">4</span>, <span class="number">5</span>], [<span class="number">8</span>, <span class="number">9</span>]], dtype=int16)</span><br></pre></td></tr></table></figure>
<p>即这两个白色方块的中心点的坐标位置。</p>
<h1 id="标记局部极值的位置"><a href="#标记局部极值的位置" class="headerlink" title="标记局部极值的位置"></a>标记局部极值的位置</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buf = np.zeros(ips.size, dtype=np.uint32)</span><br><span class="line">buf[pts[:,<span class="number">0</span>], pts[:,<span class="number">1</span>]] = img[pts[:,<span class="number">0</span>], pts[:,<span class="number">1</span>]] = <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>首先创建了一个与图像同样大小的缓冲区，初始值全部为0，然后根据前面得到的局部极大值的坐标位置，将缓冲区和二值化后的img的该位置处的像素值设为2。<br>那么，此时buf的值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]], dtype=uint32)</span><br></pre></td></tr></table></figure>
<p>img的值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]], dtype=uint8)</span><br></pre></td></tr></table></figure>

<h1 id="标识种子（根据极值点位置进行标号）"><a href="#标识种子（根据极值点位置进行标号）" class="headerlink" title="标识种子（根据极值点位置进行标号）"></a>标识种子（根据极值点位置进行标号）</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">markers, n = ndimg.label(buf, np.ones((<span class="number">3</span>,<span class="number">3</span>)))</span><br></pre></td></tr></table></figure>
<p>这里特别注意scipy的ndimage包的label函数，它是为了标记矩阵中的特征，比如标识有多少个连通区域。<br>这里使用了一个3乘以3的、且值都是1的核，表示只要八邻域内有值即表示两者是同一个特征。<br>经过特征标注后，n的值为2，表示有两个种子点。<br>markers的值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]])</span><br></pre></td></tr></table></figure>
<h1 id="分水岭"><a href="#分水岭" class="headerlink" title="分水岭"></a>分水岭</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">line = watershed(dist, markers, line=<span class="literal">True</span>, conn=para[<span class="string">&#x27;con&#x27;</span>]+<span class="number">1</span>, up=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p>这一步就是实际调用了通用的分水岭算法，算法在<a target="_blank" rel="noopener" href="https://github.com/Image-Py/imagepy/blob/10fff38d95626d57db9480eaa9b3731e7409d334/imagepy/ipyalg/hydrology/watershed.py#L80">这里</a>。<br>这里计算分水岭的算法基于浸没模拟（Immersion Simulation)思想：在种子点位置，刺穿一个小孔，或称打一个洞，然后把整个模型慢慢浸入水中，随着浸入的加深，种子点的影响区域慢慢向外扩展，在两个集水盆汇合处构筑大坝，即形成分水岭。由于修建的大坝将阻止聚合，即，浸没结束时，所建立的堤坝就对应于区域的轮廓，而集水盆则对应分割区域。</p>
<p>“高”和“低”是一个相对的概念，上面思想是在两个山谷处注水，从而找到“分水岭”；同样地，也可以将原图像进行“反向”，使得山顶变为山谷，然后在原“山顶”（即现”山谷“）处进行注水（注意，注水都是在山谷处进行），那么就得到了现图像的”分水岭“，效果就是找到了原图像的”河谷线“。</p>
<p>首先需要明确它的inputs是什么：距离变换图dist、种子标识markers、是否标识分水岭line、邻域范围conn、是否向上注水up。<br>具体解释一下：<br>距离变换图：之所以选择距离变换图作为分水岭算法的输入，是因为它是一个有高低起伏的地形图，必须要依据它进行“注水建大坝”；<br>种子标识：这里的种子是局部极大值点，种子也可以是一个区域；<br>是否标识分水岭：如果要标识出分水岭，就会在分水岭处设置一个大数，反之，两个连通域就硬碰硬；<br>邻域范围：这个参数决定了中心像素的邻域范围是多大，如果con为False，那么conn就是1，就是四邻域，如果con为True，那么conn就是2，就是八邻域；<br>是否向上注水：该参数与选择的种子点密切相关，即如果标记的是山峰位置，那么up就得是False，即向下下雨；如果标记的是盆地位置，那么up就是True，即向上注水。</p>
<h2 id="变换数据范围"><a href="#变换数据范围" class="headerlink" title="变换数据范围"></a>变换数据范围</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">watershed</span>(<span class="params">img, mark, conn=<span class="number">1</span>, line=<span class="literal">False</span>, up=<span class="literal">True</span></span>):</span></span><br><span class="line">    maxv = img.<span class="built_in">max</span>(); minv = img.<span class="built_in">min</span>();</span><br><span class="line">    <span class="keyword">if</span> img.dtype != np.uint8:</span><br><span class="line">        img = ((img-minv)*(<span class="number">255</span>/(maxv-minv))).astype(np.uint8）</span><br></pre></td></tr></table></figure>
<p>注意，上面的img形参就是传入的距离图dist，它的dtype是uint16，它最大值是4，最小值是0，上面的代码将其范围转换为0到255之间。具体做法就是先取得最大值和最小值，然后将其归一化，再乘以255，那么img的值变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">array([[  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>,  <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">127</span>,  <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">191</span>, <span class="number">255</span>, <span class="number">191</span>, <span class="number">127</span>,  <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">127</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>,  <span class="number">63</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">127</span>,  <span class="number">63</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">191</span>, <span class="number">255</span>, <span class="number">191</span>, <span class="number">127</span>,  <span class="number">63</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">127</span>,  <span class="number">63</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>,  <span class="number">63</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>]], dtype=uint8)</span><br></pre></td></tr></table></figure>

<h2 id="四周填充"><a href="#四周填充" class="headerlink" title="四周填充"></a>四周填充</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">img = buffer(img, np.uint8)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buffer</span>(<span class="params">img, dtype</span>):</span></span><br><span class="line">    buf = np.zeros(<span class="built_in">tuple</span>(np.array(img.shape)+<span class="number">2</span>), dtype=dtype)</span><br><span class="line">    buf[<span class="built_in">tuple</span>([<span class="built_in">slice</span>(<span class="number">1</span>,-<span class="number">1</span>)]*buf.ndim)] = img</span><br><span class="line">    <span class="keyword">return</span> buf</span><br></pre></td></tr></table></figure>
<p>这一步是将img的四周用0填充，即原来img是15乘以15大小，填充后的img是17乘以17大小，且具体数值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">array([[  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>,  <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">127</span>,  <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">191</span>, <span class="number">255</span>, <span class="number">191</span>, <span class="number">127</span>,  <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,    <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">127</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">127</span>, <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">191</span>, <span class="number">255</span>, <span class="number">191</span>, <span class="number">127</span>, <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">191</span>, <span class="number">127</span>, <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">127</span>, <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>,  <span class="number">63</span>, <span class="number">63</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>]], dtype=uint8)</span><br></pre></td></tr></table></figure>
<p>同理，对于种子标识点也做同样的填充：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mark = buffer(mark, np.uint32)</span><br></pre></td></tr></table></figure>
<p>mark即变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]], dtype=uint32)</span><br></pre></td></tr></table></figure>
<p>但注意两者的数据类型dtype，前者是uint8类型，后者是uint32类型。<br>然后对mark来说，将四周填充的0改为2的32次方减1（用十六进制表示就是0xffffffff），这样就明确标识出了四周边界（后面还会用4294967294，即0xfffffffe，来标识出内部边界，即分水岭）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ndim = img.ndim</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(ndim):</span><br><span class="line">    idx = [<span class="built_in">slice</span>(<span class="literal">None</span>) <span class="keyword">if</span> i!=n <span class="keyword">else</span> [<span class="number">0</span>,-<span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ndim)]</span><br><span class="line">    mark[<span class="built_in">tuple</span>(idx)] = <span class="number">0xffffffff</span></span><br></pre></td></tr></table></figure>
<p>那么，mark变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">1</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">2</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,           <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,            <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,          <span class="number">0</span>,              <span class="number">0</span>,             <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>]], dtype=uint32)</span><br></pre></td></tr></table></figure>
<h2 id="寻找邻居标识并压平图像"><a href="#寻找邻居标识并压平图像" class="headerlink" title="寻找邻居标识并压平图像"></a>寻找邻居标识并压平图像</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nbs = neighbors(img.shape, conn)</span><br></pre></td></tr></table></figure>
<p>该步是计算某个像素的邻居点的标识，比如它左侧的邻居像素标识就是-1，右侧的邻居标识就是1。neighbors函数的具体写法之所以看着繁琐，是为了适配任意维度，保证程序的鲁棒性。<br>另外，这里用到了整个分水岭算法的第四个参数conn，即Full Connectivity，实测该参数是控制计算四邻域还是八邻域。默认full connectivity是False。<br>寻找邻居标识的具体过程为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">block = generate_binary_structure(dim, conn)</span><br></pre></td></tr></table></figure>
<p>即先生成一个二元的结构单元，这个结构单元的大小和内容由维度和连通性来决定。如果连通性为1，即寻找的是4邻域，另外，若dim为2，即图像的shape有二维，那么该结构单元为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="literal">False</span>  <span class="literal">True</span> <span class="literal">False</span>]</span><br><span class="line">[ <span class="literal">True</span>  <span class="literal">True</span>  <span class="literal">True</span>]</span><br><span class="line">[<span class="literal">False</span>  <span class="literal">True</span> <span class="literal">False</span>]]</span><br></pre></td></tr></table></figure>
<p>若dim为3，且连通性仍为1，则：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[[[<span class="literal">False</span> <span class="literal">False</span> <span class="literal">False</span>]</span><br><span class="line">  [<span class="literal">False</span>  <span class="literal">True</span> <span class="literal">False</span>]</span><br><span class="line">  [<span class="literal">False</span> <span class="literal">False</span> <span class="literal">False</span>]]</span><br><span class="line">[[<span class="literal">False</span>  <span class="literal">True</span> <span class="literal">False</span>]</span><br><span class="line">  [ <span class="literal">True</span>  <span class="literal">True</span>  <span class="literal">True</span>]</span><br><span class="line">  [<span class="literal">False</span>  <span class="literal">True</span> <span class="literal">False</span>]]</span><br><span class="line">[[<span class="literal">False</span> <span class="literal">False</span> <span class="literal">False</span>]</span><br><span class="line">  [<span class="literal">False</span>  <span class="literal">True</span> <span class="literal">False</span>]</span><br><span class="line">  [<span class="literal">False</span> <span class="literal">False</span> <span class="literal">False</span>]]]</span><br></pre></td></tr></table></figure>
<p>这里可以将其联想成一个3乘3的魔方，二维时候的4邻域就变成了三维时的6邻域，此时中心像素与邻居的距离都是1个棋盘距离；同理，二维时的8邻域就变成了三维时的18邻域，这时中心像素与邻居的距离都是2个棋盘距离以内；同时，三维时还有魔方的八个角点也作为邻居时的情形，此时中心像素与邻居的距离都是3个棋盘距离以内，即此时三维的邻域就是26邻域。</p>
<p>下面的解析都以二维且4邻域为例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">block[<span class="built_in">tuple</span>([<span class="number">1</span>]*dim)] = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>这一步是将中心像素的标识置为0，因此，此时block变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="literal">False</span>  <span class="literal">True</span> <span class="literal">False</span>]</span><br><span class="line">[ <span class="literal">True</span>  Flase  <span class="literal">True</span>]</span><br><span class="line">[<span class="literal">False</span>  <span class="literal">True</span> <span class="literal">False</span>]]</span><br></pre></td></tr></table></figure>
<p>接下来取得这些邻居所在的索引指标：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idx = np.where(block&gt;<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>idx的输出为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idx =  (array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>], dtype=int64), array([<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>], dtype=int64))</span><br></pre></td></tr></table></figure>
<p>因此idx的行标号和列标号是分离的，还需要将它们组合起来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idx = np.array(idx, dtype=np.uint8).T</span><br></pre></td></tr></table></figure>
<p>一个简单的转置操作即可实现，此时idx为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">idx =  [[<span class="number">0</span> <span class="number">1</span>]</span><br><span class="line">[<span class="number">1</span> <span class="number">0</span>]</span><br><span class="line">[<span class="number">1</span> <span class="number">2</span>]</span><br><span class="line">[<span class="number">2</span> <span class="number">1</span>]]</span><br></pre></td></tr></table></figure>
<p>然后：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idx = np.array(idx-[<span class="number">1</span>]*dim)</span><br></pre></td></tr></table></figure>
<p>这一步是取得邻居与中心像素的相对距离，此时idx变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">idx =  [[-<span class="number">1</span>  <span class="number">0</span>]</span><br><span class="line">[ <span class="number">0</span> -<span class="number">1</span>]</span><br><span class="line">[ <span class="number">0</span>  <span class="number">1</span>]</span><br><span class="line">[ <span class="number">1</span>  <span class="number">0</span>]]</span><br></pre></td></tr></table></figure>
<p>注意，此时这个相对距离还是以“图像”为载体，即是一个矩阵上的行列的相对距离，实际在使用时，是将图像压平为一个很长的一维链，所以下一步是根据图像的宽度将这里的相对距离转换为一维链上的相对距离：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acc = np.cumprod((<span class="number">1</span>,)+shape[::-<span class="number">1</span>][:-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p>这一步是最重要的一步：<br>（1）对shape的操作是先将它翻转，比如原来是(10, 110)，先翻转为(110, 10)，然后排除掉最后一个元素，即只取110，这是因为在一维链上的相对位置与图像宽度有关，而与高度无关；如果shape是(10, 110, 3)，即是一个三通道图像，那么排除最后一个元素后，就是(3, 110)。<br>（2）接着是另一个精髓的操作，将(1,)这个元组与shape截取后的元组相加，注意元组相加其实是组合效果，即比如(1,)+(110, )等于(1, 110)，以及(1, )+(3, 110)等于(1, 3, 110)，这里之所以用(1,)相加，是为了对应与中心像素相同高度上的邻居。<br>（3）最后是另一个神来之笔，即用numpy的累乘，这一步是用来将通道考虑进去。</p>
<p>经过一系列操作，如果是二维的shape(10, 110)，那么acc为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acc =  [<span class="number">1</span> <span class="number">110</span>]</span><br></pre></td></tr></table></figure>
<p>如果是三维的shape(10, 110, 3)，那么acc为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acc =  [<span class="number">1</span>  <span class="number">3</span> <span class="number">330</span>]</span><br></pre></td></tr></table></figure>
<p>至此，就知道了在一维链上邻居点相对中心像素的绝对距离，那么，针对于具体的邻居点，得到其具体的绝对距离：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">np.dot(idx, acc[::-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p>比如二维时结果为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array([-<span class="number">110</span>,   -<span class="number">1</span>,    <span class="number">1</span>,  <span class="number">110</span>])</span><br></pre></td></tr></table></figure>
<p>三维时结果为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array([-<span class="number">330</span>,   -<span class="number">3</span>,   -<span class="number">1</span>,    <span class="number">1</span>,    <span class="number">3</span>,  <span class="number">330</span>])</span><br></pre></td></tr></table></figure>
<p>以上就是寻找邻居标识的全部过程。</p>
<p>在此例中，nbs就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array([-<span class="number">17</span>,  -<span class="number">1</span>,   <span class="number">1</span>,  <span class="number">17</span>])</span><br></pre></td></tr></table></figure>
<p>如果full connectivity设为True，那么nbs的值就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array([-<span class="number">18</span>, -<span class="number">17</span>, -<span class="number">16</span>,  -<span class="number">1</span>,   <span class="number">1</span>,  <span class="number">16</span>,  <span class="number">17</span>,  <span class="number">18</span>])</span><br></pre></td></tr></table></figure>
<p>接下来就是将img和mark进行压平，这样上面的邻居标识就可以配合压平后的图像进行使用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">img = img.ravel()</span><br><span class="line">mark1d = mark.ravel()</span><br></pre></td></tr></table></figure>
<p>这样img和mark1d的shape都是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">289</span>, )</span><br></pre></td></tr></table></figure>
<h2 id="统计灰度直方图"><a href="#统计灰度直方图" class="headerlink" title="统计灰度直方图"></a>统计灰度直方图</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pts = np.zeros(img.size//<span class="number">3</span>, dtype=np.int64)</span><br><span class="line">s, bins = collect(img, mark1d, nbs, pts)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">collect</span>(<span class="params">img, mark, nbs, pts</span>):</span></span><br><span class="line">    bins = np.zeros(img.<span class="built_in">max</span>()+<span class="number">1</span>, dtype=np.uint32)</span><br><span class="line">    cur = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(mark)):</span><br><span class="line">        bins[img[p]] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> mark[p]==<span class="number">0xffffffff</span>: <span class="keyword">continue</span> <span class="comment"># edge</span></span><br><span class="line">        <span class="keyword">if</span> mark[p]==<span class="number">0</span>: <span class="keyword">continue</span>      <span class="comment"># zero</span></span><br><span class="line">        <span class="keyword">for</span> dp <span class="keyword">in</span> nbs:</span><br><span class="line">            <span class="keyword">if</span> mark[p+dp]!=mark[p]:</span><br><span class="line">                pts[cur] = p</span><br><span class="line">                cur += <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> cur, bins</span><br></pre></td></tr></table></figure>
<p>这一步是统计了图像的灰度直方图bins，即每一个灰度阶有多少个像素。s存储的是后面注水时一步步水漫时的中心像素的个数。<br>bins的数值是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">array([<span class="number">200</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">40</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">31</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,  <span class="number">16</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">2</span>], dtype=uint32)</span><br></pre></td></tr></table></figure>
<p>即灰度为0的像素有200个，灰度为63的像素有40个，灰度为127的像素有31个，灰度为191的像素有16个，灰度为255的像素有2个。<br>cur就是种子数，为2。<br>同时，该函数也改变了pts的数值，它存储了后面注水时一步步水漫时的中心像素的位置，初始值是两个种子点的位置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">array([ <span class="number">91</span>, <span class="number">163</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,</span><br><span class="line">         <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>], dtype=int64)</span><br></pre></td></tr></table></figure>

<h2 id="注水"><a href="#注水" class="headerlink" title="注水"></a>注水</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> level <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(bins))[::<span class="number">1</span> <span class="keyword">if</span> up <span class="keyword">else</span> -<span class="number">1</span>]:</span><br><span class="line">    <span class="keyword">if</span> bins[level]==<span class="number">0</span>:<span class="keyword">continue</span></span><br><span class="line">    s, c = clear(pts, s, <span class="number">0</span>)</span><br><span class="line">    s = step(img, mark1d, line, pts, s, level, up, nbs)</span><br></pre></td></tr></table></figure>
<p>首先，这里面用到了最开始调用分水岭算法时的最后一个参数up，up控制的是灰度的遍历顺序，即从0到255，还是从255到0，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">range</span>(<span class="built_in">len</span>(bins))[::<span class="number">1</span> <span class="keyword">if</span> up <span class="keyword">else</span> -<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<p>若up为True，则1为步长，该range就是range(0,256)；若up为False，则-1为步长，该range就是range(255, -1, -1)。</p>
<p>然后对所有的灰度阶（即水平面）进行判断：<br>（1）如果该灰度阶没有对应的像素，那么就跳过下面的动作，继续对下一个灰度阶进行判断；<br>（2）对于有对应像素的灰度阶，首先清除pts中无效标识，即clear函数所做的动作，如果pts中的标识为-1，则清除，且将后面的标识往前推；<br>（3）接着就是具体的注水过程，执行step()函数，它接收的参数比较多：img是地形图，mark1d是标识点，line是是否标识分水岭，pts中存储了水漫时的中心位置点，s是中心位置点个数，level是当前水平面，up是是否注水还是下雨，nbs是邻居像素的标识。<br>（3.1）对水漫时的中心像素进行循环，依次从pts中取出该像素的位置标识，首先判断此处的标记值是否为0xfffffffe，或者是否向上注水up和此处img灰度值是否大于该灰度阶，或者是否向下注水not up和此处img灰度值是否小于该灰度阶。<br>这里需要明确一下Python的逻辑运算符的优先级，<a target="_blank" rel="noopener" href="https://blog.csdn.net/lqzdreamer/article/details/77171255">这个链接</a>是非常清晰的一个解释。摘抄如下：</p>
<blockquote>
<p>首先，‘and’、‘or’和‘not’的优先级是not大于and大于or；<br>其次，逻辑操作符and 和or 也称作短路操作符（short-circuitlogic）或者惰性求值（lazy evaluation）：它们的参数从左向右解析，一旦结果可以确定就停止。<br>例如，如果A 和C 为真而B 为假， A and B and C 不会解析C 。作用于一个普通的非逻辑值时，短路操作符的返回值通常是最后一个变量。<br>因此，and运算符必须所有的运算数都是true才会把所有的运算数都解析，并且返回最后一个变量。而或逻辑（or），即只要有一个是true，即停止解析运算数，返回最近为true的变量。</p>
</blockquote>
<p>（3.2）如果上述条件满足，那么就跳过此处的像素，继续对pts中的位置进行循环，这一步实现的效果就是：（a）如果是向上注水，即up为True，那么代表在集水盆地注水，此时在这个盆地内与注水点相同水平面（即同一个level值）的像素点的标记值会被置为与注水点相同的标记值，而当某一像素值大于此时的level时，就不会被淹没，因为它的水平面更高，这是为了保证分水岭两侧的水平面是同步上涨的，否则就像是水会沿着山体爬上去，然后就会越过山体与另一侧汇合，这样也就无法找到正确的分水岭；（b）如果是向下注水，即up为False，那么代表在山顶开始下雨，水位也是在同一个level时停止，保证水在两个山体下滑的速度相等；（c）如果该像素已经是分水岭，即标记值为0xfffffffe，那么也跳过。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> msk[p] == <span class="number">0xfffffffe</span> <span class="keyword">or</span> up <span class="keyword">and</span> img[p]&gt;level <span class="keyword">or</span> <span class="keyword">not</span> up <span class="keyword">and</span> img[p]&lt;level:</span><br><span class="line">    cur += <span class="number">1</span></span><br><span class="line">    <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<p>（3.3）如果上述条件不满足，则对该中心像素的邻居像素进行循环：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> dp <span class="keyword">in</span> nbs:</span><br><span class="line">    cp = p+dp</span><br><span class="line">    <span class="keyword">if</span> msk[cp]==<span class="number">0</span>:</span><br><span class="line">        msk[cp] = msk[p]</span><br><span class="line">        <span class="keyword">if</span> s == <span class="built_in">len</span>(pts):</span><br><span class="line">            s, cur = clear(pts, s, cur)</span><br><span class="line">        pts[s] = cp</span><br><span class="line">        s+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> msk[cp] == msk[p]:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">elif</span> msk[cp] == <span class="number">0xffffffff</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">elif</span> msk[cp] == <span class="number">0xfffffffe</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> line : msk[cp] = <span class="number">0xfffffffe</span></span><br></pre></td></tr></table></figure>
<p>首先判断该邻居的标记值是否为0，如果是，则将该中心像素的标记值赋给它，同时将该邻居位置记录进入pts中，后面将以该点为中心继续填充；如果不为0，再判断该邻居像素与中心像素的标记值是否相等，若相等，则跳过下面步骤；若两者不相等，则再判断该邻居像素的标记值是否为0xffffffff，即是否在边界上，若在边界上，即跳过下面步骤；若不在边界上，则继续判断该像素的标记值是否为0xfffffffe（该值是为了标识分水岭位置），若是分水岭，则跳过以下步骤；若不是分水岭，则继续判断line是否为True，该参数控制是否将分水岭标识出来，若为True，则此时将该邻居像素的标记值置为0xfffffffe，即明确显示出来分水岭。<br>因此，这里面的逻辑就是：<br>0代表还没占领的，0xffffffff代表边界，0xfffffffe代表已经确定是分水岭的，msk[p]代表自己已经占领的，如果这几个都不满足或命中，则言外之意是到了他人占领的地方了，此时如果设置line=True，那么就划定界线，将该像素标为0xfffffffe，即分水岭。</p>
<p>（3.4）对该中心像素的邻居遍历完后，还将该中心像素在pts中的标识转为-1，方便后面在clear函数中进行删除。</p>
<p>经过上面的注水过程，得到的标识图像mark为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,         <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>, <span class="number">4294967294</span>, <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,         <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">4294967294</span>,  <span class="number">2</span>,  <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,         <span class="number">1</span>,          <span class="number">1</span>, <span class="number">4294967294</span>,          <span class="number">2</span>,          <span class="number">2</span>,   <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,         <span class="number">1</span>, <span class="number">4294967294</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,   <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,         <span class="number">4294967294</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,      <span class="number">2</span>,  <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>, <span class="number">4294967294</span>,   <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,    <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>, <span class="number">4294967294</span>,          <span class="number">2</span>,   <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,   <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>, <span class="number">4294967294</span>,          <span class="number">2</span>,          <span class="number">2</span>,   <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,   <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>, <span class="number">4294967294</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,   <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,   <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>,  <span class="number">4294967294</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,        <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,    <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">1</span>,          <span class="number">1</span>,          <span class="number">1</span>, <span class="number">4294967294</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,     <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,        <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">1</span>,          <span class="number">1</span>, <span class="number">4294967294</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,     <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,        <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">1</span>, <span class="number">4294967294</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,     <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,        <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>, <span class="number">4294967294</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,     <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,        <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,      <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,          <span class="number">2</span>,     <span class="number">2</span>, <span class="number">4294967295</span>],</span><br><span class="line">       [<span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>, <span class="number">4294967295</span>]], dtype=uint32)</span><br></pre></td></tr></table></figure>

<h2 id="蚀刻边界"><a href="#蚀刻边界" class="headerlink" title="蚀刻边界"></a>蚀刻边界</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> line:erose(mark1d)</span><br></pre></td></tr></table></figure>
<p>erose函数将边界和分水岭边界给去掉，此时mark变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]], dtype=uint32)</span><br></pre></td></tr></table></figure>

<h2 id="去除四周边界填充"><a href="#去除四周边界填充" class="headerlink" title="去除四周边界填充"></a>去除四周边界填充</h2><p>最后，将之前加入的四周边界填充去掉：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mark[<span class="built_in">tuple</span>([<span class="built_in">slice</span>(<span class="number">1</span>,-<span class="number">1</span>)]*ndim)]</span><br></pre></td></tr></table></figure>
<p>那么，mark即变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>]], dtype=uint32)</span><br></pre></td></tr></table></figure>
<p>至此，整个通用的分水岭算法就结束了。</p>
<h1 id="后处理显示"><a href="#后处理显示" class="headerlink" title="后处理显示"></a>后处理显示</h1><p>这一步就是为了将分水岭可视化出来，根据不同的问题，有不一样的处理方式，比如这里的二值分水岭和另一个灰度图分水岭的处理方式就不同。但目的是一致的，就是可视化。<br>还是看这里的二值分水岭的处理方法：</p>
<h2 id="创建原图掩膜"><a href="#创建原图掩膜" class="headerlink" title="创建原图掩膜"></a>创建原图掩膜</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msk = apply_hysteresis_threshold(img, <span class="number">0</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>这一步是基于已经标识了极大值位置的img来创建掩膜，注意不是上面的mark，而是img，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]], dtype=uint8)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>apply_hysteresis_threshold()函数的<a target="_blank" rel="noopener" href="https://scikit-image.org/docs/dev/api/skimage.filters.html#skimage.filters.apply_hysteresis_threshold">用法</a>是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">skimage.filters.apply_hysteresis_threshold(image, low, high)</span><br><span class="line"></span><br><span class="line">Apply hysteresis thresholding to image.</span><br><span class="line">This algorithm finds regions where image <span class="keyword">is</span> greater than high OR image <span class="keyword">is</span> greater than low <span class="keyword">and</span> that region <span class="keyword">is</span> connected to a region greater than high.</span><br></pre></td></tr></table></figure>
<p>即找到图像中的这样的区域：（1）比high值要大的区域，或者（2）比low值要大，但该区域要连接比high值大的区域。<br>那么，掩膜msk的值就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>]])</span><br></pre></td></tr></table></figure>

<h2 id="与分水岭做与操作"><a href="#与分水岭做与操作" class="headerlink" title="与分水岭做与操作"></a>与分水岭做与操作</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(line==<span class="number">0</span>) &amp; msk</span><br></pre></td></tr></table></figure>
<p>将上述掩膜与分水岭边界进行与操作，就可以得到分水岭的一个子集，即两个矩形区块相碰的区域，注意看中间的三个True值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">array([[<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>,  <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>],</span><br><span class="line">       [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>]])</span><br></pre></td></tr></table></figure>
<p>然后再取反，再与原先的截图snap进行相乘：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img[:] = snap * ~((line==<span class="number">0</span>) &amp; msk</span><br></pre></td></tr></table></figure>
<p>从而得到原图被分水岭分割后的效果，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">array([[  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,  <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,  <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,  <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>,  <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>]], dtype=uint8)</span><br></pre></td></tr></table></figure>
<p>就是这个样子：<br><img src="https://user-images.githubusercontent.com/6218739/71226720-d4d26680-2317-11ea-98e5-f8c85cdb4d0e.png" alt="watershed-after-display"></p>
<h1 id="山脊线"><a href="#山脊线" class="headerlink" title="山脊线"></a>山脊线</h1><p>与分水岭不同，山脊线可以形成孤立的线，线段基本是沿着地理意义上的山脊行走，除了主脉，也有余脉。<br>具体寻找山脊线时，类似分水岭算法，仍然采用“涨水法”，但只用一个集水盆，并且制定新的终止规则：<br>（1）不能淹没终端像素；<br>（2）不能将原本相连的区域分成两个孤岛。<br><img src="https://user-images.githubusercontent.com/6218739/89259722-7dda9100-d65d-11ea-9593-8cd4aee46164.png" alt="image"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/11/17/ImagePy_14/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/17/ImagePy_14/" class="post-title-link" itemprop="url">ImagePy解析：14 -- 寻找局部极值（Find Maximum和Find Minimum）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-17 00:00:00" itemprop="dateCreated datePublished" datetime="2019-11-17T00:00:00+08:00">2019-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/11/17/ImagePy_14/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/17/ImagePy_14/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>源码在：<a target="_blank" rel="noopener" href="https://github.com/Image-Py/imagepy/blob/master/imagepy/ipyalg/hydrology/findmax.py">这里</a><br>还有一篇参考文献：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/wjy-lulu/p/7416135.html">局部极值提取算法</a></p>
<h1 id="图像准备"><a href="#图像准备" class="headerlink" title="图像准备"></a>图像准备</h1><p>首先创建一张10 pixels乘以10 pixels的背底黑色、中间白色的图像，如下图所示（下图仅是为了显示，实际图像是100个像素的面积大小，这样是为了后面显示像素矩阵时更方便）：<br><img src="https://user-images.githubusercontent.com/6218739/69029452-e91cfe00-0a0f-11ea-9e7f-b13dec002fc2.png"><br>然后上面这张图像不能直接传入findmax脚本中，实际用到的是它的距离变换图（注意将这张图的显示范围调整为0-3，因为面积很小，所以距离很近，如果正常0-255显示则就是一片黑色）：<br><img src="https://user-images.githubusercontent.com/6218739/69029482-04880900-0a10-11ea-80a9-496a538fabd5.png"><br>这张图像的像素矩阵就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]]</span><br></pre></td></tr></table></figure>

<p>然后基于这张图像创建一个掩膜和缓冲区：<br>创建掩膜：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msk = np.zeros_like(img, dtype=np.uint8)</span><br><span class="line">msk[<span class="built_in">tuple</span>([<span class="built_in">slice</span>(<span class="number">1</span>,-<span class="number">1</span>)]*img.ndim)] = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>该掩膜的矩阵为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]]</span><br></pre></td></tr></table></figure>
<p>可以看出来，实际就是将边界一圈都置为0，内部区域置为1。<br>创建缓冲区：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buf = np.zeros(img.size//<span class="number">3</span>, dtype=np.int64)</span><br></pre></td></tr></table></figure>
<p>该缓冲区为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>可以看出，是33个0，即对图像尺寸对3进行向下取整的除法。这里的缓冲区是为了存放泛洪填充时的中心像素的位置，因此，很有可能泛洪漫延时超过33个位置，不过也没关系，程序中已经做了，如果超过33个，就会及时地将后面的数据挪到前面，保证不溢出。如这两部分处的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> s==<span class="built_in">len</span>(buf):</span><br><span class="line">    buf[:s-cur] = buf[cur:]</span><br><span class="line">    s-=cur; cur=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>和：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> s==msk.size//<span class="number">3</span>:</span><br><span class="line">    cut = cur//<span class="number">2</span></span><br><span class="line">    msk[bur[:cut]] = <span class="number">2</span></span><br><span class="line">    bur[:s-cut] = bur[cut:]</span><br><span class="line">    cur -= cut</span><br><span class="line">    s -= cut</span><br></pre></td></tr></table></figure>

<h1 id="获得邻居像素的位置距离"><a href="#获得邻居像素的位置距离" class="headerlink" title="获得邻居像素的位置距离"></a>获得邻居像素的位置距离</h1><p>neighbors()方法是为了在以某个像素为中心时，获得它周围的8个像素相对它的位置距离。<br>源码为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">neighbors</span>(<span class="params">shape</span>):</span></span><br><span class="line">    dim = <span class="built_in">len</span>(shape)</span><br><span class="line">    block = np.ones([<span class="number">3</span>]*dim)</span><br><span class="line">    block[<span class="built_in">tuple</span>([<span class="number">1</span>]*dim)] = <span class="number">0</span></span><br><span class="line">    idx = np.where(block&gt;<span class="number">0</span>)</span><br><span class="line">    idx = np.array(idx, dtype=np.uint8).T</span><br><span class="line">    idx = np.array(idx-[<span class="number">1</span>]*dim)</span><br><span class="line">    acc = np.cumprod((<span class="number">1</span>,)+shape[::-<span class="number">1</span>][:-<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> np.dot(idx, acc[::-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p>比如，这里的示例图像是10乘以10的大小，那么经过neighbour方法后，得到的邻居像素的位置距离就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nbs = neighbors(img.shape)</span><br></pre></td></tr></table></figure>
<p>得到：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nbs = array([-<span class="number">11</span>, -<span class="number">10</span>,  -<span class="number">9</span>,  -<span class="number">1</span>,   <span class="number">1</span>,   <span class="number">9</span>,  <span class="number">10</span>,  <span class="number">11</span>])</span><br></pre></td></tr></table></figure>
<p>后面对img进行Ravel()的扁平化处理后，就可以根据相对距离得到中心像素的8个邻居。</p>
<h1 id="以某个像素点为起点进行等值填充"><a href="#以某个像素点为起点进行等值填充" class="headerlink" title="以某个像素点为起点进行等值填充"></a>以某个像素点为起点进行等值填充</h1><p>fill()方法是实现针对于某一像素点，如果其周围的八个邻居与其像素值相等，则填充为相同的背景。<br>fill()算法就是传说中的泛洪填充算法（或称漫水填充算法）。<br>算法原理为：<br>（1）选取一个起始种子点，获得基准颜色，将种子点压入堆栈；<br>（2）从堆栈中取出一个像素，对其进行填充，然后搜索其四邻域（或八邻域），如果有需要填充的像素，压入堆栈；<br>（3）重复（2）直至堆栈为空。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span>(<span class="params">img, msk, p, nbs, buf</span>):</span></span><br><span class="line">    buf[<span class="number">0</span>] = p</span><br><span class="line">    back = img[p]</span><br><span class="line">    cur = <span class="number">0</span>; s = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> cur&lt;s:</span><br><span class="line">        p = buf[cur]</span><br><span class="line">        <span class="keyword">for</span> dp <span class="keyword">in</span> nbs:</span><br><span class="line">            cp = p+dp</span><br><span class="line">            <span class="keyword">if</span> img[cp]==back <span class="keyword">and</span> msk[cp]==<span class="number">1</span>:</span><br><span class="line">                msk[cp] = <span class="number">3</span></span><br><span class="line">                buf[s] = cp</span><br><span class="line">                s+=<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> s==<span class="built_in">len</span>(buf):</span><br><span class="line">                    buf[:s-cur] = buf[cur:]</span><br><span class="line">                    s-=cur; cur=<span class="number">0</span>;</span><br><span class="line">        cur += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>注意理解该算法所接收的参数：<br>img是原图像，msk是掩膜（初始为边界一圈为0，内部为1），p是填充时所选的起始像素（一切都是该像素引发的，后面的idx中存储的就是这种引起填充行为的像素的位置），nbs就是上面所说的邻居像素的相对距离，buf存储了填充时的中心像素位置（再说一遍，起始像素引起了这次填充，它周围的像素则可以作为继续填充时的中心像素，以此类推）。<br>具体算法为：<br>（1）将起始像素点的位置记入buffer的第一个元素；<br>（2）将起始像素点的像素值另存为back变量，后面的像素都是与它做比较；<br>（3）创建一个游标cur和不断变化的可以作为填充的中心像素的计数变量s；<br>（4）对于起始像素，判断它周围的8个像素，如果满足两个条件：一是邻居像素的像素值与它的像素值相等，二是邻居像素不在边界上及未被填充过（这里再说明一下，边界点的掩膜值为0，填充过的掩膜值为3，未填充的掩膜值为1，后面还会有一个值为2，是代表该像素是否被某一局部极值占有），那么就把该邻居像素的掩膜值设为3，同时把它的位置存入buf中，同时把可作为填充的中心像素数目加1；<br>（5）后面再以邻居像素为中心继续填充，直到不满足上面的两个条件。</p>
<p>前面也说了，如果buf的长度不够，会及时把它后面的数据挪到前面来。</p>
<h1 id="对整张图像进行标记"><a href="#对整张图像进行标记" class="headerlink" title="对整张图像进行标记"></a>对整张图像进行标记</h1><p>mark()方法就是对整张图像进行填充标记：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mark</span>(<span class="params">img, msk, buf, mode</span>):</span></span><br><span class="line">    nbs = neighbors(img.shape)</span><br><span class="line">    idx = np.zeros(msk.size//<span class="number">3</span>, dtype=np.int64)</span><br><span class="line">    img = img.ravel()</span><br><span class="line">    msk = msk.ravel()</span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(img)):</span><br><span class="line">        <span class="keyword">if</span> msk[p]!=<span class="number">1</span>:<span class="keyword">continue</span></span><br><span class="line">        sta = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> dp <span class="keyword">in</span> nbs:</span><br><span class="line">            <span class="keyword">if</span> img[p+dp]==img[p]:sta+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> mode <span class="keyword">and</span> img[p+dp]&gt;img[p]:</span><br><span class="line">                sta = <span class="number">100</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="keyword">not</span> mode <span class="keyword">and</span> img[p+dp]&lt;img[p]:</span><br><span class="line">                sta = <span class="number">100</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> sta==<span class="number">100</span>:<span class="keyword">continue</span></span><br><span class="line">        msk[p] = <span class="number">3</span></span><br><span class="line">        <span class="keyword">if</span> sta&gt;<span class="number">0</span>:</span><br><span class="line">            fill(img, msk, p, nbs, buf)</span><br><span class="line"></span><br><span class="line">        idx[s] = p</span><br><span class="line">        s += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> s==<span class="built_in">len</span>(idx):<span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> idx[:s].copy()</span><br></pre></td></tr></table></figure>
<p>需要明确的是该方法所接收的mode，如果为True，则是寻找局部极大值，如果为False，则是寻找局部极小值。<br>它首先是要对图像中的所有像素点进行循环：<br>（1）如果该点在边界上（掩膜值为0）或之前已经被标记过（掩膜值为3），那么就会跳过；<br>（2）如果没有被标记（掩膜值为1），那么就会对它周围的八个邻居像素进行循环：<br>（2.1）如果邻居像素的像素值与该中心像素的像素值相同，则将状态加1；<br>（2.2）如果是想寻找局部极大值（mode为True），且有个邻居像素大于该中心像素的像素值，则直接将状态置为100，并跳出循环；<br>（2.3）如果是想寻找局部极小值（mode为False），且有个邻居像素小于该中心像素的像素值，则直接将状态置为100，并跳出循环；<br>然后就判断状态值，如果为100，那么就不以该像素为起点进行填充，反之，则将该像素的掩膜值置为3，然后如果状态&gt;0，那么就以它为起点进行填充，同时记录下该起点像素的位置，填入idx中进行保存。</p>
<p>举一个例子，因为边界上的像素都不会被标记，因为第一个被标记的像素是编号为11的像素（即除了边界外的左上角的那个像素，此时的编号是基于img已经被Ravel()压平了），以它为起始点进行填充后，得到的掩膜矩阵为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]]</span><br></pre></td></tr></table></figure>
<p>然后，第二个可作为填充的起始像素是编号为42的像素，经过再一次填充后，掩膜变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">1</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]]</span><br></pre></td></tr></table></figure>
<p>第三次可作为填充的起始像素的编号为45，经过填充后，掩膜变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">3</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">3</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">1</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]]</span><br></pre></td></tr></table></figure>
<p>可以看出，像素值为2的区域没有被填充，就是因为以这些像素进行填充时，会碰到像素值为3的像素，导致sta被置为100，无法执行填充操作。</p>
<p>经过后面对idx中的元素截取，得到mark()方法后的返回值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">11</span>, <span class="number">42</span>, <span class="number">45</span>]</span><br></pre></td></tr></table></figure>

<h1 id="寻找局部极值"><a href="#寻找局部极值" class="headerlink" title="寻找局部极值"></a>寻找局部极值</h1><p>filter()方法就是用来实现局部极值的寻找：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span>(<span class="params">img, msk, idx, bur, tor, mode</span>):</span></span><br><span class="line">    nbs = neighbors(img.shape)</span><br><span class="line">    acc = np.cumprod((<span class="number">1</span>,)+img.shape[::-<span class="number">1</span>][:-<span class="number">1</span>])[::-<span class="number">1</span>]</span><br><span class="line">    img = img.ravel()</span><br><span class="line">    msk = msk.ravel()</span><br><span class="line"></span><br><span class="line">    arg = np.argsort(img[idx])[::-<span class="number">1</span> <span class="keyword">if</span> mode <span class="keyword">else</span> <span class="number">1</span>]</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> arg:</span><br><span class="line">        <span class="keyword">if</span> msk[idx[i]]!=<span class="number">3</span>:</span><br><span class="line">            idx[i] = <span class="number">0</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        cur = <span class="number">0</span>; s = <span class="number">1</span>;</span><br><span class="line">        bur[<span class="number">0</span>] = idx[i]</span><br><span class="line">        <span class="keyword">while</span> cur&lt;s:</span><br><span class="line">            p = bur[cur]</span><br><span class="line">            <span class="keyword">if</span> msk[p] == <span class="number">2</span>:</span><br><span class="line">                idx[i]=<span class="number">0</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> dp <span class="keyword">in</span> nbs:</span><br><span class="line">                cp = p+dp</span><br><span class="line">                <span class="keyword">if</span> msk[cp]==<span class="number">0</span> <span class="keyword">or</span> cp==idx[i] <span class="keyword">or</span> msk[cp] == <span class="number">4</span>: <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> mode <span class="keyword">and</span> img[cp] &lt; img[idx[i]]-tor: <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> mode <span class="keyword">and</span> img[cp] &gt; img[idx[i]]+tor: <span class="keyword">continue</span></span><br><span class="line">                bur[s] = cp</span><br><span class="line">                s += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> s==msk.size//<span class="number">3</span>:</span><br><span class="line">                    cut = cur//<span class="number">2</span></span><br><span class="line">                    msk[bur[:cut]] = <span class="number">2</span></span><br><span class="line">                    bur[:s-cut] = bur[cut:]</span><br><span class="line">                    cur -= cut</span><br><span class="line">                    s -= cut</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> msk[cp]!=<span class="number">2</span>:msk[cp] = <span class="number">4</span></span><br><span class="line">            cur += <span class="number">1</span></span><br><span class="line">        msk[bur[:s]] = <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> idx2rc(idx[idx&gt;<span class="number">0</span>], acc)</span><br></pre></td></tr></table></figure>
<p>主要步骤是：<br>（1）首先对找到的极值按数值大小进行排序：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arg = np.argsort(img[idx])[::-<span class="number">1</span> <span class="keyword">if</span> mode <span class="keyword">else</span> <span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<p>如果是寻找极大值，那么就是按从大到小来排序。比如在这里，idx中存储的位置对应的像素的数值分别是0、1和3，所以，arg就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arg = Array([<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>], dtype=int64)</span><br></pre></td></tr></table></figure>
<p>（2）按顺序依次寻找极值的领地<br>（2.1）首先还是以idx存储的像素为起始点，对它的8个邻居像素进行遍历，如果这些邻居像素在边界上（掩膜值为0）或被临时占有（掩膜值为4），那么就跳过；<br>（2.2）如果是寻找极大值（mode为True）以及邻居像素要小于该idx存储的起点像素的像素值减去容忍度tolerance，那么也跳过（那么这里，容忍度就是非常重要的一个参数，它是由用户输入，代表这个极值的“势力范围”或“领地”，如果容忍度为0，那么就严格地认为只有拥有该数值的像素才属于该极值，直观理解看，就是容忍度决定了势力范围，如果tolerance较大，说明划定的势力范围较大，那么两个局部极值就可以碰到，导致合并成一个极值，所以tolerance越大，极值点越少）；<br>（2.3）同理，如果是寻找极小值，邻居像素如果大于该起点像素的像素值加上容忍度，那么也跳过；<br>（2.4）如果邻居像素属于该极值的势力范围（即数值满足起点像素值和tolerance），那么就将它的位置存入buf中，后续还要以它为中心进行循环，同时如果它的掩膜值不为2（即之前没有被占有过），则将它的掩膜值置为4，即临时占有；<br>（2.5）在对这些中心像素都遍历一遍后，就将它们的掩膜值置为2，即它们被该idx存储的像素所永久占有。<br>如果将tolerance设为1，下面是位置编号为45的像素所占有的领地（掩膜矩阵）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]]</span><br></pre></td></tr></table></figure>
<p>那么在对下一个idx存储的像素为起点进行探索时，也会执行上面的步骤，但此时可以在一开始或中途触发某个掩膜值为2的邻居像素，那么此时就会终止该次循环，并且将idx中存储的这个像素的位置置为0，即下面的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> cur&lt;s:</span><br><span class="line">    p = bur[cur]</span><br><span class="line">    <span class="keyword">if</span> msk[p] == <span class="number">2</span>:</span><br><span class="line">        idx[i]=<span class="number">0</span></span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>这个地方非常重要，这代表着两个极值所涉及的领地是否有冲突，如果冲突了，那么说明这两个极值实际是接触的，因为前面的循环是基于更大的极值（以寻找极大值来说），那么这个第二次的极值就会被刚才的极值占领，它的位置也就可以在idx中被抹去。<br>比如位置编号为42的像素开始占有后：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">2</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]]</span><br></pre></td></tr></table></figure>
<p>就是因为在不断地寻找过程中，某个邻居像素碰到了之前已经被标记为2的像素，导致提前终止，使得idx变成了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idx = array([<span class="number">11</span>,  <span class="number">0</span>, <span class="number">45</span>], dtype=int64)</span><br></pre></td></tr></table></figure>
<p>而接着在对idx中的位置为11的像素进行探索时，发现它一上来掩膜值就已经是2，所以直接就被终止，idx变成：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idx = array([<span class="number">0</span>,  <span class="number">0</span>, <span class="number">45</span>], dtype=int64)</span><br></pre></td></tr></table></figure>
<p>那么下面一步就是挑选不为0的位置编号，并且将它转换为行号和列号，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">idx2rc(idx[idx&gt;<span class="number">0</span>], acc)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">idx2rc</span>(<span class="params">idx, acc</span>):</span></span><br><span class="line">    rst = np.zeros((<span class="built_in">len</span>(idx), <span class="built_in">len</span>(acc)), dtype=np.int16)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(idx)):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(acc)):</span><br><span class="line">            rst[i,j] = idx[i]//acc[j]</span><br><span class="line">            idx[i] -= rst[i,j]*acc[j]</span><br><span class="line">    <span class="keyword">return</span> rst</span><br></pre></td></tr></table></figure>
<p>这里找到的极值点就是在行号为4、列号为5的像素点，即第5行、第6列。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/11/04/ImagePy_13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/04/ImagePy_13/" class="post-title-link" itemprop="url">ImagePy解析：13 -- Macros引擎及宏录制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-04 00:00:00" itemprop="dateCreated datePublished" datetime="2019-11-04T00:00:00+08:00">2019-11-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/11/04/ImagePy_13/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/04/ImagePy_13/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考文献：<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25483846">ImagePy开发文档 —— 宏引擎</a><br><a target="_blank" rel="noopener" href="https://github.com/Image-Py/demoplugin/blob/master/doc/chinese/macros.md#Macros">Macros 插件</a></p>
<p>Macros 是一个宏执行器引擎，它负责将一串 ImagePy 命令依次执行。 事实上我们几乎不会去继承 Macros，它仅仅是 ImagePy 为了实现宏功能，并统一为一种引擎接口而设计的辅助类。<br>因此，Macros引擎常见的用法是：首先通过宏录制器来完成记录，宏录制器在<strong>Plugins &gt; Macros&gt; Macros Recorder</strong>， 然后将录制的命令保存到menus或其子文件夹里，以mc作为后缀，重启即可加载到对应位置。（语出上面的参考文献）</p>
<h1 id="Macros引擎"><a href="#Macros引擎" class="headerlink" title="Macros引擎"></a>Macros引擎</h1><p>先来看一下Macros类的全貌：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stepmacros</span>(<span class="params">plg, callafter=<span class="literal">None</span></span>):</span></span><br><span class="line">    plg._<span class="built_in">next</span>(callafter)</span><br><span class="line">pub.subscribe(stepmacros, <span class="string">&#x27;stepmacros&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Macros</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, title, cmds</span>):</span></span><br><span class="line">        …</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_next</span>(<span class="params">self, callafter=<span class="literal">None</span></span>):</span></span><br><span class="line">        …</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next</span>(<span class="params">self</span>):</span></span><br><span class="line">        …</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        …</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self</span>):</span></span><br><span class="line">        …</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self, para=<span class="literal">None</span>, callafter=<span class="literal">None</span></span>):</span></span><br><span class="line">        …</span><br></pre></td></tr></table></figure>
<p>下面具体看一下Macros类的属性和方法。</p>
<h2 id="初始化函数"><a href="#初始化函数" class="headerlink" title="初始化函数"></a>初始化函数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, title, cmds</span>):</span></span><br><span class="line">    self.title = title</span><br><span class="line">    self.cmds = cmds</span><br></pre></td></tr></table></figure>
<p>可以看出，在初始化函数中需要传入宏命令的名称title和具体的执行操作。<br>这一块实际调用是发生在主界面解析插件目录时，具体是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extend_plugins</span>(<span class="params">path, lst, err</span>):</span></span><br><span class="line">    ……</span><br><span class="line">        <span class="keyword">elif</span> i[-<span class="number">3</span>:] == <span class="string">&#x27;.mc&#x27;</span>:</span><br><span class="line">            pt = os.path.join(root_dir, path)</span><br><span class="line">            f = <span class="built_in">open</span>(pt+<span class="string">&#x27;/&#x27;</span>+i, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">            cmds = f.readlines()</span><br><span class="line">            f.close()</span><br><span class="line">            rst.append(Macros(i[:-<span class="number">3</span>], [getpath(pt, i) <span class="keyword">for</span> i <span class="keyword">in</span> cmds]))</span><br><span class="line">            PluginsManager.add(rst[-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p>可以看出，先判断脚本文件是否为mc后缀，如果是的话，则按行读取文件内容，然后根据根据这些信息创建一个Macros对象，传入PluginsManager管理器中。</p>
<p>因此，整个宏文件形成一个插件，会被解析成一个菜单项，然后如果点击的话，就是执行的Macros类的start()函数。</p>
<p>##_next()函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_next</span>(<span class="params">self, callafter=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> self.cur==<span class="built_in">len</span>(self.cmds):</span><br><span class="line">        <span class="keyword">if</span> self.callafter!=<span class="literal">None</span>:</span><br><span class="line">            self.callafter()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(self.cmds[self.cur])&lt;<span class="number">3</span> <span class="keyword">or</span> self.cmds[self.cur][<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span>:</span><br><span class="line">        self.cur += <span class="number">1</span></span><br><span class="line">       <span class="keyword">return</span> self._<span class="built_in">next</span>(callafter)</span><br><span class="line">    title, para = self.cmds[self.cur].split(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">    self.cur += <span class="number">1</span></span><br><span class="line">    plg = PluginsManager.get(title)()</span><br><span class="line">    plg.start(<span class="built_in">eval</span>(para), self.<span class="built_in">next</span>)</span><br></pre></td></tr></table></figure>
<p>这个函数的作用是实际读取宏文件中的命令并执行。它是通过游标self.cur来逐行读取。<br>第一个判断语句是判断是否将命令列表读完，如果读完了，则返回。<br>第二个判断语句是判断该行是否是小于三个字符或以井号开头，如果是，则读下一行。以井号开头说明该行是条注释。小于三个字符是为了忽略空行，这个地方在不同系统上有一个微小不同，见<a target="_blank" rel="noopener" href="https://blog.csdn.net/stpeace/article/details/45767245">彻底解读剪不断理还乱的\r\n和\n, 以Windows和Linux为例</a>。</p>
<blockquote>
<p>Windows系统中有如下等价关系： 用enter换行 &lt;====&gt; 程序写\n  &lt;====&gt; 真正朝文件中写\r\n(0x0d0x0a) &lt;====&gt;程序真正读取的是\n<br>linux系统中的等价关系： 用enter换行 &lt;====&gt; 程序写\n  &lt;====&gt; 真正朝文件中写\n(0x0a)  &lt;====&gt; 程序真正读取的是\n</p>
</blockquote>
<p>后面的语句是真正执行命令：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">plg = PluginsManager.get(title)()</span><br><span class="line">plg.start(<span class="built_in">eval</span>(para), self.<span class="built_in">next</span>)</span><br></pre></td></tr></table></figure>
<h2 id="next-函数"><a href="#next-函数" class="headerlink" title="next()函数"></a>next()函数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">next</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">if</span> IPy.uimode() == <span class="string">&#x27;no&#x27;</span>:</span><br><span class="line">        self._<span class="built_in">next</span>(self)</span><br><span class="line">    <span class="keyword">else</span>: wx.CallAfter(pub.sendMessage, <span class="string">&#x27;stepmacros&#x27;</span>, plg=self)</span><br></pre></td></tr></table></figure>
<p>采用pub-sub模式，然后调用上面的_next()函数。</p>
<h2 id="run-函数"><a href="#run-函数" class="headerlink" title="run()函数"></a>run()函数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span>self.<span class="built_in">next</span>()</span><br></pre></td></tr></table></figure>
<p>这是为了与其他插件进行统一，run()也就是调用了next()函数。</p>
<h2 id="start-函数"><a href="#start-函数" class="headerlink" title="start()函数"></a>start()函数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self, para=<span class="literal">None</span>, callafter=<span class="literal">None</span></span>):</span></span><br><span class="line">    self.callafter = callafter</span><br><span class="line">    self.cur = <span class="number">0</span></span><br><span class="line">    self.run()</span><br></pre></td></tr></table></figure>
<p>前面已经说过，这是入口函数。</p>
<h1 id="宏录制"><a href="#宏录制" class="headerlink" title="宏录制"></a>宏录制</h1><h2 id="录制操作步骤"><a href="#录制操作步骤" class="headerlink" title="录制操作步骤"></a>录制操作步骤</h2><p>Plugins &gt; Macros &gt; Macros Recorder</p>
<h2 id="录制机制"><a href="#录制机制" class="headerlink" title="录制机制"></a>录制机制</h2><p>首先这个Macros Recorder是个wgt.py文件，在初始解析插件时就会被加入到组件管理器WidgetManager中。然后它有一个write()方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">self, cont</span>):</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> self.recording: <span class="keyword">return</span></span><br><span class="line">self.txt_cont.AppendText((cont+<span class="string">&#x27;\n&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>即在该panel的文本框中记录执行的命令名称。</p>
<p>然后仔细查看Free、Simple和Filter引擎类中，都可以发现这么两行代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">win = WidgetsManager.getref(<span class="string">&#x27;Macros Recorder&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> win!=<span class="literal">None</span>:</span><br><span class="line">    win.write(<span class="string">&#x27;&#123;&#125;&gt;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.title, para))</span><br></pre></td></tr></table></figure>
<p>即后面在执行某个插件时，都会调用宏录制器，将插件的名字title和参数para传给它，使其记录下来，记录形式为：插件名称&gt;参数字典。</p>
<h2 id="执行机制"><a href="#执行机制" class="headerlink" title="执行机制"></a>执行机制</h2><p>（语出上面的参考文献）<br>所有的插件都被 PluginsManager 所管理，PluginsManager 内部实际上是维护了一个以插件的 title 为主键的键值对。所以我们这样做：<br>1.解析宏命令，用 ‘&gt;’ 进行字符串分割<br>2.用分割的 title 作为主键去 PluginsManager 中查找，得到滤波器的实例。<br>3.调用 eval 函数，把 para 重新解析成 python 对象（这里充分发挥了脚本语言的优势）<br>4.执行获取的滤波器的 start 方法，把 para 当作参数输入。<br>（还记得引起的 start() 方法特性，当 para 为 None 时进行交互，否则直接执行 run）</p>
<p>最后一条值得注意，如果该有参数的地方设置为None，则会跳出参数对话框供手动设置，也可以直接传入参数。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/10/29/ImagePy_12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/29/ImagePy_12/" class="post-title-link" itemprop="url">ImagePy解析：12 -- 画布Canvas类详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-29 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-29T00:00:00+08:00">2019-10-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/10/29/ImagePy_12/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/29/ImagePy_12/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<br>2020-9-5 更新：<br>加入draw_image()和mix_img()方法的详解<br>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</p>
<p>前面系列文已经提到，ImagePy的画布Canvas类已经被抽象出来，可以被单独使用。<br>本节就对该类做一个详细解析：因为Canvas类又调用了同一路径下的boxutil和imutil，所以本文的思路是先整体介绍它的运行机理，然后具体到某一功能时可以再详细查看下方的详细解释，这样不至于迷失在代码中。。</p>
<p>该类的源码地址在<a target="_blank" rel="noopener" href="https://github.com/Image-Py/imagepy/tree/master/imagepy/ui/canvas">这里</a>。</p>
<h1 id="画布Canvas运行机理"><a href="#画布Canvas运行机理" class="headerlink" title="画布Canvas运行机理"></a>画布Canvas运行机理</h1><p>总体看一下它的调用代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    msk = np.zeros((<span class="number">512</span>,<span class="number">512</span>), dtype=np.uint8)</span><br><span class="line">    msk[<span class="number">100</span>:<span class="number">200</span>,<span class="number">100</span>:<span class="number">200</span>] = <span class="number">1</span></span><br><span class="line">    msk[<span class="number">200</span>:<span class="number">300</span>,<span class="number">200</span>:<span class="number">300</span>] = <span class="number">2</span></span><br><span class="line">    msk[<span class="number">300</span>:<span class="number">400</span>,<span class="number">300</span>:<span class="number">400</span>] = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    lut = np.array([(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>),(<span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>),(<span class="number">0</span>,<span class="number">255</span>,<span class="number">0</span>),(<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>)], dtype=np.uint8)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> skimage.data <span class="keyword">import</span> astronaut, camera</span><br><span class="line">    app = wx.App()</span><br><span class="line">    frame = wx.Frame(<span class="literal">None</span>)</span><br><span class="line">    canvas = Canvas(frame)</span><br><span class="line">    canvas.set_img(msk)</span><br><span class="line">    canvas.set_lut(lut)</span><br><span class="line">    canvas.set_cn(<span class="number">0</span>)</span><br><span class="line">    canvas.set_back(astronaut())</span><br><span class="line">    canvas.set_cn(<span class="string">&#x27;rgb&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    canvas.set_mode(<span class="string">&#x27;msk&#x27;</span>)</span><br><span class="line">    frame.Show(<span class="literal">True</span>)</span><br><span class="line">    app.MainLoop()</span><br></pre></td></tr></table></figure>
<p>这里是查看单独调用该画布时的用法，该画布也可以直接用在ImagePy框架中用。<br>然后分步看一下具体设置和运行。</p>
<h2 id="创建掩膜"><a href="#创建掩膜" class="headerlink" title="创建掩膜"></a>创建掩膜</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msk = np.zeros((<span class="number">512</span>,<span class="number">512</span>), dtype=np.uint8)</span><br><span class="line">msk[<span class="number">100</span>:<span class="number">200</span>,<span class="number">100</span>:<span class="number">200</span>] = <span class="number">1</span></span><br><span class="line">msk[<span class="number">200</span>:<span class="number">300</span>,<span class="number">200</span>:<span class="number">300</span>] = <span class="number">2</span></span><br><span class="line">msk[<span class="number">300</span>:<span class="number">400</span>,<span class="number">300</span>:<span class="number">400</span>] = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>这里的掩膜msk是一个512乘以512大小的黑色图像，然后将它的三个区域分别由0变为1、2或3。<br>掩膜之所以设置成512乘以512，是因为下面的astronaut()是这么个形状，所以一般掩膜应该是设置成与背景图像相同大小的黑色图像。（也可以任意设置掩膜大小，但那样只会显示原图的一部分，没有什么实际意义。）</p>
<h2 id="创建查找表"><a href="#创建查找表" class="headerlink" title="创建查找表"></a>创建查找表</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lut = np.array([(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>),(<span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>),(<span class="number">0</span>,<span class="number">255</span>,<span class="number">0</span>),(<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>)], dtype=np.uint8)</span><br></pre></td></tr></table></figure>
<p>这里的查找表lut是一个array数组，里面盛放了四种颜色。具体使用它的地方是imutil中lookup()方法，可以详细查看本文下面的说明。一言以蔽之，是使用了Numpy的Fancy Indexing，与上面的msk进行呼应，当msk中的像素值为1时，就取lut的(255, 0, 0)红色。</p>
<h2 id="创建并运行Canvas对象"><a href="#创建并运行Canvas对象" class="headerlink" title="创建并运行Canvas对象"></a>创建并运行Canvas对象</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app = wx.App()</span><br><span class="line">frame = wx.Frame(<span class="literal">None</span>)</span><br><span class="line">canvas = Canvas(frame)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">frame.Show(<span class="literal">True</span>)</span><br><span class="line">app.MainLoop()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面创建了Canvas的对象，并通过它所依赖的frame的Show()方法进行渲染展示。当Show()方法调用时，就会生成Canvas的窗口，然后就会触发它的窗口改变wx.EVT_SIZE事件，然后就执行一系列的绘图动作，具体做了啥见下方说明。</p>
<h2 id="配置Canvas：设置图像"><a href="#配置Canvas：设置图像" class="headerlink" title="配置Canvas：设置图像"></a>配置Canvas：设置图像</h2><p>上面创建了Canvas后，还要对其进行一番配置。这一步及下面的五步都是Canvas的核心配置步骤。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canvas.set_img(msk)</span><br></pre></td></tr></table></figure>
<p>这一步是设置前景图（下面还有一个背景图），因为这个例子是有点特别，是用于标注，所以此时Canvas要显示的图像是掩膜msk与原图的在掩膜模式下的混合（看起来就像是前景可以任意涂抹，背景则不受影响）。<br>那么再重新理一下这几张图：在这个例子中，前景图是一张黑色图像（大部分像素值为0，但里面的一些像素值已被更改为非0），背景图是彩色原图，实际上画布Canvas显示的是一张图像，即两者的混合，根据不同的混合模式显示不同的混合图像。</p>
<p>还需要注意一点（感谢龙哥的语音指导）：<br>（1）在单纯这个Canvas显示中，前景图和背景图需要分辨清楚，因为它是用于标注，需要明确哪个在前哪个在后，而在其他混合模式下，如最大值、最小值混合，两者效果相同。<br>（2）如果将Canvas放入ImagePy中，两者也是要分辨清楚，因为前景永远指的是滤波器要处理的这一张图，而背景图仅用于衬托。</p>
<h2 id="配置Canvas：设置查找表"><a href="#配置Canvas：设置查找表" class="headerlink" title="配置Canvas：设置查找表"></a>配置Canvas：设置查找表</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canvas.set_lut(lut)</span><br></pre></td></tr></table></figure>
<p>这一步是设置查找表。这里因为只传递了lut，所以该方法的第二个参数用的是False，即这里设置的是self.lut属性，而self._lut保持默认值（即黑色到白色的渐变）不变。<br>这里也提前说明，不带下划线的属性（包括self.lut、self.rg和self.cn）都是与前景图相关，而带下划线的属性（包括self._lut、self._rg和self._cn）都是与背景图相关。</p>
<h2 id="配置Canvas：设置图像通道"><a href="#配置Canvas：设置图像通道" class="headerlink" title="配置Canvas：设置图像通道"></a>配置Canvas：设置图像通道</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canvas.set_cn(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>这一步是设置图像通道，这里因为只传递了0，所以第二个参数用的是默认值False，即这里不是针对背景图设置的，而是针对前景图，即self.cn设为0。这里有两点需要注意：首先因为是cn，不带下划线，说明是对前景图的设置；再者一定要设置为0，这是通道标识，因为掩膜msk是一个灰度值，所以只有一个通道，那么它的标识就是0。</p>
<p>可以再往下看，后面又调用了set_cn()方法，传入的是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canvas.set_cn(<span class="string">&#x27;rgb&#x27;</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>即此时将’rgb’赋给了self._cn，即对背景图的通道进行设置，即想让背景图以RGB彩色图的形式显示。</p>
<h2 id="配置Canvas：设置背景图像"><a href="#配置Canvas：设置背景图像" class="headerlink" title="配置Canvas：设置背景图像"></a>配置Canvas：设置背景图像</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canvas.set_back(astronaut())</span><br></pre></td></tr></table></figure>
<p>这一步是设置背景图像，是将numpy数组形式的图像传入。</p>
<h2 id="配置Canvas：设置混合模式"><a href="#配置Canvas：设置混合模式" class="headerlink" title="配置Canvas：设置混合模式"></a>配置Canvas：设置混合模式</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canvas.set_mode(<span class="string">&#x27;msk&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>这里将模式设为msk，即掩膜模式。<br>因为如前所述，该例子是为了标注，设置为掩膜模式后，画布上呈现的图就是掩膜不为0的地方的前景图与掩膜为0的地方的背景图的叠加。<br>关于mode的详述，见本文下面的set_mode()方法。</p>
<h1 id="Canvas类及其属性和方法"><a href="#Canvas类及其属性和方法" class="headerlink" title="Canvas类及其属性和方法"></a>Canvas类及其属性和方法</h1><h2 id="set-img-方法"><a href="#set-img-方法" class="headerlink" title="set_img()方法"></a>set_img()方法</h2><p>这一步就是指定前景图，再强调一下，这个前景图并不是画布呈现的图，画布呈现的是前景与背景的混合图像。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_img</span>(<span class="params">self, img</span>):</span></span><br><span class="line">    self.img = img</span><br><span class="line">    self.conbox = [<span class="number">0</span>, <span class="number">0</span>, *img.shape[<span class="number">1</span>::-<span class="number">1</span>]]</span><br><span class="line">    self.oribox = [<span class="number">0</span>, <span class="number">0</span>, *img.shape[<span class="number">1</span>::-<span class="number">1</span>]]</span><br></pre></td></tr></table></figure>
<p>注意，这个地方用到了一个星号变量，是为了将shape由元组拆分为单个参数，具体用法可以看我转载的一篇讲星号变量的文章，那么这个地方的运算顺序实际是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.conbox = [<span class="number">0</span>, <span class="number">0</span>, *(img.shape[<span class="number">1</span>::-<span class="number">1</span>])]</span><br></pre></td></tr></table></figure>
<p>同时，注意对shape元组切片时的步长是-1，即它是反着切的，即只取第0个元素和第1个元素。<br>得到的conbox和oribox也是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conbox =  [<span class="number">0</span>, <span class="number">0</span>, <span class="number">512</span>, <span class="number">512</span>]</span><br></pre></td></tr></table></figure>
<p>通过设置前景图，给Canvas的img属性赋值，同时根据图像尺寸得到了Canvas的conbox和oribox。<br>这里面的几个box要明白它们的含义（因为这里没涉及旋转，oribox未作分析）：<br>（1）winbox：即盛放整个panel窗口的box；<br>（2）conbox：即承载图像的box；<br>（3）csbox：即上面两个box重叠的部分，也是真正绘图的画布box。<br>比如一张图像为[512, 1024]大小，呈现给用户的窗口是[1000, 1000]，那么conbox就是512乘以1024大小，winbox就是1000乘以1000大小，csbox大小则是512乘以1000，那么看起来就是整个窗口上，图像水平方向能全部显示，且左右都有空白填充，而垂直方向仅能显示大部分图像，没有空白填充。</p>
<h2 id="set-lut-方法"><a href="#set-lut-方法" class="headerlink" title="set_lut()方法"></a>set_lut()方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_lut</span>(<span class="params">self, lut, b=<span class="literal">False</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> b: self._lut = lut</span><br><span class="line">    <span class="keyword">else</span>: self.lut = lut</span><br></pre></td></tr></table></figure>
<p>这一步是定义查找表，除了传入查找表数组，还传入一个旗标b（就是background），如果是False（即不是背景，可以把旗标b命名为isBackgroud，否则可能有点绕），就设置self.lut属性，如果是True（即是背景），就设置self._lut属性。</p>
<p>这两个属性默认值是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.lut = np.array([np.arange(<span class="number">256</span>)]*<span class="number">3</span>, dtype=np.uint8).T</span><br><span class="line">self._lut = np.array([np.arange(<span class="number">256</span>)]*<span class="number">3</span>, dtype=np.uint8).T</span><br></pre></td></tr></table></figure>
<p>即是从黑色到白色渐变的一个颜色索引（注意后面的转置）。</p>
<h2 id="set-cn-方法"><a href="#set-cn-方法" class="headerlink" title="set_cn()方法"></a>set_cn()方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_cn</span>(<span class="params">self, cn, b=<span class="literal">False</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> b: self._cn = cn</span><br><span class="line">    <span class="keyword">else</span>: self.cn = cn</span><br></pre></td></tr></table></figure>
<p>这一步是设置图像通道，除了传入通道，还传入一个旗标b，如果是False（即不是背景），就设置self.cn，如果是True（即是背景），就设置self._cn。</p>
<p>这两个属性默认值都是0：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.cn = <span class="number">0</span></span><br><span class="line">self._cn = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>这里传入的cn是通道标识，如果图像只有一个通道，一定要设置为0；如果有多个通道，比如RGB，若想显示彩图，则设置为RGB；若只想显示其中一个通道，则设置通道标识为0或1或2。</p>
<h2 id="set-back-方法"><a href="#set-back-方法" class="headerlink" title="set_back()方法"></a>set_back()方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_back</span>(<span class="params">self, back</span>):</span> self.back = back</span><br></pre></td></tr></table></figure>
<p>这一步是设置背景图像，为self.back属性赋值。</p>
<h2 id="set-mode-方法"><a href="#set-mode-方法" class="headerlink" title="set_mode()方法"></a>set_mode()方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_mode</span>(<span class="params">self, mode</span>):</span> self.mode = mode</span><br></pre></td></tr></table></figure>
<p>这一步是设置混合模式，为self.mode属性赋值。<br>该属性的默认值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.mode = <span class="string">&#x27;set&#x27;</span></span><br></pre></td></tr></table></figure>
<p>有多种混合模式：<br>（1）set模式：默认模式，直接将图像设为要显示的图像（即不混合）<br>（2）min模式：逐个对比背景图和前景图两张图像中的像素，选择数值小的像素保存进混合图像<br>（3）max模式：逐个对比背景图和前景图两张图像中的像素，选择数值大的像素保存进混合图像<br>（4）msk模式：根据掩膜将背景图和前景图进行混合，在掩膜msk不为0的地方，将背景图设为0；在msk为0的地方，保留原值（因为对msk作了逻辑非操作，然后下面在元素相乘时，True为1，False为0）。然后将两图进行相加合成存入混合图像。<br>（5）按比例混合模式：mode可以是一个小数，即将背景图与1-mode相乘，前景图与mode相乘，然后两者相加合成存入混合图像。</p>
<h2 id="set-rg"><a href="#set-rg" class="headerlink" title="set_rg()"></a>set_rg()</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_rg</span>(<span class="params">self, rg, b=<span class="literal">False</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> b: self._rg = rg</span><br><span class="line">    <span class="keyword">else</span>: self.rg = rg</span><br></pre></td></tr></table></figure>
<p>这一步是设置像素值范围，默认两张图都是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.rg = (<span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">self._rg = (<span class="number">0</span>, <span class="number">255</span>)</span><br></pre></td></tr></table></figure>
<h2 id="initBuffer-方法"><a href="#initBuffer-方法" class="headerlink" title="initBuffer()方法"></a>initBuffer()方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initBuffer</span>(<span class="params">self</span>):</span></span><br><span class="line">    box = self.GetClientSize()</span><br><span class="line">    self.buffer = wx.Bitmap(*box)</span><br><span class="line">    self.winbox = [<span class="number">0</span>, <span class="number">0</span>, *box]</span><br></pre></td></tr></table></figure>
<p>可以看出来，初始化缓冲时就是先创建一个初始尺寸的wxPython的位图Bitmap，然后将它赋给self.buffer变量。<br>同时也将整个面板的大小self.winbox设定一下。</p>
<h2 id="update-方法"><a href="#update-方法" class="headerlink" title="update()方法"></a>update()方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self</span>):</span></span><br><span class="line">    start = time()</span><br><span class="line">    lay(self.winbox, self.conbox)</span><br><span class="line">    dc = wx.BufferedDC(wx.ClientDC(self), self.buffer)</span><br><span class="line">    dc.Clear()</span><br><span class="line">    self.draw_image(dc, self.img, self.back, <span class="number">0</span>)</span><br><span class="line">    dc.UnMask()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;frame rate:&#x27;</span>,<span class="built_in">int</span>(<span class="number">1</span>/<span class="built_in">max</span>(<span class="number">0.001</span>, time()-start)))</span><br></pre></td></tr></table></figure>
<p>首先通过lay()方法根据winbox的位置来更新conbox的位置（该方法的解析见本文下方），然后创建一个BufferedDC与用户交互，然后调用draw_image()方法。</p>
<h2 id="draw-image-方法"><a href="#draw-image-方法" class="headerlink" title="draw_image()方法"></a>draw_image()方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw_image</span>(<span class="params">self, dc, img, back, mode</span>):</span></span><br><span class="line">    out, rgb = self.outimg, self.outrgb</span><br><span class="line">    csbox = cross(self.winbox, self.conbox)</span><br><span class="line">    shp = csbox[<span class="number">3</span>]-csbox[<span class="number">1</span>], csbox[<span class="number">2</span>]-csbox[<span class="number">0</span>]</span><br><span class="line">    o, m = mat(self.oribox, self.conbox, csbox)</span><br><span class="line">    shp = <span class="built_in">tuple</span>(np.array(shp).<span class="built_in">round</span>().astype(np.<span class="built_in">int</span>))</span><br><span class="line">    <span class="keyword">if</span> out <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> (out.shape, out.dtype) != (shp, img.dtype):</span><br><span class="line">        self.outimg = np.zeros(shp, dtype=img.dtype)</span><br><span class="line">    <span class="keyword">if</span> rgb <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> rgb.shape[:<span class="number">2</span>] != shp:</span><br><span class="line">        self.outrgb = np.zeros(shp+(<span class="number">3</span>,), dtype=np.uint8)</span><br><span class="line">        self.outint = np.zeros(shp, dtype=np.uint8)</span><br><span class="line">        buf = <span class="built_in">memoryview</span>(self.outrgb)</span><br><span class="line">        self.outbmp = wx.Bitmap.FromBuffer(*shp[::-<span class="number">1</span>], buf)</span><br><span class="line"></span><br><span class="line">    mix_img(back, m, o, shp, self.outimg,</span><br><span class="line">          self.outrgb, self.outint,</span><br><span class="line">          self._rg, self._lut, cns=self._cn, mode=<span class="string">&#x27;set&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">    mix_img(img, m, o, shp, self.outimg,</span><br><span class="line">          self.outrgb, self.outint,</span><br><span class="line">          self.rg, self.lut, cns=self.cn, mode=self.mode)</span><br><span class="line"></span><br><span class="line">    self.outbmp.CopyFromBuffer(<span class="built_in">memoryview</span>(self.outrgb))</span><br><span class="line">    dc.DrawBitmap(self.outbmp, *csbox[:<span class="number">2</span>])</span><br></pre></td></tr></table></figure>

<p>首先通过cross()方法取得了winbox和conbox这两个矩形框重叠的部分csbox（仍然见下方解析），然后计算csbox的宽度和高度，形成shape这个元组，这个大小是真正要作图的区域，而不是winbox和conbox这两个的大小。<br>这里根据shape的大小，会创建几个变量：<br>self.outimg：大小为shape、值全为0、类型为img.dtype<br>self.outrgb：大小为shape+3通道（注意，是3通道）、值全为0、类型为np.uint8<br>self.outint：大小为shape（注意，是单通道）、值全为0、类型为np.uint8<br>然后就会调用两次图像混合。<br>通过mat()方法得到偏移量和缩放因子，这两个参数都是后面仿射变换的重要参数。<br>可以看出mix_img()方法调用了两次，分别是为了设置背景图和设置前景图。两者的顺序不能调换，因为第一次的调用返回的self.outrgb是作为背景图在第二次调用时进行图像混合。</p>
<h2 id="事件响应"><a href="#事件响应" class="headerlink" title="事件响应"></a>事件响应</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bindEvents</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">for</span> event, handler <span class="keyword">in</span> [ \</span><br><span class="line">            (wx.EVT_SIZE, self.on_size),</span><br><span class="line">            (wx.EVT_MOUSE_EVENTS, self.on_mouseevent),</span><br><span class="line">            (wx.EVT_IDLE, self.on_idle),</span><br><span class="line">            (wx.EVT_CLOSE, self.on_close),</span><br><span class="line">            (wx.EVT_PAINT, self.on_paint)]:</span><br><span class="line">        self.Bind(event, handler)</span><br></pre></td></tr></table></figure>
<h3 id="窗口尺寸改变"><a href="#窗口尺寸改变" class="headerlink" title="窗口尺寸改变"></a>窗口尺寸改变</h3><p>这个事件就是wx.EVT_SIZE，即窗口尺寸变化时触发，比如用鼠标拖动窗口边界。<br>实际上，刚开始创建该窗口时也会触发该事件，即该事件实际就是该Canvas的入口函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_size</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    self.initBuffer()</span><br><span class="line">    self.update()</span><br></pre></td></tr></table></figure>
<p>可以看出，该事件处理函数就是调用初始化方法和更新方法。</p>
<h3 id="鼠标事件"><a href="#鼠标事件" class="headerlink" title="鼠标事件"></a>鼠标事件</h3><p>这个事件就是wx.EVT_MOUSE_EVENTS，包括鼠标按下和释放、鼠标移动、鼠标滚动等。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_mouseevent</span>(<span class="params">self, me</span>):</span></span><br><span class="line">    <span class="keyword">if</span> me.ButtonDown():</span><br><span class="line">       <span class="keyword">if</span> me.GetButton()==<span class="number">1</span>:</span><br><span class="line">            self.oldxy = me.GetX(), me.GetY()</span><br><span class="line">        <span class="keyword">if</span> me.GetButton()==<span class="number">3</span>:</span><br><span class="line">            self.fit()</span><br><span class="line">    wheel = np.sign(me.GetWheelRotation())</span><br><span class="line">    <span class="keyword">if</span> wheel!=<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> wheel == <span class="number">1</span>:</span><br><span class="line">            self.zoomout(me.GetX(), me.GetY())</span><br><span class="line">        <span class="keyword">if</span> wheel == -<span class="number">1</span>:</span><br><span class="line">            self.zoomin(me.GetX(), me.GetY())</span><br><span class="line">    <span class="keyword">if</span> me.Dragging():</span><br><span class="line">        x, y = self.oldxy</span><br><span class="line">        self.move(me.GetX()-x, me.GetY()-y)</span><br><span class="line">        self.oldxy = me.GetX(), me.GetY()</span><br></pre></td></tr></table></figure>
<p>可以看出，首先对鼠标按键按下做判断：1就是左键，3就是右键，2就是中键，如果想更清楚地表示的话，可以分别用wx.MOUSE_BTN_LEFT、wx.MOUSE_BTN_MIDDLE和wx.MOUSE_BTN_RIGHT来表示。<br>如果是左键按下，就要捕捉当前鼠标所在的像素坐标系（以图像左上角为原点）的坐标。然后下面如果接着出了Dragging()事件，则记录新的坐标点，同时根据新旧坐标点移动conbox，并重新绘图。<br>如果是右键按下，则会调用fit()方法，对比oribox与winbox的相对大小，然后寻找哪个收缩比例可以使得oribox小于winbox，然后调用zoom()，传给zoom()的是收缩因子以及中心点(0,0)，更新一下conbox。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scales = [<span class="number">0.03125</span>, <span class="number">0.0625</span>, <span class="number">0.125</span>, <span class="number">0.25</span>, <span class="number">0.5</span>, <span class="number">0.75</span>, <span class="number">1</span>, <span class="number">1.5</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">50</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> self.scales[<span class="number">6</span>::-<span class="number">1</span>]:</span><br><span class="line">    <span class="keyword">if</span> oriw*i&lt;winw <span class="keyword">and</span> orih*i&lt;winh:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">self.scaidx = self.scales.index(i)</span><br></pre></td></tr></table></figure>
<p>scales属性本身存放了很多的缩放因子，fit()方法寻找收缩因子的时候，是从中间的比例1往前查找，找到第一个能使图像完整呈现的因子。<br>如果是鼠标滚轮动了，则：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> wheel == <span class="number">1</span>:</span><br><span class="line">    self.zoomout(me.GetX(), me.GetY())</span><br><span class="line"><span class="keyword">if</span> wheel == -<span class="number">1</span>:</span><br><span class="line">    self.zoomin(me.GetX(), me.GetY())</span><br></pre></td></tr></table></figure>
<p>判断到底是放大还是缩小，然后分别调用zoomout()和zoomin()，注意将当前鼠标的坐标点传入，这样就能够实现以当前鼠标点为中心进行缩放，妙~~~</p>
<h3 id="空闲事件"><a href="#空闲事件" class="headerlink" title="空闲事件"></a>空闲事件</h3><p>目前该事件处理函数是空的。</p>
<h3 id="绘图事件"><a href="#绘图事件" class="headerlink" title="绘图事件"></a>绘图事件</h3><p>这个事件就是wx.EVT_PAINT：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_paint</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    wx.BufferedPaintDC(self, self.buffer)</span><br></pre></td></tr></table></figure>
<p>这个事件发生在拉动窗口边界时，此时创建一个临时的BufferedPaintDC，然后将当前的缓冲呈现出来。</p>
<h1 id="boxutil模块及其方法"><a href="#boxutil模块及其方法" class="headerlink" title="boxutil模块及其方法"></a>boxutil模块及其方法</h1><h2 id="cross-方法"><a href="#cross-方法" class="headerlink" title="cross()方法"></a>cross()方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cross</span>(<span class="params">winbox, conbox</span>):</span></span><br><span class="line">    two = np.array([winbox, conbox])</span><br><span class="line">    x1, y1 = two[:,:<span class="number">2</span>].<span class="built_in">max</span>(axis=<span class="number">0</span>)</span><br><span class="line">    x2, y2 = two[:,<span class="number">2</span>:].<span class="built_in">min</span>(axis=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> [x1, y1, x2, y2]</span><br></pre></td></tr></table></figure>
<p>cross()方法就是取winbox和conbox这两个矩形框交叠的部分。<br>比如，winbox是[0, 0, 520, 211]，conbox是[4.0, -2, 516.0, 510]，那么cross()返回的就是[4.0, 0.0, 516.0, 211.0]。</p>
<h2 id="lay-方法"><a href="#lay-方法" class="headerlink" title="lay()方法"></a>lay()方法</h2><p>lay()的功能就是根据图像与窗口之间的相对大小来设定conbox的大小。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">layx</span>(<span class="params">winbox, conbox</span>):</span></span><br><span class="line">    conw = conbox[<span class="number">2</span>]-conbox[<span class="number">0</span>]</span><br><span class="line">    winw = winbox[<span class="number">2</span>]-winbox[<span class="number">0</span>]  </span><br><span class="line">    <span class="keyword">if</span> conw&lt;winw:</span><br><span class="line">        mid = (winbox[<span class="number">0</span>]+winbox[<span class="number">2</span>])/<span class="number">2</span></span><br><span class="line">        conbox[<span class="number">0</span>] = mid-conw/<span class="number">2</span></span><br><span class="line">        conbox[<span class="number">2</span>] = mid+conw/<span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> conbox[<span class="number">0</span>] &gt; winbox[<span class="number">0</span>]:</span><br><span class="line">        conbox[<span class="number">0</span>] = winbox[<span class="number">0</span>]</span><br><span class="line">        conbox[<span class="number">2</span>] = conbox[<span class="number">0</span>] + conw</span><br><span class="line">    <span class="keyword">elif</span> conbox[<span class="number">2</span>] &lt; winbox[<span class="number">2</span>]:</span><br><span class="line">        conbox[<span class="number">2</span>] = winbox[<span class="number">2</span>]</span><br><span class="line">        conbox[<span class="number">0</span>] = conbox[<span class="number">2</span>] - conw</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">layy</span>(<span class="params">winbox, conbox</span>):</span></span><br><span class="line">    winh = winbox[<span class="number">3</span>]-winbox[<span class="number">1</span>]</span><br><span class="line">    conh = conbox[<span class="number">3</span>]-conbox[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> conh&lt;winh:</span><br><span class="line">        mid = (winbox[<span class="number">1</span>]+winbox[<span class="number">3</span>])/<span class="number">2</span></span><br><span class="line">        conbox[<span class="number">1</span>] = mid-conh/<span class="number">2</span></span><br><span class="line">        conbox[<span class="number">3</span>] = mid+conh/<span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> conbox[<span class="number">1</span>] &gt; winbox[<span class="number">1</span>]:</span><br><span class="line">        conbox[<span class="number">1</span>] = winbox[<span class="number">1</span>]</span><br><span class="line">        conbox[<span class="number">3</span>] = conbox[<span class="number">1</span>] + conh</span><br><span class="line">    <span class="keyword">elif</span> conbox[<span class="number">3</span>] &lt; winbox[<span class="number">3</span>]:</span><br><span class="line">        conbox[<span class="number">3</span>] = winbox[<span class="number">3</span>]</span><br><span class="line">        conbox[<span class="number">1</span>] = conbox[<span class="number">3</span>] - conh</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lay</span>(<span class="params">winbox, conbox</span>):</span></span><br><span class="line">    layx(winbox, conbox)</span><br><span class="line">    layy(winbox, conbox)</span><br></pre></td></tr></table></figure>
<p>可以分为以下几种情况，以x方向的大小为例（从layx和layy可以看出，两者代码是一致的），主要是判断宽度的相对大小、左端点和右端点的相对位置：<br>（1）如果conbox宽度小于winbox，即整张图像无法完全填充整个窗口，需要使用空白来填充窗口时，则：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> conw&lt;winw:</span><br><span class="line">    mid = (winbox[<span class="number">0</span>]+winbox[<span class="number">2</span>])/<span class="number">2</span></span><br><span class="line">    conbox[<span class="number">0</span>] = mid-conw/<span class="number">2</span></span><br><span class="line">    conbox[<span class="number">2</span>] = mid+conw/<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>即先得到winbox的中心mid，然后这个中心mid在左右分别减去和加上conbox的半宽，就得到新的conbox的位置，但保持其宽度不变。<br>（2）如果conbox宽度大于winbox，即conbox能覆盖住winbox，在此前提下，如果conbox的左侧端点大于winbox的左侧，即conbox相比于winbox太靠右了，则：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elif</span> conbox[<span class="number">0</span>] &gt; winbox[<span class="number">0</span>]:</span><br><span class="line">    conbox[<span class="number">0</span>] = winbox[<span class="number">0</span>]</span><br><span class="line">    conbox[<span class="number">2</span>] = conbox[<span class="number">0</span>] + conw</span><br></pre></td></tr></table></figure>
<p>即将conbox挪回到winbox的左侧，同时还要保证原来的宽度不变。<br>（3）另外，在conbox能覆盖住winbox前提下，如果conbox的右侧端点小于winbox的右侧，即conbox相比于winbox太靠左了，则：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elif</span> conbox[<span class="number">2</span>] &lt; winbox[<span class="number">2</span>]:</span><br><span class="line">    conbox[<span class="number">2</span>] = winbox[<span class="number">2</span>]</span><br><span class="line">    conbox[<span class="number">0</span>] = conbox[<span class="number">2</span>] - conw</span><br></pre></td></tr></table></figure>
<p>则将conbox挪回到winbox的右侧，同时还要保证原来的宽度不变。<br>后面这两种情形都与鼠标动作的拖动有关，即捕捉当前鼠标位置，拖动后再记录当前新位置，两者相减得到移动量，得到更新的conbox位置。</p>
<h2 id="mat-方法"><a href="#mat-方法" class="headerlink" title="mat()方法"></a>mat()方法</h2><p>mat()方法是为了得到图像conbox与绘图区域csbox的旋转缩放矩阵matrix及偏移量offset。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">o, m = mat(self.oribox, self.conbox, csbox)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mat</span>(<span class="params">ori, vir, cros</span>):</span></span><br><span class="line">    kx = (ori[<span class="number">2</span>]-ori[<span class="number">0</span>])/(vir[<span class="number">2</span>]-vir[<span class="number">0</span>])</span><br><span class="line">    ky = (ori[<span class="number">3</span>]-ori[<span class="number">1</span>])/(vir[<span class="number">3</span>]-vir[<span class="number">1</span>])</span><br><span class="line">    ox = (cros[<span class="number">1</span>]-vir[<span class="number">1</span>])*ky</span><br><span class="line">    oy = (cros[<span class="number">0</span>]-vir[<span class="number">0</span>])*kx</span><br><span class="line">    <span class="keyword">return</span> (ox, oy), (kx, ky)</span><br></pre></td></tr></table></figure>
<p>传入的分别是oribox（这里oribox一直没变）、conbox和csbox，然后返回偏移量和缩放因子。</p>
<h1 id="imutil模块及其方法"><a href="#imutil模块及其方法" class="headerlink" title="imutil模块及其方法"></a>imutil模块及其方法</h1><h2 id="stretch-方法"><a href="#stretch-方法" class="headerlink" title="stretch()方法"></a>stretch()方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stretch</span>(<span class="params">img, out, rg, rgb=<span class="literal">None</span>, mode=<span class="string">&#x27;set&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> img.dtype==np.uint8 <span class="keyword">and</span> rg==(<span class="number">0</span>,<span class="number">255</span>):</span><br><span class="line">        out[:] = img</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        np.subtract(img, rg[<span class="number">0</span>], out=out, casting=<span class="string">&#x27;unsafe&#x27;</span>)</span><br><span class="line">        np.multiply(img, <span class="number">255.0</span>/np.ptp(rg), out=out, casting=<span class="string">&#x27;unsafe&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>这一方法实际在这个canvas中只运行了if中的语句，else中的并没有执行，所以其实并没有深刻理解它干了啥。<br>目前看，if中实现了用img来填充out中的内容。注意这个赋值语句中，左边是out的切片，千万不能将这个切片去掉，否则img和out的地址是一样的，即out也指向了img，而如果使用了切片，out还是保留原来的地址指向，只是内容改成了img。知识点可以参见如下：<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/10623302/how-assignment-works-with-python-list-slice">How assignment works with Python list slice?</a></p>
<h2 id="lookup-方法"><a href="#lookup-方法" class="headerlink" title="lookup()方法"></a>lookup()方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lookup</span>(<span class="params">img, lut, out, mode=<span class="string">&#x27;set&#x27;</span></span>):</span></span><br><span class="line">    blend(lut[img], out, img, mode)</span><br></pre></td></tr></table></figure>
<p>可以看出，lookup()方法实际是调用了下面的blend()方法，所以具体干了啥还要看一下blend()干了啥。<br>但这一步中有一个非常重要的操作，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lut[img]</span><br></pre></td></tr></table></figure>
<p>这一步就是将img作为参数传入了lut查找表中，其实是用到了Numpy的Fancy Indexing，具体知识点可以查看之前一篇博文。<br>值得注意的是，Fancy Indexing返回的数组的shape是索引的shape，所以这一步其实返回的是一个跟img相同shape的另一张图像。<br>所以，这一步的效果就是将图像按照查找表中的颜色进行了重新着色，即当img中的像素值为1时，那么就取lut中的(255, 0, 0)红色。</p>
<h2 id="blend-方法"><a href="#blend-方法" class="headerlink" title="blend()方法"></a>blend()方法</h2><p>blend()方法有很多种模式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">blend</span>(<span class="params">img, out, msk, mode</span>):</span></span><br><span class="line">    <span class="keyword">if</span> mode==<span class="string">&#x27;set&#x27;</span>: out[:] = img</span><br><span class="line">    <span class="keyword">if</span> mode==<span class="string">&#x27;min&#x27;</span>: np.minimum(out, img, out=out)</span><br><span class="line">    <span class="keyword">if</span> mode==<span class="string">&#x27;max&#x27;</span>: np.maximum(out, img, out=out)</span><br><span class="line">    <span class="keyword">if</span> mode==<span class="string">&#x27;msk&#x27;</span>:</span><br><span class="line">        msk = np.logical_not(msk)</span><br><span class="line">        out.T[:] *= msk.T</span><br><span class="line">        out += img</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(mode, <span class="built_in">float</span>):</span><br><span class="line">        np.multiply(out, <span class="number">1</span>-mode, out=out, casting=<span class="string">&#x27;unsafe&#x27;</span>)</span><br><span class="line">        np.multiply(img, mode, out=img, casting=<span class="string">&#x27;unsafe&#x27;</span>)</span><br><span class="line">        out += img</span><br></pre></td></tr></table></figure>
<p>最终目的就是看按哪一种方式将img和out混合起来：<br>（1）set模式：直接将out里的内容设为img<br>（2）min模式：逐个对比out和img两张图像中的像素，选择数值小的像素存入out<br>（3）max模式：逐个对比out和img两张图像中的像素，选择数值大的像素存入out<br>（4）msk模式：在掩膜msk不为0的地方，将out设为0；在msk为0的地方，保留原值（因为对msk作了逻辑非操作，然后下面主元素相乘时，True为1，False为0）。然后将img和out进行相加合成。<br>（5）按比例混合模式：mode可以是一个小数，即将out与1-mode相乘，img与mode相乘，然后两者相加合成。</p>
<h2 id="mix-img-方法"><a href="#mix-img-方法" class="headerlink" title="mix_img()方法"></a>mix_img()方法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mix_img</span>(<span class="params">img, m, o, shp, buf, rgb, byt, rg=(<span class="params"><span class="number">0</span>,<span class="number">255</span></span>), lut=<span class="literal">None</span>, cns=<span class="number">0</span>, mode=<span class="string">&#x27;set&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> img <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">return</span></span><br><span class="line">    img = img.reshape((img.shape[<span class="number">0</span>], img.shape[<span class="number">1</span>], -<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(rg, <span class="built_in">tuple</span>): rg = [rg]*img.shape[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(cns, <span class="built_in">int</span>):</span><br><span class="line">        affine_transform(img[:,:,cns], m, o, shp, buf, <span class="number">0</span>, <span class="string">&#x27;nearest&#x27;</span>)</span><br><span class="line">        stretch(buf, byt, rg[cns])</span><br><span class="line">        <span class="keyword">return</span> lookup(byt, lut, rgb, mode)</span><br><span class="line"></span><br><span class="line">    irgb = [cns.index(i) <span class="keyword">if</span> i <span class="keyword">in</span> cns <span class="keyword">else</span> -<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&#x27;rgb&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">enumerate</span>(irgb):</span><br><span class="line">        <span class="keyword">if</span> v==-<span class="number">1</span>: rgb[:,:,i] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">elif</span> mode==<span class="string">&#x27;set&#x27;</span> <span class="keyword">and</span> buf.dtype==np.uint8 <span class="keyword">and</span> rg[v]==(<span class="number">0</span>,<span class="number">255</span>):</span><br><span class="line">            affine_transform(img[:,:,v], m, o, shp, rgb[:,:,v], <span class="number">0</span>, prefilter=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            affine_transform(img[:,:,v], m, o, shp, buf, <span class="number">0</span>, prefilter=<span class="literal">False</span>)</span><br><span class="line">            stretch(buf, byt, rg[v])</span><br><span class="line">            blend(byt, rgb[:,:,v], byt, mode)</span><br></pre></td></tr></table></figure>
<p>mix_img()方法接收的参数特别多：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mix_img</span>(<span class="params">img, m, o, shp, buf, rgb, byt, rg=(<span class="params"><span class="number">0</span>,<span class="number">255</span></span>), lut=<span class="literal">None</span>, cns=<span class="number">0</span>, mode=<span class="string">&#x27;set&#x27;</span></span>):</span></span><br></pre></td></tr></table></figure>
<p>第一个是img图像，从前面的调用可知，可以传入前景图或背景图；<br>第一个是m，旋转缩放矩阵；<br>第三个是shp，即最终要绘图的区域大小；<br>第四个是buf，其在显示某个通道（即单通道图像）时作为仿射变换后的图像；<br>第五个是rgb，其在显示RGB彩色图时作为仿射变换后的图像，在显示单通道图像时作为混合图像的背景；<br>第六个是byt，这张图像没分析出有什么作用。。；<br>第七个是rg，像素值范围，默认是(0, 255)；<br>第八个是lut，查找表；<br>第九个是cns，通道标识；<br>第十个是mode，混合模式。</p>
<p>具体看一下mix_img的操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mix_img</span>(<span class="params">img, m, o, shp, buf, rgb, byt, rg=(<span class="params"><span class="number">0</span>,<span class="number">255</span></span>), lut=<span class="literal">None</span>, log=<span class="literal">True</span>, cns=<span class="number">0</span>, mode=<span class="string">&#x27;set&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> img <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">return</span></span><br><span class="line">    img = img.reshape((img.shape[<span class="number">0</span>], img.shape[<span class="number">1</span>], -<span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<p>首先是对img进行一下reshape，这里是将img的格式统一一下，将原来的两维或三维数组统一为三维数组。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">isinstance</span>(rg, <span class="built_in">tuple</span>): rg = [rg]*img.shape[<span class="number">2</span>]</span><br></pre></td></tr></table></figure>
<p>这里也是对范围range进行一下统一，如果rg为元组，则将其转化为与img的通道数相匹配的形式，比如原来rg是(0, 255)，若图像是三通道的，则经过转换后，rg变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(<span class="number">0</span>, <span class="number">255</span>), (<span class="number">0</span>, <span class="number">255</span>), (<span class="number">0</span>, <span class="number">255</span>)]</span><br></pre></td></tr></table></figure>
<p>接下来是对通道的处理：<br>如果cns是一个数，比如就选了一张彩色图中的一个通道显示，或者直接就是一张灰度图，那么：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">isinstance</span>(cns, <span class="built_in">int</span>):</span><br><span class="line">    <span class="keyword">if</span> np.iscomplexobj(buf):</span><br><span class="line">        affine_transform(img[:,:,<span class="number">0</span>].real, m, o, shp, buf.real, <span class="number">0</span>, prefilter=<span class="literal">False</span>)</span><br><span class="line">        affine_transform(img[:,:,<span class="number">0</span>].imag, m, o, shp, buf.imag, <span class="number">0</span>, prefilter=<span class="literal">False</span>)</span><br><span class="line">        buf = complex_norm(buf, buf.real, buf.imag, buf.real)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        affine_transform(img[:,:,cns], m, o, shp, buf, <span class="number">0</span>, prefilter=<span class="literal">False</span>)</span><br><span class="line">    stretch(buf, byt, rg[cns], log)</span><br><span class="line">    <span class="keyword">return</span> lookup(byt, lut, rgb, mode)</span><br></pre></td></tr></table></figure>
<p>（1）首先判断一下buf是不是复数，这里应该是支持傅里叶变换的图像显示，暂且不分析；<br>（2）否则，就对该图像（灰度图或彩图的某一通道）进行仿射变换，输出到buf中，接着通过stretch转移到byt中，然后再调用lookup，根据上面的分析，lookup实际调用了blend，只是中间转了一下，输入到blend中的是lut(byt)，即将原图用lut转一下，然后再图像混合到rgb，即此种情况下rgb中的颜色是原图在查找表lut中的值。</p>
<p>如果通道标识cns是一个元组形式传入的，则：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">enumerate</span>(cns):</span><br><span class="line">    <span class="keyword">if</span> v==-<span class="number">1</span>: rgb[:,:,i] = <span class="number">0</span></span><br><span class="line">    <span class="keyword">elif</span> mode==<span class="string">&#x27;set&#x27;</span> <span class="keyword">and</span> img.dtype==np.uint8 <span class="keyword">and</span> rg[v]==(<span class="number">0</span>,<span class="number">255</span>) <span class="keyword">and</span> <span class="keyword">not</span> log:</span><br><span class="line">        affine_transform(img[:,:,v], m, o, shp, rgb[:,:,i], <span class="number">0</span>, prefilter=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        affine_transform(img[:,:,v], m, o, shp, buf, <span class="number">0</span>, prefilter=<span class="literal">False</span>)</span><br><span class="line">        stretch(buf, byt, rg[v], log)</span><br><span class="line">        blend(byt, rgb[:,:,i], byt, mode)</span><br></pre></td></tr></table></figure>
<p>对通道标识cns进行遍历，这里有多个判断条件：<br>（1）如果某个标识为-1，则将rgb中的相应通道置为0，<br>（2）否则，如果mode为set，且满足dtype、rg的相应条件，则进行仿射变换，注意此时改变的是rgb的相应通道，即将img的相应通道的值经过放射变换赋值给rgb的相应通道。这种情况就是用来显示RGB彩色图；<br>（3）若上述条件都不满足，则进行以下操作，这种情形就是用来显示彩色图的某些通道，但又与单独显示某通道不同：<br>（3.1）仿射变换：注意这里的output是buf，因为buf是单一通道，所以这里直接就是对其本身进行作用；<br>（3.2）stretch：目前这里的测试效果就是将buf的值同样赋值给byt，即byt也是img的仿射变换<br>（3.3）blend：这里是混合模式的设置，注意这里是将byt和rgb的相应通道进行混合，改变的是rgb的值，注意，后面画布绘制出的也是基于self.rgb。</p>
<p>经过上面对于通道标识cns的分析，就可以知道以下两者的不同：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">image.cn = (<span class="number">0</span>, -<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line">image.cn = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>假设图像是一张RGB彩色图，前者是将绿色通道和蓝色通道都置为0，红色通道照常处理，最终呈现的还是三者的综合；而后者是仅选了红色通道，即将红色通道单独摘出来作为一张灰度图显示。</p>
<p>mix_img()方法主要操作就是仿射变换和图像混合。关于仿射变换的具体细节见下面一小节。</p>
<p>以下面的代码为例，看看具体是怎么搞的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">image = Image()</span><br><span class="line">msk = np.zeros(astronaut().shape[:<span class="number">2</span>], dtype=np.uint8)</span><br><span class="line">msk[<span class="number">100</span>:<span class="number">200</span>,<span class="number">100</span>:<span class="number">200</span>] = <span class="number">1</span></span><br><span class="line">msk[<span class="number">200</span>:<span class="number">300</span>,<span class="number">200</span>:<span class="number">300</span>] = <span class="number">2</span></span><br><span class="line">msk[<span class="number">300</span>:<span class="number">400</span>,<span class="number">300</span>:<span class="number">400</span>] = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">image.img = msk</span><br><span class="line"> </span><br><span class="line">bak = Image([astronaut()])</span><br><span class="line">bak.cn = (<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">image.back = bak</span><br><span class="line">image.mode = <span class="string">&#x27;msk&#x27;</span></span><br><span class="line"></span><br><span class="line">canvas.images.append(image)</span><br></pre></td></tr></table></figure>
<p>注意，前景图是一个有个别位置不为0的掩膜，背景图是宇航员图，前景图的混合模式是msk。</p>
<p>第一次调用“图像混合”方法时：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mix_img(back.img, m, o, shp, self.outbak,</span><br><span class="line">    self.outrgb, self.outint, back.rg, back.lut,</span><br><span class="line">    back.log, cns=back.cn, mode=<span class="string">&#x27;set&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>以宇航员astronaut()图像为例，传入的这些参数实际值是：<br>back.img的shape是(512, 512, 3)，<br>m是(4.0, 4.0)，这个值（包括下面的o和shp）不是固定的，与具体操作有关，这里不是绝对值，<br>o是(0.0, 0.0)，<br>shp是(128, 128)，<br>self.outbak对应形参中的buf，即缓冲，是shape为(128, 128)的全为0的数组，<br>self.outrgb对应形参中的rgb，即彩色图，是shape为(128, 128, 3)的全为0的数组，<br>self.outint对应形参中的byt，即灰度图，是shape为(128, 128)的全为0的数组，<br>back.rg是(0, 255)，即数值范围，<br>back.lut是查找表，这里默认的是shape为(256, 3)的数组，由以下语句构建：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default_lut = np.arange(<span class="number">256</span>*<span class="number">3</span>, dtype=np.uint8).reshape((<span class="number">3</span>,-<span class="number">1</span>)).T</span><br></pre></td></tr></table></figure>
<p>具体的值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">array([[  <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>],</span><br><span class="line">       [  <span class="number">1</span>,   <span class="number">1</span>,   <span class="number">1</span>],</span><br><span class="line">       [  <span class="number">2</span>,   <span class="number">2</span>,   <span class="number">2</span>],</span><br><span class="line">       [  <span class="number">3</span>,   <span class="number">3</span>,   <span class="number">3</span>],</span><br><span class="line">…</span><br><span class="line">       [ <span class="number">254</span>,  <span class="number">254</span>,  <span class="number">254</span>],</span><br><span class="line">       [ <span class="number">255</span>,  <span class="number">255</span>,  <span class="number">255</span>],</span><br></pre></td></tr></table></figure>
<p>back.log是False，<br>back.cn是通道标识，这里是(0, 1, 2)，<br>mode为’set’。<br>经过这一步的mix_img，改变的只有self.outrgb，其大小仍是(128, 128, 3)，但数值已经变成了img经过仿射变换后的数值。</p>
<p>第二次调用“图像混合”方法时：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mix_img(img.img, m, o, shp, self.outimg,</span><br><span class="line">    self.outrgb, self.outint, img.rg, img.lut,</span><br><span class="line">    img.log, cns=img.cn, mode=img.mode)</span><br></pre></td></tr></table></figure>
<p>注意，这一次是基于img.img，即前景图，相应的buf、rg、lut、log也都是前景图的属性，值得注意的是这一次仍然调用了self.outrgb，它的值经过了前面背景图的处理，已经变成了背景图的仿射变换。<br>然后，这里因为是msk模式，先是将掩膜（再次强调掩膜是这里的前景图）仿射变换到buf，然后将buf和rgb进行混合，在掩膜不为0的地方，会将rgb的值置为掩膜的值，比如某些位置置为掩膜中的1，然后在显示时，就会去寻找lut中位置为1的颜色。</p>
<h2 id="仿射变换"><a href="#仿射变换" class="headerlink" title="仿射变换"></a>仿射变换</h2><p><a target="_blank" rel="noopener" href="https://sparkydogx.github.io/2018/09/03/affine-with-python/">使用python对2D坐标点进行仿射变换</a><br>仿射变换就是对原图进行缩放、旋转、平移等操作，其示意图如下图（取自上面的文献）：<br><img src="https://user-images.githubusercontent.com/6218739/69029568-54ff6680-0a10-11ea-879e-e1df857d0df2.jpg"><br>可以通过下面的代码进行探究：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> scipy.ndimage <span class="keyword">import</span> affine_transform</span><br><span class="line"><span class="keyword">from</span> skimage <span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">from</span> skimage.data <span class="keyword">import</span> astronaut</span><br><span class="line"> </span><br><span class="line">img = astronaut()</span><br><span class="line">matrix = (<span class="number">0.5</span>, <span class="number">0.1</span>)</span><br><span class="line"><span class="comment"># theta = np.pi/4</span></span><br><span class="line"><span class="comment"># matrix = ((np.cos(theta), np.sin(theta)), (-np.sin(theta), np.cos(theta)))</span></span><br><span class="line">offset = (<span class="number">0</span>, <span class="number">100</span>)</span><br><span class="line">shape = img.shape</span><br><span class="line">output = np.zeros(shape, dtype=np.uint8)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    affine_transform(img[:, :, i], matrix, offset, output.shape[<span class="number">0</span>:<span class="number">2</span>], output[:,:,i])</span><br><span class="line"></span><br><span class="line">io.imshow(output)</span><br><span class="line">io.show()</span><br></pre></td></tr></table></figure>
<p>对于图中的九种操作，可以按如下参数进行设定得到：<br>（1）no change:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">matrix = (<span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">offset = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>（2）Translate:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">matrix = (<span class="number">1.0</span>, <span class="number">1.0</span>)</span><br><span class="line">offset = (<span class="number">100</span>, <span class="number">200</span>)</span><br><span class="line"><span class="comment"># or offset = 100</span></span><br></pre></td></tr></table></figure>
<p>这个地方可以单独为x、y设置偏移，也可以只设置一个数，表示x、y都偏移多少。注意，前面的是y偏移量。<br>（3）Scale about origin:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">matrix = (<span class="number">0.5</span>, <span class="number">0.1</span>)</span><br><span class="line">offset = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>小于1为放大倍数，大于1则为缩小倍数。<br>（4）Rotate about origin:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">theta = np.pi/<span class="number">4</span></span><br><span class="line">matrix = ((np.cos(theta), np.sin(theta)), (-np.sin(theta), np.cos(theta)))</span><br><span class="line">offset = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>theta就是旋转角度。<br>（5）Shear in x direction：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">phi = np.pi/<span class="number">6</span></span><br><span class="line">matrix = ((<span class="number">1.0</span>, <span class="number">0.0</span>), (np.tan(phi), <span class="number">1.0</span>))</span><br><span class="line">offset = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>（6）Shear in y direction:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">phi = np.pi/<span class="number">6</span></span><br><span class="line">matrix = ((<span class="number">1.0</span>, np.tan(phi)), (<span class="number">0.0</span>, <span class="number">1.0</span>))</span><br><span class="line">offset = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>（7）Reflect about origin:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">matrix = (-<span class="number">1.0</span>, -<span class="number">1.0</span>)</span><br><span class="line">offset = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>实测这样操作后，因为还是显示的第一象限的数据，此时全是黑色。<br>其实可以通过：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">offset = img.shape[<span class="number">0</span>:<span class="number">2</span>]</span><br></pre></td></tr></table></figure>
<p>将图像给挪到第一象限中，从而正确显示。<br>（8）Reflect about x-axis</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">matrix = (<span class="number">1.0</span>, -<span class="number">1.0</span>)</span><br></pre></td></tr></table></figure>
<p>同样，通过平移将它挪到第一象限中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">offset = (<span class="number">0</span>, img.shape[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>
<p>（9）Reflect about y-axis</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">matrix = (-<span class="number">1.0</span>, <span class="number">1.0</span>)</span><br></pre></td></tr></table></figure>
<p>同样，通过平移将它挪到第一象限中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">offset = (img.shape[<span class="number">0</span>], <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>另外，上面代码中的shape是取的跟原有图像一样的shape，这里可以任意设定大小，那么就可以得到特定形状的输出图像，比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shape = (<span class="number">100</span>, <span class="number">200</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>上述代码中img和output都是3通道，也可以output只有1通道，那么相应的输出shape也要改一下，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shape = (<span class="number">512</span>, <span class="number">512</span>)</span><br><span class="line">output = np.zeros(shape, dtype=np.uint8)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    affine_transform(img[:, :, i], matrix, offset, output.shape[<span class="number">0</span>:<span class="number">2</span>], output)</span><br></pre></td></tr></table></figure>
<p>此时虽然做了三次仿射变换，但只有img的第三个通道作用在了output上，它把前两个通道的作用给覆盖了。<br>即输入图像和输出图像可以不是一样的通道数，但affine_transform()的第四个参数shape和第五个参数output它俩一定要对应好。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/10/20/python-indexing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/20/python-indexing/" class="post-title-link" itemprop="url">Numpy的广播Broadcasting和奇妙索引Fancy Indexing</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-20 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-20T00:00:00+08:00">2019-10-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/10/20/python-indexing/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/20/python-indexing/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考文献：<br><a target="_blank" rel="noopener" href="https://jakevdp.github.io/PythonDataScienceHandbook/02.05-computation-on-arrays-broadcasting.html">Computation on Arrays: Broadcasting</a><br><a target="_blank" rel="noopener" href="https://docs.scipy.org/doc/numpy/reference/arrays.indexing.html">Indexing</a></p>
<p>本文就是对上面两篇参考文献的翻译理解。</p>
<h1 id="广播Broadcasting"><a href="#广播Broadcasting" class="headerlink" title="广播Broadcasting"></a>广播Broadcasting</h1><p>广播的原则：<br>（1）如果两个数组的形状不同，那么形状小的那个数组填充成另一个数组的形状（注意是用形状1来向左填充，具体见下方示例）。<br>（2）如果两个数组的形状相同，但某一维度上数目不匹配，那么在这一维度上形状为1的数组扩展成另一个数组的形状。<br>（3）如果两个数组的形状相同，在某一维度上数目不匹配，但在这一维度上形状都不为1，那么报错。</p>
<h2 id="Example-1"><a href="#Example-1" class="headerlink" title="Example 1"></a>Example 1</h2><p>我们想把下面两个数组相加：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M = np.ones((<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line">a = np.arange(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>两者的形状是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M.shape = (<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">a.shape = (<span class="number">3</span>,)</span><br></pre></td></tr></table></figure>
<p>那么，根据规则1，需要先填充a的形状为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M.shape -&gt; (2, 3)</span><br><span class="line">a.shape -&gt; (1, 3)</span><br></pre></td></tr></table></figure>
<p>根据规则2，在第一维上，两者形状不匹配，那么继续扩展：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M.shape -&gt; (2, 3)</span><br><span class="line">a.shape -&gt; (2, 3)</span><br></pre></td></tr></table></figure>
<p>因此M和a相当于：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M -&gt; array([[1., 1., 1.], [1., 1., 1.]])</span><br><span class="line">a -&gt; array([[0, 1, 2], [0, 1, 2]])</span><br></pre></td></tr></table></figure>
<p>那么，两者相加即为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>M + a</span><br><span class="line">array([[<span class="number">1.</span>, <span class="number">2.</span>, <span class="number">3.</span>],</span><br><span class="line">       [<span class="number">1.</span>, <span class="number">2.</span>, <span class="number">3.</span>]])</span><br></pre></td></tr></table></figure>

<h2 id="Example-2"><a href="#Example-2" class="headerlink" title="Example 2"></a>Example 2</h2><p>这个例子是两个数组都要广播的情形。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = np.arange(<span class="number">3</span>).reshape((<span class="number">3</span>, <span class="number">1</span>))</span><br><span class="line">b = np.arange(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>那么，两者的shape是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a.shape = (<span class="number">3</span>, <span class="number">1</span>)</span><br><span class="line">b.shape = (<span class="number">3</span>,)</span><br></pre></td></tr></table></figure>
<p>根据规则1，需要将b的shape填充为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a.shape -&gt; (3, 1)</span><br><span class="line">b.shape -&gt; (1, 3)</span><br></pre></td></tr></table></figure>
<p>然后根据规则2，需要将两者都扩展为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a.shape -&gt; (3, 3)</span><br><span class="line">b.shape -&gt; (3, 3)</span><br></pre></td></tr></table></figure>
<p>那么，实际两者扩展成：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a -&gt; array([[0, 0, 0],[1, 1, 1], [2, 2, 2]])</span><br><span class="line">b -&gt; array([[0, 1, 2],[0, 1, 2], [0, 1, 2]])</span><br></pre></td></tr></table></figure>
<p>所以，两者相加为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a + b</span><br><span class="line">array([[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">       [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">       [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]])</span><br></pre></td></tr></table></figure>
<h2 id="Example-3"><a href="#Example-3" class="headerlink" title="Example 3"></a>Example 3</h2><p>这个例子是两个例子不兼容的情形。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M = np.ones((<span class="number">3</span>, <span class="number">2</span>))</span><br><span class="line">a = np.arange(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>两者的形状为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M.shape = (<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line">a.shape = (<span class="number">3</span>,)</span><br></pre></td></tr></table></figure>
<p>根据规则1，要将a填充：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M.shape -&gt; (3, 2)</span><br><span class="line">a.shape -&gt; (1, 3)</span><br></pre></td></tr></table></figure>
<p>根据规则2，要将a的第一维扩展：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">M.shape -&gt; (3, 2)</span><br><span class="line">a.shape -&gt; (3, 3)</span><br></pre></td></tr></table></figure>
<p>此时就会触发规则3，即在第二维上形状不相同，但又都不为1：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>M + a</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">ValueError: operands could <span class="keyword">not</span> be broadcast together <span class="keyword">with</span> shapes (<span class="number">3</span>,<span class="number">2</span>) (<span class="number">3</span>,)</span><br></pre></td></tr></table></figure>
<p>此时你可能想着如果不是向左填充形状1，而是向右填充，那么问题就可以解决了。但广播的规则规定了只能向左填充，这是为了防止出现混乱。其实此时可以人为手动将a的形状改为(3,1)，即使用np.newaxis，因为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a[:, np.newaxis].shape</span><br><span class="line">(<span class="number">3</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>所以：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>M + a[:, np.newaxis]</span><br><span class="line">array([[<span class="number">1.</span>, <span class="number">1.</span>],</span><br><span class="line">       [<span class="number">2.</span>, <span class="number">2.</span>],</span><br><span class="line">       [<span class="number">3.</span>, <span class="number">3.</span>]])</span><br></pre></td></tr></table></figure>
<p>上述例子是针对于加号操作符，实际上上面的广播也适用于任意二元操作符。</p>
<h1 id="奇妙索引Fancy-Indexing"><a href="#奇妙索引Fancy-Indexing" class="headerlink" title="奇妙索引Fancy Indexing"></a>奇妙索引Fancy Indexing</h1><p>Fancy Indexing是指传递一个索引序列，然后一次性得到多个索引元素。</p>
<h2 id="一维数组的索引"><a href="#一维数组的索引" class="headerlink" title="一维数组的索引"></a>一维数组的索引</h2><p>生成一个一维数组x，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">rand = np.random.RandomState(<span class="number">42</span>)</span><br><span class="line">x = rand.randint(<span class="number">100</span>, size=<span class="number">10</span>)</span><br><span class="line"><span class="built_in">print</span>(x)</span><br></pre></td></tr></table></figure>
<p>返回结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">51</span> <span class="number">92</span> <span class="number">14</span> <span class="number">71</span> <span class="number">60</span> <span class="number">20</span> <span class="number">82</span> <span class="number">86</span> <span class="number">74</span> <span class="number">74</span>]</span><br></pre></td></tr></table></figure>
<p>（1）一维索引</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ind = [<span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>]</span><br><span class="line">x[ind]</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array([<span class="number">71</span>, <span class="number">86</span>, <span class="number">60</span>])</span><br></pre></td></tr></table></figure>
<p>（2）多维索引</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ind = np.array([[<span class="number">3</span>, <span class="number">7</span>],</span><br><span class="line">                [<span class="number">4</span>, <span class="number">5</span>]])</span><br><span class="line">x[ind]</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">array([[<span class="number">71</span>, <span class="number">86</span>],</span><br><span class="line">       [<span class="number">60</span>, <span class="number">20</span>]])</span><br></pre></td></tr></table></figure>
<p>因此，这里可以看出来，返回的array的shape是索引数组的shape，而不是被索引array的shape。</p>
<h2 id="多维数组的索引"><a href="#多维数组的索引" class="headerlink" title="多维数组的索引"></a>多维数组的索引</h2><p>生成一个多维数组X：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">X = np.arange(<span class="number">12</span>).reshape((<span class="number">3</span>, <span class="number">4</span>))</span><br><span class="line">X</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array([[ <span class="number">0</span>,  <span class="number">1</span>,  <span class="number">2</span>,  <span class="number">3</span>],</span><br><span class="line">       [ <span class="number">4</span>,  <span class="number">5</span>,  <span class="number">6</span>,  <span class="number">7</span>],</span><br><span class="line">       [ <span class="number">8</span>,  <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>]])</span><br></pre></td></tr></table></figure>
<p>对于传给X的索引，第一个参数表示行row，第二个参数表示列column：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">row = np.array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>])</span><br><span class="line">col = np.array([<span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>])</span><br><span class="line">X[row, col]</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array([ <span class="number">2</span>,  <span class="number">5</span>, <span class="number">11</span>])</span><br></pre></td></tr></table></figure>
<p>即分别取的是X[0, 2]、X[1, 1]和X[2, 3]的值。<br>注意，这个返回数组的shape仍然是索引数组的shape，而不是原始数组的shape。<br>再来一个多维的索引数组：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X[row[:, np.newaxis], col]</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array([[ <span class="number">2</span>,  <span class="number">1</span>,  <span class="number">3</span>],</span><br><span class="line">       [ <span class="number">6</span>,  <span class="number">5</span>,  <span class="number">7</span>],</span><br><span class="line">       [<span class="number">10</span>,  <span class="number">9</span>, <span class="number">11</span>]])</span><br></pre></td></tr></table></figure>
<p>可以逐个看一下第一个参数和第二个参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>row[:, np.newaxis]</span><br><span class="line">array([[<span class="number">0</span>],</span><br><span class="line">       [<span class="number">1</span>],</span><br><span class="line">       [<span class="number">2</span>]])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>col</span><br><span class="line">array([<span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>])</span><br></pre></td></tr></table></figure>
<p>两个的维度不同，那么就符合前面所说的广播的原则，即其实索引是这样的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X[[[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], [<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>]], [[<span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>], [<span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>], [<span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>]]]</span><br></pre></td></tr></table></figure>
<p>仍然提醒一句，返回数组的shape就是索引数组被广播后的shape。</p>
<h2 id="组合索引"><a href="#组合索引" class="headerlink" title="组合索引"></a>组合索引</h2><p>上面的Fancy Indexing可以和其他的索引方式进行组合。</p>
<h3 id="Fancy-Indexing-slice"><a href="#Fancy-Indexing-slice" class="headerlink" title="Fancy Indexing + slice"></a>Fancy Indexing + slice</h3><p>如果索引中有切片操作slice，或者ellipsis、newaxis等，可以看做是一个多维切片：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X[<span class="number">1</span>:, [<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>]]</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">array([[ <span class="number">6</span>,  <span class="number">4</span>,  <span class="number">5</span>],</span><br><span class="line">       [<span class="number">10</span>,  <span class="number">8</span>,  <span class="number">9</span>]])</span><br></pre></td></tr></table></figure>
<h3 id="Fancy-Indexing-mask"><a href="#Fancy-Indexing-mask" class="headerlink" title="Fancy Indexing + mask"></a>Fancy Indexing + mask</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mask = np.array([<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>], dtype=<span class="built_in">bool</span>)</span><br><span class="line">X[row[:, np.newaxis], mask]</span><br></pre></td></tr></table></figure>
<p>返回：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array([[ <span class="number">0</span>,  <span class="number">2</span>],</span><br><span class="line">       [ <span class="number">4</span>,  <span class="number">6</span>],</span><br><span class="line">       [ <span class="number">8</span>, <span class="number">10</span>]])</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/10/16/ImagePy_11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/16/ImagePy_11/" class="post-title-link" itemprop="url">ImagePy解析：11 -- 使用wxPython设备上下文绘图</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-16 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-16T00:00:00+08:00">2019-10-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/10/16/ImagePy_11/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/16/ImagePy_11/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文是对《wxPython in Action》一书的第6.1节和第12.2节的翻译理解。<br>ImagePy很多的组件都用到了wxPython的设备上下文进行绘制，比如histogram panel、curve panel、colormap panel和Canvas等。可以说，对于wxPython不提供的组件，ImagePy都通过DC绘制进行了自己开发，因此这一部分对于理解ImagePy的UI交互会很有帮助。</p>
<h1 id="wxPython设备上下文"><a href="#wxPython设备上下文" class="headerlink" title="wxPython设备上下文"></a>wxPython设备上下文</h1><p>为了能在屏幕上绘图，需要使用wxPython的称为设备上下文Device Context的对象，它能对显示设备进行抽象，给予每个设备一套通用的绘图方法，这样一来，编写的绘图代码就对任意的设备都是相同的。wxPython使用wx.DC及其子类来描述设备上下文。因为wx.DC是个抽象类，因此在实际使用时必须使用它的一个子类。</p>
<p>wx.DC的子类：<br>wx.BufferedDC：用来缓冲一系列的绘图命令，直到这些命令都完成且准备在屏幕上绘图，这可以防止出现不想要的闪烁现象；<br>wx.BufferedPaintDC：与wx.BufferedDC相同，但仅能在绘图事件wx.PaintEvent的处理过程中使用，仅能临时地创建该类的实例；<br>wx.ClientDC：用来在窗口的工作区绘图，即不能在边界或其他装饰区域绘图；该类应该被临时创建，且不能在wx.PaintEvent事件处理中使用；<br>wx.MemoryDC：用来将图像写入内存中的位图，不用来显示；然后可以选择这张位图，使用wx.DC.Blit()方法将位图绘制在窗口上；<br>wx.MetafileDC：在Windows操作系统上，该设备上下文可以用来创建标准的Windows元文件数据；<br>wx.PaintDC：与wx.ClientDC相同，但它仅能用在wx.PaintEvent事件处理中；仅临时创建该类的实例；<br>wx.PostScriptDC：用来存成PostScript文件；<br>wx.PrinterDC：在Windows平台上用来写文件给打印机；<br>wx.ScreenDC：用来直接在屏幕上绘图，仅能临时创建；<br>wx.WindowDC：用来在整个窗口上绘图，包括边界及其他装饰组件上；非Windows操作系统可能不支持该类。</p>
<h1 id="画图板"><a href="#画图板" class="headerlink" title="画图板"></a>画图板</h1><p>原始代码见：<br><a target="_blank" rel="noopener" href="https://github.com/freephys/wxPython-In-Action/blob/master/Chapter-06/example1.py">wxPython-In-Action/Chapter-06/example1.py</a></p>
<p>上述代码在Phoenix版的wxPython下无法运行，因为部分API已经改变，以下是经过修改后能够顺利运行的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SketchWindow</span>(<span class="params">wx.Window</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent, ID</span>):</span></span><br><span class="line">        wx.Window.__init__(self, parent, ID)</span><br><span class="line">        self.SetBackgroundColour(<span class="string">&quot;White&quot;</span>)</span><br><span class="line">        self.color = <span class="string">&quot;Black&quot;</span></span><br><span class="line">        self.thickness = <span class="number">1</span></span><br><span class="line">        self.pen = wx.Pen(self.color, self.thickness, wx.SOLID)</span><br><span class="line">        self.lines = []</span><br><span class="line">        self.curLine = []</span><br><span class="line">        self.pos = (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        self.InitBuffer()</span><br><span class="line"></span><br><span class="line">        self.Bind(wx.EVT_LEFT_DOWN, self.OnLeftDown)</span><br><span class="line">        self.Bind(wx.EVT_LEFT_UP, self.OnLeftUp)</span><br><span class="line">        self.Bind(wx.EVT_MOTION, self.OnMotion)</span><br><span class="line">        self.Bind(wx.EVT_SIZE, self.OnSize)</span><br><span class="line">        self.Bind(wx.EVT_IDLE, self.OnIdle)</span><br><span class="line">        self.Bind(wx.EVT_PAINT, self.OnPaint)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">InitBuffer</span>(<span class="params">self</span>):</span></span><br><span class="line">        size = self.GetClientSize()       </span><br><span class="line">        self.buffer = wx.Bitmap(size.width, size.height)</span><br><span class="line">        dc = wx.BufferedDC(<span class="literal">None</span>, self.buffer)       </span><br><span class="line">        dc.SetBackground(wx.Brush(self.GetBackgroundColour()))</span><br><span class="line">        dc.Clear()</span><br><span class="line">        self.DrawLines(dc)</span><br><span class="line">        self.reInitBuffer = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GetLinesData</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.lines[:]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">SetLinesData</span>(<span class="params">self, lines</span>):</span></span><br><span class="line">        self.lines = lines[:]</span><br><span class="line">        self.InitBuffer()</span><br><span class="line">        self.Refresh()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnLeftDown</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        self.curLine = [] </span><br><span class="line">        self.pos = event.GetPosition().Get()  </span><br><span class="line">        self.CaptureMouse()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnLeftUp</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.HasCapture():</span><br><span class="line">            self.lines.append((self.color,</span><br><span class="line">                               self.thickness,</span><br><span class="line">                               self.curLine))</span><br><span class="line">            self.curLine = []         </span><br><span class="line">            self.ReleaseMouse()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnMotion</span>(<span class="params">self, event</span>):</span>     </span><br><span class="line">        <span class="keyword">if</span> event.Dragging() <span class="keyword">and</span> event.LeftIsDown():</span><br><span class="line">            dc = wx.BufferedDC(wx.ClientDC(self), self.buffer)</span><br><span class="line">            self.drawMotion(dc, event)</span><br><span class="line">        event.Skip()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">drawMotion</span>(<span class="params">self, dc, event</span>):</span></span><br><span class="line">        dc.SetPen(self.pen)</span><br><span class="line">        newPos = event.GetPosition().Get()</span><br><span class="line">        coords = self.pos + newPos</span><br><span class="line">        self.curLine.append(coords)</span><br><span class="line">        dc.DrawLine(*coords)</span><br><span class="line">        self.pos = newPos</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnSize</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        self.reInitBuffer = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnIdle</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.reInitBuffer:</span><br><span class="line">            self.InitBuffer()</span><br><span class="line">            self.Refresh(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnPaint</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        dc = wx.BufferedPaintDC(self, self.buffer)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">DrawLines</span>(<span class="params">self, dc</span>):</span></span><br><span class="line">        <span class="keyword">for</span> colour, thickness, line <span class="keyword">in</span> self.lines:</span><br><span class="line">            pen = wx.Pen(colour, thickness, wx.SOLID)</span><br><span class="line">            dc.SetPen(pen)</span><br><span class="line">            <span class="keyword">for</span> coords <span class="keyword">in</span> line:</span><br><span class="line">                dc.DrawLine(*coords)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">SetColor</span>(<span class="params">self, color</span>):</span></span><br><span class="line">        self.color = color</span><br><span class="line">        self.pen = wx.Pen(self.color, self.thickness, wx.SOLID)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">SetThickness</span>(<span class="params">self, num</span>):</span></span><br><span class="line">        self.thickness = num</span><br><span class="line">        self.pen = wx.Pen(self.color, self.thickness, wx.SOLID)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SketchFrame</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent</span>):</span></span><br><span class="line">        wx.Frame.__init__(self, parent, -<span class="number">1</span>, <span class="string">&quot;Sketch Frame&quot;</span>,</span><br><span class="line">                size=(<span class="number">800</span>,<span class="number">600</span>))</span><br><span class="line">        self.sketch = SketchWindow(self, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = wx.App()</span><br><span class="line">    frame = SketchFrame(<span class="literal">None</span>)</span><br><span class="line">    frame.Show(<span class="literal">True</span>)</span><br><span class="line">    app.MainLoop()</span><br></pre></td></tr></table></figure>

<p>下面对一些必要的知识点说明一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.pen = wx.Pen(self.color, self.thickness, wx.SOLID)</span><br></pre></td></tr></table></figure>
<p>该行创建了一个wx.Pen实例，从中可以指定画线的颜色、宽度和线型等。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">self.Bind(wx.EVT_LEFT_DOWN, self.OnLeftDown)</span><br><span class="line">self.Bind(wx.EVT_LEFT_UP, self.OnLeftUp)</span><br><span class="line">self.Bind(wx.EVT_MOTION, self.OnMotion)</span><br><span class="line">self.Bind(wx.EVT_SIZE, self.OnSize)</span><br><span class="line">self.Bind(wx.EVT_IDLE, self.OnIdle)</span><br><span class="line">self.Bind(wx.EVT_PAINT, self.OnPaint)</span><br></pre></td></tr></table></figure>
<p>为这个画图板绑定各种鼠标处理事件，包括鼠标左键按下和弹起、鼠标运动、窗口尺寸变化、窗口重绘，以及空闲时候的处理工作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.buffer = wx.Bitmap(size.width, size.height)</span><br><span class="line">dc = wx.BufferedDC(<span class="literal">None</span>, self.buffer)  </span><br></pre></td></tr></table></figure>
<p>通过两步创建缓冲设备上下文：（1）创建一张空白位图作为缓冲区；（2）使用上述缓冲区创建一个缓冲设备上下文。这个缓冲上下文是为了防止线条的重绘使得屏幕闪烁。<br>下面的代码还会创建一个dc，注意这两个dc的不同。这里的dc更像是一个看不见的绘图层，它主要是在窗口尺寸变化、需要重绘的时候调用，是通过读取鼠标事件存储下来的一系列的坐标，然后调用self.DrawLines(dc)一次性绘出很多的线条。而第二个dc是一个即时的绘图dc。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dc.SetBackground(wx.Brush(self.GetBackgroundColour()))</span><br><span class="line">dc.Clear()</span><br></pre></td></tr></table></figure>
<p>创建一个wx.Brush画刷来设置设备上下文的背景，同时使用该背景画刷来清空上下文的内容。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.pos = event.GetPosition().Get()</span><br></pre></td></tr></table></figure>
<p>得到当前鼠标的精确坐标位置，注意这个地方有API变化，书中的是GetPositionTuple()，同时GetPosition()返回的是wx.Point类型的数据，需要调用它的Get()函数将坐标转化为元组格式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.CaptureMouse()</span><br></pre></td></tr></table></figure>
<p>CaptureMouse()方法使得所有的鼠标输入局限在该窗口中，即使有时候拖动鼠标超出该窗口的边界。该动作必须在后面通过调用ReleaseMouse()来取消。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">OnLeftUp</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    <span class="keyword">if</span> self.HasCapture():</span><br><span class="line">        self.lines.append((self.color,</span><br><span class="line">                           self.thickness,</span><br><span class="line">                           self.curLine))</span><br><span class="line">        self.curLine = []         </span><br><span class="line">        self.ReleaseMouse()</span><br></pre></td></tr></table></figure>
<p>定义鼠标左键弹起时的动作，此时是将之前鼠标划过的线条存储到self.lines中，用于窗口重绘时的那个看不见的dc的绘图。同时如上所述，ReleaseMouse()将系统返回到上一个CaptureMouse()之前的状态。wxPython使用一个堆栈来追踪捕获鼠标的窗口，因此ReleaseMouse()和CaptureMouse()的数目必须相等。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> event.Dragging() <span class="keyword">and</span> event.LeftIsDown():</span><br><span class="line">    dc = wx.BufferedDC(wx.ClientDC(self), self.buffer)</span><br><span class="line">    self.drawMotion(dc, event)</span><br></pre></td></tr></table></figure>
<p>画线时，要首先判断鼠标拖动是不是画线的一部分，即既要鼠标左键按下，又要鼠标在拖动；如果这两个条件都满足，则进入画线状态。因为wx.BufferedDC是一种临时创建的设备上下文，因此在画线之前要重新创建一个wx.BufferedDC，这里创建了一个wx.ClientDC作为主上下文，然后重新使用了那张空白位图作为缓冲。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drawMotion</span>(<span class="params">self, dc, event</span>):</span></span><br><span class="line">    dc.SetPen(self.pen)</span><br><span class="line">    newPos = event.GetPosition().Get()</span><br><span class="line">    coords = self.pos + newPos</span><br><span class="line">    self.curLine.append(coords)</span><br><span class="line">    dc.DrawLine(*coords)</span><br><span class="line">    self.pos = newPos</span><br></pre></td></tr></table></figure>
<p>这一步是在设备上下文上进行绘图，注意coords是新旧坐标的综合，两个tuple相加的结果是两者拼接起来，这个语法要注意。同时使用星号变量将coords这个tuple中的四个元素拆分为单个元素传入DrawLine()函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">OnSize</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    self.reInitBuffer = <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>如果窗口的尺寸被改变，则将self.reInitBuffer属性置为True，然后什么都不用做，直到调用下一个空闲事件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">OnIdle</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    <span class="keyword">if</span> self.reInitBuffer:</span><br><span class="line">        self.InitBuffer()</span><br><span class="line">        self.Refresh(<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p>当出现空闲事件后，程序就会趁机响应改变尺寸的动作。这里选择将改变尺寸的动作放在空闲事件处理中，而不是放在它本来的尺寸变化事件处理中，是为了允许多个尺寸改变事件能够快速地连续执行，而不用等待每一个的重绘。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">OnPaint</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    dc = wx.BufferedPaintDC(self, self.buffer)</span><br></pre></td></tr></table></figure>
<p>处理重绘要求是比较简单的，即只需要创建一个缓冲绘图设备上下文，注意因为这里是wx.PaintEvent中，因此，需要使用wx.PaintDC，而不是wx.ClientDC。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DrawLines</span>(<span class="params">self, dc</span>):</span></span><br><span class="line">    <span class="keyword">for</span> colour, thickness, line <span class="keyword">in</span> self.lines:</span><br><span class="line">        pen = wx.Pen(colour, thickness, wx.SOLID)</span><br><span class="line">        dc.SetPen(pen)</span><br><span class="line">       <span class="keyword">for</span> coords <span class="keyword">in</span> line:</span><br><span class="line">            dc.DrawLine(*coords)</span><br></pre></td></tr></table></figure>
<p>在窗口尺寸改变、需要重绘时，使用那个看不见的dc根据之前存储的线条进行绘制。</p>
<p>下面详细分析这三个dc之间的关系，可以在代码中适时地插入一些print函数和SaveFile函数看一下，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">InitBuffer</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;@@@ Initializing buffer&quot;</span>)</span><br><span class="line">    size = self.GetClientSize()       </span><br><span class="line">    self.buffer = wx.Bitmap(size.width, size.height)</span><br><span class="line">    dc = wx.BufferedDC(<span class="literal">None</span>, self.buffer)       </span><br><span class="line">    dc.SetBackground(wx.Brush(self.GetBackgroundColour()))</span><br><span class="line">    dc.Clear()</span><br><span class="line">    self.buffer.SaveFile(<span class="string">&quot;buffer_before_DrawLines.jpg&quot;</span>, wx.BITMAP_TYPE_JPEG)</span><br><span class="line">    self.DrawLines(dc)</span><br><span class="line">    self.buffer.SaveFile(<span class="string">&quot;buffer_after_DrawLines.jpg&quot;</span>, wx.BITMAP_TYPE_JPEG)</span><br><span class="line">    self.reInitBuffer = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">OnMotion</span>(<span class="params">self, event</span>):</span>     </span><br><span class="line">    <span class="keyword">if</span> event.Dragging() <span class="keyword">and</span> event.LeftIsDown():</span><br><span class="line">        dc = wx.BufferedDC(wx.ClientDC(self), self.buffer)</span><br><span class="line">        self.drawMotion(dc, event)</span><br><span class="line">        self.buffer.SaveFile(<span class="string">&quot;buffer_in_OnMotion.jpg&quot;</span>, wx.BITMAP_TYPE_JPEG)</span><br><span class="line">    event.Skip()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">OnPaint</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;!!! On painting&quot;</span>)</span><br><span class="line">    self.buffer.SaveFile(<span class="string">&quot;buffer_in_OnPaint.jpg&quot;</span>, wx.BITMAP_TYPE_JPEG)</span><br><span class="line">    dc = wx.BufferedPaintDC(self, self.buffer)</span><br></pre></td></tr></table></figure>
<p>详细机理为：当初始化时，首先创建了一个全黑色的wx.Bitmap位图self.buffer，然后将它传给了第一个dc，因为这个dc会设置背景为白色，所以其实这时将self.buffer存成图像，即buffer_before_DrawLines.jpg是一张白色图像，即非常重要的知识点就是dc会改变self.buffer。<br>在初始化时，InitBuffer()和OnPaint()函数都会调用，那么此时buffer_before_DrawLines.jpg、buffer_after_DrawLines.jpg和buffer_in_OnPaint.jpg都是纯白色图像，而因为鼠标还没有开始绘图，则OnMotion()不会被调用，那么buffer_in_OnMotion.jpg也不会调用。<br>当鼠标开始绘图时，buffer_in_OnMotion.jpg就会生成，且会将当前有线条的图像存储下来，即self.buffer也会被改变。<br>如果此时拖动窗口边界，但注意不要松开鼠标，则会发现OnPaint()函数一直执行，但InitBuffer()却没有执行，这就是因为之前将InitBuffer()放在了空闲事件中的结果，如果将它放在wx.EVT_SIZE中，那么也可以，但明显在拖动边界时你会感觉到很卡的感觉。<br>如果拖动了窗口边界，且松开鼠标后，InitBuffer()就会执行，此时可以发现，buffer_before_DrawLines.jpg因为存储的是初始化后的self.buffer，所以它仍然是白色的，而buffer_after_DrawLines.jpg则会存储有线条且当前窗口形状的图像，注意它是当前窗口形状的图像，而buffer_in_OnMotion.jpg是之前窗口的图像，除非再次用鼠标绘图。<br>如果不关联wx.EVT_PAINT事件，此时拖动窗口边界，则会发现此时会出现“擦掉”图像的现象，但下一次鼠标再次绘制时，之前的线条又会重现，这会非常让人困扰，所以该事件是非常必要的。</p>
<p>那么总结一下：<br>self.buffer是穿插在这几个dc间的纽带，每个dc都可以对它进行修改。第一个BufferedDC是为了在窗口尺寸变化时存储之前绘制的线条，第二个BufferedDC是实际在鼠标交互时的绘图层，它让用户能实时看到绘制了什么，然后在窗口重绘时它就销毁，将坐标信息传给第一个DC，第三个BufferedPaintDC是为了取出缓冲self.buffer用来刷新窗口，让前后图像具有一致性。</p>
<h1 id="绘制雷达图"><a href="#绘制雷达图" class="headerlink" title="绘制雷达图"></a>绘制雷达图</h1><p>原始代码见：<br><a target="_blank" rel="noopener" href="https://github.com/freephys/wxPython-In-Action/blob/master/Chapter-12/radargraph.py">wxPython-In-Action/Chapter-12/radargraph.py</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RadarGraph</span>(<span class="params">wx.Window</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    A simple radar graph that plots a collection of values in the</span></span><br><span class="line"><span class="string">    range of 0-100 onto a polar coordinate system designed to easily</span></span><br><span class="line"><span class="string">    show outliers, etc.  You might use this kind of graph to monitor</span></span><br><span class="line"><span class="string">    some sort of resource allocation metrics, and a quick glance at</span></span><br><span class="line"><span class="string">    the graph can tell you when conditions are good (within some</span></span><br><span class="line"><span class="string">    accepted tolerance level) or approaching critical levels (total</span></span><br><span class="line"><span class="string">    resource consumption).</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent, title, labels</span>):</span></span><br><span class="line">        wx.Window.__init__(self, parent)</span><br><span class="line">        self.title = title</span><br><span class="line">        self.labels = labels</span><br><span class="line">        self.data = [<span class="number">0.0</span>] * <span class="built_in">len</span>(labels)</span><br><span class="line">        self.titleFont = wx.Font(<span class="number">14</span>, wx.SWISS, wx.NORMAL, wx.BOLD)</span><br><span class="line">        self.labelFont = wx.Font(<span class="number">10</span>, wx.SWISS, wx.NORMAL, wx.NORMAL)</span><br><span class="line"></span><br><span class="line">        self.InitBuffer()</span><br><span class="line"></span><br><span class="line">        self.Bind(wx.EVT_SIZE, self.OnSize)</span><br><span class="line">        self.Bind(wx.EVT_PAINT, self.OnPaint)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnSize</span>(<span class="params">self, evt</span>):</span></span><br><span class="line">        <span class="comment"># When the window size changes we need a new buffer.</span></span><br><span class="line">        self.InitBuffer()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnPaint</span>(<span class="params">self, evt</span>):</span></span><br><span class="line">        <span class="comment"># This automatically Blits self.buffer to a wx.PaintDC when</span></span><br><span class="line">        <span class="comment"># the dc is destroyed, and so nothing else needs done.</span></span><br><span class="line">        dc = wx.BufferedPaintDC(self, self.buffer)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">InitBuffer</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># Create the buffer bitmap to be the same size as the window,</span></span><br><span class="line">        <span class="comment"># then draw our graph to it.  Since we use wx.BufferedDC</span></span><br><span class="line">        <span class="comment"># whatever is drawn to the buffer is also drawn to the window.</span></span><br><span class="line">        w, h = self.GetClientSize()       </span><br><span class="line">        self.buffer = wx.Bitmap(w, h)</span><br><span class="line">        dc = wx.BufferedDC(wx.ClientDC(self), self.buffer)</span><br><span class="line">        self.DrawGraph(dc)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GetData</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">SetData</span>(<span class="params">self, newData</span>):</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(newData) == <span class="built_in">len</span>(self.data)</span><br><span class="line">        self.data = newData[:]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># The data has changed, so update the buffer and the window</span></span><br><span class="line">        dc = wx.BufferedDC(wx.ClientDC(self), self.buffer)</span><br><span class="line">        self.DrawGraph(dc)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">PolarToCartesian</span>(<span class="params">self, radius, angle, cx, cy</span>):</span></span><br><span class="line">        x = radius * math.cos(math.radians(angle))</span><br><span class="line">        y = radius * math.sin(math.radians(angle))</span><br><span class="line">        <span class="keyword">return</span> (cx+x, cy-y)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">DrawGraph</span>(<span class="params">self, dc</span>):</span></span><br><span class="line">        spacer = <span class="number">10</span></span><br><span class="line">        scaledmax = <span class="number">150.0</span></span><br><span class="line"></span><br><span class="line">        dc.SetBackground(wx.Brush(self.GetBackgroundColour()))</span><br><span class="line">        dc.Clear()</span><br><span class="line">        dw, dh = dc.GetSize()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Find out where to draw the title and do it</span></span><br><span class="line">        dc.SetFont(self.titleFont)</span><br><span class="line">        tw, th = dc.GetTextExtent(self.title)</span><br><span class="line">        dc.DrawText(self.title, (dw-tw)/<span class="number">2</span>, spacer)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># find the center of the space below the title</span></span><br><span class="line">        th = th + <span class="number">2</span>*spacer</span><br><span class="line">        cx = dw/<span class="number">2</span></span><br><span class="line">        cy = (dh-th)/<span class="number">2</span> + th</span><br><span class="line"></span><br><span class="line">        <span class="comment"># calculate a scale factor to use for drawing the graph based</span></span><br><span class="line">        <span class="comment"># on the minimum available width or height</span></span><br><span class="line">        mindim = <span class="built_in">min</span>(cx, (dh-th)/<span class="number">2</span>)</span><br><span class="line">        scale = mindim/scaledmax</span><br><span class="line"></span><br><span class="line">        <span class="comment"># draw the graph axis and &quot;bulls-eye&quot; with rings at scaled 25,</span></span><br><span class="line">        <span class="comment"># 50, 75 and 100 positions</span></span><br><span class="line">        dc.SetPen(wx.Pen(<span class="string">&quot;black&quot;</span>, <span class="number">1</span>))</span><br><span class="line">        dc.SetBrush(wx.TRANSPARENT_BRUSH)</span><br><span class="line">        dc.DrawCircle(cx,cy, <span class="number">25</span>*scale)</span><br><span class="line">        dc.DrawCircle(cx,cy, <span class="number">50</span>*scale)</span><br><span class="line">        dc.DrawCircle(cx,cy, <span class="number">75</span>*scale)</span><br><span class="line">        dc.DrawCircle(cx,cy, <span class="number">100</span>*scale)</span><br><span class="line"></span><br><span class="line">        dc.SetPen(wx.Pen(<span class="string">&quot;black&quot;</span>, <span class="number">2</span>))</span><br><span class="line">        dc.DrawLine(cx-<span class="number">110</span>*scale, cy, cx+<span class="number">110</span>*scale, cy)</span><br><span class="line">        dc.DrawLine(cx, cy-<span class="number">110</span>*scale, cx, cy+<span class="number">110</span>*scale)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># Now find the coordinates for each data point, draw the</span></span><br><span class="line">        <span class="comment"># labels, and find the max data point</span></span><br><span class="line">        dc.SetFont(self.labelFont)</span><br><span class="line">        maxval = <span class="number">0</span></span><br><span class="line">        angle = <span class="number">0</span></span><br><span class="line">        polypoints = []</span><br><span class="line">        <span class="keyword">for</span> i, label <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.labels):</span><br><span class="line">            val = self.data[i]</span><br><span class="line">            point = self.PolarToCartesian(val*scale, angle, cx, cy)</span><br><span class="line">            polypoints.append(point)</span><br><span class="line">            x, y = self.PolarToCartesian(<span class="number">125</span>*scale, angle, cx,cy)</span><br><span class="line">            dc.DrawText(label, x, y)</span><br><span class="line">            <span class="keyword">if</span> val &gt; maxval:</span><br><span class="line">                maxval = val</span><br><span class="line">            angle = angle + <span class="number">360</span>/<span class="built_in">len</span>(self.labels)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Set the brush color based on the max value (green is good,</span></span><br><span class="line">        <span class="comment"># red is bad)</span></span><br><span class="line">        c = <span class="string">&quot;forest green&quot;</span></span><br><span class="line">        <span class="keyword">if</span> maxval &gt; <span class="number">70</span>:</span><br><span class="line">            c = <span class="string">&quot;yellow&quot;</span></span><br><span class="line">        <span class="keyword">if</span> maxval &gt; <span class="number">95</span>:</span><br><span class="line">            c = <span class="string">&quot;red&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Finally, draw the plot data as a filled polygon</span></span><br><span class="line">        dc.SetBrush(wx.Brush(c))</span><br><span class="line">        dc.SetPen(wx.Pen(<span class="string">&quot;navy&quot;</span>, <span class="number">3</span>))</span><br><span class="line">        dc.DrawPolygon(polypoints)</span><br><span class="line">       </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestFrame</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        wx.Frame.__init__(self, <span class="literal">None</span>, title=<span class="string">&quot;Double Buffered Drawing&quot;</span>,</span><br><span class="line">                          size=(<span class="number">480</span>,<span class="number">480</span>))</span><br><span class="line">        self.plot = RadarGraph(self, <span class="string">&quot;Sample &#x27;Radar&#x27; Plot&quot;</span>,</span><br><span class="line">                          [<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;D&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="string">&quot;F&quot;</span>, <span class="string">&quot;G&quot;</span>, <span class="string">&quot;H&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Set some random initial data values</span></span><br><span class="line">        data = []</span><br><span class="line">        <span class="keyword">for</span> d <span class="keyword">in</span> self.plot.GetData():</span><br><span class="line">            data.append(random.randint(<span class="number">0</span>, <span class="number">75</span>))</span><br><span class="line">        self.plot.SetData(data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Create a timer to update the data values</span></span><br><span class="line">        self.Bind(wx.EVT_TIMER, self.OnTimeout)</span><br><span class="line">        self.timer = wx.Timer(self)</span><br><span class="line">        self.timer.Start(<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnTimeout</span>(<span class="params">self, evt</span>):</span></span><br><span class="line">        <span class="comment"># simulate the positive or negative growth of each data value</span></span><br><span class="line">        data = []</span><br><span class="line">        <span class="keyword">for</span> d <span class="keyword">in</span> self.plot.GetData():</span><br><span class="line">            val = d + random.uniform(-<span class="number">5</span>, <span class="number">5</span>)</span><br><span class="line">            <span class="keyword">if</span> val &lt; <span class="number">0</span>:</span><br><span class="line">                val = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> val &gt; <span class="number">110</span>:</span><br><span class="line">                val = <span class="number">110</span></span><br><span class="line">            data.append(val)</span><br><span class="line">        self.plot.SetData(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = wx.App()</span><br><span class="line">frm = TestFrame()</span><br><span class="line">frm.Show()</span><br><span class="line">app.MainLoop()</span><br></pre></td></tr></table></figure>
<p>该程序与上面的画图板原理相同，需要注意的是它将InitBuffer()放进了EVT_SIZE事件处理函数中，这样每次窗口变化时就会得到一个新的缓冲，雷达图的绘制也会随着窗口的变化实时改变。<br>该例子用到了更多的dc的功能，如DrawCircle、DrawText、DrawPolygon等。</p>
<h1 id="绘制位图"><a href="#绘制位图" class="headerlink" title="绘制位图"></a>绘制位图</h1><p>原始代码见：<br><a target="_blank" rel="noopener" href="https://github.com/freephys/wxPython-In-Action/blob/master/Chapter-12/draw_image.py">wxPython-In-Action/Chapter-12/draw_image.py</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This one shows how to draw images on a DC.</span></span><br><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">random.seed()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomImagePlacementWindow</span>(<span class="params">wx.Window</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent, image</span>):</span></span><br><span class="line">        wx.Window.__init__(self, parent)</span><br><span class="line">        self.photo = image.ConvertToBitmap()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># choose some random positions to draw the image at:</span></span><br><span class="line">        self.positions = [(<span class="number">10</span>,<span class="number">10</span>)]</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">            x = random.randint(<span class="number">0</span>, <span class="number">1000</span>)</span><br><span class="line">            y = random.randint(<span class="number">0</span>, <span class="number">1000</span>)</span><br><span class="line">            self.positions.append( (x,y) )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Bind the Paint event</span></span><br><span class="line">        self.Bind(wx.EVT_PAINT, self.OnPaint)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnPaint</span>(<span class="params">self, evt</span>):</span></span><br><span class="line">        <span class="comment"># create and clear the DC</span></span><br><span class="line">        dc = wx.PaintDC(self)</span><br><span class="line">        brush = wx.Brush(<span class="string">&quot;sky blue&quot;</span>)</span><br><span class="line">        dc.SetBackground(brush)</span><br><span class="line">        dc.Clear()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># draw the image in random locations</span></span><br><span class="line">        <span class="keyword">for</span> x,y <span class="keyword">in</span> self.positions:</span><br><span class="line">            dc.DrawBitmap(self.photo, x, y, <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestFrame</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        wx.Frame.__init__(self, <span class="literal">None</span>, title=<span class="string">&quot;Loading Images&quot;</span>,</span><br><span class="line">                          size=(<span class="number">640</span>,<span class="number">480</span>))</span><br><span class="line">        img = wx.Image(<span class="string">&quot;masked-portrait.png&quot;</span>)</span><br><span class="line">        win = RandomImagePlacementWindow(self, img)</span><br><span class="line">       </span><br><span class="line">app = wx.App()</span><br><span class="line">frm = TestFrame()</span><br><span class="line">frm.Show()</span><br><span class="line">app.MainLoop()</span><br></pre></td></tr></table></figure>
<p>主要函数就是DrawBitmap()，如果是绘制图标，则用DrawIcon()。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/10/15/python-asterisk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/15/python-asterisk/" class="post-title-link" itemprop="url">(转载)Python星号变量的特殊用法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-15 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-15T00:00:00+08:00">2019-10-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/10/15/python-asterisk/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/15/python-asterisk/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>看到一篇非常好的讲解Python星号变量的用法，特转载之。<br>来自:晴刃(QingSword.COM)<br>原文连接:<a target="_blank" rel="noopener" href="http://www.qingsword.com/qing/python-12.html">http://www.qingsword.com/qing/python-12.html</a></p>
<h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>在Python中，星号除了用于乘法数值运算和幂运算外，还有一种特殊的用法”在变量前添加单个星号或两个星号”，实现多参数的传入或变量的拆解，本文将详细介绍”星号参数”的用法。</p>
<h1 id="0×1-什么是星号变量"><a href="#0×1-什么是星号变量" class="headerlink" title="0×1.什么是星号变量"></a>0×1.什么是星号变量</h1><p>最初，星号变量是用在函数的参数传递上的，在下面的实例中，单个星号代表这个位置接收任意多个非关键字参数，在函数的*b位置上将其转化成元组，而双星号代表这个位置接收任意多个关键字参数，在**b位置上将其转化成字典：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#--------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">one</span>(<span class="params">a,*b</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;a是一个普通传入参数，*b是一个非关键字星号参数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(b)</span><br><span class="line">one(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)</span><br><span class="line"><span class="comment">#--------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">two</span>(<span class="params">a=<span class="number">1</span>,**b</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;a是一个普通关键字参数，**b是一个关键字双星号参数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(b)</span><br><span class="line">two(a=<span class="number">1</span>,b=<span class="number">2</span>,c=<span class="number">3</span>,d=<span class="number">4</span>,e=<span class="number">5</span>,f=<span class="number">6</span>)</span><br><span class="line"><span class="comment">#程序输出</span></span><br><span class="line">(<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">&#123;<span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;c&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;e&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;f&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">4</span>&#125;</span><br><span class="line"><span class="comment">#从输出中可以看到，第一个函数中，*b的位置可以传入任意多没有关键字的参数，*b会将这些传入参数转化成一个元组，下面的调用</span></span><br><span class="line">one(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)</span><br><span class="line"><span class="comment">#传入one(a,*b)后，等价与</span></span><br><span class="line">one(<span class="number">1</span>,(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#第二个函数中，**b的位置可以接收任意多个关键字参数，下面的调用</span></span><br><span class="line">two(a=<span class="number">1</span>,b=<span class="number">2</span>,c=<span class="number">3</span>,d=<span class="number">4</span>,e=<span class="number">5</span>,f=<span class="number">6</span>)</span><br><span class="line"><span class="comment">#传入one(a,*b)后，等价与</span></span><br><span class="line">two(a=<span class="number">1</span>,&#123;<span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;c&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;e&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;f&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;d&#x27;</span>: <span class="number">4</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>在了解了单星号和双星号的基本使用方法后，下面来看看他们的扩展用法。</p>
<h1 id="0×2-单星号变量实例"><a href="#0×2-单星号变量实例" class="headerlink" title="0×2.单星号变量实例"></a>0×2.单星号变量实例</h1><p>单星号变量不仅仅能够用在函数的参数传递中，实际上对一个普通变量使用单星号前缀，能够将这个变量拆分成单个元素，请看下面的实例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#--------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">one</span>(<span class="params">*x</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;输出传入的第一个参数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(x[<span class="number">0</span>])</span><br><span class="line"><span class="comment">#--------</span></span><br><span class="line">lst=[<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>]</span><br><span class="line">stri=<span class="string">&quot;www.qingsword.com&quot;</span></span><br><span class="line">one(stri,lst)</span><br><span class="line">one(*lst)</span><br><span class="line">one(*stri)</span><br><span class="line"><span class="comment">#程序输出</span></span><br><span class="line">www.qingsword.com</span><br><span class="line">a</span><br><span class="line">w</span><br><span class="line"><span class="comment">#第一次调用one(stri,lst)，代入one(*x)后等价与</span></span><br><span class="line">one(([<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>],<span class="string">&quot;www.qingsword.com&quot;</span>))</span><br><span class="line"><span class="comment">#第二次调用one(*lst)，代入one(*x)后等价与</span></span><br><span class="line">one((<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>))</span><br><span class="line"><span class="comment">#第三次调用one(*stri)，代入one(*x)后等价与</span></span><br><span class="line">one((<span class="string">&quot;w&quot;</span>,<span class="string">&quot;w&quot;</span>,<span class="string">&quot;w&quot;</span>,<span class="string">&quot;.&quot;</span>,<span class="string">&quot;q&quot;</span>,<span class="string">&quot;i&quot;</span>,<span class="string">&quot;n&quot;</span>,<span class="string">&quot;g&quot;</span>,<span class="string">&quot;s&quot;</span>,<span class="string">&quot;w&quot;</span>,<span class="string">&quot;o&quot;</span>,<span class="string">&quot;r&quot;</span>,<span class="string">&quot;d&quot;</span>,<span class="string">&quot;.&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;o&quot;</span>,<span class="string">&quot;m&quot;</span>))</span><br><span class="line"><span class="comment">#如果在变量前面使用单星号，实际上是对变量的一次拆解操作，将变量中单独的元素拆解出来，然后依次传入one()函数，而传入one()函数后，one()函数会将这些传入的单个元素保存成一个元组，这就是为什么我们 print(x[0])能够提取第一个元素的原因</span></span><br></pre></td></tr></table></figure>
<p>为了验证这一点，我们修改一下one()函数，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#--------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">one</span>(<span class="params">*x</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;一个错误的实例，尝试修改传入的第一个参数值，引发异常&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(x[<span class="number">0</span>])</span><br><span class="line">    x[<span class="number">0</span>]=<span class="string">&quot;qingsword&quot;</span></span><br><span class="line">lst=[<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>]</span><br><span class="line">one(*lst)</span><br><span class="line"><span class="comment">#我们知道列表是可以更改的，我们将列表拆分后传入one()函数，尝试在函数内部更改第一个元素的值，结果触发了&quot;TypeError&quot;异常，大家可以自己尝试下，出现这种结果的原因上面已经说明，不论传入的参数的原始类型是什么，one(*x)在*x的位置接收这些传入的参数后，都会将其保存成&quot;元组&quot;，而元组是不能改变的</span></span><br></pre></td></tr></table></figure>
<p>再来看几个实例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#--------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">one</span>(<span class="params">*x</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;打印出传入参数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> x:</span><br><span class="line">        <span class="built_in">print</span>(a)</span><br><span class="line">lst=[<span class="string">&quot;abc&quot;</span>,<span class="number">123</span>,<span class="string">&quot;www.qingsword.com&quot;</span>]</span><br><span class="line">stri=<span class="string">&quot;abcd&quot;</span></span><br><span class="line">dect=&#123;<span class="number">1</span>:<span class="string">&quot;one&quot;</span>,<span class="number">2</span>:<span class="string">&quot;two&quot;</span>,<span class="number">3</span>:<span class="string">&quot;three&quot;</span>&#125;</span><br><span class="line">one(*lst)</span><br><span class="line">one(*stri)</span><br><span class="line">one(*dect)</span><br><span class="line"><span class="comment">#程序输出</span></span><br><span class="line">abc</span><br><span class="line"><span class="number">123</span></span><br><span class="line">www.qingsword.com</span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br><span class="line">d</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="comment">#前面两次调用都很好理解，最后我们传入了一个字典元素，发现仅输出了字典元素的键，并没有包含值，实际上，单星号是无法读取到字典中的值的，永远只会读取到字典中的键，如果想读取到字典中的值，需要使用双星号</span></span><br></pre></td></tr></table></figure>
<h1 id="0×3-双星号变量实例"><a href="#0×3-双星号变量实例" class="headerlink" title="0×3.双星号变量实例"></a>0×3.双星号变量实例</h1><p>在第2小节的最后，我们使用单星号拆分了一个字典传递给函数，却只能得到字典的键，下面演示如何使用双星号来获得字典的值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#--------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">one</span>(<span class="params">**x</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;将传入的关键字参数的值保存成元组输出&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line">    b=()</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> x.values():</span><br><span class="line">        b+=(a,)</span><br><span class="line">    <span class="built_in">print</span>(b)</span><br><span class="line">dect=&#123;<span class="string">&quot;one&quot;</span>:<span class="number">1</span>,<span class="string">&quot;two&quot;</span>:<span class="number">2</span>,<span class="string">&quot;three&quot;</span>:<span class="number">3</span>&#125;</span><br><span class="line">one(**dect)</span><br><span class="line"><span class="comment">#程序输出</span></span><br><span class="line">&#123;<span class="string">&#x27;three&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;one&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;two&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line">(<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="comment">#对一个字典使用双星号前缀，就相当于将其拆分成关键字参数的形式，**dect相当于将字典拆分成下面这种样子</span></span><br><span class="line">one=<span class="number">1</span>,two=<span class="number">2</span>,three=<span class="number">3</span></span><br><span class="line"><span class="comment">#将上面这些关键字参数传入one(**x)，就等价与（还记得前面说的，双星号将接收到的所有关键字参数都保存成一个字典吧）</span></span><br><span class="line">one(&#123;<span class="string">&quot;one&quot;</span>:<span class="number">1</span>,<span class="string">&quot;two&quot;</span>:<span class="number">2</span>,<span class="string">&quot;three&quot;</span>:<span class="number">3</span>&#125;)</span><br><span class="line"><span class="comment">#既然是字典，那么字典中的所有方法都能使用，使用for循环遍历这个字典的值，添加到一个元组中，最后打印出这个元组</span></span><br></pre></td></tr></table></figure>
<p>Ps：注意，使用这种方法将字典传入函数的时候，字典的键的命名要符合python变量的命名规则，通过上面的分析也不难看出，双星号会将字典首先转换成关键字参数的形式，就相当于使用字典中的键作为变量名，如果键不符合变量命名规则，则会抛出一个”TypeError”异常，大家可以尝试着颠倒一下上面字典中的键和值，使用数字作为键，看看会出现什么问题。</p>
<p>在一个函数的接收参数中，同时出现”非关键字参数（位置参数）”和”关键字参数”时，可以使用一个单星号来分隔这两种参数，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#--------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mix</span>(<span class="params">a,b,*,x,y</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;位置参数与关键字参数混合&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> a,b,x,y</span><br><span class="line"><span class="comment">#星号前面的a和b是位置参数，星号后面的x和y是关键字参数，调用mix()函数并传入参数时，关键字参数一定要使用&quot;变量名=值&quot;的形式传入数据，如果同位置参数一样传入数据，就会引发一个TypeError异常</span></span><br><span class="line"><span class="built_in">print</span>(mix(<span class="number">1</span>,<span class="number">2</span>,x=<span class="number">3</span>,y=<span class="number">4</span>))</span><br><span class="line"><span class="comment">#程序输出</span></span><br><span class="line">(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="comment">#在上面的mix函数中，如果位置参数与关键字参数之间已经存在了一个单星号位置参数，那么，这个参数后面的就都是关键字参数，也不需要再使用星号来分隔他们了，例如</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#--------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mix</span>(<span class="params">a,b,*c,x,y</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;位置参数与关键字参数混合&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> a,b,c,x,y</span><br><span class="line"><span class="comment">#在*c的位置可以输入任意多个位置参数值</span></span><br><span class="line"><span class="built_in">print</span>(mix(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,x=<span class="number">6</span>,y=<span class="number">7</span>))</span><br><span class="line"><span class="comment">#程序输出</span></span><br><span class="line">(<span class="number">1</span>, <span class="number">2</span>, (<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>), <span class="number">6</span>, <span class="number">7</span>)</span><br></pre></td></tr></table></figure>
<p>如果我们要在一个函数中包含多种参数的组合，必须遵守这样的顺序：位置参数（必选参数），默认参数，单星号参数或星号分隔符，关键字参数，双星号参数；请看下面的实例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#--------</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mix</span>(<span class="params">a,b=<span class="number">0</span>,*c,x,**y</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;位置参数与关键字参数混合&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> a,b,c,x,y</span><br><span class="line"><span class="built_in">print</span>(mix(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,x=<span class="number">6</span>,y=<span class="number">7</span>,z=<span class="number">8</span>))</span><br><span class="line"><span class="comment">#程序输出</span></span><br><span class="line">(<span class="number">1</span>, <span class="number">2</span>, (<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>), <span class="number">6</span>, &#123;<span class="string">&#x27;y&#x27;</span>: <span class="number">7</span>, <span class="string">&#x27;z&#x27;</span>: <span class="number">8</span>&#125;)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/10/13/python-import/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/13/python-import/" class="post-title-link" itemprop="url">Python3的Import理解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-13 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-13T00:00:00+08:00">2019-10-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/10/13/python-import/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/13/python-import/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考文献：<br><a target="_blank" rel="noopener" href="https://loggerhead.me/posts/python-de-import-ji-zhi.html">Python 的 import 机制</a><br><a target="_blank" rel="noopener" href="http://blog.konghy.cn/2016/07/21/python-import-relative-and-absolute/">Python 相对导入与绝对导入</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/junbujianwpl/article/details/79324814">python: <strong>main</strong> is not a package</a></p>
<h1 id="Python-import的搜索路径"><a href="#Python-import的搜索路径" class="headerlink" title="Python import的搜索路径"></a>Python import的搜索路径</h1><p>import的搜索路径为：</p>
<ol>
<li>搜索「内置模块」（built-in module）</li>
<li>搜索 sys.path 中的路径</li>
</ol>
<p>而sys.path在初始化时，又会按照顺序添加以下路径：</p>
<ol>
<li>foo.py 所在目录（如果是软链接，那么是真正的 foo.py 所在目录）或当前目录；</li>
<li>环境变量 PYTHONPATH中列出的目录（类似环境变量 PATH，由用户定义，默认为空）；</li>
<li>site 模块被 import 时添加的路径1（site 会在运行时被自动 import）。</li>
</ol>
<p>import site 所添加的路径一般是 XXX/site-packages。如果懒得记 sys.path 的初始化过程，可以简单的认为 import 的查找顺序是：</p>
<ol>
<li>内置模块</li>
<li>.py 文件所在目录</li>
<li>pip 或 easy_install 安装的包</li>
</ol>
<h1 id="绝对导入和相对导入"><a href="#绝对导入和相对导入" class="headerlink" title="绝对导入和相对导入"></a>绝对导入和相对导入</h1><p>绝对导入和相对导入的关系可以类比绝对路径和相对路径。<br>绝对导入的格式为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> A.B</span><br><span class="line">或</span><br><span class="line"><span class="keyword">from</span> A <span class="keyword">import</span> B</span><br></pre></td></tr></table></figure>
<p>相对导入格式为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> B</span><br><span class="line">或</span><br><span class="line"><span class="keyword">from</span> ..A <span class="keyword">import</span> B</span><br></pre></td></tr></table></figure>
<p>其中，点号.代表当前模块，..代表上层模块，…代表上上层模块，依次类推。</p>
<h1 id="模块的执行方式"><a href="#模块的执行方式" class="headerlink" title="模块的执行方式"></a>模块的执行方式</h1><p>模块的执行可以有两种方式：直接执行和以模块执行，即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python example&#x2F;foo.py</span><br><span class="line">或</span><br><span class="line">python -m example.foo</span><br></pre></td></tr></table></figure>
<p>注意，以模块执行时，一定要有包的概念，即example一定是个包，而foo是这个包下的模块，这样才能顺利执行。</p>
<h1 id="包和模块"><a href="#包和模块" class="headerlink" title="包和模块"></a>包和模块</h1><p>模块: 一个 .py 文件就是一个模块（module）<br>包: <strong>init</strong>.py 文件所在目录就是包（package）</p>
<h1 id="各种情形测试"><a href="#各种情形测试" class="headerlink" title="各种情形测试"></a>各种情形测试</h1><h2 id="模块直接导入"><a href="#模块直接导入" class="headerlink" title="模块直接导入"></a>模块直接导入</h2><p>即模块所在的目录都不是一个包结构，各个模块都是独立的，比如以下的目录结构：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">D:\LEARN\IMPORT_TEST\TEST1</span><br><span class="line">├─pack1</span><br><span class="line">│      modu1.py</span><br><span class="line">└─pack2</span><br><span class="line">       modu2.py</span><br></pre></td></tr></table></figure>
<p>modu1.py中的内容为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.append(<span class="string">&quot;D:\\learn\\import_test\\TEST1\\pack2&quot;</span>)</span><br><span class="line"><span class="keyword">from</span> modu2 <span class="keyword">import</span> hello2</span><br><span class="line">hello2()</span><br></pre></td></tr></table></figure>
<p>modu2.py中的内容为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello2</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hello, I am module 2&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>注意在modu1中一定加上sys.path.append那部分内容，即根据上面的描述，一定要让modu1能找到modu2才行，否则就会出现如下错误：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModuleNotFoundError: No module named <span class="string">&#x27;modu2&#x27;</span></span><br></pre></td></tr></table></figure>
<p>此时进入pack1目录下，以直接执行或模块执行的方式都可以顺利输出。</p>
<h2 id="包外导入"><a href="#包外导入" class="headerlink" title="包外导入"></a>包外导入</h2><p>将上面两个模块所在的目录都变为包结构，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">D:\LEARN\IMPORT_TEST\TEST2</span><br><span class="line">├─pack1</span><br><span class="line">│      modu1.py</span><br><span class="line">│      __init__.py</span><br><span class="line">└─pack2</span><br><span class="line">       modu2.py</span><br><span class="line">       __init__.py</span><br></pre></td></tr></table></figure>
<p>此时也能顺利执行，同时比上面非包结构的多出来一条执行方式，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pack1.modu1</span><br></pre></td></tr></table></figure>
<p>即以包名+模块名的方式执行。</p>
<p>上面两种情形，即模块与模块、包与包都是相互独立的关系，也就没有相对导入的意义。<br>如果是在一个包内的不同模块的导入，那么最自然的就是使用相对导入。</p>
<h2 id="包内相对导入"><a href="#包内相对导入" class="headerlink" title="包内相对导入"></a>包内相对导入</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">D:\LEARN\IMPORT_TEST\Test3</span><br><span class="line">│  __init__.py</span><br><span class="line">│</span><br><span class="line">├─pack1</span><br><span class="line">│      modu1.py</span><br><span class="line">│      __init__.py</span><br><span class="line">│</span><br><span class="line">└─pack2</span><br><span class="line">       modu2.py</span><br><span class="line">       __init__.py</span><br></pre></td></tr></table></figure>
<p>此时modu1.py中的内容为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ..pack2.modu2 <span class="keyword">import</span> hello2</span><br><span class="line">hello2()</span><br></pre></td></tr></table></figure>
<p>即将sys.path.append去掉，因为是在一个包内相互引用，此时这样写没有意义。<br>此时正确运行的方式是进入Test3上一层的文件夹，然后：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m Test3.pack1.modu1</span><br></pre></td></tr></table></figure>
<p>即明确地告诉解释器模块的层次结构。<br>而如果采用直接运行的方式，比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python Test3\pack1\modu1.py</span><br></pre></td></tr></table></figure>
<p>就会报如下错误：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ValueError: attempted relative <span class="keyword">import</span> beyond top-level package</span><br></pre></td></tr></table></figure>
<p>这是因为，相对导入使用模块的__name__（这里的name和下面的main都是有两个下划线的，但是网页显示不出来。。）属性来决定模块在包结构中的位置。当__name__属性不包含包信息（i.e. 没有用’.’表示的层次结构，比如’<strong>main</strong>‘），则相对导入将模块解析为顶层模块，而不管模块在文件系统中的实际位置。这里模块被直接运行，则它自己为顶层模块，不存在层次结构，所以找不到其他的相对路径。</p>
<p>因此，直接运行带有相对导入的模块是不行的，需要通过模块运行的方式，将包结构明确告诉它才行。</p>
<p>这个原理也适用于下面这种错误，比如将modu2移动到pack1中，即与modu1在同一个目录下，然后将modu1的内容改为这样的相对引用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .modu2 <span class="keyword">import</span> hello2</span><br><span class="line">hello2()</span><br></pre></td></tr></table></figure>
<p>此时使用模块执行的方式没有问题，如果还是想尝试直接运行，那么就会出现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModuleNotFoundError: No module named <span class="string">&#x27;__main__.modu2&#x27;</span>; <span class="string">&#x27;__main__&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> a package</span><br></pre></td></tr></table></figure>
<p>原因就是此时没有包结构，__main__也不是个包。</p>
<p>那么解决方法就是或者使用模块运行的方式运行，或者将它改成下面的绝对导入的方式就可以直接运行。</p>
<h2 id="包内绝对导入"><a href="#包内绝对导入" class="headerlink" title="包内绝对导入"></a>包内绝对导入</h2><p>那么，如果将modu1.py中的内容改为绝对导入，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Test3.pack2.modu2 <span class="keyword">import</span> hello2</span><br><span class="line">hello2()</span><br></pre></td></tr></table></figure>
<p>此时正确运行方式也是进入Test3上一层文件夹，然后使用模块执行的方式运行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m Test3.pack1.modu1</span><br></pre></td></tr></table></figure>

<p>如果此时采用直接运行的方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python Test3\pack1\modu1.py</span><br></pre></td></tr></table></figure>
<p>那么就会报错：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModuleNotFoundError: No module named <span class="string">&#x27;Test3&#x27;</span></span><br></pre></td></tr></table></figure>
<p>这主要是因为Test3没有被找到，即按照第一部分所说，Test3没有在import的搜索路径中。所以，只要将它加入进去即可，比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> PYTHONPATH=D:\learn\import_test\</span><br></pre></td></tr></table></figure>
<p>此时再直接运行就没有问题了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/10/10/ImagePy_10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/10/ImagePy_10/" class="post-title-link" itemprop="url">ImagePy解析：10 -- Tool引擎及其衍生的画笔工具</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-10 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-10T00:00:00+08:00">2019-10-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/10/10/ImagePy_10/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/10/ImagePy_10/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考文献：<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25483900">ImagePy开发文档 —— 工具</a><br><a target="_blank" rel="noopener" href="https://github.com/Image-Py/demoplugin/blob/master/doc/chinese/tool.md">Tool 插件</a></p>
<p>Filter、Simple 都可以处理图像，但有时候我们需要用鼠标交互对图像进行一些操作。比如我们的选区操作，绘图操作等。ImagePlus 被绘制在一个 Canvas 上，Canvas 是 wxpython 的 Panel 子类，当然我们可以对其添加鼠标事件，但我们并不推荐这样做，原因之一是这样做比较繁琐，其次，多工具同时注册事件，会引起管理混乱和事件冲突。（语出上面的参考文献）<br>这一篇来解析一下Tool引擎，先分析一下这个基类，然后通过基于它编写的画笔工具深入理解。<br>注意，Tool引擎与前面的Free、Filter等交互逻辑上有挺多区别，比如入口函数中不触发一系列的连贯操作，而是强烈依赖于鼠标事件，因此需要仔细地区别对待。</p>
<h1 id="Tool引擎"><a href="#Tool引擎" class="headerlink" title="Tool引擎"></a>Tool引擎</h1><p>看一下Tool引擎的全貌：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ... <span class="keyword">import</span> IPy</span><br><span class="line"><span class="keyword">from</span> ...core.manager <span class="keyword">import</span> ToolsManager</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tool</span>:</span></span><br><span class="line">    title = <span class="string">&#x27;Tool&#x27;</span></span><br><span class="line">    view, para = <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        …   </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">config</span>(<span class="params">self</span>):</span><span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load</span>(<span class="params">self</span>):</span><span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">switch</span>(<span class="params">self</span>):</span><span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self</span>):</span></span><br><span class="line">        …       </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouse_down</span>(<span class="params">self, ips, x, y, btn, **key</span>):</span> <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouse_up</span>(<span class="params">self, ips, x, y, btn, **key</span>):</span> <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouse_move</span>(<span class="params">self, ips, x, y, btn, **key</span>):</span> <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouse_wheel</span>(<span class="params">self, ips, x, y, d, **key</span>):</span> <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>然后再细看一下它的具体属性和方法。</p>
<h2 id="para和view属性"><a href="#para和view属性" class="headerlink" title="para和view属性"></a>para和view属性</h2><p>这两位朋友很熟悉了，用于设置输入的参数和交互界面样式，默认为None，代表不需要交互。这里的para与前面Free和Filter中的para有些不一样，它是用来设置工具的自身特性，比如画笔的宽度、颜色等。</p>
<h2 id="show-方法"><a href="#show-方法" class="headerlink" title="show()方法"></a>show()方法</h2><p>Tool引擎的show()方法与Free和Filter的都不同，它不会在入口函数start()中进行触发，而是在鼠标左键双击时触发。那么机理来自于哪里？奥妙就在于在第一步构建主界面的加载工具条时对鼠标事件的绑定，来自于toolsloader.py的add_tools()函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>(<span class="params">plg, e</span>):</span></span><br><span class="line">    plg.start()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(plg, Tool):</span><br><span class="line">        e.Skip()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_info</span>(<span class="params">value</span>):</span></span><br><span class="line">    IPy.curapp.set_info(value)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_tools</span>(<span class="params">bar, datas, clear=<span class="literal">False</span>, curids=[]</span>):</span></span><br><span class="line">    …</span><br><span class="line">        btn.Bind( wx.EVT_LEFT_DOWN, <span class="keyword">lambda</span> x, p=data[<span class="number">0</span>]:f(p(), x))</span><br><span class="line">        btn.Bind( wx.EVT_RIGHT_DOWN, <span class="keyword">lambda</span> x, p=data[<span class="number">0</span>]: IPy.show_md(p.title, DocumentManager.get(p.title)))</span><br><span class="line">        btn.Bind( wx.EVT_ENTER_WINDOW,</span><br><span class="line">                  <span class="keyword">lambda</span> x, p=<span class="string">&#x27;&quot;&#123;&#125;&quot; Tool&#x27;</span>.<span class="built_in">format</span>(data[<span class="number">0</span>].title): set_info(p))       </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(data[<span class="number">0</span>], Macros) <span class="keyword">and</span> <span class="built_in">issubclass</span>(data[<span class="number">0</span>], Tool):</span><br><span class="line">            btn.Bind(wx.EVT_LEFT_DCLICK, <span class="keyword">lambda</span> x, p=data[<span class="number">0</span>]:p().show())</span><br><span class="line">        btn.SetDefault()</span><br><span class="line">    …</span><br></pre></td></tr></table></figure>
<p>可以看出，这里将左键双击事件绑定到了Tool引擎的show()方法上。<br>同时可以看出，对于界面上的每一个tool，还有其他的鼠标事件绑定：<br>（1）左键单击：执行f()函数，即执行了Tool引擎的start()函数<br>（2）右键单击：调用IPy的显示MarkDown帮助文件<br>（3）鼠标进入窗口：在状态栏显示该tool的title</p>
<p>说回show()方法，看它的源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">if</span> self.view == <span class="literal">None</span>:<span class="keyword">return</span></span><br><span class="line">    rst = IPy.get_para(self.title, self.view, self.para)</span><br><span class="line">    <span class="keyword">if</span> rst!=<span class="literal">None</span> : self.config()</span><br></pre></td></tr></table></figure>
<p>可以看出，如果view为None，即不交互，则不做什么动作；反之，则调用IPy的get_para()方法，此时就会蹦出参数对话框用于设置参数。然后接着调用下面的config()方法，该方法默认是什么也不做。</p>
<h2 id="config-方法"><a href="#config-方法" class="headerlink" title="config()方法"></a>config()方法</h2><p>当交互对话框确认时将会被调用，用于生效我们的设置。一些时候参数值的改变本身就会生效，例如调整画笔宽度，但有些时候，需要对外部进行一些通讯，比如设置全局颜色，就需要和 ColorManager 通讯。（语出上面的参考文献）</p>
<h2 id="load-和switch-方法"><a href="#load-和switch-方法" class="headerlink" title="load()和switch()方法"></a>load()和switch()方法</h2><p>load是工具被选中时调用，switch是由当前工具切换到另一个工具时调用（可以处理绘制了一半还没有闭合的多边形选区等）。（语出上面的参考文献）</p>
<h2 id="start-方法"><a href="#start-方法" class="headerlink" title="start()方法"></a>start()方法</h2><p>前已述及，它在鼠标左键单击时调用，具体操作是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self</span>):</span></span><br><span class="line">    ips = IPy.get_ips()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ips <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> ips.tool <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        ips.tool = <span class="literal">None</span></span><br><span class="line">        ips.update()</span><br><span class="line">    ToolsManager.<span class="built_in">set</span>(self)</span><br></pre></td></tr></table></figure>
<p>可以看出，首先得到了ips对象，然后还有一个重要操作是调用ToolsManager（ToolsManager在pluginmanager.py中定义）的set()方法，里面就调用了上面的switch()方法。</p>
<h2 id="mouse-down-、mouse-up-、mouse-move-和mouse-wheel-方法"><a href="#mouse-down-、mouse-up-、mouse-move-和mouse-wheel-方法" class="headerlink" title="mouse_down()、mouse_up()、mouse_move()和mouse_wheel()方法"></a>mouse_down()、mouse_up()、mouse_move()和mouse_wheel()方法</h2><p>这四个方法一看名字就知道是与鼠标操作有关，具体地，与鼠标按下、弹起、移动、滚轮相关。<br>那么，它们是怎样被调用的呢？<br>从前面的那篇“由新建图像谈起”文章可知，ImagePy中图像是呈现在Canvasl中的。虽然Canvas能够作为独立组件单独调用，但在ImagePy整个框架中，Canvas是通过CanvasPanel来调用的，所以在图像中的鼠标操作事件最开始都是由CanvasPanel所调用的Canvas来捕获和激发的，即下面这句话：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.canvas = Canvas(self, autofit = IPy.uimode()==<span class="string">&#x27;ij&#x27;</span>)</span><br><span class="line">self.canvas.Bind(wx.EVT_MOUSE_EVENTS, self.on_mouse)</span><br></pre></td></tr></table></figure>

<p>这里插一句，为了保证Canvas能够被单独调用，在Canvas类中也写了这么一个鼠标事件绑定，所以如果仅仅是在ImagePy中使用Canvas，可以把那句删掉。<br>再插一句，Canvas所捕获的鼠标事件与上面提到的加载工具条时捕获的鼠标事件要区分开，这是两个不同的wxPython的Panel。比如，虽然都会捕获鼠标左键按下，但是不同的Panel所做的动作是不一样的。</p>
<p>然后在具体的事件处理函数on_mouse()中，开头是这样的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_mouse</span>(<span class="params">self, me</span>):</span></span><br><span class="line">    tool = self.ips.tool</span><br><span class="line">    <span class="keyword">if</span> tool == <span class="literal">None</span> : tool = ToolsManager.curtool</span><br></pre></td></tr></table></figure>
<p>这样就解释了上面的参考文献中的这句话：</p>
<blockquote>
<p>事件的调用遵循如下规则：<br>1.事件最初由 Canvas 类触发。<br>2.如果 Canvas 持有的 ImagePlus 有一个 CustomTool，则交给它来处理。（一般来说，比如选区，画笔等工具，是全局有效的，但有时我们需要与单一图像做特定交互，比如当某个图像栈进入了三视图观察状态时，这时CustomTool 就变得很有用。）<br>3.如果没有，则交给 ToolsManager 的当前工具来处理。</p>
</blockquote>
<p>然后如果真是交给了当前工具，那么Tool引擎的这四个方法就开始调用了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sta = [me.AltDown(), me.ControlDown(), me.ShiftDown()]</span><br><span class="line"><span class="keyword">if</span> me.ButtonDown():tool.mouse_down(self.ips, x, y, me.GetButton(),</span><br><span class="line">    alt=sta[<span class="number">0</span>], ctrl=sta[<span class="number">1</span>], shift=sta[<span class="number">2</span>], canvas=self.canvas)</span><br><span class="line"><span class="keyword">if</span> me.ButtonUp():tool.mouse_up(self.ips, x, y, me.GetButton(),</span><br><span class="line">    alt=sta[<span class="number">0</span>], ctrl=sta[<span class="number">1</span>], shift=sta[<span class="number">2</span>], canvas=self.canvas)</span><br><span class="line"><span class="keyword">if</span> me.Moving():tool.mouse_move(self.ips, x, y, <span class="literal">None</span>,</span><br><span class="line">    alt=sta[<span class="number">0</span>], ctrl=sta[<span class="number">1</span>], shift=sta[<span class="number">2</span>], canvas=self.canvas)</span><br><span class="line">btn = [me.LeftIsDown(), me.MiddleIsDown(), me.RightIsDown(),<span class="literal">True</span>].index(<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">if</span> me.Dragging():tool.mouse_move(self.ips, x, y, <span class="number">0</span> <span class="keyword">if</span> btn==<span class="number">3</span> <span class="keyword">else</span> btn+<span class="number">1</span>,</span><br><span class="line">    alt=sta[<span class="number">0</span>], ctrl=sta[<span class="number">1</span>], shift=sta[<span class="number">2</span>], canvas=self.canvas)</span><br><span class="line">wheel = np.sign(me.GetWheelRotation())</span><br><span class="line"><span class="keyword">if</span> wheel!=<span class="number">0</span>:tool.mouse_wheel(self.ips, x, y, wheel,</span><br><span class="line">    alt=sta[<span class="number">0</span>], ctrl=sta[<span class="number">1</span>], shift=sta[<span class="number">2</span>], canvas=self.canvas)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hasattr</span>(tool, <span class="string">&#x27;cursor&#x27;</span>):</span><br><span class="line">    self.canvas.SetCursor(wx.Cursor(tool.cursor))</span><br><span class="line"><span class="keyword">else</span> : self.canvas.SetCursor(wx.Cursor(wx.CURSOR_ARROW))</span><br></pre></td></tr></table></figure>

<p>具体地分析一下这四个方法所需要的参数：（语出上面的参考文献）</p>
<ol>
<li>mouse_down()<br>鼠标按下时调用，其参数意义如下：<br>（1）ips:与事件相关的 ImagePlus，可以通过ips.img获取当前图像，也可以ips.lut, ips.roi, ips.unit获取图像的索引表，roi，比例尺和单位等附加信息。<br>（2）x:数据坐标系下的 x<br>（3）y:数据坐标系下的 y<br>（4）btn:按下的按钮（1：左键，2：中键，3：右键）<br>（5）key其他参数：可以通过key[‘alt’]、key[‘ctrl’]、key[‘shift’]获取相应功能键是否按下，通过key[‘canvas’]获取触发事件的Canvas对象。</li>
<li>mouse_up()<br>参数和意义与 mouse_down 完全相同</li>
<li>mouse_move()<br>参数和意义与 mouse_down 完全相同，另外附加如果没有按键按下，btn=0</li>
<li>mouse_wheel()<br>参数和意义与 mouse_down 基本相同，除了btn参数变成了d，代表滚动量</li>
</ol>
<p>下面以画笔工具看看怎样编写基于Tool的插件。</p>
<h1 id="Pencil画笔工具"><a href="#Pencil画笔工具" class="headerlink" title="Pencil画笔工具"></a>Pencil画笔工具</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> imagepy.core.engine <span class="keyword">import</span> Tool</span><br><span class="line"><span class="keyword">from</span> imagepy.core.manager <span class="keyword">import</span> ColorManager</span><br><span class="line"><span class="keyword">from</span> skimage.draw <span class="keyword">import</span> line, circle</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drawline</span>(<span class="params">img, oldp, newp, w, value</span>):</span></span><br><span class="line">    <span class="keyword">if</span> img.ndim == <span class="number">2</span>: value = <span class="built_in">sum</span>(value)/<span class="number">3</span></span><br><span class="line">    oy, ox = line(*[<span class="built_in">int</span>(<span class="built_in">round</span>(i)) <span class="keyword">for</span> i <span class="keyword">in</span> oldp+newp])</span><br><span class="line">    cy, cx = circle(<span class="number">0</span>, <span class="number">0</span>, w/<span class="number">2</span>+<span class="number">1e-6</span>)</span><br><span class="line">    ys = (oy.reshape((-<span class="number">1</span>,<span class="number">1</span>))+cy).clip(<span class="number">0</span>, img.shape[<span class="number">0</span>]-<span class="number">1</span>)</span><br><span class="line">    xs = (ox.reshape((-<span class="number">1</span>,<span class="number">1</span>))+cx).clip(<span class="number">0</span>, img.shape[<span class="number">1</span>]-<span class="number">1</span>)</span><br><span class="line">    img[ys.ravel(), xs.ravel()] = value</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plugin</span>(<span class="params">Tool</span>):</span></span><br><span class="line">    title = <span class="string">&#x27;Pencil&#x27;</span></span><br><span class="line">    para = &#123;<span class="string">&#x27;width&#x27;</span>:<span class="number">1</span>&#125;</span><br><span class="line">    view = [(<span class="built_in">int</span>, <span class="string">&#x27;width&#x27;</span>, (<span class="number">0</span>,<span class="number">30</span>), <span class="number">0</span>,  <span class="string">&#x27;width&#x27;</span>, <span class="string">&#x27;pix&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.status = <span class="literal">False</span></span><br><span class="line">        self.oldp = (<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouse_down</span>(<span class="params">self, ips, x, y, btn, **key</span>):</span></span><br><span class="line">        self.status = <span class="literal">True</span></span><br><span class="line">        self.oldp = (y, x)</span><br><span class="line">        ips.snapshot()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouse_up</span>(<span class="params">self, ips, x, y, btn, **key</span>):</span></span><br><span class="line">        self.status = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouse_move</span>(<span class="params">self, ips, x, y, btn, **key</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.status:<span class="keyword">return</span></span><br><span class="line">        w = self.para[<span class="string">&#x27;width&#x27;</span>]</span><br><span class="line">        value = ColorManager.get_front()</span><br><span class="line">        drawline(ips.img, self.oldp, (y, x), w, value)</span><br><span class="line">        self.oldp = (y, x)</span><br><span class="line">        ips.update()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mouse_wheel</span>(<span class="params">self, ips, x, y, d, **key</span>):</span><span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>可以看出，para中定义了线宽。在这个画笔工具中，当鼠标按下时，将status属性置为True，同时将当前坐标点存下来作为oldp，以及也存一个快照。<br>注意存坐标点时将x和y的顺序互换，这在之前一篇解析文章中已提到，这是因为图像在坐标系中的顺序与实际的Numpy数组的顺序是相反地，前者是先列后行，后者的读取则是先行后列。<br>然后在鼠标移动过程中绘图，线宽可以通过双击该画笔工具进行设定。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xin-Bo Qi(亓欣波)"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Xin-Bo Qi(亓欣波)</p>
  <div class="site-description" itemprop="description">Be interesting!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">120</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/qixinbo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qixinbo" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:qixinbo@gmail.com" title="E-Mail → mailto:qixinbo@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.tsinghua.edu.cn/" title="https:&#x2F;&#x2F;www.tsinghua.edu.cn" rel="noopener" target="_blank">THU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.imr.cas.cn/" title="http:&#x2F;&#x2F;www.imr.cas.cn" rel="noopener" target="_blank">IMR</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.sdu.edu.cn/" title="http:&#x2F;&#x2F;www.sdu.edu.cn" rel="noopener" target="_blank">SDU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://liam0205.me/" title="http:&#x2F;&#x2F;liam0205.me&#x2F;" rel="noopener" target="_blank">黄晨成</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xin-Bo Qi(亓欣波)</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://qixinbo.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
