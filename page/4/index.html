<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qixinbo.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Be interesting!">
<meta property="og:type" content="website">
<meta property="og:title" content="亓欣波">
<meta property="og:url" content="http://qixinbo.github.io/page/4/index.html">
<meta property="og:site_name" content="亓欣波">
<meta property="og:description" content="Be interesting!">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Xin-Bo Qi(亓欣波)">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://qixinbo.github.io/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>亓欣波</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">亓欣波</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Hi, I am Xin-Bo Qi (亓欣波)</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-scholar">

    <a href="/scholar/" rel="section"><i class="bar-chart fa-fw"></i>scholar</a>

  </li>
        <li class="menu-item menu-item-sources">

    <a href="/sources/" rel="section"><i class="rss fa-fw"></i>sources</a>

  </li>
        <li class="menu-item menu-item-gallery">

    <a href="/gallery/" rel="section"><i class="file-image-o fa-fw"></i>gallery</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404.html" rel="section"><i class="heartbeat fa-fw"></i>Commonweal 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/10/06/ImagePy_9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/06/ImagePy_9/" class="post-title-link" itemprop="url">ImagePy解析：9 -- Filter引擎及其衍生的图像取反插件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-06 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-06T00:00:00+08:00">2019-10-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/10/06/ImagePy_9/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/06/ImagePy_9/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考文献：<br><a target="_blank" rel="noopener" href="https://github.com/Image-Py/demoplugin/blob/master/doc/chinese/filter.md">Filter 插件</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25474961">ImagePy开发文档 —— 滤波器引擎</a></p>
<p>Filter引擎是最重要的一类插件，用于对二维图像进行滤波，也是图像处理中最基础、最普遍的一类应用（语出上面的参考文献）。<br>这一篇分析Filter引擎的功能，并通过基于它所编写的图像取反插件来深入理解。</p>
<h1 id="Filter引擎"><a href="#Filter引擎" class="headerlink" title="Filter引擎"></a>Filter引擎</h1><p>Filter引擎的基本类结构如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Filter</span>:</span></span><br><span class="line">    title = <span class="string">&#x27;Filter&#x27;</span></span><br><span class="line">    modal = <span class="literal">True</span></span><br><span class="line">    note = []</span><br><span class="line">    para, view = <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, ips=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="comment">#...</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment">#...</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, ips, snap, img, para = <span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="comment">#...</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">self, ips</span>):</span></span><br><span class="line">        <span class="comment">#...</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">preview</span>(<span class="params">self, para</span>):</span></span><br><span class="line">        <span class="comment">#...</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load</span>(<span class="params">self, ips</span>):</span></span><br><span class="line">        <span class="comment">#...</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self, para=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<p>可以看出，其基本框架与前面分析的Free引擎类似，毕竟都属于引擎一族。</p>
<h2 id="初始化函数"><a href="#初始化函数" class="headerlink" title="初始化函数"></a>初始化函数</h2><p>先看它的初始化函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, ips=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> ips==<span class="literal">None</span>:ips = IPy.get_ips()</span><br><span class="line">    self.dialog = <span class="literal">None</span></span><br><span class="line">    self.ips = ips</span><br></pre></td></tr></table></figure>
<p>即会首先通过IPy的get_ips()将ImagePlus图像传给self.ips（IPy是调用了框架的ImageManager管理器），如果没有图像，那么显然这个值就是None。</p>
<h2 id="note属性"><a href="#note属性" class="headerlink" title="note属性"></a>note属性</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">note = []</span><br><span class="line"><span class="string">&#x27;all, 8-bit, 16-bit, int, rgb, float, not_channel, not_slice, req_roi, auto_snap, auto_msk, preview, 2int, 2float&#x27;</span></span><br></pre></td></tr></table></figure>
<p>note属性决定了该Filter的运行特性，其内的字符串可以分为两类：<br>（1）一类用于检查时：<br>all表示该滤镜能处理所有类型的图像、8-bit表示该滤镜能处理8位灰度图像、16-bit表示能处理16位灰度图像、int表示能处理32位整型灰度图像、rgb表示能处理RGB彩色图像、float表示能处理浮点图像，req_roi表示该滤镜需要选区。具体检查原理就是在check()方法中形如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elif</span> ips.get_imgtype()==<span class="string">&#x27;8-bit&#x27;</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="string">&#x27;8-bit&#x27;</span> <span class="keyword">in</span> note:</span><br><span class="line">    IPy.alert(<span class="string">&#x27;Do not surport 8-bit image&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<p>（2）一类用于运行时：<br>preview:是否需要提供预览功能、auto_snap:是否需要执行前自动快照、auto_msk:是否要支持选区、not_channel:是否在处理彩色图像时自动处理每个通道（如不填写为是）、not_slice:是否在处理图像栈的时候询问，从而处理每个层（如不填写为是）、2int:如果精度低于16位整数，是否在处理之前把图像转为16位整数（一些运算会产生负数或溢出）、2float:如果精度低于32位浮点，是否在处理之前把图像转为32位浮点（一些运算需要在浮点上做才能保证质量）（语出上面的参考文献）</p>
<h2 id="modal属性"><a href="#modal属性" class="headerlink" title="modal属性"></a>modal属性</h2><p>当 modal 为 True 时，参数对话框将以模态展示，这也是默认情况，这满足大多数的使用场景。</p>
<h2 id="para和view属性"><a href="#para和view属性" class="headerlink" title="para和view属性"></a>para和view属性</h2><p>核心函数需要用到的参数，以及他们的交互方式，默认为 None，代表不需要交互。</p>
<h2 id="check-方法"><a href="#check-方法" class="headerlink" title="check()方法"></a>check()方法</h2><p>check根据note标识，对当前图像是否存在、选区是否存在、图像类型等进行检查，如果不满足，则调用IPy的alert()弹窗警告。</p>
<h2 id="load-方法"><a href="#load-方法" class="headerlink" title="load()方法"></a>load()方法</h2><p>这里默认是没有做什么操作。但是可以在load()里做一些准备工作，比如获取当前图像的像素直方图等，也可以用作进一步的检查，比如检查图像是否为二值图像。返回 True，则继续执行后续流程，返回 False，则终止。</p>
<h2 id="start-方法"><a href="#start-方法" class="headerlink" title="start()方法"></a>start()方法</h2><p>前面分析Free引擎时已提到，start()方法是引擎的启动函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self, para=<span class="literal">None</span>, callafter=<span class="literal">None</span></span>):</span></span><br><span class="line">    ips = self.ips</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.check(ips):<span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.load(ips):<span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;auto_snap&#x27;</span> <span class="keyword">in</span> self.note:ips.snapshot()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> para!=<span class="literal">None</span>:</span><br><span class="line">        self.ok(self.ips, para, callafter)</span><br><span class="line">    <span class="keyword">elif</span> self.view==<span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.__class__.show <span class="keyword">is</span> Filter.show:</span><br><span class="line">            <span class="keyword">if</span> self.show():</span><br><span class="line">                self.ok(self.ips, para, callafter)</span><br><span class="line">        <span class="keyword">else</span>: self.ok(self.ips, para, callafter)</span><br><span class="line">    <span class="keyword">elif</span> self.modal:</span><br><span class="line">        <span class="keyword">if</span> self.show():</span><br><span class="line">            self.ok(ips, <span class="literal">None</span>, callafter)</span><br><span class="line">        <span class="keyword">else</span>:self.cancel(ips)</span><br><span class="line">        self.dialog.Destroy()</span><br><span class="line">    <span class="keyword">else</span>: self.show()</span><br></pre></td></tr></table></figure>
<p>可以看到，首先就是调用check()方法做必要的“体检”，检查项目包括图像本身、ROI、类型检查等。然后执行load()方法。<br>如果note属性里设置了auto_snap，就会调用ImagePlus对象的snapshot()方法将图像的快照存下来。这里插一句，查看这个方法的源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">snapshot</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">if</span> self.snap <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        self.snap = self.img.copy()</span><br><span class="line">    <span class="keyword">else</span>: self.snap[...] = self.img</span><br></pre></td></tr></table></figure>
<p>发现里面有个省略号的符号，Python中的省略号代表未指定的其余数组维度的占位符，可以把它看作是代表它所放置的位置中所有尺寸的完整切片，因此a[…,0]在3d数组中与a[:,:,0]相同，在4d数组中与a[:,:,:,0]相同。具体的参考文章有：<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/772124/what-does-the-python-ellipsis-object-do">What does the Python Ellipsis object do?</a><br><a target="_blank" rel="noopener" href="https://farer.org/2017/11/29/python-ellipsis-object/">Python 的 Ellipsis 对象</a><br>然后判断para是否为None，参数 para 如果有值，则直接执行 run。（菜单点击的方式下都是传入的 None，而运行宏的时候，可以传入 para 参数）<br>如果para为None，则还要经过其他判断，比如是否veiw有值、是否模态对话框等，接着会调用self.show()方法（即生成参数对话框）或者self.ok()方法，具体不同以后再分析。下面以最简单的图像取反操作来分析具体流程。</p>
<h1 id="图像取反"><a href="#图像取反" class="headerlink" title="图像取反"></a>图像取反</h1><p>图像取反插件是基于Filter引擎的最简单的一个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> imagepy.core.engine <span class="keyword">import</span> Filter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plugin</span>(<span class="params">Filter</span>):</span></span><br><span class="line">    title = <span class="string">&#x27;Invert Demo&#x27;</span></span><br><span class="line">    note = [<span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;auto_msk&#x27;</span>, <span class="string">&#x27;auto_snap&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, ips, snap, img, para = <span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">255</span>-snap</span><br></pre></td></tr></table></figure>
<p>我们看看这个插件的运行路径。<br>因为该插件没有定义para和view，因此，start()就执行到这里了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;self.__class__ = &quot;</span>, self.__class__)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> self.__class__.show <span class="keyword">is</span> Filter.show:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; __class__.show is not Filter.show&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> self.show():</span><br><span class="line">        self.ok(self.ips, para, callafter)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; __class__.show is Filter.show&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Execcute directly~~&quot;</span>)</span><br><span class="line">    self.ok(self.ips, para, callafter)</span><br></pre></td></tr></table></figure>
<p>然后就判断show()方法是该取反插件自己的还是Filter基类的，因为取反插件没有定义show()，所以它就默认调用的是Filter的show，因此实际就执行的else情形的代码。<br>插一句，关于__class__的用法，见：<br><a target="_blank" rel="noopener" href="https://luobuda.github.io/2015/01/16/python-class/">python中的__class__</a><br>那么，就看ok()方法干了啥。其实ok()的主要作用就是根据不同情形决定调用process_one()还是process_stack()，即处理单张图像，还是一个图像栈。<br>查看一下这两者的不同。先看两者的原始声明：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_one</span>(<span class="params">plg, ips, src, img, para, callafter=<span class="literal">None</span></span>)</span></span><br><span class="line"><span class="function"><span class="title">def</span> <span class="title">process_stack</span>(<span class="params">plg, ips, src, imgs, para, callafter=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>
<p>再看它们实际调用时：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">process_one(self, ips, ips.snap, ips.img, para, callafter)</span><br><span class="line">process_stack(self, ips, ips.snap, ips.imgs, para, callafter)</span><br></pre></td></tr></table></figure>
<p>分析一下实参和形参的对应关系：<br>（1）self就是当前插件的指针，传给了它们俩的plg形参，因此可以在plg中调用插件的各个属性和方法；<br>（2）ips作为整个图像的封装，传给了ips形参，注意ips与下面的src和img的关系，ips是一个统一封装，src和img仅是它的一部分；<br>（3）ips.snap就是对图像的快照，如前所述，如果在note中设置了auto_snap，则提前就将图像copy一份到snap中，它传给了src形参；<br>（4）ips.img或ips.imgs充分反映了两个函数的不同点：如果是处理一张图像，则传入ips.img，如前所述，这是调用了ImagePlus的img属性，它与当前的游标self.cur有关；如果是处理一个图像栈，则传入ips.imgs。将它们传给了img或imgs形参。注意src与img的区别，src是图像在处理前的一个copy，在代码中也是使用的copy()函数，所以src创建了一个新的对象，与源图像已没有关系；而img或imgs还是原来对象的引用。这里插一句，拷贝有深拷贝和浅拷贝的区别，同时python的拷贝与numpy的拷贝也有不同（这里查看snapshot()源码可知，snapshot是作用于单张图像上，所以是numpy的copy()，而不是python的copy包的copy()）：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u010099080/article/details/59111207">Python numpy 中的 copy 问题详解</a><br><a target="_blank" rel="noopener" href="http://wsfdl.com/python/2013/08/16/%E7%90%86%E8%A7%A3Python%E7%9A%84%E6%B7%B1%E6%8B%B7%E8%B4%9D%E5%92%8C%E6%B5%85%E6%8B%B7%E8%B4%9D.html">理解 Python 引用、浅拷贝和深拷贝</a><br>（5）para就是参数，注意它与self.para的区别，将它传给了para形参；<br>（6）callafter：目前看就是默认None，没有对它进行改变，也是正常传给了para形参。</p>
<p>这两个函数又都调用了process_channels()方法，即对通道进行处理。<br>先来看该方法的声明：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_channels</span>(<span class="params">plg, ips, src, des, para</span>)</span></span><br></pre></td></tr></table></figure>
<p>再来看process_one()和process_stack()调用它时：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对于一张图像</span></span><br><span class="line">rst = process_channels(plg, ips, src, buf <span class="keyword">if</span> transint <span class="keyword">or</span> transfloat <span class="keyword">else</span> img, para)</span><br><span class="line"><span class="comment"># 对于一个图像栈</span></span><br><span class="line">rst = process_channels(plg, ips, src, buf <span class="keyword">if</span> transint <span class="keyword">or</span> transfloat <span class="keyword">else</span> i, para)</span><br></pre></td></tr></table></figure>
<p>这样的实参与形参对应时，需要注意的就是buf实参与des形参的对应，如果note中表明了2int或2float，即需要转成int型或float型，就要先调用numpy的astype转换一下数据格式。然后实际process_channels中的des就是之前的self.img或self.imgs。</p>
<p>再来看取反插件中的run()是怎样与Filter引擎进行对应的。对于取反插件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, ips, snap, img, para = <span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">255</span>-snap</span><br></pre></td></tr></table></figure>
<p>在Filter引擎中（以单通道为例）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rst = plg.run(ips, src, des, para)</span><br></pre></td></tr></table></figure>
<p>对应关系就是ips传给ips，src传给snap，des传给img，para传给para。<br>经过上面分析，这四个实参：ips是通过IPy调用ImageManager获得的，src和des都是ips中的属性，para追根溯源是从取反插件的para属性中传入的，即下面这个赋值语句（即如果是菜单点击的话，在插件中直接将para=None就是将插件的para属性传给了run()方法）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ok</span>(<span class="params">self, ips, para=<span class="literal">None</span>, callafter=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> para == <span class="literal">None</span>:</span><br><span class="line">        para = self.para</span><br></pre></td></tr></table></figure>
<p>所以对于插件的编写，只需要在重载run()方法时正确地写上这些参数，不需要考虑怎样给它们赋值，而是只定义逻辑操作即可，比如这里的直接用255减去snap的值。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/10/05/ImagePy_8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/05/ImagePy_8/" class="post-title-link" itemprop="url">ImagePy解析：8 -- 由新建图像谈起（引出IPy、ImagePlus、Canvas、ImageManager）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-05 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-05T00:00:00+08:00">2019-10-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/10/05/ImagePy_8/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/05/ImagePy_8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>%%%%% 更新日志 %%%%%<br>2019-10-11更新：增加ImageManager管理器解析<br>%%%%%%%%%%%%%%%%%%%%</p>
<p>参考文献：<br><a target="_blank" rel="noopener" href="https://github.com/Image-Py/demoplugin/blob/master/doc/chinese/free.md#%E5%88%9B%E5%BB%BA%E5%9B%BE%E5%83%8F">创建图像</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25474453">ImagePy开发文档 —— 常用汇总</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25474501">ImagePy开发文档 —— 图像封装类</a></p>
<h1 id="新建图像的插件"><a href="#新建图像的插件" class="headerlink" title="新建图像的插件"></a>新建图像的插件</h1><p>最简单的新建图像的插件代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> imagepy.core.engine <span class="keyword">import</span> Free</span><br><span class="line"><span class="keyword">from</span> imagepy <span class="keyword">import</span> IPy</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plugin</span>(<span class="params">Free</span>):</span></span><br><span class="line">    title = <span class="string">&#x27;New Image Demo&#x27;</span></span><br><span class="line">    para = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;new image&#x27;</span>,<span class="string">&#x27;w&#x27;</span>:<span class="number">300</span>, <span class="string">&#x27;h&#x27;</span>:<span class="number">300</span>&#125;</span><br><span class="line">    view = [(<span class="built_in">str</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            (<span class="built_in">int</span>, <span class="string">&#x27;w&#x27;</span>, (<span class="number">1</span>,<span class="number">2048</span>), <span class="number">0</span>,  <span class="string">&#x27;width&#x27;</span>, <span class="string">&#x27;pix&#x27;</span>),</span><br><span class="line">            (<span class="built_in">int</span>, <span class="string">&#x27;h&#x27;</span>, (<span class="number">1</span>,<span class="number">2048</span>), <span class="number">0</span>,  <span class="string">&#x27;height&#x27;</span>, <span class="string">&#x27;pix&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, para = <span class="literal">None</span></span>):</span></span><br><span class="line">        imgs = [np.zeros((para[<span class="string">&#x27;h&#x27;</span>], para[<span class="string">&#x27;w&#x27;</span>]), dtype=np.uint8)]</span><br><span class="line">        IPy.show_img(imgs, para[<span class="string">&#x27;name&#x27;</span>])</span><br></pre></td></tr></table></figure>
<p>该插件的写法可以参考之前的解析文章，在run()方法中接收para的宽度w和高度h的数值，然后通过numpy的zeros函数生成了一个全是0的array数组，注意imgs变量又对该array数组加入了一个方括号，即将其转化为python的列表（其实从后面可以看出，该列表的长度就是整个图像栈有多少个slices），所以imgs的具体数值就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">imgs =  [array([[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, ..., <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, ..., <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, ..., <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       ...,</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, ..., <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, ..., <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">       [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, ..., <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]], dtype=uint8)]</span><br></pre></td></tr></table></figure>
<p>然后将imgs和用户输入的图像名称传入IPy的show_img()方法。到这里就可以看出，ImagePy是将传统的numpy数组（一般的图像库都是将图像读作numpy数组）进行了进一步的封装，这个封装类就是ImagePlus，后面再具体分析ImagePlus。</p>
<h1 id="IPy常用工具集"><a href="#IPy常用工具集" class="headerlink" title="IPy常用工具集"></a>IPy常用工具集</h1><p>上面将imgs传入了IPy的show_img()方法，实际IPy是一些常用功能的汇总，比如展示一幅图像，获取当前图像窗口等功能，其实这些功能是分布在各个功能组建中的，IPy只是重新引用和整理，并且IPy处于最顶层目录，随处都可以方便的引用这样以来，提高了开发效率。（语出上面的参看文献）<br>具体看show_img()方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showimg</span>(<span class="params">imgs, title</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;show img&#x27;</span>)</span><br><span class="line">    <span class="keyword">from</span> .core <span class="keyword">import</span> ImagePlus</span><br><span class="line">    ips = ImagePlus(imgs, title)</span><br><span class="line">    showips(ips)</span><br><span class="line"></span><br><span class="line">pub.subscribe(showimg, <span class="string">&#x27;showimg&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_img</span>(<span class="params">imgs, title</span>):</span></span><br><span class="line">    <span class="keyword">if</span> uimode()==<span class="string">&#x27;no&#x27;</span>:</span><br><span class="line">        <span class="keyword">from</span> .core <span class="keyword">import</span> manager, ImagePlus</span><br><span class="line">        <span class="keyword">from</span> .ui.canvasframe <span class="keyword">import</span> VirturlCanvas</span><br><span class="line">        frame = VirturlCanvas(ImagePlus(imgs, title))</span><br><span class="line">    <span class="keyword">else</span>:wx.CallAfter(pub.sendMessage, <span class="string">&#x27;showimg&#x27;</span>, imgs=imgs, title=title)</span><br></pre></td></tr></table></figure>
<p>可以看出，该方法又通过Publisher/Subscriber机制调用了showimg()方法，这里就引出了ImagePlus封装类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ips = ImagePlus(imgs, title)</span><br></pre></td></tr></table></figure>
<p>ImagePlus接收imgs和title，组装成了ImagePlus类型的ips。</p>
<h1 id="ImagePlus图像封装类"><a href="#ImagePlus图像封装类" class="headerlink" title="ImagePlus图像封装类"></a>ImagePlus图像封装类</h1><p>ImagePy 采用 Numpy 数组作为图像数据结构，Numpy 非常强大，但是要让它能够支持我们的全部特性（索引色支持，撤销，选区支持，多通道支持，图像栈支持），还需要一些其他的数据给予必要的辅助，因而我们有了ImagePlus类（语出上面的参考文献）。<br>下面看看ImagePlus收到imgs后干了什么：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_imgs</span>(<span class="params">self, imgs</span>):</span></span><br><span class="line">    self.is3d = <span class="keyword">not</span> <span class="built_in">isinstance</span>(imgs, <span class="built_in">list</span>)</span><br><span class="line">    self.scrchanged = <span class="literal">True</span></span><br><span class="line">    self.snap = <span class="literal">None</span></span><br><span class="line">    self.imgs = imgs</span><br><span class="line">    self.size = self.imgs[<span class="number">0</span>].shape[:<span class="number">2</span>]</span><br><span class="line">    self.height, self.width = self.size</span><br><span class="line">    self.imgtype = get_img_type(self.imgs)</span><br><span class="line">    <span class="keyword">if</span> self.imgs[<span class="number">0</span>].ndim==<span class="number">2</span>: self.channels = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>: self.channels = self.imgs[<span class="number">0</span>].shape[<span class="number">2</span>]</span><br><span class="line">    self.dtype = self.imgs[<span class="number">0</span>].dtype</span><br><span class="line">    <span class="keyword">if</span> self.dtype == np.uint8: self.<span class="built_in">range</span> = (<span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">    <span class="keyword">else</span>: self.<span class="built_in">range</span> = self.get_updown(<span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;one&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> self.dtype == np.uint8:</span><br><span class="line">        self.chan_range = [(<span class="number">0</span>, <span class="number">255</span>)] * self.channels</span><br><span class="line">    <span class="keyword">else</span>: self.chan_range = self.get_updown(<span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, step=<span class="number">512</span>)</span><br><span class="line">    self.chan = (<span class="number">0</span>, [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>])[self.channels==<span class="number">3</span>]</span><br></pre></td></tr></table></figure>
<p>针对于上述图像，经过初始化后，其对应的ImagePlus的各个属性值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">self.is3d =  <span class="literal">False</span></span><br><span class="line">self.size =  (<span class="number">300</span>, <span class="number">300</span>)</span><br><span class="line">self.<span class="built_in">type</span> =  <span class="number">8</span>-bit</span><br><span class="line">self.imgs[<span class="number">0</span>].shape =  (<span class="number">300</span>, <span class="number">300</span>)</span><br><span class="line">self.channels =  <span class="number">1</span></span><br><span class="line">self.dtype =  uint8</span><br><span class="line">self.chan =  <span class="number">0</span></span><br><span class="line">self.chan_range =  [(<span class="number">0</span>, <span class="number">255</span>)]</span><br><span class="line">self.<span class="built_in">range</span> =  (<span class="number">0</span>, <span class="number">255</span>)</span><br></pre></td></tr></table></figure>
<p>如果是使用ImagePy源码里的new_plg，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wx,os</span><br><span class="line"><span class="keyword">from</span> imagepy.ui.canvasframe <span class="keyword">import</span> CanvasFrame</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> imagepy <span class="keyword">import</span> IPy</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> imagepy.core.engine <span class="keyword">import</span> Free</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plugin</span>(<span class="params">Free</span>):</span></span><br><span class="line">    title = <span class="string">&#x27;New&#x27;</span></span><br><span class="line">    para = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;Undefined&#x27;</span>,<span class="string">&#x27;width&#x27;</span>:<span class="number">300</span>, <span class="string">&#x27;height&#x27;</span>:<span class="number">300</span>, <span class="string">&#x27;type&#x27;</span>:<span class="string">&#x27;8-bit&#x27;</span>,<span class="string">&#x27;slice&#x27;</span>:<span class="number">1</span>&#125;</span><br><span class="line">    view = [(<span class="built_in">str</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            (<span class="built_in">int</span>, <span class="string">&#x27;width&#x27;</span>,  (<span class="number">1</span>,<span class="number">10240</span>), <span class="number">0</span>,  <span class="string">&#x27;width&#x27;</span>, <span class="string">&#x27;pix&#x27;</span>),</span><br><span class="line">            (<span class="built_in">int</span>, <span class="string">&#x27;height&#x27;</span>, (<span class="number">1</span>,<span class="number">10240</span>), <span class="number">0</span>,  <span class="string">&#x27;height&#x27;</span>, <span class="string">&#x27;pix&#x27;</span>),</span><br><span class="line">            (<span class="built_in">list</span>, <span class="string">&#x27;type&#x27;</span>, [<span class="string">&#x27;8-bit&#x27;</span>,<span class="string">&#x27;RGB&#x27;</span>], <span class="built_in">str</span>, <span class="string">&#x27;Type&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            (<span class="built_in">int</span>, <span class="string">&#x27;slice&#x27;</span>,  (<span class="number">1</span>,<span class="number">2048</span>), <span class="number">0</span>,  <span class="string">&#x27;slice&#x27;</span>, <span class="string">&#x27;&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="comment">#process</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, para = <span class="literal">None</span></span>):</span></span><br><span class="line">        w, h = para[<span class="string">&#x27;width&#x27;</span>], para[<span class="string">&#x27;height&#x27;</span>]</span><br><span class="line">        channels = (<span class="number">1</span>,<span class="number">3</span>)[para[<span class="string">&#x27;type&#x27;</span>]==<span class="string">&#x27;RGB&#x27;</span>]</span><br><span class="line">        slices = para[<span class="string">&#x27;slice&#x27;</span>]</span><br><span class="line">        shape = (h,w,channels) <span class="keyword">if</span> channels!=<span class="number">1</span> <span class="keyword">else</span> (h,w)</span><br><span class="line">        imgs = [np.zeros(shape, dtype=np.uint8) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(slices)]</span><br><span class="line">        IPy.show_img(imgs, para[<span class="string">&#x27;name&#x27;</span>])</span><br></pre></td></tr></table></figure>
<p>且此时设定Type为RGB、slice为2，那么此时图像的各个ImagePlus属性值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">self.is3d =  <span class="literal">False</span></span><br><span class="line">self.size =  (<span class="number">300</span>, <span class="number">300</span>)</span><br><span class="line">self.<span class="built_in">type</span> =  rgb</span><br><span class="line">self.imgs[<span class="number">0</span>].shape =  (<span class="number">300</span>, <span class="number">300</span>, <span class="number">3</span>)</span><br><span class="line">self.channels =  <span class="number">3</span></span><br><span class="line">self.dtype =  uint8</span><br><span class="line">self.chan =  [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">self.chan_range =  [(<span class="number">0</span>, <span class="number">255</span>), (<span class="number">0</span>, <span class="number">255</span>), (<span class="number">0</span>, <span class="number">255</span>)]</span><br><span class="line">self.<span class="built_in">range</span> =  (<span class="number">0</span>, <span class="number">255</span>)</span><br></pre></td></tr></table></figure>
<p>这里插一句，上面的插件的run()函数中判断channels的值的语句为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channels = (<span class="number">1</span>,<span class="number">3</span>)[para[<span class="string">&#x27;type&#x27;</span>]==<span class="string">&#x27;RGB&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>这是Python的一种特殊的条件表达式，称为元组条件表达式，即(X, Y)[C]，如果C为False，则返回X，如果C为True，则返回Y，这是因为在Python中，True等于1，而False等于0，这就相当于在元组中使用0和1来选取数据。<br>元组条件表达式在这里是没有问题的，但下面的两篇文章有个提醒，在使用这样的条件表达式时，需要注意如下问题，即元组是提前构建数据，则X和Y会提前运行，然后再用True(1)/False(0)来索引到数据。如果X和Y是比较耗资源的运算，则会开销比较大，另外如果有异常运算，也会直接报错。此时建议使用X if C else Y的条件表达式形式。<br><a target="_blank" rel="noopener" href="https://oldj.net/blog/2010/10/17/python-ternary-operator/">Python中的三元操作</a><br><a target="_blank" rel="noopener" href="https://wiki.jikexueyuan.com/project/interpy-zh/ternary_operators/ternary_operators.html">三元运算符</a></p>
<p>回到两张图像的对比，可以看出对于一张8-bit的只有一个slice的图像与一张RGB的有两个slices的图像来说，两者的图像类型type、图像矩阵的shape、通道标识chan、通道范围chan_range都是不同的。<br>这里再插一句，对于ImagePlus类的range和img属性，ImagePy采取了既非普通属性、又非方法调用的方式来设定和读取，即property装饰器的方法，这样的好处有两点：（1）相比于普通的属性，这样可以进行参数检查，保证安全性和合理性；（2）相比于set()和get()这样的配对函数，这样的方式又更加简洁。其实原理就是property装饰器将一个getter方法变成了属性，同时生成了一个setter装饰器，负责将setter方法变成属性赋值。对比img和range这两个属性，可以发现，range有property和相应的setter装饰器，而img只有property装饰器，这表明range是可读可写，而img是只读方式。这里的知识点见廖大爷的如下教程：<br><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017502538658208">使用@property</a></p>
<p>另外，这个img属性的具体定义：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">img</span>(<span class="params">self</span>):</span><span class="keyword">return</span> self.imgs[self.cur]</span><br></pre></td></tr></table></figure>
<p>可以看出，img具体调用的是哪个图像还与当前的游标有关。</p>
<h1 id="Canvas画布"><a href="#Canvas画布" class="headerlink" title="Canvas画布"></a>Canvas画布</h1><p>继续回到IPy，可以看出构造了ImagePlus类型的ips后，就继续调用IPy的showips()函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">showips(ips)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showips</span>(<span class="params">ips</span>):</span></span><br><span class="line">    <span class="keyword">if</span> uimode()==<span class="string">&#x27;ipy&#x27;</span>:</span><br><span class="line">        <span class="keyword">from</span> .ui.canvasframe <span class="keyword">import</span> CanvasPanel</span><br><span class="line">        canvasp = CanvasPanel(curapp.canvasnb)</span><br><span class="line">        canvasp.set_ips(ips)</span><br><span class="line">        curapp.canvasnb.add_page( canvasp, ips)</span><br><span class="line">        <span class="comment">#canvasp.canvas.initBuffer()</span></span><br><span class="line">        curapp.auimgr.Update()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> uimode()==<span class="string">&#x27;ij&#x27;</span>:</span><br><span class="line">        <span class="keyword">from</span> .ui.canvasframe <span class="keyword">import</span> CanvasFrame</span><br><span class="line">        frame = CanvasFrame(curapp)</span><br><span class="line">        frame.set_ips(ips)</span><br><span class="line">        frame.Show()</span><br></pre></td></tr></table></figure>
<p>根据当前的UI界面是ImagePy风格还是ImageJ风格，来以不同的方式显示图像。其实ImageJ风格的CanvasFrame也是调用了ImagePy自定义的CanvasPanel，它是一张张图像分成不同的窗口显示，而ImagePy风格的显示方式是以标签页的形式聚合显示不同图像，即传入CanvasPanel的是curapp.canvasnb，查看这个canvasnb即可知道，它是CanvasNoteBook类型的数据，其派生自wx.lib.agw.aui.AuiNotebook。<br>CanvasPanel又调用了同级目录canvas下的Canvas类，前面已经提到，该类已经从ImagePy中解耦，可以作为独立组件运行。<br>Canvas类的运行过程乍一看不好理解，其实它是利用了wxPython的SizeEvent：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    self.bindEvents()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bindEvents</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">for</span> event, handler <span class="keyword">in</span> [ \</span><br><span class="line">            (wx.EVT_SIZE, self.on_size)]:</span><br><span class="line">        self.Bind(event, handler)</span><br></pre></td></tr></table></figure>
<p>即当窗口绘制时，就会调用on_size()函数，然后就会执行一系列的绘图等操作。<br>ImagePy的Canvas是个定制的wxPython Panel，它显示图像的基本原理是利用wxPython的GDI接口，具体是wxPython的BufferedDC，以及其DrawBitmap()函数。</p>
<p>当创建Canvas对象后，接着就是将图像传入其中，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CanvasPanel设置ips</span></span><br><span class="line">canvasp.set_ips(ips)</span><br><span class="line"></span><br><span class="line"><span class="comment"># CanvasFrame设置ips，实际也是调用的CanvasPanel</span></span><br><span class="line">frame.set_ips(ips)</span><br></pre></td></tr></table></figure>
<p>然后就是将这些Panel显示出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># imagepy风格的Panel显示</span></span><br><span class="line">curapp.canvasnb.add_page( canvasp, ips)</span><br><span class="line">curapp.auimgr.Update()</span><br><span class="line"></span><br><span class="line"><span class="comment"># imagej风格的Panel显示</span></span><br><span class="line">frame.Show()</span><br></pre></td></tr></table></figure>
<p>以imagej风格为例（因为它相对简单，直接Show()出来，没有标签页那些东西需要分析），当Show()方法（这是wxPython的每个frame显示时都要调用的方法）被调用时，就会产生“激活”事件（wx.ActivateEvent），即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">self.Bind(wx.EVT_ACTIVATE, self.on_valid)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_valid</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    <span class="keyword">if</span> event.GetActive():</span><br><span class="line">        ImageManager.add(self.canvaspanel.ips)</span><br><span class="line">        WindowsManager.add(self.canvaspanel)</span><br></pre></td></tr></table></figure>
<p>一旦被激活，可以看出，此时接着就会将当前的ips和当前的panel加入到ImageManager管理器和WindowsManager管理器中。<br>下面就以ImageManager为例详细分析一下管理器的运行路径。</p>
<h1 id="ImageManager管理器"><a href="#ImageManager管理器" class="headerlink" title="ImageManager管理器"></a>ImageManager管理器</h1><p>管理器是 ImagePy 里很重要的一个概念，作为插件系统，各个部件都是松散耦合。而管理器的作用就是全局协调。（语出上面的参考文献）<br>先来看一下ImageManager的全貌：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageManager</span>:</span></span><br><span class="line">    imgs = []</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">cls, ips</span>):</span></span><br><span class="line">        …       </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove</span>(<span class="params">cls, ips</span>):</span></span><br><span class="line">        …           </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">cls, title=<span class="literal">None</span></span>):</span></span><br><span class="line">        …         </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_titles</span>(<span class="params">cls</span>):</span></span><br><span class="line">        …       </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span>(<span class="params">cls, name</span>):</span></span><br><span class="line">        …</span><br></pre></td></tr></table></figure>
<p>首先注意到这个类与之前类的定义的一个很大不同就是每个方法前面都加了classmethod修饰符，这样的好处是调用这些方法时不需要实例化，不需要 self 参数，但第一个参数需要是表示自身类的 cls 参数，可以来调用类的属性，类的方法，实例化对象等。参考资料有：<br><a target="_blank" rel="noopener" href="http://www.runoob.com/python/python-func-classmethod.html">Python classmethod 修饰符</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/handsomekang/article/details/9615239">飘逸的python - @staticmethod和@classmethod的作用与区别</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/28010894">正确理解Python中的 @staticmethod@classmethod方法</a></p>
<p>然后具体看一下add()方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">cls, ips</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ips in add() = &quot;</span>, ips)</span><br><span class="line">    cls.remove(ips)</span><br><span class="line">    callback = <span class="keyword">lambda</span> a: cls.remove(a())</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">a</span>):</span></span><br><span class="line">        cls.remove(a())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;~~~ ~~~ image add!&#x27;</span>)</span><br><span class="line">    cls.imgs.insert(<span class="number">0</span>, weakref.ref(ips, callback))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;~~~ ~~~ ImageManager = &quot;</span>, cls.imgs)</span><br><span class="line"></span><br><span class="line"><span class="meta">@classmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span>(<span class="params">cls, ips</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cls.imgs:</span><br><span class="line">        <span class="keyword">if</span> i() == ips:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;ips in remove() = &quot;</span>, ips)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;~~~ ~~~ !!! remove imgs !!!&quot;</span>)</span><br><span class="line">            cls.imgs.remove(i)</span><br></pre></td></tr></table></figure>
<p>add()首先就调用了该类的remove()方法，在这个方法里会判断该图像ips是否在ImageManager的imgs列表中，如果有则删除。<br>插一句，这个remove方法不只是在add()中调用，在关闭某张图像时，也会调用，因为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">self.Bind(wx.EVT_CLOSE, self.on_close)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_close</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    WindowsManager.remove(self.canvaspanel)</span><br><span class="line">    ImageManager.remove(self.canvaspanel.ips)</span><br><span class="line">    self.canvaspanel.ips = <span class="literal">None</span></span><br><span class="line">    self.canvaspanel.back = <span class="literal">None</span></span><br><span class="line">    event.Skip()</span><br></pre></td></tr></table></figure>
<p>然后定义了一个lambda表达式，虽然它是匿名函数，但是这里还是给它取了个名字callback，那其实这里有个问题需要后续研究一下，即这个lambda表达式与下面接着的显式定义的callback()函数有何不同。。。这个地方没明白，留作后续详细解读。。<br>插一句lambda表达式的知识点，见：<br><a target="_blank" rel="noopener" href="https://foofish.net/lambda.html">什么时候使用Lambda函数？</a></p>
<p>然后就是将当前图像ips插入到imgs列表中，这里用到了weakref弱引用，参考资料见：<br><a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/library/weakref.html">weakref — 弱引用</a><br><a target="_blank" rel="noopener" href="https://xrlin.github.io/python%E4%B8%AD%E7%9A%84weakref(%E5%BC%B1%E5%BC%95%E7%94%A8)/">python中的weakref(弱引用)</a><br><a target="_blank" rel="noopener" href="https://learnku.com/docs/pymotw/weakref-a-weak-reference-to-an-object/3372">3.9. weakref — 实现对象的弱引用</a><br>引用上面资料中对weakref的用途：</p>
<blockquote>
<p> python使用weakref模块可以实现对象的弱引用，python中的垃圾回收机制是通过对象的引用计数来触发的，当对象间有相互引用时，垃圾回收会失败，这时可以使用weakref模块实现对象的弱引用，给对象设置弱引用并不会增加对象的引用计数，所以不会影响内存的回收，同时也正是因为弱引用不会增加对象的 引用计数，弱引用并不能保证原对象存在，弱引用的初衷是为了在进行大对象处理时实现缓存机制，比如从而节省资源占用，比如当你需要处理大量的二进制图片文件对象时，为了方便读写，我们需要进行一个图片名称到图片对象的映射，如果使用字典进行存储对象和名称的映射的存储，那么在程序运行期间，所有的图片对象都不会被销毁，因为此时对象已经作为dict对象中的key或者value，这就造成了过多的资源消耗，若此时使用weakref模块的WeakKeyDictionary和WeakValueDictionary类对对象进行弱引用，则可以减少资源占用，方便进行内存回收。</p>
</blockquote>
<blockquote>
<p>回调函数callback的用途：在引用 「死亡」 并且没有其他引用指向原始对象的时候将引用对象作为参数传递给回调函数。这个功能的一种应用方法是从缓存中删除弱引用对象。</p>
</blockquote>
<p>有一点需要额外注意的是，使用weakref.ref()获得对象引用后，下面调用时需要加上括号才能获得原对象，如果是使用weakref.proxy()获得引用，则调用时不需要加上括号。</p>
<p>下面做一个测试，看看上面的代码中的print信息都有啥。<br>具体操作是这样的：先新建一个图像，名为Undefined，然后再新建一个图像，名为Undefined-1，然后关闭Undefined-1。<br>操作下来，print的信息如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ips <span class="keyword">in</span> add() =  &lt;imagepy.core.wraper.imageplus.ImagePlus <span class="built_in">object</span> at <span class="number">0x000002914889F5C0</span>&gt;</span><br><span class="line">~~~ ~~~ image add!</span><br><span class="line">~~~ ~~~ ImageManager =  [&lt;weakref at <span class="number">0x0000029148895548</span>; to <span class="string">&#x27;ImagePlus&#x27;</span> at <span class="number">0x000002914889F5C0</span>&gt;]</span><br><span class="line"></span><br><span class="line">ips <span class="keyword">in</span> add() =  &lt;imagepy.core.wraper.imageplus.ImagePlus <span class="built_in">object</span> at <span class="number">0x0000029148883198</span>&gt;</span><br><span class="line">~~~ ~~~ image add!</span><br><span class="line">~~~ ~~~ ImageManager =  [&lt;weakref at <span class="number">0x00000291447469A8</span>; to <span class="string">&#x27;ImagePlus&#x27;</span> at <span class="number">0x0000029148883198</span>&gt;, &lt;weakref at <span class="number">0x0000029148895548</span>; to <span class="string">&#x27;ImagePlus&#x27;</span> at <span class="number">0x000002914889F5C0</span>&gt;]</span><br><span class="line"> </span><br><span class="line">ips <span class="keyword">in</span> remove() =  &lt;imagepy.core.wraper.imageplus.ImagePlus <span class="built_in">object</span> at <span class="number">0x0000029148883198</span>&gt;</span><br><span class="line">~~~ ~~~ !!! remove imgs !!!</span><br><span class="line">ips <span class="keyword">in</span> add() =  &lt;imagepy.core.wraper.imageplus.ImagePlus <span class="built_in">object</span> at <span class="number">0x000002914889F5C0</span>&gt;</span><br><span class="line">ips <span class="keyword">in</span> remove() =  &lt;imagepy.core.wraper.imageplus.ImagePlus <span class="built_in">object</span> at <span class="number">0x000002914889F5C0</span>&gt;</span><br><span class="line">~~~ ~~~ !!! remove imgs !!!</span><br><span class="line">~~~ ~~~ image add!</span><br><span class="line">~~~ ~~~ ImageManager =  [&lt;weakref at <span class="number">0x0000029148895548</span>; to <span class="string">&#x27;ImagePlus&#x27;</span> at <span class="number">0x000002914889F5C0</span>&gt;]</span><br></pre></td></tr></table></figure>
<p>从打印信息就可以一目了然地知道运行路径，即先add一张图像，然后再add另一张图像，这样ImageManager中就有两张图像引用，然后再remove第二张图像，这里注意，其实remove掉第二张照片后，第一张照片又会被add一下，然后再被remove，然后再insert到列表中，就像最后几行所示。原因就是因为第二张图像被删掉后，第一张图像的Canvas组件又被activated激活了，然后就会再调用add()方法。<br>其实不光是删掉图像后会激活另一张图像，也可以通过点击另一张图像来激活它，就会发现上面的过程又会重复一遍，即先删除图像，再添加它，这样带来的效果就是当前被激活的图像始终在ImageManager的imgs列表的第一个。<br>设计巧妙啊！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/09/30/ImagePy_7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/30/ImagePy_7/" class="post-title-link" itemprop="url">ImagePy解析：7 -- ImagePy插件运行解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-09-30 00:00:00" itemprop="dateCreated datePublished" datetime="2019-09-30T00:00:00+08:00">2019-09-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/09/30/ImagePy_7/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/09/30/ImagePy_7/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>%%%%%%%%%%%% 更新日志 %%%%%%%%%%%%%<br>2019-10-13 更新：修正之前关于自定义控件的Bind()函数的解释、增加对GUI界面绘制的理解<br>2019-10-4 更新：增加参数对话框ParaDiglog部分的解析<br>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</p>
<p>参考文献：<br><a target="_blank" rel="noopener" href="https://github.com/Image-Py/demoplugin/blob/master/READMECN.md">Demo Plugin</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25483752">ImagePy开发文档 —— 自由引擎</a></p>
<p>这一篇解析ImagePy的插件的编写规则、运行机理。</p>
<h1 id="ImagePy的自由引擎Free-engine解析"><a href="#ImagePy的自由引擎Free-engine解析" class="headerlink" title="ImagePy的自由引擎Free engine解析"></a>ImagePy的自由引擎Free engine解析</h1><p>在<a target="_blank" rel="noopener" href="http://qixinbo.info/2019/03/17/ImagePy_1/">第一篇解析</a>中已提到，ImagePy提前定义了多种引擎，来作为插件的基类，如Filter类作为滤波器基类。这里通过解析Free引擎来研究ImagePy的插件运行原理。Free引擎是与图像本身相关性最弱的一个引擎，它仅仅是用来完成一个任务，如打开、新建图像，打开主题帮助，查看版本信息等操作（语出上面的参考文献）。</p>
<p>Free引擎的源码为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Free</span>:</span></span><br><span class="line">    title = <span class="string">&#x27;Free&#x27;</span></span><br><span class="line">    view = <span class="literal">None</span></span><br><span class="line">    para = <span class="literal">None</span></span><br><span class="line">    prgs = (<span class="literal">None</span>, <span class="number">1</span>)</span><br><span class="line">    asyn = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">progress</span>(<span class="params">self, i, n</span>):</span></span><br><span class="line">        self.prgs = (i, n)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, para=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;this is a plugin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runasyn</span>(<span class="params">self, para, callback=<span class="literal">None</span></span>):</span></span><br><span class="line">        TaskManager.add(self)</span><br><span class="line">        start = time()</span><br><span class="line">        self.run(para)</span><br><span class="line">        IPy.set_info(<span class="string">&#x27;%s: cost %.3fs&#x27;</span>%(self.title, time()-start))</span><br><span class="line">        TaskManager.remove(self)</span><br><span class="line">        <span class="keyword">if</span> callback!=<span class="literal">None</span>:callback()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load</span>(<span class="params">self</span>):</span><span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.view==<span class="literal">None</span>:<span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">with</span> ParaDialog(WindowsManager.get(), self.title) <span class="keyword">as</span> dialog:</span><br><span class="line">            dialog.init_view(self.view, self.para, <span class="literal">False</span>, <span class="literal">True</span>)</span><br><span class="line">            doc = self.__doc__ <span class="keyword">or</span> <span class="string">&#x27;### Sorry\nNo document yet!&#x27;</span></span><br><span class="line">            dialog.on_help = <span class="keyword">lambda</span> : IPy.show_md(self.title, DocumentManager.get(self.title))</span><br><span class="line">            <span class="keyword">return</span> dialog.ShowModal() == wx.ID_OK</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self, para=<span class="literal">None</span>, callback=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.load():</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> para!=<span class="literal">None</span> <span class="keyword">or</span> self.show():</span><br><span class="line">            <span class="keyword">if</span> para==<span class="literal">None</span>:</span><br><span class="line">                para = self.para</span><br><span class="line">            win = WidgetsManager.getref(<span class="string">&#x27;Macros Recorder&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> win!=<span class="literal">None</span>:</span><br><span class="line">                win.write(<span class="string">&#x27;&#123;&#125;&gt;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.title, para))</span><br><span class="line">            <span class="keyword">if</span> self.asyn <span class="keyword">and</span> IPy.uimode()!=<span class="string">&#x27;no&#x27;</span>:</span><br><span class="line">                threading.Thread(target = self.runasyn, args = (para, callback)).start()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.runasyn(para, callback)</span><br></pre></td></tr></table></figure>
<h2 id="title属性"><a href="#title属性" class="headerlink" title="title属性"></a>title属性</h2><p>title是插件的标题，将作为菜单栏的显示、交互对话框的标题，以及插件管理器中的主键。<br>比如作为菜单栏的显示时，就是pluginloader中的以下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buildItem</span>(<span class="params">parent, root, item</span>):</span></span><br><span class="line">    LanguageManager.add(item.title)</span><br><span class="line">    title = LanguageManager.get(item.title) <span class="keyword">if</span> sc==<span class="literal">None</span> <span class="keyword">else</span> LanguageManager.get(item.title)+<span class="string">&#x27;\t&#x27;</span>+sc</span><br><span class="line">    mi = wx.MenuItem(root, -<span class="number">1</span>, title)</span><br></pre></td></tr></table></figure>
<h2 id="para和view属性"><a href="#para和view属性" class="headerlink" title="para和view属性"></a>para和view属性</h2><p>定义函数需要的参数及交互方式，两者默认都为None，表示没有参数，也不需要交互</p>
<h2 id="show-方法"><a href="#show-方法" class="headerlink" title="show()方法"></a>show()方法</h2><p>弹出交互对话框，一般时候我们只需要设定para和view，Filter会自动调用ParaDialog 生成交互对话框，但必要时，可以覆盖 show()方法。<br>这里默认的show()方法中会先查看self.view是否为None，如果view为None，即不交互，则返回True，即使view有值，即有交互，那么在蹦出对话框后，如果后面点击了OK按钮，那么也会使得self.show()返回true。</p>
<h2 id="run-方法"><a href="#run-方法" class="headerlink" title="run()方法"></a>run()方法</h2><p>核心函数，para 将作为参数传入，在这里做你想要做的。</p>
<h2 id="load-方法"><a href="#load-方法" class="headerlink" title="load()方法"></a>load()方法</h2><p>如果return结果为False，插件将中止执行。默认返回True，如有必要，可以对其进行重载，进行一系列条件检验，如不满足，IPy.alert弹出提示，并返回False。</p>
<h2 id="start-方法"><a href="#start-方法" class="headerlink" title="start()方法"></a>start()方法</h2><p>启动函数。之所以会启动，就是因为之前在创建菜单时的按键绑定：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buildItem</span>(<span class="params">parent, root, item</span>):</span></span><br><span class="line">    ...</span><br><span class="line">    mi = wx.MenuItem(root, -<span class="number">1</span>, title)</span><br><span class="line">    parent.Bind(wx.EVT_MENU, <span class="keyword">lambda</span> x, p=item:p().start(), mi)</span><br><span class="line">    root.Append(mi)</span><br></pre></td></tr></table></figure>
<p>具体看一下start函数是怎么运行的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self, para=<span class="literal">None</span>, callback=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.load():<span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> para!=<span class="literal">None</span> <span class="keyword">or</span> self.show():</span><br><span class="line">        <span class="keyword">if</span> para==<span class="literal">None</span>:para = self.para</span><br><span class="line">        win = WidgetsManager.getref(<span class="string">&#x27;Macros Recorder&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> win!=<span class="literal">None</span>:</span><br><span class="line">            win.write(<span class="string">&#x27;&#123;&#125;&gt;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.title, para))</span><br><span class="line">        <span class="keyword">if</span> self.asyn <span class="keyword">and</span> IPy.uimode()!=<span class="string">&#x27;no&#x27;</span>:</span><br><span class="line">            threading.Thread(target = self.runasyn, args = (para, callback)).start()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.runasyn(para, callback)</span><br></pre></td></tr></table></figure>
<p>首先判断self.load()，如果特定插件有重载这个函数，那么就会执行。继续往下，判断para是否不为None或者self.show()是否为True，如果两者有其一满足，则继续往下走，然后就会以新开一个线程或在这个线程下直接运行self.runasyn()，这个函数就会继续调用self.run()方法。</p>
<p>下面通过三个基于Free引擎的三个事例插件详细探究。 </p>
<h1 id="跟世界打招呼"><a href="#跟世界打招呼" class="headerlink" title="跟世界打招呼"></a>跟世界打招呼</h1><p>下面是最简单的ImagePy向世界打招呼的方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> imagepy.core.engine <span class="keyword">import</span> Free</span><br><span class="line"><span class="keyword">from</span> imagepy <span class="keyword">import</span> IPy</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plugin</span>(<span class="params">Free</span>):</span></span><br><span class="line">    title = <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, para=<span class="literal">None</span></span>):</span></span><br><span class="line">        IPy.alert(<span class="string">&#x27;Hello World, I am ImagePy!&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>这里就是重定义了title属性，以及run()方法，调用了IPy的alert()方法，以publisher和subscriber的方式发送和接收一个alert消息，蹦出一个wxPython的MessageDialog对话框。<br>注意这个地方除了蹦出这个对话框，还有一个变化，即因为是通过runasyn()方法调用的run()方法，所以runasyn()方法中的另外的语句也会执行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runasyn</span>(<span class="params">self, para, callback=<span class="literal">None</span></span>):</span></span><br><span class="line">    TaskManager.add(self)</span><br><span class="line">    start = time()</span><br><span class="line">    self.run(para)</span><br><span class="line">    IPy.set_info(<span class="string">&#x27;%s: cost %.3fs&#x27;</span>%(self.title, time()-start))</span><br><span class="line">    TaskManager.remove(self)</span><br><span class="line">    <span class="keyword">if</span> callback!=<span class="literal">None</span>:callback()</span><br></pre></td></tr></table></figure>
<p>即还会调用IPy的set_info()方法，然后因为curapp已传入当前的ImagePy这个Frame，所以会调用它的set_info()方法，效果就是在最下面的状态栏上打出”Hello World: cost 0.000s”的字样。</p>
<h1 id="你是谁"><a href="#你是谁" class="headerlink" title="你是谁"></a>你是谁</h1><p>“你是谁”这个插件可以展示怎样与插件进行交互。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> imagepy.core.engine <span class="keyword">import</span> Free</span><br><span class="line"><span class="keyword">from</span> imagepy <span class="keyword">import</span> IPy</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plugin</span>(<span class="params">Free</span>):</span></span><br><span class="line">    title = <span class="string">&#x27;Who Are You&#x27;</span></span><br><span class="line">    para = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;age&#x27;</span>:<span class="number">0</span>&#125;</span><br><span class="line">    view = [(<span class="built_in">str</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;please&#x27;</span>),</span><br><span class="line">            (<span class="built_in">int</span>, <span class="string">&#x27;age&#x27;</span>, (<span class="number">0</span>,<span class="number">120</span>), <span class="number">0</span>, <span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;years old&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, para=<span class="literal">None</span></span>):</span></span><br><span class="line">        IPy.alert(<span class="string">&#x27;Name:\t%s\r\nAge:\t%d&#x27;</span>%(para[<span class="string">&#x27;name&#x27;</span>], para[<span class="string">&#x27;age&#x27;</span>]))</span><br></pre></td></tr></table></figure>
<p>注意此时设置了para和view都不为None，那么在start()方法中，就会因为view有值而进入交互模式，弹出一个对话框，这个对话框也是定制的，基类是wxPython的Diglog类。para是接收的具体参数，view来控制这个对话框的显示样式。</p>
<p>那么这个对话框是如何自定义接收参数的界面并传递参数的呢，一切要从free引擎的show()方法入手：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">if</span> self.view==<span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">with</span> ParaDialog(WindowsManager.get(), self.title) <span class="keyword">as</span> dialog:</span><br><span class="line">        dialog.init_view(self.view, self.para, <span class="literal">False</span>, <span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> dialog.ShowModal() == wx.ID_OK</span><br></pre></td></tr></table></figure>
<p>ParaDialog就是那个定制的基于wxPython Dialog类的对话框类，它负责解析“你是谁”插件中的para和view参数。<br>首先看它的入口函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_view</span>(<span class="params">self, items, para, preview=<span class="literal">False</span>, modal = <span class="literal">True</span></span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;*********Enter init_view ********&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;para = &quot;</span>, para)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;items = &quot;</span>, items)</span><br><span class="line">    self.para = para</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;item = &quot;</span>, item)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Ctrl = &quot;</span>, widgets[item[<span class="number">0</span>]])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;key = &quot;</span>, item[<span class="number">1</span>])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;pre/postfix = &quot;</span>, item[<span class="number">2</span>:])</span><br><span class="line">        self.add_ctrl_(widgets[item[<span class="number">0</span>]], item[<span class="number">1</span>], item[<span class="number">2</span>:])</span><br></pre></td></tr></table></figure>

<p>针对于“你是谁”插件，上面的一系列print输出就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">*********Enter init_view ********</span><br><span class="line">para =  &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">0</span>&#125; </span><br><span class="line">items =  [(&lt;class &#x27;str&#x27;&gt;, &#x27;name&#x27;, &#x27;name&#x27;, &#x27;please&#x27;), (&lt;class &#x27;int&#x27;&gt;, &#x27;age&#x27;, (0, 120), 0, &#x27;age&#x27;, &#x27;years old&#x27;)]</span><br><span class="line">item =  (&lt;class &#x27;str&#x27;&gt;, &#x27;name&#x27;, &#x27;name&#x27;, &#x27;please&#x27;)</span><br><span class="line">Ctrl =  &lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">imagepy</span>.<span class="title">ui</span>.<span class="title">widgets</span>.<span class="title">normal</span>.<span class="title">TextCtrl</span>&#x27;&gt;</span></span><br><span class="line">key =  name</span><br><span class="line">pre/postfix =  (<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;please&#x27;</span>)</span><br><span class="line">item =  (&lt;class &#x27;int&#x27;&gt;, &#x27;age&#x27;, (0, 120), 0, &#x27;age&#x27;, &#x27;years old&#x27;)</span><br><span class="line">Ctrl =  &lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">imagepy</span>.<span class="title">ui</span>.<span class="title">widgets</span>.<span class="title">normal</span>.<span class="title">NumCtrl</span>&#x27;&gt;</span></span><br><span class="line">key =  age</span><br><span class="line">pre/postfix =  ((<span class="number">0</span>, <span class="number">120</span>), <span class="number">0</span>, <span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;years old&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>可以看出，它将view的每个元组的第一项都解析成了它自定义的类，比如imagepy.ui.widgets.normal.TextCtrl和imagepy.ui.widgets.normal.NumCtrl，具体的解析关系就是在panelconfig.py的最上面的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">widgets = &#123; <span class="string">&#x27;ctrl&#x27;</span>:<span class="literal">None</span>, <span class="string">&#x27;slide&#x27;</span>:FloatSlider, <span class="built_in">int</span>:NumCtrl,</span><br><span class="line">            <span class="built_in">float</span>:NumCtrl, <span class="string">&#x27;lab&#x27;</span>:Label, <span class="built_in">bool</span>:Check, <span class="built_in">str</span>:TextCtrl,</span><br><span class="line">            <span class="built_in">list</span>:Choice, <span class="string">&#x27;img&#x27;</span>:ImageList, <span class="string">&#x27;tab&#x27;</span>:TableList, <span class="string">&#x27;color&#x27;</span>:ColorCtrl,</span><br><span class="line">            <span class="string">&#x27;any&#x27;</span>:AnyType, <span class="string">&#x27;chos&#x27;</span>:Choices, <span class="string">&#x27;fields&#x27;</span>:TableFields,</span><br><span class="line">            <span class="string">&#x27;field&#x27;</span>:TableField, <span class="string">&#x27;hist&#x27;</span>:HistCanvas, <span class="string">&#x27;cmap&#x27;</span>:ColorMap&#125;</span><br></pre></td></tr></table></figure>
<p>它是一个字典，因此很容易就将key-value对应起来。<br>注意，这个地方在接收输入参数时，还有一个特别灵巧的地方：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_ctrl_</span>(<span class="params">self, Ctrl, key, p</span>):</span></span><br><span class="line">    ctrl = Ctrl(self, *p)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p[<span class="number">0</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        self.ctrl_dic[key] = ctrl</span><br></pre></td></tr></table></figure>
<p>因为不同类型的输入框需要不同数目的参数，比如接收字符串文本时，需要有名称和单位这样的提示语，那么就需要定义prefix和suffix，如果接收数值，还需要定义数值范围、精度等信息，因此参数的数目是不固定的，这里就运用了Python的可变参数的功能，这里使用一个星号来接收不定长度的元组参数（还可以用两个星号来接收不同长度的字典参数）。关于可变长参数，如下是一篇很好的教程：<br><a target="_blank" rel="noopener" href="https://n3xtchen.github.io/n3xtchen/python/2014/08/08/python-args-and-kwargs">Python 优雅的使用参数 - 可变参数（*args &amp; **kwargs)</a><br>同时add_ctrl_()的接下来一句话将不同的组件与key相联系起来，key参数是view与para联系的纽带，如reset()方法中所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset</span>(<span class="params">self, para=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> para!=<span class="literal">None</span>:self.para = para</span><br><span class="line">    <span class="comment">#print(para, &#x27;====&#x27;)</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">list</span>(self.para.keys()):</span><br><span class="line">        <span class="keyword">if</span> p <span class="keyword">in</span> self.ctrl_dic:</span><br><span class="line">            self.ctrl_dic[p].SetValue(self.para[p])</span><br></pre></td></tr></table></figure>
<p>通过查看是否两者都有相同的key，来读取para中的value大小并赋值给相应的对话框。<br>再总结一下“你是谁”插件中view的写法：<br>str：用于接收文本字符串，view中的用法为：(str, key, prefix, suffix)，key是para中的key，prefix和suffix分别是输入框前后的提示内容，如title和unit；<br>int：用于接收整型数值，view中的用法为：(int, key, (lim1, lim2), accu, ‘prefix’, ‘suffix’)，其中key是para中的key，limit用于限定输入数值的范围，accu限定小数点位数，prefix和suffix用作输入框前后的提示内容。</p>
<p>以下部分的解析之前有误，感谢霄龙哥的讲解~~</p>
<p>ImagePy自定义的比如TextCtrl、NumCtrl等都是在wxPython标准组件上的组合。比如，自定义的TextCtrl是StaticText、标准组件TextCtrl和另外一个StaticText的组合。查看这个自定义的TextCtrl，可以发现有两个Bind()绑定：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    self.ctrl.Bind(wx.EVT_KEY_UP, self.ontext)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Bind</span>(<span class="params">self, z, f</span>):</span>self.f = f  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ontext</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    self.f(event)</span><br></pre></td></tr></table></figure>
<p>第一个Bind是对该自定义的TextCtrl中的标准TextCtrl组件的绑定，第二个是对该自定义的TextCtrl自身的绑定。<br>这个地方的运行原理是这样的：标准TextCtrl等输入框都绑定了按键弹起EVT_KEY_UP这个事件，即任何一个键弹起时，都会触发ontext()方法，这个方法又调用了self.f()方法，那么self.f()方法是怎样的？其实就是第二行的Bind()函数，它在ParaDiglog类中是这样执行的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_ctrl_</span>(<span class="params">self, Ctrl, key, p</span>):</span></span><br><span class="line">    ctrl = Ctrl(self, *p)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p[<span class="number">0</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        self.ctrl_dic[key] = ctrl</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(ctrl, <span class="string">&#x27;Bind&#x27;</span>):</span><br><span class="line">        ctrl.Bind(<span class="literal">None</span>, self.para_changed)</span><br></pre></td></tr></table></figure>
<p>即如果该面板中添加的组件有Bind()函数，那么就调用它的Bind()函数，将ParaDialog的para_changed()方法传入，即将它赋值给了自定义TextCtrl的self.f()方法，所以，上面的ontext就是实际执行了para_changed()方法。<br>因为自定义的TextCtrl基于wxPython的Panel类，其实仔细查看Panel类的继承关系就知道，wx.Panel继承自wx.Window，wx.Window又继承自wx.EventHandler，而wx.EventHandler中有Bind()函数，其定义为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Bind(self, event, handler, source=<span class="literal">None</span>, <span class="built_in">id</span>=wx.ID_ANY, id2=wx.ID_ANY)</span><br></pre></td></tr></table></figure>
<p>因此，自定义TextCtrl中的这个Bind()方法就是对它的重载：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Bind</span>(<span class="params">self, z, f</span>):</span>self.f = f</span><br></pre></td></tr></table></figure>
<p>即z就是个事件event，f就是句柄或称事件处理函数handler。因此，调用Bind()的时候就是给定两个参数，一个是event，一个是handler。</p>
<p>这个地方龙哥又延伸了一下：</p>
<blockquote>
<p>其实所有的控件，本质上都是GDI draw出来的（查看ImagePy的Histgram的panel就知道都是调用了GDI绘图），包括按钮、选项卡和文本框等等。<br>所有的控件本质上都是一个panel，可以draw自己（根据数据进行draw），也可以响应事件（基础事件也只有鼠标点击和键盘，具体是哪个键则是操作系统维护的）。所以，控件的核心就是数据关联，然后draw和Bind。<br>举个例子：ImagePy的表格控件，也只是一个panel，要做的事情就是关联数据、维护表格行列宽度、绘制滚动条，然后计算显示的范围、绘制行列分割线、绘制每个单元格的值。然后重载鼠标单击事件，对外暴露成一个Bind，关联一个特殊的标识符，比如叫wx.EVT_Cell_Clicked，然后根据鼠标点击的x和y，计算出对应的单元格，然后高亮绘制，看起来就像是选中了。<br>没有现成的控件，就要从panel开始重载（自己动手、丰衣足食）。</p>
</blockquote>
<h1 id="问卷调查"><a href="#问卷调查" class="headerlink" title="问卷调查"></a>问卷调查</h1><p>这个插件详细说明了怎样设置参数和定制对话框样式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> imagepy.core.engine <span class="keyword">import</span> Free</span><br><span class="line"><span class="keyword">from</span> imagepy <span class="keyword">import</span> IPy</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plugin</span>(<span class="params">Free</span>):</span></span><br><span class="line">    title = <span class="string">&#x27;Questionnaire&#x27;</span></span><br><span class="line"></span><br><span class="line">    para = &#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;yxdragon&#x27;</span>, <span class="string">&#x27;age&#x27;</span>:<span class="number">10</span>, <span class="string">&#x27;h&#x27;</span>:<span class="number">1.72</span>, <span class="string">&#x27;w&#x27;</span>:<span class="number">70</span>, <span class="string">&#x27;sport&#x27;</span>:<span class="literal">True</span>, <span class="string">&#x27;sys&#x27;</span>:<span class="string">&#x27;Mac&#x27;</span>, <span class="string">&#x27;lan&#x27;</span>:[<span class="string">&#x27;C/C++&#x27;</span>, <span class="string">&#x27;Python&#x27;</span>], <span class="string">&#x27;c&#x27;</span>:(<span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>)&#125;</span><br><span class="line"></span><br><span class="line">    view = [(<span class="string">&#x27;lab&#x27;</span>, <span class="string">&#x27;lab&#x27;</span>, <span class="string">&#x27;This is a questionnaire&#x27;</span>),</span><br><span class="line">            (<span class="built_in">str</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;please&#x27;</span>),</span><br><span class="line">            (<span class="built_in">int</span>, <span class="string">&#x27;age&#x27;</span>, (<span class="number">0</span>,<span class="number">150</span>), <span class="number">0</span>, <span class="string">&#x27;age&#x27;</span>, <span class="string">&#x27;years old&#x27;</span>),</span><br><span class="line">            (<span class="built_in">float</span>, <span class="string">&#x27;h&#x27;</span>, (<span class="number">0.3</span>, <span class="number">2.5</span>), <span class="number">2</span>, <span class="string">&#x27;height&#x27;</span>, <span class="string">&#x27;m&#x27;</span>),</span><br><span class="line">            (<span class="string">&#x27;slide&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, (<span class="number">1</span>, <span class="number">150</span>), <span class="number">0</span>, <span class="string">&#x27;kg&#x27;</span>),</span><br><span class="line">            (<span class="built_in">bool</span>, <span class="string">&#x27;sport&#x27;</span>, <span class="string">&#x27;do you like sport&#x27;</span>),</span><br><span class="line">            (<span class="built_in">list</span>, <span class="string">&#x27;sys&#x27;</span>, [<span class="string">&#x27;Windows&#x27;</span>,<span class="string">&#x27;Mac&#x27;</span>,<span class="string">&#x27;Linux&#x27;</span>], <span class="built_in">str</span>, <span class="string">&#x27;favourite&#x27;</span>, <span class="string">&#x27;system&#x27;</span>),</span><br><span class="line">            (<span class="string">&#x27;chos&#x27;</span>, <span class="string">&#x27;lan&#x27;</span>, [<span class="string">&#x27;C/C++&#x27;</span>,<span class="string">&#x27;Java&#x27;</span>,<span class="string">&#x27;Python&#x27;</span>], <span class="string">&#x27;lanuage you like(multi)&#x27;</span>),</span><br><span class="line">            (<span class="string">&#x27;color&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;which&#x27;</span>, <span class="string">&#x27;you like&#x27;</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, para=<span class="literal">None</span></span>):</span></span><br><span class="line">        rst = [<span class="string">&#x27;Questionnaire Result&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Name:%s&#x27;</span>%para[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;Age:%s&#x27;</span>%para[<span class="string">&#x27;age&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;Height:%sm&#x27;</span>%para[<span class="string">&#x27;h&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;Weight:%skg&#x27;</span>%para[<span class="string">&#x27;w&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;Like Sport:%s&#x27;</span>%para[<span class="string">&#x27;sport&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;Favourite System:%s&#x27;</span>%para[<span class="string">&#x27;sys&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;Like lanuage:%s&#x27;</span>%para[<span class="string">&#x27;lan&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;Favourite Color:%s&#x27;</span>%<span class="built_in">str</span>(para[<span class="string">&#x27;c&#x27;</span>])]</span><br><span class="line"></span><br><span class="line">        IPy.alert(<span class="string">&#x27;\r\n&#x27;</span>.join(rst))</span><br></pre></td></tr></table></figure>
<p>首先，para就是一个python字典，里面就是一系列的key-value键值对。<br>view是一个列表，具体格式得按照一定的规则。明天就是70周年国庆了，这里先将格式要求抄录如下，后面再详细分析。<br>lab: para类型：不需要参数, view用法：(‘lab’, ‘lab’, ‘what you want to show’)<br>str: para类型：str, view用法：(str, key, prefix, suffix)，其中key要和para中的key对应，prefix，suffix用作输入框前后的提示内容。<br>int: para类型：int，view用法：(int, key, (lim1, lim2), accu, ‘prefix’, ‘suffix’)，其中key要和para中的key对应，limit用于限定输入数值的范围，accu限定小数点位数(0)，prefix，suffix用作输入框前后的提示内容。<br>float: para类型：float，view用法：(int, key, (lim1, lim2), accu, ‘prefix’, ‘suffix’)，其中key要和para中的key对应，limit用于限定输入数值的范围，accu限定小数点位数，prefix，suffix用作输入框前后的提示内容。<br>slider: para类型：int/float，view用法：(‘slide’, key, (lim1, lim2), accu, ‘prefix’)，其中key要和para中的key对应，limit用于限定输入数值的范围，accu限定小数点位数，prefix用作输入框前后的提示内容。<br>bool: para类型：bool，view用法：(bool, ‘key’, ‘label’)，其中key要和para中的key对应，label用作提示。<br>list: para类型：any type，view用法：(list, key, [choices], type, prefix, suffix)，其中key要和para中的key对应，choices是字符选项，type是期望输出类型，如str, int，prefix，suffix用作选择框前后的提示内容。<br>choices: para类型：str list，view用法：(‘chos’, key, [choices], prefix, suffix)，与list类似，不同的是choices可以支持多选，选项以list of string形式记录。<br>color: para类型：(r,g,b) 0-255，用法：(‘color’, key, prefix, suffix)，其中key要和para中的key对应，prefix，suffix用作输入框前后的提示内容。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/09/07/ImagePy_6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/07/ImagePy_6/" class="post-title-link" itemprop="url">ImagePy解析：6 -- wxPython GDI绘图和FloatCanvas</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-09-07 00:00:00" itemprop="dateCreated datePublished" datetime="2019-09-07T00:00:00+08:00">2019-09-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/09/07/ImagePy_6/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/09/07/ImagePy_6/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>序言：<br>本文的成文与ImagePy没有直接关系，但有相当大的间接关系。起因是我在自己的程序中想集成一个可以自由缩放且绘点的画布工具，发现ImagePy的canvas能够很好地满足需求，但无奈ImagePy的源码看不懂，自己想抽离这个canvas也没抽离出来。后经霄龙提醒，发现wxPython的FloatCanvas也有这些基本功能，所以就有了对FloatCanvas和wxPython GDI绘图进行学习的本文。<br>更让人欣喜的是，在我弄懂了FloatCanvas的用法、且实现一个基础demo之际，霄龙将ImagePy中的canvas迅速剥离了出来，可以单独调用，同时提供了掩膜模式，可以更好地进行像素标注。官方一出手，就知有没有！<br>终于可以愉快地进行数据标注了～～</p>
<p>参考文献：<br><a target="_blank" rel="noopener" href="http://zetcode.com/wxpython/gdi/">wxPython graphics</a><br><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/svn2github/wxPython/master/3rdParty/branches/FloatCanvas/SOC2008_FloatCanvas/floatcanvas2/docs/tutorial/FloatCanvas%20Tutorial.txt">FloatCanvas2 tutorial</a><br><a target="_blank" rel="noopener" href="https://wxpython.org/Phoenix/docs/html/wx.lib.floatcanvas.html">wx.lib.floatcanvas</a><br><a target="_blank" rel="noopener" href="https://github.com/wxWidgets/Phoenix/tree/master/samples/floatcanvas">Phoenix/samples/floatcanvas/</a></p>
<h1 id="wxPython-GDI绘图概述"><a href="#wxPython-GDI绘图概述" class="headerlink" title="wxPython GDI绘图概述"></a>wxPython GDI绘图概述</h1><p>GDI是图形设备接口Graphics Device Interface的缩写，主要任务是负责系统与绘图程序之间的信息交换，GDI的出现使程序员无需要关心硬件设备及设备正常驱动，就可以将应用程序的输出转化为硬件设备上的输出和构成，实现了程序开发者与硬件设备的隔离，大大方便了开发工作。上述介绍见<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/GDI/3123145">百度百科-GDI</a>。<br>从编程角度来看，GDI是一组与图像打交道的类和方法，其包括二维矢量图、字体和位图。<br>在绘图之前，需要先创建一个设备上下文Device Context对象。在wxPython中，称为wx.DC，但它不能直接调用，需要使用它的一系列的派生类才行。比如：<br>（1）wx.ScreenPC：可以在屏幕的任意位置绘图；<br>（2）wx.ClientDC：用来在窗口的工作区绘图，即去除窗口的标题和边框；<br>（3）wx.PaintDC：也在窗口的工作区绘图，但与ClientDC的不同点在于：PaintDC仅能在wx.PaintEvent中使用，而ClientDC不能在wx.PaintEvent中使用；<br>（4）wx.MemoryDC：用来在位图上绘图；<br>（5）wx.PostScriptDC：用于输出PostScript文件；</p>
<p>此外，还有wx.BufferedDC、wxBufferedPaintDC等。</p>
<h2 id="wxPython-GDI绘图入门"><a href="#wxPython-GDI绘图入门" class="headerlink" title="wxPython GDI绘图入门"></a>wxPython GDI绘图入门</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ZetCode wxPython tutorial</span></span><br><span class="line"><span class="string">This program draws a line in</span></span><br><span class="line"><span class="string">a paint event.</span></span><br><span class="line"><span class="string">author: Jan Bodnar</span></span><br><span class="line"><span class="string">website: zetcode.com</span></span><br><span class="line"><span class="string">last edited: May 2018</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kw</span>):</span></span><br><span class="line">        <span class="built_in">super</span>(Example, self).__init__(*args, **kw)</span><br><span class="line">        self.InitUI()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">InitUI</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.Bind(wx.EVT_PAINT, self.OnPaint)</span><br><span class="line">        self.SetTitle(<span class="string">&quot;Line&quot;</span>)</span><br><span class="line">        self.Centre()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnPaint</span>(<span class="params">self, e</span>):</span></span><br><span class="line">        dc = wx.PaintDC(self)</span><br><span class="line">        dc.DrawLine(<span class="number">50</span>, <span class="number">60</span>, <span class="number">190</span>, <span class="number">60</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    app = wx.App()</span><br><span class="line">    ex = Example(<span class="literal">None</span>)</span><br><span class="line">    ex.Show()</span><br><span class="line">    app.MainLoop()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h2 id="设备上下文的属性"><a href="#设备上下文的属性" class="headerlink" title="设备上下文的属性"></a>设备上下文的属性</h2><p>设备上下文有很多属性，比如画刷、画笔和字体。<br>（1）画刷wx.Brush是用来填充某个形状的背景，它需要颜色color和样式style，比如设置某一颜色wx.Brush(‘#c56c00’)；<br>（2）画笔wx.Pen是用来绘制形状的轮廓，它需要colour、width和style，比如wx.Pen(‘#4c4c4c’, 1, wx.LONG_DASH)；<br>（3）字体wx.Font是用来定义文本的外观。</p>
<p>可以通过设定这些属性来控制所绘图形的样式，比如DrawPoint时点的颜色就是使用了当前画笔的颜色。<br>wxPython的GDI绘图需要了解很多非常细节的地方，且其通常绘制在一个基础的panel上，能实现基本功能，但功能不强大。下面的FloatCanvas是一个集成在wxPython中的第三方库，试图进一步提高wxPython的绘图功能</p>
<h1 id="FloatCanvas概述"><a href="#FloatCanvas概述" class="headerlink" title="FloatCanvas概述"></a>FloatCanvas概述</h1><p>FloatCanvas是一个用来在任意坐标系中绘制矢量图的窗口类，由Chris Barker编写和维护，其目的是为了提供一个简便地在屏幕上绘图的工具，有很多优点：<br>（1）有一整套完备的鼠标事件和回调机制用来响应用户的点击等操作，且很容易地转换在不同坐标系中转换坐标；<br>（2）提供虚拟的无限缩放、平移功能，为用户处理好重绘等操作；<br>（3）用户无需了解wxWindows的画刷、画笔及色彩等，即FloatCanvas比wx.DC容易使用得多。<br>该类存在于wx.lib.floatcanvas包中，该包还有另外一个重要模块NavCanvas.py，其是对FloatCanvas的一个封装，额外提供了一个操控画布的工具条，比如缩放、平移等；另外，Resources.py模块中包含了FloatCanvas所需的一些资源，如图标等。</p>
<h2 id="绘制图形"><a href="#绘制图形" class="headerlink" title="绘制图形"></a>绘制图形</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"><span class="keyword">from</span> wx.lib.floatcanvas <span class="keyword">import</span> FloatCanvas</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DrawFrame</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        wx.Frame.__init__(self, *args, **kwargs)</span><br><span class="line">        self.Canvas = FloatCanvas.FloatCanvas(self, -<span class="number">1</span>,</span><br><span class="line">                                     size=(<span class="number">500</span>, <span class="number">500</span>),</span><br><span class="line">                                     ProjectionFun=<span class="literal">None</span>,</span><br><span class="line">                                     Debug=<span class="number">0</span>,</span><br><span class="line">                                     BackgroundColor=<span class="string">&quot;White&quot;</span>,</span><br><span class="line">                                     )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add a circle</span></span><br><span class="line">        cir = FloatCanvas.Circle((<span class="number">10</span>, <span class="number">10</span>), <span class="number">100</span>)</span><br><span class="line">        self.Canvas.AddObject(cir)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add a rectangle</span></span><br><span class="line">        rect = FloatCanvas.Rectangle((<span class="number">110</span>, <span class="number">10</span>), (<span class="number">100</span>, <span class="number">100</span>), FillColor=<span class="string">&#x27;Red&#x27;</span>)</span><br><span class="line">        self.Canvas.AddObject(rect)</span><br><span class="line">        self.Canvas.Draw()</span><br><span class="line">app = wx.App()</span><br><span class="line">frame = DrawFrame(<span class="literal">None</span>)</span><br><span class="line">frame.Show()</span><br><span class="line">app.MainLoop()</span><br></pre></td></tr></table></figure>

<p>运行结果就是在画布上画了一个空心圆和填充红色矩形。<br>上述代码时先建立某一个FloatCanvas的图形对象，如FloatCanvas.Circle，然后通过AddObject添加进去。<br>也可以直接采用更简单的API，如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.Canvas.AddCircle((<span class="number">10</span>, <span class="number">10</span>), <span class="number">100</span>)</span><br><span class="line">self.Canvas.AddRectangle((<span class="number">110</span>, <span class="number">10</span>), (<span class="number">100</span>, <span class="number">100</span>), FillColor=<span class="string">&#x27;Red&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>其他图形的API可仿照以上样式在github的samples中查找。</p>
<h2 id="加上NavCanvas导航条"><a href="#加上NavCanvas导航条" class="headerlink" title="加上NavCanvas导航条"></a>加上NavCanvas导航条</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"><span class="keyword">from</span> wx.lib.floatcanvas <span class="keyword">import</span> NavCanvas, FloatCanvas</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DrawFrame</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        wx.Frame.__init__(self, *args, **kwargs)</span><br><span class="line">        <span class="comment"># Add the Canvas</span></span><br><span class="line">        Canvas = NavCanvas.NavCanvas(self,-<span class="number">1</span>,</span><br><span class="line">                                     size = (<span class="number">500</span>,<span class="number">500</span>),</span><br><span class="line">                                     ProjectionFun = <span class="literal">None</span>,</span><br><span class="line">                                     Debug = <span class="number">0</span>,</span><br><span class="line">                                     BackgroundColor = <span class="string">&quot;DARK SLATE BLUE&quot;</span>,</span><br><span class="line">                                     ).Canvas</span><br><span class="line"></span><br><span class="line">        Rect = Canvas.AddRectangle((<span class="number">50</span>, <span class="number">20</span>), (<span class="number">40</span>,<span class="number">10</span>), FillColor=<span class="string">&quot;Red&quot;</span>, LineStyle = <span class="literal">None</span>)</span><br><span class="line">        Rect.MinSize = <span class="number">4</span> <span class="comment"># default is 1</span></span><br><span class="line">        Rect.DisappearWhenSmall = <span class="literal">False</span> <span class="comment"># defualt is True</span></span><br><span class="line"></span><br><span class="line">        self.Show()</span><br><span class="line">        Canvas.ZoomToBB()</span><br><span class="line"></span><br><span class="line">app = wx.App(<span class="literal">False</span>)</span><br><span class="line">F = DrawFrame(<span class="literal">None</span>, title=<span class="string">&quot;FloatCanvas Demo App&quot;</span>, size=(<span class="number">700</span>,<span class="number">700</span>) )</span><br><span class="line">app.MainLoop()</span><br></pre></td></tr></table></figure>
<p>其作用就是加上NavCanvans导航条，从而可以缩放、平移画布。<br>查看NavCanvas源码后就可以发现，它里面其实已经引用了FloatCanvas，所以这里不用显式地调用FloatCanvas。</p>
<h2 id="获取鼠标坐标"><a href="#获取鼠标坐标" class="headerlink" title="获取鼠标坐标"></a>获取鼠标坐标</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"><span class="keyword">from</span> wx.lib.floatcanvas <span class="keyword">import</span> NavCanvas, FloatCanvas</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DrawFrame</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        wx.Frame.__init__(self, *args, **kwargs)</span><br><span class="line">        self.CreateStatusBar()</span><br><span class="line">        <span class="comment"># Add the Canvas</span></span><br><span class="line">        Canvas = NavCanvas.NavCanvas(self,-<span class="number">1</span>,</span><br><span class="line">                                     size = (<span class="number">500</span>,<span class="number">500</span>),</span><br><span class="line">                                     ProjectionFun = <span class="literal">None</span>,</span><br><span class="line">                                     Debug = <span class="number">0</span>,</span><br><span class="line">                                     BackgroundColor = <span class="string">&quot;DARK SLATE BLUE&quot;</span>,</span><br><span class="line">                                     ).Canvas</span><br><span class="line">        self.Canvas = Canvas</span><br><span class="line">        self.Canvas.Bind(FloatCanvas.EVT_MOTION, self.OnMove )</span><br><span class="line">        Rect = Canvas.AddRectangle((<span class="number">50</span>, <span class="number">20</span>), (<span class="number">40</span>,<span class="number">10</span>), FillColor=<span class="string">&quot;Red&quot;</span>, LineStyle = <span class="literal">None</span>)</span><br><span class="line">        Rect.MinSize = <span class="number">4</span> <span class="comment"># default is 1</span></span><br><span class="line">        Rect.DisappearWhenSmall = <span class="literal">False</span> <span class="comment"># defualt is True</span></span><br><span class="line">        self.Show()</span><br><span class="line">        Canvas.ZoomToBB()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnMove</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Coords = &quot;</span>, event.Coords)</span><br><span class="line">        self.SetStatusText(<span class="string">&quot;%.2f, %.2f&quot;</span>%<span class="built_in">tuple</span>(event.Coords))</span><br><span class="line"></span><br><span class="line">app = wx.App(<span class="literal">False</span>)</span><br><span class="line">F = DrawFrame(<span class="literal">None</span>, title=<span class="string">&quot;FloatCanvas Demo App&quot;</span>, size=(<span class="number">700</span>,<span class="number">700</span>) )</span><br><span class="line">app.MainLoop()</span><br></pre></td></tr></table></figure>
<p>注意，上述代码中使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event.Coords</span><br></pre></td></tr></table></figure>

<p>获取了鼠标的坐标，这其实是鼠标在世界坐标系中的位置。<br>在立体视觉中，有四个坐标系需要明确，一个详细的说明见：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011574296/article/details/73658560">世界坐标系、相机坐标系、图像坐标系、像素坐标系之间的关系</a><br>摘抄如下：<br>（1）世界坐标系：<br>客观三维世界的绝对坐标系，也称客观坐标系。因为数码相机安放在三维空间中，我们需要世界坐标系这个基准坐标系来描述数码相机的位置，并且用它来描述安放在此三维环境中的其它任何物体的位置，用（X, Y, Z）表示其坐标值。<br>（2）相机坐标系（光心坐标系）：<br>以相机的光心为坐标原点，X 轴和Y 轴分别平行于图像坐标系的 X 轴和Y 轴，相机的光轴为Z 轴，用（Xc, Yc, Zc）表示其坐标值。<br>（3）图像坐标系：<br>以CCD 图像平面的中心为坐标原点，X轴和Y 轴分别平行于图像平面的两条垂直边，用( x , y )表示其坐标值。图像坐标系是用物理单位（例如毫米）表示像素在图像中的位置。<br>（4）像素坐标系：<br>以 CCD 图像平面的左上角顶点为原点，X 轴和Y 轴分别平行于图像坐标系的 X 轴和Y 轴，用(u , v )表示其坐标值。数码相机采集的图像首先是形成标准电信号的形式，然后再通过模数转换变换为数字图像。每幅图像的存储形式是M × N的数组，M 行 N 列的图像中的每一个元素的数值代表的是图像点的灰度。这样的每个元素叫像素，像素坐标系就是以像素为单位的图像坐标系。</p>
<p>获取像素坐标系的方法就是调用wxpython的原生方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event.GetPosition()</span><br></pre></td></tr></table></figure>
<p>注意GetPosition与上面的Coords的区别：<br>（1）Coords是事件event的属性，不是一个方法，所以没有括号，且它的返回值是一个长度为2的numpy数组；<br>（2）GetPosition()是事件event的方法，所以需要括号，且它的返回值是一个wx.Point类型的数据，可以通过wx.Point.x和wx.Point.y来具体获取整型的像素坐标。</p>
<p>FloatCanvas也提供了API进行世界坐标系与像素坐标系的转换，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;mouse in pixel coordinates = &quot;</span>, event.GetPosition())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;mouse in world coordinates = &quot;</span>, event.Coords)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;pixel2world = &quot;</span>, self.Canvas.PixelToWorld(event.GetPosition()))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;world2pixel = &quot;</span>, self.Canvas.WorldToPixel(event.Coords))</span><br></pre></td></tr></table></figure>

<p>这个地方需要特别注意的是，图像在这些坐标系中的xy表示顺序与OpenCV中的xy表示顺序是反的，这是因为图像在屏幕上的表示是先列后行，而图像被OpenCV读入后，是一个先行后列的数组，取得某一点时，先取行号，再取列号。比如在屏幕上使用鼠标点击获得的坐标点是(x, y)，那么实际这个像素点在OpenCV中的位置是(y, x)，即是在对角线的另一侧。</p>
<h2 id="缩放位图"><a href="#缩放位图" class="headerlink" title="缩放位图"></a>缩放位图</h2><p>这个例子介绍了怎样在FloatCanvas中缩放位图：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line">ImageFile = <span class="string">&quot;white_tank.jpg&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> wx.lib.floatcanvas <span class="keyword">import</span> NavCanvas, FloatCanvas</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DrawFrame</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        wx.Frame.__init__(self, *args, **kwargs)</span><br><span class="line">        self.CreateStatusBar()</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># Add the Canvas</span></span><br><span class="line">        Canvas = NavCanvas.NavCanvas(self,</span><br><span class="line">                                     ProjectionFun = <span class="literal">None</span>,</span><br><span class="line">                                     BackgroundColor = <span class="string">&quot;White&quot;</span>,</span><br><span class="line">                                     ).Canvas</span><br><span class="line">        Canvas.MaxScale=<span class="number">20</span> <span class="comment"># sets the maximum zoom level</span></span><br><span class="line">        self.Canvas = Canvas</span><br><span class="line">        self.Canvas.Bind(FloatCanvas.EVT_MOTION, self.OnMove )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create the image:</span></span><br><span class="line">        image = wx.Image(ImageFile)</span><br><span class="line">        self.width, self.height = image.GetSize()</span><br><span class="line">        img = FloatCanvas.ScaledBitmap2( image,</span><br><span class="line">                                        (<span class="number">0</span>,<span class="number">0</span>),</span><br><span class="line">                                        Height=image.GetHeight(),</span><br><span class="line">                                        Position = <span class="string">&#x27;tl&#x27;</span>,</span><br><span class="line">                                        )</span><br><span class="line">        Canvas.AddObject(img)</span><br><span class="line">        self.Show()</span><br><span class="line">        Canvas.ZoomToBB()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnMove</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        self.SetStatusText(<span class="string">&quot;%i, %i&quot;</span>%<span class="built_in">tuple</span>(event.Coords))</span><br><span class="line"></span><br><span class="line">app = wx.App(<span class="literal">False</span>)</span><br><span class="line">F = DrawFrame(<span class="literal">None</span>, title=<span class="string">&quot;FloatCanvas Demo App&quot;</span>, size=(<span class="number">700</span>,<span class="number">700</span>) )</span><br><span class="line">app.MainLoop()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/09/01/ImagePy_5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/01/ImagePy_5/" class="post-title-link" itemprop="url">ImagePy解析：5 -- wxPython多线程编程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-09-01 00:00:00" itemprop="dateCreated datePublished" datetime="2019-09-01T00:00:00+08:00">2019-09-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/09/01/ImagePy_5/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/09/01/ImagePy_5/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考文献：<br><a target="_blank" rel="noopener" href="http://www.liujiangblog.com/course/python/79">多线程threading</a><br><a target="_blank" rel="noopener" href="https://www.amazon.com/wxPython-Recipes-Problem-Solution-Approach/dp/1484232364">wxPython Recipes: A Problem - Solution Approach</a></p>
<p>本篇是对上面这两个参考文章的摘抄学习，第一篇博客介绍了Python怎样多线程编程，第二个是本书，介绍了wxPython怎样多线程编程，实际是在Python多线程编程的基础上开展的。<br>ImagePy也是这样的多线程编程思路，所以本篇可以作为理解ImagePy的辅助材料。</p>
<h1 id="Python多线程threading"><a href="#Python多线程threading" class="headerlink" title="Python多线程threading"></a>Python多线程threading</h1><p>在Python3中，通过threading模块提供线程的功能。原来的thread模块已废弃。但是threading模块中有个Thread类（大写的T，类名），是模块中最主要的线程类。<br>对于Thread类，它的定义如下：<br>threading.Thread(self, group=None, target=None, name=None, args=(), kwargs=None, *, daemon=None)</p>
<ul>
<li>参数group是预留的，用于将来扩展；</li>
<li>参数target是一个可调用对象，在线程启动后执行；</li>
<li>参数name是线程的名字。默认值为“Thread-N“，N是一个数字。</li>
<li>参数args和kwargs分别表示调用target时的参数列表和关键字参数。</li>
</ul>
<p>Thread类提供了以下方法和属性:</p>
<ul>
<li>start()：启动线程，等待CPU调度</li>
<li>run()：线程被cpu调度后自动执行的方法</li>
<li>getName()、setName()和name：用于获取和设置线程的名称。</li>
<li>setDaemon()：设置为后台线程或前台线程（默认是False，前台线程）。如果是后台线程，主线程执行过程中，后台线程也在进行，主线程执行完毕后，后台线程不论成功与否，均停止。如果是前台线程，主线程执行过程中，前台线程也在进行，主线程执行完毕后，等待前台线程执行完成后，程序才停止。</li>
<li>ident：获取线程的标识符。线程标识符是一个非零整数，只有在调用了start()方法之后该属性才有效，否则它只返回None。</li>
<li>is_alive()：判断线程是否是激活的（alive）。从调用start()方法启动线程，到run()方法执行完毕或遇到未处理异常而中断这段时间内，线程是激活的。</li>
<li>isDaemon()方法和daemon属性：是否为守护线程</li>
<li>join([timeout])：调用该方法将会使主调线程堵塞，直到被调用线程运行结束或超时。参数timeout是一个数值类型，表示超时时间，如果未提供该参数，那么主调线程将一直堵塞到被调线程结束。</li>
</ul>
<h2 id="创建线程"><a href="#创建线程" class="headerlink" title="创建线程"></a>创建线程</h2><p>有两种方式来创建线程：一种是继承Thread类，并重写它的run()方法；另一种是在实例化threading.Thread对象的时候，将线程要执行的任务函数作为参数传入线程。</p>
<p>第一种方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span>(<span class="params">threading.Thread</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, thread_name</span>):</span></span><br><span class="line">        <span class="comment"># 注意：一定要显式的调用父类的初始化函数。</span></span><br><span class="line">        <span class="built_in">super</span>(MyThread, self).__init__(name=thread_name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;%s正在运行中......&quot;</span> % self.name)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        MyThread(<span class="string">&quot;thread-&quot;</span> + <span class="built_in">str</span>(i)).start()</span><br></pre></td></tr></table></figure>
<p>第二种方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">arg</span>):</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;thread &#x27;</span>+<span class="built_in">str</span>(arg)+<span class="string">&quot; running....&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        t = threading.Thread(target=show, args=(i,))</span><br><span class="line">        t.start()</span><br></pre></td></tr></table></figure>

<h2 id="线程调用"><a href="#线程调用" class="headerlink" title="线程调用"></a>线程调用</h2><p>在多线程执行过程中，有一个特点要注意，那就是每个线程各执行各的任务，不等待其它的线程，自顾自的完成自己的任务，Python默认会等待最后一个线程执行完毕后才退出。比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">doWaiting</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;start waiting:&#x27;</span>, time.strftime(<span class="string">&#x27;%H:%M:%S&#x27;</span>))</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;stop waiting&#x27;</span>, time.strftime(<span class="string">&#x27;%H:%M:%S&#x27;</span>))</span><br><span class="line"></span><br><span class="line">t = threading.Thread(target=doWaiting)</span><br><span class="line">t.start()</span><br><span class="line"><span class="comment"># 确保线程t已经启动</span></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;start job&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;end job&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>上述输出为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start waiting: <span class="number">15</span>:<span class="number">27</span>:<span class="number">58</span></span><br><span class="line">start job</span><br><span class="line">end job</span><br><span class="line">stop waiting <span class="number">15</span>:<span class="number">28</span>:01</span><br></pre></td></tr></table></figure>
<p>上面例子中，主线程没有等待子线程t执行完毕，而是啥都不管，继续往下执行它自己的代码，执行完毕后也没有结束整个程序，而是等待子线程t执行完毕，整个程序才结束。</p>
<p>有时候希望主线程等等子线程，不要“埋头往前跑”。那就使用join()方法，如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">doWaiting</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;start waiting:&#x27;</span>, time.strftime(<span class="string">&#x27;%H:%M:%S&#x27;</span>))</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;stop waiting&#x27;</span>, time.strftime(<span class="string">&#x27;%H:%M:%S&#x27;</span>))</span><br><span class="line"></span><br><span class="line">t = threading.Thread(target=doWaiting)</span><br><span class="line">t.start()</span><br><span class="line"><span class="comment"># 确保线程t已经启动</span></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;start join&#x27;</span>)</span><br><span class="line"><span class="comment"># 将一直堵塞，直到t运行结束。</span></span><br><span class="line">t.join()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;end join&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>输出为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start waiting: <span class="number">15</span>:<span class="number">30</span>:<span class="number">21</span></span><br><span class="line">start join</span><br><span class="line">stop waiting <span class="number">15</span>:<span class="number">30</span>:<span class="number">24</span></span><br><span class="line">end join</span><br></pre></td></tr></table></figure>

<p>还可以使用setDaemon(True)把所有的子线程都变成主线程的守护线程，当主线程结束后，守护子线程也会随之结束，整个程序也跟着退出。如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(threading.current_thread().getName(), <span class="string">&quot;开始工作&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)       <span class="comment"># 子线程停2s</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;子线程工作完毕&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    t = threading.Thread(target=run,)</span><br><span class="line">    t.setDaemon(<span class="literal">True</span>)   <span class="comment"># 把子线程设置为守护线程，必须在start()之前设置</span></span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">1</span>)     <span class="comment"># 主线程停1秒</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;主线程结束了！&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(threading.active_count())  <span class="comment"># 输出活跃的线程数</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上述输出为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thread-<span class="number">1</span> 开始工作</span><br><span class="line">Thread-<span class="number">2</span> 开始工作</span><br><span class="line">Thread-<span class="number">3</span> 开始工作</span><br><span class="line">主线程结束了！</span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure>

<h1 id="Publish-Subscribe模式"><a href="#Publish-Subscribe模式" class="headerlink" title="Publish-Subscribe模式"></a>Publish-Subscribe模式</h1><p>Publish-Subscribe模式，即发布-订阅模式，是计算机科学中用来在一个程序中的不同部分中进行交流的常用模式。基本思想就是先创建一个或多个subscribers，然后它们会监听publisher发送的特定的消息。<br>wxPython的关于这一模式的实现就是wx.lib.pubsub，但这一API已经deprecated，现在换用PyPubSub，只需稍微把以前的import的wx.lib.pubsub改成pubsub即可。<br>一个例子是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"><span class="keyword">from</span> pubsub <span class="keyword">import</span> pub</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OtherFrame</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Constructor&quot;&quot;&quot;</span></span><br><span class="line">        wx.Frame.__init__(self, <span class="literal">None</span>, wx.ID_ANY, <span class="string">&quot;Secondary Frame&quot;</span>)</span><br><span class="line">        panel = wx.Panel(self)</span><br><span class="line"></span><br><span class="line">        msg = <span class="string">&quot;Enter a Message to send to the main frame&quot;</span></span><br><span class="line">        instructions = wx.StaticText(panel, label=msg)</span><br><span class="line">        self.msgTxt = wx.TextCtrl(panel, value=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        closeBtn = wx.Button(panel, label=<span class="string">&quot;Send and Close&quot;</span>)</span><br><span class="line">        closeBtn.Bind(wx.EVT_BUTTON, self.onSendAndClose)</span><br><span class="line"> </span><br><span class="line">        sizer = wx.BoxSizer(wx.VERTICAL)</span><br><span class="line">        flags = wx.ALL|wx.CENTER</span><br><span class="line">        sizer.Add(instructions, <span class="number">0</span>, flags, <span class="number">5</span>)</span><br><span class="line">        sizer.Add(self.msgTxt, <span class="number">0</span>, flags, <span class="number">5</span>)</span><br><span class="line">        sizer.Add(closeBtn, <span class="number">0</span>, flags, <span class="number">5</span>)</span><br><span class="line">        panel.SetSizer(sizer)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">onSendAndClose</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Send a message and close frame</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        msg = self.msgTxt.GetValue()</span><br><span class="line">        pub.sendMessage(<span class="string">&quot;panelListener&quot;</span>, message=msg)</span><br><span class="line">        pub.sendMessage(<span class="string">&quot;panelListener&quot;</span>, message=<span class="string">&quot;test2&quot;</span>, arg2=<span class="string">&quot;2nd argument!&quot;</span>)</span><br><span class="line">        self.Close()</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPanel</span>(<span class="params">wx.Panel</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Constructor&quot;&quot;&quot;</span></span><br><span class="line">        wx.Panel.__init__(self, parent)</span><br><span class="line">        pub.subscribe(self.myListener, <span class="string">&quot;panelListener&quot;</span>)</span><br><span class="line"></span><br><span class="line">        btn = wx.Button(self, label=<span class="string">&quot;Open Frame&quot;</span>)</span><br><span class="line">        btn.Bind(wx.EVT_BUTTON, self.onOpenFrame)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">myListener</span>(<span class="params">self, message, arg2=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Received the following message: &quot;</span> + message)</span><br><span class="line">        <span class="keyword">if</span> arg2:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Received another arguments: &quot;</span> + <span class="built_in">str</span>(arg2))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">onOpenFrame</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Opens secondary frame</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        frame = OtherFrame()</span><br><span class="line">        frame.Show()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFrame</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Constructor&quot;&quot;&quot;</span></span><br><span class="line">        wx.Frame.__init__(self, <span class="literal">None</span>, title=<span class="string">&quot;New PubSub API Tutorial&quot;</span>)</span><br><span class="line">        panel = MyPanel(self)</span><br><span class="line">        self.Show()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app = wx.App(<span class="literal">False</span>)</span><br><span class="line">    frame = MyFrame()</span><br><span class="line">    app.MainLoop()</span><br></pre></td></tr></table></figure>

<p>解析如下：<br>（1）首先在MyPanel类中创建subscriber：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pub.subscribe(self.myListener, <span class="string">&quot;panelListener&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>myListener函数能够接收一个或多个参数，这里设定至少接收一个参数message，以及另一个可选参数arg2。<br>然后将MyPanel中的button与onOpenFrame事件绑定，从而可以调用另一个frame。<br>（2）然后在OtherFrame类中创建publisher：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">onSendAndClose</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    msg = self.msgTxt.GetValue()</span><br><span class="line">    pub.sendMessage(<span class="string">&quot;panelListener&quot;</span>, message=msg)</span><br><span class="line">    pub.sendMessage(<span class="string">&quot;panelListener&quot;</span>, message=<span class="string">&quot;test2&quot;</span>, arg2=<span class="string">&quot;2nd argument!&quot;</span>)</span><br><span class="line">    self.Close()</span><br></pre></td></tr></table></figure>
<p>可以看出，这里定义了两个publishers，第一个发送一个参数，第二个发送两个参数。有两点需要注意：<br>一个是subscriber和publisher的事件标识是一致的，这样才能互相接收信号；第二个是在publisher中需要明确写出subscriber的形参名称，否则会报错。<br>但是，注意，pubsub不是线程安全的，需要配合下面的线程安全的方法进行服用。</p>
<h1 id="wxPython多线程编程"><a href="#wxPython多线程编程" class="headerlink" title="wxPython多线程编程"></a>wxPython多线程编程</h1><p>在wxPython中，有三种线程安全的（thread-safe）的方法：wx.PostEvent、wx.CallAfter和wx.CallLater。据Robin Dunn（wxPython的创建者）所说，wx.CallAfter调用wx.PostEvent来向一个应用对象发送事件，该应用对象将会拥有一个与该事件绑定的事件句柄，然后将根据开发者编写的代码来对事件作出反应；然后根据Mike Driscoll（wxPython Recipes这本书的作者）所理解，wx.CallLater又会调用wx.CallAfter，同时可加上一个特定的时间限制，从而可以实现在等待一定时间后再发送事件。总之，在这三个方法中，wx.CallLater是最抽象的方法，wx.CallAfter次之，wx.PostEvent则是最底层的API。</p>
<p>在wxPython的邮件列表中，推荐最多的就是使用wx.CallAfter和PubSub的组合，因此推荐使用这种方法来实现多线程。</p>
<p>一个例子如下（不适用于wxPython老版本，适用于wxPython 3.0和Phoenix版本，因为PubSub更新了API）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wxPython 3.0 and Phoenix</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> pubsub <span class="keyword">import</span> pub</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestThread</span>(<span class="params">Thread</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Test Worker Thread Class.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Init Worker Thread Class.&quot;&quot;&quot;</span></span><br><span class="line">        Thread.__init__(self)</span><br><span class="line">        self.start()    <span class="comment"># start the thread</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Run Worker Thread.&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># This is the code executing in the new thread.</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">            time.sleep(<span class="number">10</span>)</span><br><span class="line">            wx.CallAfter(self.postTime, i)</span><br><span class="line">        time.sleep(<span class="number">5</span>)</span><br><span class="line">        wx.CallAfter(pub.sendMessage, <span class="string">&quot;update&quot;</span>, msg=<span class="string">&quot;Thread finished!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">postTime</span>(<span class="params">self, amt</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Send time to GUI</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        amtOfTime = (amt + <span class="number">1</span>) * <span class="number">10</span></span><br><span class="line">        pub.sendMessage(<span class="string">&quot;update&quot;</span>, msg=amtOfTime)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyForm</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        wx.Frame.__init__(self, <span class="literal">None</span>, wx.ID_ANY, <span class="string">&quot;Tutorial&quot;</span>)</span><br><span class="line">        <span class="comment"># Add a panel so it looks the correct on all platforms</span></span><br><span class="line">        panel = wx.Panel(self, wx.ID_ANY)</span><br><span class="line">        self.displayLbl = wx.StaticText(panel,</span><br><span class="line">                                        label=<span class="string">&quot;Amount of time since thread started goes here&quot;</span>)</span><br><span class="line">        self.btn = btn = wx.Button(panel, label=<span class="string">&quot;Start Thread&quot;</span>)</span><br><span class="line">        btn.Bind(wx.EVT_BUTTON, self.onButton)</span><br><span class="line">        sizer = wx.BoxSizer(wx.VERTICAL)</span><br><span class="line">        sizer.Add(self.displayLbl, <span class="number">0</span>, wx.ALL|wx.CENTER, <span class="number">5</span>)</span><br><span class="line">        sizer.Add(btn, <span class="number">0</span>, wx.ALL|wx.CENTER, <span class="number">5</span>)</span><br><span class="line">        panel.SetSizer(sizer)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create a pubsub receiver</span></span><br><span class="line">        pub.subscribe(self.updateDisplay, <span class="string">&quot;update&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">onButton</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Runs the thread</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        TestThread()</span><br><span class="line">        self.displayLbl.SetLabel(<span class="string">&quot;Thread started!&quot;</span>)</span><br><span class="line">        btn = event.GetEventObject()</span><br><span class="line">        btn.Disable()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">updateDisplay</span>(<span class="params">self, msg</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Receives data from thread and updates the display</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        t = msg</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(t, <span class="built_in">int</span>):</span><br><span class="line">            self.displayLbl.SetLabel(<span class="string">&quot;Time since thread started: %s seconds&quot;</span> % t)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.displayLbl.SetLabel(<span class="string">&quot;%s&quot;</span> % t)</span><br><span class="line">            self.btn.Enable()</span><br><span class="line"><span class="comment"># Run the program</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app = wx.App(<span class="literal">False</span>)</span><br><span class="line">    frame = MyForm().Show()</span><br><span class="line">    app.MainLoop()</span><br></pre></td></tr></table></figure>
<p>解析如下：<br>（1）首先在MyForm中创建一个subscriber：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pub.subscribe(self.updateDisplay, <span class="string">&quot;update&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">updateDisplay</span>(<span class="params">self, msg</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Receives data from thread and updates the display</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    t = msg</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(t, <span class="built_in">int</span>):</span><br><span class="line">        self.displayLbl.SetLabel(<span class="string">&quot;Time since thread started: %s seconds&quot;</span> % t)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.displayLbl.SetLabel(<span class="string">&quot;%s&quot;</span> % t)</span><br><span class="line">        self.btn.Enable()</span><br></pre></td></tr></table></figure>
<p>它所调用的updateDisplay事件处理函数接收一个名为msg的参数，接收后则更新面板上的StaticText组件。<br>（2）通过一个按钮来开启其他线程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">btn.Bind(wx.EVT_BUTTON, self.onButton)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">onButton</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    TestThread()</span><br><span class="line">    self.displayLbl.SetLabel(<span class="string">&quot;Thread started!&quot;</span>)</span><br><span class="line">    btn = event.GetEventObject()</span><br><span class="line">    btn.Disable()</span><br></pre></td></tr></table></figure>
<p>点击MyForm上的这个按钮后，就会开启其他线程，同时将这个按钮置为不可用。<br>（3）其他线程的调用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Run Worker Thread.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># This is the code executing in the new thread.</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        time.sleep(<span class="number">10</span>)</span><br><span class="line">        wx.CallAfter(self.postTime, i)</span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">    wx.CallAfter(pub.sendMessage, <span class="string">&quot;update&quot;</span>, msg=<span class="string">&quot;Thread finished!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">postTime</span>(<span class="params">self, amt</span>):</span></span><br><span class="line">    amtOfTime = (amt + <span class="number">1</span>) * <span class="number">10</span></span><br><span class="line">    pub.sendMessage(<span class="string">&quot;update&quot;</span>, msg=amtOfTime)</span><br></pre></td></tr></table></figure>
<p>可以看出，这个新线程在做的事就是进行六次循环，每次等待10秒钟后创建一个发射器，将时间数值发送给接收器，从而更新MyForm面板上的数值。最后，发送一个名为”Thread finished!”的消息给接收器。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/08/31/ImagePy_4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/31/ImagePy_4/" class="post-title-link" itemprop="url">ImagePy解析：4 -- 主界面渲染</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-31 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-31T00:00:00+08:00">2019-08-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/08/31/ImagePy_4/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/08/31/ImagePy_4/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<br>更新日志：<br>2019-9-30 更新：<br>增加了ImageJ和ImagePy两种UI加载方式的对比</p>
<p>以下为正文<br>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</p>
<p>ImagePy的主界面就是名为ImagePy的类，这一部分详解主界面是如何渲染出来的。</p>
<h1 id="父类初始化"><a href="#父类初始化" class="headerlink" title="父类初始化"></a>父类初始化</h1><p>ImagePy这个类是继承自wxPython的Frame类，所以首先对这个类进行初始化，包括名称、尺寸、位置、样式等。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wx.Frame.__init__ ( self, parent, <span class="built_in">id</span> = wx.ID_ANY, title = <span class="string">&#x27;ImagePy&#x27;</span>,</span><br><span class="line">                    size = wx.Size(-<span class="number">1</span>,-<span class="number">1</span>), pos = wx.DefaultPosition,</span><br><span class="line">                    style = wx.RESIZE_BORDER|wx.DEFAULT_FRAME_STYLE|wx.TAB_TRAVERSAL )</span><br></pre></td></tr></table></figure>

<h1 id="创建AuiManager管理器，用来管理复杂布局"><a href="#创建AuiManager管理器，用来管理复杂布局" class="headerlink" title="创建AuiManager管理器，用来管理复杂布局"></a>创建AuiManager管理器，用来管理复杂布局</h1><p>ImagePy使用AuiManager来管理复杂界面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.auimgr = aui.AuiManager()</span><br><span class="line">self.auimgr.SetManagedWindow( self )</span><br></pre></td></tr></table></figure>
<p>Aui等于Advanced User Interface，它可以用来方便地管理多个面板，尤其是对于可停靠的（dockable）和可悬浮的（floating）的面板。<br>一个很好的关于AuiManager的教程见：<br><a target="_blank" rel="noopener" href="https://perphyliu.wordpress.com/2010/01/02/day-4-wxpython-aui%E4%BB%8B%E7%BB%8D/">Day 4: wxPython AUI介绍</a><br>其使用套路如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#（1）生成AuiManager实例：以wx.Frame或其子类的实例为参数，用来生成一个AuiManager实例以实现对该Frame实例的管理</span></span><br><span class="line">self._mgr = wx.aui.AuiManager(self)</span><br><span class="line"></span><br><span class="line"><span class="comment">#（2）添加面板：AuiManager中可以添加若干个面板；它使用AuiPaneInfo用来控制面板的位置、大小等属性</span></span><br><span class="line">text1 = wx.TextCtrl(self, -<span class="number">1</span>, <span class="string">&#x27;Pane 1 - sample text&#x27;</span>,  wx.DefaultPosition, wx.Size(<span class="number">200</span>,<span class="number">150</span>), wx.NO_BORDER | wx.TE_MULTILINE)</span><br><span class="line">self._mgr.AddPane(text1, wx.aui.AuiPaneInfo().Left().MaximizeButton(<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#（3）更新AuiManager实例：调用Update()方法将AuiManager中的面板添加到其所管理的Frame中</span></span><br><span class="line">self._mgr.Update()</span><br><span class="line"></span><br><span class="line"><span class="comment">#（4）卸载AuiManager实例：退出应用程序时应调用UnInit方法以回收资源</span></span><br><span class="line">self._mgr.UnInit()</span><br></pre></td></tr></table></figure>

<p>完整的示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"><span class="keyword">import</span> wx.aui</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFrame</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent, <span class="built_in">id</span>=-<span class="number">1</span>, title=<span class="string">&#x27;wx.aui Test&#x27;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                  pos=wx.DefaultPosition, size=(<span class="params"><span class="number">800</span>, <span class="number">600</span></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                  style=wx.DEFAULT_FRAME_STYLE</span>):</span></span><br><span class="line">            wx.Frame.__init__(self, parent, <span class="built_in">id</span>, title, pos, size, style)</span><br><span class="line">            self._mgr = wx.aui.AuiManager(self)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># create several text controls</span></span><br><span class="line">            text1 = wx.TextCtrl(self, -<span class="number">1</span>, <span class="string">&#x27;Pane 1 - sample text&#x27;</span>,</span><br><span class="line">                                wx.DefaultPosition, wx.Size(<span class="number">200</span>,<span class="number">150</span>),</span><br><span class="line">                                wx.NO_BORDER | wx.TE_MULTILINE)</span><br><span class="line"></span><br><span class="line">            text2 = wx.TextCtrl(self, -<span class="number">1</span>, <span class="string">&#x27;Pane 2 - sample text&#x27;</span>,</span><br><span class="line">                                wx.DefaultPosition, wx.Size(<span class="number">200</span>,<span class="number">150</span>),</span><br><span class="line">                                wx.NO_BORDER | wx.TE_MULTILINE)</span><br><span class="line"></span><br><span class="line">            text3 = wx.TextCtrl(self, -<span class="number">1</span>, <span class="string">&#x27;Main content window&#x27;</span>,</span><br><span class="line">                                wx.DefaultPosition, wx.Size(<span class="number">200</span>,<span class="number">150</span>),</span><br><span class="line">                                wx.NO_BORDER | wx.TE_MULTILINE)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># add the panes to the manager</span></span><br><span class="line">            self._mgr.AddPane(text1, wx.aui.AuiPaneInfo().Left().MaximizeButton(<span class="literal">True</span>))</span><br><span class="line">            self._mgr.AddPane(text2, wx.aui.AuiPaneInfo().Bottom().MaximizeButton(<span class="literal">True</span>))</span><br><span class="line">            self._mgr.AddPane(text3, wx.aui.AuiPaneInfo().Center())</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Create toolbar</span></span><br><span class="line">            toolbar = wx.ToolBar(self, -<span class="number">1</span>, wx.DefaultPosition, wx.DefaultSize,</span><br><span class="line">                             wx.TB_FLAT | wx.TB_NODIVIDER | wx.TB_HORZ_TEXT)</span><br><span class="line">            toolbar.SetToolBitmapSize(wx.Size(<span class="number">16</span>,<span class="number">16</span>))</span><br><span class="line">            toolbar_bmp1 = wx.ArtProvider.GetBitmap(wx.ART_NORMAL_FILE, wx.ART_OTHER, wx.Size(<span class="number">16</span>, <span class="number">16</span>))</span><br><span class="line">            toolbar.AddTool(<span class="number">101</span>, <span class="string">&quot;Item 1&quot;</span>, toolbar_bmp1)</span><br><span class="line">            toolbar.AddTool(<span class="number">101</span>, <span class="string">&quot;Item 2&quot;</span>, toolbar_bmp1)</span><br><span class="line">            toolbar.AddTool(<span class="number">101</span>, <span class="string">&quot;Item 3&quot;</span>, toolbar_bmp1)</span><br><span class="line">            toolbar.AddTool(<span class="number">101</span>, <span class="string">&quot;Item 4&quot;</span>, toolbar_bmp1)</span><br><span class="line">            toolbar.AddSeparator()</span><br><span class="line">            toolbar.AddTool(<span class="number">101</span>, <span class="string">&quot;Item 5&quot;</span>, toolbar_bmp1)</span><br><span class="line">            toolbar.AddTool(<span class="number">101</span>, <span class="string">&quot;Item 6&quot;</span>, toolbar_bmp1)</span><br><span class="line">            toolbar.AddTool(<span class="number">101</span>, <span class="string">&quot;Item 7&quot;</span>, toolbar_bmp1)</span><br><span class="line">            toolbar.AddTool(<span class="number">101</span>, <span class="string">&quot;Item 8&quot;</span>, toolbar_bmp1)</span><br><span class="line">            toolbar.Realize()</span><br><span class="line">            self._mgr.AddPane(toolbar, wx.aui.AuiPaneInfo().Name(<span class="string">&quot;toolbar&quot;</span>).Caption(<span class="string">&quot;Toolbar Demo&quot;</span>).ToolbarPane().Top().LeftDockable(<span class="literal">False</span>).RightDockable(<span class="literal">False</span>))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># tell the manager to &#x27;commit&#x27; all the changes just made</span></span><br><span class="line">            self._mgr.Update()</span><br><span class="line">            self.Bind(wx.EVT_CLOSE, self.OnClose)</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">OnClose</span>(<span class="params">self, event</span>):</span></span><br><span class="line">            <span class="comment"># deinitialize the frame manager</span></span><br><span class="line">            self._mgr.UnInit()</span><br><span class="line">            <span class="comment"># delete the frame</span></span><br><span class="line">            self.Destroy()</span><br><span class="line"></span><br><span class="line">app = wx.App()</span><br><span class="line">frame = MyFrame(<span class="literal">None</span>)</span><br><span class="line">frame.Show()</span><br><span class="line">app.MainLoop()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="设置图标"><a href="#设置图标" class="headerlink" title="设置图标"></a>设置图标</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">logopath = os.path.join(root_dir, <span class="string">&#x27;data/logo.ico&#x27;</span>)</span><br><span class="line">self.SetIcon(wx.Icon(logopath, wx.BITMAP_TYPE_ICO))</span><br><span class="line"></span><br><span class="line">IPy.curapp = self</span><br><span class="line"><span class="comment"># 根据UI的模式，设置窗口的最大、最小尺寸以及变化幅度。这个UI的模式是通过configmanager模块读取preference.cfg配置文件获得的。</span></span><br><span class="line">self.SetSizeHints( wx.Size(<span class="number">900</span>,<span class="number">700</span>) <span class="keyword">if</span> IPy.uimode() == <span class="string">&#x27;ipy&#x27;</span> <span class="keyword">else</span> wx.Size( <span class="number">580</span>,-<span class="number">1</span> ))</span><br></pre></td></tr></table></figure>

<h1 id="根据路径添加菜单项"><a href="#根据路径添加菜单项" class="headerlink" title="根据路径添加菜单项"></a>根据路径添加菜单项</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.menubar = pluginloader.buildMenuBarByPath(self, <span class="string">&#x27;menus&#x27;</span>, <span class="string">&#x27;plugins&#x27;</span>, <span class="literal">None</span>, <span class="literal">True</span>)</span><br><span class="line">self.SetMenuBar( self.menubar )</span><br></pre></td></tr></table></figure>
<p>这一部分是核心，详细的解析过程见本系列的第二部分。</p>
<h1 id="创建快捷键映射"><a href="#创建快捷键映射" class="headerlink" title="创建快捷键映射"></a>创建快捷键映射</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.shortcut = pluginloader.buildShortcut(self)</span><br><span class="line">self.SetAcceleratorTable(self.shortcut)</span><br></pre></td></tr></table></figure>

<h1 id="构建工具条"><a href="#构建工具条" class="headerlink" title="构建工具条"></a>构建工具条</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.toolbar = toolsloader.build_tools(self, <span class="string">&#x27;tools&#x27;</span>, <span class="string">&#x27;plugins&#x27;</span>, <span class="literal">None</span>, <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>这一部分也是核心，详细解析过程见本系列的第三部分。</p>
<h1 id="设置显示样式"><a href="#设置显示样式" class="headerlink" title="设置显示样式"></a>设置显示样式</h1><p>根据UI的模式为”ipy”或”ij”来调整UI的样式为仿ImageJ还是自带的ImagePy样式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(IPy.uimode())</span><br><span class="line"><span class="keyword">if</span> IPy.uimode()==<span class="string">&#x27;ipy&#x27;</span>: self.load_aui()</span><br><span class="line"><span class="keyword">else</span>: self.load_ijui()</span><br><span class="line">self.load_document()</span><br><span class="line">self.Fit()</span><br></pre></td></tr></table></figure>
<p>两种样式的相同点和不同点在于：<br>（1）相同点：都有菜单栏和工具栏，其中菜单栏已经在上面创建，工具栏的创建如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.auimgr.AddPane(self.toolbar, aui.AuiPaneInfo() .Left()  .PinButton( <span class="literal">True</span> )</span><br><span class="line">            .CaptionVisible( <span class="literal">True</span> ).Dock().Resizable().FloatingSize( wx.DefaultSize ).MaxSize(wx.Size( <span class="number">32</span>,-<span class="number">1</span> ))</span><br><span class="line">            . BottomDockable( <span class="literal">True</span> ).TopDockable( <span class="literal">False</span> ).Layer( <span class="number">10</span> ) )</span><br></pre></td></tr></table></figure>
<p>（2）不同点：ImagePy会显示navigator、histogram等组件。（ImageJ也会加载这些组件，但是隐藏显示）<br>首先扫描widgets文件夹下的组件，其扫描方式与plugins、tools相同。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.widgets = widgetsloader.build_widgets(self, <span class="string">&#x27;widgets&#x27;</span>, <span class="string">&#x27;plugins&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>即调用了widgetsloader的build_widgets函数，其中该函数中又接着调用了loader类下的build_widgets函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">datas = loader.build_widgets(toolspath)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;widgets = &quot;</span>, datas)</span><br></pre></td></tr></table></figure>
<p>因为widgets有两个组件：navigator和histogram，其中histogram又细分为histogram和curve两个组件，因为这一步输出的结果为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">widgets =  (&lt;module &#x27;imagepy.widgets&#x27; from &#x27;D:\\imagepy-master\\imagepy\\widgets\\__init__.py&#x27;&gt;, [(&lt;module &#x27;imagepy.widgets.histogram&#x27; from &#x27;D:\\imagepy-master\\imagepy\\widgets\\histogram\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.widgets.histogram.histogram_wgt.Plugin&#x27;&gt;, &lt;class &#x27;imagepy.widgets.histogram.curve_wgt.Plugin&#x27;&gt;]), (&lt;module &#x27;imagepy.widgets.navigator&#x27; from &#x27;D:\\imagepy-master\\imagepy\\widgets\\navigator\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.widgets.navigator.navigator_wgt.Plugin&#x27;&gt;])])</span><br></pre></td></tr></table></figure>
<p>注意，仍然是(pg, subtree)这样的返回格式。UI上使用了wxPython的Choicebook来在同一个组件类的不同插件间进行选择。navigator、histogram和curve这三个组件也都是在wxPython的Panel基础上进行定制，高级，见识了~~</p>
<h1 id="创建底部状态栏"><a href="#创建底部状态栏" class="headerlink" title="创建底部状态栏"></a>创建底部状态栏</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">self.stapanel = stapanel = wx.Panel( self, wx.ID_ANY, wx.DefaultPosition, wx.DefaultSize, wx.TAB_TRAVERSAL )</span><br><span class="line">sizersta = wx.BoxSizer( wx.HORIZONTAL )</span><br><span class="line">self.txt_info = wx.StaticText( stapanel, wx.ID_ANY, <span class="string">&quot;ImagePy  v0.2&quot;</span>, wx.DefaultPosition, wx.DefaultSize, <span class="number">0</span> )</span><br><span class="line">self.txt_info.Wrap( -<span class="number">1</span> )</span><br><span class="line"><span class="comment">#self.txt_info.SetBackgroundColour( wx.SystemSettings.GetColour( wx.SYS_COLOUR_INFOBK ) )</span></span><br><span class="line">sizersta.Add( self.txt_info, <span class="number">1</span>, wx.ALIGN_BOTTOM|wx.BOTTOM|wx.LEFT|wx.RIGHT, <span class="number">2</span> )</span><br></pre></td></tr></table></figure>
<h1 id="创建底部进度条"><a href="#创建底部进度条" class="headerlink" title="创建底部进度条"></a>创建底部进度条</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.pro_bar = wx.Gauge( stapanel, wx.ID_ANY, <span class="number">100</span>, wx.DefaultPosition, wx.Size( <span class="number">100</span>,<span class="number">15</span> ), wx.GA_HORIZONTAL )</span><br><span class="line">sizersta.Add( self.pro_bar, <span class="number">0</span>, wx.ALIGN_BOTTOM|wx.BOTTOM|wx.LEFT|wx.RIGHT, <span class="number">2</span> )</span><br><span class="line">stapanel.SetSizer(sizersta)</span><br></pre></td></tr></table></figure>

<h1 id="为底部的这个panel增加拖放文件直接打开的功能"><a href="#为底部的这个panel增加拖放文件直接打开的功能" class="headerlink" title="为底部的这个panel增加拖放文件直接打开的功能"></a>为底部的这个panel增加拖放文件直接打开的功能</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stapanel.SetDropTarget(FileDrop())</span><br><span class="line">self.auimgr.AddPane( stapanel,  aui.AuiPaneInfo() .Bottom() .CaptionVisible( <span class="literal">False</span> ).PinButton( <span class="literal">True</span> )</span><br><span class="line">    .PaneBorder( <span class="literal">False</span> ).Dock().Resizable().FloatingSize( wx.DefaultSize ).DockFixed( <span class="literal">True</span> )</span><br><span class="line">    . MinSize(wx.Size(-<span class="number">1</span>, <span class="number">20</span>)). MaxSize(wx.Size(-<span class="number">1</span>, <span class="number">20</span>)).Layer( <span class="number">10</span> ) )</span><br></pre></td></tr></table></figure>

<h1 id="更新Aui管理器"><a href="#更新Aui管理器" class="headerlink" title="更新Aui管理器"></a>更新Aui管理器</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">self.Centre( wx.BOTH )</span><br><span class="line">self.Layout()</span><br><span class="line">self.auimgr.Update()</span><br><span class="line">self.Fit()</span><br><span class="line">self.Centre( wx.BOTH )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(IPy.uimode()==<span class="string">&#x27;ij&#x27;</span>):</span><br><span class="line">    self.SetMaxSize((-<span class="number">1</span>, self.GetSize()[<span class="number">1</span>]))</span><br><span class="line">    self.SetMinSize(self.GetSize())</span><br><span class="line">self.update = <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<h1 id="绑定事件逻辑"><a href="#绑定事件逻辑" class="headerlink" title="绑定事件逻辑"></a>绑定事件逻辑</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为关闭按钮绑定on_close逻辑</span></span><br><span class="line">self.Bind(wx.EVT_CLOSE, self.on_close)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为AuiManager管理器所管理的panel的关闭按钮绑定on_pan_close逻辑，但目前发现并没有起到作用。。:(</span></span><br><span class="line">self.Bind(aui.EVT_AUI_PANE_CLOSE, self.on_pan_close)</span><br></pre></td></tr></table></figure>

<h1 id="创建并启动多线程"><a href="#创建并启动多线程" class="headerlink" title="创建并启动多线程"></a>创建并启动多线程</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">thread = threading.Thread(<span class="literal">None</span>, self.hold, ())</span><br><span class="line">thread.setDaemon(<span class="literal">True</span>)</span><br><span class="line">thread.start()</span><br></pre></td></tr></table></figure>

<p>它所执行的函数是其中的hold函数，具体涉及了ImagePy的任务管理器TaskManager，后面具体分析。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/08/30/git-multi-account/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/30/git-multi-account/" class="post-title-link" itemprop="url">Git配置单机器多账号配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-30 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-30T00:00:00+08:00">2019-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/08/30/git-multi-account/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/08/30/git-multi-account/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>参考资料：<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/d195394f7d2e">Windows下配置多个git账号的SSH Key</a><br><a target="_blank" rel="noopener" href="https://gist.github.com/suziewong/4378434">Git的多账号如何处理？</a><br><a target="_blank" rel="noopener" href="https://github.com/jawil/notes/issues/2">同一台电脑配置多个git账号</a></p>
<p>有以下两种场景需要进行区分。</p>
<h1 id="多个账号-同一邮箱"><a href="#多个账号-同一邮箱" class="headerlink" title="多个账号+同一邮箱"></a>多个账号+同一邮箱</h1><p>对于 Git 而言，邮箱是识别用户的唯一手段。因此如果在不同的代码托管服务商（GitHub、GitLab或Bitbucket）中使用同一邮箱作为账号，此时不需要担心密钥的问题，因为这些网站push pull 认证的唯一性是邮箱。此时只需生成一个通用的私钥和公钥对即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;simba@gmail.com&quot;</span><br></pre></td></tr></table></figure>
<p>此时会在用户目录的.ssh/ 下生成两个文件，id_rsa 是私钥，id_rsa.pub 是公钥，然后登陆服务器（如GitHub），将公钥中的内容添加进去即可。</p>
<h1 id="多个账号-不同邮箱"><a href="#多个账号-不同邮箱" class="headerlink" title="多个账号+不同邮箱"></a>多个账号+不同邮箱</h1><p>此时原理上就是对 SSH 协议配置 config 文件，对不同的域名采用不同的认证密钥。</p>
<h2 id="git-config-介绍"><a href="#git-config-介绍" class="headerlink" title="git config 介绍"></a>git config 介绍</h2><p>Git有一个工具被称为git config，它允许你获得和设置配置变量；这些变量可以控制Git的外观和操作的各个方面。这些变量可以被存储在三个不同的位置：<br>（1）/etc/gitconfig 文件：包含了适用于系统所有用户和所有库的值。如果你传递参数选项’–system’ 给 git config，它将明确的读和写这个文件。<br>（2）~/.gitconfig 文件 ：具体到你的用户。你可以通过传递 ‘–global’ 选项使Git 读或写这个特定的文件。<br>（3）当前项目Git目录的 config 文件 (也就是 .git/config) ：无论你当前在用的库是什么，特定指向该单一的库。每个级别重写前一个级别的值。因此，在 .git/config 中的值覆盖了在/etc/gitconfig中的同一个值，可以通过传递‘–local’选项使Git 读或写这个特定的文件。</p>
<h2 id="为不同邮箱账号生成不同的公钥和私钥"><a href="#为不同邮箱账号生成不同的公钥和私钥" class="headerlink" title="为不同邮箱账号生成不同的公钥和私钥"></a>为不同邮箱账号生成不同的公钥和私钥</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -f ~/.ssh/id_rsa.github -C &quot;simba@example.com&quot;</span><br></pre></td></tr></table></figure>
<p>一定注意加上-f选项明确指定私钥文件名称，防止覆盖默认生成的id_rsa文件；或者此时不加，但在下面的生成过程中仔细写上。<br>然后将公钥内容上传到特定的服务器上。</p>
<h2 id="配置config文件"><a href="#配置config文件" class="headerlink" title="配置config文件"></a>配置config文件</h2><p>在.ssh/目录下的config文件（如果没有，则新建）中，写入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">    HostName github.com</span><br><span class="line">    IdentityFile C:\Users\xxx\.ssh\id_rsa.github</span><br><span class="line">    PreferredAuthentications publickey</span><br></pre></td></tr></table></figure>
<p>其中每项的意义为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Host    　    #　主机别名</span><br><span class="line">HostName　    #　服务器真实地址</span><br><span class="line">IdentityFile　#　私钥文件路径</span><br><span class="line">PreferredAuthentications　#　认证方式</span><br><span class="line">User　        #　用户名</span><br></pre></td></tr></table></figure>
<p>每个不同的账号都配置一个这样的ssh-key。</p>
<h2 id="为具体的git项目设置账号信息"><a href="#为具体的git项目设置账号信息" class="headerlink" title="为具体的git项目设置账号信息"></a>为具体的git项目设置账号信息</h2><p>首先需要先git clone下来具体的git项目（或者git init新建项目），然后在项目下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config  user.email &quot;xxxx@xx.com&quot;</span><br><span class="line">git config  user.name &quot;xxx&quot;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/08/29/ImagePy_3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/29/ImagePy_3/" class="post-title-link" itemprop="url">ImagePy解析：3 -- 工具条加载详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-29 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-29T00:00:00+08:00">2019-08-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/08/29/ImagePy_3/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/08/29/ImagePy_3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这一部分详解ImagePy的工具条是如何加载的。</p>
<h1 id="构建工具条入口"><a href="#构建工具条入口" class="headerlink" title="构建工具条入口"></a>构建工具条入口</h1><p>通过build_tools这个函数来构建工具条：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.toolbar = toolsloader.build_tools(self, <span class="string">&#x27;tools&#x27;</span>, <span class="string">&#x27;plugins&#x27;</span>, <span class="literal">None</span>, <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>这几个实参所对应的该函数的形参依次为：tools传入toolpath, plugins传入extends（这个参数目前看没有用处），None传入bar，True赋给report。<br>下面详细看这个函数做了什么。</p>
<h1 id="递归获得所有工具的类文件和图标文件"><a href="#递归获得所有工具的类文件和图标文件" class="headerlink" title="递归获得所有工具的类文件和图标文件"></a>递归获得所有工具的类文件和图标文件</h1><p>上面的build_tools函数又会调用loader的build_tools函数，这个函数所做的东西跟前面加载插件时的逻辑基本是相同的，都是为了递归获得所有工具的类文件，不过这里还会获得图标文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">datas = loader.build_tools(toolspath, report)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;datas = &quot;</span>, datas)</span><br></pre></td></tr></table></figure>
<p>如果tools文件夹下仅保留部分文件，那么上面的返回结果如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">datas =  (&lt;module &#x27;imagepy.tools&#x27; from &#x27;D:\\imagepy-master\\imagepy\\tools\\__init__.py&#x27;&gt;, [(&lt;module &#x27;imagepy.tools.Measure&#x27; from &#x27;D:\\imagepy-master\\imagepy\\tools\\Measure\\__init__.py&#x27;&gt;, [(&lt;class &#x27;imagepy.tools.Measure.distance_tol.Plugin&#x27;&gt;, &#x27;D:\\imagepy-master\\imagepy\\tools\\Measure/distance.gif&#x27;), (&lt;class &#x27;imagepy.tools.Measure.profile_tol.Plugin&#x27;&gt;, &#x27;D:\\imagepy-master\\imagepy\\tools\\Measure/profile.gif&#x27;)]), (&lt;module &#x27;imagepy.tools.Standard&#x27; from &#x27;D:\\imagepy-master\\imagepy\\tools\\Standard\\__init__.py&#x27;&gt;, [(&lt;class &#x27;imagepy.tools.Standard.point_tol.Plugin&#x27;&gt;, &#x27;D:\\imagepy-master\\imagepy\\tools\\Standard/point.gif&#x27;)])])</span><br></pre></td></tr></table></figure>
<p>可以看出，上述数据结构的层级类似于构建菜单时得到的结果。</p>
<p>#解析为wxpython工具条<br>使用的函数为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">toolsbar = buildToolsBar(parent, datas, bar)</span><br></pre></td></tr></table></figure>
<p>即，将上面得到的datas元组传入，然后该函数首先创建了wxpython的penel对象，并用BoxSizer进行组织：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> toolsbar <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    box = wx.BoxSizer( wx.HORIZONTAL )</span><br><span class="line">    toolsbar = wx.Panel( parent, wx.ID_ANY,  wx.DefaultPosition, wx.DefaultSize, wx.TAB_TRAVERSAL )</span><br><span class="line">    toolsbar.SetSizer( box )</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    box = toolsbar.GetSizer()</span><br><span class="line">    toolsbar.DestroyChildren()</span><br><span class="line">    box.Clear()</span><br></pre></td></tr></table></figure>
<p>注意，ImagePy创建工具条不是使用的wxPython默认的ToolBar对象，而是使用的wxPython的panel对象，应该是为了考虑更加灵活的控制。<br>然后将获得工具条层级关系传入下面的add_tools函数中，注意，这个地方传入的是datas这个tuple的第三维度，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;datas[1][0][1] = &quot;</span>, datas[<span class="number">1</span>][<span class="number">0</span>][<span class="number">1</span>])</span><br><span class="line">add_tools(toolsbar, datas[<span class="number">1</span>][<span class="number">0</span>][<span class="number">1</span>], clear=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>原因可以从上面的输出中进行追究：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">datas[1][0][1] =  [(&lt;class &#x27;imagepy.tools.Measure.distance_tol.Plugin&#x27;&gt;, &#x27;D:\\imagepy-master\\imagepy\\tools\\Measure/distance.gif&#x27;), (&lt;class &#x27;imagepy.tools.Measure.profile_tol.Plugin&#x27;&gt;, &#x27;D:\\imagepy-master\\imagepy\\tools\\Measure/profile.gif&#x27;)]</span><br></pre></td></tr></table></figure>
<p>可以看出，第一个index选择1，是因为选择它之前扫描到的tools文件夹下的所有工具形成的list；第二个index选择0，代表第一个文件夹，即Measure文件夹；第二个index选择1，即选择Measure文件夹下的所有工具形成的list。其实，看下方的代码，ImagePy还会加载第二个文件夹，但此时源代码中有一个bug，即如果tools文件夹只有一个子文件夹，那么就会报错，无法启动，因此这里对ImagePy源码可以修改，增加一个判断，如果有多于两个文件夹，才会加载下方的代码，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(datas[<span class="number">1</span>]) &gt; <span class="number">1</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;datas[1][1][1] = &quot;</span>, datas[<span class="number">1</span>][<span class="number">1</span>][<span class="number">1</span>])</span><br><span class="line">    add_tools(toolsbar, datas[<span class="number">1</span>][<span class="number">1</span>][<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<p>GitHub上我提了一个Pull Request，见：<br><a target="_blank" rel="noopener" href="https://github.com/Image-Py/imagepy/pull/65">fix the startup error when only there is only one toolbar</a></p>
<p>然后下面进入add_tools函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_tools</span>(<span class="params">bar, datas, clear=<span class="literal">False</span>, curids=[]</span>):</span></span><br><span class="line">    box = bar.GetSizer()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> clear:</span><br><span class="line">        <span class="keyword">for</span> curid <span class="keyword">in</span> curids:</span><br><span class="line">            curid.Destroy()</span><br><span class="line">    <span class="keyword">del</span> curids[:]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> datas:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;data = &quot;</span>, data)</span><br><span class="line">        <span class="comment"># 将扫描到的icon图像文件制作成wxPython的BitmapButton</span></span><br><span class="line">        btn = wx.BitmapButton(bar, wx.ID_ANY, make_bitmap(wx.Bitmap(data[<span class="number">1</span>])), wx.DefaultPosition, (<span class="number">32</span>,<span class="number">32</span>), wx.BU_AUTODRAW|wx.RAISED_BORDER )       </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> clear:curids.append(btn)       </span><br><span class="line">        <span class="comment"># 判断是否在界面上直接显示，还是收缩起来，点击后再显示</span></span><br><span class="line">        <span class="keyword">if</span> clear:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--- It is clear ---&quot;</span>)</span><br><span class="line">            <span class="comment"># 将这个button直接添加进入BoxSizer中</span></span><br><span class="line">            box.Add(btn)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--- It is not clear&quot;</span>)</span><br><span class="line">            <span class="comment"># 如果是收缩起来，则在特定位置加入，而不是直接加入，这里的特定位置是box已有的所有的item数-2，之所以是减去2，与之前box添加的东西有关，具体可以看下面的输出，即在box添加的分割线后添加</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;length of box&#x27;s children = &quot;</span>, <span class="built_in">len</span>(box.GetChildren()))</span><br><span class="line">            <span class="keyword">for</span> child <span class="keyword">in</span> box.GetChildren():</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;box&#x27;s children = &quot;</span>, child.GetWindow())</span><br><span class="line">            box.Insert(<span class="built_in">len</span>(box.GetChildren())-<span class="number">2</span>, btn)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 为该button绑定“左键按下”的鼠标事件   </span></span><br><span class="line">        btn.Bind( wx.EVT_LEFT_DOWN, <span class="keyword">lambda</span> x, p=data[<span class="number">0</span>]:f(p(), x))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 为该button绑定“右键按下”的鼠标事件</span></span><br><span class="line">        btn.Bind( wx.EVT_RIGHT_DOWN, <span class="keyword">lambda</span> x, p=data[<span class="number">0</span>]: IPy.show_md(p.title, DocumentManager.get(p.title)))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 为该button绑定“鼠标移入”的鼠标事件</span></span><br><span class="line">        btn.Bind( wx.EVT_ENTER_WINDOW, <span class="keyword">lambda</span> x, p=<span class="string">&#x27;&quot;&#123;&#125;&quot; Tool&#x27;</span>.<span class="built_in">format</span>(data[<span class="number">0</span>].title): set_info(p))       </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(data[<span class="number">0</span>], Macros) <span class="keyword">and</span> <span class="built_in">issubclass</span>(data[<span class="number">0</span>], Tool):</span><br><span class="line">            btn.Bind(wx.EVT_LEFT_DCLICK, <span class="keyword">lambda</span> x, p=data[<span class="number">0</span>]:p().show())</span><br><span class="line"></span><br><span class="line">        btn.SetDefault()</span><br><span class="line">    box.Layout()</span><br><span class="line">    bar.Refresh()</span><br></pre></td></tr></table></figure>
<p>上面的输出为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">datas[1][0][1] =  [(&lt;class &#x27;imagepy.tools.Measure.distance_tol.Plugin&#x27;&gt;, &#x27;D:\\imagepy-master\\imagepy\\tools\\Measure/distance.gif&#x27;), (&lt;class &#x27;imagepy.tools.Measure.profile_tol.Plugin&#x27;&gt;, &#x27;D:\\imagepy-master\\imagepy\\tools\\Measure/profile.gif&#x27;)]</span><br><span class="line">data =  (&lt;class &#x27;imagepy.tools.Measure.distance_tol.Plugin&#x27;&gt;, &#x27;D:\\imagepy-master\\imagepy\\tools\\Measure/distance.gif&#x27;)</span><br><span class="line">--- It <span class="keyword">is</span> clear ---</span><br><span class="line">data =  (&lt;class &#x27;imagepy.tools.Measure.profile_tol.Plugin&#x27;&gt;, &#x27;D:\\imagepy-master\\imagepy\\tools\\Measure/profile.gif&#x27;)</span><br><span class="line">--- It <span class="keyword">is</span> clear ---</span><br><span class="line">datas[1][1][1] =  [(&lt;class &#x27;imagepy.tools.Standard.point_tol.Plugin&#x27;&gt;, &#x27;D:\\imagepy-master\\imagepy\\tools\\Standard/point.gif&#x27;)]</span><br><span class="line">data =  (&lt;class &#x27;imagepy.tools.Standard.point_tol.Plugin&#x27;&gt;, &#x27;D:\\imagepy-master\\imagepy\\tools\\Standard/point.gif&#x27;)</span><br><span class="line">--- It <span class="keyword">is</span> <span class="keyword">not</span> clear</span><br><span class="line">length of box<span class="string">&#x27;s children =  5</span></span><br><span class="line"><span class="string">box&#x27;</span>s children =  &lt;wx._core.BitmapButton <span class="built_in">object</span> at <span class="number">0x0000020B2C24E558</span>&gt;</span><br><span class="line">box<span class="string">&#x27;s children =  &lt;wx._core.BitmapButton object at 0x0000020B2C24E708&gt;</span></span><br><span class="line"><span class="string">box&#x27;</span>s children =  &lt;wx._core.StaticLine <span class="built_in">object</span> at <span class="number">0x0000020B2C24E8B8</span>&gt;</span><br><span class="line">box<span class="string">&#x27;s children =  None</span></span><br><span class="line"><span class="string">box&#x27;</span>s children =  &lt;wx._core.BitmapButton <span class="built_in">object</span> at <span class="number">0x0000020B2C24E828</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="工具按钮绑定鼠标事件"><a href="#工具按钮绑定鼠标事件" class="headerlink" title="工具按钮绑定鼠标事件"></a>工具按钮绑定鼠标事件</h1><p>前面代码已经简略描述了如何为工具绑定鼠标事件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">btn.Bind( wx.EVT_LEFT_DOWN, <span class="keyword">lambda</span> x, p=data[<span class="number">0</span>]:f(p(), x))</span><br><span class="line">btn.Bind( wx.EVT_RIGHT_DOWN, <span class="keyword">lambda</span> x, p=data[<span class="number">0</span>]: IPy.show_md(p.title, DocumentManager.get(p.title)))</span><br><span class="line">btn.Bind( wx.EVT_ENTER_WINDOW, <span class="keyword">lambda</span> x, p=<span class="string">&#x27;&quot;&#123;&#125;&quot; Tool&#x27;</span>.<span class="built_in">format</span>(data[<span class="number">0</span>].title): set_info(p))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(data[<span class="number">0</span>], Macros) <span class="keyword">and</span> <span class="built_in">issubclass</span>(data[<span class="number">0</span>], Tool):</span><br><span class="line">    btn.Bind(wx.EVT_LEFT_DCLICK, <span class="keyword">lambda</span> x, p=data[<span class="number">0</span>]:p().show())</span><br></pre></td></tr></table></figure>
<p>首先还是使用了lambda算子，即匿名函数，进行事件绑定。<br>这里的工具都是继承了Tool这个引擎，事件触发的也都是Tool引擎本身的函数或者该特定工具重载的同名函数。<br>值得注意的是，这里的右键按下事件，会调用IPy的显示markdown的功能，再次说明IPy将常用功能抽象出来的作用。<br>另外，工具的加载不像插件的加载那样，会加入到一个管理器Manager中，工具的加载就是对wxPython的panel的渲染，然后绑定鼠标事件。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/08/09/ImagePy_2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/09/ImagePy_2/" class="post-title-link" itemprop="url">ImagePy解析：2 -- 插件加载详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-09 00:00:00" itemprop="dateCreated datePublished" datetime="2019-08-09T00:00:00+08:00">2019-08-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computational-material-science/" itemprop="url" rel="index"><span itemprop="name">computational material science</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/08/09/ImagePy_2/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/08/09/ImagePy_2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在第一部分中已经介绍，ImagePy的插件就是文件，这一篇详细解析ImagePy怎样解析物理文件，然后将其加载到菜单栏中。</p>
<h1 id="主界面构建菜单"><a href="#主界面构建菜单" class="headerlink" title="主界面构建菜单"></a>主界面构建菜单</h1><p>首先在主界面中根据路径添加菜单项（插件就是菜单），即逐层遍历’menus’路径下的文件夹和文件，找到特定后缀的文件（比如后缀为”plgs.py”），并添加为菜单项。这是整个插件加载的入口函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.menubar = pluginloader.buildMenuBarByPath(self, <span class="string">&#x27;menus&#x27;</span>, <span class="string">&#x27;plugins&#x27;</span>, <span class="literal">None</span>, <span class="literal">True</span>)</span><br><span class="line">self.SetMenuBar( self.menubar )</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>下面详细查看pluginloader的buildMenuBarByPath函数的详细用途。<br>首先对应好该函数接收的形参和实参，即path形参接收了menus这个文件夹，extends形参接收了plugins这个文件夹（但这个参数后面证明啥也没做），menubar这个形参设为None，report这个形参设为True。<br>接着看该函数到底干了什么。它首先调用了加载器loader类的buildplugins函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">datas = loader.build_plugins(path, report)</span><br></pre></td></tr></table></figure>

<p>这一步有如下几个重点：</p>
<h1 id="通过递归得到menus文件夹下的子文件夹和特定后缀的文件"><a href="#通过递归得到menus文件夹下的子文件夹和特定后缀的文件" class="headerlink" title="通过递归得到menus文件夹下的子文件夹和特定后缀的文件"></a>通过递归得到menus文件夹下的子文件夹和特定后缀的文件</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_plugins</span>(<span class="params">path, err=<span class="literal">False</span></span>):</span></span><br><span class="line">    root = err <span class="keyword">in</span> (<span class="literal">True</span>, <span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">if</span> root: sta, err = err, []</span><br><span class="line">    subtree = []</span><br><span class="line">    <span class="comment"># 返回menus文件夹包含的文件和文件夹的名字的列表</span></span><br><span class="line">    cont = os.listdir(os.path.join(root_dir, path))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;cont = &quot;</span>, cont)</span><br><span class="line">    <span class="comment"># 遍历这些文件和文件夹</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> cont:</span><br><span class="line">        subp = os.path.join(path,i)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;subp = &quot;</span>, subp)</span><br><span class="line">        <span class="comment"># 判断子路径是否是文件夹</span></span><br><span class="line">        <span class="keyword">if</span> os.path.isdir(os.path.join(root_dir, subp)):</span><br><span class="line">            <span class="comment"># 如果是文件夹，就做递归操作，即将该子文件夹作为新的path，直到不再是文件夹，而是具体的文件</span></span><br><span class="line">            sub = build_plugins(subp, err)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;sub after building plugins = &quot;</span>, sub)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(sub)!=<span class="number">0</span>:</span><br><span class="line">                subtree.append(sub)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;subtree append sub = &quot;</span>, subtree)</span><br><span class="line">        <span class="comment"># 如果不再是文件夹后，就判断后缀，如果是以下后缀，则添加进subtree</span></span><br><span class="line">        <span class="keyword">elif</span> i[-<span class="number">6</span>:] <span class="keyword">in</span> (<span class="string">&#x27;plg.py&#x27;</span>, <span class="string">&#x27;lgs.py&#x27;</span>, <span class="string">&#x27;wgt.py&#x27;</span>, <span class="string">&#x27;gts.py&#x27;</span>):</span><br><span class="line">            subtree.append(i)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;subtree append .py = &quot;</span>, subtree)</span><br><span class="line">        <span class="comment"># 这些后缀的文件也添加进subtree</span></span><br><span class="line">        <span class="keyword">elif</span> i[-<span class="number">3</span>:] <span class="keyword">in</span> (<span class="string">&#x27;.mc&#x27;</span>, <span class="string">&#x27;.md&#x27;</span>, <span class="string">&#x27;.wf&#x27;</span>, <span class="string">&#x27;rpt&#x27;</span>):</span><br><span class="line">            subtree.append(i)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;subtree append .mc = &quot;</span>, subtree)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(subtree)==<span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Cont if subtree is empty = &quot;</span>, cont)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Cont if subtree is NOT empty = &quot;</span>, cont)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;path = &quot;</span>, path)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;*********Found the directory containing valid files**********&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>上述代码在源代码基础上加了很多print函数，方便打印结果。<br>以File文件夹为例，上述print的结果为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cont =  [<span class="string">&#x27;BMP&#x27;</span>, <span class="string">&#x27;DAT&#x27;</span>, <span class="string">&#x27;DICOM&#x27;</span>, <span class="string">&#x27;exit_plg.py&#x27;</span>, <span class="string">&#x27;Export&#x27;</span>, <span class="string">&#x27;GIF&#x27;</span>, <span class="string">&#x27;Import&#x27;</span>, <span class="string">&#x27;JPG&#x27;</span>, <span class="string">&#x27;MAT&#x27;</span>, <span class="string">&#x27;new_plg.py&#x27;</span>, <span class="string">&#x27;Numpy&#x27;</span>, <span class="string">&#x27;Open Recent&#x27;</span>, <span class="string">&#x27;open_plg.py&#x27;</span>, <span class="string">&#x27;PNG&#x27;</span>, <span class="string">&#x27;Samples ImageJ&#x27;</span>, <span class="string">&#x27;Samples Local&#x27;</span>, <span class="string">&#x27;Samples Online&#x27;</span>, <span class="string">&#x27;save_plg.py&#x27;</span>, <span class="string">&#x27;TIF&#x27;</span>, <span class="string">&#x27;__init__.py&#x27;</span>, <span class="string">&#x27;__pycache__&#x27;</span>]</span><br><span class="line">subp =  menus\File\BMP</span><br><span class="line">cont =  [<span class="string">&#x27;bmp_plgs.py&#x27;</span>, <span class="string">&#x27;__init__.py&#x27;</span>, <span class="string">&#x27;__pycache__&#x27;</span>]</span><br><span class="line">subp =  menus\File\BMP\bmp_plgs.py</span><br><span class="line">subtree append .py =  [<span class="string">&#x27;bmp_plgs.py&#x27;</span>]</span><br><span class="line">subp =  menus\File\BMP\__init__.py</span><br><span class="line">subp =  menus\File\BMP\__pycache__</span><br><span class="line">cont =  [<span class="string">&#x27;bmp_plgs.cpython-37.pyc&#x27;</span>, <span class="string">&#x27;__init__.cpython-37.pyc&#x27;</span>]</span><br><span class="line">subp =  menus\File\BMP\__pycache__\bmp_plgs.cpython-<span class="number">37.</span>pyc</span><br><span class="line">subp =  menus\File\BMP\__pycache__\__init__.cpython-<span class="number">37.</span>pyc</span><br><span class="line">Cont <span class="keyword">if</span> subtree <span class="keyword">is</span> empty =  [<span class="string">&#x27;bmp_plgs.cpython-37.pyc&#x27;</span>, <span class="string">&#x27;__init__.cpython-37.pyc&#x27;</span>]</span><br><span class="line">sub after building plugins =  []</span><br><span class="line">Cont <span class="keyword">if</span> subtree <span class="keyword">is</span> NOT empty =  [<span class="string">&#x27;bmp_plgs.py&#x27;</span>, <span class="string">&#x27;__init__.py&#x27;</span>, <span class="string">&#x27;__pycache__&#x27;</span>]</span><br><span class="line">*********Found the directory containing valid files**********</span><br></pre></td></tr></table></figure>
<p>可以看出，程序先扫描File文件夹下的所有文件和文件夹，然后逐个判断；首先进入子文件夹BMP，扫描得到它下面的所有文件和文件夹，这里面有一个符合后缀的插件文件，就将它加入到subtree中，对于跟它平级的’<em>pycache</em>‘缓存文件夹，程序也照样会进入，但其里面因为没有有效的插件文件，就返回一个空值给subtree，然后跳出这个文件夹，回到它的父文件夹BMP；前面已提到，BMP中有一个有效插件，因此subtree不为空，这里就是[‘bmp_plgs.py’]，此时就不会终止程序，而是继续往下面走，注意此时的path就是BMP路径，即menus\File\BMP。</p>
<p>接下来是导入BMP这个包，注意这里的术语区别，BMP是包module，表明它还有多个类。接下来一步是导入BMP这个包：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将路径中的斜线替换为替换为点号，为后续导入做准备</span></span><br><span class="line">rpath = path.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>).replace(<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;rpath = &quot;</span>, rpath)</span><br><span class="line"><span class="comment"># 动态加载这个模块</span></span><br><span class="line">pg = <span class="built_in">__import__</span>(<span class="string">&#x27;imagepy.&#x27;</span>+rpath,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,[<span class="string">&#x27;&#x27;</span>])</span><br><span class="line"><span class="comment"># 给这个模块的title属性赋值为path变量的basename，title会被后面用作菜单的名字</span></span><br><span class="line">pg.title = os.path.basename(path)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;pg = &quot;</span>, pg)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;pg&#x27;s title = &quot;</span>, pg.title)</span><br></pre></td></tr></table></figure>
<p>输出结果为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpath =  menus.File.BMP</span><br><span class="line">pg =  &lt;module <span class="string">&#x27;imagepy.menus.File.BMP&#x27;</span> <span class="keyword">from</span> <span class="string">&#x27;D:\\imagepy-master\\imagepy\\menus\\File\\BMP\\__init__.py&#x27;</span>&gt;</span><br><span class="line">pg<span class="string">&#x27;s title =  BMP</span></span><br></pre></td></tr></table></figure>
<p>注意pg变量是个module，与下面的plgs进行区别。<br>上述subtree列表中存的都是字符串，extend_plugins将它们以类的形式加载到PluginManager中（之所以取名为extend，是因为原先扫描到的都是文件，这一步是将文件中定义的类提取出来），其中rpt（report）、.mc（macro宏）、.wf（WorkFlow工作流）、.md（markdown）和.py（plg.py和plgs.py）都加载到PluginManager，而wgt.py和gts.py则加载到WidgetManager中。调用接口是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subtree = extend_plugins(path, subtree, err)</span><br></pre></td></tr></table></figure>
<p>此处path就是menus\File\BMP，subtree就是[‘bmp_plgs.py’]。因为这里BMP的例子是插件文件，所以只截取该函数中处理插件文件部分的代码进行分析：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将path路径中的斜线替换为点号</span></span><br><span class="line">rpath = path.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>).replace(<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;rpath in extend-plugins is &quot;</span>, rpath)</span><br><span class="line"><span class="comment"># 动态导入那个插件文件</span></span><br><span class="line">plg = <span class="built_in">__import__</span>(<span class="string">&#x27;imagepy.&#x27;</span>+ rpath+<span class="string">&#x27;.&#x27;</span>+i[:-<span class="number">3</span>],<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,[<span class="string">&#x27;&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;plg in extend-plugins is &quot;</span>, plg)</span><br><span class="line"><span class="comment"># 判断这个py文件是否有plgs这个属性，该属性告诉程序该程序有几个类</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">hasattr</span>(plg, <span class="string">&#x27;plgs&#x27;</span>):</span><br><span class="line">    <span class="comment"># 如果有plgs属性的话，就把它添加进rst变量，这个地方兼具插件排序的功能</span></span><br><span class="line">    rst.extend([j <span class="keyword">for</span> j <span class="keyword">in</span> plg.plgs])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;rst if plg has attr of plgs = &quot;</span>, rst)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;plg.plgs = &quot;</span>, plg.plgs)</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> plg.plgs:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;p = &quot;</span>, p)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(p, <span class="built_in">str</span>):</span><br><span class="line">            <span class="comment"># 将插件加入插件管理器，这个add是被classmethod修饰符所修饰的</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;!!! Add plgs into PluginsManager !!!&quot;</span>)</span><br><span class="line">            PluginsManager.add(p)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment">#plgs属性是为了一下定义多个类而准备的，也可以使用Plugin属性添加单个插件</span></span><br><span class="line">    rst.append(plg.Plugin)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;rst if plg does NOT have attr of plgs = &quot;</span>, rst)</span><br><span class="line">    PluginsManager.add(plg.Plugin)</span><br></pre></td></tr></table></figure>
<p>该函数返回的是rst变量。插件管理器的add方法是classmethod所修饰，一个关于该修饰符的教程见：<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/28010894">正确理解Python中的 @staticmethod@classmethod方法</a><br>这里上面的print函数得到的输出为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rpath <span class="keyword">in</span> extend-plugins <span class="keyword">is</span>  menus.File.BMP</span><br><span class="line">plg <span class="keyword">in</span> extend-plugins <span class="keyword">is</span>  &lt;module <span class="string">&#x27;imagepy.menus.File.BMP.bmp_plgs&#x27;</span> <span class="keyword">from</span> <span class="string">&#x27;D:\\imagepy-master\\imagepy\\menus\\File\\BMP\\bmp_plgs.py&#x27;</span>&gt;</span><br><span class="line">rst if plg has attr of plgs =  [&lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.SaveFile&#x27;&gt;]</span><br><span class="line">plg.plgs =  [&lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.SaveFile&#x27;&gt;]</span><br><span class="line">p =  &lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">imagepy</span>.<span class="title">menus</span>.<span class="title">File</span>.<span class="title">BMP</span>.<span class="title">bmp_plgs</span>.<span class="title">OpenFile</span>&#x27;&gt;</span></span><br><span class="line"><span class="class">!!! <span class="title">Add</span> <span class="title">plgs</span> <span class="title">into</span> <span class="title">PluginsManager</span> !!!</span></span><br><span class="line">p =  &lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.SaveFile&#x27;&gt;</span><br><span class="line">!!! Add plgs into PluginsManager !!! </span><br></pre></td></tr></table></figure>
<p>可以看出，rst变量是一个列表，里面包含了该插件的两个类，而插件管理器添加的也是这两个类。<br>不同后缀的文件经过处理后，该函数返回值会赋值给subtree变量，即：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">subtree = extend_plugins(path, subtree, err)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;subtree after extending = &quot;</span>, subtree)</span><br></pre></td></tr></table></figure>
<p>因此，此时subtree变量依然是个列表，但里面的东西不再是字符串，而是动态加载的类，但是注意，subtree里面的东西还会变，注意往下看。<br>经过后缀处理后，build_plugins这个函数最终返回的是一个(pg, subtree)元组，前者是包名，后者是类名的列表。此处具体为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub after building plugins =  (&lt;module &#x27;imagepy.menus.File.BMP&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\BMP\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.SaveFile&#x27;&gt;])                                                      </span><br></pre></td></tr></table></figure>
<p>注意，build_plugins返回的值是sub变量，如果它不为空的话，它还会添加到subtree中，所以subtree此时仍是一个list，但其中的元素是个tuple，具体值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">subtree append sub =  [(&lt;module &#x27;imagepy.menus.File.BMP&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\BMP\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.SaveFile&#x27;&gt;])]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>搜索完File文件夹的子文件夹BMP后，再接着搜索子文件夹DAT，再经过上面一轮操作，得到的subtree又更新了（注意，这个subtree是在menus这个path变量时的全局的subtree，所以它的值可以一直叠加更新，而在子文件夹下的局部的subtree的值则会一直变化）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">subtree append sub =  [(&lt;module &#x27;imagepy.menus.File.BMP&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\BMP\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.SaveFile&#x27;&gt;]), (&lt;module &#x27;imagepy.menus.File.DAT&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\DAT\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.DAT.dat_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.DAT.dat_plgs.SaveFile&#x27;&gt;])]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面BMP和DAT都是File的子文件夹，如果遇到了File的子文件，比如exit_plg.py，则subtree会变为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subtree append .py =  [(&lt;module &#x27;imagepy.menus.File.BMP&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\BMP\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.SaveFile&#x27;&gt;]), (&lt;module &#x27;imagepy.menus.File.DAT&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\DAT\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.DAT.dat_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.DAT.dat_plgs.SaveFile&#x27;&gt;]), (&lt;module &#x27;imagepy.menus.File.DICOM&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\DICOM\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.DICOM.dicom_plgs.OpenFile&#x27;&gt;]), &#x27;exit_plg.py&#x27;]</span><br></pre></td></tr></table></figure>
<p>虽然subtree在更新过程中是list形式，但最终在最上层的menus路径下执行的build_plugins函数返回的还是元组的形式，这里的具体形式形如：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&lt;module &#x27;imagepy.menus&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\__init__.py&#x27;&gt;, [(&lt;module &#x27;imagepy.menus.File&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\__init__.py&#x27;&gt;, [(&lt;module &#x27;imagepy.menus.File.BMP&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\BMP\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.SaveFile&#x27;&gt;]), (&lt;module &#x27;imagepy.menus.File.DAT&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\DAT\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.DAT.dat_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.DAT.dat_plgs.SaveFile&#x27;&gt;]), &lt;class &#x27;imagepy.menus.File.exit_plg.Plugin&#x27;&gt;, (&lt;module &#x27;imagepy.menus.File.GIF&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\GIF\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.GIF.gif_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.GIF.gif_plgs.SaveFile&#x27;&gt;, &#x27;-&#x27;, &lt;class &#x27;imagepy.menus.File.GIF.animate_plgs.OpenAnimate&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.GIF.animate_plgs.SaveAnimate&#x27;&gt;]), &lt;class &#x27;imagepy.menus.File.open_plg.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.open_plg.OpenUrl&#x27;&gt;])])</span><br></pre></td></tr></table></figure>
<p>上面的结果是在menus文件夹下只保留File子文件夹，且File子文件夹下只保留BMP、DAT和GIF文件夹以及两个py文件的结果。<br>更精简地，做这样一个测试，在menus下保留File和Edit两个子文件夹，File下只保留BMP子文件夹，Edit下仅有edit_plg.py文件，且其中的类只有Undo、分隔符和ClearOut，那么此时最终返回结果为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(&lt;module &#x27;imagepy.menus&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\__init__.py&#x27;&gt;, [(&lt;module &#x27;imagepy.menus.File&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\__init__.py&#x27;&gt;, [(&lt;module &#x27;imagepy.menus.File.BMP&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\BMP\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.SaveFile&#x27;&gt;])]), (&lt;module &#x27;imagepy.menus.Edit&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\Edit\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.Edit.edit_plg.Undo&#x27;&gt;, &#x27;-&#x27;, &lt;class &#x27;imagepy.menus.Edit.edit_plg.ClearOut&#x27;&gt;])])</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看出，整个返回值是一个整体有2个元素的tuple，第一个元素是导入的menus这个包，第二个元素是一个list，这个list又是含有2个元素，分别对应File和Edit两个文件夹，第一个元素又是一个tuple，这个tuple的第一个元素导入的是File这个包，第二个元素是一个list，包含BMP子文件夹所形成的tuple。那么规律就是：对于一个文件夹（包括menus这个总文件夹）层级，每个文件夹就是一个Python包，该层上的返回的结构就是一个含有2个元素的tuple，第一个元素是导入的这个Python包信息，第二个元素就是一个list，包含该文件夹下的插件信息，如果有子文件夹，那么该子文件夹又会重复这样的层级表示。构思相当之巧妙～～</p>
<h1 id="对插件进行顺序调整"><a href="#对插件进行顺序调整" class="headerlink" title="对插件进行顺序调整"></a>对插件进行顺序调整</h1><p>首先明确插件的类型有两种：一种是按物理文件组织的插件，如插件组，即多个插件文件在同一个文件夹中；一种是在同一个文件内的不同插件，即一个插件文件中有多个类。<br>先看第一种插件，上面的BMP和DAT文件夹中都只有一个插件，而GIF文件夹中有两个插件，因此这里面还会涉及插件的排序问题，这个排序问题存在于“一个文件夹中有多个插件”的情形，因此File这个文件夹也会存在该问题。默认情况下，插件是通过字母顺序排序的，这是因为python扫描文件时就是按字母顺序来的。也可以通过在初始化文件中定义catlog属性来人为规定插件顺序。具体代码为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">hasattr</span>(pg, <span class="string">&#x27;catlog&#x27;</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;Personal Information&#x27;</span> <span class="keyword">in</span> pg.catlog:</span><br><span class="line">        <span class="built_in">print</span>(subtree)</span><br><span class="line">    subtree = sort_plugins(pg.catlog, subtree)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;subtree with catlog = &quot;</span>, subtree)</span><br><span class="line">subtree = extend_plugins(path, subtree, err)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;subtree after extending = &quot;</span>, subtree)</span><br></pre></td></tr></table></figure>
<p>注意，这里在catlog列表中加入”-“来映射为菜单分割线。<br>调整顺序后的局部的subtree变量为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subtree after extending =  [&lt;class &#x27;imagepy.menus.File.GIF.gif_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.GIF.gif_plgs.SaveFile&#x27;&gt;, &#x27;-&#x27;, &lt;class &#x27;imagepy.menus.File.GIF.animate_plgs.OpenAnimate&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.GIF.animate_plgs.SaveAnimate&#x27;&gt;]</span><br></pre></td></tr></table></figure>
<p>再看第二种插件，其实这种插件的排序是在extend_plugins函数中隐含进行的，具体地是在该文件的最后定义plgs这个属性，然后extend_plugins这个函数读取该属性，然后逐个添加插件到插件管理器中。</p>
<h1 id="python脚本解析为wxPython菜单"><a href="#python脚本解析为wxPython菜单" class="headerlink" title="python脚本解析为wxPython菜单"></a>python脚本解析为wxPython菜单</h1><p>使用wxPython菜单栏的一个基本教程为：<br><a target="_blank" rel="noopener" href="https://wizardforcel.gitbooks.io/wxpy-in-action/15.html">创建和使用wxPython菜单</a><br>基本套路为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建菜单栏</span></span><br><span class="line">menuBar = wx.MenuBar()</span><br><span class="line"><span class="comment"># 把菜单栏附加给框架：使用SetMenuBar()方法将它附加给一个wx.Frame（或其子类），通常这些都在框架的__init__或OnInit()方法中实施</span></span><br><span class="line">self.SetMenuBar(menuBar)</span><br><span class="line"><span class="comment"># 创建单个的菜单</span></span><br><span class="line">menu = wx.Menu()</span><br><span class="line"><span class="comment"># 把菜单附加给菜单栏或一个父菜单，即可以用Append添加一个子菜单，但这个API在最新版本中是deprecated，需要使用AppendSubMenu</span></span><br><span class="line">menuBar.Append(menu, <span class="string">&quot;Left Menu&quot;</span>)</span><br><span class="line"><span class="comment"># 创建单个的菜单项，并附加给某个菜单 （即：菜单栏包含多个菜单，某个菜单包含多个菜单项）</span></span><br><span class="line">exit = menu.Append(-<span class="number">1</span>, <span class="string">&quot;Exit&quot;</span>)</span><br><span class="line"><span class="comment"># 为每个菜单项创建一个事件绑定</span></span><br><span class="line">self.Bind(wx.EVT_MENU, self.OnExit, exit)</span><br></pre></td></tr></table></figure>

<p>一个基础例子为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFrame</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        wx.Frame.__init__(self, <span class="literal">None</span>, -<span class="number">1</span>,</span><br><span class="line">                          <span class="string">&quot;Sub-menu Example&quot;</span>)</span><br><span class="line">        p = wx.Panel(self)</span><br><span class="line">        menu = wx.Menu()</span><br><span class="line">        submenu = wx.Menu()</span><br><span class="line">        submenu.Append(-<span class="number">1</span>, <span class="string">&quot;Sub-item 1&quot;</span>)</span><br><span class="line">        submenu.Append(-<span class="number">1</span>, <span class="string">&quot;Sub-item 2&quot;</span>)</span><br><span class="line">        menu.Append(-<span class="number">1</span>, <span class="string">&quot;Sub-menu&quot;</span>, submenu)</span><br><span class="line">        menu.AppendSeparator()</span><br><span class="line">        exit = menu.Append(-<span class="number">1</span>, <span class="string">&quot;Exit&quot;</span>)</span><br><span class="line">        self.Bind(wx.EVT_MENU, self.OnExit, exit)</span><br><span class="line">        menuBar = wx.MenuBar()</span><br><span class="line">        menuBar.Append(menu, <span class="string">&quot;Menu&quot;</span>)</span><br><span class="line">        self.SetMenuBar(menuBar)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">OnExit</span>(<span class="params">self, event</span>):</span></span><br><span class="line">        self.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app = wx.App()</span><br><span class="line">    frame = MyFrame()</span><br><span class="line">    frame.Show()</span><br><span class="line">    app.MainLoop()</span><br></pre></td></tr></table></figure>

<p>回到ImagePy的解析菜单功能，调用的函数如下，其中的形参datas的值为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">datas =  (&lt;module &#x27;imagepy.menus&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\__init__.py&#x27;&gt;, [(&lt;module &#x27;imagepy.menus.File&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\__init__.py&#x27;&gt;, [(&lt;module &#x27;imagepy.menus.File.BMP&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\BMP\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.SaveFile&#x27;&gt;])]), (&lt;module &#x27;imagepy.menus.Edit&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\Edit\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.Edit.edit_plg.Undo&#x27;&gt;, &#x27;-&#x27;, &lt;class &#x27;imagepy.menus.Edit.edit_plg.ClearOut&#x27;&gt;])])</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>即还是跟之前一节的值一样。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buildMenuBar</span>(<span class="params">parent, datas, menuBar=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> menuBar==<span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 创建wxPython菜单栏对象</span></span><br><span class="line">        menuBar = wx.MenuBar()</span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> datas[<span class="number">1</span>]:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;data = &quot;</span>, data)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(data[<span class="number">1</span>]) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;data.title = &quot;</span>, data[<span class="number">0</span>].title)</span><br><span class="line">        LanguageManager.add(data[<span class="number">0</span>].title)</span><br><span class="line">        <span class="comment"># 这个地方又调用了下面的buildMenu来创建菜单</span></span><br><span class="line">        menuBar.Append(buildMenu(parent, data, data[<span class="number">0</span>].title), LanguageManager.get(data[<span class="number">0</span>].title))</span><br><span class="line">    <span class="keyword">return</span> menuBar</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buildMenu</span>(<span class="params">parent, data, curpath</span>):</span></span><br><span class="line">    <span class="comment"># 创建wxPython菜单，这是为了后面将它加入MenuBar</span></span><br><span class="line">    menu = wx.Menu()</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> data[<span class="number">1</span>]:</span><br><span class="line">        <span class="comment"># 如果item是个tuple，就会进行递归构建</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, <span class="built_in">tuple</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;When item is a tuple&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;item = &quot;</span>, item)</span><br><span class="line">            nextpath = curpath + <span class="string">&#x27;.&#x27;</span> + item[<span class="number">0</span>].title</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;item&#x27;s title = &quot;</span>, item[<span class="number">0</span>].title)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;nextpath = &quot;</span>, nextpath)</span><br><span class="line">            LanguageManager.add(item[<span class="number">0</span>].title)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 这个地方也可用于子菜单的构建</span></span><br><span class="line">            menu.Append(-<span class="number">1</span>, LanguageManager.get(item[<span class="number">0</span>].title), buildMenu(parent, item,nextpath))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 如果item不是个tuple，是个具体的class，那么就会进入构建菜单项（注意是菜单项）并绑定事件</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;When item is NOT a tuple&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;item = &quot;</span>, item)</span><br><span class="line">            buildItem(parent, menu, item)</span><br><span class="line">    <span class="keyword">return</span> menu</span><br></pre></td></tr></table></figure>
<p>针对于传入的datas那个值，上面的输出为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">data =  (&lt;module &#x27;imagepy.menus.File&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\__init__.py&#x27;&gt;, [(&lt;module &#x27;imagepy.menus.File.BMP&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\BMP\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.SaveFile&#x27;&gt;])])</span><br><span class="line">data.title =  File</span><br><span class="line">When item <span class="keyword">is</span> a <span class="built_in">tuple</span></span><br><span class="line">item =  (&lt;module &#x27;imagepy.menus.File.BMP&#x27; from &#x27;D:\\imagepy-master\\imagepy\\menus\\File\\BMP\\__init__.py&#x27;&gt;, [&lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.OpenFile&#x27;&gt;, &lt;class &#x27;imagepy.menus.File.BMP.bmp_plgs.SaveFile&#x27;&gt;])</span><br><span class="line">item<span class="string">&#x27;s title =  BMP</span></span><br><span class="line"><span class="string">nextpath =  File.BMP</span></span><br><span class="line"><span class="string">When item is NOT a tuple</span></span><br><span class="line"><span class="string">item =  &lt;class &#x27;</span>imagepy.menus.File.BMP.bmp_plgs.OpenFile<span class="string">&#x27;&gt;</span></span><br><span class="line"><span class="string">When item is NOT a tuple</span></span><br><span class="line"><span class="string">item =  &lt;class &#x27;</span>imagepy.menus.File.BMP.bmp_plgs.SaveFile<span class="string">&#x27;&gt;</span></span><br><span class="line"><span class="string">data =  (&lt;module &#x27;</span>imagepy.menus.Edit<span class="string">&#x27; from &#x27;</span>D:\\imagepy-master\\imagepy\\menus\\Edit\\__init__.py<span class="string">&#x27;&gt;, [&lt;class &#x27;</span>imagepy.menus.Edit.edit_plg.Undo<span class="string">&#x27;&gt;, &#x27;</span>-<span class="string">&#x27;, &lt;class &#x27;</span>imagepy.menus.Edit.edit_plg.ClearOut<span class="string">&#x27;&gt;])</span></span><br><span class="line"><span class="string">data.title =  Edit</span></span><br><span class="line"><span class="string">When item is NOT a tuple</span></span><br><span class="line"><span class="string">item =  &lt;class &#x27;</span>imagepy.menus.Edit.edit_plg.Undo<span class="string">&#x27;&gt;</span></span><br><span class="line"><span class="string">When item is NOT a tuple</span></span><br><span class="line"><span class="string">item =  -</span></span><br><span class="line"><span class="string">When item is NOT a tuple</span></span><br><span class="line"><span class="string">item =  &lt;class &#x27;</span>imagepy.menus.Edit.edit_plg.ClearOut<span class="string">&#x27;&gt;</span></span><br></pre></td></tr></table></figure>
<p>从上面的输出可以清楚地看到解析过程。当item是一个具体的class时，就会进入下面的buildItem函数，进行菜单项的创建，以及绑定事件。这个地方又有一个小绕绕，即它绑定的事件这里使用了lambda表达式，即匿名函数，所以比较难看懂，见：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parent.Bind(wx.EVT_MENU, <span class="keyword">lambda</span> x, p=item:p().start(), mi)</span><br></pre></td></tr></table></figure>
<p>其实这个函数就是将item传给p，然后调用了p的start()函数，那么start()函数在哪？<br>这就牵扯到了ImagePy所定义的各种引擎engine，比如基础引擎Simple、自由引擎Free、宏引擎Macros等，这些引擎都在engine文件夹下定义。而之前的插件类实际都是这些引擎的派生，自然也就继承了每个引擎的start()函数。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2019/07/26/tensorflow-gpu-install/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Be interesting!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="亓欣波">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/26/tensorflow-gpu-install/" class="post-title-link" itemprop="url">linux系统Tensorflow GPU版安装过程记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-07-26 00:00:00" itemprop="dateCreated datePublished" datetime="2019-07-26T00:00:00+08:00">2019-07-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-25 15:20:30" itemprop="dateModified" datetime="2021-03-25T15:20:30+08:00">2021-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/07/26/tensorflow-gpu-install/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/07/26/tensorflow-gpu-install/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><p>Linux系统还是建议选Ubuntu系的，首先是驱动支持得全面，再者是Ubuntu源很给力，安装软件不费劲。<br>这里选择的Linux发行版是Linux Mint 19，它也是Ubuntu系的，界面比原生的Ubuntu要舒服，且软件源也是用的Ubuntu的。</p>
<h1 id="安装Nvidia-GPU驱动"><a href="#安装Nvidia-GPU驱动" class="headerlink" title="安装Nvidia GPU驱动"></a>安装Nvidia GPU驱动</h1><p>首先确认系统是否有Nvidia GPU驱动：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvidia-smi</span><br></pre></td></tr></table></figure>
<p>如果显示没有驱动的话，则需要下载安装驱动，可以有多种方式安装，最简单的一种是通过Ubuntu或Linux Mint的Driver Manager。打开该管理器，等待更新缓存后，就会有可用的Nvidia驱动下载，建议下载最新的，比如最新的TF就需要驱动版本在410以上。<br>也可以直接上Nvidia官网上下载，链接是：<br><a target="_blank" rel="noopener" href="https://www.nvidia.com/Download/index.aspx?lang=en-us">https://www.nvidia.com/Download/index.aspx?lang=en-us</a><br>但是安装可能很费劲，比如手动禁用开源的Nvidia驱动nouveau等。<br>下面是一篇很详细的安装方法，见：<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/wf19930209/article/details/81877822">Linux安装NVIDIA显卡驱动的正确姿势</a></p>
<h1 id="安装CUDA工具集"><a href="#安装CUDA工具集" class="headerlink" title="安装CUDA工具集"></a>安装CUDA工具集</h1><p>CUDA的版本与TF的版本要对应好，这里要安装的是TF-1.14，它对应的是CUDA10，所以这里下载并安装CUDA10。<br>下载链接是：<br><a target="_blank" rel="noopener" href="https://developer.nvidia.com/cuda-toolkit-archive">CUDA Toolkit Archive</a><br>依次选择系统、架构、发行版、发行版版本、安装类型后，就会出现下载链接及安装步骤，如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -i cuda-repo-ubuntu1804<span class="number">-10</span><span class="number">-1</span>-local<span class="number">-10.1</span><span class="number">.168</span><span class="number">-418.67</span>_1<span class="number">.0</span><span class="number">-1</span>_amd64.deb</span><br><span class="line">sudo apt-key add /var/cuda-repo-&lt;version&gt;/<span class="number">7f</span>a2af80.pub</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install cuda</span><br></pre></td></tr></table></figure>
<p>然后再将可执行文件和链接库的路径加入到环境变量中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> PATH=/usr/local/cuda<span class="number">-10.1</span>/bin:$PATH</span><br><span class="line"><span class="keyword">export</span> LD_LIBRARY_PATH=/usr/local/cuda<span class="number">-10.1</span>/lib64:$LD_LIBRARY_PATH</span><br></pre></td></tr></table></figure>
<p>如果有其他版本的cuda安装过，比如cuda9.1，那么需要首先完全卸载才行，否则会冲突：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt remove cuda</span><br><span class="line">sudo apt autoclean</span><br><span class="line">sudo apt remove cuda*</span><br><span class="line">sudo rm -rf /usr/local/cuda<span class="number">-9.1</span></span><br><span class="line">sudo rm -rf /usr/local/cuda</span><br><span class="line">sudo find / -name cuda<span class="number">-9</span>* (then remove all the files related to cuda<span class="number">-9.1</span>)</span><br></pre></td></tr></table></figure>

<h1 id="安装cuDNN"><a href="#安装cuDNN" class="headerlink" title="安装cuDNN"></a>安装cuDNN</h1><p>这里也是安装最新的，要大于7.4.1。<br>下载链接（要注册）：<br><a target="_blank" rel="noopener" href="https://developer.nvidia.com/rdp/form/cudnn-download-survey">https://developer.nvidia.com/rdp/form/cudnn-download-survey</a><br>选择好与前面cuda版本相对应的版本。<br>如果选择的是cuDNN Runtime Library for Ubuntu18.04 (Deb)。<br>则直接安装即可：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -i xxx.deb</span><br></pre></td></tr></table></figure>
<p>如果选择的是cuDNN Library for Linux，则解压后：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo cp cuda/include<span class="comment">/* /usr/local/cuda-10.1/include</span></span><br><span class="line"><span class="comment">sudo cp cuda/lib64/* /usr/local/cuda-10.1/lib64</span></span><br><span class="line"><span class="comment">sudo /sbin/ldconfig</span></span><br></pre></td></tr></table></figure>
<h1 id="安装tensorflow-gpu"><a href="#安装tensorflow-gpu" class="headerlink" title="安装tensorflow-gpu"></a>安装tensorflow-gpu</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">conda create -n tf python=<span class="number">3.7</span></span><br><span class="line">source activate tf</span><br><span class="line">pip install tensorflow-gpu</span><br></pre></td></tr></table></figure>

<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&quot;import tensorflow as tf;print(tf.reduce_sum(tf.random.normal([1000, 1000])))&quot;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xin-Bo Qi(亓欣波)"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Xin-Bo Qi(亓欣波)</p>
  <div class="site-description" itemprop="description">Be interesting!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">120</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/qixinbo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qixinbo" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:qixinbo@gmail.com" title="E-Mail → mailto:qixinbo@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.tsinghua.edu.cn/" title="https:&#x2F;&#x2F;www.tsinghua.edu.cn" rel="noopener" target="_blank">THU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.imr.cas.cn/" title="http:&#x2F;&#x2F;www.imr.cas.cn" rel="noopener" target="_blank">IMR</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.sdu.edu.cn/" title="http:&#x2F;&#x2F;www.sdu.edu.cn" rel="noopener" target="_blank">SDU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://liam0205.me/" title="http:&#x2F;&#x2F;liam0205.me&#x2F;" rel="noopener" target="_blank">黄晨成</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xin-Bo Qi(亓欣波)</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://qixinbo.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
