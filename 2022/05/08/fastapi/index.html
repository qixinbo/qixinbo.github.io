<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qixinbo.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="参考文献： FastAPI官方文档 中文翻译 （注意，当前2022年5月8日的中文翻译有一些错误）  介绍 FastAPI 是一个用于构建 API 的现代、快速（高性能）的 web 框架，使用 Python 3.6+ 并基于标准的 Python 类型提示。 FastAPI 站在以下巨人的肩膀之上：   * Starlette负责 web 部分。  * Pydantic负责数据部分。  安装 1">
<meta property="og:type" content="article">
<meta property="og:title" content="FastAPI用户指南">
<meta property="og:url" content="http://qixinbo.github.io/2022/05/08/fastapi/index.html">
<meta property="og:site_name" content="数字旗手">
<meta property="og:description" content="参考文献： FastAPI官方文档 中文翻译 （注意，当前2022年5月8日的中文翻译有一些错误）  介绍 FastAPI 是一个用于构建 API 的现代、快速（高性能）的 web 框架，使用 Python 3.6+ 并基于标准的 Python 类型提示。 FastAPI 站在以下巨人的肩膀之上：   * Starlette负责 web 部分。  * Pydantic负责数据部分。  安装 1">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-05-07T16:00:00.000Z">
<meta property="article:modified_time" content="2022-05-13T03:58:58.584Z">
<meta property="article:author" content="Xin-Bo Qi(亓欣波)">
<meta property="article:tag" content="FastAPI">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://qixinbo.github.io/2022/05/08/fastapi/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>FastAPI用户指南 | 数字旗手</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="数字旗手" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">数字旗手</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">电气化、自动化、数字化、智能化、智慧化</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-scholar">

    <a href="/scholar/" rel="section"><i class="fa fa-chart-bar fa-fw"></i>scholar</a>

  </li>
        <li class="menu-item menu-item-sources">

    <a href="/sources/" rel="section"><i class="fa fa-rss fa-fw"></i>sources</a>

  </li>
        <li class="menu-item menu-item-gallery">

    <a href="/gallery/" rel="section"><i class="fa fa-file-image fa-fw"></i>gallery</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404.html" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://qixinbo.github.io/2022/05/08/fastapi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Xin-Bo Qi(亓欣波)">
      <meta itemprop="description" content="Digitize everything to realize Digitalization!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="数字旗手">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          FastAPI用户指南
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-08 00:00:00" itemprop="dateCreated datePublished" datetime="2022-05-08T00:00:00+08:00">2022-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-13 11:58:58" itemprop="dateModified" datetime="2022-05-13T11:58:58+08:00">2022-05-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/coding/" itemprop="url" rel="index"><span itemprop="name">coding</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2022/05/08/fastapi/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/05/08/fastapi/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>参考文献：<br><a target="_blank" rel="noopener" href="https://fastapi.tiangolo.com/">FastAPI官方文档</a><br><a target="_blank" rel="noopener" href="https://fastapi.tiangolo.com/zh/">中文翻译</a><br>（注意，当前2022年5月8日的中文翻译有一些错误）</p>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>FastAPI 是一个用于构建 API 的现代、快速（高性能）的 web 框架，使用 Python 3.6+ 并基于标准的 Python 类型提示。<br>FastAPI 站在以下巨人的肩膀之上：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.starlette.io/">Starlette</a>负责 web 部分。</li>
<li><a target="_blank" rel="noopener" href="https://pydantic-docs.helpmanual.io/">Pydantic</a>负责数据部分。</li>
</ul>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install fastapi</span><br></pre></td></tr></table></figure>
<p>还需要一个 ASGI 服务器，生产环境可以使用<a target="_blank" rel="noopener" href="https://www.uvicorn.org/">Uvicorn</a>或者<a target="_blank" rel="noopener" href="https://gitlab.com/pgjones/hypercorn">Hypercorn</a>。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install uvicorn[standard]</span><br></pre></td></tr></table></figure></p>
<h1 id="示例1"><a href="#示例1" class="headerlink" title="示例1"></a>示例1</h1><h2 id="源文件"><a href="#源文件" class="headerlink" title="源文件"></a>源文件</h2><p>创建一个<code>main.py</code>文件并写入以下内容:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_root</span>():</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;Hello&quot;</span>: <span class="string">&quot;World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">item_id: <span class="built_in">int</span>, q: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;q&quot;</span>: q&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uvicorn main:app --reload</span><br></pre></td></tr></table></figure>
<p>uvicorn main:app 命令含义如下:</p>
<ul>
<li><code>main</code>：main.py 文件（一个 Python “模块”）。</li>
<li><code>app</code>：在 main.py 文件中通过 app = FastAPI() 创建的对象。</li>
<li><code>--reload</code>：让服务器在更新代码后重新启动。仅在开发时使用该选项。</li>
</ul>
<h2 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h2><p>使用浏览器访问<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/items/5?q=somequery">http://127.0.0.1:8000/items/5?q=somequery</a>。<br>将会看到如下 JSON 响应：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;item_id&quot;</span>:<span class="number">5</span>,<span class="string">&quot;q&quot;</span>:<span class="string">&quot;somequery&quot;</span>&#125;</span><br></pre></td></tr></table></figure><br>这里已经创建了一个具有以下功能的 API：</p>
<ul>
<li>通过路径 <code>/</code> 和 <code>/items/&#123;item_id&#125;</code> 接受 HTTP 请求。</li>
<li>以上路径 都接受 GET 操作（也被称为 HTTP 方法）。</li>
<li><code>/items/&#123;item_id&#125;</code> 路径 有一个路径参数 <code>item_id</code> 并且应该为<code>int</code>类型。</li>
<li><code>/items/&#123;item_id&#125;</code> 路径 有一个可选的<code>str</code>类型的查询参数 <code>q</code>。</li>
</ul>
<h2 id="交互式API文档"><a href="#交互式API文档" class="headerlink" title="交互式API文档"></a>交互式API文档</h2><p>现在访问<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/docs">http://127.0.0.1:8000/docs</a>。<br>会看到自动生成的交互式 API 文档（由 <a target="_blank" rel="noopener" href="https://github.com/swagger-api/swagger-ui">Swagger UI</a>生成）。</p>
<h2 id="可选的API文档"><a href="#可选的API文档" class="headerlink" title="可选的API文档"></a>可选的API文档</h2><p>访问<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/redoc">http://127.0.0.1:8000/redoc</a>。<br>会看到另一个自动生成的文档（由<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/redoc">ReDoc</a>生成）。<br>Redoc也很有用，尤其有时它检测到的请求体格式要比Swagger的准确。</p>
<h1 id="示例2"><a href="#示例2" class="headerlink" title="示例2"></a>示例2</h1><p>现在修改<code>main.py</code>文件来从<code>PUT</code>请求中接收请求体。<br>以及借助<code>Pydantic</code>来使用标准的 Python 类型声明请求体。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    is_offer: <span class="type">Optional</span>[<span class="built_in">bool</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_root</span>():</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;Hello&quot;</span>: <span class="string">&quot;World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">item_id: <span class="built_in">int</span>, q: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;q&quot;</span>: q&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_name&quot;</span>: item.name, <span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br></pre></td></tr></table></figure><br>请求体是一个JSON格式的数据体。</p>
<p>对于上面的代码，FastAPI 将会：</p>
<ul>
<li>校验<code>GET</code>和<code>PUT</code>请求的路径中是否含有<code>item_id</code></li>
<li>校验<code>GET</code>和<code>PUT</code>请求中的<code>item_id</code>是否为<code>int</code>类型：如果不是，客户端将会收到清晰有用的错误信息。</li>
<li>检查<code>GET</code>请求中是否有命名为<code>q</code>的可选查询参数：因为<code>q</code>被声明为<code>= None</code>，所以它是可选的；如果没有<code>None</code>它将会是必需的 (如<code>PUT</code>例子中的请求体)。</li>
<li>对于访问<code>/items/&#123;item_id&#125;</code>的<code>PUT</code>请求，将请求体读取为 JSON 并：检查是否有必需属性<code>name</code>并且值为<code>str</code>类型 、检查是否有必需属性<code>price</code>并且值为 <code>float</code>类型、检查是否有可选属性<code>is_offer</code>， 如果有的话值应该为<code>bool</code>类型；以上过程对于多层嵌套的 JSON 对象同样也会执行。</li>
<li>自动对 JSON 进行转换或转换成 JSON。</li>
<li>通过 OpenAPI 文档来记录所有内容，可被用于：交互式文档系统和许多编程语言的客户端代码自动生成系统</li>
<li>直接提供 2 种交互式文档 web 界面。</li>
</ul>
<h1 id="Python类型提示"><a href="#Python类型提示" class="headerlink" title="Python类型提示"></a>Python类型提示</h1><p>Python 3.6+ 版本加入了对”类型提示”的支持。<br>这些”类型提示”是一种新的语法（在 Python 3.6 版本加入）用来声明一个变量的类型。<br>类型提示是如下这样的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">first_name:<span class="built_in">str</span>,last_name:<span class="built_in">str</span></span><br></pre></td></tr></table></figure><br>这和声明默认值是不同的，例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">first_name=<span class="string">&quot;john&quot;</span>,last_name=<span class="string">&quot;doe&quot;</span></span><br></pre></td></tr></table></figure><br>我们用的是冒号（:），不是等号（=）。<br>而且添加类型提示一般不会改变原来的运行结果。</p>
<h2 id="简单类型"><a href="#简单类型" class="headerlink" title="简单类型"></a>简单类型</h2><p>不只是 <code>str</code>，你能够声明所有的标准 Python 类型。<br>比如以下类型：<code>int</code>、<code>float</code>、<code>bool</code>、<code>bytes</code>。</p>
<h2 id="嵌套类型"><a href="#嵌套类型" class="headerlink" title="嵌套类型"></a>嵌套类型</h2><p>有些容器数据结构可以包含其他的值，比如 <code>dict</code>、<code>list</code>、<code>set</code> 和 <code>tuple</code>。它们内部的值也会拥有自己的类型。<br>你可以使用 Python 的 <code>typing</code> 标准库来声明这些类型以及子类型，它专门用来支持这些类型提示。<br>（注意，<code>typing</code>支持3.6版本以上的所有python版本，如果是3.9以上的版本，甚至不需要<code>typing</code>即可实现这些容器结构的类型声明）</p>
<h3 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h3><p>例如，让我们来定义一个由 <code>str</code> 组成的 <code>list</code> 变量。<br>从 <code>typing</code> 模块导入 <code>List</code>（注意是大写的 <code>L</code>）：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_items</span>(<span class="params">items: <span class="type">List</span>[<span class="built_in">str</span>]</span>):</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">        <span class="built_in">print</span>(item)</span><br></pre></td></tr></table></figure><br>同样以冒号（:）来声明这个变量。输入 <code>List</code> 作为类型。<br>由于列表是带有”子类型”的类型，所以把子类型<code>str</code>放在方括号中。这表示：”变量 <code>items</code> 是一个 <code>list</code>，并且这个列表里的每一个元素都是<code>str</code>“。</p>
<h3 id="元组和集合"><a href="#元组和集合" class="headerlink" title="元组和集合"></a>元组和集合</h3><p>声明<code>tuple</code> 和<code>set</code>的方法也是一样的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Set</span>, <span class="type">Tuple</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_items</span>(<span class="params">items_t: <span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">str</span>], items_s: <span class="type">Set</span>[<span class="built_in">bytes</span>]</span>):</span></span><br><span class="line">    <span class="keyword">return</span> items_t, items_s</span><br></pre></td></tr></table></figure><br>这表示：<br>（1）变量<code>items_t</code> 是一个<code>tuple</code>，其有三个元素，依次是<code>int</code>类型、<code>init</code>类型和<code>str</code>类型。<br>（2）变量<code>items_s</code>是一个<code>set</code>，其中的每个元素都是<code>bytes</code>类型。</p>
<h3 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h3><p>定义 <code>dict</code> 时，需要传入两个子类型，用逗号进行分隔。<br>第一个子类型声明 <code>dict</code> 的所有键，第二个子类型声明 <code>dict</code> 的所有值。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_items</span>(<span class="params">prices: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]</span>):</span></span><br><span class="line">    <span class="keyword">for</span> item_name, item_price <span class="keyword">in</span> prices.items():</span><br><span class="line">        <span class="built_in">print</span>(item_name)</span><br><span class="line">        <span class="built_in">print</span>(item_price)</span><br></pre></td></tr></table></figure><br>这表示，变量 prices 是一个 dict：这个 dict 的所有键为 <code>str</code> 类型（可以看作是字典内每个元素的名称），这个 dict 的所有值为 <code>float</code> 类型（可以看作是字典内每个元素的价格）。</p>
<h2 id="类作为类型"><a href="#类作为类型" class="headerlink" title="类作为类型"></a>类作为类型</h2><p>也可以将类声明为变量的类型。<br>假设你有一个名为 <code>Person</code> 的类，拥有 <code>name</code>属性，就可以如下这样将类声明为类型：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name: <span class="built_in">str</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_person_name</span>(<span class="params">one_person: Person</span>):</span></span><br><span class="line">    <span class="keyword">return</span> one_person.name</span><br></pre></td></tr></table></figure></p>
<h2 id="Pydantic模型"><a href="#Pydantic模型" class="headerlink" title="Pydantic模型"></a>Pydantic模型</h2><p>Pydantic 是一个用来用来执行数据校验的 Python 库。<br>你可以将数据的”结构”声明为带属性的类，然后每个属性都拥有类型。<br>接着可以用一些值来创建这个类的实例，这些值会被校验，并被转换为适当的类型（在需要的情况下），返回一个包含所有数据的对象。<br>一个例子如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入pydantic的BaseModel</span></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 继承BaseModel，形成一个带属性的类，每个属性都可以声明类型，且有默认值</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line">    name = <span class="string">&quot;John Doe&quot;</span></span><br><span class="line">    signup_ts: <span class="type">Optional</span>[datetime] = <span class="literal">None</span></span><br><span class="line">    friends: <span class="type">List</span>[<span class="built_in">int</span>] = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">external_data = &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">    <span class="string">&quot;signup_ts&quot;</span>: <span class="string">&quot;2017-06-01 12:22&quot;</span>,</span><br><span class="line">    <span class="string">&quot;friends&quot;</span>: [<span class="number">1</span>, <span class="string">&quot;2&quot;</span>, <span class="string">b&quot;3&quot;</span>],</span><br><span class="line">&#125;</span><br><span class="line">user = User(**external_data)</span><br><span class="line"><span class="built_in">print</span>(user)</span><br><span class="line"><span class="comment"># &gt; User id=123 name=&#x27;John Doe&#x27; signup_ts=datetime.datetime(2017, 6, 1, 12, 22) friends=[1, 2, 3]</span></span><br><span class="line"><span class="built_in">print</span>(user.<span class="built_in">id</span>)</span><br><span class="line"><span class="comment"># &gt; 123</span></span><br></pre></td></tr></table></figure></p>
<h2 id="FastAPI-中的类型提示"><a href="#FastAPI-中的类型提示" class="headerlink" title="FastAPI 中的类型提示"></a>FastAPI 中的类型提示</h2><p>FastAPI 利用这些类型提示来做下面几件事。<br>使用 FastAPI 时用类型提示声明参数可以获得：<br>（1）编辑器支持，<br>（2）类型检查。<br>并且 FastAPI 还会用这些类型声明来：<br>（1）定义参数要求：声明对请求路径参数、查询参数、请求头、请求体、依赖等的要求。<br>（2）转换数据：将来自请求的数据转换为需要的类型。<br>（3）校验数据： 对于每一个请求：当数据校验失败时自动生成错误信息返回给客户端。<br>（4）使用 OpenAPI 记录 API，然后用于自动生成交互式文档的用户界面。</p>
<h1 id="并发和异步-等待"><a href="#并发和异步-等待" class="headerlink" title="并发和异步/等待"></a>并发和异步/等待</h1><p>如果使用的第三方库说了使用<code>await</code>来调用，例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">results = <span class="keyword">await</span> some_library()</span><br></pre></td></tr></table></figure><br>那么就用<code>async def</code>声明路径操作函数，如下所示：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_results</span>():</span></span><br><span class="line">    results = <span class="keyword">await</span> some_library()</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>如果正在使用一个第三方库来与某些东西（数据库、API、文件系统等）进行通信，并且它不支持使用<code>await</code>（目前大多数数据库都是这种情况），那么就只需<code>def</code>声明路径操作，例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">results</span>():</span></span><br><span class="line">    results = some_library()</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>如果你的应用程序（以某种方式）不必与其他任何东西通信并等待它响应，请使用<code>async def</code>。<br>如果你是啥都不知道，就直接使用普通<code>def</code>。</p>
<p>注意：可以根据需要混合使用<code>def</code>和<code>async def</code>。FastAPI 会对它们做正确的事情。<br>无论如何，在上述任何情况下，FastAPI 仍将以异步方式工作并且非常快。<br>但是按照上面的步骤，它将能够进行一些性能优化。</p>
<h1 id="用户指南"><a href="#用户指南" class="headerlink" title="用户指南"></a>用户指南</h1><h2 id="OpenAPI"><a href="#OpenAPI" class="headerlink" title="OpenAPI"></a>OpenAPI</h2><p>FastAPI 使用OpenAPI标准将所有 API 转换成模式schema。</p>
<h3 id="模式Schema"><a href="#模式Schema" class="headerlink" title="模式Schema"></a>模式Schema</h3><p>模式是对事物的一种定义或描述。它并非具体的实现代码，而只是抽象的描述。</p>
<h3 id="API模式"><a href="#API模式" class="headerlink" title="API模式"></a>API模式</h3><p>此时所指的API模式就是API的规范，OpenAPI 就是一种规定如何定义 API 模式的规范。<br> OpenAPI定义的模式包括API 路径，以及它们可能使用的参数等等。</p>
<h3 id="数据模式"><a href="#数据模式" class="headerlink" title="数据模式"></a>数据模式</h3><p>模式这个术语也可能指的是某些数据比如 JSON 的结构。<br>在这种情况下，它可以表示 JSON 的属性及其具有的数据类型，等等。</p>
<h3 id="OpenAPI-和-JSON-Schema"><a href="#OpenAPI-和-JSON-Schema" class="headerlink" title="OpenAPI 和 JSON Schema"></a>OpenAPI 和 JSON Schema</h3><p>OpenAPI定义了 API 模式。该模式中包含了你API 发送和接收的数据的定义（或称为数据模式），这些定义通过 JSON Schema 这一JSON 数据模式标准所生成。</p>
<h3 id="查看-openapi-json"><a href="#查看-openapi-json" class="headerlink" title="查看 openapi.json"></a>查看 openapi.json</h3><p>如果你对原始的 OpenAPI 模式长什么样子感到好奇，FastAPI自动生成了它，它就是一个json文件，可以通过<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/openapi.json">http://127.0.0.1:8000/openapi.json</a>访问。</p>
<h3 id="OpenAPI的用途"><a href="#OpenAPI的用途" class="headerlink" title="OpenAPI的用途"></a>OpenAPI的用途</h3><p>驱动 FastAPI 内置的 2 个交互式文档系统的正是 OpenAPI 模式。<br>并且还有数十种替代方案，它们全部都基于 OpenAPI。你可以轻松地将这些替代方案中的任何一种添加到使用 FastAPI 构建的应用程序中。<br>你还可以使用它自动生成与你的 API 进行通信的客户端代码。例如 web 前端，移动端或物联网嵌入程序。</p>
<h2 id="路径参数"><a href="#路径参数" class="headerlink" title="路径参数"></a>路径参数</h2><p>这里的路径指的是 URL 中从第一个 <code>/</code> 起的后半部分。<br>路径也通常被称为端点或路由。<br>开发 API 时，「路径」是用来分离「关注点」和「资源」的主要手段。<br>举例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">item_id</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br></pre></td></tr></table></figure><br>路径参数 <code>item_id</code> 的值将作为参数 <code>item_id</code> 传递给你的函数。</p>
<h3 id="有类型的路径参数"><a href="#有类型的路径参数" class="headerlink" title="有类型的路径参数"></a>有类型的路径参数</h3><p>可以使用标准的 Python 类型标注为函数中的路径参数声明类型。<br>比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">item_id: <span class="built_in">int</span></span>):</span> <span class="comment"># 声明item_id为int型</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="数据转换"><a href="#数据转换" class="headerlink" title="数据转换"></a>数据转换</h3><p>如果你运行示例并打开浏览器访问<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/items/3">http://127.0.0.1:8000/items/3</a>，那么将得到如下返回：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;item_id&quot;</span>:<span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure><br>注意函数接收（并返回）的值为 3，是一个 Python <code>int</code> 值，而不是字符串 <code>&quot;3&quot;</code>。<br>所以，FastAPI 通过上面的类型声明提供了对请求的自动”解析”。</p>
<h3 id="数据校验"><a href="#数据校验" class="headerlink" title="数据校验"></a>数据校验</h3><p>但如果你通过浏览器访问<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/items/foo">http://127.0.0.1:8000/items/foo</a>，你会看到一个清晰可读的 HTTP 错误：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;detail&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;loc&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;path&quot;</span>,</span><br><span class="line">                <span class="string">&quot;item_id&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;value is not a valid integer&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;type_error.integer&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>所以，通过同样的 Python 类型声明，FastAPI 提供了数据校验功能。<br>注意上面的错误同样清楚地指出了校验未通过的具体原因。<br>在开发和调试与你的 API 进行交互的代码时，这非常有用。</p>
<h3 id="路径的顺序"><a href="#路径的顺序" class="headerlink" title="路径的顺序"></a>路径的顺序</h3><p>在创建路径操作时，会发现有些情况下路径是固定的。<br>比如 <code>/users/me</code>，我们假设它用来获取关于当前用户的数据，然后，还可以使用路径 <code>/users/&#123;user_id&#125;</code> 来通过用户 ID 获取关于特定用户的数据。<br>由于路径操作是按顺序依次运行的，需要确保路径 <code>/users/me</code> 声明在路径 <code>/users/&#123;user_id&#125;</code>之前。否则，<code>/users/&#123;user_id&#125;</code> 的路径还将与 <code>/users/me</code> 相匹配，”认为”自己正在接收一个值为 <code>&quot;me&quot;</code> 的 <code>user_id</code> 参数。 </p>
<h3 id="预设值"><a href="#预设值" class="headerlink" title="预设值"></a>预设值</h3><p>如果有一个接收路径参数的路径操作，但希望预先设定可能的有效参数值，则可以使用标准的 Python Enum 类型。<br>比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入 Enum 并创建一个继承自 str 和 Enum 的子类。</span></span><br><span class="line"><span class="comment"># 通过从 str 继承，API 文档将能够知道这些值必须为 string 类型并且能够正确地展示出来。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelName</span>(<span class="params"><span class="built_in">str</span>, Enum</span>):</span></span><br><span class="line">    <span class="comment"># 然后创建具有固定值的类属性，这些固定值将是可用的有效值：</span></span><br><span class="line">    alexnet = <span class="string">&quot;alexnet&quot;</span></span><br><span class="line">    resnet = <span class="string">&quot;resnet&quot;</span></span><br><span class="line">    lenet = <span class="string">&quot;lenet&quot;</span></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/models/&#123;model_name&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># 使用你定义的枚举类（ModelName）创建一个带有类型标注的路径参数：</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_model</span>(<span class="params">model_name: ModelName</span>):</span></span><br><span class="line">    <span class="comment"># 路径参数的值是一个枚举成员</span></span><br><span class="line">    <span class="comment"># 可以将它与你创建的枚举类 ModelName 中的枚举成员进行比较</span></span><br><span class="line">    <span class="keyword">if</span> model_name == ModelName.alexnet:</span><br><span class="line">        <span class="comment"># 可以返回枚举成员，即使嵌套在 JSON 结构中（例如一个 dict 中）。</span></span><br><span class="line">        <span class="comment"># 在返回给客户端之前，它们将被转换为对应的值：</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;model_name&quot;</span>: model_name, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Deep Learning FTW!&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 可以使用 model_name.value 或通常来说 your_enum_member.value 来获取实际的值（在这个例子中它是一个字符串str）</span></span><br><span class="line">    <span class="comment"># 也可以通过 ModelName.lenet.value 来获取值 &quot;lenet&quot;。</span></span><br><span class="line">    <span class="keyword">if</span> model_name.value == <span class="string">&quot;lenet&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;model_name&quot;</span>: model_name, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;LeCNN all the images&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;model_name&quot;</span>: model_name, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Have some residuals&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="包含路径的路径参数"><a href="#包含路径的路径参数" class="headerlink" title="包含路径的路径参数"></a>包含路径的路径参数</h3><p>假设有一个路径操作，它的路径为 <code>/files/&#123;file_path&#125;</code>。<br>但是你需要 <code>file_path</code> 自身也包含路径，比如 <code>home/johndoe/myfile.txt</code>。<br>因此，该文件的URL将类似于这样：<code>/files/home/johndoe/myfile.txt</code>。</p>
<p>OpenAPI 不支持这样的声明路径参数以在其内部包含路径，因为这可能会导致难以测试和定义的情况出现。<br>不过，你仍然可以通过 Starlette 的一个内部工具在 FastAPI 中实现它。<br>而且文档依旧可以使用，但是不会添加任何文档，来说明该参数应包含路径。<br>可以使用直接来自 Starlette 的选项来声明一个包含路径的路径参数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/files/&#123;file_path:path&#125;</span><br></pre></td></tr></table></figure><br>在这种情况下，参数的名称为 <code>file_path</code>，结尾部分的 <code>:path</code> 说明该参数应匹配任意的路径。<br>因此，可以这样使用它：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 你可能会需要参数包含 /home/johndoe/myfile.txt，以斜杠（/）开头。</span></span><br><span class="line"><span class="comment"># 在这种情况下，URL 将会是 /files//home/johndoe/myfile.txt，在files 和 home 之间有一个双斜杠（//）。</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/files/&#123;file_path:path&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_file</span>(<span class="params">file_path: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;file_path&quot;</span>: file_path&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="额外校验"><a href="#额外校验" class="headerlink" title="额外校验"></a>额外校验</h3><p>可以使用Path为路径参数声明一些元数据及进行数值校验。<br>（1）声明元数据<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 fastapi 导入 Path（有关Query的用法参见下节的查询参数的校验）</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 声明路径参数 item_id的 title 元数据值</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 路径参数总是必需的，因为它必须是路径的一部分。所以，你应该在声明时使用 ... 将其标记为必需参数。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 然而，即使你使用 None 声明路径参数或设置一个其他默认值也不会有任何影响，它依然会是必需参数。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    item_id: <span class="built_in">int</span> = Path(<span class="params">..., title=<span class="string">&quot;The ID of the item to get&quot;</span></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">    q: <span class="type">Optional</span>[<span class="built_in">str</span>] = Query(<span class="params"><span class="literal">None</span>, alias=<span class="string">&quot;item-query&quot;</span></span>),</span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>（2）按需对参数排序<br>（2.1）FastAPI通过参数的名称、类型和默认值声明（Query、Path 等）来检测参数，而不在乎参数的顺序。<br>比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    q: <span class="built_in">str</span>, item_id: <span class="built_in">int</span> = Path(<span class="params">..., title=<span class="string">&quot;The ID of the item to get&quot;</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>（2.2）另外一种排序方式<br>如果声明查询参数<code>q</code>时既不想使用Query，也不想使用默认值，与此同时，使用 Path 声明路径参数 item_id，并使它们的顺序与上面不同，Python 对此有一些特殊的语法。即传递 <code>*</code>星号 作为函数的第一个参数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># Python 不会对该 * 做任何事情，但是它将知道之后的所有参数都应作为关键字参数（键值对），也被称为 kwargs，来调用。即使它们没有默认值。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    *, item_id: <span class="built_in">int</span> = Path(<span class="params">..., title=<span class="string">&quot;The ID of the item to get&quot;</span></span>), q: <span class="built_in">str</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>（3）数值校验<br>使用 Query 和 Path（以及你将在后面看到的其他类）可以声明字符串约束，但也可以声明数值约束。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 添加 ge=1 后，item_id 将必须是一个大于（greater than）或等于（equal）1 的整数。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># gt：大于（greater than）</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># le：小于等于（less than or equal）</span></span></span></span><br><span class="line"><span class="function"><span class="params">    *, </span></span></span><br><span class="line"><span class="function"><span class="params">    item_id: <span class="built_in">int</span> = Path(<span class="params">..., title=<span class="string">&quot;The ID of the item to get&quot;</span>, ge=<span class="number">1</span>, le=<span class="number">1000</span></span>), </span></span></span><br><span class="line"><span class="function"><span class="params">    q: <span class="built_in">str</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 数值校验同样适用于 float 值。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    size: <span class="built_in">float</span> = Query(<span class="params">..., gt=<span class="number">0</span>, lt=<span class="number">10.5</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<h2 id="查询参数"><a href="#查询参数" class="headerlink" title="查询参数"></a>查询参数</h2><p>声明不属于路径参数的其他函数参数时，它们将被自动解释为”查询字符串”参数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">fake_items_db = [&#123;<span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;, &#123;<span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;Baz&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">skip: <span class="built_in">int</span> = <span class="number">0</span>, limit: <span class="built_in">int</span> = <span class="number">10</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> fake_items_db[skip : skip + limit]</span><br></pre></td></tr></table></figure><br>查询字符串是键值对的集合，这些键值对位于 URL 的 <code>?</code> 之后，并以 <code>&amp;</code> 符号分隔。<br>比如以下URL：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8000/items/?skip=0&amp;limit=10</span><br></pre></td></tr></table></figure><br>查询参数为：<br>（1）skip：对应的值为 0<br>（2）limit：对应的值为 10<br>由于它们是 URL 的一部分，因此它们的”原始值”是字符串。<br>但是，当你为它们声明了 Python 类型（在上面的示例中为 <code>int</code>）时，它们将转换为该类型并针对该类型进行校验。<br>应用于路径参数的所有相同过程也适用于查询参数，包括编辑器支持、数据”解析”、数据校验、自动生成文档。</p>
<h3 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h3><p>由于查询参数不是路径的固定部分，因此它们可以是可选的，并且可以有默认值。<br>在上面的示例中，它们具有 <code>skip=0</code> 和 <code>limit=10</code> 的默认值。</p>
<h3 id="可选参数"><a href="#可选参数" class="headerlink" title="可选参数"></a>可选参数</h3><p>通过同样的方式，你可以将它们的默认值设置为 None 来声明可选查询参数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">item_id: <span class="built_in">str</span>, q: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;q&quot;</span>: q&#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="多个路径和查询参数"><a href="#多个路径和查询参数" class="headerlink" title="多个路径和查询参数"></a>多个路径和查询参数</h3><p>可以同时声明多个路径参数和查询参数，FastAPI 能够识别它们。<br>而且不需要以任何特定的顺序来声明。<br>它们将通过名称被检测到：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_user_item</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    user_id: <span class="built_in">int</span>, item_id: <span class="built_in">str</span>, q: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>, short: <span class="built_in">bool</span> = <span class="literal">False</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    item = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;owner_id&quot;</span>: user_id&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        item.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> short:</span><br><span class="line">        item.update(</span><br><span class="line">            &#123;<span class="string">&quot;description&quot;</span>: <span class="string">&quot;This is an amazing item that has a long description&quot;</span>&#125;</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure></p>
<h3 id="必需查询参数"><a href="#必需查询参数" class="headerlink" title="必需查询参数"></a>必需查询参数</h3><p>当你为非路径参数（目前而言，我们所知道的仅有查询参数）声明了默认值时，则该参数不是必需的。<br>如果你不想添加一个特定的值，而只是想使该参数成为可选的，则将默认值设置为 None。<br>但当你想让一个查询参数成为必需的，不声明任何默认值就可以：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_user_item</span>(<span class="params">item_id: <span class="built_in">str</span>, needy: <span class="built_in">str</span></span>):</span></span><br><span class="line">    item = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;needy&quot;</span>: needy&#125;</span><br><span class="line">    <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure></p>
<h3 id="额外校验-1"><a href="#额外校验-1" class="headerlink" title="额外校验"></a>额外校验</h3><p>FastAPI 允许你为参数声明额外的信息和校验，方法是使用Query。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 fastapi 导入 Query</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># 添加约束条件：即使 q 是可选的，但只要提供了该参数，则该参数值不能超过50个字符的长度。</span></span><br><span class="line"><span class="comment"># 方法就是将 Query 用作查询参数的默认值，并将它的 max_length 参数设置为 50</span></span><br><span class="line"><span class="comment"># 必须用 Query(None) 替换默认值 None，Query 的第一个参数同样也是用于定义默认值。</span></span><br><span class="line"><span class="comment"># max_length 参数将会校验数据，在数据无效时展示清晰的错误信息，并在 OpenAPI 模式的路径操作中记录该参数。</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params">q: <span class="type">Optional</span>[<span class="built_in">str</span>] = Query(<span class="params"><span class="literal">None</span>, max_length=<span class="number">50</span></span>)</span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;items&quot;</span>: [&#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;]&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 min_length 参数等更多校验，以及正则表达式</span></span><br><span class="line"><span class="comment"># @app.get(&quot;/items/&quot;)</span></span><br><span class="line"><span class="comment"># async def read_items(</span></span><br><span class="line"><span class="comment">#     q: Optional[str] = Query(None, min_length=3, max_length=50, regex=&quot;^fixedquery$&quot;)</span></span><br><span class="line"><span class="comment"># ):</span></span><br><span class="line"><span class="comment">#     results = &#123;&quot;items&quot;: [&#123;&quot;item_id&quot;: &quot;Foo&quot;&#125;, &#123;&quot;item_id&quot;: &quot;Bar&quot;&#125;]&#125;</span></span><br><span class="line"><span class="comment">#     if q:</span></span><br><span class="line"><span class="comment">#         results.update(&#123;&quot;q&quot;: q&#125;)</span></span><br><span class="line"><span class="comment">#     return results</span></span><br></pre></td></tr></table></figure></p>
<p>以上参数<code>q</code>默认值是<code>None</code>，所以它是可选的。<br>一般情形下不声明默认值就表明<code>q</code>是必需参数，但此时正在用 Query 声明它，因此，需要点特殊写法。<br>当在使用 Query 且需要声明一个值是必需的时，可以将 <code>...</code> 用作第一个参数值：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params">q: <span class="built_in">str</span> = Query(<span class="params">..., min_length=<span class="number">3</span></span>)</span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;items&quot;</span>: [&#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;]&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>这将使 FastAPI 知道此查询参数是必需的。</p>
<h3 id="查询参数列表或多个值"><a href="#查询参数列表或多个值" class="headerlink" title="查询参数列表或多个值"></a>查询参数列表或多个值</h3><p>要声明类型为 list 的查询参数，需要显式地使用 Query，否则该参数将被解释为请求体。<br>即当你使用 Query 显式地定义查询参数时，还可以声明它去接收一组值，或换句话来说，接收多个值。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params">q: <span class="type">Optional</span>[<span class="type">List</span>[<span class="built_in">str</span>]] = Query(<span class="params"><span class="literal">None</span></span>)</span>):</span></span><br><span class="line">    query_items = &#123;<span class="string">&quot;q&quot;</span>: q&#125;</span><br><span class="line">    <span class="keyword">return</span> query_items</span><br></pre></td></tr></table></figure><br>然后输入网址为:<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/items/?q=foo&amp;q=bar">http://127.0.0.1:8000/items/?q=foo&amp;q=bar</a><br>那么会在路径操作函数的函数参数 <code>q</code> 中以一个 Python list 的形式接收到查询参数 <code>q</code> 的多个值（<code>foo</code> 和 <code>bar</code>）。<br>也可以对多个值配置默认值：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params">q: <span class="type">List</span>[<span class="built_in">str</span>] = Query(<span class="params">[<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>]</span>)</span>):</span></span><br><span class="line">    query_items = &#123;<span class="string">&quot;q&quot;</span>: q&#125;</span><br><span class="line">    <span class="keyword">return</span> query_items</span><br></pre></td></tr></table></figure></p>
<h3 id="Query的更多用法"><a href="#Query的更多用法" class="headerlink" title="Query的更多用法"></a>Query的更多用法</h3><p>（1）声明更多元数据<br>你可以添加更多有关该参数的信息，比如增加title和description。<br>这些信息将包含在生成的 OpenAPI 模式中，并由文档用户界面和外部工具所使用。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    q: <span class="type">Optional</span>[<span class="built_in">str</span>] = Query(<span class="params"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        <span class="literal">None</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        title=<span class="string">&quot;Query string&quot;</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        description=<span class="string">&quot;Query string for the items to search in the database that have a good match&quot;</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        min_length=<span class="number">3</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">    </span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;items&quot;</span>: [&#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;]&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>（2）别名参数<br>比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params">q: <span class="type">Optional</span>[<span class="built_in">str</span>] = Query(<span class="params"><span class="literal">None</span>, alias=<span class="string">&quot;item-query&quot;</span></span>)</span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;items&quot;</span>: [&#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;]&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>（3）弃用参数<br>现在假设你不再喜欢此参数。<br>你不得不将其保留一段时间，因为有些客户端正在使用它，但你希望文档清楚地将其展示为已弃用。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    q: <span class="type">Optional</span>[<span class="built_in">str</span>] = Query(<span class="params"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        <span class="literal">None</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        alias=<span class="string">&quot;item-query&quot;</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        title=<span class="string">&quot;Query string&quot;</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        description=<span class="string">&quot;Query string for the items to search in the database that have a good match&quot;</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        min_length=<span class="number">3</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        max_length=<span class="number">50</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        regex=<span class="string">&quot;^fixedquery$&quot;</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        <span class="comment"># 配置该参数deprecated=True</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        deprecated=<span class="literal">True</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">    </span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;items&quot;</span>: [&#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;]&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        results.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<h2 id="请求体"><a href="#请求体" class="headerlink" title="请求体"></a>请求体</h2><p>当需要将数据从客户端（例如浏览器）发送给 API 时，需要将其作为“请求体”发送。<br>请求体request body是客户端发送给 API 的数据。响应体response body是 API 发送给客户端的数据。<br>你的 API 几乎总是要发送响应体。但是客户端并不总是需要发送请求体。<br>FastAPI使用 Pydantic 模型来声明请求体。<br>注意：不能使用 GET 操作（HTTP 方法）发送请求体。要发送数据，必须使用下列方法之一：POST（较常见）、PUT、DELETE 或 PATCH。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="comment"># 从 pydantic 中导入 BaseModel</span></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将你的数据模型声明为继承自 BaseModel 的类</span></span><br><span class="line"><span class="comment"># 使用标准的 Python 类型来声明所有属性</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    <span class="comment"># 和声明查询参数时一样，当一个模型属性具有默认值时，它不是必需的。否则它是一个必需属性。将默认值设为 None 可使其成为可选属性。</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用与声明路径和查询参数的相同方式声明请求体，即可将其添加到「路径操作」中</span></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_item</span>(<span class="params">item: Item</span>):</span></span><br><span class="line">    <span class="comment"># 在函数内部，你可以直接访问模型对象的所有属性</span></span><br><span class="line">    item_dict = item.<span class="built_in">dict</span>()</span><br><span class="line">    <span class="keyword">if</span> item.tax:</span><br><span class="line">        price_with_tax = item.price + item.tax</span><br><span class="line">        item_dict.update(&#123;<span class="string">&quot;price_with_tax&quot;</span>: price_with_tax&#125;)</span><br><span class="line">    <span class="keyword">return</span> item_dict</span><br></pre></td></tr></table></figure><br>可以看出，仅仅使用了 Python 类型声明，FastAPI 将会：<br>（1）将请求体作为 JSON 读取。<br>（2）转换为相应的类型（在需要时）。<br>（3）校验数据：如果数据无效，将返回一条清晰易读的错误信息，指出不正确数据的确切位置和内容。<br>（4）将接收的数据赋值到参数 item 中：由于已经在函数中将它声明为 Item 类型，还将获得对于所有属性及其类型的一切编辑器支持（代码补全等）。<br>（5）为模型生成 JSON 模式 定义，这些模式将成为生成的 OpenAPI 模式的一部分，并且被自动化文档 UI 所使用。</p>
<h3 id="请求体-路径参数-查询参数"><a href="#请求体-路径参数-查询参数" class="headerlink" title="请求体 + 路径参数 + 查询参数"></a>请求体 + 路径参数 + 查询参数</h3><p>还可以同时声明请求体、路径参数和查询参数。<br>FastAPI 会识别它们中的每一个，并从正确的位置获取数据。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item, q: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>):</span></span><br><span class="line">    result = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, **item.<span class="built_in">dict</span>()&#125;</span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        result.update(&#123;<span class="string">&quot;q&quot;</span>: q&#125;)</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><br>函数参数将依次按如下规则进行识别：<br>（1）如果在路径中也声明了该参数，它将被用作路径参数。<br>（2）如果参数属于单一类型（比如 int、float、str、bool 等）它将被解释为查询参数。<br>（3）如果参数的类型被声明为一个 Pydantic 模型，它将被解释为请求体。</p>
<h3 id="可选请求体"><a href="#可选请求体" class="headerlink" title="可选请求体"></a>可选请求体</h3><p>可以通过将默认值设置为 None 来将请求体参数声明为可选参数。</p>
<h3 id="多个请求体参数"><a href="#多个请求体参数" class="headerlink" title="多个请求体参数"></a>多个请求体参数</h3><p>可以添加多个请求体参数到路径操作函数中，即使一个请求只能有一个请求体。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    full_name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># FastAPI 将注意到该函数中有多个请求体参数（两个 Pydantic 模型参数）。</span></span><br><span class="line"><span class="comment"># 它将使用参数名称作为请求体中的键（字段名称），并期望一个类似于以下内容的请求体</span></span><br><span class="line"><span class="comment"># &#123;</span></span><br><span class="line"><span class="comment">#     &quot;item&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;name&quot;: &quot;Foo&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;description&quot;: &quot;The pretender&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;price&quot;: 42.0,</span></span><br><span class="line"><span class="comment">#         &quot;tax&quot;: 3.2</span></span><br><span class="line"><span class="comment">#     &#125;,</span></span><br><span class="line"><span class="comment">#     &quot;user&quot;: &#123;</span></span><br><span class="line"><span class="comment">#         &quot;username&quot;: &quot;dave&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;full_name&quot;: &quot;Dave Grohl&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item, user: User</span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item, <span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<h3 id="请求体中的单一值"><a href="#请求体中的单一值" class="headerlink" title="请求体中的单一值"></a>请求体中的单一值</h3><p>与使用 Query 和 Path 为查询参数和路径参数定义额外数据的方式相同，FastAPI 提供了一个同等的 Body。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Body, FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    full_name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 例如，为了扩展先前的模型，你可能决定除了 item 和 user 之外，还想在同一请求体中具有另一个键 importance。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 如果就按原样声明它，因为它是一个单一值，FastAPI 将假定它是一个查询参数。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 但是可以使用 Body 指示 FastAPI 将其作为请求体的另一个键进行处理。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># Body 同样具有与 Query、Path 以及其他后面将看到的类完全相同的额外校验和元数据参数。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    item_id: <span class="built_in">int</span>, item: Item, user: User, importance: <span class="built_in">int</span> = Body(<span class="params">...</span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item, <span class="string">&quot;user&quot;</span>: user, <span class="string">&quot;importance&quot;</span>: importance&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<h3 id="单个请求体参数嵌入一个键中"><a href="#单个请求体参数嵌入一个键中" class="headerlink" title="单个请求体参数嵌入一个键中"></a>单个请求体参数嵌入一个键中</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Body, FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    item_id: <span class="built_in">int</span>, </span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 假设只有一个来自 Pydantic 模型 Item 的请求体参数 item。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 默认情况下，FastAPI 将直接期望这样的请求体。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 但是，如果希望它拥有 item 键，就像在声明额外的请求体参数时所做的那样</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 则可以使用一个特殊的 Body 参数 embed。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 在这种情况下，FastAPI 将期望像这样的请求体：</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">#     &quot;item&quot;: &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">#         &quot;name&quot;: &quot;Foo&quot;,</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">#         &quot;description&quot;: &quot;The pretender&quot;,</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">#         &quot;price&quot;: 42.0,</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">#         &quot;tax&quot;: 3.2</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">#     &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 而不是：</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># &#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">#     &quot;name&quot;: &quot;Foo&quot;,</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">#     &quot;description&quot;: &quot;The pretender&quot;,</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">#     &quot;price&quot;: 42.0,</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">#     &quot;tax&quot;: 3.2</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># &#125;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    item: Item = Body(<span class="params">..., embed=<span class="literal">True</span></span>)</span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure>
<h3 id="请求体中的字段校验"><a href="#请求体中的字段校验" class="headerlink" title="请求体中的字段校验"></a>请求体中的字段校验</h3><p>与使用 Query、Path 和 Body 在路径操作函数中声明额外的校验和元数据的方式相同，可以使用 Pydantic 的 Field 在 Pydantic 模型内部声明校验和元数据。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Body, FastAPI</span><br><span class="line"><span class="comment"># 注意，Field 是直接从 pydantic 导入的，而不是像其他的（Query，Path，Body 等）都从 fastapi 导入。</span></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    <span class="comment"># 对模型属性使用 Field</span></span><br><span class="line">    <span class="comment"># Field 的工作方式和 Query、Path 和 Body 相同，包括它们的参数等等也完全相同。</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(</span><br><span class="line">        <span class="literal">None</span>, title=<span class="string">&quot;The description of the item&quot;</span>, max_length=<span class="number">300</span></span><br><span class="line">    )</span><br><span class="line">    price: <span class="built_in">float</span> = Field(..., gt=<span class="number">0</span>, description=<span class="string">&quot;The price must be greater than zero&quot;</span>)</span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item = Body(<span class="params">..., embed=<span class="literal">True</span></span>)</span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<h3 id="嵌套模型"><a href="#嵌套模型" class="headerlink" title="嵌套模型"></a>嵌套模型</h3><p>（1）普通python类型作为嵌套<br>使用 FastAPI，你可以定义、校验、记录文档并使用任意深度嵌套的模型（归功于Pydantic）。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line">    <span class="comment"># 将一个属性定义为拥有子元素的类型，比如list</span></span><br><span class="line">    <span class="comment"># 这将使 tags 成为一个由元素组成的列表。不过它没有声明每个元素的类型。</span></span><br><span class="line">    <span class="comment"># tags: list = []</span></span><br><span class="line">    <span class="comment"># 但是 Python 有一种特定的方法来声明具有子类型的列表：</span></span><br><span class="line">    tags: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item</span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>但是随后我们考虑了一下，意识到标签不应该重复，它们很大可能会是唯一的字符串。<br>Python 具有一种特殊的数据类型来保存一组唯一的元素，即 set。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Set</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line">    tags: <span class="type">Set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item</span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>这样，即使你收到带有重复数据的请求，这些数据也会被转换为一组唯一项。<br>而且，每当你输出该数据时，即使源数据有重复，它们也将作为一组唯一项输出。<br>并且还会被相应地标注 / 记录文档。</p>
<p>（2）Pydantic模型作为嵌套<br>Pydantic 模型的每个属性都具有类型。<br>但是这个类型本身可以是另一个 Pydantic 模型。<br>因此，你可以声明拥有特定属性名称、类型和校验的深度嵌套的 JSON 对象。<br>上述这些都可以任意的嵌套。<br>比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Set</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Image</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    url: <span class="built_in">str</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line">    tags: <span class="type">Set</span>[<span class="built_in">str</span>] = []</span><br><span class="line">    <span class="comment"># 将子模型用作类型</span></span><br><span class="line">    <span class="comment"># 这意味着 FastAPI 将期望类似于以下内容的请求体：</span></span><br><span class="line">    <span class="comment"># &#123;</span></span><br><span class="line">    <span class="comment">#     &quot;name&quot;: &quot;Foo&quot;,</span></span><br><span class="line">    <span class="comment">#     &quot;description&quot;: &quot;The pretender&quot;,</span></span><br><span class="line">    <span class="comment">#     &quot;price&quot;: 42.0,</span></span><br><span class="line">    <span class="comment">#     &quot;tax&quot;: 3.2,</span></span><br><span class="line">    <span class="comment">#     &quot;tags&quot;: [&quot;rock&quot;, &quot;metal&quot;, &quot;bar&quot;],</span></span><br><span class="line">    <span class="comment">#     &quot;image&quot;: &#123;</span></span><br><span class="line">    <span class="comment">#         &quot;url&quot;: &quot;http://example.com/baz.jpg&quot;,</span></span><br><span class="line">    <span class="comment">#         &quot;name&quot;: &quot;The Foo live&quot;</span></span><br><span class="line">    <span class="comment">#     &#125;</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">    image: <span class="type">Optional</span>[Image] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item</span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>（3）特殊类型及其校验<br>除了普通的单一值类型（如 str、int、float 等）外，还可以使用其他的更复杂的单一值类型。<br>要了解所有的可用选项，请查看关于 <a target="_blank" rel="noopener" href="https://pydantic-docs.helpmanual.io/usage/types/">Pydantic字段类型</a> 的文档。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Set</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, HttpUrl</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Image</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    <span class="comment"># 例如，在 Image 模型中我们有一个 url 字段，我们可以把它声明为 Pydantic 的 HttpUrl，而不是 str。</span></span><br><span class="line">   <span class="comment"># 该字符串将被检查是否为有效的 URL，并在 JSON Schema / OpenAPI 文档中进行记录。</span></span><br><span class="line">    url: HttpUrl</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line">    tags: <span class="type">Set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>()</span><br><span class="line">    image: <span class="type">Optional</span>[Image] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item</span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>（4）深度嵌套模型<br>可以定义任意深度的嵌套模型：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Set</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, HttpUrl</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Image</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    url: HttpUrl</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line">    tags: <span class="type">Set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>()</span><br><span class="line">    images: <span class="type">Optional</span>[<span class="type">List</span>[Image]] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Offer</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    items: <span class="type">List</span>[Item]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/offers/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_offer</span>(<span class="params">offer: Offer</span>):</span></span><br><span class="line">    <span class="keyword">return</span> offer</span><br></pre></td></tr></table></figure></p>
<h3 id="纯列表请求体"><a href="#纯列表请求体" class="headerlink" title="纯列表请求体"></a>纯列表请求体</h3><p>如果你期望的 JSON 请求体的最外层是一个 JSON <code>array</code>（即 Python <code>list</code>），则可以在路径操作函数的参数中声明此类型。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, HttpUrl</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Image</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    url: HttpUrl</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/images/multiple/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_multiple_images</span>(<span class="params">images: <span class="type">List</span>[Image]</span>):</span></span><br><span class="line">    <span class="keyword">return</span> images</span><br></pre></td></tr></table></figure></p>
<h3 id="任意dict构成的请求体"><a href="#任意dict构成的请求体" class="headerlink" title="任意dict构成的请求体"></a>任意dict构成的请求体</h3><p>也可以将请求体声明为使用某类型的key和其他类型的value的 dict。<br>无需事先知道有效的字段/属性（比如使用 Pydantic 模型的场景）是什么。<br>如果你想接收一些尚且未知的键，这将很有用。<br>还有一些奇葩的场景，如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/index-weights/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># 当你想要接收其他类型的键（键的类型通常都是str）时，例如 int。</span></span><br><span class="line"><span class="comment"># 请记住 JSON 仅支持将 str 作为键。</span></span><br><span class="line"><span class="comment"># 但是 Pydantic 具有自动转换数据的功能。</span></span><br><span class="line"><span class="comment"># 这意味着，即使你的 API 客户端只能将字符串作为键发送，只要这些字符串内容仅包含整数，Pydantic 就会对其进行转换并校验。</span></span><br><span class="line"><span class="comment"># 然后你接收的名为 weights 的 dict 实际上将具有 int 类型的键和 float 类型的值。</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_index_weights</span>(<span class="params">weights: <span class="type">Dict</span>[<span class="built_in">int</span>, <span class="built_in">float</span>]</span>):</span></span><br><span class="line">    <span class="keyword">return</span> weights</span><br></pre></td></tr></table></figure></p>
<h3 id="声明请求体的示例数据"><a href="#声明请求体的示例数据" class="headerlink" title="声明请求体的示例数据"></a>声明请求体的示例数据</h3><p>可以声明你想接收的数据的示例模样。<br>有几种方法可以做到：<br>（1）Pydantic schema_extra<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 可以使用 Config 和 schema_extra 为Pydantic模型声明一个示例</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Config</span>:</span></span><br><span class="line">        schema_extra = &#123;</span><br><span class="line">            <span class="string">&quot;example&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>,</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: <span class="string">&quot;A very nice Item&quot;</span>,</span><br><span class="line">                <span class="string">&quot;price&quot;</span>: <span class="number">35.4</span>,</span><br><span class="line">                <span class="string">&quot;tax&quot;</span>: <span class="number">3.2</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item</span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>（2）Field 的附加参数<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    <span class="comment"># 在 Field, Path, Query, Body 和其他你之后将会看到的工厂函数中，</span></span><br><span class="line">    <span class="comment"># 可以通过给工厂函数传递其他的任意参数来给JSON模式声明额外信息，比如增加 example。</span></span><br><span class="line">    <span class="comment"># 请记住，传递的那些额外参数不会添加任何验证，只会添加注释，用于文档的目的。</span></span><br><span class="line">    name: <span class="built_in">str</span> = Field(..., example=<span class="string">&quot;Foo&quot;</span>)</span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(<span class="literal">None</span>, example=<span class="string">&quot;A very nice Item&quot;</span>)</span><br><span class="line">    price: <span class="built_in">float</span> = Field(..., example=<span class="number">35.4</span>)</span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = Field(<span class="literal">None</span>, example=<span class="number">3.2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params">item_id: <span class="built_in">int</span>, item: Item</span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><br>（3）Body的额外参数<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Body, FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    item_id: <span class="built_in">int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    item: Item = Body(<span class="params"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        ...,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        example=&#123;</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;A very nice Item&quot;</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">            <span class="string">&quot;price&quot;</span>: <span class="number">35.4</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">            <span class="string">&quot;tax&quot;</span>: <span class="number">3.2</span>,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">        &#125;,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">    </span>),</span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    results = &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;item&quot;</span>: item&#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure></p>
<h3 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h3><p>（1）用<code>PUT</code>更新数据<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.encoders <span class="keyword">import</span> jsonable_encoder</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line">    tax: <span class="built_in">float</span> = <span class="number">10.5</span></span><br><span class="line">    tags: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">items = &#123;</span><br><span class="line">    <span class="string">&quot;foo&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">50.2</span>&#125;,</span><br><span class="line">    <span class="string">&quot;bar&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Bar&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The bartenders&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">62</span>, <span class="string">&quot;tax&quot;</span>: <span class="number">20.2</span>&#125;,</span><br><span class="line">    <span class="string">&quot;baz&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Baz&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="literal">None</span>, <span class="string">&quot;price&quot;</span>: <span class="number">50.2</span>, <span class="string">&quot;tax&quot;</span>: <span class="number">10.5</span>, <span class="string">&quot;tags&quot;</span>: []&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span>, response_model=Item</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> items[item_id]</span><br><span class="line"></span><br><span class="line"><span class="comment"># PUT 用于接收替换现有数据的数据。</span></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span>, response_model=Item</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params">item_id: <span class="built_in">str</span>, item: Item</span>):</span></span><br><span class="line">    <span class="comment"># 把输入数据转换为以 JSON 格式存储的数据（比如，使用 NoSQL 数据库时），可以使用 jsonable_encoder。例如，把 datetime 转换为 str。</span></span><br><span class="line">    update_item_encoded = jsonable_encoder(item)</span><br><span class="line">    items[item_id] = update_item_encoded</span><br><span class="line">    <span class="keyword">return</span> update_item_encoded</span><br></pre></td></tr></table></figure><br>当使用如下请求体：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;bar111&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">  <span class="string">&quot;price&quot;</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>用<code>PUT</code>更新<code>bar</code>时，因为上述数据未包含已存储的属性 <code>&quot;tax&quot;: 20.2</code>，新的输入模型会把 <code>&quot;tax&quot;: 10.5</code> 作为默认值。<br>因此，本次操作把 <code>tax</code> 的值「更新」为 <code>10.5</code>。<br>（2）用<code>PATCH</code>进行部分更新<br>HTTP PATCH 操作用于更新 部分 数据。<br>即，只发送要更新的数据，其余数据保持不变。<br>PATCH 没有 PUT 知名，也怎么不常用。<br>很多人甚至只用 PUT 实现部分更新。<br>FastAPI 对此没有任何限制，可以随意互换使用这两种操作。<br>但本指南也会分别介绍这两种操作各自的用途。<br>仍然以上述请求体为例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.encoders <span class="keyword">import</span> jsonable_encoder</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line">    tax: <span class="built_in">float</span> = <span class="number">10.5</span></span><br><span class="line">    tags: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">items = &#123;</span><br><span class="line">    <span class="string">&quot;foo&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">50.2</span>&#125;,</span><br><span class="line">    <span class="string">&quot;bar&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Bar&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The bartenders&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">62</span>, <span class="string">&quot;tax&quot;</span>: <span class="number">20.2</span>&#125;,</span><br><span class="line">    <span class="string">&quot;baz&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Baz&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="literal">None</span>, <span class="string">&quot;price&quot;</span>: <span class="number">50.2</span>, <span class="string">&quot;tax&quot;</span>: <span class="number">10.5</span>, <span class="string">&quot;tags&quot;</span>: []&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span>, response_model=Item</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> items[item_id]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.patch(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span>, response_model=Item</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params">item_id: <span class="built_in">str</span>, item: Item</span>):</span></span><br><span class="line">    stored_item_data = items[item_id]</span><br><span class="line">    stored_item_model = Item(**stored_item_data)</span><br><span class="line">    <span class="comment"># 更新部分数据时，可以在 Pydantic 模型的 `.dict()` 中使用 `exclude_unset` 参数。</span></span><br><span class="line">    <span class="comment"># 如下代码生成的 dict 只包含创建 item 模型时显式设置的数据，而不包括默认值。</span></span><br><span class="line">    <span class="comment"># 即：update_data =  &#123;&#x27;name&#x27;: &#x27;bar111&#x27;, &#x27;description&#x27;: &#x27;string&#x27;, &#x27;price&#x27;: 0.0&#125;</span></span><br><span class="line">    <span class="comment"># 而不是</span></span><br><span class="line">    <span class="comment"># update_data =  &#123;&#x27;name&#x27;: &#x27;bar111&#x27;, &#x27;description&#x27;: &#x27;string&#x27;, &#x27;price&#x27;: 0.0, &#x27;tax&#x27;: 10.5, &#x27;tags&#x27;: []&#125;</span></span><br><span class="line">    update_data = item.<span class="built_in">dict</span>(exclude_unset=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 接下来，用 .copy() 为已有模型创建调用 update 参数的副本，该参数为包含更新数据的 dict。</span></span><br><span class="line">    updated_item = stored_item_model.copy(update=update_data)</span><br><span class="line">    items[item_id] = jsonable_encoder(updated_item)</span><br><span class="line">    <span class="keyword">return</span> updated_item</span><br></pre></td></tr></table></figure><br>实际上，HTTP <code>PUT</code> 也可以完成相同的操作。 但本节以 <code>PATCH</code> 为例的原因是，该操作就是为了这种用例创建的。</p>
<h2 id="其他数据类型"><a href="#其他数据类型" class="headerlink" title="其他数据类型"></a>其他数据类型</h2><p>到目前为止，一直在使用常见的数据类型，如:<code>int</code>、<code>float</code>、<code>str</code>、<code>bool</code>，但是也可以使用更复杂的数据类型。<br>在这些复杂数据类型上，也能有如下功能：编辑器支持、传入请求的数据转换、响应数据的转换、数据验证、自动补全和文档。<br>一些常用的复杂数据类型:<br>（1）<code>UUID</code>:<br>一种标准的 “通用唯一标识符” ，在许多数据库和系统中用作ID。<br>在请求和响应中将以 <code>str</code> 表示。<br>（2）<code>datetime.datetime</code>:<br>日期时间。<br>在请求和响应中将表示为 ISO 8601 格式的 str ，比如: <code>2008-09-15T15:53:00+05:00</code>.<br>（3）<code>datetime.date</code>:<br>日期。<br>在请求和响应中将表示为 ISO 8601 格式的 str ，比如: <code>2008-09-15</code>.<br>（4）<code>datetime.time</code>:<br>时间。<br>在请求和响应中将表示为 ISO 8601 格式的 str ，比如: <code>14:23:55.003</code>.<br>（5）<code>datetime.timedelta</code>:<br>时间间隔。<br>在请求和响应中将表示为 float 代表总秒数。<br>Pydantic 也允许将其表示为 “ISO 8601 时间差异编码”。<br>（6）<code>frozenset</code>:<br>在请求和响应中，作为 <code>set</code> 对待：<br>在请求中，列表将被读取，消除重复，并将其转换为一个 <code>set</code>。<br>在响应中 <code>set</code> 将被转换为 <code>list</code> 。<br>产生的schema将指定哪些<code>set</code> 的值是唯一的 (使用 JSON Schema的 <code>uniqueItems</code>)。<br>（7）bytes:<br>标准的 Python <code>bytes</code>。<br>在请求和响应中被当作 <code>str</code> 处理。<br>生成的schema将指定这个 <code>str</code> 是 <code>binary</code> “格式”。<br>（8）Decimal:<br>标准的 Python <code>Decimal</code>。<br>在请求和响应中被当做 <code>float</code> 一样处理。<br>（9）可以在这里检查所有有效的pydantic数据类型: <a target="_blank" rel="noopener" href="https://pydantic-docs.helpmanual.io/usage/types/">Pydantic data types</a>。</p>
<h2 id="Cookie参数"><a href="#Cookie参数" class="headerlink" title="Cookie参数"></a>Cookie参数</h2><p>可以像定义 <code>Query</code> 参数和 <code>Path</code> 参数一样来定义 <code>Cookie</code> 参数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="comment"># 导入 Cookie</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Cookie, FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># 需要使用 Cookie 来声明 cookie 参数，否则参数将会被解释为查询参数。</span></span><br><span class="line"><span class="comment"># 声明 Cookie 参数的结构与声明 Query 参数和 Path 参数时相同。</span></span><br><span class="line"><span class="comment"># 第一个值是参数的默认值，同时也可以传递所有验证参数或注释参数，来校验参数</span></span><br><span class="line"><span class="comment"># Cookie 、Path 、Query是兄弟类，它们都继承自公共的 Param 类</span></span><br><span class="line"><span class="comment"># 但请记住，从 fastapi 导入的 Query、Path、Cookie 或其他参数声明函数，这些实际上是返回特殊类的函数。</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params">ads_id: <span class="type">Optional</span>[<span class="built_in">str</span>] = Cookie(<span class="params"><span class="literal">None</span></span>)</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;ads_id&quot;</span>: ads_id&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Header参数"><a href="#Header参数" class="headerlink" title="Header参数"></a>Header参数</h2><p>可以使用定义 <code>Query</code>, <code>Path</code> 和 <code>Cookie</code> 参数一样的方法定义 <code>Header</code> 参数。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="comment"># 导入 Header</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Header</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># 为了声明headers， 需要使用Header, 否则参数将被解释为查询参数。</span></span><br><span class="line"><span class="comment"># 使用和Path, Query and Cookie 一样的结构定义 header 参数</span></span><br><span class="line"><span class="comment"># 第一个值是默认值，你可以传递所有的额外验证或注释参数</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params">user_agent: <span class="type">Optional</span>[<span class="built_in">str</span>] = Header(<span class="params"><span class="literal">None</span></span>)</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;User-Agent&quot;</span>: user_agent&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="自动转换"><a href="#自动转换" class="headerlink" title="自动转换"></a>自动转换</h3><p>Header 在 Path、 Query 和 Cookie 提供的功能之上有一点额外的功能。<br>大多数标准的headers用 “连字符” 分隔，也称为 “减号” (-)。<br>但是像 <code>user-agent</code> 这样的变量在Python中是无效的。<br>因此, 默认情况下, Header 将把参数名称的字符从下划线 (_) 转换为连字符 (-) 来提取并记录 headers.<br>同时，HTTP headers 是大小写不敏感的，因此，因此可以使用标准Python样式(也称为 “<code>snake_case</code>“)声明它们。<br>因此，可以像通常在Python代码中那样使用 <code>user_agent</code> ，而不需要将首字母大写为 <code>User_Agent</code> 或类似的东西。<br>如果出于某些原因，需要禁用下划线到连字符的自动转换，设置Header的参数 <code>convert_underscores</code> 为 <code>False</code>（注意，一些HTTP代理和服务器不允许使用带有下划线的headers。）。</p>
<h3 id="重复的headers"><a href="#重复的headers" class="headerlink" title="重复的headers"></a>重复的headers</h3><p>有可能收到重复的headers。这意味着，相同的header具有多个值。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Header</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># 可以在类型声明中使用一个list来定义这些情况。</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params">x_token: <span class="type">Optional</span>[<span class="type">List</span>[<span class="built_in">str</span>]] = Header(<span class="params"><span class="literal">None</span></span>)</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;X-Token values&quot;</span>: x_token&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="响应模型"><a href="#响应模型" class="headerlink" title="响应模型"></a>响应模型</h2><p>可以在任意的路径操作中使用 <code>response_model</code> 参数来声明用于响应的模型。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line">    tags: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/items/&quot;</span>, response_model=Item</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_item</span>(<span class="params">item: Item</span>):</span></span><br><span class="line">    <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure><br>注意，<code>response_model</code>是「装饰器」方法（<code>get</code>，<code>post</code> 等）的一个参数。不像之前的所有参数和请求体，它不属于路径操作函数。<br>它接收的类型与为 Pydantic 模型属性所声明的类型相同，因此它可以是一个 Pydantic 模型，但也可以是一个由 Pydantic 模型组成的 list，例如 <code>List[Item]</code>。<br>FastAPI 将使用此 <code>response_model</code> 来：<br>（1）将输出数据转换为其声明的类型。<br>（2）校验数据。<br>（3）在 OpenAPI 的路径操作中为响应添加一个 JSON Schema。<br>（4）并在自动生成文档系统中使用。<br>但最重要的是：<br>会将输出数据限制在该模型定义内。这一点非常重要。<br>（响应模型在参数中被声明，而不是作为函数返回类型标注，这是因为路径函数可能不会真正返回该响应模型，而是返回一个 dict、数据库对象或其他模型，然后再使用 <code>response_model</code> 来执行字段约束和序列化。）<br>比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, EmailStr</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个有明文密码的输入模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserIn</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    password: <span class="built_in">str</span></span><br><span class="line">    email: EmailStr</span><br><span class="line">    full_name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一个没有明文密码的输出模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserOut</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: EmailStr</span><br><span class="line">    full_name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 response_model 声明为了不包含密码的 UserOut 模型</span></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/user/&quot;</span>, response_model=UserOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_user</span>(<span class="params">user: UserIn</span>):</span></span><br><span class="line">    <span class="comment"># 即便我们的路径操作函数将会返回包含密码的相同输入用户</span></span><br><span class="line">    <span class="comment"># FastAPI 将会负责过滤掉未在输出模型中声明的所有数据（使用 Pydantic）。</span></span><br><span class="line">    <span class="keyword">return</span> user</span><br></pre></td></tr></table></figure></p>
<h3 id="默认值-1"><a href="#默认值-1" class="headerlink" title="默认值"></a>默认值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    <span class="comment"># 响应模型可以具有默认值</span></span><br><span class="line">    <span class="comment"># 但如果它们并没有存储实际的值，你可能想从结果中忽略它们的默认值。</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="built_in">float</span> = <span class="number">10.5</span></span><br><span class="line">    tags: <span class="type">List</span>[<span class="built_in">str</span>] = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">items = &#123;</span><br><span class="line">    <span class="string">&quot;foo&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">50.2</span>&#125;,</span><br><span class="line">    <span class="string">&quot;bar&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Bar&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The bartenders&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">62</span>, <span class="string">&quot;tax&quot;</span>: <span class="number">20.2</span>&#125;,</span><br><span class="line">    <span class="string">&quot;baz&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Baz&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="literal">None</span>, <span class="string">&quot;price&quot;</span>: <span class="number">50.2</span>, <span class="string">&quot;tax&quot;</span>: <span class="number">10.5</span>, <span class="string">&quot;tags&quot;</span>: []&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以设置路径操作装饰器的 response_model_exclude_unset=True 参数</span></span><br><span class="line"><span class="comment"># 这样响应中将不会包含那些默认值，而是仅有实际设置的值，比如foo这个id</span></span><br><span class="line"><span class="comment"># 如果你的数据在具有默认值的模型字段中有实际的值，比如bar这个id，这些值将包含在响应中。</span></span><br><span class="line"><span class="comment"># 如果数据具有与默认值相同的值，例如 ID 为 baz 的项，它们将包含在 JSON 响应中。</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span>, response_model=Item, response_model_exclude_unset=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> items[item_id]</span><br></pre></td></tr></table></figure>
<h3 id="多个模型"><a href="#多个模型" class="headerlink" title="多个模型"></a>多个模型</h3><p>从前面的示例继续，拥有多个相关的模型是很常见的。<br>对用户模型来说尤其如此，因为：<br>（1）输入模型需要拥有密码属性。<br>（2）输出模型不应该包含密码。<br>（3）数据库模型很可能需要保存密码的哈希值。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, EmailStr</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserIn</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    password: <span class="built_in">str</span></span><br><span class="line">    email: EmailStr</span><br><span class="line">    full_name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserOut</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: EmailStr</span><br><span class="line">    full_name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInDB</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    hashed_password: <span class="built_in">str</span></span><br><span class="line">    email: EmailStr</span><br><span class="line">    full_name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fake_password_hasher</span>(<span class="params">raw_password: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;supersecret&quot;</span> + raw_password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fake_save_user</span>(<span class="params">user_in: UserIn</span>):</span></span><br><span class="line">    hashed_password = fake_password_hasher(user_in.password)</span><br><span class="line">    <span class="comment"># user_in 是一个 UserIn 类的 Pydantic 模型.</span></span><br><span class="line">    <span class="comment"># Pydantic 模型具有 .dict（） 方法，该方法返回一个拥有模型数据的 dict，暂时命名为user_dict。</span></span><br><span class="line">    <span class="comment"># 如果将该dict以 **user_dict 形式传递给一个函数（或类），Python将对其进行「解包」。它会将 user_dict 的键和值作为关键字参数直接传递。</span></span><br><span class="line">    <span class="comment"># 这样就获得了一个来自于其他 Pydantic 模型中的数据的 Pydantic 模型。</span></span><br><span class="line">    user_in_db = UserInDB(**user_in.<span class="built_in">dict</span>(), hashed_password=hashed_password)</span><br><span class="line">    <span class="comment"># 如下效果就是：</span></span><br><span class="line">    <span class="comment"># user_in_db = UserInDB(</span></span><br><span class="line">    <span class="comment">#     username = user_dict[&quot;username&quot;],</span></span><br><span class="line">    <span class="comment">#     password = user_dict[&quot;password&quot;],</span></span><br><span class="line">    <span class="comment">#     email = user_dict[&quot;email&quot;],</span></span><br><span class="line">    <span class="comment">#     full_name = user_dict[&quot;full_name&quot;],</span></span><br><span class="line">    <span class="comment">#     hashed_password = hashed_password,</span></span><br><span class="line">    <span class="comment"># )</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;User saved! ..not really&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> user_in_db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/user/&quot;</span>, response_model=UserOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_user</span>(<span class="params">user_in: UserIn</span>):</span></span><br><span class="line">    user_saved = fake_save_user(user_in)</span><br><span class="line">    <span class="keyword">return</span> user_saved</span><br></pre></td></tr></table></figure></p>
<p>（1）减少重复<br>减少代码重复是 FastAPI 的核心思想之一。<br>因为代码重复会增加出现 bug、安全性问题、代码失步问题（当你在一个位置更新了代码但没有在其他位置更新）等的可能性。<br>上面的这些模型都共享了大量数据，并拥有重复的属性名称和类型。<br>我们可以声明一个 <code>UserBase</code> 模型作为其他模型的基类。然后可以创建继承该模型属性（类型声明，校验等）的子类。<br>所有的数据转换、校验、文档生成等仍将正常运行。<br>这样，可以仅声明模型之间的差异部分（具有明文的 <code>password</code>、具有 <code>hashed_password</code> 以及不包括密码）。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, EmailStr</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserBase</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: EmailStr</span><br><span class="line">    full_name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserIn</span>(<span class="params">UserBase</span>):</span></span><br><span class="line">    password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserOut</span>(<span class="params">UserBase</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInDB</span>(<span class="params">UserBase</span>):</span></span><br><span class="line">    hashed_password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fake_password_hasher</span>(<span class="params">raw_password: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;supersecret&quot;</span> + raw_password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fake_save_user</span>(<span class="params">user_in: UserIn</span>):</span></span><br><span class="line">    hashed_password = fake_password_hasher(user_in.password)</span><br><span class="line">    user_in_db = UserInDB(**user_in.<span class="built_in">dict</span>(), hashed_password=hashed_password)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;User saved! ..not really&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> user_in_db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/user/&quot;</span>, response_model=UserOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_user</span>(<span class="params">user_in: UserIn</span>):</span></span><br><span class="line">    user_saved = fake_save_user(user_in)</span><br><span class="line">    <span class="keyword">return</span> user_saved</span><br></pre></td></tr></table></figure><br>（2）Union 或者 anyOf<br>以将一个响应声明为两种类型的 <code>Union</code>，这意味着该响应将是两种类型中的任何一种。<br>这将在 OpenAPI 中使用 <code>anyOf</code> 进行定义。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseItem</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    description: <span class="built_in">str</span></span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CarItem</span>(<span class="params">BaseItem</span>):</span></span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&quot;car&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlaneItem</span>(<span class="params">BaseItem</span>):</span></span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&quot;plane&quot;</span></span><br><span class="line">    size: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">items = &#123;</span><br><span class="line">    <span class="string">&quot;item1&quot;</span>: &#123;<span class="string">&quot;description&quot;</span>: <span class="string">&quot;All my friends drive a low rider&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;car&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;item2&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Music is my aeroplane, it&#x27;s my aeroplane&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;plane&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: <span class="number">5</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个 Union 类型时，首先包括最详细的类型，然后是不太详细的类型。</span></span><br><span class="line"><span class="comment"># 在下面的示例中，更详细的 PlaneItem 位于 Union[PlaneItem，CarItem] 中的 CarItem 之前。</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span>, response_model=<span class="type">Union</span>[CarItem, PlaneItem]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> items[item_id]</span><br></pre></td></tr></table></figure></p>
<p>（3）模型列表<br>可以用同样的方式声明由对象列表构成的响应。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">items = [</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;There comes my hero&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Red&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;It&#x27;s my aeroplane&quot;</span>&#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span>, response_model=<span class="type">List</span>[Item]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>():</span></span><br><span class="line">    <span class="keyword">return</span> items</span><br></pre></td></tr></table></figure><br>（4）任意dict构成的响应<br>还可以使用一个任意的普通 dict 声明响应，仅声明键和值的类型，而不使用 Pydantic 模型。<br>如果你事先不知道有效的字段/属性名称（对于 Pydantic 模型是必需的），这将很有用。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/keyword-weights/&quot;</span>, response_model=<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_keyword_weights</span>():</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;foo&quot;</span>: <span class="number">2.3</span>, <span class="string">&quot;bar&quot;</span>: <span class="number">3.4</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="响应状态码"><a href="#响应状态码" class="headerlink" title="响应状态码"></a>响应状态码</h2><p>与指定响应模型的方式相同，也可以在以下任意的路径操作中使用 <code>status_code</code> 参数来声明用于响应的 HTTP 状态码。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># status_code 参数接收一个表示 HTTP 状态码的数字。</span></span><br><span class="line"><span class="comment"># status_code 也能够接收一个 IntEnum 类型，比如 Python 的 http.HTTPStatus。</span></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/items/&quot;</span>, status_code=<span class="number">201</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_item</span>(<span class="params">name: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;name&quot;</span>: name&#125;</span><br></pre></td></tr></table></figure><br>注意，<code>status_code</code> 是「装饰器」方法（<code>get</code>，<code>post</code> 等）的一个参数。不像之前的所有参数和请求体，它不属于路径操作函数。<br>在 HTTP 协议中，将发送 3 位数的数字状态码作为响应的一部分。<br>这些状态码有一个识别它们的关联名称，但是重要的还是数字。<br>（1）100 及以上状态码用于「消息」响应。很少直接使用它们。具有这些状态代码的响应不能带有响应体。<br>（2）200 及以上状态码用于「成功」响应。这些是最常使用的。</p>
<ul>
<li>200 是默认状态代码，它表示一切「正常」。</li>
<li>201表示「已创建」。它通常在数据库中创建了一条新记录后使用。</li>
<li>204表示「无内容」。此响应在没有内容返回给客户端时使用，因此该响应不能包含响应体。</li>
</ul>
<p>（3）300 及以上状态码用于「重定向」。具有这些状态码的响应可能有或者可能没有响应体，但 304「未修改」是个例外，该响应不得含有响应体。<br>（4）400 及以上状态码用于「客户端错误」响应。这些可能是第二常用的类型。</p>
<ul>
<li>404，用于「未找到」响应。</li>
<li>对于来自客户端的一般错误，可以只使用 400。</li>
</ul>
<p>（5）500 及以上状态码用于服务器端错误。几乎永远不会直接使用它们。当你的应用程序代码或服务器中的某些部分出现问题时，它将自动返回这些状态代码之一。<br>要了解有关每个状态代码以及适用场景的更多信息，请查看<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">MDN 关于 HTTP 状态码的文档</a>。</p>
<h2 id="表单数据"><a href="#表单数据" class="headerlink" title="表单数据"></a>表单数据</h2><p>接收的不是 JSON，而是表单字段时，要使用 Form。<br>要使用表单，需预先安装<code>python-multipart</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install python-multipart</span><br></pre></td></tr></table></figure><br>例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从 fastapi 导入 Form</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Form</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/login/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># 创建表单（Form）参数的方式与 Body 和 Query 一样</span></span><br><span class="line"><span class="comment"># OAuth2 规范的 &quot;密码流&quot; 模式规定要通过表单字段发送 username 和 password。</span></span><br><span class="line"><span class="comment"># 该规范要求字段必须命名为 username 和 password，并通过表单字段发送，不能用 JSON。</span></span><br><span class="line"><span class="comment"># 使用 Form 可以声明与 Body （及 Query、Path、Cookie）相同的元数据和验证。</span></span><br><span class="line"><span class="comment"># 声明表单体要显式使用 Form ，否则，FastAPI 会把该参数当作查询参数或请求体（JSON）参数。</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">username: <span class="built_in">str</span> = Form(<span class="params">...</span>), password: <span class="built_in">str</span> = Form(<span class="params">...</span>)</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;username&quot;</span>: username&#125;</span><br></pre></td></tr></table></figure></p>
<p>与 JSON 不同，HTML 表单（<code>&lt;form&gt;&lt;/form&gt;</code>）向服务器发送数据通常使用「特殊」的编码。<br>FastAPI 要确保从正确的位置读取数据，而不是读取 JSON。<br>表单数据的「媒体类型」编码一般为 <code>application/x-www-form-urlencoded</code>。<br>但包含文件的表单编码为 <code>multipart/form-data</code>。文件处理详见下节。</p>
<p>可在一个路径操作中声明多个 Form 参数，但不能同时声明要接收 JSON 的 Body 字段。因为此时请求体的编码是 <code>application/x-www-form-urlencoded</code>，不是 <code>application/json</code>。<br>这不是 FastAPI 的问题，而是 HTTP 协议的规定。</p>
<h2 id="请求文件"><a href="#请求文件" class="headerlink" title="请求文件"></a>请求文件</h2><p><code>File</code> 用于定义客户端的上传文件。<br>因为上传文件以「表单数据」形式发送。<br>所以接收上传文件，要预先安装 <code>python-multipart</code>。<br>有两种文件请求方式：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从 fastapi 导入 File 和 UploadFile</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, File, UploadFile</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/files/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># 创建文件（File）参数的方式与 Body 和 Form 一样</span></span><br><span class="line"><span class="comment"># 声明文件体必须使用 File，否则，FastAPI 会把该参数当作查询参数或请求体（JSON）参数。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果把路径操作函数参数的类型声明为 bytes，FastAPI 将以 bytes 形式读取和接收文件内容。</span></span><br><span class="line"><span class="comment"># 这种方式把文件的所有内容都存储在内存里，适用于小型文件。</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_file</span>(<span class="params">file: <span class="built_in">bytes</span> = File(<span class="params">...</span>)</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;file_size&quot;</span>: <span class="built_in">len</span>(file)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/uploadfile/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># 不过，很多情况下，UploadFile 更好用。</span></span><br><span class="line"><span class="comment"># 定义 File 参数时使用 UploadFile</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_upload_file</span>(<span class="params">file: UploadFile</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;filename&quot;</span>: file.filename&#125;</span><br></pre></td></tr></table></figure><br>UploadFile 与 bytes 相比有更多优势：<br>（1）使用 spooled 文件：存储在内存的文件超出最大上限时，FastAPI 会把文件存入磁盘；<br>（2）这种方式更适于处理图像、视频、二进制文件等大型文件，好处是不会占用所有内存；<br>（3）可获取上传文件的元数据；<br>（4）自带 <a target="_blank" rel="noopener" href="https://docs.python.org/zh-cn/3/glossary.html#term-file-like-object">file-like</a> <code>async</code> 接口；<br>（5）它暴露了一个 Python <code>SpooledTemporaryFile</code> 对象，可直接传递给其他想要<code>file-like</code>对象的库。</p>
<p>UploadFile 的属性如下：<br>（1）<code>filename</code>：上传文件的文件名字符串（str），例如<code>myimage.jpg</code>；<br>（2）<code>content_type</code>：内容的类型（MIME 类型 / 媒体类型）字符串（str），例如<code>image/jpeg</code>；<br>（3）<code>file</code>： <code>SpooledTemporaryFile</code>（一个<code>file-like</code> 对象）。该对象可直接传递给其他想要 <code>file-like</code> 对象的函数或库。</p>
<p>UploadFile 支持以下 <code>async</code> 方法，（使用内部 <code>SpooledTemporaryFile</code>）可调用如下方法。<br>（1）<code>write(data)</code>：把 <code>data</code> （<code>str</code> 或 <code>bytes</code>）写入文件；<br>（2）<code>read(size)</code>：按指定数量的字节或字符（<code>size (int)</code>）读取文件内容；<br>（3）<code>seek(offset)</code>：移动至文件<code>offset (int)</code> 字节处的位置；<br>例如，<code>await myfile.seek(0)</code>移动到文件开头；<br>执行 <code>await myfile.read()</code> 后，需再次读取已读取内容时，这种方法特别好用。<br>（4）<code>close()</code>：关闭文件。<br>因为上述方法都是 <code>async</code> 方法，要搭配<code>await</code>使用。<br>例如，在 <code>async</code> 路径操作函数 内，要用以下方式读取文件内容：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contents = <span class="keyword">await</span> myfile.read()</span><br></pre></td></tr></table></figure><br>在普通 <code>def</code> 路径操作函数 内，则可以直接访问<code>UploadFile.file</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contents = myfile.file.read()</span><br></pre></td></tr></table></figure></p>
<p>多文件上传：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, File, UploadFile</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> HTMLResponse</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/files/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># 可用同一个「表单字段」发送含多个文件的「表单数据」。</span></span><br><span class="line"><span class="comment"># 上传多个文件时，要声明含 bytes 或 UploadFile 的列表（List）：</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_files</span>(<span class="params">files: <span class="type">List</span>[<span class="built_in">bytes</span>] = File(<span class="params">...</span>)</span>):</span></span><br><span class="line">    <span class="comment"># 接收的也是含 bytes 或 UploadFile 的列表（list）。</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;file_sizes&quot;</span>: [<span class="built_in">len</span>(file) <span class="keyword">for</span> file <span class="keyword">in</span> files]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/uploadfiles/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_upload_files</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 也可以声明元数据</span></span></span></span><br><span class="line"><span class="function"><span class="params">    files: <span class="type">List</span>[UploadFile] = File(<span class="params">..., description=<span class="string">&quot;Multiple files as UploadFile&quot;</span></span>)</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;filenames&quot;</span>: [file.filename <span class="keyword">for</span> file <span class="keyword">in</span> files]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    content = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;form action=&quot;/files/&quot; enctype=&quot;multipart/form-data&quot; method=&quot;post&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;files&quot; type=&quot;file&quot; multiple&gt;</span></span><br><span class="line"><span class="string">&lt;input type=&quot;submit&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;form action=&quot;/uploadfiles/&quot; enctype=&quot;multipart/form-data&quot; method=&quot;post&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input name=&quot;files&quot; type=&quot;file&quot; multiple&gt;</span></span><br><span class="line"><span class="string">&lt;input type=&quot;submit&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> HTMLResponse(content=content)</span><br></pre></td></tr></table></figure></p>
<h2 id="请求表单和文件"><a href="#请求表单和文件" class="headerlink" title="请求表单和文件"></a>请求表单和文件</h2><p>FastAPI 支持同时使用 <code>File</code> 和 <code>Form</code> 定义文件和表单字段。<br>在同一个请求中接收数据和文件时，应同时使用 File 和 Form。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, File, Form, UploadFile</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/files/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_file</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 创建文件和表单参数的方式与 Body 和 Query 一样</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 可在一个路径操作中声明多个 File 与 Form 参数，但不能同时声明要接收 JSON 的 Body 字段。因为此时请求体的编码为 multipart/form-data，不是 application/json。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 这不是 FastAPI 的问题，而是 HTTP 协议的规定。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    file: <span class="built_in">bytes</span> = File(<span class="params">...</span>), fileb: UploadFile = File(<span class="params">...</span>), token: <span class="built_in">str</span> = Form(<span class="params">...</span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;file_size&quot;</span>: <span class="built_in">len</span>(file),</span><br><span class="line">        <span class="string">&quot;token&quot;</span>: token,</span><br><span class="line">        <span class="string">&quot;fileb_content_type&quot;</span>: fileb.content_type,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="处理错误"><a href="#处理错误" class="headerlink" title="处理错误"></a>处理错误</h2><p>某些情况下，需要向客户端返回错误提示。<br>这里所谓的客户端包括前端浏览器、其他应用程序、物联网设备等。<br>需要向客户端返回错误提示的场景主要如下：<br>（1）客户端没有执行操作的权限<br>（2）客户端没有访问资源的权限<br>（3）客户端要访问的项目不存在<br>等等 …<br>遇到这些情况时，通常要返回 4XX（400 至 499）HTTP 状态码。</p>
<h3 id="使用HTTPException"><a href="#使用HTTPException" class="headerlink" title="使用HTTPException"></a>使用HTTPException</h3><p>向客户端返回 HTTP 错误响应，可以使用 <code>HTTPException</code>。<br>HTTPException 是一个常规 Python 异常，包含了和 API 有关的额外数据。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入 HTTPException</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">items = &#123;<span class="string">&quot;foo&quot;</span>: <span class="string">&quot;The Foo Wrestlers&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> item_id <span class="keyword">not</span> <span class="keyword">in</span> items:</span><br><span class="line">        <span class="comment"># 因为是 Python 异常，所以不能 return，只能 raise。</span></span><br><span class="line">        <span class="comment"># 如在调用路径操作函数里的工具函数时，触发了 HTTPException，FastAPI 就不再继续执行路径操作函数中的后续代码，而是立即终止请求，并把 HTTPException 的 HTTP 错误发送至客户端。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 触发 HTTPException 时，可以用参数 detail 传递任何能转换为 JSON 的值，不仅限于 str。</span></span><br><span class="line">        <span class="comment"># 还支持传递 dict、list 等数据结构。</span></span><br><span class="line">        <span class="comment"># FastAPI 能自动处理这些数据，并将之转换为 JSON。</span></span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">404</span>, detail=<span class="string">&quot;Item not found&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item&quot;</span>: items[item_id]&#125;</span><br></pre></td></tr></table></figure><br>有些场景下要为 HTTP 错误添加自定义响应头。例如，出于某些方面的安全需要。<br>一般情况下可能不会需要在代码中直接使用响应头。<br>但对于某些高级应用场景，还是需要添加自定义响应头：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, HTTPException</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">items = &#123;<span class="string">&quot;foo&quot;</span>: <span class="string">&quot;The Foo Wrestlers&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items-header/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item_header</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> item_id <span class="keyword">not</span> <span class="keyword">in</span> items:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=<span class="number">404</span>,</span><br><span class="line">            detail=<span class="string">&quot;Item not found&quot;</span>,</span><br><span class="line">            headers=&#123;<span class="string">&quot;X-Error&quot;</span>: <span class="string">&quot;There goes my error&quot;</span>&#125;,</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item&quot;</span>: items[item_id]&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="安装自定义异常处理器"><a href="#安装自定义异常处理器" class="headerlink" title="安装自定义异常处理器"></a>安装自定义异常处理器</h3><p>添加自定义处理器，要使用<a target="_blank" rel="noopener" href="https://www.starlette.io/exceptions/">Starlette 的异常工具</a>。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> JSONResponse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设要触发的自定义异常叫作 UnicornException。</span></span><br><span class="line"><span class="comment"># 且需要 FastAPI 实现全局处理该异常。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnicornException</span>(<span class="params">Exception</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name: <span class="built_in">str</span></span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以用 @app.exception_handler() 添加自定义异常控制器</span></span><br><span class="line"><span class="meta">@app.exception_handler(<span class="params">UnicornException</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">unicorn_exception_handler</span>(<span class="params">request: Request, exc: UnicornException</span>):</span></span><br><span class="line">    <span class="comment"># 接收到的错误信息清晰明了，HTTP 状态码为 418，JSON 内容如下：</span></span><br><span class="line">    <span class="keyword">return</span> JSONResponse(</span><br><span class="line">        status_code=<span class="number">418</span>,</span><br><span class="line">        content=&#123;<span class="string">&quot;message&quot;</span>: <span class="string">f&quot;Oops! <span class="subst">&#123;exc.name&#125;</span> did something. There goes a rainbow...&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/unicorns/&#123;name&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_unicorn</span>(<span class="params">name: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="comment"># 请求 /unicorns/yolo 时，路径操作会触发 UnicornException。</span></span><br><span class="line">    <span class="comment"># 但该异常将会被 unicorn_exception_handler 处理。</span></span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">&quot;yolo&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> UnicornException(name=name)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;unicorn_name&quot;</span>: name&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="覆盖默认异常处理器"><a href="#覆盖默认异常处理器" class="headerlink" title="覆盖默认异常处理器"></a>覆盖默认异常处理器</h3><p>FastAPI 自带了一些默认异常处理器。<br>触发 <code>HTTPException</code> 或请求无效数据时，这些处理器返回默认的 JSON 响应结果。<br>不过，也可以使用自定义处理器覆盖默认异常处理器。<br>（这部分内容太高阶，且一般情况下使用默认异常处理器即可。跳过本部分）</p>
<h2 id="路径操作配置"><a href="#路径操作配置" class="headerlink" title="路径操作配置"></a>路径操作配置</h2><p>路径操作装饰器支持多种配置参数。<br>通过传递参数给路径操作装饰器 ，即可轻松地配置路径操作、添加元数据。<br>注意：以下参数应直接传递给路径操作装饰器，不能传递给路径操作函数。</p>
<h3 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h3><p><code>status_code</code> 用于定义路径操作响应中的 HTTP 状态码。<br>可以直接传递 <code>int</code> 代码， 比如 404。<br>如果记不住数字码的涵义，也可以用 <code>status</code> 的快捷常量，如<code>status.HTTP_201_CREATED</code>。</p>
<h3 id="tags参数"><a href="#tags参数" class="headerlink" title="tags参数"></a>tags参数</h3><p>tags 参数的值是由 str 组成的 list （一般只有一个 str ），tags 用于为路径操作添加标签。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Set</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line">    tags: <span class="type">Set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/items/&quot;</span>, response_model=Item, tags=[<span class="string">&quot;items&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_item</span>(<span class="params">item: Item</span>):</span></span><br><span class="line">    <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span>, tags=[<span class="string">&quot;items&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">42</span>&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&quot;</span>, tags=[<span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_users</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;johndoe&quot;</span>&#125;]</span><br></pre></td></tr></table></figure><br>OpenAPI schema会自动添加标签，供 API 文档接口使用。</p>
<h3 id="summary-和-description-参数"><a href="#summary-和-description-参数" class="headerlink" title="summary 和 description 参数"></a>summary 和 description 参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Set</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line">    tags: <span class="type">Set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    <span class="string">&quot;/items/&quot;</span>,</span></span></span><br><span class="line"><span class="meta"><span class="params">    response_model=Item,</span></span></span><br><span class="line"><span class="meta"><span class="params">    <span class="comment"># 对api的概要</span></span></span></span><br><span class="line"><span class="meta"><span class="params">    summary=<span class="string">&quot;Create an item&quot;</span>,</span></span></span><br><span class="line"><span class="meta"><span class="params">    <span class="comment"># 详细说明，更复杂的说明可以使用下面的文档字符串</span></span></span></span><br><span class="line"><span class="meta"><span class="params">    description=<span class="string">&quot;Create an item with all the information, name, description, price, tax and a set of unique tags&quot;</span>,</span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_item</span>(<span class="params">item: Item</span>):</span></span><br><span class="line">    <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>
<h3 id="文档字符串"><a href="#文档字符串" class="headerlink" title="文档字符串"></a>文档字符串</h3><p>描述内容比较长且占用多行时，可以在函数的 docstring 中声明路径操作的描述，FastAPI 支持从文档字符串中读取描述内容。<br>文档字符串支持 Markdown，能正确解析和显示 Markdown 的内容，但要注意文档字符串的缩进。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Set</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line">    tags: <span class="type">Set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/items/&quot;</span>, response_model=Item, summary=<span class="string">&quot;Create an item&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_item</span>(<span class="params">item: Item</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Create an item with all the information:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    - **name**: each item must have a name</span></span><br><span class="line"><span class="string">    - **description**: a long description</span></span><br><span class="line"><span class="string">    - **price**: required</span></span><br><span class="line"><span class="string">    - **tax**: if the item doesn&#x27;t have tax, you can omit this</span></span><br><span class="line"><span class="string">    - **tags**: a set of unique tag strings for this item</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure></p>
<h3 id="响应描述"><a href="#响应描述" class="headerlink" title="响应描述"></a>响应描述</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Set</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    price: <span class="built_in">float</span></span><br><span class="line">    tax: <span class="type">Optional</span>[<span class="built_in">float</span>] = <span class="literal">None</span></span><br><span class="line">    tags: <span class="type">Set</span>[<span class="built_in">str</span>] = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    <span class="string">&quot;/items/&quot;</span>,</span></span></span><br><span class="line"><span class="meta"><span class="params">    response_model=Item,</span></span></span><br><span class="line"><span class="meta"><span class="params">    summary=<span class="string">&quot;Create an item&quot;</span>,</span></span></span><br><span class="line"><span class="meta"><span class="params">    <span class="comment"># response_description 参数用于定义响应的描述说明</span></span></span></span><br><span class="line"><span class="meta"><span class="params">    <span class="comment"># OpenAPI 规定每个路径操作都要有响应描述。</span></span></span></span><br><span class="line"><span class="meta"><span class="params">    <span class="comment"># 如果没有定义响应描述，FastAPI 则自动生成内容为 &quot;Successful response&quot; 的响应描述。</span></span></span></span><br><span class="line"><span class="meta"><span class="params">    response_description=<span class="string">&quot;The created item&quot;</span>,</span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">create_item</span>(<span class="params">item: Item</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Create an item with all the information:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    - **name**: each item must have a name</span></span><br><span class="line"><span class="string">    - **description**: a long description</span></span><br><span class="line"><span class="string">    - **price**: required</span></span><br><span class="line"><span class="string">    - **tax**: if the item doesn&#x27;t have tax, you can omit this</span></span><br><span class="line"><span class="string">    - **tags**: a set of unique tag strings for this item</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>
<h3 id="弃用路径操作"><a href="#弃用路径操作" class="headerlink" title="弃用路径操作"></a>弃用路径操作</h3><p><code>deprecated</code> 参数可以把路径操作标记为弃用，无需直接删除。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span>, tags=[<span class="string">&quot;items&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;price&quot;</span>: <span class="number">42</span>&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&quot;</span>, tags=[<span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_users</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;johndoe&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/elements/&quot;</span>, tags=[<span class="string">&quot;items&quot;</span>], deprecated=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_elements</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;]</span><br></pre></td></tr></table></figure></p>
<h2 id="JSON兼容编码器"><a href="#JSON兼容编码器" class="headerlink" title="JSON兼容编码器"></a>JSON兼容编码器</h2><p>在某些情况下，可能需要将一个数据类型（如 Pydantic 模型）转换为与 JSON 兼容的类型（如<code>dict</code>、<code>list</code>等）。<br>比如想将该数据存储在数据库中。<br>为此，FastAPI提供了一个<code>jsonable_encoder()</code>功能。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="comment"># 导入jsonable_encoder</span></span><br><span class="line"><span class="keyword">from</span> fastapi.encoders <span class="keyword">import</span> jsonable_encoder</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设fake_db数据库只接收 JSON 兼容的数据。</span></span><br><span class="line"><span class="comment"># 例如，它不接收datetime对象，因为它们与 JSON 不兼容。</span></span><br><span class="line"><span class="comment"># 因此，datetime对象必须转换为包含ISO格式数据的str对象。</span></span><br><span class="line"><span class="comment"># 同样，该数据库不会接收 Pydantic 模型（具有属性的对象），只会接收dict.</span></span><br><span class="line">fake_db = &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    title: <span class="built_in">str</span></span><br><span class="line">    timestamp: datetime</span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/items/&#123;id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params"><span class="built_in">id</span>: <span class="built_in">str</span>, item: Item</span>):</span></span><br><span class="line">    <span class="comment"># jsonable_encoder将 Pydantic 模型转换为一个dict，并将datetime转换为str。</span></span><br><span class="line">    <span class="comment"># 它不会返回一个大的str，里面包含JSON格式的数据（作为字符串）。</span></span><br><span class="line">    <span class="comment"># 而是返回一个Python标准数据结构（例如一个dict），其中的值和子值都与 JSON 兼容。</span></span><br><span class="line">    json_compatible_item_data = jsonable_encoder(item)</span><br><span class="line">    fake_db[<span class="built_in">id</span>] = json_compatible_item_data</span><br></pre></td></tr></table></figure></p>
<h2 id="依赖项"><a href="#依赖项" class="headerlink" title="依赖项"></a>依赖项</h2><p>FastAPI 提供了简单易用，但功能强大的依赖注入系统。<br>这个依赖系统设计的简单易用，可以让开发人员轻松地把组件集成至 FastAPI。</p>
<h3 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h3><p>编程中的「依赖注入」是声明代码（本文中为路径操作函数 ）运行所需的，或要使用的「依赖」的一种方式。<br>然后，由系统（本文中为 FastAPI）负责执行任意需要的逻辑，为代码提供这些依赖（「注入」依赖项）。<br>依赖注入常用于以下场景：<br>（1）共享业务逻辑（复用相同的代码逻辑）<br>（2）共享数据库连接<br>（3）实现安全、验证、角色权限<br>等……<br>上述场景均可以使用依赖注入，将代码重复最小化。<br>依赖注入系统支持构建集成和「插件」。但实际上，FastAPI 根本不需要创建「插件」，因为使用依赖项可以声明不限数量的、可用于路径操作函数的集成与交互。<br>创建依赖项非常简单、直观，并且还支持导入 Python 包。毫不夸张地说，只要几行代码就可以把需要的 Python 包与 API 函数集成在一起。</p>
<h3 id="FastAPI-兼容性"><a href="#FastAPI-兼容性" class="headerlink" title="FastAPI 兼容性"></a>FastAPI 兼容性</h3><p>依赖注入系统如此简洁的特性，让 FastAPI 可以与下列系统兼容：</p>
<ul>
<li>关系型数据库</li>
<li>NoSQL 数据库</li>
<li>外部支持库</li>
<li>外部 API</li>
<li>认证和鉴权系统</li>
<li>API 使用监控系统</li>
<li>响应数据注入系统<br>等等……</li>
</ul>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"><span class="comment"># 导入 Depends</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建依赖项</span></span><br><span class="line"><span class="comment"># 依赖项函数的形式和结构与路径操作函数一样。</span></span><br><span class="line"><span class="comment"># 可以把依赖项当作没有「装饰器」（即，没有 @app.get(&quot;/some-path&quot;) ）的路径操作函数。</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">common_parameters</span>(<span class="params">q: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>, skip: <span class="built_in">int</span> = <span class="number">0</span>, limit: <span class="built_in">int</span> = <span class="number">100</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;q&quot;</span>: q, <span class="string">&quot;skip&quot;</span>: skip, <span class="string">&quot;limit&quot;</span>: limit&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 声明依赖项</span></span><br><span class="line"><span class="comment"># 与在路径操作函数参数中使用 Body、Query 的方式相同，声明依赖项需要使用 Depends 和一个新的参数。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 虽然，在路径操作函数的参数中使用 Depends 的方式与 Body、Query 相同，但 Depends 的工作方式略有不同。</span></span><br><span class="line"><span class="comment"># 这里只能传给 Depends 一个参数。</span></span><br><span class="line"><span class="comment"># 且该参数必须是可调用对象，比如函数。</span></span><br><span class="line"><span class="comment"># 该函数接收的参数和路径操作函数的参数一样。</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params">commons: <span class="built_in">dict</span> = Depends(<span class="params">common_parameters</span>)</span>):</span></span><br><span class="line">    <span class="keyword">return</span> commons</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接收到新的请求时，FastAPI 执行如下操作：</span></span><br><span class="line"><span class="comment"># （1）用正确的参数调用依赖项函数（「可依赖项」）</span></span><br><span class="line"><span class="comment"># （2）获取函数返回的结果</span></span><br><span class="line"><span class="comment"># （3）把函数返回的结果赋值给路径操作函数的参数</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_users</span>(<span class="params">commons: <span class="built_in">dict</span> = Depends(<span class="params">common_parameters</span>)</span>):</span></span><br><span class="line">    <span class="keyword">return</span> commons</span><br></pre></td></tr></table></figure>
<p>虽然，层级式依赖注入系统的定义与使用十分简单，但它却非常强大。<br>比如，可以定义依赖其他依赖项的依赖项。<br>最后，依赖项层级树构建后，依赖注入系统会处理所有依赖项及其子依赖项，并为每一步操作提供（注入）结果。</p>
<h3 id="类作为依赖项"><a href="#类作为依赖项" class="headerlink" title="类作为依赖项"></a>类作为依赖项</h3><p>上面例子中依赖项的声明是个函数，它的返回值是个字典。这种方式可行，但可以更好，比如此时编辑器就没法提供很好的支持，因为它不知道字典的键和值是什么。<br>函数并不是声明依赖关系的唯一方法（尽管它可能更常见）。关键因素是依赖项应该是“可调用的”。<br>Python 中的“可调用”是 Python 可以像函数一样“调用”的任何东西，比如类<code>class</code>也是可调用的。</p>
<p>FastAPI 实际检查的是它是“可调用的”（函数、类或其他任何东西）和定义的参数。<br>如果在FastAPI 中将“可调用”作为依赖项传递，它将分析该“可调用”的参数，并以与路径操作函数的参数相同的方式处理它们。包括子依赖。<br>这也适用于完全没有参数的可调用对象。与没有参数的路径操作函数相同。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_items_db = [&#123;<span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;, &#123;<span class="string">&quot;item_name&quot;</span>: <span class="string">&quot;Baz&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将依赖项从上面的函数common_parameters更改为类CommonQueryParams</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommonQueryParams</span>:</span></span><br><span class="line">    <span class="comment"># __init__用于创建类实例的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, q: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>, skip: <span class="built_in">int</span> = <span class="number">0</span>, limit: <span class="built_in">int</span> = <span class="number">100</span></span>):</span></span><br><span class="line">        self.q = q</span><br><span class="line">        self.skip = skip</span><br><span class="line">        self.limit = limit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># 使用这个类来声明依赖</span></span><br><span class="line"><span class="comment"># 这将创建该类的“实例”，并且该实例将作为参数传递commons给函数。</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params">commons: CommonQueryParams = Depends(<span class="params">CommonQueryParams</span>)</span>):</span></span><br><span class="line">    response = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> commons.q:</span><br><span class="line">        response.update(&#123;<span class="string">&quot;q&quot;</span>: commons.q&#125;)</span><br><span class="line">    items = fake_items_db[commons.skip : commons.skip + commons.limit]</span><br><span class="line">    response.update(&#123;<span class="string">&quot;items&quot;</span>: items&#125;)</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure></p>
<h3 id="子依赖项"><a href="#子依赖项" class="headerlink" title="子依赖项"></a>子依赖项</h3><p>FastAPI 支持创建含子依赖项的依赖项。<br>并且，可以按需声明任意深度的子依赖项嵌套层级。<br>FastAPI 负责处理解析不同深度的子依赖项。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Cookie, Depends, FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建第一层依赖项</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_extractor</span>(<span class="params">q: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> q</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建另一个依赖项函数，并同时再声明一个依赖项</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_or_cookie_extractor</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    q: <span class="built_in">str</span> = Depends(<span class="params">query_extractor</span>), last_query: <span class="type">Optional</span>[<span class="built_in">str</span>] = Cookie(<span class="params"><span class="literal">None</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> q:</span><br><span class="line">        <span class="keyword">return</span> last_query</span><br><span class="line">    <span class="keyword">return</span> q</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_query</span>(<span class="params">query_or_default: <span class="built_in">str</span> = Depends(<span class="params">query_or_cookie_extractor</span>)</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;q_or_cookie&quot;</span>: query_or_default&#125;</span><br></pre></td></tr></table></figure><br>如果在同一个路径操作 多次声明了同一个依赖项，例如，多个依赖项共用一个子依赖项，FastAPI 在处理同一请求时，只调用一次该子依赖项。<br>FastAPI 不会为同一个请求多次调用同一个依赖项，而是把依赖项的返回值进行「缓存」，并把它传递给同一请求中所有需要使用该返回值的「依赖项」。<br>在高级使用场景中，如果不想使用「缓存」值，而是为需要在同一请求的每一步操作（多次）中都实际调用依赖项，可以把 Depends 的参数 <code>use_cache</code> 的值设置为 <code>False</code> :<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">needy_dependency</span>(<span class="params">fresh_value: <span class="built_in">str</span> = Depends(<span class="params">get_value, use_cache=<span class="literal">False</span></span>)</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;fresh_value&quot;</span>: fresh_value&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="路径操作装饰器中的依赖项"><a href="#路径操作装饰器中的依赖项" class="headerlink" title="路径操作装饰器中的依赖项"></a>路径操作装饰器中的依赖项</h3><p>有时，我们并不需要在路径操作函数中使用依赖项的返回值。或者说，有些依赖项不返回值。<br>但仍要执行或解析该依赖项。<br>对于这种情况，不必在声明路径操作函数的参数时使用 Depends，而是可以在路径操作装饰器中添加一个由 <code>dependencies</code> 组成的 <code>list</code>。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI, Header, HTTPException</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">verify_token</span>(<span class="params">x_token: <span class="built_in">str</span> = Header(<span class="params">...</span>)</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x_token != <span class="string">&quot;fake-super-secret-token&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;X-Token header invalid&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">verify_key</span>(<span class="params">x_key: <span class="built_in">str</span> = Header(<span class="params">...</span>)</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x_key != <span class="string">&quot;fake-super-secret-key&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;X-Key header invalid&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> x_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 路径操作装饰器支持可选参数dependencies。</span></span><br><span class="line"><span class="comment"># 该参数的值是由 Depends() 组成的 list</span></span><br><span class="line"><span class="comment"># 路径操作装饰器依赖项（以下简称为“路径装饰器依赖项”）的执行或解析方式和普通依赖项一样，但就算这些依赖项会返回值，它们的值也不会传递给路径操作函数。</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span>, dependencies=[Depends(<span class="params">verify_token</span>), Depends(<span class="params">verify_key</span>)]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;item&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;, &#123;<span class="string">&quot;item&quot;</span>: <span class="string">&quot;Bar&quot;</span>&#125;]</span><br></pre></td></tr></table></figure></p>
<h3 id="全局依赖项"><a href="#全局依赖项" class="headerlink" title="全局依赖项"></a>全局依赖项</h3><p>有时，我们要为整个应用添加依赖项。<br>通过与定义路径装饰器依赖项 类似的方式，可以把依赖项添加至整个 FastAPI 应用。<br>这样一来，就可以为所有路径操作应用该依赖项。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI, Header, HTTPException</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">verify_token</span>(<span class="params">x_token: <span class="built_in">str</span> = Header(<span class="params">...</span>)</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x_token != <span class="string">&quot;fake-super-secret-token&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;X-Token header invalid&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">verify_key</span>(<span class="params">x_key: <span class="built_in">str</span> = Header(<span class="params">...</span>)</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x_key != <span class="string">&quot;fake-super-secret-key&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;X-Key header invalid&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> x_key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局依赖项</span></span><br><span class="line"><span class="comment"># 路径装饰器依赖项一节的思路均适用于全局依赖项</span></span><br><span class="line">app = FastAPI(dependencies=[Depends(verify_token), Depends(verify_key)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;item&quot;</span>: <span class="string">&quot;Portal Gun&quot;</span>&#125;, &#123;<span class="string">&quot;item&quot;</span>: <span class="string">&quot;Plumbus&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_users</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;Rick&quot;</span>&#125;, &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;Morty&quot;</span>&#125;]</span><br></pre></td></tr></table></figure></p>
<h3 id="有yield的依赖项"><a href="#有yield的依赖项" class="headerlink" title="有yield的依赖项"></a>有yield的依赖项</h3><p>FastAPI 支持在完成后执行一些额外步骤的依赖项。<br>为此，请使用<code>yield</code>代替<code>return</code>，并在之后编写额外的步骤。<br>确保使用<code>yield</code>一次。<br>一个典型例子是想在发送请求时创建一个数据库对话，然后发送完成后就关闭它。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># async或普通函数都可以</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_db</span>():</span></span><br><span class="line">    <span class="comment"># 只有在yield之前和包含yield那行代码会在发送请求前执行</span></span><br><span class="line">    db = DBSession()</span><br><span class="line">    <span class="keyword">try</span>: <span class="comment">#使用try能收到异常</span></span><br><span class="line">        <span class="comment"># yield的值会注入到路径操作中，或其他依赖中</span></span><br><span class="line">        <span class="keyword">yield</span> db</span><br><span class="line">    <span class="comment"># 在yield之后的代码会在发送响应后再执行</span></span><br><span class="line">    <span class="keyword">finally</span>: <span class="comment"># 使用finally来确保执行退出步骤，无论是否有异常。</span></span><br><span class="line">        db.close()</span><br></pre></td></tr></table></figure></p>
<h2 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h2><p>有许多方法可以处理安全性、身份认证和授权等问题。<br>而且这通常是一个复杂而「困难」的话题。<br>在许多框架和系统中，仅处理安全性和身份认证就会花费大量的精力和代码（在许多情况下，可能占编写的所有代码的 50％ 或更多）。<br>FastAPI 提供了多种工具，可帮助你以标准的方式轻松、快速地处理安全性，而无需研究和学习所有的安全规范。</p>
<h3 id="基本知识"><a href="#基本知识" class="headerlink" title="基本知识"></a>基本知识</h3><p>（1）OAuth2<br>OAuth2是一个规范，它定义了几种处理身份认证和授权的方法。<br>它是一个相当广泛的规范，涵盖了一些复杂的使用场景。<br>它包括了使用「第三方」进行身份认证的方法。这就是所有带有「使用 Facebook，Google，Twitter，GitHub 登录」的系统背后所使用的机制。<br>有一个 OAuth 1，它与 OAuth2 完全不同，并且更为复杂，因为它直接包含了有关如何加密通信的规范。<br>如今它已经不是很流行，没有被广泛使用了。<br>OAuth2 没有指定如何加密通信，它期望你为应用程序使用 HTTPS 进行通信。<br>（2）OpenID Connect<br>OpenID Connect 是另一个基于 OAuth2 的规范。<br>它只是扩展了 OAuth2，并明确了一些在 OAuth2 中相对模糊的内容，以尝试使其更具互操作性。<br>例如，Google 登录使用 OpenID Connect（底层使用OAuth2）。<br>但是 Facebook 登录不支持 OpenID Connect。它具有自己的 OAuth2 风格。<br>（3）OpenID（非「OpenID Connect」）<br>还有一个「OpenID」规范。它试图解决与 OpenID Connect 相同的问题，但它不是基于 OAuth2。<br>因此，它是一个完整的附加系统。<br>如今它已经不是很流行，没有被广泛使用了。<br>（4）OpenAPI<br>OpenAPI（以前称为 Swagger）是用于构建 API 的开放规范（现已成为 Linux Foundation 的一部分）。<br>FastAPI 基于 OpenAPI。<br>这就是使多个自动交互式文档界面，代码生成等成为可能的原因。<br>OpenAPI 有一种定义多个安全「方案」的方法。<br>通过使用它们，你可以利用所有这些基于标准的工具，包括这些交互式文档系统。<br>OpenAPI 定义了以下安全方案：<br>（4.1）<code>apiKey</code>：一个特定于应用程序的密钥，可以来自：查询参数、请求头、cookie。<br>（4.2）<code>http</code>：标准的 HTTP 身份认证系统，包括：</p>
<ul>
<li>bearer: 一个值为 Bearer 加令牌字符串的 Authorization 请求头。这是从 OAuth2 继承的。</li>
<li>HTTP Basic 认证方式。</li>
<li>HTTP Digest，等等。</li>
</ul>
<p>（4.3）<code>oauth2</code>：所有的 OAuth2 处理安全性的方式（称为「流程」）。<br>以下几种流程适合构建 OAuth 2.0 身份认证的提供者（例如 Google，Facebook，Twitter，GitHub 等）：<code>implicit</code>、<code>clientCredentials</code>、<code>authorizationCode</code>。<br>但是有一个特定的「流程」可以完美地用于直接在同一应用程序中处理身份认证：<code>password</code>：接下来的几章将介绍它的示例。<br>（4.4）<code>openIdConnect</code>：提供了一种定义如何自动发现 OAuth2 身份认证数据的方法。此自动发现机制是 OpenID Connect 规范中定义的内容。</p>
<h3 id="基本框架"><a href="#基本框架" class="headerlink" title="基本框架"></a>基本框架</h3><p>假设在某个域中拥有后端API。并且在另一个域或同一域的不同路径中（或在移动应用程序中）有一个前端。<br>此时希望有一种方法让前端使用<code>username</code>和<code>password</code>与后端进行身份验证。<br>我们可以使用FastAPI提供的<code>OAuth2</code>构建它。<br>（注意，需要首先安装<code>python-multipart</code>，这是因为OAuth2使用“表单数据”来发送<code>username</code>和<code>password</code>。）<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI</span><br><span class="line"><span class="comment"># FastAPI提供了多种不同抽象级别的工具来实现安全功能。</span></span><br><span class="line"><span class="comment"># 在此示例中，将使用OAuth2，配合Password流和Bearer令牌。</span></span><br><span class="line"><span class="comment"># 具体地，使用OAuth2PasswordBearer类来做到这一点。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bearer令牌不是唯一的选择。但它是该用例的最佳选择。</span></span><br><span class="line"><span class="comment"># 对于大多数用例来说，它可能是最好的，除非你是 OAuth2 专家并且确切地知道为什么有另一个选项更适合需求。</span></span><br><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> OAuth2PasswordBearer</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当创建OAuth2PasswordBearer类的实例时，传入tokenUrl参数。</span></span><br><span class="line"><span class="comment"># 此参数包含客户端（在用户浏览器中运行的前端）用于发送username和password以获取令牌的URL。</span></span><br><span class="line"><span class="comment"># 这里的tokenUrl=&quot;token&quot;指的是一个相对URL，所以它相当于./token，不过该URL还尚未创建。</span></span><br><span class="line"><span class="comment"># 因为使用的是相对 URL，如果API位于https://example.com/，那么它将引用https://example.com/token。</span></span><br><span class="line"><span class="comment"># 但如果API 位于https://example.com/api/v1/，那么它就是https://example.com/api/v1/token.</span></span><br><span class="line"><span class="comment"># 使用相对 URL 非常重要，可以确保应用程序即使在像代理服务器后面这样的高级用例中也能正常工作。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tokenUrl=&quot;token&quot;不会创建该路径操作，但声明了/token这个URL将是客户端应该用来获取令牌的URL。该信息在 OpenAPI 中使用，然后在交互式 API 文档系统中使用。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># oauth2_scheme变量是OAuth2PasswordBearer的一个实例，但它也是“可调用的”。</span></span><br><span class="line"><span class="comment"># 因此它可被Depends使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 它将查看请求中的Authorization这个header，检查该值是否是Bearer以及一些令牌，并返回str类型的令牌.</span></span><br><span class="line"><span class="comment"># 如果它没有看到Authorization标头，或者该值没有Bearer标记，它将直接返回 401状态代码错误(UNAUTHORIZED)。</span></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="string">&quot;token&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="comment"># 这个依赖将提供一个str赋值给token这个参数</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params">token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_scheme</span>)</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;token&quot;</span>: token&#125;</span><br></pre></td></tr></table></figure><br>以上只是一个基本框架，还没有实际功能。</p>
<h3 id="完整功能"><a href="#完整功能" class="headerlink" title="完整功能"></a>完整功能</h3><p>在查看真正的具有安全功能的代码时，需要用到JWT令牌和哈希密码。<br>（1）JWT令牌<br>JWT 表示 「JSON Web Tokens」。<br>它是一个将 JSON 对象编码为密集且没有空格的长字符串的标准。字符串看起来像这样：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><br></pre></td></tr></table></figure><br>它没有被加密，因此任何人都可以从字符串内容中还原数据。<br>但它经过了签名。因此，当你收到一个由你发出的令牌时，可以校验令牌是否真的由你发出。<br>通过这种方式，你可以创建一个有效期为 1 周的令牌。然后当用户第二天使用令牌重新访问时，你知道该用户仍然处于登入状态。<br>一周后令牌将会过期，用户将不会通过认证，必须再次登录才能获得一个新令牌。而且如果用户（或第三方）试图修改令牌以篡改过期时间，你将因为签名不匹配而能够发觉。</p>
<p>对JWT令牌进行签名，实际就是一个密钥。要生成一个安全的随机密钥，可使用openssl。<br>windows版的openssl可以用别人编译好的，在<a target="_blank" rel="noopener" href="https://slproweb.com/products/Win32OpenSSL.html">这里</a>。<br>在终端中使用以下命令：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -<span class="built_in">hex</span> <span class="number">32</span></span><br></pre></td></tr></table></figure></p>
<p>需要安装 python-jose 以在 Python 中生成和校验 JWT 令牌（Python-jose 需要一个额外的加密后端。这里推荐：pyca/cryptography。）<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install python-jose[cryptography]</span><br></pre></td></tr></table></figure></p>
<p>（2）哈希密码<br>「哈希」的意思是：将某些内容（在本例中为密码）转换为看起来像乱码的字节序列（只是一个字符串）。<br>每次你传入完全相同的内容（完全相同的密码）时，你都会得到完全相同的乱码。<br>但是你不能从乱码转换回密码。<br>PassLib 是一个用于处理哈希密码的很棒的 Python 包。<br>它支持许多安全哈希算法以及配合算法使用的实用程序。<br>推荐的算法是 「Bcrypt」。<br>因此，安装附带 Bcrypt 的 PassLib：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install passlib[bcrypt]</span><br></pre></td></tr></table></figure></p>
<p>完整实例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI, HTTPException, status</span><br><span class="line"><span class="comment"># 将使用 FastAPI 的安全性实用工具来获取 username 和 password。</span></span><br><span class="line"><span class="comment"># OAuth2 规定在使用「password 流程」时，客户端/用户必须将 username 和 password 字段作为表单数据发送（因此，此处不能使用 JSON）。</span></span><br><span class="line"><span class="comment"># 而且规范明确了字段必须这样命名。因此 user-name 或 email 是行不通的。</span></span><br><span class="line"><span class="comment"># 不过不用担心，你可以在前端按照你的想法将它展示给最终用户。</span></span><br><span class="line"><span class="comment"># 而且你的数据库模型也可以使用你想用的任何其他名称。</span></span><br><span class="line"><span class="comment"># 但是对于登录路径操作，我们需要使用这些名称来与规范兼容（以具备例如使用集成的 API 文档系统的能力）。</span></span><br><span class="line"><span class="comment"># 具体地，导入 OAuth2PasswordRequestForm</span></span><br><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> OAuth2PasswordBearer, OAuth2PasswordRequestForm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 passlib 导入我们需要的工具。</span></span><br><span class="line"><span class="keyword">from</span> passlib.context <span class="keyword">import</span> CryptContext</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入jwt相关模块</span></span><br><span class="line"><span class="keyword">from</span> jose <span class="keyword">import</span> JWTError, jwt</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="comment">#################################### JWT相关功能 #####################################</span></span><br><span class="line"><span class="comment"># 在终端中使用openssl rand -hex 32生成如下key</span></span><br><span class="line">SECRET_KEY = <span class="string">&quot;cda3c6e86b29270b741c9e1c62d052f5593921f26ae0badc4027b856f53d679f&quot;</span></span><br><span class="line"><span class="comment"># 创建用于设定 JWT 令牌签名算法的变量 「ALGORITHM」，并将其设置为 &quot;HS256&quot;。</span></span><br><span class="line">ALGORITHM = <span class="string">&quot;HS256&quot;</span></span><br><span class="line"><span class="comment"># 创建一个设置令牌过期时间的变量。</span></span><br><span class="line">ACCESS_TOKEN_EXPIRE_MINUTES = <span class="number">30</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个将在令牌端点中用于响应的 Pydantic 模型。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Token</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    access_token: <span class="built_in">str</span></span><br><span class="line">    token_type: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenData</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    username: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个生成新的访问令牌的工具函数。</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_access_token</span>(<span class="params">data: <span class="built_in">dict</span>, expires_delta: <span class="type">Optional</span>[timedelta] = <span class="literal">None</span></span>):</span></span><br><span class="line">    to_encode = data.copy()</span><br><span class="line">    <span class="keyword">if</span> expires_delta:</span><br><span class="line">        expire = datetime.utcnow() + expires_delta</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        expire = datetime.utcnow() + timedelta(minutes=<span class="number">15</span>)</span><br><span class="line">    to_encode.update(&#123;<span class="string">&quot;exp&quot;</span>: expire&#125;)</span><br><span class="line">    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)</span><br><span class="line">    <span class="keyword">return</span> encoded_jwt</span><br><span class="line"></span><br><span class="line"><span class="comment">#################################### 数据库相关功能 #####################################</span></span><br><span class="line"><span class="comment"># 假的用户数据库</span></span><br><span class="line">fake_users_db = &#123;</span><br><span class="line">    <span class="string">&quot;johndoe&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;johndoe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;full_name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;johndoe@example.com&quot;</span>,</span><br><span class="line">        <span class="comment"># 哈希密码，不明文存储，如下是明文密目&quot;secret&quot;的哈希，所以登录时要用secret登录</span></span><br><span class="line">        <span class="string">&quot;hashed_password&quot;</span>: <span class="string">&quot;$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW&quot;</span>,</span><br><span class="line">        <span class="string">&quot;disabled&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个用户 Pydantic 模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    email: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    full_name: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    disabled: <span class="type">Optional</span>[<span class="built_in">bool</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInDB</span>(<span class="params">User</span>):</span></span><br><span class="line">    hashed_password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="string">&quot;token&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#################################### 哈希密码相关功能 #####################################</span></span><br><span class="line"><span class="comment"># 创建一个 PassLib 「上下文」。这将用于哈希和校验密码。</span></span><br><span class="line">pwd_context = CryptContext(schemes=[<span class="string">&quot;bcrypt&quot;</span>], deprecated=<span class="string">&quot;auto&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个工具函数以哈希来自用户的密码。</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_password_hash</span>(<span class="params">password</span>):</span></span><br><span class="line">    <span class="keyword">return</span> pwd_context.<span class="built_in">hash</span>(password)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建另一个工具函数，用于校验接收的密码是否与存储的哈希值匹配。</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_password</span>(<span class="params">plain_password, hashed_password</span>):</span></span><br><span class="line">    <span class="keyword">return</span> pwd_context.verify(plain_password, hashed_password)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user</span>(<span class="params">db, username: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">in</span> db:</span><br><span class="line">        user_dict = db[username]</span><br><span class="line">        <span class="keyword">return</span> UserInDB(**user_dict)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建另一个工具函数用于认证并返回用户。</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">authenticate_user</span>(<span class="params">fake_db, username: <span class="built_in">str</span>, password: <span class="built_in">str</span></span>):</span></span><br><span class="line">    user = get_user(fake_db, username)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> verify_password(password, user.hashed_password):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个 get_current_user 依赖项</span></span><br><span class="line"><span class="comment"># get_current_user将具有一个之前所创建的同一个 oauth2_scheme 作为依赖项。</span></span><br><span class="line"><span class="comment"># 与之前直接在路径操作中所做的相同，新的依赖项 get_current_user 将从子依赖项 oauth2_scheme 中接收一个 str 类型的 token，具体地，就是一个JWT令牌</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_current_user</span>(<span class="params">token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_scheme</span>)</span>):</span></span><br><span class="line">    credentials_exception = HTTPException(</span><br><span class="line">        status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">        detail=<span class="string">&quot;Could not validate credentials&quot;</span>,</span><br><span class="line">        headers=&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>: <span class="string">&quot;Bearer&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 解码接收到的令牌，对其进行校验</span></span><br><span class="line">        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])</span><br><span class="line">        <span class="comment"># JWT 的规范中有一个 sub 键，值为该令牌的主题。</span></span><br><span class="line">        <span class="comment"># 使用它并不是必须的，但这是放置用户标识的地方，所以在示例中使用了它。</span></span><br><span class="line">        username: <span class="built_in">str</span> = payload.get(<span class="string">&quot;sub&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> credentials_exception</span><br><span class="line">        token_data = TokenData(username=username)</span><br><span class="line">    <span class="comment"># 如果令牌无效，立即返回一个 HTTP 错误。</span></span><br><span class="line">    <span class="keyword">except</span> JWTError:</span><br><span class="line">        <span class="keyword">raise</span> credentials_exception</span><br><span class="line">    <span class="comment"># 然后返回当前用户</span></span><br><span class="line">    user = get_user(fake_users_db, username=token_data.username)</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> credentials_exception</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"><span class="comment"># 想要仅当此用户处于启用状态时才能获取 current_user。</span></span><br><span class="line"><span class="comment"># 因此，创建了一个额外的依赖项 get_current_active_user，而该依赖项又以 get_current_user 作为依赖项。</span></span><br><span class="line"><span class="comment"># 如果用户不存在或处于未启用状态，则这两个依赖项都将返回 HTTP 错误。</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_current_active_user</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_user</span>)</span>):</span></span><br><span class="line">    <span class="keyword">if</span> current_user.disabled:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;Inactive user&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> current_user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在token的路径操作中通过Depends将OAuth2PasswordRequestForm作为依赖项使用</span></span><br><span class="line"><span class="comment"># OAuth2PasswordRequestForm 是一个类依赖项，声明了如下的请求表单：</span></span><br><span class="line"><span class="comment"># - username。</span></span><br><span class="line"><span class="comment"># - password。</span></span><br><span class="line"><span class="comment"># - 一个可选的 scope 字段，但实际上它是一个由空格分隔的「作用域」组成的长字符串。每个「作用域」只是一个字符串（中间没有空格）。它们通常用于声明特定的安全权限，例如：users:read 或者 users:write 是常见的例子。类依赖项 OAuth2PasswordRequestForm 的实例不会有用空格分隔的长字符串属性 scope，而是具有一个 scopes 属性，该属性将包含实际被发送的每个作用域字符串组成的列表。</span></span><br><span class="line"><span class="comment"># - 一个可选的 grant_type.</span></span><br><span class="line"><span class="comment"># - 一个可选的 client_id（该示例不需要它）。</span></span><br><span class="line"><span class="comment"># - 一个可选的 client_secret（该示例不需要它）。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/token&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">login_for_access_token</span>(<span class="params">form_data: OAuth2PasswordRequestForm = Depends(<span class="params"></span>)</span>):</span> <span class="comment">#这个是一个快捷方式</span></span><br><span class="line">    <span class="comment"># 使用表单字段中的 username 从（伪）数据库中获取用户数据。 </span></span><br><span class="line">    <span class="comment"># 如果没有这个用户，我们将返回一个错误消息，提示「用户名或密码错误」。</span></span><br><span class="line">    user = authenticate_user(fake_users_db, form_data.username, form_data.password)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=status.HTTP_401_UNAUTHORIZED,</span><br><span class="line">            detail=<span class="string">&quot;Incorrect username or password&quot;</span>,</span><br><span class="line">            headers=&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>: <span class="string">&quot;Bearer&quot;</span>&#125;,</span><br><span class="line">        )</span><br><span class="line">    <span class="comment"># 创建一个真实的 JWT 访问令牌 </span></span><br><span class="line">    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)</span><br><span class="line">    access_token = create_access_token(</span><br><span class="line">        data=&#123;<span class="string">&quot;sub&quot;</span>: user.username&#125;, expires_delta=access_token_expires</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># token 端点的响应必须是一个 JSON 对象，里面包含有：</span></span><br><span class="line">    <span class="comment"># （1）token_type字段：在该例中，由于我们使用的是「Bearer」令牌，因此令牌类型应为「bearer」。</span></span><br><span class="line">    <span class="comment"># （2）access_token字段：它是一个包含我们的访问令牌的字符串。</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;access_token&quot;</span>: access_token, <span class="string">&quot;token_type&quot;</span>: <span class="string">&quot;bearer&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意声明响应模型</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/me/&quot;</span>, response_model=User</span>)</span></span><br><span class="line"><span class="comment"># 在路径操作中使用 get_current_active_user 作为 Depends</span></span><br><span class="line"><span class="comment"># 注意我们将 current_user 的类型声明为 Pydantic 模型 User。</span></span><br><span class="line"><span class="comment"># 这将帮助我们在函数内部使用所有的代码补全和类型检查。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在这个端点中，只有当用户存在，身份认证通过且处于启用状态时，我们才能获得该用户</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_users_me</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_active_user</span>)</span>):</span></span><br><span class="line">    <span class="keyword">return</span> current_user</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/me/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_own_items</span>(<span class="params">current_user: User = Depends(<span class="params">get_current_active_user</span>)</span>):</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;item_id&quot;</span>: <span class="string">&quot;Foo&quot;</span>, <span class="string">&quot;owner&quot;</span>: current_user.username&#125;]</span><br></pre></td></tr></table></figure></p>
<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><p>可以向 FastAPI 应用添加中间件.<br>“中间件”是一个函数,它在每个请求被特定的路径操作处理之前,以及在每个响应返回之前工作.</p>
<ul>
<li>它接收你的应用程序的每一个请求.</li>
<li>然后它可以对这个请求做一些事情或者执行任何需要的代码.</li>
<li>然后它将请求传递给应用程序的其他部分 (通过某种路径操作).</li>
<li>然后它获取应用程序生产的响应 (通过某种路径操作).</li>
<li>它可以对该响应做些什么或者执行任何需要的代码.</li>
<li>然后它返回这个响应。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Request</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 要创建中间件你可以在函数的顶部使用装饰器 @app.middleware(&quot;http&quot;).</span></span><br><span class="line"><span class="comment"># 中间件参数接收如下参数:</span></span><br><span class="line">- request.</span><br><span class="line">- call_next函数：它将接收 request 作为参数.</span><br><span class="line">（<span class="number">1</span>）这个函数将 request 传递给相应的 路径操作.</span><br><span class="line">（<span class="number">2</span>）然后它将返回由相应的路径操作生成的 response.</span><br><span class="line">（<span class="number">3</span>）然后你可以在返回 response 前进一步修改它.</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.middleware(<span class="params"><span class="string">&quot;http&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">add_process_time_header</span>(<span class="params">request: Request, call_next</span>):</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    response = <span class="keyword">await</span> call_next(request)</span><br><span class="line">    process_time = time.time() - start_time</span><br><span class="line">    <span class="comment"># 可以 用&#x27;X-&#x27; 前缀添加专有自定义请求头.</span></span><br><span class="line">    <span class="comment"># 但是如果你想让浏览器中的客户端看到你的自定义请求头, 你需要把它们加到 CORS 配置 (CORS (Cross-Origin Resource Sharing)) 的 expose_headers 参数中</span></span><br><span class="line">    response.headers[<span class="string">&quot;X-Process-Time&quot;</span>] = <span class="built_in">str</span>(process_time)</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<h2 id="CORS跨域资源共享"><a href="#CORS跨域资源共享" class="headerlink" title="CORS跨域资源共享"></a>CORS跨域资源共享</h2><p>CORS 或者「跨域资源共享」 指浏览器中运行的前端拥有与后端通信的 JavaScript 代码，而后端处于与前端不同的「源」的情况。<br>源origin是协议（<code>http</code>，<code>https</code>）、域（<code>myapp.com</code>，<code>localhost</code>，<code>localhost.tiangolo.com</code>）以及端口（<code>80</code>、<code>443</code>、<code>8080</code>）的组合。</p>
<p>因此，这些都是不同的源：<code>http://localhost</code>、<code>https://localhost</code>、<code>http://localhost:8080</code>。<br>即使它们都在 localhost 中，但是它们使用不同的协议或者端口，所以它们都是不同的「源」。</p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>假设你的浏览器中有一个前端运行在<code>http://localhost:8080</code>，并且它的 JavaScript 正在尝试与运行在<code>http://localhost</code>的后端通信（因为我们没有指定端口，浏览器会采用默认的端口<code>80</code>）。<br>然后，浏览器会向后端发送一个 <code>HTTP OPTIONS</code> 请求，如果后端发送适当的 <code>headers</code> 来授权来自这个不同源（<code>http://localhost:8080</code>）的通信，浏览器将允许前端的 JavaScript 向后端发送请求。<br>为此，后端必须有一个「允许的源」列表。<br>在这种情况下，它必须包含<code>http://localhost:8080</code>，前端才能正常工作。</p>
<h3 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h3><p>也可以使用 “*”（一个「通配符」）声明这个列表，表示全部都是允许的。<br>但这仅允许某些类型的通信，不包括所有涉及凭据的内容：像 Cookies 以及那些使用 Bearer 令牌的授权 headers 等。<br>因此，为了一切都能正常工作，最好显式地指定允许的源。</p>
<h3 id="使用CORSMiddleware"><a href="#使用CORSMiddleware" class="headerlink" title="使用CORSMiddleware"></a>使用CORSMiddleware</h3><p>可以在 FastAPI 应用中使用 CORSMiddleware 来配置它。<br>（1）导入 CORSMiddleware。<br>（2）创建一个允许的源列表（由字符串组成）。<br>（3）将其作为「中间件」添加到你的 FastAPI 应用中。</p>
<p>也可以指定后端是否允许：<br>（1）凭证（授权 headers，Cookies 等）。<br>（2）特定的 HTTP 方法（POST，PUT）或者使用通配符 “<em>“ 允许所有方法。<br>（3）特定的 HTTP headers 或者使用通配符 “</em>“ 允许所有 headers。</p>
<p>默认情况下，这个 CORSMiddleware 实现所使用的默认参数较为保守，所以你需要显式地启用特定的源、方法或者 headers，以便浏览器能够在跨域上下文中使用它们。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> fastapi.middleware.cors <span class="keyword">import</span> CORSMiddleware</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">origins = [</span><br><span class="line">    <span class="string">&quot;http://localhost.tiangolo.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://localhost.tiangolo.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://localhost&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://localhost:8080&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">app.add_middleware(</span><br><span class="line">    CORSMiddleware,</span><br><span class="line">    <span class="comment"># allow_origins：一个允许跨域请求的源列表。例如 [&#x27;https://example.org&#x27;, &#x27;https://www.example.org&#x27;]。可以使用 [&#x27;*&#x27;] 允许任何源。</span></span><br><span class="line">    allow_origins=origins,</span><br><span class="line">    <span class="comment"># allow_credentials：指示跨域请求支持 cookies。默认是 False。另外，允许凭证时 allow_origins 不能设定为 [&#x27;*&#x27;]，必须指定源。</span></span><br><span class="line">    allow_credentials=<span class="literal">True</span>,</span><br><span class="line">    <span class="comment"># allow_methods：一个允许跨域请求的 HTTP 方法列表。默认为 [&#x27;GET&#x27;]。你可以使用 [&#x27;*&#x27;] 来允许所有标准方法。</span></span><br><span class="line">    allow_methods=[<span class="string">&quot;*&quot;</span>],</span><br><span class="line">    <span class="comment"># allow_headers：一个允许跨域请求的 HTTP 请求头列表。默认为 []。你可以使用 [&#x27;*&#x27;] 允许所有的请求头。</span></span><br><span class="line">    <span class="comment"># Accept、Accept-Language、Content-Language 以及 Content-Type 请求头总是允许 CORS 请求。</span></span><br><span class="line">    allow_headers=[<span class="string">&quot;*&quot;</span>],</span><br><span class="line">    <span class="comment"># 还有其他，比如：</span></span><br><span class="line">    <span class="comment"># allow_origin_regex：一个正则表达式字符串，匹配的源允许跨域请求。例如 &#x27;https://.*\.example\.org&#x27;。</span></span><br><span class="line">    <span class="comment"># expose_headers：指示可以被浏览器访问的响应头。默认为 []。</span></span><br><span class="line">    <span class="comment"># max_age：设定浏览器缓存 CORS 响应的最长时间，单位是秒。默认为 600。</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br></pre></td></tr></table></figure><br>中间件响应两种特定类型的 HTTP 请求：<br>（1）CORS 预检请求<br>这是些带有 Origin 和 Access-Control-Request-Method 请求头的 OPTIONS 请求。<br>在这种情况下，中间件将拦截传入的请求并进行响应，出于提供信息的目的返回一个使用了适当的 CORS headers 的 200 或 400 响应。<br>（2）简单请求<br>任何带有 Origin 请求头的请求。在这种情况下，中间件将像平常一样传递请求，但是在响应中包含适当的 CORS headers。</p>
<h2 id="SQL数据库"><a href="#SQL数据库" class="headerlink" title="SQL数据库"></a>SQL数据库</h2><p>FastAPI不要求使用 SQL（关系）数据库。不过可以使用任何想要的关系数据库（通过SQLAlchemy实现）。<br>在下面示例中，将使用SQLite，因为它使用单个文件并且 Python 具有集成支持。对于大的生产应用程序，可能希望使用像PostgreSQL这样的数据库服务器。<br><a target="_blank" rel="noopener" href="https://github.com/tiangolo/full-stack-fastapi-postgresql">这里</a>有一个带有FastAPI和PostgreSQL的官方项目生成器，全部基于Docker，包括前端和更多工具。</p>
<p>首先需要安装SQLAlchemy：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install SQLAlchemy</span><br></pre></td></tr></table></figure></p>
<p>文件结构：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">└── sql_app</span><br><span class="line">    ├── __init__.py</span><br><span class="line">    ├── crud.py</span><br><span class="line">    ├── database.py</span><br><span class="line">    ├── main.py</span><br><span class="line">    ├── models.py</span><br><span class="line">    └── schemas.py</span><br></pre></td></tr></table></figure><br>（1）对于database.py文件<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入 SQLAlchemy 部件</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为 SQLAlchemy 创建数据库 URL</span></span><br><span class="line">SQLALCHEMY_DATABASE_URL = <span class="string">&quot;sqlite:///./sql_app.db&quot;</span></span><br><span class="line"><span class="comment"># SQLALCHEMY_DATABASE_URL = &quot;postgresql://user:password@postgresserver/db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 SQLAlchemy engine</span></span><br><span class="line">engine = create_engine(</span><br><span class="line">    <span class="comment"># connect_args仅用于SQLite. 其他数据库不需要它</span></span><br><span class="line">    <span class="comment"># 默认情况下，SQLite只允许一个线程与其通信，假设每个线程将处理一个独立的请求。</span></span><br><span class="line">    <span class="comment"># 这是为了防止意外地为不同的事物（不同的请求）共享相同的连接。</span></span><br><span class="line">    <span class="comment"># 但是在 FastAPI 中，使用普通函数 ( def) 多个线程可以为同一个请求与数据库交互，因此我们需要让 SQLite 知道它应该允许这个connect_args=&#123;&quot;check_same_thread&quot;: False&#125;</span></span><br><span class="line">    <span class="comment"># 此外，我们将确保每个请求获得自己的数据库连接会话，因此不需要该默认机制。</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URL, connect_args=&#123;<span class="string">&quot;check_same_thread&quot;</span>: <span class="literal">False</span>&#125;</span><br><span class="line">)</span><br><span class="line"><span class="comment"># 创建一个SessionLocal类</span></span><br><span class="line"><span class="comment"># SessionLocal类的每一个实例都是一个数据库会话。该类本身并不是数据库会话。</span></span><br><span class="line">SessionLocal = sessionmaker(autocommit=<span class="literal">False</span>, autoflush=<span class="literal">False</span>, bind=engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用declarative_base()返回一个类。</span></span><br><span class="line"><span class="comment"># 稍后将从这个类继承来创建每个数据库模型或类（ORM 模型）：</span></span><br><span class="line">Base = declarative_base()</span><br></pre></td></tr></table></figure><br>（2）对于models.py文件<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Boolean, Column, ForeignKey, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> relationship</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从database.py文件中导入Base类</span></span><br><span class="line"><span class="keyword">from</span> .database <span class="keyword">import</span> Base</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Base的子类，这些类都是SQLAlchemy模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Base</span>):</span></span><br><span class="line">    <span class="comment"># __tablename__属性告诉SQLAlchemy这些模型在数据库中的文件</span></span><br><span class="line">    __tablename__ = <span class="string">&quot;users&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建模型字段，每个字段在数据库中都是一列Column，也就是数据表的字段</span></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    email = Column(String, unique=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    hashed_password = Column(String)</span><br><span class="line">    is_active = Column(Boolean, default=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建数据表之间的关系</span></span><br><span class="line">    items = relationship(<span class="string">&quot;Item&quot;</span>, back_populates=<span class="string">&quot;owner&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">Base</span>):</span></span><br><span class="line">    __tablename__ = <span class="string">&quot;items&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = Column(Integer, primary_key=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    title = Column(String, index=<span class="literal">True</span>)</span><br><span class="line">    description = Column(String, index=<span class="literal">True</span>)</span><br><span class="line">    owner_id = Column(Integer, ForeignKey(<span class="string">&quot;users.id&quot;</span>))</span><br><span class="line"></span><br><span class="line">    owner = relationship(<span class="string">&quot;User&quot;</span>, back_populates=<span class="string">&quot;items&quot;</span>)</span><br></pre></td></tr></table></figure><br>（3）对于schemas.py文件<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为了不搞混SQLAlchemy模型和Pydantic模型，就用models.py存放SQLAlchemy模型，而该文件schemas.py存放Pydantic模型</span></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建ItemBase这一Pydantic模型，作为一个盛放关于item统一属性的模型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ItemBase</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    title: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ItemCreate</span>(<span class="params">ItemBase</span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Item</span>(<span class="params">ItemBase</span>):</span></span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line">    owner_id: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用config属性对Pydantic模型进行配置</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Config</span>:</span></span><br><span class="line">        <span class="comment"># orm_mode参数告诉Pydantic模型读取数据，即使它不是一个dict，而是一个ORM模型（或其他任意带属性的对象）</span></span><br><span class="line">        <span class="comment"># 此时它会尝试通过id = data.id这样获取属性的方式来读取数据，</span></span><br><span class="line">        <span class="comment"># 而不是id = data[&#x27;id&#x27;]这样字典读key的方法</span></span><br><span class="line">        <span class="comment"># 这样Pydantic模型就与ORM模型可以兼容，</span></span><br><span class="line">        <span class="comment"># 在路径操作中也可使用response_model来声明</span></span><br><span class="line">        orm_mode = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserBase</span>(<span class="params">BaseModel</span>):</span></span><br><span class="line">    email: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserCreate</span>(<span class="params">UserBase</span>):</span></span><br><span class="line">    password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">UserBase</span>):</span></span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line">    is_active: <span class="built_in">bool</span></span><br><span class="line">    items: <span class="type">List</span>[Item] = []</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Config</span>:</span></span><br><span class="line">        orm_mode = <span class="literal">True</span></span><br></pre></td></tr></table></figure></p>
<p>（4）对于crud.py文件<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 该文件就是对数据库的操作，即增删改查</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从SQLAlchemy.orm中导入Session，这将允许对下面的db参数进行类型声明，从而有类型检查和补全功能</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入SQLAlchemy模型和Pydantic模型</span></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> models, schemas</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建几个工具函数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># （1）通过id读取单个用户</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user</span>(<span class="params">db: Session, user_id: <span class="built_in">int</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> db.query(models.User).<span class="built_in">filter</span>(models.User.<span class="built_in">id</span> == user_id).first()</span><br><span class="line"><span class="comment"># （2）通过邮箱读取单个用户</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user_by_email</span>(<span class="params">db: Session, email: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> db.query(models.User).<span class="built_in">filter</span>(models.User.email == email).first()</span><br><span class="line"></span><br><span class="line"><span class="comment"># （3）读取多个用户</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_users</span>(<span class="params">db: Session, skip: <span class="built_in">int</span> = <span class="number">0</span>, limit: <span class="built_in">int</span> = <span class="number">100</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> db.query(models.User).offset(skip).limit(limit).<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># （4）创建一个用户</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user</span>(<span class="params">db: Session, user: schemas.UserCreate</span>):</span></span><br><span class="line">    fake_hashed_password = user.password + <span class="string">&quot;notreallyhashed&quot;</span></span><br><span class="line">    db_user = models.User(email=user.email, hashed_password=fake_hashed_password)</span><br><span class="line">    <span class="comment"># add添加实例对象</span></span><br><span class="line">    db.add(db_user)</span><br><span class="line">    <span class="comment"># commit提交更改</span></span><br><span class="line">    db.commit()</span><br><span class="line">    <span class="comment"># refresh刷新以获得最新数据</span></span><br><span class="line">    db.refresh(db_user)</span><br><span class="line">    <span class="keyword">return</span> db_user</span><br><span class="line"></span><br><span class="line"><span class="comment"># （5）读取多个items</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_items</span>(<span class="params">db: Session, skip: <span class="built_in">int</span> = <span class="number">0</span>, limit: <span class="built_in">int</span> = <span class="number">100</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> db.query(models.Item).offset(skip).limit(limit).<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># （6）创建一个item</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user_item</span>(<span class="params">db: Session, item: schemas.ItemCreate, user_id: <span class="built_in">int</span></span>):</span></span><br><span class="line">    <span class="comment"># **是用来解包，并且附加另一个参数</span></span><br><span class="line">    db_item = models.Item(**item.<span class="built_in">dict</span>(), owner_id=user_id)</span><br><span class="line">    db.add(db_item)</span><br><span class="line">    db.commit()</span><br><span class="line">    db.refresh(db_item)</span><br><span class="line">    <span class="keyword">return</span> db_item</span><br></pre></td></tr></table></figure></p>
<p>（5）对于main.py文件<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI, HTTPException</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> crud, models, schemas</span><br><span class="line"><span class="keyword">from</span> .database <span class="keyword">import</span> SessionLocal, engine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库的数据表</span></span><br><span class="line"><span class="comment"># 通常，可能会使用Alembic初始化数据库（创建表等）。</span></span><br><span class="line"><span class="comment"># 还可以使用 Alembic 进行“迁移”（这是它的主要工作）。</span></span><br><span class="line"><span class="comment"># “迁移”是每当更改 SQLAlchemy 模型的结构、添加新属性等以在数据库中复制这些更改、添加新列、新表等时所需的一组步骤。</span></span><br><span class="line"><span class="comment"># 可以在Project Generation - Template的模板中找到一个 FastAPI 项目中的 Alembic 示例。</span></span><br><span class="line">models.Base.metadata.create_all(bind=engine)</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个依赖项</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db</span>():</span></span><br><span class="line">    <span class="comment"># 每个请求都有一个独立的会话，请求结束后就关闭它</span></span><br><span class="line">    <span class="comment"># 但所有会话都是同一个</span></span><br><span class="line">    db = SessionLocal()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># yield的用法可以参考之前部分</span></span><br><span class="line">        <span class="keyword">yield</span> db</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        db.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/users/&quot;</span>, response_model=schemas.User</span>)</span></span><br><span class="line"><span class="comment"># 在路径操作中都使用上述依赖</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user</span>(<span class="params">user: schemas.UserCreate, db: Session = Depends(<span class="params">get_db</span>)</span>):</span></span><br><span class="line">    db_user = crud.get_user_by_email(db, email=user.email)</span><br><span class="line">    <span class="keyword">if</span> db_user:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;Email already registered&quot;</span>)</span><br><span class="line">    <span class="comment"># 返回的是SQLAlchemy模型，但是因为设置了orm_mode，就能与响应模型兼容</span></span><br><span class="line">    <span class="keyword">return</span> crud.create_user(db=db, user=user)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&quot;</span>, response_model=<span class="type">List</span>[schemas.User]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_users</span>(<span class="params">skip: <span class="built_in">int</span> = <span class="number">0</span>, limit: <span class="built_in">int</span> = <span class="number">100</span>, db: Session = Depends(<span class="params">get_db</span>)</span>):</span></span><br><span class="line">    users = crud.get_users(db, skip=skip, limit=limit)</span><br><span class="line">    <span class="keyword">return</span> users</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;&quot;</span>, response_model=schemas.User</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_user</span>(<span class="params">user_id: <span class="built_in">int</span>, db: Session = Depends(<span class="params">get_db</span>)</span>):</span></span><br><span class="line">    db_user = crud.get_user(db, user_id=user_id)</span><br><span class="line">    <span class="keyword">if</span> db_user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">404</span>, detail=<span class="string">&quot;User not found&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> db_user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;/items/&quot;</span>, response_model=schemas.Item</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_item_for_user</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    user_id: <span class="built_in">int</span>, item: schemas.ItemCreate, db: Session = Depends(<span class="params">get_db</span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    <span class="keyword">return</span> crud.create_user_item(db=db, item=item, user_id=user_id)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span>, response_model=<span class="type">List</span>[schemas.Item]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_items</span>(<span class="params">skip: <span class="built_in">int</span> = <span class="number">0</span>, limit: <span class="built_in">int</span> = <span class="number">100</span>, db: Session = Depends(<span class="params">get_db</span>)</span>):</span></span><br><span class="line">    items = crud.get_items(db, skip=skip, limit=limit)</span><br><span class="line">    <span class="keyword">return</span> items</span><br></pre></td></tr></table></figure></p>
<p>运行：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uvicorn sql_app.main:app --reload</span><br></pre></td></tr></table></figure><br>注意得在包外面，按如上方式运行。因为文件内有相对路径导入。</p>
<p>查看SQLite数据，可以使用在线工具，如<a target="_blank" rel="noopener" href="https://inloop.github.io/sqlite-viewer/">https://inloop.github.io/sqlite-viewer/</a>。</p>
<h2 id="大型项目的文件组织"><a href="#大型项目的文件组织" class="headerlink" title="大型项目的文件组织"></a>大型项目的文件组织</h2><p>如果正在开发一个应用程序或 Web API，很少会将所有的内容都放在一个文件中。<br>FastAPI 提供了一个方便的工具，可以在保持所有灵活性的同时构建你的应用程序。<br>如果你来自 Flask，那这将相当于 Flask 的 Blueprints。</p>
<p>文件结构：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── app                  <span class="comment"># 「app」是一个 Python 包</span></span><br><span class="line">│   ├── __init__.py      <span class="comment"># 这个文件使「app」成为一个 Python 包</span></span><br><span class="line">│   ├── main.py          <span class="comment"># 「main」模块，例如 import app.main</span></span><br><span class="line">│   ├── dependencies.py  <span class="comment"># 「dependencies」模块，例如 import app.dependencies</span></span><br><span class="line">│   └── routers          <span class="comment"># 「routers」是一个「Python 子包」</span></span><br><span class="line">│   │   ├── __init__.py  <span class="comment"># 使「routers」成为一个「Python 子包」</span></span><br><span class="line">│   │   ├── items.py     <span class="comment"># 「items」子模块，例如 import app.routers.items</span></span><br><span class="line">│   │   └── users.py     <span class="comment"># 「users」子模块，例如 import app.routers.users</span></span><br><span class="line">│   └── internal         <span class="comment"># 「internal」是一个「Python 子包」</span></span><br><span class="line">│       ├── __init__.py  <span class="comment"># 使「internal」成为一个「Python 子包」</span></span><br><span class="line">│       └── admin.py     <span class="comment"># 「admin」子模块，例如 import app.internal.admin</span></span><br></pre></td></tr></table></figure></p>
<h3 id="APIRouter路由"><a href="#APIRouter路由" class="headerlink" title="APIRouter路由"></a>APIRouter路由</h3><p>APIRouter可以使得对于不同对象的路径操作写在不同文件中，以使其井井有条。<br>（1）专门用于处理用户逻辑的文件是位于 <code>/app/routers/users.py</code> 的子模块<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 专门处理用户逻辑的路由文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入 APIRouter</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过与 FastAPI 类相同的方式创建一个「实例」</span></span><br><span class="line">router = APIRouter()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以将 APIRouter 视为一个「迷你 FastAPI」类。</span></span><br><span class="line"><span class="comment"># 所有相同的选项都得到支持。</span></span><br><span class="line"><span class="comment"># 所有相同的 parameters、responses、dependencies、tags 等等。</span></span><br><span class="line"><span class="meta">@router.get(<span class="params"><span class="string">&quot;/users/&quot;</span>, tags=[<span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_users</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;Rick&quot;</span>&#125;, &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;Morty&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.get(<span class="params"><span class="string">&quot;/users/me&quot;</span>, tags=[<span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_user_me</span>():</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;fakecurrentuser&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.get(<span class="params"><span class="string">&quot;/users/&#123;username&#125;&quot;</span>, tags=[<span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_user</span>(<span class="params">username: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;username&quot;</span>: username&#125;</span><br></pre></td></tr></table></figure><br>（2）专门用于处理应用程序中「项目」的路由操作：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter, Depends, HTTPException</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ..dependencies <span class="keyword">import</span> get_token_header</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此模块中的所有路径操作都有相同的：</span></span><br><span class="line">    <span class="comment"># 路径 prefix：/items。</span></span><br><span class="line">    <span class="comment"># tags：（仅有一个 items 标签）。</span></span><br><span class="line">    <span class="comment"># 额外的 responses。</span></span><br><span class="line">    <span class="comment"># dependencies：它们都需要我们创建的 X-Token 依赖项。</span></span><br><span class="line"><span class="comment"># 因此，我们可以将其添加到 APIRouter 中，而不是将其添加到每个路径操作中。</span></span><br><span class="line">router = APIRouter(</span><br><span class="line">    prefix=<span class="string">&quot;/items&quot;</span>,</span><br><span class="line">    tags=[<span class="string">&quot;items&quot;</span>],</span><br><span class="line">    dependencies=[Depends(get_token_header)],</span><br><span class="line">    responses=&#123;<span class="number">404</span>: &#123;<span class="string">&quot;description&quot;</span>: <span class="string">&quot;Not found&quot;</span>&#125;&#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_items_db = &#123;<span class="string">&quot;plumbus&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Plumbus&quot;</span>&#125;, <span class="string">&quot;gun&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Portal Gun&quot;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>():</span></span><br><span class="line">    <span class="keyword">return</span> fake_items_db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.get(<span class="params"><span class="string">&quot;/&#123;item_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_item</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> item_id <span class="keyword">not</span> <span class="keyword">in</span> fake_items_db:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">404</span>, detail=<span class="string">&quot;Item not found&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;name&quot;</span>: fake_items_db[item_id][<span class="string">&quot;name&quot;</span>], <span class="string">&quot;item_id&quot;</span>: item_id&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.put(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    <span class="string">&quot;/&#123;item_id&#125;&quot;</span>,</span></span></span><br><span class="line"><span class="meta"><span class="params">    <span class="comment"># 仍然可以添加更多将会应用于特定的路径操作的tags，以及一些特定于该路径操作的额外 responses</span></span></span></span><br><span class="line"><span class="meta"><span class="params">    <span class="comment"># 最后的这个路径操作将包含标签的组合：[&quot;items&quot;，&quot;custom&quot;]。</span></span></span></span><br><span class="line"><span class="meta"><span class="params">    <span class="comment"># 并且在文档中也会有两个响应，一个用于 404，一个用于 403。</span></span></span></span><br><span class="line"><span class="meta"><span class="params">    tags=[<span class="string">&quot;custom&quot;</span>],</span></span></span><br><span class="line"><span class="meta"><span class="params">    responses=&#123;<span class="number">403</span>: &#123;<span class="string">&quot;description&quot;</span>: <span class="string">&quot;Operation forbidden&quot;</span>&#125;&#125;,</span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_item</span>(<span class="params">item_id: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> item_id != <span class="string">&quot;plumbus&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(</span><br><span class="line">            status_code=<span class="number">403</span>, detail=<span class="string">&quot;You can only update the item: plumbus&quot;</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;item_id&quot;</span>: item_id, <span class="string">&quot;name&quot;</span>: <span class="string">&quot;The great Plumbus&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>也可以在另一个 APIRouter 中包含 APIRouter，通过：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.include_router(other_router)</span><br></pre></td></tr></table></figure><br>请确保在你将 <code>router</code> 包含到 FastAPI 应用程序之前进行此操作，以便 <code>other_router</code> 中的路径操作也能被包含进来。</p>
<p>（3）现在，假设你的组织为你提供了 <code>app/internal/admin.py</code> 文件。<br>它包含一个带有一些由你的组织在多个项目之间共享的管理员路径操作的 <code>APIRouter</code>。<br>对于此示例，它将非常简单。但是假设由于它是与组织中的其他项目所共享的，因此我们无法对其进行修改，以及直接在 APIRouter 中添加 <code>prefix</code>、<code>dependencies</code>、<code>tags</code> 等：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"></span><br><span class="line">router = APIRouter()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">update_admin</span>():</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Admin getting schwifty&quot;</span>&#125;</span><br></pre></td></tr></table></figure><br>但是我们仍然希望在包含 APIRouter 时设置一个自定义的 <code>prefix</code>，以便其所有路径操作以 <code>/admin</code> 开头，我们希望使用本项目已经有的 <code>dependencies</code> 保护它，并且我们希望它包含自定义的 <code>tags</code> 和 <code>responses</code>。<br>这些将在主体文件<code>main.py</code>中实现。</p>
<h3 id="依赖项-1"><a href="#依赖项-1" class="headerlink" title="依赖项"></a>依赖项</h3><p>我们将需要一些在应用程序的好几个地方所使用的依赖项。<br>因此，将它们放在 <code>dependencies</code> 模块（<code>app/dependencies.py</code>）中。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Header, HTTPException</span><br><span class="line"><span class="comment"># 我们正在使用虚构的请求首部来简化此示例。</span></span><br><span class="line"><span class="comment"># 但在实际情况下，使用集成的安全性实用工具会得到更好的效果。</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_token_header</span>(<span class="params">x_token: <span class="built_in">str</span> = Header(<span class="params">...</span>)</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x_token != <span class="string">&quot;fake-super-secret-token&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;X-Token header invalid&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_query_token</span>(<span class="params">token: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> token != <span class="string">&quot;jessica&quot;</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;No Jessica token provided&quot;</span>)</span><br></pre></td></tr></table></figure><br>所有的这些路径操作都将在自身之前计算/执行 dependencies 列表。</p>
<ul>
<li>如果你还在一个具体的路径操作中声明了依赖项，它们也会被执行。</li>
<li>路由器的依赖项最先执行，然后是装饰器中的 dependencies，再然后是普通的参数依赖项。</li>
<li>你还可以添加具有 scopes 的 Security 依赖项。</li>
</ul>
<h3 id="主体"><a href="#主体" class="headerlink" title="主体"></a>主体</h3><p><code>app/main.py</code>模块导入并使用 FastAPI 类。<br>这将是你的应用程序中将所有内容联结在一起的主文件。<br>并且由于你的大部分逻辑现在都存在于其自己的特定模块中，因此主文件的内容将非常简单。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> Depends, FastAPI</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .dependencies <span class="keyword">import</span> get_query_token, get_token_header</span><br><span class="line"><span class="keyword">from</span> .internal <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> .routers <span class="keyword">import</span> items, users</span><br><span class="line"></span><br><span class="line"><span class="comment"># 甚至可以声明全局依赖项，它会和每个 APIRouter 的依赖项组合在一起：</span></span><br><span class="line">app = FastAPI(dependencies=[Depends(get_query_token)])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含来自 users 和 items 子模块的 router。</span></span><br><span class="line"><span class="comment"># 使用 app.include_router()，我们可以将每个 APIRouter 添加到主 FastAPI 应用程序中。</span></span><br><span class="line">app.include_router(users.router)</span><br><span class="line">app.include_router(items.router)</span><br><span class="line"><span class="comment"># 通过将以下这些参数传递给 app.include_router() 来完成所有的声明，而不必修改原始的 APIRouter</span></span><br><span class="line"><span class="comment"># 这样，原始的APIRouter将保持不变，因此我们仍然可以与组织中的其他项目共享相同的 app/internal/admin.py 文件。</span></span><br><span class="line"><span class="comment"># 但这只会影响我们应用中的 APIRouter，而不会影响使用它的任何其他代码。</span></span><br><span class="line"><span class="comment"># 因此，举例来说，其他项目能够以不同的身份认证方法使用相同的 APIRouter。</span></span><br><span class="line">app.include_router(</span><br><span class="line">    admin.router,</span><br><span class="line">    prefix=<span class="string">&quot;/admin&quot;</span>,</span><br><span class="line">    tags=[<span class="string">&quot;admin&quot;</span>],</span><br><span class="line">    dependencies=[Depends(get_token_header)],</span><br><span class="line">    responses=&#123;<span class="number">418</span>: &#123;<span class="string">&quot;description&quot;</span>: <span class="string">&quot;I&#x27;m a teapot&quot;</span>&#125;&#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以直接将路径操作添加到 FastAPI 应用中</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">root</span>():</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello Bigger Applications!&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="后台任务"><a href="#后台任务" class="headerlink" title="后台任务"></a>后台任务</h2><p>可以定义在返回响应后运行的后台任务。<br>这对于需要在请求之后发生的操作很有用，但客户端实际上不必在接收响应之前等待操作完成。<br>这包括，例如：<br>（1）执行操作后发送的电子邮件通知： 由于连接到电子邮件服务器并发送电子邮件往往“慢”（几秒钟），可以立即返回响应并在后台发送电子邮件通知。<br>（2）处理数据：例如，假设您收到一个必须经过缓慢处理的文件，您可以返回“已接受”（HTTP 202）的响应并在后台处理它。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入BackgroundTasks</span></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> BackgroundTasks, FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个作为后台任务运行的函数。</span></span><br><span class="line"><span class="comment"># 它是一个可以接收参数的标准函数。</span></span><br><span class="line"><span class="comment"># 它可以是一个async def或普通def函数，FastAPI会知道如何正确处理它。</span></span><br><span class="line"><span class="comment"># 该例中任务函数将写入文件（模拟发送电子邮件的场景）。</span></span><br><span class="line"><span class="comment"># 并且由于写操作不使用async和await，我们用 normal 定义函数def：</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_notification</span>(<span class="params">email: <span class="built_in">str</span>, message=<span class="string">&quot;&quot;</span></span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;log.txt&quot;</span>, mode=<span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> email_file:</span><br><span class="line">        content = <span class="string">f&quot;notification for <span class="subst">&#123;email&#125;</span>: <span class="subst">&#123;message&#125;</span>&quot;</span></span><br><span class="line">        email_file.write(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/send-notification/&#123;email&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">send_notification</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    email: <span class="built_in">str</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 定义一个参数，其类型声明为：BackgroundTasks </span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># FastAPI将为您创建类型的对象BackgroundTasks并将其作为该参数传递。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    background_tasks: BackgroundTasks</span>):</span></span><br><span class="line">    <span class="comment"># 在路径操作函数内部，使用以下方法将任务函数传递给后台任务对象</span></span><br><span class="line">    background_tasks.add_task(write_notification, email, message=<span class="string">&quot;some notification&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Notification sent in the background&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意：<br>如果需要执行繁重的后台计算并且不一定需要它由同一进程运行（例如，不需要共享内存、变量等），可能会受益于使用其他更大的工具，例如Celery。<br>它们往往需要更复杂的配置，消息/作业队列管理器，如 RabbitMQ 或 Redis，但它们允许在多个进程中运行后台任务，尤其是在多个服务器中。<br>要查看示例，请查看Project Generators，它们都包含已配置的 Celery。<br>但是，如您需要从同一个FastAPI应用程序访问变量和对象，或者需要执行小型后台任务（例如发送电子邮件通知），只需使用BackgroundTasks.</p>
<h3 id="依赖注入-1"><a href="#依赖注入-1" class="headerlink" title="依赖注入"></a>依赖注入</h3><p><code>BackgroundTasks</code>也适用于依赖注入系统。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> BackgroundTasks, Depends, FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_log</span>(<span class="params">message: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;log.txt&quot;</span>, mode=<span class="string">&quot;a&quot;</span>) <span class="keyword">as</span> log:</span><br><span class="line">        log.write(message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_query</span>(<span class="params">background_tasks: BackgroundTasks, q: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> q:</span><br><span class="line">        message = <span class="string">f&quot;found query: <span class="subst">&#123;q&#125;</span>\n&quot;</span></span><br><span class="line">        background_tasks.add_task(write_log, message)</span><br><span class="line">    <span class="keyword">return</span> q</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/send-notification/&#123;email&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">send_notification</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 在此示例中，消息将在发送响应后写入文件log.txt。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 如果请求中有查询，它将在后台任务中写入日志。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment"># 然后在路径操作函数处生成的另一个后台任务将使用email路径参数写入一条消息。</span></span></span></span><br><span class="line"><span class="function"><span class="params">    email: <span class="built_in">str</span>, background_tasks: BackgroundTasks, q: <span class="built_in">str</span> = Depends(<span class="params">get_query</span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span>):</span></span><br><span class="line">    message = <span class="string">f&quot;message to <span class="subst">&#123;email&#125;</span>\n&quot;</span></span><br><span class="line">    background_tasks.add_task(write_log, message)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Message sent&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="元数据和文档URL"><a href="#元数据和文档URL" class="headerlink" title="元数据和文档URL"></a>元数据和文档URL</h2><p>可以在 FastAPI 应用中自定义几个元数据配置。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">description = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ChimichangApp API helps you do awesome stuff. 🚀</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Items</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can **read items**.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## Users</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You will be able to:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">* **Create users** (_not implemented_).</span></span><br><span class="line"><span class="string">* **Read users** (_not implemented_).</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">app = FastAPI(</span><br><span class="line">    <span class="comment"># Title：在 OpenAPI 和自动 API 文档用户界面中作为 API 的标题/名称使用。</span></span><br><span class="line">    title=<span class="string">&quot;ChimichangApp&quot;</span>,</span><br><span class="line">    <span class="comment"># Description：在 OpenAPI 和自动 API 文档用户界面中用作 API 的描述。</span></span><br><span class="line">    description=description,</span><br><span class="line">    <span class="comment"># Version：API 版本，例如 v2 或者 2.5.0。</span></span><br><span class="line">    version=<span class="string">&quot;0.0.1&quot;</span>,</span><br><span class="line">    terms_of_service=<span class="string">&quot;http://example.com/terms/&quot;</span>,</span><br><span class="line">    contact=&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Deadpoolio the Amazing&quot;</span>,</span><br><span class="line">        <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://x-force.example.com/contact/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;dp@x-force.example.com&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    license_info=&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Apache 2.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://www.apache.org/licenses/LICENSE-2.0.html&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Katana&quot;</span>&#125;]</span><br></pre></td></tr></table></figure></p>
<h3 id="标签元数据"><a href="#标签元数据" class="headerlink" title="标签元数据"></a>标签元数据</h3><p>也可以使用参数 <code>openapi_tags</code>，为用于分组路径操作的不同标签添加额外的元数据。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接受一个列表，这个列表包含每个标签对应的一个字典。</span></span><br><span class="line"><span class="comment"># 每个标签元数据字典的顺序也定义了在文档用户界面显示的顺序。</span></span><br><span class="line">tags_metadata = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"># name（必要）：一个 str，它与路径操作和 APIRouter 中使用的 tags 参数有相同的标签名。</span></span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;users&quot;</span>,</span><br><span class="line">        <span class="comment"># description：一个用于简短描述标签的 str。它支持 Markdown 并且会在文档用户界面中显示。</span></span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Operations with users. The **login** logic is also here.&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;items&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Manage items. So _fancy_ they have their own docs.&quot;</span>,</span><br><span class="line">        <span class="comment"># externalDocs：一个描述外部文档的 dict：</span></span><br><span class="line">            <span class="comment"># description：用于简短描述外部文档的 str。</span></span><br><span class="line">            <span class="comment"># url（必要）：外部文档的 URL str。</span></span><br><span class="line">        <span class="string">&quot;externalDocs&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Items external docs&quot;</span>,</span><br><span class="line">            <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://fastapi.tiangolo.com/&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">app = FastAPI(openapi_tags=tags_metadata)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 tags 参数和路径操作（以及 APIRouter）一起使用，将其分配给不同的标签</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&quot;</span>, tags=[<span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_users</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Harry&quot;</span>&#125;, &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Ron&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span>, tags=[<span class="string">&quot;items&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get_items</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;wand&quot;</span>&#125;, &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;flying broom&quot;</span>&#125;]</span><br></pre></td></tr></table></figure></p>
<h3 id="文档URL"><a href="#文档URL" class="headerlink" title="文档URL"></a>文档URL</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="comment"># 可以配置两个文档用户界面，包括：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     Swagger UI：服务于 /docs。</span></span><br><span class="line"><span class="comment">#         可以使用参数 docs_url 设置它的 URL。</span></span><br><span class="line"><span class="comment">#         可以通过设置 docs_url=None 禁用它。</span></span><br><span class="line"><span class="comment">#     ReDoc：服务于 /redoc。</span></span><br><span class="line"><span class="comment">#         可以使用参数 redoc_url 设置它的 URL。</span></span><br><span class="line"><span class="comment">#         可以通过设置 redoc_url=None 禁用它。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 例如，设置 Swagger UI 服务于 /documentation 并禁用 ReDoc：</span></span><br><span class="line">app = FastAPI(docs_url=<span class="string">&quot;/documentation&quot;</span>, redoc_url=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_items</span>():</span></span><br><span class="line">    <span class="keyword">return</span> [&#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Foo&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>
<h2 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h2><p>可以使用<code>StaticFiles</code>来挂载静态文件。</p>
<h2 id="测试客户端"><a href="#测试客户端" class="headerlink" title="测试客户端"></a>测试客户端</h2><p>基于Starlette，测试FastAPI应用程序变得简单而愉快。具体地，它基于Requests，因此非常熟悉和直观。<br>有了它，可以直接将pytest与FastAPI一起使用。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="comment"># 导入TestClient</span></span><br><span class="line"><span class="keyword">from</span> fastapi.testclient <span class="keyword">import</span> TestClient</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_main</span>():</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client = TestClient(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_read_main</span>():</span></span><br><span class="line">    response = client.get(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">    <span class="keyword">assert</span> response.status_code == <span class="number">200</span></span><br><span class="line">    <span class="keyword">assert</span> response.json() == &#123;<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br></pre></td></tr></table></figure></p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Donate
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechat_reward.png" alt="Xin-Bo Qi(亓欣波) WeChat Pay">
        <p>WeChat Pay</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/FastAPI/" rel="tag"># FastAPI</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/20/docker/" rel="prev" title="Docker知识点">
      <i class="fa fa-chevron-left"></i> Docker知识点
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/05/22/ImJoy_13/" rel="next" title="开源深度学习计算平台ImJoy解析：13 -- Kaibu应用">
      开源深度学习计算平台ImJoy解析：13 -- Kaibu应用 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B1"><span class="nav-number">3.</span> <span class="nav-text">示例1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E6%96%87%E4%BB%B6"><span class="nav-number">3.1.</span> <span class="nav-text">源文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C"><span class="nav-number">3.2.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B"><span class="nav-number">3.3.</span> <span class="nav-text">查看</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%A4%E4%BA%92%E5%BC%8FAPI%E6%96%87%E6%A1%A3"><span class="nav-number">3.4.</span> <span class="nav-text">交互式API文档</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E9%80%89%E7%9A%84API%E6%96%87%E6%A1%A3"><span class="nav-number">3.5.</span> <span class="nav-text">可选的API文档</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B2"><span class="nav-number">4.</span> <span class="nav-text">示例2</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Python%E7%B1%BB%E5%9E%8B%E6%8F%90%E7%A4%BA"><span class="nav-number">5.</span> <span class="nav-text">Python类型提示</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%B1%BB%E5%9E%8B"><span class="nav-number">5.1.</span> <span class="nav-text">简单类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B5%8C%E5%A5%97%E7%B1%BB%E5%9E%8B"><span class="nav-number">5.2.</span> <span class="nav-text">嵌套类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%97%E8%A1%A8"><span class="nav-number">5.2.1.</span> <span class="nav-text">列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%83%E7%BB%84%E5%92%8C%E9%9B%86%E5%90%88"><span class="nav-number">5.2.2.</span> <span class="nav-text">元组和集合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E5%85%B8"><span class="nav-number">5.2.3.</span> <span class="nav-text">字典</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E4%BD%9C%E4%B8%BA%E7%B1%BB%E5%9E%8B"><span class="nav-number">5.3.</span> <span class="nav-text">类作为类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pydantic%E6%A8%A1%E5%9E%8B"><span class="nav-number">5.4.</span> <span class="nav-text">Pydantic模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FastAPI-%E4%B8%AD%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%8F%90%E7%A4%BA"><span class="nav-number">5.5.</span> <span class="nav-text">FastAPI 中的类型提示</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91%E5%92%8C%E5%BC%82%E6%AD%A5-%E7%AD%89%E5%BE%85"><span class="nav-number">6.</span> <span class="nav-text">并发和异步&#x2F;等待</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%8C%87%E5%8D%97"><span class="nav-number">7.</span> <span class="nav-text">用户指南</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenAPI"><span class="nav-number">7.1.</span> <span class="nav-text">OpenAPI</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%BC%8FSchema"><span class="nav-number">7.1.1.</span> <span class="nav-text">模式Schema</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API%E6%A8%A1%E5%BC%8F"><span class="nav-number">7.1.2.</span> <span class="nav-text">API模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%BC%8F"><span class="nav-number">7.1.3.</span> <span class="nav-text">数据模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenAPI-%E5%92%8C-JSON-Schema"><span class="nav-number">7.1.4.</span> <span class="nav-text">OpenAPI 和 JSON Schema</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B-openapi-json"><span class="nav-number">7.1.5.</span> <span class="nav-text">查看 openapi.json</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenAPI%E7%9A%84%E7%94%A8%E9%80%94"><span class="nav-number">7.1.6.</span> <span class="nav-text">OpenAPI的用途</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E5%8F%82%E6%95%B0"><span class="nav-number">7.2.</span> <span class="nav-text">路径参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%B7%AF%E5%BE%84%E5%8F%82%E6%95%B0"><span class="nav-number">7.2.1.</span> <span class="nav-text">有类型的路径参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E8%BD%AC%E6%8D%A2"><span class="nav-number">7.2.2.</span> <span class="nav-text">数据转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C"><span class="nav-number">7.2.3.</span> <span class="nav-text">数据校验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E7%9A%84%E9%A1%BA%E5%BA%8F"><span class="nav-number">7.2.4.</span> <span class="nav-text">路径的顺序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%84%E8%AE%BE%E5%80%BC"><span class="nav-number">7.2.5.</span> <span class="nav-text">预设值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%85%E5%90%AB%E8%B7%AF%E5%BE%84%E7%9A%84%E8%B7%AF%E5%BE%84%E5%8F%82%E6%95%B0"><span class="nav-number">7.2.6.</span> <span class="nav-text">包含路径的路径参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%9D%E5%A4%96%E6%A0%A1%E9%AA%8C"><span class="nav-number">7.2.7.</span> <span class="nav-text">额外校验</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0"><span class="nav-number">7.3.</span> <span class="nav-text">查询参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="nav-number">7.3.1.</span> <span class="nav-text">默认值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E9%80%89%E5%8F%82%E6%95%B0"><span class="nav-number">7.3.2.</span> <span class="nav-text">可选参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AA%E8%B7%AF%E5%BE%84%E5%92%8C%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0"><span class="nav-number">7.3.3.</span> <span class="nav-text">多个路径和查询参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%85%E9%9C%80%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0"><span class="nav-number">7.3.4.</span> <span class="nav-text">必需查询参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%9D%E5%A4%96%E6%A0%A1%E9%AA%8C-1"><span class="nav-number">7.3.5.</span> <span class="nav-text">额外校验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0%E5%88%97%E8%A1%A8%E6%88%96%E5%A4%9A%E4%B8%AA%E5%80%BC"><span class="nav-number">7.3.6.</span> <span class="nav-text">查询参数列表或多个值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Query%E7%9A%84%E6%9B%B4%E5%A4%9A%E7%94%A8%E6%B3%95"><span class="nav-number">7.3.7.</span> <span class="nav-text">Query的更多用法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E4%BD%93"><span class="nav-number">7.4.</span> <span class="nav-text">请求体</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E4%BD%93-%E8%B7%AF%E5%BE%84%E5%8F%82%E6%95%B0-%E6%9F%A5%E8%AF%A2%E5%8F%82%E6%95%B0"><span class="nav-number">7.4.1.</span> <span class="nav-text">请求体 + 路径参数 + 查询参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E9%80%89%E8%AF%B7%E6%B1%82%E4%BD%93"><span class="nav-number">7.4.2.</span> <span class="nav-text">可选请求体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AA%E8%AF%B7%E6%B1%82%E4%BD%93%E5%8F%82%E6%95%B0"><span class="nav-number">7.4.3.</span> <span class="nav-text">多个请求体参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E4%BD%93%E4%B8%AD%E7%9A%84%E5%8D%95%E4%B8%80%E5%80%BC"><span class="nav-number">7.4.4.</span> <span class="nav-text">请求体中的单一值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E4%B8%AA%E8%AF%B7%E6%B1%82%E4%BD%93%E5%8F%82%E6%95%B0%E5%B5%8C%E5%85%A5%E4%B8%80%E4%B8%AA%E9%94%AE%E4%B8%AD"><span class="nav-number">7.4.5.</span> <span class="nav-text">单个请求体参数嵌入一个键中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E4%BD%93%E4%B8%AD%E7%9A%84%E5%AD%97%E6%AE%B5%E6%A0%A1%E9%AA%8C"><span class="nav-number">7.4.6.</span> <span class="nav-text">请求体中的字段校验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B5%8C%E5%A5%97%E6%A8%A1%E5%9E%8B"><span class="nav-number">7.4.7.</span> <span class="nav-text">嵌套模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%AF%E5%88%97%E8%A1%A8%E8%AF%B7%E6%B1%82%E4%BD%93"><span class="nav-number">7.4.8.</span> <span class="nav-text">纯列表请求体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BB%E6%84%8Fdict%E6%9E%84%E6%88%90%E7%9A%84%E8%AF%B7%E6%B1%82%E4%BD%93"><span class="nav-number">7.4.9.</span> <span class="nav-text">任意dict构成的请求体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E7%A4%BA%E4%BE%8B%E6%95%B0%E6%8D%AE"><span class="nav-number">7.4.10.</span> <span class="nav-text">声明请求体的示例数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE"><span class="nav-number">7.4.11.</span> <span class="nav-text">更新数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">7.5.</span> <span class="nav-text">其他数据类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cookie%E5%8F%82%E6%95%B0"><span class="nav-number">7.6.</span> <span class="nav-text">Cookie参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Header%E5%8F%82%E6%95%B0"><span class="nav-number">7.7.</span> <span class="nav-text">Header参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E8%BD%AC%E6%8D%A2"><span class="nav-number">7.7.1.</span> <span class="nav-text">自动转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%A4%8D%E7%9A%84headers"><span class="nav-number">7.7.2.</span> <span class="nav-text">重复的headers</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E6%A8%A1%E5%9E%8B"><span class="nav-number">7.8.</span> <span class="nav-text">响应模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E5%80%BC-1"><span class="nav-number">7.8.1.</span> <span class="nav-text">默认值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AA%E6%A8%A1%E5%9E%8B"><span class="nav-number">7.8.2.</span> <span class="nav-text">多个模型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E7%8A%B6%E6%80%81%E7%A0%81"><span class="nav-number">7.9.</span> <span class="nav-text">响应状态码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE"><span class="nav-number">7.10.</span> <span class="nav-text">表单数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E6%96%87%E4%BB%B6"><span class="nav-number">7.11.</span> <span class="nav-text">请求文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E8%A1%A8%E5%8D%95%E5%92%8C%E6%96%87%E4%BB%B6"><span class="nav-number">7.12.</span> <span class="nav-text">请求表单和文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF"><span class="nav-number">7.13.</span> <span class="nav-text">处理错误</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8HTTPException"><span class="nav-number">7.13.1.</span> <span class="nav-text">使用HTTPException</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8"><span class="nav-number">7.13.2.</span> <span class="nav-text">安装自定义异常处理器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%86%E7%9B%96%E9%BB%98%E8%AE%A4%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8"><span class="nav-number">7.13.3.</span> <span class="nav-text">覆盖默认异常处理器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%93%8D%E4%BD%9C%E9%85%8D%E7%BD%AE"><span class="nav-number">7.14.</span> <span class="nav-text">路径操作配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E7%A0%81"><span class="nav-number">7.14.1.</span> <span class="nav-text">状态码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tags%E5%8F%82%E6%95%B0"><span class="nav-number">7.14.2.</span> <span class="nav-text">tags参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#summary-%E5%92%8C-description-%E5%8F%82%E6%95%B0"><span class="nav-number">7.14.3.</span> <span class="nav-text">summary 和 description 参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">7.14.4.</span> <span class="nav-text">文档字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E6%8F%8F%E8%BF%B0"><span class="nav-number">7.14.5.</span> <span class="nav-text">响应描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%83%E7%94%A8%E8%B7%AF%E5%BE%84%E6%93%8D%E4%BD%9C"><span class="nav-number">7.14.6.</span> <span class="nav-text">弃用路径操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSON%E5%85%BC%E5%AE%B9%E7%BC%96%E7%A0%81%E5%99%A8"><span class="nav-number">7.15.</span> <span class="nav-text">JSON兼容编码器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="nav-number">7.16.</span> <span class="nav-text">依赖项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="nav-number">7.16.1.</span> <span class="nav-text">依赖注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FastAPI-%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="nav-number">7.16.2.</span> <span class="nav-text">FastAPI 兼容性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90"><span class="nav-number">7.16.3.</span> <span class="nav-text">例子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E4%BD%9C%E4%B8%BA%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="nav-number">7.16.4.</span> <span class="nav-text">类作为依赖项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%90%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="nav-number">7.16.5.</span> <span class="nav-text">子依赖项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%93%8D%E4%BD%9C%E8%A3%85%E9%A5%B0%E5%99%A8%E4%B8%AD%E7%9A%84%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="nav-number">7.16.6.</span> <span class="nav-text">路径操作装饰器中的依赖项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="nav-number">7.16.7.</span> <span class="nav-text">全局依赖项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89yield%E7%9A%84%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="nav-number">7.16.8.</span> <span class="nav-text">有yield的依赖项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7"><span class="nav-number">7.17.</span> <span class="nav-text">安全性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86"><span class="nav-number">7.17.1.</span> <span class="nav-text">基本知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6"><span class="nav-number">7.17.2.</span> <span class="nav-text">基本框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E5%8A%9F%E8%83%BD"><span class="nav-number">7.17.3.</span> <span class="nav-text">完整功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">7.18.</span> <span class="nav-text">中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CORS%E8%B7%A8%E5%9F%9F%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB"><span class="nav-number">7.19.</span> <span class="nav-text">CORS跨域资源共享</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4"><span class="nav-number">7.19.1.</span> <span class="nav-text">步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6"><span class="nav-number">7.19.2.</span> <span class="nav-text">通配符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8CORSMiddleware"><span class="nav-number">7.19.3.</span> <span class="nav-text">使用CORSMiddleware</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">7.20.</span> <span class="nav-text">SQL数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%96%87%E4%BB%B6%E7%BB%84%E7%BB%87"><span class="nav-number">7.21.</span> <span class="nav-text">大型项目的文件组织</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#APIRouter%E8%B7%AF%E7%94%B1"><span class="nav-number">7.21.1.</span> <span class="nav-text">APIRouter路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E9%A1%B9-1"><span class="nav-number">7.21.2.</span> <span class="nav-text">依赖项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BD%93"><span class="nav-number">7.21.3.</span> <span class="nav-text">主体</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0%E4%BB%BB%E5%8A%A1"><span class="nav-number">7.22.</span> <span class="nav-text">后台任务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5-1"><span class="nav-number">7.22.1.</span> <span class="nav-text">依赖注入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E5%92%8C%E6%96%87%E6%A1%A3URL"><span class="nav-number">7.23.</span> <span class="nav-text">元数据和文档URL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%87%E7%AD%BE%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-number">7.23.1.</span> <span class="nav-text">标签元数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E6%A1%A3URL"><span class="nav-number">7.23.2.</span> <span class="nav-text">文档URL</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"><span class="nav-number">7.24.</span> <span class="nav-text">静态文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">7.25.</span> <span class="nav-text">测试客户端</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xin-Bo Qi(亓欣波)"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Xin-Bo Qi(亓欣波)</p>
  <div class="site-description" itemprop="description">Digitize everything to realize Digitalization!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">155</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/qixinbo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qixinbo" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:qixinbo@gmail.com" title="E-Mail → mailto:qixinbo@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/qixinbo" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;qixinbo" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fas fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.tsinghua.edu.cn/" title="https:&#x2F;&#x2F;www.tsinghua.edu.cn" rel="noopener" target="_blank">THU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.imr.cas.cn/" title="http:&#x2F;&#x2F;www.imr.cas.cn" rel="noopener" target="_blank">IMR</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.sdu.edu.cn/" title="http:&#x2F;&#x2F;www.sdu.edu.cn" rel="noopener" target="_blank">SDU</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://liam0205.me/" title="http:&#x2F;&#x2F;liam0205.me&#x2F;" rel="noopener" target="_blank">黄晨成</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xin-Bo Qi(亓欣波)</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://qixinbo.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "http://qixinbo.github.io/2022/05/08/fastapi/";
    this.page.identifier = "2022/05/08/fastapi/";
    this.page.title = "FastAPI用户指南";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://qixinbo.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
